package negocio.facade.jdbc.financeiro;

import java.lang.reflect.Type;
import java.math.BigDecimal;
import java.math.BigInteger;
import java.math.RoundingMode;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.EnumMap;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Observable;
import java.util.Observer;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;

import javax.faces.model.SelectItem;

import org.springframework.context.annotation.Lazy;
import org.springframework.context.annotation.Scope;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.PreparedStatementCreator;
import org.springframework.jdbc.core.ResultSetExtractor;
import org.springframework.jdbc.support.rowset.SqlRowSet;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import com.google.common.reflect.TypeToken;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;

import controle.academico.VisaoAlunoControle;
import controle.arquitetura.DataModelo;
import jobs.JobCalculoValorTemporarioContaReceber;
import negocio.comuns.academico.CondicaoPagamentoPlanoFinanceiroCursoVO;
import negocio.comuns.academico.CursoVO;
import negocio.comuns.academico.DescontoProgressivoVO;
import negocio.comuns.academico.MatriculaPeriodoVO;
import negocio.comuns.academico.MatriculaVO;
import negocio.comuns.academico.PlanoDescontoVO;
import negocio.comuns.academico.TurmaAgrupadaVO;
import negocio.comuns.academico.TurmaVO;
import negocio.comuns.academico.TurnoVO;
import negocio.comuns.academico.enumeradores.MesAnoEnum;
import negocio.comuns.administrativo.ConfiguracaoGeralSistemaVO;
import negocio.comuns.administrativo.DepartamentoVO;
import negocio.comuns.administrativo.FuncionarioVO;
import negocio.comuns.administrativo.GrupoDestinatariosVO;
import negocio.comuns.administrativo.PersonalizacaoMensagemAutomaticaUnidadeEnsinoVO;
import negocio.comuns.administrativo.PersonalizacaoMensagemAutomaticaVO;
import negocio.comuns.administrativo.UnidadeEnsinoVO;
import negocio.comuns.administrativo.enumeradores.TipoCampoEnum;
import negocio.comuns.arquitetura.OperacaoFuncionalidadeVO;
import negocio.comuns.arquitetura.UsuarioVO;
import negocio.comuns.arquitetura.enumeradores.OperacaoFuncionalidadeEnum;
import negocio.comuns.arquitetura.enumeradores.OrigemOperacaoFuncionalidadeEnum;
import negocio.comuns.arquitetura.enumeradores.PerfilAcessoPermissaoFinanceiroEnum;
import negocio.comuns.basico.FeriadoVO;
import negocio.comuns.basico.PessoaVO;
import negocio.comuns.basico.enumeradores.ConsiderarFeriadoEnum;
import negocio.comuns.biblioteca.ConfiguracaoBibliotecaVO;
import negocio.comuns.biblioteca.EmprestimoVO;
import negocio.comuns.biblioteca.ItemEmprestimoVO;
import negocio.comuns.compras.FornecedorVO;
import negocio.comuns.contabil.LancamentoContabilVO;
import negocio.comuns.contabil.enumeradores.SituacaoLancamentoContabilEnum;
import negocio.comuns.contabil.enumeradores.TipoOrigemHistoricoBloqueioEnum;
import negocio.comuns.contabil.enumeradores.TipoOrigemLancamentoContabilEnum;
import negocio.comuns.contabil.enumeradores.TipoPlanoContaEnum;
import negocio.comuns.contabil.enumeradores.TipoValorLancamentoContabilEnum;
import negocio.comuns.faturamento.nfe.NotaFiscalSaidaServicoVO;
import negocio.comuns.financeiro.AplicarDescontoContaReceberLogVO;
import negocio.comuns.financeiro.CentroResultadoOrigemVO;
import negocio.comuns.financeiro.ConfiguracaoFinanceiroVO;
import negocio.comuns.financeiro.ConfiguracaoRecebimentoCartaoOnlineVO;
import negocio.comuns.financeiro.ContaCorrenteVO;
import negocio.comuns.financeiro.ContaReceberNegociacaoRecebimentoVO;
import negocio.comuns.financeiro.ContaReceberRecebimentoVO;
import negocio.comuns.financeiro.ContaReceberVO;
import negocio.comuns.financeiro.ControleRemessaContaReceberVO;
import negocio.comuns.financeiro.ControleRemessaVO;
import negocio.comuns.financeiro.ConvenioVO;
import negocio.comuns.financeiro.DetalhamentoValorContaVO;
import negocio.comuns.financeiro.DevolucaoChequeVO;
import negocio.comuns.financeiro.FormaPagamentoNegociacaoRecebimentoVO;
import negocio.comuns.financeiro.IndiceReajustePeriodoMatriculaPeriodoVencimentoVO;
import negocio.comuns.financeiro.IndiceReajustePeriodoVO;
import negocio.comuns.financeiro.IndiceReajusteVO;
import negocio.comuns.financeiro.MatriculaPeriodoVencimentoVO;
import negocio.comuns.financeiro.NegociacaoRecebimentoVO;
import negocio.comuns.financeiro.OrdemDescontoVO;
import negocio.comuns.financeiro.ParceiroVO;
import negocio.comuns.financeiro.PixContaCorrenteVO;
import negocio.comuns.financeiro.PlanoDescontoContaReceberVO;
import negocio.comuns.financeiro.PlanoFinanceiroAlunoDescricaoDescontosVO;
import negocio.comuns.financeiro.ProcessamentoArquivoRetornoParceiroExcelVO;
import negocio.comuns.financeiro.RegistroArquivoVO;
import negocio.comuns.financeiro.RegistroDetalheVO;
import negocio.comuns.financeiro.enumerador.FormaPadraoDataBaseCartaoRecorrenteEnum;
import negocio.comuns.financeiro.enumerador.OrigemDetalhamentoContaEnum;
import negocio.comuns.financeiro.enumerador.SituacaoControleRemessaContaReceberEnum;
import negocio.comuns.financeiro.enumerador.TipoCentroResultadoOrigemDetalheEnum;
import negocio.comuns.financeiro.enumerador.TipoCentroResultadoOrigemEnum;
import negocio.comuns.job.RegistroExecucaoJobVO;
import negocio.comuns.processosel.InscricaoVO;
import negocio.comuns.utilitarias.ConsistirException;
import negocio.comuns.utilitarias.ControleConsulta;
import negocio.comuns.utilitarias.Ordenacao;
import negocio.comuns.utilitarias.ProcessarParalelismo;
import negocio.comuns.utilitarias.ProgressBarVO;
import negocio.comuns.utilitarias.SituacaoExecucaoEnum;
import negocio.comuns.utilitarias.Stopwatch;
import negocio.comuns.utilitarias.StreamSeiException;
import negocio.comuns.utilitarias.Uteis;
import negocio.comuns.utilitarias.UteisJSF;
import negocio.comuns.utilitarias.boleto.GeradorDeDigitoBanestes;
import negocio.comuns.utilitarias.dominios.Bancos;
import negocio.comuns.utilitarias.dominios.DiaSemana;
import negocio.comuns.utilitarias.dominios.FaixaDescontoProgressivo;
import negocio.comuns.utilitarias.dominios.SituacaoContaReceber;
import negocio.comuns.utilitarias.dominios.SituacaoVencimentoMatriculaPeriodo;
import negocio.comuns.utilitarias.dominios.TipoBoletoBancario;
import negocio.comuns.utilitarias.dominios.TipoFormaPagamento;
import negocio.comuns.utilitarias.dominios.TipoNivelEducacional;
import negocio.comuns.utilitarias.dominios.TipoOrigemContaReceber;
import negocio.comuns.utilitarias.dominios.TipoPessoa;
import negocio.comuns.utilitarias.faturamento.nfe.UteisData;
import negocio.comuns.utilitarias.faturamento.nfe.UteisTexto;
import negocio.facade.jdbc.academico.Matricula;
import negocio.facade.jdbc.arquitetura.AtributoPersistencia;
import negocio.facade.jdbc.arquitetura.ControleAcesso;
import negocio.facade.jdbc.utilitarias.NivelMontarDados;
import negocio.interfaces.financeiro.ContaReceberInterfaceFacade;
import relatorio.negocio.comuns.financeiro.ContaReceberCobrancaRelVO;
import relatorio.negocio.comuns.financeiro.FiltroRelatorioFinanceiroVO;

/**
 * Classe de persistência que encapsula todas as operações de manipulação dos dados da classe <code>ContaReceberVO</code>. Responsável por implementar operações como incluir, alterar, excluir e consultar pertinentes a classe <code>ContaReceberVO</code>. Encapsula toda a interação com o banco de dados.
 * 
 * @see ContaReceberVO
 * @see ControleAcesso
 */
@Lazy
@Repository
@Scope("singleton")
public class ContaReceber extends ControleAcesso implements ContaReceberInterfaceFacade {

	/**
	 * 
	 */
	private static final long serialVersionUID = -5257218153440328270L;
	protected static String idEntidade;
	private static final long ONE_DAY = 24 * 60 * 60 * 1000;
	

	public ContaReceber() throws Exception {
		super();
		setIdEntidade("ContaReceber");
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# validarUsuarioConsultarMinhasContasReceber()
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# validarUsuarioConsultarMinhasContasReceber()
	 */
	public void validarUsuarioConsultarMinhasContasReceber(UsuarioVO usuario) throws Exception {
		consultar("MinhasContasPagar", true, usuario);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#novo()
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#novo()
	 */
	public ContaReceberVO novo(UsuarioVO usuario) throws Exception {
		ContaReceber.incluir(getIdEntidade());
		ContaReceberVO obj = new ContaReceberVO();
		return obj;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# validarDadosParaImpressaoBoletos(negocio.comuns. utilitarias.dominios.TipoBoletoBancario)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# validarDadosParaImpressaoBoletos(negocio.comuns. utilitarias.dominios.TipoBoletoBancario)
	 */
	public void validarDadosParaImpressaoBoletos(TipoBoletoBancario tipoBoletoBancario, UsuarioVO usuario, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		switch (tipoBoletoBancario) {
		case MATRICULA:
			if (configuracaoFinanceiroVO.getModeloBoletoMatricula().getCodigo().equals(0)) {
				throw new ConsistirException("Defina um modelo de boleto padrão para MATRÍCULA na CONFIGURAÇÃO GERAL do SISTEMA.");
			}
			break;
		case MENSALIDADE:
			if (configuracaoFinanceiroVO.getModeloBoletoMensalidade().getCodigo().equals(0)) {
				throw new ConsistirException("Defina um modelo de boleto padrão para MENSALIDADE na CONFIGURAÇÃO GERAL do SISTEMA.");
			}
			break;
		case MATERIAL_DIDATICO:
			if (configuracaoFinanceiroVO.getModeloBoletoMaterialDidatico().getCodigo().equals(0)) {
				throw new ConsistirException("Defina um modelo de boleto padrão para MATERIAL DIDÁTICO na CONFIGURAÇÃO GERAL do SISTEMA.");
			}
			break;

		case OUTROS:
			if (configuracaoFinanceiroVO.getModeloBoletoOutros().getCodigo().equals(0)) {
				throw new ConsistirException("Defina um modelo de boleto padrão para OUTROS na CONFIGURAÇÃO GERAL do SISTEMA.");
			}
			break;
		case PROCESSO_SELETIVO:
			if (configuracaoFinanceiroVO.getModeloBoletoProcessoSeletivo().getCodigo().equals(0)) {
				throw new ConsistirException("Defina um modelo de boleto padrão para PROCESSO SELETIVO na CONFIGURAÇÃO GERAL do SISTEMA.");
			}
			break;
		case REQUERIMENTO:
			if (configuracaoFinanceiroVO.getModeloBoletoRequerimento().getCodigo().equals(0)) {
				throw new ConsistirException("Defina um modelo de boleto padrão para REQUERIMENTO na CONFIGURAÇÃO GERAL do SISTEMA.");
			}
			break;
		default:
			break;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void validarContaReceberEmMemoriaAntesAlteracao(ContaReceberVO contaReceber) throws Exception {
		/*
		 * StringBuilder sql = new StringBuilder(); sql.append(" select codigo from contareceber where codigo = ").append(contaReceber.getCodigo()).append(" and to_char(updated, 'YYYY-MM-DD HH:mm:ss.ms') = to_char('").append(Uteis.getDataJDBCTimestamp(contaReceber.getUpdated())).append("'::TIMESTAMP, 'YYYY-MM-DD HH:mm:ss.ms')  "); SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString()); if(!rs.next()){ throw new Exception("Por favor tentar novamente. Sua conta foi manipulada por outro usuário."); }
		 */

	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarAtributoUpdatedContaReceberAposAlteracaoPeloSistemaGarantindoAssimIntegridade(ContaReceberVO contaReceber) throws Exception {
		/*
		 * StringBuilder sql = new StringBuilder(); sql.append(" select updated from contareceber where codigo = ").append(contaReceber.getCodigo()).append(" "); SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString()); if(rs.next()){ contaReceber.setUpdated(rs.getTimestamp("updated")); }
		 */
	}

	/**
	 * Rotina para geração do nossoNumero para controle de boletagem. Esta rotina segue dois padrões de geração. Caso seja uma boleto, que nao seja originado de uma matricula ou mensalidade, então o nosso numero irá assumir o codigo da conta a receber. Caso a conta receber seja originada de uma matricula ou mensalidade, aí o padrão é alterado. Passa-se a adotar a geração do nossoNumero com base no codOrigem da contareceber (codigo de uma matriculaperiodo), adicionado de um controlador de indicativo da parcela. Para isto adotamos o seguinte formato,
	 * 
	 * --> Primeira posição com valor, indicando que trata-se de um nossoNumero | relativo a uma matricula e/ou parcela. | |-----> Dois caracteres seguintes, refere-se ao numero da parcela (ou matrícula) ||----> para a qual está se gerando o nossoNumero para Boletagem. Onde "00" ||| indica que é uma matricula, 01 - refere-se a primeira parcela, 02 - segunda parcela e assim por diante. |||--------> Os demais oito digitos referem-se ao codOrigem (no caso matriculaPeriodo). |||| | "10000123456"
	 * 
	 * Exemplo 1) 10000123456 -> trata-se de uma matrícula, da matrículaPeriodo de código 123456; Exemplo 2) 10300033244 -> trata-se da mensalidade numero 03, da matriculaPeriodo de código 33244;
	 * 
	 * Nosso numero deve possuir no maxima 10 digitos numericos, pois o Banco do Brasil por exemplo, trabalha com esta limitacao de tamanho.
	 * 
	 * @param obj
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void executarGeracaoNossoNumeroContaReceber(final ContaReceberVO obj, String numeroBanco, Boolean forcarRegerarNossoNumero, UsuarioVO usuario) throws Exception {
		String baseNossoNumero = obj.getCodigo().toString();
		String tipoNumeracaoGeracao = "1";
		String numeroParcela = "";
		String numeroPreenchidoPosicoesVagas = "";
		if (obj.getContaCorrenteVO().getAgencia().getBanco().getModeloGeracaoBoleto().equals("SICOB")) {
			numeroBanco = numeroBanco + "-S";
		}
		if (obj.getContaCorrenteVO().getAgencia().getBanco().getModeloGeracaoBoleto().equals("SICOB15")) {
			numeroBanco = numeroBanco + "-N15";
		}
		if (((obj.getTipoOrigem().equals("MAT")) || (obj.getTipoOrigem().equals("MEN"))) && (!obj.getParcela().contains("IN"))) {
			executarGeracaoNossoNumeroContaReceberMatriculaOuMensalidade(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, false, forcarRegerarNossoNumero, usuario);
		} else if (obj.getTipoOrigem().equals("NCR")) {
			executarGeracaoNossoNumeroContaReceberRenegociacaoContaReceber(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, false, forcarRegerarNossoNumero, usuario);
		} else if (obj.getTipoOrigem().equals("IPS")) {
			executarGeracaoNossoNumeroContaReceberIPS(obj, numeroBanco, Uteis.isAtributoPreenchido(obj.getCodOrigem()) ? obj.getCodOrigem() : baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, false, forcarRegerarNossoNumero, usuario);
		} else {
			executarGeracaoNossoNumeroContaReceberOutros(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, false, forcarRegerarNossoNumero, usuario);
		}

		// if
		// (getFacadeFactory().getBancoFacade().consultarPorCodigoContaReceber(obj.getCodigo(),
		// false, Uteis.NIVELMONTARDADOS_DADOSBASICOS,
		// usuario).getNrBanco().equals("341"))
		// {
		// obj.setNossoNumero(Uteis.preencherComZerosPosicoesVagas(baseNossoNumero,
		// 8));
		// }
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void executarGeracaoNossoNumeroContaReceberMatriculaOuMensalidade(final ContaReceberVO obj, String numeroBanco, String baseNossoNumero, String numeroParcela, String numeroPreenchidoPosicoesVagas, String tipoNumeracaoGeracao, boolean recursividade, Boolean forcarRegerarNossoNumero, UsuarioVO usuario) throws Exception {
		if (!obj.getCodOrigem().equals("")) {
			// assumi-se o codigo de origem como base para geracao do nosso
			// numero,
			// caso ele seja diferente de vazio.
			baseNossoNumero = obj.getCodOrigem();
		}
		if (obj.getCodOrigem().length() > 7 && !numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())) {
			throw new Exception("Erro ao gerar o nosso número para controle de boletagem da conta a receber de " + "código: " + obj.getCodigo() + ". O campo base de geração ultrapassou o limite máximo " + "permitido pelos Bancos (tamanho máximo 7). ");
		}
		boolean regerouNossoNumeroCaixa = false;
		boolean achouRegistroNossoNumeroContaCorrente = false;
		boolean excluirNossoNumeroAntigo = false;
		boolean gerarNossoNumeroSicoob = false;
		boolean utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero().equals("") ? false : true;
		Integer anoBoleto = Integer.parseInt(Uteis.getData(new Date(), "yyyy"));
		if (forcarRegerarNossoNumero) {
			regerouNossoNumeroCaixa = true;
			achouRegistroNossoNumeroContaCorrente = false;
			recursividade = true;
		}
		if ((!forcarRegerarNossoNumero || recursividade) && (
				numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) 
				|| numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco()))) {
			int qtd = 4;
			if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
					|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())
					|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
					|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())) {
				qtd = 5;
			}
			SqlRowSet rs = null;
			if (obj.getNumeroParcela().contains("EX")) {
				rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and tipoorigem = '"+obj.getTipoOrigem()+"'" + " and parcela ilike '" + obj.getNumeroParcela() + "' order by codigo desc limit 1");
			} else {
				rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and tipoorigem = '"+obj.getTipoOrigem()+"'" + " and parcela ilike '" + obj.getNumeroParcela() + "%' order by codigo desc limit 1");
			}
			if (rs.next() ) {
				// montar dados do nossonumerocontareceber
				ContaReceberVO nncc = new ContaReceberVO();
				montarDadosNossoNumeroContaReceber(nncc, rs, usuario);
				achouRegistroNossoNumeroContaCorrente = true;
				// Verifica se alterou valor da conta.
				if (this.verificarAlteracoesContaParaGeracaoNossoNumero(nncc, obj, obj.getMatriculaAluno()) || nncc.getNossoNumeroAlterado() || recursividade) {
					// se sim gera novo nossonumero
					SqlRowSet rs2 = consultarSequencialNossoNumeroCorrente(obj, qtd);
					if (rs2.next()) {						
						baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs2.getString("sequencialnossonumero_codigo"), qtd);
						anoBoleto = rs2.getInt("anoboleto");
						regerouNossoNumeroCaixa = true;
						achouRegistroNossoNumeroContaCorrente = false;
					}
				} else {
					if (nncc.getNrBanco().equals("") || nncc.getNrBanco().equals(numeroBanco)) {
						baseNossoNumero = nncc.getNossoNumero();
					} else {
						// tem que regerar o nossonumero pois mudou o banco!
						regerouNossoNumeroCaixa = false;
						achouRegistroNossoNumeroContaCorrente = false;
						excluirNossoNumeroAntigo = true;
					}
				}
			} else {
				qtd = 4;
				if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
						|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())
						|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
						|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())) {
					qtd = 5;
				}
				verificarBancoSicoobESetaAtributoNecessarioParaGeracaoBoleto(obj, obj.getContaCorrenteVO());
				baseNossoNumero = obj.getSequencialcodmatperalternativoboleto().toString();
				rs = consultarSequencialNossoNumeroCorrente(obj, qtd);
				if (rs.next()) {
					baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero_codigo"), qtd);
					anoBoleto = rs.getInt("anoboleto");
					regerouNossoNumeroCaixa = true;
				}
				gerarNossoNumeroSicoob = true;
				achouRegistroNossoNumeroContaCorrente = false;
			}
		}
		// Rotina responsavel por alterar o nossonumero de contas da CAIXA que sofrem modificação no valor.
		if ((!forcarRegerarNossoNumero || recursividade) && ((numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				//|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())
				//|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())))) {
			// if (!numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) && !numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
			int qtd = verificacaoQuantidadeDigitosNossNumeroPorBanco(numeroBanco);
			// if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
			// qtd = 4;
			// }
			SqlRowSet rs = null;
			if (obj.getNumeroParcela().contains("EX")) {
				rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + "  and tipoorigem = '"+obj.getTipoOrigem()+"'" +  " and parcela ilike '" + obj.getNumeroParcela() + "' order by codigo desc limit 1");
			} else {
				rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + "  and tipoorigem = '"+obj.getTipoOrigem()+"'" + " and parcela ilike '" + obj.getNumeroParcela() + "%' order by codigo desc limit 1");
			}
			if (rs.next()) {
				// montar dados do nossonumerocontareceber
				ContaReceberVO nncc = new ContaReceberVO();
				montarDadosNossoNumeroContaReceber(nncc, rs, usuario);
				List<ContaCorrenteVO> listaContaCorrente = new ArrayList<>();
				listaContaCorrente.add(nncc.getContaCorrenteVO());
				achouRegistroNossoNumeroContaCorrente = true;
				ControleRemessaContaReceberVO crcr = getFacadeFactory().getControleRemessaContaReceberFacade().consultaRapidaContaArquivoRemessaPorNossoNumeroContaReceber(listaContaCorrente, nncc.getNossoNumero());
				// Verifica se alterou valor da conta.
				if (nncc.getNossoNumeroAlterado() || recursividade || (this.verificarAlteracoesContaParaGeracaoNossoNumero(nncc, obj, obj.getMatriculaAluno()) && crcr.getCodigo() > 0) ) {
					// se sim era novo nossonumero
					SqlRowSet rs2 = consultarSequencialNossoNumeroCorrente(obj, qtd);
					if (rs2.next()) {
						baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs2.getString("sequencialnossonumero_codigo"), qtd);
						anoBoleto = rs2.getInt("anoboleto");
						regerouNossoNumeroCaixa = true;
						achouRegistroNossoNumeroContaCorrente = false;
					}
				} else {
					if(this.verificarAlteracoesContaParaGeracaoNossoNumero(nncc, obj, obj.getMatriculaAluno()) && !Uteis.isAtributoPreenchido(crcr.getCodigo()) ) {
						this.alterarNossoNumeroContaReceber(obj, nncc.getCodigo() , numeroBanco,  usuario );						
					}
					if (nncc.getNrBanco().equals("") || nncc.getNrBanco().equals(numeroBanco)) {
						baseNossoNumero = nncc.getNossoNumero();
					} else {
						// tem que regerar o nossonumero pois mudou o banco!
						regerouNossoNumeroCaixa = false;
						achouRegistroNossoNumeroContaCorrente = false;
						excluirNossoNumeroAntigo = true;
					}
				}
			}
		}
		anoBoleto = Integer.parseInt(anoBoleto.toString().substring((anoBoleto.toString().length() - 2), anoBoleto.toString().length()));
		numeroParcela = obj.obterNumeroParcela();
		numeroPreenchidoPosicoesVagas = executarVerificacaoQuantidadeDigitosNossNumeroPorBanco(baseNossoNumero, numeroBanco, "MAT", tipoNumeracaoGeracao, numeroParcela);
		// Essa condição foi feita para atender o IPOG porque as contas a
		// receber estavam com os codigos origens com o tamanho = 6
		// sendo assim estava gerando o nosso número maior que o permitido
		// para o banco ITAU.
		// Para solução do problema ficou definido retirar o primeiro
		// digito(tipoNumeracaoGeracao), quando possuir o codigo origem = 6
		// apenas para o banco ITAU
		if (obj.getCodOrigem().length() == 6 && numeroBanco.equals(Bancos.ITAU.getNumeroBanco())) {
			if (!numeroPreenchidoPosicoesVagas.equals("")) {
				baseNossoNumero = numeroParcela + numeroPreenchidoPosicoesVagas;
			} else {
				baseNossoNumero = numeroParcela + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 7);
			}
			// O tamanho de geração do nosso número para o banco Santader
			// dever ser de 8 dígitos
			// e estavam sendo gerados com 9 dígitos, sendo assim foi posto
			// a regra abaixo para o mesmo.
			// Carlos
		}else if (numeroBanco.equals(Bancos.ITAU.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas;
		} else if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) && (regerouNossoNumeroCaixa || gerarNossoNumeroSicoob)) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas, obj);
			} else {
				baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(anoBoleto + numeroPreenchidoPosicoesVagas, obj);
			}
			
		} else if (numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas + Uteis.getModulo11Santander(digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas, 9);
			} else {
				baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + Uteis.getModulo11Santander(anoBoleto + numeroPreenchidoPosicoesVagas, 9);
			}
			
		} else if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + "2" + numeroPreenchidoPosicoesVagas + getModulo11Sicred(digitoInicialGeracaoNossoNumero + "2" + numeroPreenchidoPosicoesVagas, obj);
			} else {
				baseNossoNumero = anoBoleto + "2" + numeroPreenchidoPosicoesVagas + getModulo11Sicred(anoBoleto + "2" + numeroPreenchidoPosicoesVagas, obj);
			}
		} else if ((numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())				
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())) && regerouNossoNumeroCaixa) {
			       baseNossoNumero = anoBoleto + "0" + numeroPreenchidoPosicoesVagas;			      
		}else if(numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
			if (!achouRegistroNossoNumeroContaCorrente) {
				if (!numeroPreenchidoPosicoesVagas.equals("") && !regerouNossoNumeroCaixa) {
					baseNossoNumero = tipoNumeracaoGeracao + numeroParcela + numeroPreenchidoPosicoesVagas;
					if (baseNossoNumero.length() == 7) {
						baseNossoNumero = tipoNumeracaoGeracao + "0" + numeroParcela + numeroPreenchidoPosicoesVagas;
					}
					
					GeradorDeDigitoBanestes geradorDigito =	new GeradorDeDigitoBanestes();
					baseNossoNumero =	baseNossoNumero + geradorDigito.CalculaDVNossoNumero(baseNossoNumero,9);
					baseNossoNumero =   baseNossoNumero + geradorDigito.CalculaDVNossoNumero(baseNossoNumero,10);
				} else {					
					baseNossoNumero = anoBoleto  + "0"+ numeroPreenchidoPosicoesVagas;
					if(baseNossoNumero.length() >= 9) {
						baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas;
					}
		    	    GeradorDeDigitoBanestes geradorDigito =	new GeradorDeDigitoBanestes();
					baseNossoNumero =	baseNossoNumero + geradorDigito.CalculaDVNossoNumero(baseNossoNumero,9);
					baseNossoNumero =   baseNossoNumero + geradorDigito.CalculaDVNossoNumero(baseNossoNumero,10);
					
				}
		   }		
		} else {
			if (!achouRegistroNossoNumeroContaCorrente) {
				if (!numeroPreenchidoPosicoesVagas.equals("")) {
					baseNossoNumero = tipoNumeracaoGeracao + numeroParcela + numeroPreenchidoPosicoesVagas;
				} else {
					baseNossoNumero = tipoNumeracaoGeracao + numeroParcela + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 7);
				}
			}
		}
		SqlRowSet rs2 = getConexao().getJdbcTemplate().queryForRowSet(" select codigo from contareceber where nossonumero = '" + baseNossoNumero + "' and codigo != " + obj.getCodigo() + " and contacorrente = " + obj.getContaCorrenteVO().getCodigo());
		if (rs2.next() && rs2.getInt("codigo") > 0) {
			executarGeracaoNossoNumeroContaReceberMatriculaOuMensalidade(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, true, false, usuario);
			return;
		}
		obj.setNossoNumero(baseNossoNumero);
		if ((numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) && !achouRegistroNossoNumeroContaCorrente) {
			if (excluirNossoNumeroAntigo) {
				excluirNossoNumeroContaReceber(baseNossoNumero, usuario);
			}
			this.incluirNossoNumeroContaReceber(obj, numeroBanco, regerouNossoNumeroCaixa, usuario);
		}
	}

	public void montarDadosNossoNumeroContaReceber(ContaReceberVO obj, SqlRowSet dadosSQL, UsuarioVO usuario) throws Exception {		
		obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaPeriodo"));
		obj.setParcela(dadosSQL.getString("parcela"));
		obj.setNossoNumero(dadosSQL.getString("nossonumero"));		
		obj.setDataVencimento(Uteis.getDataJDBC(dadosSQL.getDate("dataVencimento")));
		obj.setValorBaseContaReceber(dadosSQL.getDouble("valorBase"));
		obj.setValor(dadosSQL.getDouble("valor"));
		obj.setValorDescontoSemValidade(dadosSQL.getDouble("valordescontosemvalidade"));
		obj.setValorDescontoDataLimite(dadosSQL.getDouble("valordescontodatalimite"));
		obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
		obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoPrimeiraFaixaDescontos"));
		obj.setValorDescontoCalculadoSegundaFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoSegundaFaixaDescontos"));
		obj.setValorDescontoCalculadoTerceiraFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoTerceiraFaixaDescontos"));
		obj.setValorDescontoCalculadoQuartaFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoQuartaFaixaDescontos"));
		obj.setNossoNumeroAlterado(dadosSQL.getBoolean("nossonumeroalterado"));
		obj.setNrBanco(dadosSQL.getString("numeroBanco"));
		obj.setDataLimitePrimeiraFaixaDescontos(Uteis.getDataJDBC(dadosSQL.getDate("dataLimitePrimeiraFaixaDescontos")));
		obj.setDataLimiteSegundaFaixaDescontos(Uteis.getDataJDBC(dadosSQL.getDate("dataLimiteSegundaFaixaDescontos")));
		obj.setDataLimiteTerceiraFaixaDescontos(Uteis.getDataJDBC(dadosSQL.getDate("dataLimiteTerceiraFaixaDescontos")));
		obj.setDataLimiteQuartaFaixaDescontos(Uteis.getDataJDBC(dadosSQL.getDate("dataLimiteQuartaFaixaDescontos")));
		obj.setContaCorrenteVO(Uteis.montarDadosVO(dadosSQL.getInt("contacorrente"), ContaCorrenteVO.class, p -> getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(p, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario)));
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void executarGeracaoNossoNumeroContaReceberRenegociacaoContaReceber(final ContaReceberVO obj, String numeroBanco, String baseNossoNumero, String numeroParcela, String numeroPreenchidoPosicoesVagas, String tipoNumeracaoGeracao, boolean recursividade, Boolean forcarRegerarNossoNumero, UsuarioVO usuario) throws Exception {
		tipoNumeracaoGeracao = "2";
//		Integer anoBoleto = Integer.parseInt(Uteis.getData(new Date(), "yyyy"));
//		if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) || numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
//			int qtd = 4;
//			if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
//				qtd = 5;
//			}
//			verificarBancoSicoobESetaAtributoNecessarioParaGeracaoBoleto(obj, obj.getContaCorrenteVO());
//			SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(" select sequencialnossonumero from contareceber where codigo = " + obj.getCodigo());
//			if (rs.next() && rs.getString("sequencialnossonumero") != null && !recursividade) {
//				baseNossoNumero = "" + Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero"), qtd);
//				anoBoleto =  Integer.parseInt(Uteis.getData(new Date(), "yyyy"));
//			} else {
//				rs = consultarSequencialNossoNumeroCorrente(obj, qtd);
//				if(rs.next()){
//					baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero_codigo"), qtd);
//					anoBoleto = rs.getInt("anoBoleto");
//				}
//			}
//		}
//		numeroPreenchidoPosicoesVagas = executarVerificacaoQuantidadeDigitosNossNumeroPorBanco(baseNossoNumero, numeroBanco, "NCR", tipoNumeracaoGeracao, numeroParcela);
//		anoBoleto = Integer.parseInt(anoBoleto.toString().substring((anoBoleto.toString().length() - 2), anoBoleto.toString().length()));
//		if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())) {
//			baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(anoBoleto + numeroPreenchidoPosicoesVagas, obj);
//		} else if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
//			baseNossoNumero = anoBoleto + "2" + numeroPreenchidoPosicoesVagas + getModulo11Sicred(anoBoleto + "2" + numeroPreenchidoPosicoesVagas, obj);
//		} else if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())) {
//			baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(anoBoleto + numeroPreenchidoPosicoesVagas, obj);
//		} else if (!numeroPreenchidoPosicoesVagas.equals("")) {
//			baseNossoNumero = tipoNumeracaoGeracao + numeroPreenchidoPosicoesVagas;
//		} else {
//			baseNossoNumero = tipoNumeracaoGeracao + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 9);
//		}
//		obj.setNossoNumero(baseNossoNumero);
//		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(" select codigo from contareceber where nossonumero = '" + baseNossoNumero + "' and codigo != " + obj.getCodigo());
//		if (rs.next() && rs.getInt("codigo") > 0) {
//			executarGeracaoNossoNumeroContaReceberRenegociacaoContaReceber(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, true, forcarRegerarNossoNumero, usuario);
//			return;
//		}
		
		String nossoNumeroBaseOriginal = baseNossoNumero;
		Integer anoBoleto = Integer.parseInt(Uteis.getData(new Date(), "yyyy"));		
		boolean regerouNossoNumeroCaixa = false;
		boolean achouRegistroNossoNumeroContaCorrente = false;
		boolean excluirNossoNumeroAntigo = false;		
		boolean utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero().equals("") ? false : true;
		if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) 
				|| numeroBanco.equals(Bancos.SICRED.getNumeroBanco()) 
				|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco()) ) {
			int qtd = 4;
			if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
					|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())
					|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
					|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())) {
				qtd = 5;
			}
			SqlRowSet rs = null;
			rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + "  and tipoorigem=  '"+obj.getTipoOrigem()+"'" + " and parcela ilike '" + obj.getNumeroParcela() + "%' order by codigo desc limit 1");
			if (rs.next()) {
				// montar dados do nossonumerocontareceber
				ContaReceberVO nncc = new ContaReceberVO();
				montarDadosNossoNumeroContaReceber(nncc, rs, usuario);
				achouRegistroNossoNumeroContaCorrente = true;
				// Verifica se alterou valor da conta.
				if (this.verificarAlteracoesContaParaGeracaoNossoNumero(nncc, obj, obj.getMatriculaAluno()) || nncc.getNossoNumeroAlterado() || recursividade) {
					// se sim gera novo nossonumero
					SqlRowSet rs2 = consultarSequencialNossoNumeroCorrente(obj, qtd);
					if (rs2.next()) {						
						baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs2.getString("sequencialnossonumero_codigo"), qtd);
						anoBoleto = rs2.getInt("anoboleto");
						regerouNossoNumeroCaixa = true;
						achouRegistroNossoNumeroContaCorrente = false;
					}
				} else {
					if (nncc.getNrBanco().equals("") || nncc.getNrBanco().equals(numeroBanco)) {
						baseNossoNumero = nncc.getNossoNumero();
					} else {
						// tem que regerar o nossonumero pois mudou o banco!
						regerouNossoNumeroCaixa = false;
						achouRegistroNossoNumeroContaCorrente = false;
						excluirNossoNumeroAntigo = true;
					}
				}
			} else {
				qtd = 4;
				if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
						|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())
						|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
						|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())) {
					qtd = 5;
				}
				verificarBancoSicoobESetaAtributoNecessarioParaGeracaoBoleto(obj, obj.getContaCorrenteVO());
				baseNossoNumero = obj.getSequencialcodmatperalternativoboleto().toString();
				rs = consultarSequencialNossoNumeroCorrente(obj, qtd);
				if (rs.next()) {
					baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero_codigo"), qtd);
					anoBoleto = rs.getInt("anoboleto");
				}
				regerouNossoNumeroCaixa = true;
				achouRegistroNossoNumeroContaCorrente = false;
			}
		}
		// Rotina responsavel por alterar o nossonumero de contas da CAIXA que sofrem modificação no valor.
		if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())) {
			int qtd = verificacaoQuantidadeDigitosNossNumeroPorBanco(numeroBanco);
			SqlRowSet rs = null;
			rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and tipoorigem ='"+obj.getTipoOrigem()+"'  and parcela ilike '" + obj.getNumeroParcela() + "%' order by codigo desc limit 1");
			if (rs.next()) {
				// montar dados do nossonumerocontareceber
				ContaReceberVO nncc = new ContaReceberVO();
				montarDadosNossoNumeroContaReceber(nncc, rs, usuario);
				List<ContaCorrenteVO> listaContaCorrente = new ArrayList<>();
				listaContaCorrente.add(nncc.getContaCorrenteVO());
				achouRegistroNossoNumeroContaCorrente = true;
				ControleRemessaContaReceberVO crcr = getFacadeFactory().getControleRemessaContaReceberFacade().consultaRapidaContaArquivoRemessaPorNossoNumeroContaReceber(listaContaCorrente, nncc.getNossoNumero());
				// Verifica se alterou valor da conta.
				if ((this.verificarAlteracoesContaParaGeracaoNossoNumero(nncc, obj, obj.getMatriculaAluno()) && crcr.getCodigo() > 0) || recursividade) {
					// se sim era novo nossonumero
					SqlRowSet rs2 = consultarSequencialNossoNumeroCorrente(obj, qtd);
					if (rs2.next()) {
						baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs2.getString("sequencialnossonumero_codigo"), qtd);
						anoBoleto = rs2.getInt("anoboleto");
						regerouNossoNumeroCaixa = true;
						achouRegistroNossoNumeroContaCorrente = false;
					}
				} else {
					if (nncc.getNrBanco().equals("") || nncc.getNrBanco().equals(numeroBanco)) {
						baseNossoNumero = nncc.getNossoNumero();
					} else {
						// tem que regerar o nossonumero pois mudou o banco!
						regerouNossoNumeroCaixa = false;
						achouRegistroNossoNumeroContaCorrente = false;
						excluirNossoNumeroAntigo = true;
					}
				}
			}
		}		
		numeroPreenchidoPosicoesVagas = executarVerificacaoQuantidadeDigitosNossNumeroPorBanco(baseNossoNumero, numeroBanco, "NCR", tipoNumeracaoGeracao, numeroParcela);
		anoBoleto = Integer.parseInt(anoBoleto.toString().substring((anoBoleto.toString().length() - 2), anoBoleto.toString().length()));
		if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas, obj);
			} else {
				baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(anoBoleto + numeroPreenchidoPosicoesVagas, obj);
			}
			
		} else if (numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas + Uteis.getModulo11Santander(digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas, 9);
			} else {
				baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + Uteis.getModulo11Santander(anoBoleto + numeroPreenchidoPosicoesVagas, 9);
			}
						
		} else if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + "2" + numeroPreenchidoPosicoesVagas + getModulo11Sicred(digitoInicialGeracaoNossoNumero + "2" + numeroPreenchidoPosicoesVagas, obj);
			} else {
				baseNossoNumero = anoBoleto + "2" + numeroPreenchidoPosicoesVagas + getModulo11Sicred(anoBoleto + "2" + numeroPreenchidoPosicoesVagas, obj);
			}
		} else if ((numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())) && regerouNossoNumeroCaixa) {
			baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas;
		}else if(numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
			if (!achouRegistroNossoNumeroContaCorrente) {
				if (!numeroPreenchidoPosicoesVagas.equals("")) {
					baseNossoNumero = tipoNumeracaoGeracao + '0' + numeroPreenchidoPosicoesVagas;
					GeradorDeDigitoBanestes geradorDigito =	new GeradorDeDigitoBanestes();
					baseNossoNumero =	baseNossoNumero + geradorDigito.CalculaDVNossoNumero(baseNossoNumero,9);
					baseNossoNumero =   baseNossoNumero + geradorDigito.CalculaDVNossoNumero(baseNossoNumero,10);
				} else {
					baseNossoNumero = tipoNumeracaoGeracao + '0' + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 9);
				}
		   }	
		} else {
			if (!achouRegistroNossoNumeroContaCorrente) {
				if (!numeroPreenchidoPosicoesVagas.equals("")) {
					baseNossoNumero = tipoNumeracaoGeracao + '0' + numeroPreenchidoPosicoesVagas;
				} else {
					baseNossoNumero = tipoNumeracaoGeracao + '0' + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 9);
				}
			}
		}
		obj.setNossoNumero(baseNossoNumero);
		if ((numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) && !achouRegistroNossoNumeroContaCorrente) {
			if (excluirNossoNumeroAntigo) {
				excluirNossoNumeroContaReceber(baseNossoNumero, usuario);
			}
			this.incluirNossoNumeroContaReceber(obj, numeroBanco, regerouNossoNumeroCaixa, usuario);
		}		
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(" select codigo from contareceber where nossonumero = '" + baseNossoNumero + "' and codigo != " + obj.getCodigo());
		if (rs.next() && rs.getInt("codigo") > 0) {
			if (Uteis.getIsValorNumerico(nossoNumeroBaseOriginal)) {
				baseNossoNumero = (Long.valueOf(nossoNumeroBaseOriginal) + 1) + "";
			}
			executarGeracaoNossoNumeroContaReceberRenegociacaoContaReceber(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, true, false, usuario);
			return;
		}		
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void executarGeracaoNossoNumeroContaReceberIPS(final ContaReceberVO obj, String numeroBanco, String baseNossoNumero, String numeroParcela, String numeroPreenchidoPosicoesVagas, String tipoNumeracaoGeracao, boolean recursividade, Boolean forcarRegerarNossoNumero, UsuarioVO usuario) throws Exception {
		
		if (!obj.getCodOrigem().equals("") && Uteis.isAtributoPreenchido(baseNossoNumero) && !recursividade) {
			baseNossoNumero = obj.getCodOrigem();
		}
				
		String nossoNumeroBaseOriginal = baseNossoNumero;
		if (obj.getCodOrigem().length() > 7) {
			throw new Exception("Erro ao gerar o nosso número para controle de boletagem da conta a receber de " + "código: " + obj.getCodigo() + ". O campo base de geração ultrapassou o limite máximo " + "permitido pelos Bancos (tamanho máximo 7). ");
		}

		Integer anoBoleto = Integer.parseInt(Uteis.getData(new Date(), "yyyy"));		
		boolean regerouNossoNumeroCaixa = false;
		boolean achouRegistroNossoNumeroContaCorrente = false;
		boolean excluirNossoNumeroAntigo = false;		
		boolean utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero().equals("") ? false : true;
		if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) 
				|| numeroBanco.equals(Bancos.SICRED.getNumeroBanco()) 
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())  
				|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())  
				|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
			int qtd = 4;
			if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
					|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())  
					|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())  
					|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
				qtd = 5;
			}
			SqlRowSet rs = null;
			//rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and parcela ilike '" + obj.getNumeroParcela() + "%' order by codigo desc limit 1");
			if (recursividade || forcarRegerarNossoNumero) {
				// montar dados do nossonumerocontareceber
				//ContaReceberVO nncc = new ContaReceberVO();
				//montarDadosNossoNumeroContaReceber(nncc, rs, usuario);
				//achouRegistroNossoNumeroContaCorrente = true;
				// Verifica se alterou valor da conta.
				//if (this.verificarAlteracoesContaParaGeracaoNossoNumero(nncc, obj, obj.getMatriculaAluno()) || nncc.getNossoNumeroAlterado()) {
					// se sim gera novo nossonumero
					rs = consultarSequencialNossoNumeroCorrente(obj, qtd);
					if (rs.next()) {						
						baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero_codigo"), qtd);
						anoBoleto = rs.getInt("anoboleto");
						regerouNossoNumeroCaixa = true;
						achouRegistroNossoNumeroContaCorrente = false;
					}
//				} else {
//					if (nncc.getNrBanco().equals("") || nncc.getNrBanco().equals(numeroBanco)) {
//						baseNossoNumero = nncc.getNossoNumero();
//					} else {
//						// tem que regerar o nossonumero pois mudou o banco!
//						regerouNossoNumeroCaixa = false;
//						achouRegistroNossoNumeroContaCorrente = false;
//						excluirNossoNumeroAntigo = true;
//					}
//				}
			} else {
				qtd = 4;
				if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
						|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())  
						|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())  
						|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
					qtd = 5;
				}
				verificarBancoSicoobESetaAtributoNecessarioParaGeracaoBoleto(obj, obj.getContaCorrenteVO());
				baseNossoNumero = obj.getSequencialcodmatperalternativoboleto().toString();
				rs = consultarSequencialNossoNumeroCorrente(obj, qtd);
				if (rs.next()) {
					baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero_codigo"), qtd);
					anoBoleto = rs.getInt("anoboleto");
				}
				regerouNossoNumeroCaixa = true;
				achouRegistroNossoNumeroContaCorrente = false;
			}
		}
		// Rotina responsavel por alterar o nossonumero de contas da CAIXA que sofrem modificação no valor.
		if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())) {
			int qtd = verificacaoQuantidadeDigitosNossNumeroPorBanco(numeroBanco);
			SqlRowSet rs = null;
			//rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and parcela ilike '" + obj.getNumeroParcela() + "%' order by codigo desc limit 1");
			if (recursividade || forcarRegerarNossoNumero) {
				// montar dados do nossonumerocontareceber
//				ContaReceberVO nncc = new ContaReceberVO();
//				montarDadosNossoNumeroContaReceber(nncc, rs, usuario);
//				List<ContaCorrenteVO> listaContaCorrente = new ArrayList<>();
//				listaContaCorrente.add(nncc.getContaCorrenteVO());
//				achouRegistroNossoNumeroContaCorrente = true;
//				ControleRemessaContaReceberVO crcr = getFacadeFactory().getControleRemessaContaReceberFacade().consultaRapidaContaArquivoRemessaPorNossoNumeroContaReceber(listaContaCorrente, nncc.getNossoNumero());
//				// Verifica se alterou valor da conta.
//				if ((this.verificarAlteracoesContaParaGeracaoNossoNumero(nncc, obj, obj.getMatriculaAluno()) && crcr.getCodigo() > 0) || recursividade) {
					// se sim era novo nossonumero
					rs = consultarSequencialNossoNumeroCorrente(obj, qtd);
					if (rs.next()) {
						baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero_codigo"), qtd);
						anoBoleto = rs.getInt("anoboleto");
						regerouNossoNumeroCaixa = true;
						achouRegistroNossoNumeroContaCorrente = false;
					}
//				} else {
//					if (nncc.getNrBanco().equals("") || nncc.getNrBanco().equals(numeroBanco)) {
//						baseNossoNumero = nncc.getNossoNumero();
//					} else {
//						// tem que regerar o nossonumero pois mudou o banco!
//						regerouNossoNumeroCaixa = false;
//						achouRegistroNossoNumeroContaCorrente = false;
//						excluirNossoNumeroAntigo = true;
//					}
//				}
			}
		}		
		numeroPreenchidoPosicoesVagas = executarVerificacaoQuantidadeDigitosNossNumeroPorBanco(baseNossoNumero, numeroBanco, "IPS", tipoNumeracaoGeracao, numeroParcela);
		anoBoleto = Integer.parseInt(anoBoleto.toString().substring((anoBoleto.toString().length() - 2), anoBoleto.toString().length()));		
		if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas, obj);
			} else {
				baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(anoBoleto + numeroPreenchidoPosicoesVagas, obj);
			}
			
		} else if (numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas + Uteis.getModulo11Santander(digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas, 9);
			} else {
				baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + Uteis.getModulo11Santander(anoBoleto + numeroPreenchidoPosicoesVagas, 9);
			}
						
		} else if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + "2" + numeroPreenchidoPosicoesVagas + getModulo11Sicred(digitoInicialGeracaoNossoNumero + "2" + numeroPreenchidoPosicoesVagas, obj);
			} else {
				baseNossoNumero = anoBoleto + "2" + numeroPreenchidoPosicoesVagas + getModulo11Sicred(anoBoleto + "2" + numeroPreenchidoPosicoesVagas, obj);
			}
			
		} else if ((numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())) && regerouNossoNumeroCaixa) {
			baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas;
		}else if(numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
				if (!achouRegistroNossoNumeroContaCorrente) {
					if (!numeroPreenchidoPosicoesVagas.equals("")) {
						baseNossoNumero = tipoNumeracaoGeracao + '0' + numeroPreenchidoPosicoesVagas;
						GeradorDeDigitoBanestes geradorDigito =	new GeradorDeDigitoBanestes();
						baseNossoNumero =	baseNossoNumero + geradorDigito.CalculaDVNossoNumero(baseNossoNumero,9);
						baseNossoNumero =   baseNossoNumero + geradorDigito.CalculaDVNossoNumero(baseNossoNumero,10);
					} else {
						baseNossoNumero = tipoNumeracaoGeracao + '0' + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 9);
					}
			   }	
		} else {
			if (!achouRegistroNossoNumeroContaCorrente) {
				if (!numeroPreenchidoPosicoesVagas.equals("")) {
					baseNossoNumero = tipoNumeracaoGeracao + '0' + numeroPreenchidoPosicoesVagas;
				} else {
					baseNossoNumero = tipoNumeracaoGeracao + '0' + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 9);
				}				
			}
		}
		obj.setNossoNumero(baseNossoNumero);
		if ((numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) && !achouRegistroNossoNumeroContaCorrente) {
			if (excluirNossoNumeroAntigo) {
				excluirNossoNumeroContaReceber(baseNossoNumero, usuario);
			}
			this.incluirNossoNumeroContaReceber(obj, numeroBanco, regerouNossoNumeroCaixa, usuario);
		}		
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(" select codigo from contareceber where nossonumero = '" + baseNossoNumero + "' and codigo != " + obj.getCodigo());
		if (rs.next() && rs.getInt("codigo") > 0) {
			System.out.println("nossoNumero -> " + baseNossoNumero);
			System.out.println("nossoNumeroBaseOriginal -> " + nossoNumeroBaseOriginal);
			if (Uteis.getIsValorNumerico(nossoNumeroBaseOriginal)) {
				baseNossoNumero = (Long.valueOf(nossoNumeroBaseOriginal) + 1) + "";				
			}
			executarGeracaoNossoNumeroContaReceberIPS(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, true, forcarRegerarNossoNumero, usuario);
			return;
		}	
		List<ContaCorrenteVO> lista = new ArrayList<>();
		lista.add(obj.getContaCorrenteVO());	
		if (Uteis.isAtributoPreenchido(getFacadeFactory().getControleRemessaContaReceberFacade().consultaRapidaContaArquivoRemessaPorNossoNumeroContaReceber(lista, baseNossoNumero))) {
			System.out.println("nossoNumero -> " + baseNossoNumero);
			System.out.println("nossoNumeroBaseOriginal -> " + nossoNumeroBaseOriginal);
			if (Uteis.getIsValorNumerico(nossoNumeroBaseOriginal)) {
				baseNossoNumero = (Long.valueOf(nossoNumeroBaseOriginal) + 1) + "";				
			}
			executarGeracaoNossoNumeroContaReceberIPS(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, true, forcarRegerarNossoNumero, usuario);
			return;
		}		
		
//	} else if (!numeroPreenchidoPosicoesVagas.equals("")) {
//		baseNossoNumero = tipoNumeracaoGeracao + numeroPreenchidoPosicoesVagas;
//	} else {
//		baseNossoNumero = tipoNumeracaoGeracao + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 9);
//	}
//	obj.setNossoNumero(baseNossoNumero);
//	SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(" select codigo from contareceber where nossonumero = '" + baseNossoNumero + "' and codigo != " + obj.getCodigo());
//	if (rs.next() && rs.getInt("codigo") > 0) {
//		if (nossoNumeroBaseOriginal.equals(obj.getCodigo().toString())) {
//			baseNossoNumero = (obj.getCodigo() + 1) + "";
//		} else {
//			baseNossoNumero = obj.getCodigo().toString();
//		}
//		executarGeracaoNossoNumeroContaReceberIPS(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, true, forcarRegerarNossoNumero, usuario);
//		return;
//	}

		
//		---------------- aqui --------------
		
//		Integer anoBoleto = Integer.parseInt(Uteis.getData(new Date(), "yyyy"));
//		tipoNumeracaoGeracao = "9";
//		if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) || numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
//			int qtd = 4;
//			if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
//				qtd = 5;
//			}
//			verificarBancoSicoobESetaAtributoNecessarioParaGeracaoBoleto(obj, obj.getContaCorrenteVO());
//			SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(" select sequencialnossonumero from contareceber where codigo = " + obj.getCodigo());
//			if (rs.next() && rs.getString("sequencialnossonumero") != null && !recursividade) {
//				baseNossoNumero = "" + Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero"), qtd);
//				anoBoleto =  Integer.parseInt(Uteis.getData(new Date(), "yyyy"));
//			}else{
//				rs = consultarSequencialNossoNumeroCorrente(obj, qtd);
//				if(rs.next()){
//					baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero_codigo"), qtd);
//					anoBoleto = rs.getInt("anoBoleto");
//				}
//			}
//		}
//		numeroPreenchidoPosicoesVagas = executarVerificacaoQuantidadeDigitosNossNumeroPorBanco(baseNossoNumero, numeroBanco, "IPS", tipoNumeracaoGeracao, numeroParcela);
//		anoBoleto = Integer.parseInt(anoBoleto.toString().substring((anoBoleto.toString().length() - 2), anoBoleto.toString().length()));
//		if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())) {
//			baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(anoBoleto + numeroPreenchidoPosicoesVagas, obj);
//		} else if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
//			baseNossoNumero = anoBoleto + "2" + numeroPreenchidoPosicoesVagas + getModulo11Sicred(anoBoleto + "2" + numeroPreenchidoPosicoesVagas, obj);
//		} else if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())) {
//			baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(anoBoleto + numeroPreenchidoPosicoesVagas, obj);
		
		
		
//		} else if (!numeroPreenchidoPosicoesVagas.equals("")) {
//			baseNossoNumero = tipoNumeracaoGeracao + numeroPreenchidoPosicoesVagas;
//		} else {
//			baseNossoNumero = tipoNumeracaoGeracao + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 9);
//		}
//		obj.setNossoNumero(baseNossoNumero);
//		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(" select codigo from contareceber where nossonumero = '" + baseNossoNumero + "' and codigo != " + obj.getCodigo());
//		if (rs.next() && rs.getInt("codigo") > 0) {
//			if (nossoNumeroBaseOriginal.equals(obj.getCodigo().toString())) {
//				baseNossoNumero = (obj.getCodigo() + 1) + "";
//			} else {
//				baseNossoNumero = obj.getCodigo().toString();
//			}
//			executarGeracaoNossoNumeroContaReceberIPS(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, true, forcarRegerarNossoNumero, usuario);
//			return;
//		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void executarGeracaoNossoNumeroContaReceberOutros(final ContaReceberVO obj, String numeroBanco, String baseNossoNumero, String numeroParcela, String numeroPreenchidoPosicoesVagas, String tipoNumeracaoGeracao, boolean recursividade, Boolean forcarRegerarNossoNumero, UsuarioVO usuario) throws Exception {
		Integer anoBoleto = Integer.parseInt(Uteis.getData(new Date(), "yyyy"));
		String nossoNumeroBaseOriginal = baseNossoNumero;
		boolean regerouNossoNumeroCaixa = false;
		boolean achouRegistroNossoNumeroContaCorrente = false;
		boolean excluirNossoNumeroAntigo = false;	
		boolean utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero().equals("") ? false : true;
		if(obj.getTipoOrigem().equals("BIB") || obj.getTipoOrigem().equals("OUT")) {
			forcarRegerarNossoNumero = true;
		}
		if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) 
				|| numeroBanco.equals(Bancos.SICRED.getNumeroBanco()) 
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco()) 
				|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco()) 
				|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
			int qtd = 4;
			if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
					|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco()) 
					|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco()) 
					|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
				qtd = 5;
			}			
			SqlRowSet rs = null;
			if (obj.getNumeroParcela().contains("EX")) {
				rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and parcela ilike '" + obj.getNumeroParcela() + "'  AND tipoorigem = '"+obj.getTipoOrigem()+"' order by codigo desc limit 1");
			} else if (obj.getTipoOrigem().equals("BCC")) {
				rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and parcela ilike '" + obj.getNumeroParcela() + "%' AND tipoorigem = '"+obj.getTipoOrigem()+"' AND convenio =  '"+obj.getConvenio().getCodigo()+"' order by codigo desc limit 1");
			} else {
				rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and parcela ilike '" + obj.getNumeroParcela() + "%' AND tipoorigem = '"+obj.getTipoOrigem()+"'  order by codigo desc limit 1");
			}
			if (rs.next()) {
				// montar dados do nossonumerocontareceber
				ContaReceberVO nncc = new ContaReceberVO();
				montarDadosNossoNumeroContaReceber(nncc, rs, usuario);
				achouRegistroNossoNumeroContaCorrente = true;
				// Verifica se alterou valor da conta.
				if (this.verificarAlteracoesContaParaGeracaoNossoNumero(nncc, obj, obj.getMatriculaAluno()) || nncc.getNossoNumeroAlterado() || recursividade) {
					// se sim gera novo nossonumero
					SqlRowSet rs2 = consultarSequencialNossoNumeroCorrente(obj, qtd);
					if (rs2.next()) {						
						baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs2.getString("sequencialnossonumero_codigo"), qtd);
						anoBoleto = rs2.getInt("anoboleto");
						regerouNossoNumeroCaixa = true;
						achouRegistroNossoNumeroContaCorrente = false;
					}
				} else {
					if (nncc.getNrBanco().equals("") || nncc.getNrBanco().equals(numeroBanco)) {
						baseNossoNumero = nncc.getNossoNumero();
					} else {
						// tem que regerar o nossonumero pois mudou o banco!
						regerouNossoNumeroCaixa = false;
						achouRegistroNossoNumeroContaCorrente = false;
						excluirNossoNumeroAntigo = true;
					}
				}
			} else {
				qtd = 4;
				if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
						|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco()) 
						|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco()) 
						|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
					qtd = 5;
				}
				verificarBancoSicoobESetaAtributoNecessarioParaGeracaoBoleto(obj, obj.getContaCorrenteVO());
				baseNossoNumero = obj.getSequencialcodmatperalternativoboleto().toString();
				rs = consultarSequencialNossoNumeroCorrente(obj, qtd);
				if (rs.next()) {
					baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero_codigo"), qtd);
					anoBoleto = rs.getInt("anoboleto");
				}
				regerouNossoNumeroCaixa = true;
				achouRegistroNossoNumeroContaCorrente = false;
			}
		}
		// Rotina responsavel por alterar o nossonumero de contas da CAIXA que sofrem modificação no valor.
		if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())) {			
			int qtd = verificacaoQuantidadeDigitosNossNumeroPorBanco(numeroBanco);			
			SqlRowSet rs = null;
			if (obj.getNumeroParcela().contains("EX")) {
				rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and parcela ilike '" + obj.getNumeroParcela() + "' AND tipoorigem = '"+obj.getTipoOrigem()+"' order by codigo desc limit 1");
			} else if (obj.getTipoOrigem().equals("BCC")) {
				rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and parcela ilike '" + obj.getNumeroParcela() + "%' AND tipoorigem = '"+obj.getTipoOrigem()+"' AND convenio =  '"+obj.getConvenio().getCodigo()+"' order by codigo desc limit 1");
			} else {
				rs = getConexao().getJdbcTemplate().queryForRowSet(" select * from nossonumerocontareceber where matriculaperiodo = " + obj.getMatriculaPeriodo() + " and parcela ilike '" + obj.getNumeroParcela() + "%' AND tipoorigem = '"+obj.getTipoOrigem()+"' order by codigo desc limit 1");
			}
			if (rs.next()) {
				// montar dados do nossonumerocontareceber
				ContaReceberVO nncc = new ContaReceberVO();
				montarDadosNossoNumeroContaReceber(nncc, rs, usuario);
				List<ContaCorrenteVO> listaContaCorrente = new ArrayList<>();
				listaContaCorrente.add(nncc.getContaCorrenteVO());
				achouRegistroNossoNumeroContaCorrente = true;
				ControleRemessaContaReceberVO crcr = getFacadeFactory().getControleRemessaContaReceberFacade().consultaRapidaContaArquivoRemessaPorNossoNumeroContaReceber(listaContaCorrente, nncc.getNossoNumero());
				// Verifica se alterou valor da conta.
				if ((this.verificarAlteracoesContaParaGeracaoNossoNumero(nncc, obj, obj.getMatriculaAluno()) && crcr.getCodigo() > 0) || recursividade) {
					// se sim era novo nossonumero
					SqlRowSet rs2 = consultarSequencialNossoNumeroCorrente(obj, qtd);
					if (rs2.next()) {
						baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs2.getString("sequencialnossonumero_codigo"), qtd);
						anoBoleto = rs2.getInt("anoboleto");
						regerouNossoNumeroCaixa = true;
						achouRegistroNossoNumeroContaCorrente = false;
					}
				} else {
					if (nncc.getNrBanco().equals("") || nncc.getNrBanco().equals(numeroBanco)) {
						baseNossoNumero = nncc.getNossoNumero();
					} else {
						// tem que regerar o nossonumero pois mudou o banco!
						regerouNossoNumeroCaixa = false;
						achouRegistroNossoNumeroContaCorrente = false;
						excluirNossoNumeroAntigo = true;
					}
				}
			}else if(forcarRegerarNossoNumero) {
				rs = consultarSequencialNossoNumeroCorrente(obj, qtd);
				if (rs.next()) {
					baseNossoNumero = ""+Uteis.getPreencherComZeroEsquerda(rs.getString("sequencialnossonumero_codigo"), qtd);
					anoBoleto = rs.getInt("anoboleto");
				}
			}
		}
		String tipoOrigem = obj.getTipoOrigemContaReceber().isMaterialDidatico() ? obj.getTipoOrigem() : "OUT"; 
		numeroPreenchidoPosicoesVagas = executarVerificacaoQuantidadeDigitosNossNumeroPorBanco(baseNossoNumero, numeroBanco, tipoOrigem, tipoNumeracaoGeracao, numeroParcela);
		anoBoleto = Integer.parseInt(anoBoleto.toString().substring((anoBoleto.toString().length() - 2), anoBoleto.toString().length()));
		if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas, obj);
			} else {
				baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + getModulo11Sicoob(anoBoleto + numeroPreenchidoPosicoesVagas, obj);
			}
			
		} else if (numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas + Uteis.getModulo11Santander(digitoInicialGeracaoNossoNumero + numeroPreenchidoPosicoesVagas, 9);
			} else {
				baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas + Uteis.getModulo11Santander(anoBoleto + numeroPreenchidoPosicoesVagas, 9);
			}
						
		} else if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco()) && regerouNossoNumeroCaixa) {
			if (utilizarInicialGeracaoNossoNumeroDefinidoContaCorrente) {
				String digitoInicialGeracaoNossoNumero = obj.getContaCorrenteVO().getInicialGeracaoNossoNumero();
				baseNossoNumero = digitoInicialGeracaoNossoNumero + "2" + numeroPreenchidoPosicoesVagas + getModulo11Sicred(digitoInicialGeracaoNossoNumero + "2" + numeroPreenchidoPosicoesVagas, obj);
			} else {
				baseNossoNumero = anoBoleto + "2" + numeroPreenchidoPosicoesVagas + getModulo11Sicred(anoBoleto + "2" + numeroPreenchidoPosicoesVagas, obj);
			}
			
		} else if ((numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())) && regerouNossoNumeroCaixa) {
			baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas;
		}else if(numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
			if (!achouRegistroNossoNumeroContaCorrente) {
				if (!numeroPreenchidoPosicoesVagas.equals("")) {
					baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas;
					GeradorDeDigitoBanestes geradorDigito =	new GeradorDeDigitoBanestes();
					baseNossoNumero =	baseNossoNumero + geradorDigito.CalculaDVNossoNumero(baseNossoNumero,9);
					baseNossoNumero =   baseNossoNumero + geradorDigito.CalculaDVNossoNumero(baseNossoNumero,10);
				} else {
					baseNossoNumero = anoBoleto + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 9);
				}
		   }	
		} else {
			if (!achouRegistroNossoNumeroContaCorrente) {
				if (!numeroPreenchidoPosicoesVagas.equals("")) {
					baseNossoNumero = anoBoleto + numeroPreenchidoPosicoesVagas;
				} else {
					baseNossoNumero = anoBoleto + Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 9);
				}
			}
		}

		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(" select codigo from contareceber where nossonumero = '" + baseNossoNumero + "' and codigo != " + obj.getCodigo());
		SqlRowSet rs2 = getConexao().getJdbcTemplate().queryForRowSet(" select codigo from nossonumerocontareceber where nossonumero = '" + baseNossoNumero + "' and codigo != " + obj.getCodigo());
		if ((rs.next() && rs.getInt("codigo") > 0) || (rs2.next() && rs2.getInt("codigo") > 0)) {
			if (Uteis.getIsValorNumerico(nossoNumeroBaseOriginal)) {
				baseNossoNumero = (Long.valueOf(nossoNumeroBaseOriginal) + 1) + "";
			}
			executarGeracaoNossoNumeroContaReceberOutros(obj, numeroBanco, baseNossoNumero, numeroParcela, numeroPreenchidoPosicoesVagas, tipoNumeracaoGeracao, true, false, usuario);
			return;
		}
		obj.setNossoNumero(baseNossoNumero);
		if ((numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SICRED.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())
				|| numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())
				|| numeroBanco.equals(Bancos.ITAU.getNumeroBanco())
				|| numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) && !achouRegistroNossoNumeroContaCorrente) {
			if (excluirNossoNumeroAntigo) {
				excluirNossoNumeroContaReceber(baseNossoNumero, usuario);
			}
			this.incluirNossoNumeroContaReceber(obj, numeroBanco, regerouNossoNumeroCaixa, usuario);
		}
	}
	
	private SqlRowSet consultarSequencialNossoNumeroCorrente(ContaReceberVO obj, int qtd) {
		return getConexao().getJdbcTemplate().queryForRowSet(" select * from inserirnossonumero("+obj.getCodigo()+ "," +(qtd+1)+ ") as sequencialnossonumero");
	}

	public String getModulo11Sicoob(String campo, ContaReceberVO obj) {
		// Modulo 11 - 3791
		campo = obj.getContaCorrenteVO().getAgencia().getNumeroAgencia() + "000" + obj.getContaCorrenteVO().getConvenio() + campo;
		int multiplicador = 3;
		int multiplicacao = 0;
		int soma_campo = 0;

		for (int i = campo.length(); i > 0; i--) {
			multiplicacao = Integer.parseInt(campo.substring(i - 1, i)) * multiplicador;

			soma_campo = soma_campo + multiplicacao;

			// multiplicador++;
			if (multiplicador == 3) {
				multiplicador = 7;
			} else if (multiplicador == 7) {
				multiplicador = 9;
			} else if (multiplicador == 9) {
				multiplicador = 1;
			} else if (multiplicador == 1) {
				multiplicador = 3;
			}
		}

		int dac = (soma_campo % 11);

		if ((dac == 0 || dac == 1)) {
			dac = 0;
		} else {
			dac = 11 - (soma_campo % 11);
		}
		return ((Integer) dac).toString();
	}

	public String getModulo11Sicred(String campo, ContaReceberVO obj) {
		// Modulo 11 - 3791
		campo = obj.getContaCorrenteVO().getAgencia().getNumeroAgencia() +  (Uteis.isAtributoPreenchido(obj.getContaCorrenteVO().getAgencia().getDigito()) ? obj.getContaCorrenteVO().getAgencia().getDigito() : "02" )  + obj.getContaCorrenteVO().getCodigoCedente() + campo;
		int multiplicador = 2;
		int multiplicacao = 0;
		int soma_campo = 0;

		for (int i = campo.length(); i > 0; i--) {
			multiplicacao = Integer.parseInt(campo.substring(i - 1, i)) * multiplicador;
			soma_campo = soma_campo + multiplicacao;
			if (multiplicador == 9) {
				multiplicador = 2;
			} else {
				multiplicador++;
			}
		}

		int dac = (soma_campo % 11);

		dac = 11 - (soma_campo % 11);

		if (dac == 10 || dac == 11) {
			dac = 0;
		}
		return ((Integer) dac).toString();
	}

	/*
	 * Método responsável por verificar quantos digitos será posto dependendo do banco escolhido
	 * 
	 * @Autor Carlos
	 */
	@Override
	public String executarVerificacaoQuantidadeDigitosNossNumeroPorBanco(String baseNossoNumero, String numeroBanco, String tipoOrigem, String tipoNumeracaoGeracao, String numeroParcela) {
		if (tipoOrigem.equals("MAT")) {
			if (numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 8);
			} else if (numeroBanco.equals(Bancos.DAYCOVAL.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 8);
			} else if (numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 7);
			} else if (numeroBanco.equals(Bancos.HSBC.getNumeroBanco())) {				
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 10);
			} else if (numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 5);
			} else if (numeroBanco.equals(Bancos.UNIBANCO.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 10);
			} else if (numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 5);
			} else if (numeroBanco.equals(Bancos.ITAU.getNumeroBanco())) {
					return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 6);
			} else if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 12);
			} else if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL_SICOB.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 5);
			} else if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL_SICOB_15.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 11);
			} else if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 5);
			} else if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 5);
			} else if (numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 5);
			}
		}	
		
		if (tipoOrigem.equals("OUT") || tipoOrigem.equals("MDI") || tipoOrigem.equals("NCR") || tipoOrigem.equals("IPS")) {
			if (numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 9);
			} else if (numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 8);
			} else if (numeroBanco.equals(Bancos.HSBC.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 11);
			} else if (numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 5);
			} else if (numeroBanco.equals(Bancos.UNIBANCO.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 12);
			} else if (numeroBanco.equals(Bancos.SAFRA.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 7);
			} else if (numeroBanco.equals(Bancos.ITAU.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 6);
			} else if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 13);
			} else if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL_SICOB.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 6);
			} else if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL_SICOB_15.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 12);
			} else if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 5);
			} else if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 5);
			} else if (numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
				return Uteis.preencherComZerosPosicoesVagas(baseNossoNumero, 6);
			}
		}
		return "";
	}

	public int verificacaoQuantidadeDigitosNossNumeroPorBanco(String numeroBanco) {
		if (numeroBanco.equals(Bancos.BRADESCO.getNumeroBanco())) {
			return 8;
		} else if (numeroBanco.equals(Bancos.DAYCOVAL.getNumeroBanco())) {
			return 8;
		} else if (numeroBanco.equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())) {
			return 7;
		} else if (numeroBanco.equals(Bancos.HSBC.getNumeroBanco())) {
			/*
			 * Eu Rodrigo J. Wind alterei a logica deste colocando o numero 10 onde anteriormente esta o numero 13, com o numero 13 gerava o nosso numero do SANTANDER um valor maior do que o permitido, porque ao sair deste era concatenado o TIPO NUMERACAO (1,2,9) + PARCELA(PARA MENSALIADADE) e o nosso numero ficava com 16 dígitos
			 * 
			 */
			return 10;
		} else if (numeroBanco.equals(Bancos.SANTANDER.getNumeroBanco())) {
			return 4;
		} else if (numeroBanco.equals(Bancos.UNIBANCO.getNumeroBanco())) {
			return 10;
		} else if (numeroBanco.equals(Bancos.ITAU.getNumeroBanco())) {
			return 5;
		} else if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())) {
			return 12;
		} else if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL_SICOB.getNumeroBanco())) {
			return 5;
		} else if (numeroBanco.equals(Bancos.CAIXA_ECONOMICA_FEDERAL_SICOB_15.getNumeroBanco())) {
			return 11;
		} else if (numeroBanco.equals(Bancos.SICRED.getNumeroBanco())) {
			return 5;
		} else if (numeroBanco.equals(Bancos.SICOOB.getNumeroBanco())) {
			return 5;
		} else if (numeroBanco.equals(Bancos.BANESTE.getNumeroBanco())) {
			return 5;
		}
		return 4;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
		// obj.setNrDocumento(gerarNumeroDocumento(obj.getUnidadeEnsino(),
	public void gerarNumeroDoc(final ContaReceberVO obj, String numeroBanco, final UsuarioVO usuario) throws Exception {
		// usuario));

		// Esse metodo será executado apenas para o banco SICOOB e apenas para preencher a variavel sequencialcodmatperalternativoboleto com o codigo alteranativo da matriculaperiodo
		verificarBancoSicoobESetaAtributoNecessarioParaGeracaoBoleto(obj, obj.getContaCorrenteVO());
		obj.setNrDocumento(gerarNumeroDocumentoPorPessoaConvenio(obj.getPessoa().getCodigo(), obj.getParceiroVO().getCodigo(), obj.getTipoPessoa(), usuario));
		if (obj.getNossoNumero().equals("")) {
			executarGeracaoNossoNumeroContaReceber(obj, numeroBanco, false, usuario);
		}
		// final String sql =
		// "UPDATE ContaReceber set nrDocumento=?, nossonumero=? WHERE ((codigo = ?))";
		// getConexao().getJdbcTemplate().update(new PreparedStatementCreator()
		// {
		// public PreparedStatement createPreparedStatement(Connection cnctn)
		// throws SQLException {
		// PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
		// sqlAlterar.setString(1, obj.getNrDocumento());
		// sqlAlterar.setString(2, obj.getNossoNumero());
		// sqlAlterar.setInt(3, obj.getCodigo().intValue());
		// return sqlAlterar;
		// }
		// });
	}

	public ContaReceberVO consultarNossoNumeroContaReceberPorNossoNumero(String nossoNumero, UsuarioVO usuario) throws Exception {
		SqlRowSet rs = null;
		ContaReceberVO nncc = null;
		try {
			String sql = "select nossonumerocontareceber.*, pessoa.nome as nomePessoa from nossonumerocontareceber left join matriculaperiodo on matriculaperiodo.codigo = nossonumerocontareceber.matriculaperiodo "
					+ " left join matricula on matricula.matricula = matriculaperiodo.matricula "
					+ " left join pessoa on pessoa.codigo = matricula.aluno "
					+ " where 1=1  ";
			sql += " AND ( nossonumero = '" + nossoNumero + "' ";
			if(nossoNumero.startsWith("00000")) {
				sql += " or nossonumero= '" + nossoNumero.substring(5, nossoNumero.length()) + "' ";
			}else if(nossoNumero.startsWith("0000")) {
				sql += " or nossonumero= '" + nossoNumero.substring(4, nossoNumero.length()) + "' ";
			}else if(nossoNumero.startsWith("000")) {
				sql += " or nossonumero= '" + nossoNumero.substring(3, nossoNumero.length()) + "' ";
			}else if(nossoNumero.startsWith("00")) { 
				sql += " or nossonumero= '" + nossoNumero.substring(2, nossoNumero.length()) + "' ";
			}else if(nossoNumero.startsWith("0")) { 
				sql += " or nossonumero= '" + nossoNumero.substring(1, nossoNumero.length()) + "' ";
			}	
			sql += " ) ";
			sql += " order by codigo desc limit 1";
			rs = getConexao().getJdbcTemplate().queryForRowSet(sql);
			if (rs.next()) {
				nncc = new ContaReceberVO();
				// montar dados do nossonumerocontareceber
				nncc.getPessoa().setNome(rs.getString("nomePessoa"));
				montarDadosNossoNumeroContaReceber(nncc, rs, usuario);
			}
			return nncc;
		} catch (Exception e) {
			return nncc;
		}
	
		
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarContaReceberRemetidaComAlteracao(final Integer codContaReceber, final ContaReceberVO obj) throws Exception {
		final String sql = "UPDATE ContaReceber set contaRemetidaComAlteracao=?, contaRemetidaComAlteracao_dataDescProgressivo=?, contaRemetidaComAlteracao_dataVencimento=?, "
				+ " contaRemetidaComAlteracao_valorBase=?, contaRemetidaComAlteracao_valorComAbatimentoAdicionadoOuModific=?, contaRemetidaComAlteracao_valorComAbatimentoRemovido=?, contaRemetidaComAlteracao_valorDescProgressivo=? "
				+ "WHERE (codigo = ?)";
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setBoolean(1, obj.getContaRemetidaComAlteracao());
				sqlAlterar.setBoolean(2, obj.getContaRemetidaComAlteracao_dataDescProgressivo());
				sqlAlterar.setBoolean(3, obj.getContaRemetidaComAlteracao_dataVencimento());
				sqlAlterar.setBoolean(4, obj.getContaRemetidaComAlteracao_valorBase());
				sqlAlterar.setBoolean(5, obj.getContaRemetidaComAlteracao_valorComAbatimentoAdicionadoOuModificado());
				sqlAlterar.setBoolean(6, obj.getContaRemetidaComAlteracao_valorComAbatimentoRemovido());
				sqlAlterar.setBoolean(7, obj.getContaRemetidaComAlteracao_valorDescProgressivo());
				sqlAlterar.setInt(8, codContaReceber);
				return sqlAlterar;
			}
		});
	}

	public void alterarBooleanEmissaoBoletoRealizada(final Integer codContaReceber, final boolean impressaoBoletoRealizada, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set impressaoBoletoRealizada=? WHERE (codigo = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setBoolean(1, impressaoBoletoRealizada);
				sqlAlterar.setInt(2, codContaReceber);
				return sqlAlterar;
			}
		});
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarNossoNumeroLinhaDigitavel(final Integer codContaReceber, final String nossoNumero, final String linhaDigitavelCodigoBarras, final String codigoBarra, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set nossonumero=?, linhaDigitavelCodigoBarras=?, codigoBarra=?  WHERE (codigo = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			
			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setString(1, nossoNumero);
				sqlAlterar.setString(2, linhaDigitavelCodigoBarras);
				sqlAlterar.setString(3, codigoBarra);
				sqlAlterar.setInt(4, codContaReceber);
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarParceiro(final Integer codParceiroManter, final Integer codParceiroRemover, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set parceiro=? WHERE (parceiro = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setInt(1, codParceiroManter);
				sqlAlterar.setInt(2, codParceiroRemover);
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	@Override
	public void incluirValorTaxaBoleto(final Integer codContaReceber, final Double taxaBoleto, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set taxaBoleto=? WHERE (codigo = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setDouble(1, taxaBoleto);
				sqlAlterar.setInt(2, codContaReceber);
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	@Override
	public void alterarSituacaoSuplicidadeTratada(final Integer codContaReceber, final Boolean tratada, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set duplicidadeTratada=? WHERE (codigo = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setBoolean(1, tratada);
				sqlAlterar.setInt(2, codContaReceber);
				return sqlAlterar;
			}
		});
		ContaReceberVO obj = new ContaReceberVO();
		obj.setDuplicidadeTratada(tratada);
		obj.setCodigo(codContaReceber);
		getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(obj, "dup.tratada-" + tratada, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	@Override
	public void executarBloqueioContaReceber(final Integer codigoContaReceber, final Integer codigoRegistroCobranca, UsuarioVO usuario) throws Exception {
		final String sql = "update contaReceber set registrocobrancacontareceber = ? where codigo = ?" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setInt(1, codigoRegistroCobranca);
				sqlAlterar.setInt(2, codigoContaReceber);
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	@Override
	public void executarDesbloqueioContaReceber(final Integer codigoContaReceber, UsuarioVO usuario) throws Exception {
		final String sql = "update contaReceber set registrocobrancacontareceber = null where codigo = ?" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setInt(1, codigoContaReceber);
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarDataArquivoRemessaContasRejeitadas(final Integer codContaReceber, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set dataarquivoremessa=? WHERE (codigo = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setNull(1, 0);
				sqlAlterar.setInt(2, codContaReceber);
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarIdentificacaoTituloBanco(final String nossoNumero, final String identificacaoTituloBanco, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set identificacaoTituloBanco=? WHERE nossoNumero = ?" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setString(1, identificacaoTituloBanco);
				sqlAlterar.setString(2, nossoNumero);
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarDataVencimentoContaReceber(final Integer codContaReceber, final Date dataVencimento, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set dataVencimento=? WHERE (codigo = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);

		// verificar bloquear aqui
		ContaReceberVO contaReceber = new ContaReceberVO();
		contaReceber.setCodigo(codContaReceber);
		carregarDados(contaReceber, NivelMontarDados.BASICO, null, usuario);
		verificarCompetenciaBloqueadaParaRegistrosEntidade(contaReceber, "ALTERAR", dataVencimento, dataVencimento, contaReceber.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);

		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setDate(1, Uteis.getDataJDBC(dataVencimento));
				sqlAlterar.setInt(2, codContaReceber);
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarNossoNumeroBancoContasValidadas(final Integer codContaReceber, final String nossoNumeroBanco, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set nossonumerobanco=? WHERE (codigo = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setString(1, nossoNumeroBanco);
				sqlAlterar.setInt(2, codContaReceber);
				return sqlAlterar;
			}
		});
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# gerarNumeroDocumento(negocio.comuns.administrativo .UnidadeEnsinoVO)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# gerarNumeroDocumento(negocio.comuns.administrativo .UnidadeEnsinoVO)
	 */
	public String gerarNumeroDocumento(UnidadeEnsinoVO unidadeEnsino, UsuarioVO usuario) throws Exception {
		UnidadeEnsinoVO obj = getFacadeFactory().getUnidadeEnsinoFacade().consultarPorChavePrimaria(unidadeEnsino.getCodigo().intValue(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
		String numDocumento = Uteis.getCompletarNumeroComZero(2, obj.getCodigo().intValue());
		if (Uteis.getAnoDataAtual4Digitos().equals(obj.getAno())) {
			numDocumento += obj.getAno();
		} else {
			Integer novoAno = Integer.parseInt(obj.getAno()) + 1;
			obj.setAno(String.valueOf(novoAno));
			obj.setNumeroDocumento(1);
			numDocumento += obj.getAno();
		}
		numDocumento += Uteis.getCompletarNumeroComZero(7, obj.getNumeroDocumento().intValue());
		obj.setNumeroDocumento(obj.getNumeroDocumento() + 1);
		getFacadeFactory().getUnidadeEnsinoFacade().alterarAnoNumeroDocumento(obj);
		return numDocumento;
	}

	public String gerarNumeroDocumentoPorPessoaConvenio(Integer pessoa, Integer parceiro, String tipoPessoa, UsuarioVO usuarioVO) throws Exception {
		String numeroDocumento = "";
		if (tipoPessoa.equals("PA")) {
			numeroDocumento = getFacadeFactory().getNumeroDocumentoContaReceberFacade().gerarNumeroDocumentoTipoParceiro(parceiro, usuarioVO);
		} else {
			numeroDocumento = getFacadeFactory().getNumeroDocumentoContaReceberFacade().gerarNumeroDocumentoTipoPessoa(pessoa, usuarioVO);
		}
		return numeroDocumento;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# criarContaReceber(negocio.comuns.financeiro. DevolucaoChequeVO)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# criarContaReceber(negocio.comuns.financeiro. DevolucaoChequeVO)
	 */
	public ContaReceberVO criarContaReceber(DevolucaoChequeVO devolucaoChequeVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		ContaCorrenteVO contaCorrenteVO = null;
		if (Uteis.isAtributoPreenchido(devolucaoChequeVO.getUnidadeEnsino().getContaCorrentePadraoDevolucaoCheque())) {
			contaCorrenteVO = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(devolucaoChequeVO.getUnidadeEnsino().getContaCorrentePadraoDevolucaoCheque(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
		} else if (Uteis.isAtributoPreenchido(configuracaoFinanceiro.getContaCorrentePadraoDevolucaoCheque())) {
			contaCorrenteVO = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(configuracaoFinanceiro.getContaCorrentePadraoDevolucaoCheque(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
		} else {
			throw new Exception(UteisJSF.internacionalizar("msg_DevolucaoCheque_contaCorrentePadrao"));
		}
		if (devolucaoChequeVO.getParceiro().getCodigo() > 0) {
			return criarContaReceber(null, devolucaoChequeVO.getParceiro(), null, devolucaoChequeVO.getUnidadeEnsino(), contaCorrenteVO, devolucaoChequeVO.getCodigo(), TipoOrigemContaReceber.DEVOLUCAO_CHEQUE.getValor(), devolucaoChequeVO.getCheque().getDataPrevisao(), devolucaoChequeVO.getCheque().getDataPrevisao(), devolucaoChequeVO.getCheque().getValor(), devolucaoChequeVO.getCentroReceita().getCodigo(), 1, 1, TipoBoletoBancario.OUTROS.getValor(), configuracaoFinanceiro, usuario, null, "");
		}
		if (devolucaoChequeVO.getFornecedor().getCodigo() > 0) {
			return criarContaReceber(null, null, null, devolucaoChequeVO.getUnidadeEnsino(), contaCorrenteVO, devolucaoChequeVO.getCodigo(), TipoOrigemContaReceber.DEVOLUCAO_CHEQUE.getValor(), devolucaoChequeVO.getCheque().getDataPrevisao(), devolucaoChequeVO.getCheque().getDataPrevisao(), devolucaoChequeVO.getCheque().getValor(), devolucaoChequeVO.getCentroReceita().getCodigo(), 1, 1, TipoBoletoBancario.OUTROS.getValor(), configuracaoFinanceiro, usuario, devolucaoChequeVO.getFornecedor(), "");
		}
		if (!devolucaoChequeVO.getCodigo().equals(0) && !devolucaoChequeVO.getContaReceberVO().getMatriculaAluno().getMatricula().equals("")) {
			return criarContaReceber(devolucaoChequeVO.getContaReceberVO().getMatriculaAluno(), devolucaoChequeVO.getPessoa(), devolucaoChequeVO.getUnidadeEnsino(), contaCorrenteVO, devolucaoChequeVO.getCodigo(), TipoOrigemContaReceber.DEVOLUCAO_CHEQUE.getValor(), devolucaoChequeVO.getCheque().getDataPrevisao(), devolucaoChequeVO.getCheque().getDataPrevisao(), devolucaoChequeVO.getCheque().getValor(), devolucaoChequeVO.getCentroReceita().getCodigo(), TipoBoletoBancario.OUTROS.getValor(), configuracaoFinanceiro, usuario, null);
		} else {
			return criarContaReceber(null, devolucaoChequeVO.getPessoa(), devolucaoChequeVO.getUnidadeEnsino(), contaCorrenteVO, devolucaoChequeVO.getCodigo(), TipoOrigemContaReceber.DEVOLUCAO_CHEQUE.getValor(), devolucaoChequeVO.getCheque().getDataPrevisao(), devolucaoChequeVO.getCheque().getDataPrevisao(), devolucaoChequeVO.getCheque().getValor(), devolucaoChequeVO.getCentroReceita().getCodigo(), TipoBoletoBancario.OUTROS.getValor(), configuracaoFinanceiro, usuario, null);
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#criarContaReceber (negocio.comuns.basico.PessoaVO, negocio.comuns.administrativo.UnidadeEnsinoVO, negocio.comuns.financeiro.ContaCorrenteVO, int, java.lang.String, java.util.Date, double, int, java.lang.String)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#criarContaReceber (negocio.comuns.basico.PessoaVO, negocio.comuns.administrativo.UnidadeEnsinoVO, negocio.comuns.financeiro.ContaCorrenteVO, int, java.lang.String, java.util.Date, double, int, java.lang.String)
	 */
	public ContaReceberVO criarContaReceber(MatriculaVO matricula, PessoaVO pessoaVO, UnidadeEnsinoVO unidadeEnsinoVO, ContaCorrenteVO contaCorrenteVO, int codigoOrigem, String tipoOrigem, Date dataVencimento, Date dataCompetencia, double valor, int centroReceita, String tipoBoleto, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, FornecedorVO fornecedorVO) throws Exception {
		return criarContaReceber(matricula, null, pessoaVO, unidadeEnsinoVO, contaCorrenteVO, codigoOrigem, tipoOrigem, dataVencimento, dataCompetencia, valor, centroReceita, 1, 1, tipoBoleto, configuracaoFinanceiro, usuario, fornecedorVO, "");
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#criarContaReceber (negocio.comuns.financeiro.ParceiroVO , negocio.comuns.basico.PessoaVO, negocio.comuns.administrativo.UnidadeEnsinoVO, negocio.comuns.financeiro.ContaCorrenteVO, int, java.lang.String, java.util.Date, double, int, int, int, java.lang.String)
	 */
	public ContaReceberVO criarContaReceber(MatriculaVO matricula, ParceiroVO parceiro, PessoaVO pessoaVO, UnidadeEnsinoVO unidadeEnsinoVO, ContaCorrenteVO contaCorrenteVO, int codigoOrigem, String tipoOrigem, Date dataVencimento, Date dataCompetencia, double valor, int centroReceita, int numParcela, int totalParcelas, String tipoBoleto, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, FornecedorVO fornecedorVO, String observacao) throws Exception {
		return criarContaReceber(matricula, parceiro, pessoaVO, unidadeEnsinoVO, unidadeEnsinoVO, contaCorrenteVO, codigoOrigem, tipoOrigem, dataVencimento, dataCompetencia, valor, centroReceita, numParcela, totalParcelas, tipoBoleto, null, configuracaoFinanceiro, usuario, fornecedorVO, 0, observacao, null);
	}

	// Possui atributo partePrefixoParcela para informar parte final da parcela,
	// usado na inclusão de disciplinas fora do prazo
	public ContaReceberVO criarContaReceberInclusaoForaPrazo(MatriculaVO matricula, ParceiroVO parceiro, PessoaVO pessoaVO, UnidadeEnsinoVO unidadeEnsinoVO, ContaCorrenteVO contaCorrenteVO, int codigoOrigem, String tipoOrigem, Date dataVencimento, Date dataCompetencia, double valor, int centroReceita, int numParcela, int totalParcelas, String tipoBoleto, String partePrefixoParcela, TurmaVO turma, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, Integer matriculaPeriodo) throws Exception {
		if (tipoOrigem.endsWith("IRE") && (codigoOrigem == matriculaPeriodo)) {
			matriculaPeriodo = 0;
		}
		return criarContaReceber(matricula, parceiro, pessoaVO, unidadeEnsinoVO, unidadeEnsinoVO, contaCorrenteVO, codigoOrigem, tipoOrigem, dataVencimento, dataCompetencia, valor, centroReceita, numParcela, totalParcelas, tipoBoleto, partePrefixoParcela, turma, configuracaoFinanceiro, usuario, null, matriculaPeriodo, "", null);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#criarContaReceber (negocio.comuns.financeiro.ParceiroVO , negocio.comuns.basico.PessoaVO, negocio.comuns.administrativo.UnidadeEnsinoVO, negocio.comuns.administrativo.UnidadeEnsinoVO, negocio.comuns.financeiro.ContaCorrenteVO, int, java.lang.String, java.util.Date, double, int, int, int, java.lang.String)
	 */
	public ContaReceberVO criarContaReceber(MatriculaVO matricula, ParceiroVO parceiro, PessoaVO pessoaVO, UnidadeEnsinoVO unidadeEnsinoVO, UnidadeEnsinoVO unidadeEnsinoVOAluno, ContaCorrenteVO contaCorrenteVO, int codigoOrigem, String tipoOrigem, Date dataVencimento, Date dataCompetencia, double valor, int centroReceita, int numParcela, int totalParcelas, String tipoBoleto, String partePrefixoParcela, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, FornecedorVO fornecedorVO, Integer matriculaPeriodo, String observacao, DepartamentoVO departamentoVO) throws Exception {
		return criarContaReceber(matricula, parceiro, pessoaVO, unidadeEnsinoVO, unidadeEnsinoVOAluno, contaCorrenteVO, codigoOrigem, tipoOrigem, dataVencimento, dataCompetencia, valor, centroReceita, numParcela, totalParcelas, tipoBoleto, partePrefixoParcela, null, configuracaoFinanceiro, usuario, fornecedorVO, matriculaPeriodo, observacao, departamentoVO);
	}

	public ContaReceberVO criarContaReceber(MatriculaVO matricula, ParceiroVO parceiro, PessoaVO pessoaVO, UnidadeEnsinoVO unidadeEnsinoVO, UnidadeEnsinoVO unidadeEnsinoVOAluno, ContaCorrenteVO contaCorrenteVO, int codigoOrigem, String tipoOrigem, Date dataVencimento, Date dataCompetencia, double valor, int centroReceita, int numParcela, int totalParcelas, String tipoBoleto, String partePrefixoParcela, TurmaVO turma, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, FornecedorVO fornecedorVO, Integer matriculaPeriodo, String observacao, DepartamentoVO departamentoVO) throws Exception {
		ContaReceberVO contaReceber = new ContaReceberVO();
		if (usuario.getUsuarioJaLiberouRegistroCompetenciaFechada()) { 
			contaReceber.liberarVerificacaoBloqueioFechamentoMes();
		}
		if (fornecedorVO != null && fornecedorVO.getCodigo() != 0) {
			contaReceber.setFornecedor(fornecedorVO);
			contaReceber.setTipoPessoa("FO");
		} else if (parceiro != null && parceiro.getCodigo() != 0) {
			contaReceber.setParceiroVO(parceiro);
			contaReceber.setTipoPessoa("PA");
		} else {
			// getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO,
			// usuario);
			contaReceber.setPessoa(pessoaVO);
			TipoPessoa tipoPessoa = TipoPessoa.getEnum(pessoaVO.getTipoPessoa());
			FuncionarioVO funcionario;
			if (tipoPessoa == null) {
				throw new ConsistirException("Usuário, a pessoa em questão não está com (TIPO PESSOA) definido.");
			}
			switch (tipoPessoa) {
			case ALUNO:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				if (matricula == null || matricula.getMatricula().equals("")) {
					contaReceber.setMatriculaAluno(getFacadeFactory().getMatriculaFacade().getUtimaMatricula(getFacadeFactory().getMatriculaFacade().consultarMatriculaPorCodigoPessoa(pessoaVO.getCodigo(), unidadeEnsinoVOAluno.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuario)));
				} else if (!matricula.getMatricula().equalsIgnoreCase("")) {
					getFacadeFactory().getMatriculaFacade().carregarDados(matricula, NivelMontarDados.BASICO, usuario);
					contaReceber.setMatriculaAluno(matricula);
				}
				contaReceber.setTipoPessoa(TipoPessoa.ALUNO.getValor());

				break;
			case RESPONSAVEL_FINANCEIRO:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				contaReceber.setTipoPessoa(TipoPessoa.RESPONSAVEL_FINANCEIRO.getValor());
				contaReceber.getResponsavelFinanceiro().setCodigo(pessoaVO.getCodigo());
				if (matricula == null || matricula.getMatricula().equals("")) {
					contaReceber.setMatriculaAluno(getFacadeFactory().getMatriculaFacade().getUtimaMatricula(getFacadeFactory().getMatriculaFacade().consultarMatriculaPorCodigoPessoa(pessoaVO.getCodigo(), unidadeEnsinoVOAluno.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuario)));
					contaReceber.getPessoa().setCodigo(contaReceber.getMatriculaAluno().getAluno().getCodigo());
				} else if (!matricula.getMatricula().equalsIgnoreCase("")) {
					getFacadeFactory().getMatriculaFacade().carregarDados(matricula, NivelMontarDados.BASICO, usuario);
					contaReceber.setMatriculaAluno(matricula);
					contaReceber.getPessoa().setCodigo(contaReceber.getMatriculaAluno().getAluno().getCodigo());
				}
				break;
			case CANDIDATO:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				contaReceber.setCandidato(pessoaVO);
				contaReceber.setTipoPessoa(TipoPessoa.CANDIDATO.getValor());
				break;
			case FUNCIONARIO:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				funcionario = getFacadeFactory().getFuncionarioFacade().consultarPorCodigoPessoa(pessoaVO.getCodigo(), unidadeEnsinoVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				contaReceber.setFuncionario(funcionario);
				contaReceber.setTipoPessoa(TipoPessoa.FUNCIONARIO.getValor());
				break;
			case MEMBRO_COMUNIDADE:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				contaReceber.setTipoPessoa(TipoPessoa.MEMBRO_COMUNIDADE.getValor());
				break;
			case REQUERENTE:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				contaReceber.setTipoPessoa(TipoPessoa.REQUERENTE.getValor());
				break;
			case PROFESSOR:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				funcionario = getFacadeFactory().getFuncionarioFacade().consultarPorCodigoPessoa(pessoaVO.getCodigo(), unidadeEnsinoVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				contaReceber.setFuncionario(funcionario);
				contaReceber.setTipoPessoa(TipoPessoa.FUNCIONARIO.getValor());
				break;
			default:
				break;

			}
		}

		// ConfiguracaoFinanceiroVO conf =
		// getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_DADOSBASICOS,
		// usuario, null);
		if (contaReceber.getMatriculaAluno().getUnidadeEnsino().getCodigo() != null && !contaReceber.getMatriculaAluno().getUnidadeEnsino().getCodigo().equals(0)
				&& (unidadeEnsinoVO == null || unidadeEnsinoVO.getCodigo() == null || unidadeEnsinoVO.getCodigo().equals(0))) {
			unidadeEnsinoVO = contaReceber.getMatriculaAluno().getUnidadeEnsino();
		}
		contaReceber.setJuroPorcentagem(configuracaoFinanceiro.getPercentualJuroPadrao());
		contaReceber.setMultaPorcentagem(configuracaoFinanceiro.getPercentualMultaPadrao());
		contaReceber.setUnidadeEnsino(unidadeEnsinoVO);
		contaReceber.setContaCorrente(contaCorrenteVO.getCodigo());
		contaReceber.setContaCorrenteVO(getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(contaCorrenteVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
		contaReceber.setEmissaoBloqueada(verificaBloqueioEmissaoBoleto(contaReceber, usuario));
		boolean possuiPermissaoEmitirBoletoVencido = ControleAcesso.verificarPermissaoFuncionalidadeUsuario("ImprimirBoletoVencidoVisaoAluno", usuario);
		validarTipoImpressaoPorContaReceber(contaReceber, possuiPermissaoEmitirBoletoVencido, usuario);
		contaReceber.setCodOrigem(String.valueOf(codigoOrigem));
		contaReceber.setTipoOrigem(tipoOrigem);
		if (!tipoOrigem.equals("MAT") && !tipoOrigem.equals("MEN")) {
			contaReceber.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceber.getValor());
			contaReceber.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceber.getValor());
			contaReceber.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceber.getValor());
			contaReceber.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceber.getValor());
		} else if (tipoOrigem.equals("OUT")) {
			contaReceber.setObservacao(observacao);
		}
		if (dataVencimento == null) {
			throw new Exception("Para geração da(s) parcela(s) é necessário informar a nova data de vencimento.");
		} else {
			contaReceber.setDataVencimento(dataVencimento);// devolucaoChequeVO.getCheque().getDataPrevisao()
			contaReceber.setDataCompetencia(Uteis.getDataPrimeiroDiaMes(dataCompetencia));// devolucaoChequeVO.getCheque().getDataPrevisao()
		}
		if (partePrefixoParcela == null || partePrefixoParcela.equals("")) {
			ContaReceberVO c = this.consultarNomeUltimaParcela(contaReceber.getPessoa().getCodigo());
			contaReceber.setParcela(String.valueOf(numParcela) + "/" + String.valueOf(totalParcelas));
			if (c.getParcela().equals(contaReceber.getParcela()) && !tipoOrigem.equals("CTR")) {
				Integer parcelas = this.consultarListaNomeUltimaParcela(contaReceber.getPessoa().getCodigo());
				contaReceber.setParcela(String.valueOf(parcelas + 1) + "/" + String.valueOf(totalParcelas));
			}
		} else {
			ContaReceberVO c = this.consultarNomeUltimaParcela(contaReceber.getPessoa().getCodigo());
			contaReceber.setParcela(String.valueOf(numParcela) + "/" + String.valueOf(totalParcelas) + partePrefixoParcela);
			if (c.getParcela().equals(contaReceber.getParcela())) {
				contaReceber.setParcela(contaReceber.getParcela() + contaReceber.getPessoa().getCodigo());
			}
			if (tipoOrigem.equals("MAT") || tipoOrigem.equals("MEN")) {
				contaReceber.setMatriculaPeriodo(codigoOrigem);
			}
		}
		if (!matriculaPeriodo.equals(0)) {
			contaReceber.setMatriculaPeriodo(matriculaPeriodo);
			// try {
			// MatriculaPeriodoVO matPer = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(matriculaPeriodo, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiro, usuario);
			// contaReceber.setTurma(matPer.getTurma());
			// } catch (Exception e) {
			// contaReceber.setTurma(new TurmaVO());
			// }
		}
		if (turma != null && turma.getCodigo().intValue() > 0) {
			contaReceber.setTurma(turma);
		} else {
			if (!contaReceber.getTipoOrigem().equals("IRE")) {
				if (!contaReceber.getMatriculaAluno().getMatricula().equals("")) {
					turma = getFacadeFactory().getTurmaFacade().consultaRapidaPorMatriculaUltimaMatriculaPeriodo(contaReceber.getMatriculaAluno().getMatricula(), usuario);
					if (turma != null) {
						contaReceber.setTurma(turma);
					}
				}
			}
		}

		contaReceber.setValor(valor);
		contaReceber.setValorBaseContaReceber(valor);
		contaReceber.setValorRecebido(0.0);
		contaReceber.getCentroReceita().setCodigo(centroReceita);
		contaReceber.setTipoBoleto(tipoBoleto);
		// contaReceber.setNrDocumento(gerarNumeroDocumento(unidadeEnsinoVO,
		// usuario));
		contaReceber.setNrDocumento(gerarNumeroDocumentoPorPessoaConvenio(contaReceber.getPessoa().getCodigo(), contaReceber.getParceiroVO().getCodigo(), contaReceber.getTipoPessoa(), usuario));
		if (valor <= 0) {
			contaReceber.setSituacao(SituacaoContaReceber.RECEBIDO.getValor());
		}
		contaReceber.setConfiguracaoFinanceiro(configuracaoFinanceiro);
		contaReceber.setDepartamentoVO(departamentoVO);
		incluir(contaReceber, false, configuracaoFinanceiro, usuario);
		if (valor <= 0) {
			ContaReceberNegociacaoRecebimentoVO contaReceberNegociacaoRecebimentoVO = new ContaReceberNegociacaoRecebimentoVO();
			contaReceberNegociacaoRecebimentoVO.setContaReceber(contaReceber);
			NegociacaoRecebimentoVO negociacaoRecebimentoVO = new NegociacaoRecebimentoVO();
			negociacaoRecebimentoVO.setResponsavel(usuario);
			negociacaoRecebimentoVO.setUnidadeEnsino(contaReceber.getUnidadeEnsino());
			negociacaoRecebimentoVO.setContaCorrenteCaixa(contaCorrenteVO);
			negociacaoRecebimentoVO.setPessoa(contaReceber.getPessoa());
			negociacaoRecebimentoVO.setTipoPessoa(contaReceber.getTipoPessoa());
			negociacaoRecebimentoVO.getContaReceberNegociacaoRecebimentoVOs().add(contaReceberNegociacaoRecebimentoVO);
			getFacadeFactory().getNegociacaoRecebimentoFacade().incluir(negociacaoRecebimentoVO, configuracaoFinanceiro, false, usuario);
		}

		return contaReceber;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluir(final ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		incluir(obj, true, configuracaoFinanceiro, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluir(final ContaReceberVO obj, final boolean verificarPermissao, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		final Date updated = new Date();
		String situacao = obj.getSituacao();
		try {
			ContaReceber.incluir(getIdEntidade(), verificarPermissao, usuario);
			verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "INCLUIR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);
			if (!Uteis.isAtributoPreenchido(configuracaoFinanceiro)) {
				configuracaoFinanceiro = getConfiguracaoFinanceiroPrevilegiandoUnidadeEnsino(obj.getUnidadeEnsinoFinanceira().getCodigo(), usuario);
			}
			obj.setUsaDescontoCompostoPlanoDesconto(configuracaoFinanceiro.getUsaDescontoCompostoPlanoDesconto());
			if (!Uteis.isAtributoPreenchido((obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getCodigo()))) {
				abaterValorDescontoConvenioNoValorContaReceberParaConvenioConfiguradosComEstaFinalidade(obj, usuario);
				if (!obj.getSituacaoEQuitada()) {
					realizarAtualizacaoIndiceReajustePrecoContaReceber(obj, obj.getMatriculaPeriodo(), usuario);
					obj.atualizarSituacaoContaReceberDeAcordoComDescontos(configuracaoFinanceiro, null, usuario);
					getFacadeFactory().getContaReceberFacade().realizarAtualizacaoValorDescontoFaixaContaReceber(obj, configuracaoFinanceiro, false);
				}
			}
			ContaReceberVO.validarDados(obj);
			realizarVinculoContaReceberComResponsavelFinanceiro(obj, usuario);
			executarCriacaoVinculoContaReceberComTurma(obj, usuario);
			executarCriacaoVinculoContaReceberComCodigoOrigem(obj, usuario);
			if (obj.getSituacao().equals("RE") && obj.getValorRecebido() < 0) {
				obj.setValorRecebido(0.0);
			}
			if (obj.getTipoBoleto().equals("")) {
				obj.setTipoBoleto("OU");
			}
						
			incluir(obj, "contareceber", new AtributoPersistencia().add("data", Uteis.getDataJDBC(obj.getData())).add("codOrigem", obj.getCodOrigem())
					.add("tipoOrigem", obj.getTipoOrigem()).add("situacao", obj.getSituacao()).add("descricaoPagamento", obj.getDescricaoPagamento())
					.add("dataVencimento", Uteis.getDataJDBC(obj.getDataVencimento())).add("valor", obj.getValor()).add("valorDesconto", obj.getValorDesconto())
					.add("juro", obj.getJuro()).add("juroPorcentagem", obj.getJuroPorcentagem()).add("multa", obj.getMulta()).add("multaPorcentagem", obj.getMultaPorcentagem())
					.add("nrDocumento", obj.getNrDocumento()).add("parcela", obj.getParcela()).add("centroReceita", obj.getCentroReceita()).add("matriculaAluno", Uteis.isAtributoPreenchido(obj.getMatriculaAluno().getMatricula())? obj.getMatriculaAluno().getMatricula() : null )
					.add("funcionario", obj.getFuncionario()).add("origemNegociacaoReceber", obj.getOrigemNegociacaoReceber().intValue() != 0 ? obj.getOrigemNegociacaoReceber().intValue() != 0 : null)
					.add("candidato", obj.getCandidato()).add("tipoPessoa", obj.getTipoPessoa()).add("pessoa", obj.getPessoa()).add("contaCorrente", obj.getContaCorrente())
					.add("descontoProgressivo", obj.getDescontoProgressivo()).add("valorRecebido", obj.getValorRecebido()).add("tipoDesconto", obj.getTipoDesconto()).add("unidadeEnsino", obj.getUnidadeEnsino())
					.add("valorDescontoRecebido", obj.getValorDescontoRecebido()).add("descontoInstituicao", obj.getValorDescontoInstituicao()).add("descontoConvenio", obj.getValorDescontoConvenio())
					.add("convenio", obj.getConvenio()).add("tipoBoleto", obj.getTipoBoleto()).add("linhaDigitavelCodigoBarras", obj.getLinhaDigitavelCodigoBarras()).add("codigoBarra", obj.getCodigoBarra())
					.add("beneficiario", obj.getTipoOrigem().equals("BCC") ? obj.getBeneficiario() : null).add("nossonumero", obj.getNossoNumero()).add("parceiro", obj.getParceiroVO()).add("matriculaPeriodo", Uteis.isAtributoPreenchido(obj.getMatriculaPeriodo()) ? obj.getMatriculaPeriodo() : null)
					.add("valorDescontoProgressivo",obj.getValorDescontoProgressivo()).add("recebimentoBancario", obj.getRecebimentoBancario() == null ? null : obj.getRecebimentoBancario())
					.add("ordemConvenio", obj.getOrdemConvenio()).add("ordemConvenioValorCheio", obj.getOrdemConvenioValorCheio()).add("ordemDescontoAluno", obj.getOrdemDescontoAluno()).add("ordemDescontoAlunoValorCheio", obj.getOrdemDescontoAlunoValorCheio())
					.add("ordemDescontoProgressivo", obj.getOrdemDescontoProgressivo()).add("ordemDescontoProgressivoValorCheio", obj.getOrdemDescontoProgressivoValorCheio()).add("ordemPlanoDesconto", obj.getOrdemPlanoDesconto())
					.add("ordemPlanoDescontoValorCheio", obj.getOrdemPlanoDescontoValorCheio()).add("justificativaDesconto", obj.getJustificativaDesconto()).add("valorDescontoLancadoRecebimento", obj.getValorDescontoLancadoRecebimento())
					.add("valorcalculadodescontolancadorecebimento", obj.getValorCalculadoDescontoLancadoRecebimento()).add("tipodescontolancadorecebimento", obj.getTipoDescontoLancadoRecebimento())
					.add("valorDescontoAlunoJaCalculado", obj.getValorDescontoAlunoJaCalculado()).add("impressaoBoletoRealizada", obj.getImpressaoBoletoRealizada()).add("dataArquivoRemessa", obj.getDataArquivoRemessa())
					.add("descontoProgressivoUtilizado", obj.getDescontoProgressivoUtilizado() == null ? null : obj.getDescontoProgressivoUtilizado().getDescricao()).add("valorDescontoCalculadoPrimeiraFaixaDescontos", obj.getValorDescontoCalculadoPrimeiraFaixaDescontos())
					.add("valorDescontoCalculadoSegundaFaixaDescontos",  obj.getValorDescontoCalculadoSegundaFaixaDescontos()).add("valorDescontoCalculadoTerceiraFaixaDescontos", obj.getValorDescontoCalculadoTerceiraFaixaDescontos())
					.add("valorDescontoCalculadoQuartaFaixaDescontos",  obj.getValorDescontoCalculadoQuartaFaixaDescontos()).add("updated",Uteis.getDataJDBCTimestamp(updated))
					.add("acrescimo",  obj.getAcrescimo()).add("usaDescontoCompostoPlanoDesconto", obj.getUsaDescontoCompostoPlanoDesconto()).add("codigoRenegociacao",  obj.getRenegociacaoContaReceberOrigem())
					.add("responsavelFinanceiro",  obj.getResponsavelFinanceiro()).add("turma", obj.getTurma()).add("duplicidadeTratada",  obj.getDuplicidadeTratada()).add("fornecedor", obj.getFornecedor())
					.add("valorCusteadoContaReceber",  obj.getValorCusteadoContaReceber()).add("valorBaseContaReceber", obj.getValorBaseContaReceber()).add("valorReceberCalculado",  obj.getValorReceberCalculado())
					.add("dataCompetencia",  Uteis.getDataJDBC(obj.getDataCompetencia())).add("processamentoIntegracaoFinanceiraDetalhe", obj.getProcessamentoIntegracaoFinanceiraDetalheVO()).add("possuiPendenciasFinanceirasExternas",  obj.getPossuiPendenciasFinanceirasExternas())					
					.add("valorDescontoRateio",  obj.getValorDescontoRateio()).add("unidadeensinofinanceira", obj.getUnidadeEnsinoFinanceira()).add("valorIndiceReajuste",  obj.getValorIndiceReajuste())
					.add("contaEditadaManualmente",  obj.getContaEditadaManualmente()).add("utilizarDescontoProgressivoManual", obj.getUtilizarDescontoProgressivoManual()).add("diaLimite1",  obj.getDiaLimite1())
					.add("diaLimite2",  obj.getDiaLimite2()).add("diaLimite3", obj.getDiaLimite3()).add("diaLimite4",  obj.getDiaLimite4()).add("possuiFiesIntegracaoFinanceiras", obj.getPossuiFiesIntegracaoFinanceiras())
					.add("dataLimitePrimeiraFaixaDescontos",  obj.getDataLimitePrimeiraFaixaDescontos()).add("dataLimiteSegundaFaixaDescontos", obj.getDataLimiteSegundaFaixaDescontos())
					.add("dataLimiteTerceiraFaixaDescontos",  obj.getDataLimiteTerceiraFaixaDescontos()).add("dataLimiteQuartaFaixaDescontos", obj.getDataLimiteQuartaFaixaDescontos())
					.add("valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa", obj.getValorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa())
					, usuario);
			obj.setNovoObj(Boolean.FALSE);		
			obj.setUpdated(updated);
			ContaCorrenteVO contaCorrenteVO = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(obj.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
			obj.setContaCorrenteVO(contaCorrenteVO);
			if (!Uteis.isAtributoPreenchido((obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getCodigo()))) {
				obj.setConfiguracaoFinanceiro(configuracaoFinanceiro);
				gerarNumeroDoc(obj, contaCorrenteVO.getAgencia().getBanco().getNrBanco(), usuario);
				getFacadeFactory().getPlanoDescontoContaReceberFacade().incluirItensPlanoDescontoContaReceber(obj.getCodigo(), obj.getPlanoDescontoContaReceberVOs(), usuario, verificarPermissao);
				if (configuracaoFinanceiro.getGerarBoletoComDescontoSemValidade()) {
					obj.setGerarBoletoComDescontoSemValidade(Boolean.TRUE);
					executarCalculoValorBoletoDescontoSemValidade(obj, configuracaoFinanceiro, usuario);
				}
				
			}
			
			obj.criarBoleto(contaCorrenteVO);
			if (obj.getTipoOrigem().equals("OUT") && obj.getCodOrigem().equals("")) {
				obj.setCodOrigem(obj.getCodigo().toString());
			}
			// alterar(obj, false, configuracaoFinanceiro, usuario);
			if (Uteis.isAtributoPreenchido(obj.getCodigoBarra()) && obj.getCodigoBarra().length() > 50) {
				throw new ConsistirException("O código de barras da conta a receber excede o limite de 50 caracteres. Revise os dados da conta corrente (" + obj.getContaCorrenteVO().getDescricaoCompletaConta() + ")");
			}
			registrarLinhaDigitavelCodigoBarrasBoletoNossoNumeroContaReceber(obj.getCodigo(), obj.getNossoNumero(), obj.getNrDocumento(), obj.getCodigoBarra(), obj.getLinhaDigitavelCodigoBarras(), usuario);
			obj.setNovoObj(Boolean.FALSE);
			getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(obj, "inclusão", usuario);
			if (obj.getSituacao().equals("RE") && obj.getValorRecebido() != null && obj.getValorRecebido() < 0) {
				throw new Exception("Falha ao registrar a conta a receber  (Valor Recebido menor que zero). ");
			}
			if (obj.getSituacaoEQuitada() && obj.getTipoOrigem().equals("OUT")) {
				getFacadeFactory().getContaReceberFacade().baixarContaReceberConcedendoDescontoTotalAMesma(obj.getCodigo(), new Date(), "Desconto 100% na parcela.", false, false, usuario, configuracaoFinanceiro, usuario);
			}
			if (!obj.getSituacao().equals("RE")) {
				obj.setValorRecebido(obj.getValorFinal());
			}
			gravarValorFinalContaReceberAtualizadoComAcrescimosEDescontos(obj, false, usuario, true);
			if (!obj.getSituacao().equals("RE")) {
				obj.setValorRecebido(0.0);
			}
			validarGeracaoCentroResultadoOrigemPadraoPorContaReceber(obj, usuario);
			persistirDetalhamentoValorContaReceber(obj, configuracaoFinanceiro, usuario);

		} catch (Exception e) {
			obj.setSituacao(situacao);
			obj.setNovoObj(Boolean.TRUE);
			if (e.getMessage().contains("unique_contareceber_codorigem_tipoorigem_parcela_pessoa_matricu") && obj.getTipoOrigem().equals("OUT")) {
				throw new Exception("O número da parcela já está sendo para outra conta a receber desta pessoa, favor informe outro número.");
			}
			throw e;
		}
	}

	public void verificarBancoSicoobESetaAtributoNecessarioParaGeracaoBoleto(ContaReceberVO obj, ContaCorrenteVO contaCorrenteVO) throws Exception {
		if (obj.getTipoOrigem().equals("MAT") || obj.getTipoOrigem().equals("MEN")) {
			if (!obj.getCodOrigem().equals("")) {
				Integer codigoAlternativo = getFacadeFactory().getMatriculaPeriodoFacade().consultaRapidaPorCodigoMatPer_CodigoAlternativoGeracaoBoletoSicoob(new Integer(obj.getCodOrigem()));
				if (Uteis.isAtributoPreenchido(codigoAlternativo)) {
					obj.setSequencialcodmatperalternativoboleto(codigoAlternativo);
				} else {
					obj.setSequencialcodmatperalternativoboleto(new Integer(obj.getCodOrigem()));
				}
			}
		} else if (obj.getMatriculaPeriodo() > 0) {
			Integer codigoAlternativo = getFacadeFactory().getMatriculaPeriodoFacade().consultaRapidaPorCodigoMatPer_CodigoAlternativoGeracaoBoletoSicoob(obj.getMatriculaPeriodo());
			if (Uteis.isAtributoPreenchido(codigoAlternativo)) {
				obj.setSequencialcodmatperalternativoboleto(codigoAlternativo);
			} else {
				if (Uteis.isAtributoPreenchido(obj.getCodOrigem())) {
					obj.setSequencialcodmatperalternativoboleto(new Integer(obj.getCodOrigem()));
				}
			}
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void registrarLinhaDigitavelCodigoBarrasBoletoNossoNumeroContaReceber(final Integer codigo, final String nossoNumero, final String numeroDocumento, final String codigoBarra, final String linhaDigitavel, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE ContaReceber set linhaDigitavelCodigoBarras=?, codigobarra=?, nrDocumento=?, nossonumero=? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
					PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
					int i = 0;
					sqlAlterar.setString(++i, linhaDigitavel);
					sqlAlterar.setString(++i, codigoBarra);
					sqlAlterar.setString(++i, numeroDocumento);
					sqlAlterar.setString(++i, nossoNumero);
					sqlAlterar.setInt(++i, codigo);
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	//
	// @Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED,
	// rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	// public void registrarNossoNumeroBancoContaReceber(final ContaReceberVO
	// obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario)
	// throws Exception {
	// try {
	// final String sql =
	// "UPDATE ContaReceber set nossonumerobanco=? WHERE (codigo = ?)";
	// getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
	// public PreparedStatement createPreparedStatement(Connection cnctn) throws
	// SQLException {
	// PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
	// int i = 0;
	// sqlAlterar.setString(++i, obj.getNossoNumeroBanco());
	// sqlAlterar.setInt(++i, obj.getCodigo().intValue());
	// return sqlAlterar;
	// }
	// });
	// } catch (Exception e) {
	// throw e;
	// }
	// }
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerarDadosBoleto(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, boolean validarPermissao, UsuarioVO usuario) throws Exception {
		this.gerarDadosBoleto(obj, configuracaoFinanceiro, validarPermissao, false, usuario);
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerarDadosBoleto(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, boolean validarPermissao, boolean forcarRegerarNossoNumero, UsuarioVO usuario) throws Exception {
		String numeroBanco = "";
		try {
			ControleAcesso.alterar(getIdEntidade(), validarPermissao, usuario);
			if (!obj.getSituacao().equals(SituacaoContaReceber.RECEBIDO.getValor())) {
				ContaCorrenteVO contaCorrenteVO = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(obj.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
				numeroBanco = contaCorrenteVO.getAgencia().getBanco().getNrBanco();
				if (!Uteis.isAtributoPreenchido((obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getCodigo()))) {
					if((numeroBanco.equals("237") && obj.getNossoNumero().length() != 11) ) {
						forcarRegerarNossoNumero = true;
					}
					if (obj.getNossoNumero().equals("") || forcarRegerarNossoNumero) {
						executarGeracaoNossoNumeroContaReceber(obj, numeroBanco, forcarRegerarNossoNumero, usuario);
					}
					obj.setConfiguracaoFinanceiro(configuracaoFinanceiro);
					gerarNumeroDoc(obj, numeroBanco, usuario);
					if (configuracaoFinanceiro.getGerarBoletoComDescontoSemValidade()) {
						obj.setGerarBoletoComDescontoSemValidade(Boolean.TRUE);
						executarCalculoValorBoletoDescontoSemValidade(obj, configuracaoFinanceiro, usuario);
					}
				}
				obj.criarBoleto(contaCorrenteVO);
				alterar(obj, false, configuracaoFinanceiro, usuario);
			}
		} catch (Exception e) {
			throw e;
		} finally {
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void processarRegerarNossoNumeroContaReceber(String listaNossoNumero, UsuarioVO usuario) throws Exception {
		HashMap<Integer, ContaCorrenteVO> hashContaCorrente = new HashMap<Integer, ContaCorrenteVO>();
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" where contareceber.situacao = 'AR'");		
		sql.append(" and nossonumero in ").append(listaNossoNumero);
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		List<ContaReceberVO> lista = montarDadosConsultaBasica(resultado);
		Iterator i = lista.iterator();
		while (i.hasNext()) {
			ContaReceberVO contareceber = (ContaReceberVO)i.next();
			ContaCorrenteVO contaCorrenteVO = null;
			if (!hashContaCorrente.containsKey(contareceber.getContaCorrente())) {
				contaCorrenteVO = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(contareceber.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
				hashContaCorrente.put(contaCorrenteVO.getCodigo(), contaCorrenteVO);
			} else {
				contaCorrenteVO = hashContaCorrente.get(contareceber.getContaCorrente());
			}
			processarRegerarNossoNumeroContaReceber(contareceber, contaCorrenteVO, usuario);
		}
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void processarRegerarNossoNumeroContaReceber(ContaReceberVO obj, ContaCorrenteVO contaCorrenteVO, UsuarioVO usuario) throws Exception {
		String numeroBanco = "";
		if (obj.getSituacao().equals(SituacaoContaReceber.A_RECEBER.getValor())) {				
			numeroBanco = contaCorrenteVO.getAgencia().getBanco().getNrBanco();
			if (!Uteis.isAtributoPreenchido((obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getCodigo()))) {
				executarGeracaoNossoNumeroContaReceber(obj, numeroBanco, true, usuario);
			}
			obj.criarBoleto(contaCorrenteVO);
			alterarNossoNumeroLinhaDigitavel(obj.getCodigo(), obj.getNossoNumero(), obj.getLinhaDigitavelCodigoBarras(), obj.getCodigoBarra(), usuario);
		}
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerarLinhaDigitavelSemGerarNossoNumero(ContaReceberVO conta, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		List listaContaReceber = this.consultaRapidaContaReceberSemCodigoBarra();
		Iterator i = listaContaReceber.iterator();
		while (i.hasNext()) {
			ContaReceberVO obj = (ContaReceberVO) i.next();
			carregarDados(obj, configuracaoFinanceiro, usuario);
			try {
				if (!obj.getSituacao().equals(SituacaoContaReceber.RECEBIDO.getValor())) {
					ContaCorrenteVO contaCorrenteVO = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(obj.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
					if (configuracaoFinanceiro.getGerarBoletoComDescontoSemValidade()) {
						obj.setGerarBoletoComDescontoSemValidade(Boolean.TRUE);
						getFacadeFactory().getContaReceberFacade().executarCalculoValorBoletoDescontoSemValidade(obj, configuracaoFinanceiro, usuario);
					}
					obj.criarBoleto(contaCorrenteVO);
					alterar(obj, false, configuracaoFinanceiro, usuario);
				}
			} finally {
			}
		}

	}

	public void executarCalculoValorBoletoDescontoSemValidade(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		Integer diasVariacaoDataVencimento = 0; //getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarDiasVariacaoDataVencimentoPeloCodigoContaReceber(obj.getCodigo(), usuario);
		boolean eMatricula = false;
		if (obj.getTipoOrigem().equals("MAT")) {
			eMatricula = true;
		}
		if (obj.getPlanoDescontoContaReceberVOs().isEmpty()) {
			obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
		}
		if (obj.getListaDescontosAplicavesContaReceber().isEmpty()) {
			montarListaDescontosAplicaveisContaReceber(obj, Uteis.obterDataAntiga(obj.getDataVencimento(), 100), obj.getUsaDescontoCompostoPlanoDesconto(), configuracaoFinanceiroVO, usuario, diasVariacaoDataVencimento);
		}
		if (obj.getListaDescontosAplicavesContaReceber().isEmpty()) {
			for (PlanoFinanceiroAlunoDescricaoDescontosVO planoFinanceiroAlunoDescricaoDescontosVO : obj.getListaDescontosAplicavesContaReceber()) {
				if (planoFinanceiroAlunoDescricaoDescontosVO.getReferentePlanoFinanceiroAposVcto() ||
						(planoFinanceiroAlunoDescricaoDescontosVO.getDiaNrAntesVencimento() <= 0 && !planoFinanceiroAlunoDescricaoDescontosVO.getReferentePlanoFinanceiroAteVencimento())) {
					planoFinanceiroAlunoDescricaoDescontosVO.setValorDescontoProgressivo(0.0);
					if (obj.getDescontoAlunoValidoAteVencimento()) {
						planoFinanceiroAlunoDescricaoDescontosVO.setValorDescontoAluno(0.0);
					}
					obj.setValorCodigoBarraDescSemValidade(planoFinanceiroAlunoDescricaoDescontosVO.getValorParaPagamentoDentroDataLimiteDesconto(eMatricula).doubleValue());
					break;
				}
			}
		} else {
			obj.setValorCodigoBarraDescSemValidade(obj.getValor());
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void regerarDadosBoletoMudancaCarteira(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		String numeroBanco = "";
		try {
			if (obj.getSituacao().equals(SituacaoContaReceber.A_RECEBER.getValor())) {
				if(obj.getContaCorrenteVO().getNivelMontarDados() == null || !obj.getContaCorrenteVO().getNivelMontarDados().equals(NivelMontarDados.TODOS)) {
				ContaCorrenteVO contaCorrenteVO = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(obj.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
				obj.setContaCorrenteVO(contaCorrenteVO);
				}
				//System.out.println("NOSSONUMERO -> " + obj.getNossoNumero());
				numeroBanco = obj.getContaCorrenteVO().getAgencia().getBanco().getNrBanco();
				verificarBancoSicoobESetaAtributoNecessarioParaGeracaoBoleto(obj, obj.getContaCorrenteVO());
				executarGeracaoNossoNumeroContaReceber(obj, numeroBanco, false, usuario);
				obj.setConfiguracaoFinanceiro(configuracaoFinanceiro);
				gerarNumeroDoc(obj, numeroBanco, usuario);
				if (configuracaoFinanceiro.getGerarBoletoComDescontoSemValidade()) {
					obj.setGerarBoletoComDescontoSemValidade(Boolean.TRUE);
					executarCalculoValorBoletoDescontoSemValidade(obj, configuracaoFinanceiro, usuario);
				}
				obj.criarBoleto(obj.getContaCorrenteVO());
				alterarCarteira(obj, usuario);
				incluirNossoNumeroContaReceber(obj, obj.getNrBanco(), false, usuario);
				
			}
		} finally {
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#alterar(negocio .comuns.financeiro.ContaReceberVO)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#alterar(negocio .comuns.financeiro.ContaReceberVO)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterar(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, boolean validarAcesso, UsuarioVO usuario) throws Exception {
		try {
			ContaReceber.alterar(getIdEntidade(), validarAcesso, usuario);
			alterar(obj, false, true, configuracaoFinanceiro, usuario);
		} catch (Exception e) {
			throw e;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# gravarContaReceberNegociacao(java.util.List, java.util.List)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# gravarContaReceberNegociacao(java.util.List, java.util.List)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gravarContaReceberNegociacao(List listaContaReceberVencidas, List novasContaReceber, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		try {
			Iterator i = listaContaReceberVencidas.iterator();
			while (i.hasNext()) {
				ContaReceberVO obj = (ContaReceberVO) i.next();
				alterarSituacao(obj.getCodigo(), "NE", usuario);
			}
			Iterator j = novasContaReceber.iterator();
			while (j.hasNext()) {
				ContaReceberVO obj = (ContaReceberVO) j.next();
				obj.setTipoBoleto("MA");
				incluir(obj, configuracaoFinanceiro, usuario);
			}
			i = null;
			j = null;
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Throwable.class, propagation = Propagation.REQUIRED)
	public void alterar(ContaReceberVO obj, boolean modificarSituacaoContaReceber, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		alterar(obj, modificarSituacaoContaReceber, false, configuracaoFinanceiro, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Throwable.class, propagation = Propagation.REQUIRED)
	public void alterar(final ContaReceberVO obj, boolean modificarSituacaoContaReceber, boolean validarControleFinanceiroManual, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		String situacao = obj.getSituacao();
		try {
			validarContaReceberEmMemoriaAntesAlteracao(obj);
			if(!situacao.equals("CA") && !situacao.equals("NE")) {
				verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "ALTERAR", obj.getDataVencimento(), obj.getDataVencimentoAntesAlteracao(), obj.getDataCompetencia(), obj.getDataCompetenciaAntesAlteracao(), obj.getUnidadeEnsino().getCodigo(), null, TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);	
			}
			if (!Uteis.isAtributoPreenchido(configuracaoFinanceiro)) {
				configuracaoFinanceiro = getConfiguracaoFinanceiroPrevilegiandoUnidadeEnsino(obj.getUnidadeEnsino().getCodigo(), usuario);
			}
			configuracaoFinanceiro.setUsaDescontoCompostoPlanoDesconto(obj.getUsaDescontoCompostoPlanoDesconto());
			
//			if (!obj.getSituacaoEQuitada()) {
//				realizarAtualizacaoIndiceReajustePrecoContaReceber(obj, obj.getMatriculaPeriodo(), usuario);
//				obj.atualizarSituacaoContaReceberDeAcordoComDescontos(configuracaoFinanceiro, null, usuario);
//				getFacadeFactory().getContaReceberFacade().realizarAtualizacaoValorDescontoFaixaContaReceber(obj, configuracaoFinanceiro, false);
//			}

			ContaReceberVO.validarDados(obj);
			executarCriacaoVinculoContaReceberComTurma(obj, usuario);
			if (obj.getSituacao().equals("AR")) {
				obj.setMulta(0.0);
				obj.setJuro(0.0);
			}

			if (obj.getLinhaDigitavelCodigoBarras() == null && obj.getCodigoBarra().equals("")) {
				ContaCorrenteVO contaCorrenteVO = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(obj.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
				if (configuracaoFinanceiro.getGerarBoletoComDescontoSemValidade()) {
					obj.setGerarBoletoComDescontoSemValidade(Boolean.TRUE);
					getFacadeFactory().getContaReceberFacade().executarCalculoValorBoletoDescontoSemValidade(obj, configuracaoFinanceiro, usuario);
				}
				obj.criarBoleto(contaCorrenteVO);
			}

			/**
			 * Adicionada regra para alterar o valorBaseContaReceber de forma que ele seja o mesmo que o valor da contarReceber quando o financeiroManual se encontre ativo.
			 */
			if (obj.getSituacao().equals("AR")) {
				if ((obj.getTipoOrigem().equals(TipoOrigemContaReceber.MATRICULA.getValor()) || obj.getTipoOrigem().equals(TipoOrigemContaReceber.MENSALIDADE.getValor()) || obj.getTipoOrigem().equals(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor())) && Uteis.isAtributoPreenchido(obj.getMatriculaPeriodo())) {
					MatriculaPeriodoVO matriculaPeriodoVO = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(obj.getMatriculaPeriodo(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuario);
					if (Uteis.isAtributoPreenchido(matriculaPeriodoVO)) {
						if (matriculaPeriodoVO.getFinanceiroManual()) {
							obj.setValorBaseContaReceber(obj.getValor()+obj.getValorCusteadoContaReceber());
						}
					}
				} else {
					obj.setValorBaseContaReceber(obj.getValor()+obj.getValorCusteadoContaReceber());
				}
			}

			// Obtém o bloqueio da Conta a Receber.
			final Date updated;
			// getBloqueio().lock();
			updated = new Date();
			// Matricula observador = (Matricula) ((Advised)
			// getFacadeFactory().getMatriculaFacade()).getTargetSource().getTarget();
			// // Obtém o bloqueio para a Matrícula.
			// observador.getBloqueio().lock();
			try {

				// Notifica observadores da conta a receber.
				// obj.addObserver(this);
				// obj.notifyObservers();
				// Notifica observadores de matrícula.
				// obj.getMatriculaAluno().addObserver(observador);
				// Este código precisa ser melhorado, é uma gambiarra por
				// enquanto...
				// if (!obj.getMatriculaAluno().isNovoObj()) {
				// obj.setChanged();
				// }
				// if (!obj.getControlarConcorrencia()) {
				// obj.getMatriculaAluno().notifyObservers();
				// }

				final StringBuilder sql = new StringBuilder("UPDATE ContaReceber set data=?, codOrigem=?, tipoOrigem=?, situacao=?, descricaoPagamento=?, dataVencimento=?, valor=?, "); // 1
				// -
				// 7
				sql.append("valorDesconto=?, juro=?, juroPorcentagem=?, multa=?, multaPorcentagem=?, nrDocumento=?, parcela=?, "); // 8
				// -
				// 14
				sql.append("centroReceita=?, matriculaAluno=?, funcionario=?, origemNegociacaoReceber=?, candidato=?, "); // 15
				// -
				// 19
				sql.append("tipoPessoa=?, pessoa=?, contaCorrente=?, descontoProgressivo = ?, valorRecebido=?, tipoDesconto = ?, "); // 20
				// -
				// 25
				sql.append("unidadeEnsino=?, valorDescontoRecebido=?, descontoInstituicao=?, descontoConvenio=?, convenio=?, tipoBoleto=?, "); // 26
				// -
				// 31
				sql.append("linhaDigitavelCodigoBarras=?, codigobarra=?, beneficiario=?, nossonumero=?, parceiro=?, matriculaPeriodo=?, valorDescontoProgressivo=?, "); // 32
				// -
				// 38
				sql.append("recebimentoBancario=?, ordemConvenio=?, ordemConvenioValorCheio=?, ordemDescontoAluno=?, ordemDescontoAlunoValorCheio=?, "); // 39
				// -
				// 43
				sql.append("ordemDescontoProgressivo=?, ordemDescontoProgressivoValorCheio=?, ordemPlanoDesconto=?, ordemPlanoDescontoValorCheio=?, justificativaDesconto=?, "); // 44
				// -
				// 48
				sql.append("valorDescontoLancadoRecebimento=?, valorCalculadoDescontoLancadoRecebimento=?, tipoDescontoLancadoRecebimento=?, valorDescontoAlunoJaCalculado=?, "); // 49
				// -
				// 52
				sql.append(" impressaoBoletoRealizada=?, descontoProgressivoUtilizado=?, dataArquivoRemessa=?, updated=?, acrescimo=?, usaDescontoCompostoPlanoDesconto=?, codigoRenegociacao=?, responsavelFinanceiro=?, turma = ?, fornecedor = ?, valorCusteadoContaReceber=?, valorBaseContaReceber=?, valorReceberCalculado=?, dataCompetencia=?, usuarioDesbloqueouDescontoRecebimento=?, dataUsuarioDesbloqueouDescontoRecebimento=?, possuiPendenciasFinanceirasExternas=?, processamentointegracaofinanceiradetalhe = ?, valorDescontoRateio = ?,  "); // 54

				sql.append("unidadeEnsinoFinanceira=?, valorIndiceReajuste=?, contaEditadaManualmente=?, utilizarDescontoProgressivoManual=?, diaLimite1=?, diaLimite2=?, diaLimite3=?, diaLimite4=?, possuiFiesIntegracaoFinanceiras=?,   ");
				// 59
				sql.append("dataLimitePrimeiraFaixaDescontos=?, dataLimiteSegundaFaixaDescontos=?, dataLimiteTerceiraFaixaDescontos=?, dataLimiteQuartaFaixaDescontos=? ");
				// 63
				if (!obj.getSituacaoEQuitada()) {
					sql.append(", valordescontocalculadoprimeirafaixadescontos =?, valordescontocalculadosegundafaixadescontos=?, valordescontocalculadoterceirafaixadescontos=?, valordescontocalculadoquartafaixadescontos=?  ");
				}
				sql.append(" WHERE ((codigo = ?))").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
				getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

					public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
						PreparedStatement sqlAlterar = cnctn.prepareStatement(sql.toString());
						int i = 0;
						sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getData()));
						sqlAlterar.setString(++i, obj.getCodOrigem());
						sqlAlterar.setString(++i, obj.getTipoOrigem());
						sqlAlterar.setString(++i, obj.getSituacao());
						sqlAlterar.setString(++i, obj.getDescricaoPagamento());
						sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataVencimento()));
						sqlAlterar.setDouble(++i, obj.getValor().doubleValue());
						sqlAlterar.setDouble(++i, obj.getValorDesconto().doubleValue());
						sqlAlterar.setDouble(++i, obj.getJuro().doubleValue());
						sqlAlterar.setDouble(++i, obj.getJuroPorcentagem().doubleValue());
						sqlAlterar.setDouble(++i, obj.getMulta().doubleValue());
						sqlAlterar.setDouble(++i, obj.getMultaPorcentagem().doubleValue());
						sqlAlterar.setString(++i, obj.getNrDocumento());
						sqlAlterar.setString(++i, obj.getParcela());
						if (obj.getCentroReceita().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getCentroReceita().getCodigo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (!obj.getMatriculaAluno().getMatricula().equals("")) {
							sqlAlterar.setString(++i, obj.getMatriculaAluno().getMatricula());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getFuncionario().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getFuncionario().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getOrigemNegociacaoReceber().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getOrigemNegociacaoReceber().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getCandidato().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getCandidato().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setString(++i, obj.getTipoPessoa());
						if (obj.getPessoa().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getPessoa().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getContaCorrente().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getContaCorrente());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getDescontoProgressivo().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getDescontoProgressivo().getCodigo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setDouble(++i, obj.getValorRecebido().doubleValue());
						sqlAlterar.setString(++i, obj.getTipoDesconto());
						if (obj.getUnidadeEnsino().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getUnidadeEnsino().getCodigo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setDouble(++i, obj.getValorDescontoRecebido().doubleValue());
						if (obj.getValorDescontoInstituicao().doubleValue() != 0.0) { // 28
							sqlAlterar.setDouble(++i, obj.getValorDescontoInstituicao().doubleValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getValorDescontoConvenio().doubleValue() != 0.0) { // 29
							sqlAlterar.setDouble(++i, obj.getValorDescontoConvenio().doubleValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getConvenio().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getConvenio().getCodigo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getTipoBoleto().equals("")) {
							obj.setTipoBoleto("OU");
							sqlAlterar.setString(++i, obj.getTipoBoleto());
						} else {
							sqlAlterar.setString(++i, obj.getTipoBoleto());
						}
						sqlAlterar.setString(++i, obj.getLinhaDigitavelCodigoBarras());
						sqlAlterar.setString(++i, obj.getCodigoBarra());
						if (obj.getTipoOrigem().equals("BCC")) {
							sqlAlterar.setInt(++i, obj.getBeneficiario().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (Uteis.isAtributoPreenchido(obj.getNossoNumero())) {
							sqlAlterar.setString(++i, obj.getNossoNumero());
						}else {
							sqlAlterar.setString(++i, consultarNossoNumeroCodigoContaReceber(obj.getCodigo()));
						}
						if (obj.getParceiroVO().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getParceiroVO().getCodigo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getMatriculaPeriodo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getMatriculaPeriodo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getValorDescontoProgressivo().doubleValue() != 0.0) {
							sqlAlterar.setDouble(++i, obj.getValorDescontoProgressivo().doubleValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getRecebimentoBancario() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setBoolean(++i, obj.getRecebimentoBancario());
						}
						sqlAlterar.setInt(++i, obj.getOrdemConvenio());
						sqlAlterar.setBoolean(++i, obj.getOrdemConvenioValorCheio());
						sqlAlterar.setInt(++i, obj.getOrdemDescontoAluno());
						sqlAlterar.setBoolean(++i, obj.getOrdemDescontoAlunoValorCheio());
						sqlAlterar.setInt(++i, obj.getOrdemDescontoProgressivo());
						sqlAlterar.setBoolean(++i, obj.getOrdemDescontoProgressivoValorCheio());
						sqlAlterar.setInt(++i, obj.getOrdemPlanoDesconto());
						sqlAlterar.setBoolean(++i, obj.getOrdemPlanoDescontoValorCheio());
						sqlAlterar.setString(++i, obj.getJustificativaDesconto());

						if (obj.getValorDescontoLancadoRecebimento().doubleValue() != 0.0) {
							sqlAlterar.setDouble(++i, obj.getValorDescontoLancadoRecebimento().doubleValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getValorCalculadoDescontoLancadoRecebimento().doubleValue() != 0.0) {
							sqlAlterar.setDouble(++i, obj.getValorCalculadoDescontoLancadoRecebimento().doubleValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setString(++i, obj.getTipoDescontoLancadoRecebimento());
						if (obj.getValorDescontoAlunoJaCalculado().doubleValue() != 0.0) {
							sqlAlterar.setDouble(++i, obj.getValorDescontoAlunoJaCalculado().doubleValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setBoolean(++i, obj.getImpressaoBoletoRealizada());

						if (obj.getDescontoProgressivoUtilizado() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setString(++i, obj.getDescontoProgressivoUtilizado().getDescricao());
						}
						if (obj.getDataArquivoRemessa() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataArquivoRemessa()));
						}
						sqlAlterar.setTimestamp(++i, Uteis.getDataJDBCTimestamp(updated));
						if (obj.getAcrescimo().doubleValue() != 0.0) {
							sqlAlterar.setDouble(++i, obj.getAcrescimo().doubleValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setBoolean(++i, obj.getUsaDescontoCompostoPlanoDesconto());
						if (obj.getRenegociacaoContaReceberOrigem().getCodigo() != 0) {
							sqlAlterar.setInt(++i, obj.getRenegociacaoContaReceberOrigem().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getResponsavelFinanceiro().getCodigo() != 0) {
							sqlAlterar.setInt(++i, obj.getResponsavelFinanceiro().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getTurma().getCodigo() != 0) {
							sqlAlterar.setInt(++i, obj.getTurma().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getTipoPessoa().equals("FO") && obj.getFornecedor().getCodigo() != 0) {
							sqlAlterar.setInt(++i, obj.getFornecedor().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setDouble(++i, obj.getValorCusteadoContaReceber().doubleValue());
						sqlAlterar.setDouble(++i, obj.getValorBaseContaReceber().doubleValue());
						sqlAlterar.setDouble(++i, obj.getValorReceberCalculado().doubleValue());
						sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataCompetencia()));
						if (obj.getUsuarioDesbloqueouDescontoRecebimento() != null) {
							sqlAlterar.setInt(++i, obj.getUsuarioDesbloqueouDescontoRecebimento().getCodigo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getDataUsuarioDesbloqueouDescontoRecebimento() != null) {
							sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataUsuarioDesbloqueouDescontoRecebimento()));
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setBoolean(++i, obj.getPossuiPendenciasFinanceirasExternas());
						if (Uteis.isAtributoPreenchido(obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getCodigo())) {
							sqlAlterar.setInt(++i, obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setDouble(++i, obj.getValorDescontoRateio());
						Uteis.setValuePreparedStatement(obj.getUnidadeEnsinoFinanceira(), ++i, sqlAlterar);
						sqlAlterar.setBigDecimal(++i, obj.getValorIndiceReajuste());

						sqlAlterar.setBoolean(++i, obj.getContaEditadaManualmente().booleanValue());
						sqlAlterar.setBoolean(++i, obj.getUtilizarDescontoProgressivoManual().booleanValue());
						if (obj.getDiaLimite1() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setInt(++i, obj.getDiaLimite1());
						}
						if (obj.getDiaLimite2() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setInt(++i, obj.getDiaLimite2());
						}
						if (obj.getDiaLimite3() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setInt(++i, obj.getDiaLimite3());
						}
						if (obj.getDiaLimite4() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setInt(++i, obj.getDiaLimite4());
						}
						sqlAlterar.setBoolean(++i, obj.getPossuiFiesIntegracaoFinanceiras());
						if (obj.getDataLimitePrimeiraFaixaDescontos() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataLimitePrimeiraFaixaDescontos()));
						}
						if (obj.getDataLimiteSegundaFaixaDescontos() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteSegundaFaixaDescontos()));
						}
						if (obj.getDataLimiteTerceiraFaixaDescontos() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteTerceiraFaixaDescontos()));
						}
						if (obj.getDataLimiteQuartaFaixaDescontos() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteQuartaFaixaDescontos()));
						}						
						if (!obj.getSituacaoEQuitada()) {
							sqlAlterar.setDouble(++i, obj.getValorDescontoCalculadoPrimeiraFaixaDescontos());
							sqlAlterar.setDouble(++i, obj.getValorDescontoCalculadoSegundaFaixaDescontos());
							sqlAlterar.setDouble(++i, obj.getValorDescontoCalculadoTerceiraFaixaDescontos());
							sqlAlterar.setDouble(++i, obj.getValorDescontoCalculadoQuartaFaixaDescontos());
						}
						sqlAlterar.setInt(++i, obj.getCodigo().intValue());
						return sqlAlterar;
					}
				});
				// Atualiza a matrícula.
				// if (obj.getMatriculaAluno().getMatricula() != null &&
				// !obj.getMatriculaAluno().getMatricula().trim().isEmpty() &&
				// !obj.getControlarConcorrencia()) {
				// realizarAtualizacaoDoCampoUpdated(MatriculaVO.class,
				// "(matricula = ?)", updated,
				// obj.getMatriculaAluno().getMatricula());
				// obj.getMatriculaAluno().setUpdated(updated);
				// obj.setControlarConcorrencia(Boolean.FALSE);
				// }
			} finally {
				// Libera o bloqueio da Matrícula.
				// observador.getBloqueio().unlock();
				// obj.getMatriculaAluno().deleteObserver(observador);
				// Libera o bloqueio da Conta a Receber.
				// getBloqueio().unlock();
				// obj.deleteObserver(this);
			}
			obj.getNotaFiscalSaidaServicoVO().setCodigo(consultarNumeroNotaFiscalSaidaServicoPorContaReceber(obj.getCodigo()));
			getFacadeFactory().getContaReceberRecebimentoFacade().alterarContaReceberRecebimentos(obj.getCodigo(), obj.getNotaFiscalSaidaServicoVO().getCodigo(), obj.getContaReceberRecebimentoVOs(), usuario);
			getFacadeFactory().getPlanoDescontoContaReceberFacade().alterarItensPlanoDescontoContaReceber(obj.getCodigo(), obj.getPlanoDescontoContaReceberVOs(), usuario);
			if (modificarSituacaoContaReceber) {

				// Modifica o campo descontoprogressivoutilizado de acordo com o
				// dia do recebimento e as faixas de desconto.
				obj.setDescontoProgressivoUtilizado(modificarValorDescontoProgressivoUtilizado(obj, usuario));

				// Modifica os planosDescontoContaReceber dessa conta, setando o
				// valorUtilizadoRecebimento para cada convênio/PlanoDesconto
				// Obs 04/09/2018 foi comentando a rotina que atualzar o valors dos planos de conta pois os mesmo ja sao atualizado pela rotina do medoto espirita
				// e sendo assim estava gerando erro pois ele nao valida se o desconto ainda esta valido para essa atualizacao gerando informacao errado para o plano desconto.Pedro Andrade
				/*if (obj.getValorDescontoInstituicao() != null || obj.getValorDescontoConvenio() != null) {
					alterarItensPlanoDescontoContaReceber(obj, usuario);
				}*/

				modificarSituacaoContaReceber(obj, configuracaoFinanceiro, usuario);

				if ((obj.getSituacaoEQuitada()) && (obj.getContaReceberReferenteMatricula() || verificarSituacaoQuitadaParcelaMatriculaPorCodigoContaReceber(obj.getCodigo()))) {
					// Caso o titulo que está sendo baixado, seja do tipo
					// matrícula, temos que avaliar
					// se não existe processamento a ser realizado. Isto, por
					// que, existem rotinas
					// que são executadas no sistema, uma vez que o aluno pague
					// sua matrícula
					processarConfirmacaoPagamentoMatricula(obj, configuracaoFinanceiro, usuario);
				}
			}
			if ((obj.getSituacaoEQuitada() || obj.getSituacao().equals("NE") || obj.getSituacao().equals("CF")) && obj.getMatriculaAluno() != null && obj.getMatriculaAluno().getMatricula() != null && !obj.getMatriculaAluno().getMatricula().isEmpty()) {
				getFacadeFactory().getMatriculaFacade().realizarVerificacaoELiberacaoSuspensaoMatricula(obj.getMatriculaAluno().getMatricula());
				realizarVerificacaoELiberacaoSuspensaoConvenioFinanciamentoProprio(obj, false, usuario);
			}
			if ((obj.getMatriculaPeriodo().intValue() != 0) && (!obj.getContaEditadaManualmente()) && (obj.getIsContaReceberReferenteMatricula() || obj.getIsContaReceberReferenteMensalidade())) {
				if (validarControleFinanceiroManual) {
					validarDadosMatriculaPeriodoFinanceiroManual(obj.getMatriculaPeriodo().intValue(), configuracaoFinanceiro, usuario);
				}
			}
			
//			Verificação comentada, pois estava impactando o indice de reajuste.
//			if (!obj.getContaEditadaManualmente()) {
//				alterarMatriculaPeriodoVencimentoDaContaReceber(obj, configuracaoFinanceiro, usuario);
//			}
			alterarMatriculaPeriodoVencimentoDaContaReceber(obj, configuracaoFinanceiro, usuario);
			getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(obj,"alteração", usuario);
			if (obj.getSituacao().equals("RE") && obj.getValorRecebido() != null && obj.getValorRecebido() < 0) {
				throw new Exception("Falha ao registrar a conta a receber  (Valor Recebido menor que zero). ");
			}
			if (situacao.equals("AR") && obj.getSituacaoEQuitada() && obj.getTipoOrigem().equals("OUT")) {
				getFacadeFactory().getContaReceberFacade().baixarContaReceberConcedendoDescontoTotalAMesma(obj.getCodigo(), new Date(), "Desconto 100% na parcela.", false, false, usuario, configuracaoFinanceiro, usuario);
			}
			if (obj.getSituacao().equals("RE") || obj.getSituacao().equals("NE") || obj.getContaEditadaManualmente() || obj.getPrecisaCalcularDesconto()) {
				gravarValorFinalContaReceberAtualizadoComAcrescimosEDescontos(obj, usuario, false, true);
			}
			validarGeracaoCentroResultadoOrigemPadraoPorContaReceber(obj, usuario);
			persistirDetalhamentoValorContaReceber(obj, configuracaoFinanceiro, usuario);
			if(obj.getSituacao().equals("AR")) {
				obj.setJuro(obj.getValorJuroCalculado());
				obj.setMulta(obj.getValorMultaCalculado());
			}
			// obj.setUpdated(updated);
		} catch (Exception e) {
			obj.setSituacao(situacao);
			throw e;
		}
	}

	private void validarGeracaoCentroResultadoOrigemPadraoPorContaReceber(final ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		if (!obj.getTipoOrigemContaReceber().isDevolucaoCheque()) {
			getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().geracaoCentroResultadoOrigemPadraoPorContaReceber(obj, false, usuario);
			for (CentroResultadoOrigemVO cro : obj.getListaCentroResultadoOrigem()) {
				if (obj.getSituacaoEQuitada()) {
					cro.calcularValor(obj.getValorRecebido());
				} else {
					cro.calcularValor(obj.getValorReceberCalculado());
				}
			}
			getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().persistir(obj.getListaCentroResultadoOrigem(), obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, false, usuario, false);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Throwable.class, propagation = Propagation.REQUIRED)
	public void alterarCarteira(final ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		try {
			verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "ALTERAR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);
			final Date updated;
			updated = new Date();
			try {
				final String sql = "UPDATE ContaReceber set codOrigem=?, tipoOrigem=?, situacao=?, dataVencimento=?, valor=?, " // 1
						// -
						// 5
						+ "juro=?, juroPorcentagem=?, multa=?, multaPorcentagem=?, nrDocumento=?, parcela=?, contaCorrente=?, tipoDesconto = ?, " // 6
						// -
						// 13
						+ "unidadeEnsino=?, linhaDigitavelCodigoBarras=?, codigobarra=?, nossonumero=?, updated=?, acrescimo=?, dataCompetencia=? " // 21
						// -
						// 21
						+ " WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
				getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

					public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
						PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
						int i = 0;
						sqlAlterar.setString(++i, obj.getCodOrigem());
						sqlAlterar.setString(++i, obj.getTipoOrigem());
						sqlAlterar.setString(++i, obj.getSituacao());
						sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataVencimento()));
						sqlAlterar.setDouble(++i, obj.getValor().doubleValue());
						sqlAlterar.setDouble(++i, obj.getJuro().doubleValue());
						sqlAlterar.setDouble(++i, obj.getJuroPorcentagem().doubleValue());
						sqlAlterar.setDouble(++i, obj.getMulta().doubleValue());
						sqlAlterar.setDouble(++i, obj.getMultaPorcentagem().doubleValue());
						sqlAlterar.setString(++i, obj.getNrDocumento());
						sqlAlterar.setString(++i, obj.getParcela());
						if (obj.getContaCorrente().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getContaCorrente());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setString(++i, obj.getTipoDesconto());
						if (obj.getUnidadeEnsino().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getUnidadeEnsino().getCodigo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setString(++i, obj.getLinhaDigitavelCodigoBarras());
						sqlAlterar.setString(++i, obj.getCodigoBarra());
						sqlAlterar.setString(++i, obj.getNossoNumero());
						sqlAlterar.setTimestamp(++i, Uteis.getDataJDBCTimestamp(updated));
						if (obj.getAcrescimo().doubleValue() != 0.0) {
							sqlAlterar.setDouble(++i, obj.getAcrescimo().doubleValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataCompetencia()));
						sqlAlterar.setInt(++i, obj.getCodigo().intValue());
						return sqlAlterar;
					}
				});
			} finally {
			}
		} catch (Exception e) {
			throw e;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# processarConfirmacaoPagamentoMatricula(negocio.comuns .financeiro.ContaReceberVO)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void processarConfirmacaoPagamentoMatricula(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		if (!obj.getMatriculaAluno().getMatricula().equals("")) {
			getFacadeFactory().getMatriculaFacade().alterarSituacaoFinanceiraMatricula(obj.getMatriculaAluno().getMatricula(), "QU");
		}
		if (Uteis.isAtributoPreenchido(obj.getMatriculaPeriodo())) {
			getFacadeFactory().getMatriculaPeriodoFacade().alterarSituacaoFinanceiraMatriculaPeriodo(obj.getMatriculaPeriodo(), "AT");
		}
		if (obj.getMatriculaPeriodo() > 0 && !obj.getRealizandoRecebimentoAutomaticoMatricula()) {
			getFacadeFactory().getMatriculaPeriodoFacade().processarGeracaoContasReceberAposConfirmacaoPagamentoMatricula(obj.getMatriculaAluno(), obj.getMatriculaPeriodo(), SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA, configuracaoFinanceiro, obj.getBloqueioPorFechamentoMesLiberado(), usuario);
		}
		// processarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVO,
		// matriculaPeriodoVO, processoMatriculaCalendarioVO, "");
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# modificarSituacaoContaReceber(negocio.comuns.financeiro .ContaReceberVO)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# modificarSituacaoContaReceber(negocio.comuns.financeiro .ContaReceberVO)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Throwable.class, propagation = Propagation.REQUIRED)
	public void modificarSituacaoContaReceber(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		if (obj.getSituacao().equals("RE")) {
			alterarSituacaoOrigemContaReceber(obj, usuario);
			incluirRecebimentoEmReceitaDW(obj, configuracaoFinanceiro, usuario);
		}
		if (obj.getSituacao().equals("AR")) {
			estornarSituacaoOrigemContaReceber(obj, usuario);
			estornarRecebimentoEmReceitaDW(obj, configuracaoFinanceiro, usuario);
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarSituacaoOrigemContaReceber(negocio.comuns. financeiro.ContaReceberVO)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarSituacaoOrigemContaReceber(negocio.comuns. financeiro.ContaReceberVO)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoOrigemContaReceber(ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		if (obj.getTipoOrigem().equals("IPS")) {
			if (!obj.getCodOrigem().equals("")) {
				alterarStatusInscricaoProcessoSeletivo(Integer.parseInt(obj.getCodOrigem()), "CO", obj.getUnidadeEnsinoFinanceira().getCodigo(), usuario);
			}
		} else if (obj.getTipoOrigem().equals("MAT")) {
			if (!obj.getCodOrigem().equals("")) {
				alterarSituacaoMatricula(Integer.parseInt(obj.getCodOrigem()), "CO", usuario);
			}
		} else if (obj.getTipoOrigem().equals("REQ")) {
			if (!obj.getCodOrigem().equals("")) {
				alterarSituacaoRequerimento(Integer.parseInt(obj.getCodOrigem()), obj.getRealizandoRecebimento(), "PG", "PE", obj.getRealizandoBaixaAutomatica(), usuario);
			}
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# estornarSituacaoOrigemContaReceber(negocio.comuns. financeiro.ContaReceberVO)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# estornarSituacaoOrigemContaReceber(negocio.comuns. financeiro.ContaReceberVO)
	 */
	public void estornarSituacaoOrigemContaReceber(ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		if (obj.getTipoOrigem().equals("IPS")) {
			if (!obj.getCodOrigem().equals("")) {
				alterarStatusInscricaoProcessoSeletivo(Integer.parseInt(obj.getCodOrigem()), "PF", obj.getUnidadeEnsinoFinanceira().getCodigo(), usuario);
			}
		} else if (obj.getTipoOrigem().equals("MAT")) {
			if (!obj.getCodOrigem().equals("")) {
				alterarSituacaoMatricula(Integer.parseInt(obj.getCodOrigem()), "PF", usuario);
			}
		} else if (obj.getTipoOrigem().equals("REQ")) {
			if (!obj.getCodOrigem().equals("")) {
				alterarSituacaoRequerimento(Integer.parseInt(obj.getCodOrigem()), obj.getRealizandoRecebimento(), "PE", "AP", false, usuario);
			}
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarStatusInscricaoProcessoSeletivo(java.lang.Integer , java.lang.String)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarStatusInscricaoProcessoSeletivo(java.lang.Integer , java.lang.String)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarStatusInscricaoProcessoSeletivo(Integer codigo, String situacao, Integer unidadeEnsino, UsuarioVO usuario) throws Exception {
		getFacadeFactory().getInscricaoFacade().alterarSituacaoFinanceira(codigo, situacao, unidadeEnsino, usuario);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarSituacaoMatricula(java.lang.Integer, java.lang.String)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarSituacaoMatricula(java.lang.Integer, java.lang.String)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoMatricula(Integer matricula, String situacao, UsuarioVO usuario) throws Exception {
		getFacadeFactory().getMatriculaPeriodoFacade().alterarSituacaoFinanceiraMatriculaPeriodo(matricula, situacao);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarSituacaoRequerimento(java.lang.Integer, java.lang.String, java.lang.String)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarSituacaoRequerimento(java.lang.Integer, java.lang.String, java.lang.String)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoRequerimento(Integer codigo, Boolean realizandoRecebimento, String sitFinan, String sitExecucao, boolean realizandoBaixaAutomatica, UsuarioVO usuario) throws Exception {
		getFacadeFactory().getRequerimentoFacade().alterarSituacaoFinanceiraESituacaoExecucao(codigo, realizandoRecebimento, sitExecucao, sitFinan, realizandoBaixaAutomatica, usuario);
	}

	public StringBuilder getSqlConsultaRapidaContaReceberLog() {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT Contareceber.* from Contareceber ");
		return sql;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# incluirRecebimentoEmReceitaDW(negocio.comuns.financeiro .ContaReceberVO)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# incluirRecebimentoEmReceitaDW(negocio.comuns.financeiro .ContaReceberVO)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Throwable.class, propagation = Propagation.REQUIRED)
	public void incluirRecebimentoEmReceitaDW(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		MatriculaVO matricula = null;
		MatriculaPeriodoVO matriculaPeriodo = null;
		InscricaoVO inscricao = null;
		try {
			if (obj.getTipoOrigem().equals("MAT") || obj.getTipoOrigem().equals("MEN")) {
				// matricula =
				// getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(obj.getMatriculaAluno().getMatricula(),
				// 0, Uteis.NIVELMONTARDADOS_DADOSBASICOS,
				// configuracaoFinanceiro, usuario);
				// Matricula.montarDadosCurso(matricula,
				// Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				matricula = getFacadeFactory().getMatriculaFacade().consultarPorMatriculaReceitaDW(obj.getMatriculaAluno().getMatricula(), 0, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiro, usuario);
				if (obj.getMatriculaPeriodo() != null && obj.getMatriculaPeriodo() > 0) {
					matriculaPeriodo = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(obj.getMatriculaPeriodo(), Uteis.NIVELMONTARDADOS_COMBOBOX, configuracaoFinanceiro, usuario);
				}
			}
			if (obj.getTipoOrigem().equals("IPS")) {
				inscricao = getFacadeFactory().getInscricaoFacade().consultarPorChavePrimaria(Integer.parseInt(obj.getCodOrigem()), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			}
			getFacadeFactory().getReceitaDWFacade().incluir(obj.getReceitaDWVO(matricula, matriculaPeriodo, inscricao));
		} catch (Exception e) {
			matricula = null;
			matriculaPeriodo = null;
			inscricao = null;
			throw e;
		} finally {
			matricula = null;
			matriculaPeriodo = null;
			inscricao = null;
		}
	}

	public void estornarRecebimentoEmReceitaDW(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		MatriculaVO matricula = new MatriculaVO();
		MatriculaPeriodoVO matriculaPeriodo = new MatriculaPeriodoVO();
		InscricaoVO inscricao = new InscricaoVO();
		if (obj.getTipoOrigem().equals("MAT") || obj.getTipoOrigem().equals("MEN")) {
			matricula = getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(obj.getMatriculaAluno().getMatricula(), 0, NivelMontarDados.TODOS, usuario);
			Matricula.montarDadosCurso(matricula, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			if (!obj.getCodOrigem().equals("")) {
				if (obj.getMatriculaPeriodo() != null && obj.getMatriculaPeriodo() > 0) {
					matriculaPeriodo = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(obj.getMatriculaPeriodo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiro, usuario);
				} else {
					matriculaPeriodo = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(Integer.parseInt(obj.getCodOrigem()), Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiro, usuario);
				}
			}
		}
		if (obj.getTipoOrigem().equals("IPS")) {
			inscricao = getFacadeFactory().getInscricaoFacade().consultarPorChavePrimaria(Integer.parseInt(obj.getCodOrigem()), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		}
		getFacadeFactory().getReceitaDWFacade().incluir(obj.getReceitaDWEstornoVO(matricula, matriculaPeriodo, inscricao));
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacao(final Integer codigo, final String situacao, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set situacao=? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setString(1, situacao);
				sqlAlterar.setInt(2, codigo);
				return sqlAlterar;
			}
		});
		if (situacao.equals(SituacaoContaReceber.CANCELADO_FINANCEIRO.getValor())) {
			getFacadeFactory().getItemEmprestimoFacade().executarIsencaoEOuRemoverVinculoDaContaReceberParaItemEmprestimo(codigo, true, false, usuario);
		} else {
			getFacadeFactory().getItemEmprestimoFacade().executarIsencaoEOuRemoverVinculoDaContaReceberParaItemEmprestimo(codigo, false, false, usuario);
		}
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.SUPPORTS)
	public String adicionarValidacaoParaContaReceberConvenioSeExisteContaAlunoRecebida()  {
		StringBuilder sb = new StringBuilder("");
		sb.append(" and not exists  ( select cr.codigo from contareceber cr ");
		sb.append(" where cr.codorigem  = contareceber.codorigem  ");
		sb.append(" and ((contareceber.parcela not ilike('%/%') and cr.parcela  = contareceber.parcela) or (contareceber.parcela ilike('%/%') and (substring(cr.parcela, 0, position('/' in cr.parcela)) =  substring(contareceber.parcela, 0, position('/' in contareceber.parcela))))) ");
		sb.append(" and cr.situacao in ('RE', 'NE', 'CF') ");
		sb.append(" and cr.tipoorigem in ('MAT', 'MEN') ");
		sb.append(" and cr.tipopessoa != 'PA' ");
		sb.append(" ) ");
		return sb.toString();
		
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluir(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, Boolean verificarPermissao, UsuarioVO usuario) throws Exception {
		MatriculaPeriodoVencimentoVO mpv = new MatriculaPeriodoVencimentoVO();
		excluir(obj, mpv, configuracaoFinanceiro, verificarPermissao, usuario);
	}

	public void excluirPorChequeDevolvido(Integer codigoCheque, UsuarioVO usuario) throws Exception {
		String clausulaWhere = " WHERE tipoorigem  = 'DCH' AND codorigem = '" + codigoCheque + "'";
		validarRegistroCobrancaAntesExclusao(clausulaWhere, null);

		verificarContaReceberPodemSerExcluidas(clausulaWhere, usuario);

		String sql = "DELETE FROM ContaReceber WHERE tipoorigem  = 'DCH' AND codorigem = '" + codigoCheque + "'" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluir(ContaReceberVO obj, MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVo, ConfiguracaoFinanceiroVO configuracaoFinanceiro, Boolean verificarPermissao, UsuarioVO usuario) throws Exception {

		try {
			if (verificarPermissao) {
				ContaReceber.excluir(getIdEntidade(), true, usuario);
			}
			verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "EXCLUIR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);

			if (matriculaPeriodoVencimentoVo.getCodigo().intValue() != 0) {
				// getFacadeFactory().getMatriculaPeriodoVencimentoFacade().excluir(matriculaPeriodoVencimentoVo.getCodigo(),usuario);
				// Se for uma parcela Extra irá excluir na
				// matriculaperiodovencimento, porque se no caso de adicionar
				// uma nova disciplina
				// o sistema consiga gerar uma nova parcela extra.
				if (matriculaPeriodoVencimentoVo.getParcela().equals("EX")) {
					getFacadeFactory().getMatriculaPeriodoVencimentoFacade().excluir(matriculaPeriodoVencimentoVo.getCodigo(), usuario);
				} else {
					matriculaPeriodoVencimentoVo.setContaReceber(null);
					matriculaPeriodoVencimentoVo.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);
					getFacadeFactory().getMatriculaPeriodoVencimentoFacade().alterar(matriculaPeriodoVencimentoVo, true, usuario);
				}

			}
			if (obj.getTipoOrigem().equals("BCC") && !obj.getMatriculaAluno().getMatricula().isEmpty() &&
					consultarExistenciaContaReceberAlunoVinculadoContaConvenio(obj.getMatriculaAluno().getMatricula(), obj.getMatriculaPeriodo(), obj.getConvenio().getCodigo(), obj.getParcela())) {
				throw new Exception(UteisJSF.internacionalizar("msg_ContaReceber_convenio_vinculo_matricula").replace("{0}", obj.getParcela()).replace("{1}", obj.getMatriculaAluno().getMatricula()).replace("{2}", obj.getMatriculaAluno().getAluno().getNome()));

			}
			if (consultarExistenciaContaReceberAlunoVinculadoRegistroNegativacao(obj.getCodigo())) {
				throw new Exception("Não é possível realizar a exclusão da conta a receber, a mesma possui um registro de negativação/cobrança vinculado!");
			}else {
				getFacadeFactory().getRegistroNegativacaoCobrancaContaReceberItemFacade().removerVinculoContaReceberRegistroNegativacaoContaReceber(obj.getCodigo(), usuario);
			}
			if (obj.getTipoOrigem().equals("MEN")) {
				List listaMatri = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorContaReceberMatriculaPeriodo(obj.getCodigo(), configuracaoFinanceiro, usuario);
				if (!listaMatri.isEmpty()) {
					Iterator i = listaMatri.iterator();
					while (i.hasNext()) {
						MatriculaPeriodoVO matr = (MatriculaPeriodoVO) i.next();
						getFacadeFactory().getMatriculaPeriodoFacade().atualizarContaReceberMatriculaPeriodo(matr.getCodigo());
					}
				}
			}
			getFacadeFactory().getMapaPendenciasControleCobrancaFacade().excluirPorContaReceber(obj, usuario);
			getFacadeFactory().getItemEmprestimoFacade().executarIsencaoEOuRemoverVinculoDaContaReceberParaItemEmprestimo(obj.getCodigo(), true, true, usuario);
			getFacadeFactory().getControleRemessaContaReceberFacade().removeVinculoContaReceberPorCodigoContaReceber(obj.getCodigo(), usuario);
			getFacadeFactory().getProcessamentoArquivoRetornoParceiroExcelFacade().removerVinculoContaReceberEspecifica(obj.getCodigo(), usuario);
			getFacadeFactory().getLancamentoContabilFacade().excluirPorCodOrigemTipoOrigem(obj.getCodigo().toString(), TipoOrigemLancamentoContabilEnum.RECEBER, false, usuario);
			getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().excluidoRegistroNaoExistenteListaPorCodOrigemPorTipoCentroResultadoOrigemEnum(null, obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, usuario);
			validarRegistroCobrancaAntesExclusao(" WHERE ((codigo = ?))", new Object[] { obj.getCodigo() });

			String sql = "DELETE FROM ContaReceber WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(sql, new Object[] { obj.getCodigo() });
			getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(obj, "exclusão", usuario);
		} catch (Exception e) {
			throw e;
		}
	}

	public void verificarDataVencimentoUnidadeContaBloqueadoParaRemocao(Integer codigoContaReceber, Boolean validarCompetenciaFechada, UsuarioVO usuario) throws Exception {
		ContaReceberVO obj = new ContaReceberVO();
		obj.setCodigo(codigoContaReceber);
		if (codigoContaReceber == null) {
			return;
		}
		carregarDados(obj, NivelMontarDados.BASICO, null, usuario);
		if (validarCompetenciaFechada) {
			verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "EXCLUIR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);
	}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirContasReceberTipoOrigemCodigoOrigem(String tipoOrigem, Integer codigoOrigem, String situacao, UsuarioVO usuario) throws Exception {
		excluirContasReceberTipoOrigemCodigoOrigem(tipoOrigem, codigoOrigem, situacao, Boolean.TRUE, usuario);
	}	
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirContasReceberTipoOrigemCodigoOrigem(String tipoOrigem, Integer codigoOrigem, String situacao, Boolean validarCompetenciaFechada, UsuarioVO usuario) throws Exception {
		StringBuilder sqlLog = getSqlConsultaRapidaContaReceberLog();
		sqlLog.append(" WHERE ((tipoOrigem = '").append(tipoOrigem).append("') and (codOrigem = '").append(codigoOrigem).append("'))");
		if (!situacao.equals("")) {
			sqlLog.append(" and (situacao = '").append(situacao.toUpperCase()).append("') ");
		}
		if (tipoOrigem.equals("BCC")) {
			sqlLog.append(adicionarValidacaoParaContaReceberConvenioSeExisteContaAlunoRecebida());
		}
		
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlLog.toString() + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
		while (resultado.next()) {
			verificarDataVencimentoUnidadeContaBloqueadoParaRemocao(resultado.getInt("codigo"), validarCompetenciaFechada, usuario);
			if (consultarExistenciaContaReceberAlunoVinculadoRegistroNegativacao(resultado.getInt("codigo"))) {
				throw new Exception("Não é possível realizar a exclusão da conta a receber de nosso número "+resultado.getString("nossonumero")+", a mesma possui um registro de negativação/cobrança vinculado!");
			}else {
				getFacadeFactory().getRegistroNegativacaoCobrancaContaReceberItemFacade().removerVinculoContaReceberRegistroNegativacaoContaReceber(resultado.getInt("codigo"), usuario);
			}
			getFacadeFactory().getControleRemessaContaReceberFacade().removeVinculoContaReceberPorCodigoContaReceber(resultado.getInt("codigo"), usuario);
			getFacadeFactory().getProcessamentoArquivoRetornoParceiroExcelFacade().removerVinculoContaReceberEspecifica(resultado.getInt("codigo"), usuario);
			getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(montarDadosConsultaRapidaLog(resultado), "exclusão", usuario);
			getFacadeFactory().getLancamentoContabilFacade().excluirPorCodOrigemTipoOrigem(String.valueOf(resultado.getInt("codigo")), TipoOrigemLancamentoContabilEnum.RECEBER, false, usuario);
			getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().excluidoRegistroNaoExistenteListaPorCodOrigemPorTipoCentroResultadoOrigemEnum(null, String.valueOf(resultado.getInt("codigo")), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, usuario);
		}
		String where = " WHERE ((tipoOrigem = ?) and (codOrigem = ?))";
		if (!situacao.equals("")) {
			where += " and (situacao = '" + situacao.toUpperCase() + "') ";
		}
		if (tipoOrigem.equals("BCC")) {
			where += adicionarValidacaoParaContaReceberConvenioSeExisteContaAlunoRecebida();
		}
		validarRegistroCobrancaAntesExclusao(where, new Object[] { tipoOrigem, String.valueOf(codigoOrigem) });
		String sql = "DELETE FROM ContaReceber WHERE ((tipoOrigem = ?) and (codOrigem = ?))";
		if (!situacao.equals("")) {
			sql += " and (situacao = '" + situacao.toUpperCase() + "') ";
		}
		if (tipoOrigem.equals("BCC")) {
			sql += adicionarValidacaoParaContaReceberConvenioSeExisteContaAlunoRecebida();
		}
		getConexao().getJdbcTemplate().update(sql + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario), new Object[] { tipoOrigem, String.valueOf(codigoOrigem) });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Boolean executarVerificarContaReceberImportadaSistemaLegada(Integer codigoConta, UsuarioVO usuario) throws Exception {
		String sql = "SELECT tituloImportadoSistemaLegado FROM ContaReceber WHERE (codigo = " + codigoConta + ")";
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql);
		if (!resultado.next()) {
			return false;
		}
		return resultado.getBoolean("tituloImportadoSistemaLegado");
	}

	/*@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirContasReceberTipoOrigemCodigoOrigemConvenioEspecifico(Integer convenioRemover, String tipoOrigem, Integer codigoOrigem, String situacao, String parcela, UsuarioVO usuario) throws Exception {
		excluirContasReceberTipoOrigemCodigoOrigemConvenioEspecifico(convenioRemover, tipoOrigem, codigoOrigem, situacao, parcela, Boolean.TRUE, usuario);
	}*/
		
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirContasReceberTipoOrigemCodigoOrigemConvenioEspecifico(Integer convenioRemover, String tipoOrigem, Integer codigoOrigem, String situacao, String parcela, Boolean validarCompetenciaFechada, UsuarioVO usuario) throws Exception {
		StringBuilder sqlLog = getSqlConsultaRapidaContaReceberLog();
		sqlLog.append(" WHERE ((tipoOrigem = '").append(tipoOrigem).append("') and (codOrigem = '").append(codigoOrigem).append("'))");
		sqlLog.append(" and (convenio = ").append(convenioRemover).append(") ");
		sqlLog.append(adicionarValidacaoParaContaReceberConvenioSeExisteContaAlunoRecebida());
		if (!situacao.equals("")) {
			sqlLog.append(" and (situacao = '").append(situacao.toUpperCase()).append("') ");
		}
		if (tipoOrigem.equals("BCC") && parcela.contains("/")) {
			sqlLog.append(" and contareceber.parcela ilike('%/%') and (substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) = '").append(parcela.substring(0, parcela.indexOf("/"))).append("') ");
		}else if (Uteis.isAtributoPreenchido(parcela) && (parcela.equals("Matrícula") || parcela.equals("MA") || parcela.equals("MAT") || parcela.equals("MATRICULA") || parcela.equals("MATRÍCULA"))) {
			sqlLog.append(" AND (contareceber.parcela in ('Matrícula', 'MA', 'MAT', 'Matricula', 'MATRICULA', 'MATRÍCULA')) ");
		}else if (!parcela.equals("")) {
			sqlLog.append(" and (parcela = '").append(parcela).append("') ");
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlLog.toString());
		while (resultado.next()) {
			if (consultarExistenciaContaReceberAlunoVinculadoRegistroNegativacao(resultado.getInt("codigo"))) {
				throw new Exception("Não é possível realizar a exclusão da conta a receber de nosso número "+resultado.getString("nossoNumero")+", a mesma possui um registro de negativação/cobrança vinculado!");
			}else {
				getFacadeFactory().getRegistroNegativacaoCobrancaContaReceberItemFacade().removerVinculoContaReceberRegistroNegativacaoContaReceber(resultado.getInt("codigo"), usuario);
			}
			verificarDataVencimentoUnidadeContaBloqueadoParaRemocao(resultado.getInt("codigo"), validarCompetenciaFechada, usuario);
			getFacadeFactory().getControleRemessaContaReceberFacade().removeVinculoContaReceberPorCodigoContaReceber(resultado.getInt("codigo"), usuario);
			getFacadeFactory().getProcessamentoArquivoRetornoParceiroExcelFacade().removerVinculoContaReceberEspecifica(resultado.getInt("codigo"), usuario);
			getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(montarDadosConsultaRapidaLog(resultado), "exclusão", usuario);
			getFacadeFactory().getLancamentoContabilFacade().excluirPorCodOrigemTipoOrigem(String.valueOf(resultado.getInt("codigo")), TipoOrigemLancamentoContabilEnum.RECEBER, false, usuario);
			getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().excluidoRegistroNaoExistenteListaPorCodOrigemPorTipoCentroResultadoOrigemEnum(null, String.valueOf(resultado.getInt("codigo")), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, usuario);
		}

		String where = " WHERE ((tipoOrigem = ?) and (codOrigem = ?))";
		where += " and (convenio = " + convenioRemover + ") ";
		where += adicionarValidacaoParaContaReceberConvenioSeExisteContaAlunoRecebida();
		if (!situacao.equals("")) {
			where += " and (situacao = '" + situacao.toUpperCase() + "') ";
		}
		if (tipoOrigem.equals("BCC") && parcela.contains("/")) {
			where += " and contareceber.parcela ilike('%/%') and (substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) = '" + parcela.substring(0, parcela.indexOf("/"))+"') ";
		}else if (Uteis.isAtributoPreenchido(parcela) && (parcela.equals("Matrícula") || parcela.equals("MA") || parcela.equals("MAT") || parcela.equals("MATRICULA") || parcela.equals("MATRÍCULA"))) {
			where += " AND (contareceber.parcela in ('Matrícula', 'MA', 'MAT', 'Matricula', 'MATRICULA', 'MATRÍCULA')) ";
		}else if (!parcela.equals("")) {
			where += " and (parcela = '" + parcela + "') ";
		}
		validarRegistroCobrancaAntesExclusao(where, new Object[] { tipoOrigem.toUpperCase(), String.valueOf(codigoOrigem) });
		String sql = "DELETE FROM ContaReceber WHERE ((tipoOrigem = ?) and (codOrigem = ?))";
		sql += " and (convenio = " + convenioRemover + ") ";
		sql += adicionarValidacaoParaContaReceberConvenioSeExisteContaAlunoRecebida();
		if (!situacao.equals("")) {
			sql += " and (situacao = '" + situacao.toUpperCase() + "') ";
		}
		if (tipoOrigem.equals("BCC") && parcela.contains("/")) {
			sql += " and contareceber.parcela ilike('%/%') and (substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) = '"+parcela.substring(0, parcela.indexOf("/"))+"') ";
		}else if (Uteis.isAtributoPreenchido(parcela) && (parcela.equals("Matrícula") || parcela.equals("MA") || parcela.equals("MAT") || parcela.equals("MATRICULA") || parcela.equals("MATRÍCULA"))) {
			sql += " AND (contareceber.parcela in ('Matrícula', 'MA', 'MAT', 'Matricula', 'MATRICULA', 'MATRÍCULA')) ";
		}else if (!parcela.equals("")) {
			sql += " and (parcela = '" + parcela + "') ";
		}
		getConexao().getJdbcTemplate().update(sql + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario), new Object[] { tipoOrigem.toUpperCase(), String.valueOf(codigoOrigem) });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirContasReceberTipoOrigemCodigoOrigem(String tipoOrigem, Integer codigoOrigem, String situacao, String parcela, UsuarioVO usuario) throws Exception {
		excluirContasReceberTipoOrigemCodigoOrigem(tipoOrigem, codigoOrigem, situacao, parcela, Boolean.TRUE, usuario);
	}	
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirContasReceberTipoOrigemCodigoOrigem(String tipoOrigem, Integer codigoOrigem, String situacao, String parcela, Boolean validarCompetenciaFechada, UsuarioVO usuario) throws Exception {
		StringBuilder sqlLog = getSqlConsultaRapidaContaReceberLog();
		sqlLog.append(" WHERE ((tipoOrigem = '").append(tipoOrigem).append("') and (codOrigem = '").append(codigoOrigem).append("'))");
		if (!situacao.equals("")) {
			sqlLog.append(" and (situacao = '").append(situacao.toUpperCase()).append("') ");
		}
		if (tipoOrigem.equals("BCC") && parcela.contains("/")) {
			sqlLog.append(" and contareceber.parcela ilike('%/%') and (substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) = '").append(parcela.substring(0, parcela.indexOf("/"))).append("') ");
		}else if (Uteis.isAtributoPreenchido(parcela) && (parcela.equals("Matrícula") || parcela.equals("MA") || parcela.equals("MAT") || parcela.equals("MATRICULA") || parcela.equals("MATRÍCULA"))) {
			sqlLog.append(" AND (contareceber.parcela in ('Matrícula', 'MA', 'MAT', 'Matricula', 'MATRICULA', 'MATRÍCULA')) ");
		} else if (!parcela.equals("")) {
			sqlLog.append(" and (parcela = '").append(parcela).append("') ");
		}
		sqlLog.append(adicionarValidacaoParaContaReceberConvenioSeExisteContaAlunoRecebida());
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlLog.toString());
		while (resultado.next()) {
			verificarDataVencimentoUnidadeContaBloqueadoParaRemocao(resultado.getInt("codigo"), validarCompetenciaFechada, usuario);
			if (consultarExistenciaContaReceberAlunoVinculadoRegistroNegativacao(resultado.getInt("codigo"))) {
				throw new Exception("Não é possível realizar a exclusão da conta a receber de nosso número "+resultado.getString("nossoNumero")+", a mesma possui um registro de negativação/cobrança vinculado!");
			}else {
				getFacadeFactory().getRegistroNegativacaoCobrancaContaReceberItemFacade().removerVinculoContaReceberRegistroNegativacaoContaReceber(resultado.getInt("codigo"), usuario);
			}
			getFacadeFactory().getControleRemessaContaReceberFacade().removeVinculoContaReceberPorCodigoContaReceber(resultado.getInt("codigo"), usuario);
			getFacadeFactory().getProcessamentoArquivoRetornoParceiroExcelFacade().removerVinculoContaReceberEspecifica(resultado.getInt("codigo"), usuario);
			getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(montarDadosConsultaRapidaLog(resultado), "exclusão", usuario);
			getFacadeFactory().getLancamentoContabilFacade().excluirPorCodOrigemTipoOrigem(String.valueOf(resultado.getInt("codigo")), TipoOrigemLancamentoContabilEnum.RECEBER, false, usuario);
			getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().excluidoRegistroNaoExistenteListaPorCodOrigemPorTipoCentroResultadoOrigemEnum(null, String.valueOf(resultado.getInt("codigo")), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, usuario);
		}
		String where = " WHERE ((tipoOrigem = ?) and (codOrigem = ?))";
		if (!situacao.equals("")) {
			where += " and (situacao = '" + situacao.toUpperCase() + "') ";
		}
		if (tipoOrigem.equals("BCC") && parcela.contains("/")) {
			where += " and contareceber.parcela ilike('%/%') and (substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) = '" + parcela.substring(0, parcela.indexOf("/"))+"') ";
		}else if (Uteis.isAtributoPreenchido(parcela) && (parcela.equals("Matrícula") || parcela.equals("MA") || parcela.equals("MAT") || parcela.equals("MATRICULA") || parcela.equals("MATRÍCULA"))) {
			where += " AND (contareceber.parcela in ('Matrícula', 'MA', 'MAT', 'Matricula', 'MATRICULA', 'MATRÍCULA')) ";
		}else if (!parcela.equals("")) {
			where += " and (parcela = '" + parcela + "') ";
		}
		where +=adicionarValidacaoParaContaReceberConvenioSeExisteContaAlunoRecebida();
		validarRegistroCobrancaAntesExclusao(where, new Object[] { tipoOrigem.toUpperCase(), String.valueOf(codigoOrigem) });
		String sql = "DELETE FROM ContaReceber WHERE ((tipoOrigem = ?) and (codOrigem = ?))";
		if (!situacao.equals("")) {
			sql += " and (situacao = '" + situacao.toUpperCase() + "') ";
		}
		if (tipoOrigem.equals("BCC") && parcela.contains("/")) {
			sql += " and (substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) = '"+parcela.substring(0, parcela.indexOf("/"))+"') ";
		}else if (Uteis.isAtributoPreenchido(parcela) && (parcela.equals("Matrícula") || parcela.equals("MA") || parcela.equals("MAT") || parcela.equals("MATRICULA") || parcela.equals("MATRÍCULA"))) {
			sql += " AND (contareceber.parcela in ('Matrícula', 'MA', 'MAT', 'Matricula', 'MATRICULA', 'MATRÍCULA')) ";
		}else if (!parcela.equals("")) {
			sql += " and (parcela = '" + parcela + "') ";
		}
		sql+=adicionarValidacaoParaContaReceberConvenioSeExisteContaAlunoRecebida();
		getConexao().getJdbcTemplate().update(sql + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario), new Object[] { tipoOrigem.toUpperCase(), String.valueOf(codigoOrigem) });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluir(ContaReceberVO contaReceber, UsuarioVO usuario) throws Exception {
		ContaReceber.excluir(getIdEntidade());
		verificarCompetenciaBloqueadaParaRegistrosEntidade(contaReceber, "EXCLUIR", contaReceber.getDataVencimento(), contaReceber.getDataCompetencia(), contaReceber.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);
		if (consultarExistenciaContaReceberAlunoVinculadoRegistroNegativacao(contaReceber.getCodigo())) {
			throw new Exception("Não é possível realizar a exclusão da conta a receber, a mesma possui um registro de negativação/cobrança vinculado!");
		}
		getFacadeFactory().getControleRemessaContaReceberFacade().removeVinculoContaReceberPorCodigoContaReceber(contaReceber.getCodigo(), usuario);
		getFacadeFactory().getMapaPendenciasControleCobrancaFacade().excluirPorContaReceber(contaReceber, usuario);
		getFacadeFactory().getProcessamentoArquivoRetornoParceiroExcelFacade().removerVinculoContaReceberEspecifica(contaReceber.getCodigo(), usuario);
		getFacadeFactory().getLancamentoContabilFacade().excluirPorCodOrigemTipoOrigem(contaReceber.getCodigo().toString(), TipoOrigemLancamentoContabilEnum.RECEBER, false, usuario);
		getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().excluidoRegistroNaoExistenteListaPorCodOrigemPorTipoCentroResultadoOrigemEnum(null, contaReceber.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, usuario);
		validarRegistroCobrancaAntesExclusao(" WHERE ((codigo = ?))", new Object[] { contaReceber.getCodigo() });
		String sql = "DELETE FROM ContaReceber WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql, new Object[] { contaReceber.getCodigo() });
		getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(contaReceber, "exclusao", usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirPorMatriculaPeriodoNaoRecebidaNaoNegociada(Integer codigoMatriculaPeriodo, UsuarioVO usuario) throws Exception {
		ContaReceber.excluir(getIdEntidade());
		StringBuilder sqlLog = getSqlConsultaRapidaContaReceberLog();
		sqlLog.append(" WHERE ((matriculaperiodo = " + codigoMatriculaPeriodo + ") and situacao <> 'RE' and situacao <> 'NE' and parcela not like '%N%') ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlLog.toString());
		while (resultado.next()) {
			verificarDataVencimentoUnidadeContaBloqueadoParaRemocao(resultado.getInt("codigo"), Boolean.TRUE, usuario);
			if (consultarExistenciaContaReceberAlunoVinculadoRegistroNegativacao(resultado.getInt("codigo"))) {
				throw new Exception("Não é possível realizar a exclusão da conta a receber de nosso número "+resultado.getString("nossoNumero")+", a mesma possui um registro de negativação/cobrança vinculado!");
			}else {
				getFacadeFactory().getRegistroNegativacaoCobrancaContaReceberItemFacade().removerVinculoContaReceberRegistroNegativacaoContaReceber(resultado.getInt("codigo"), usuario);
			}
			getFacadeFactory().getControleRemessaContaReceberFacade().removeVinculoContaReceberPorCodigoContaReceber(resultado.getInt("codigo"), usuario);
			getFacadeFactory().getProcessamentoArquivoRetornoParceiroExcelFacade().removerVinculoContaReceberEspecifica(resultado.getInt("codigo"), usuario);
			getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(montarDadosConsultaRapidaLog(resultado), "exclusão", usuario);
			getFacadeFactory().getLancamentoContabilFacade().excluirPorCodOrigemTipoOrigem(String.valueOf(resultado.getInt("codigo")), TipoOrigemLancamentoContabilEnum.RECEBER, false, usuario);
			getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().excluidoRegistroNaoExistenteListaPorCodOrigemPorTipoCentroResultadoOrigemEnum(null, String.valueOf(resultado.getInt("codigo")), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, usuario);
		}
		validarRegistroCobrancaAntesExclusao("WHERE ((matriculaperiodo = ?) and situacao <> 'RE' and situacao <> 'NE' and parcela not like '%N%')", new Object[] { codigoMatriculaPeriodo });
		String sql = "DELETE FROM ContaReceber WHERE ((matriculaperiodo = ?) and situacao <> 'RE' and situacao <> 'NE' and parcela not like '%N%')";
		getConexao().getJdbcTemplate().update(sql + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario), new Object[] { codigoMatriculaPeriodo });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluir(ContaReceberVO contaReceber, boolean verificarAcesso, UsuarioVO usuario) throws Exception {
		ContaReceber.excluir(getIdEntidade(), verificarAcesso, usuario);
		verificarCompetenciaBloqueadaParaRegistrosEntidade(contaReceber, "EXCLUIR", contaReceber.getDataVencimento(), contaReceber.getDataCompetencia(), contaReceber.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);

		getFacadeFactory().getControleRemessaContaReceberFacade().removeVinculoContaReceberPorCodigoContaReceber(contaReceber.getCodigo(), usuario);
		getFacadeFactory().getMapaPendenciasControleCobrancaFacade().excluirPorContaReceber(contaReceber, usuario);
		getFacadeFactory().getProcessamentoArquivoRetornoParceiroExcelFacade().removerVinculoContaReceberEspecifica(contaReceber.getCodigo(), usuario);
		getFacadeFactory().getLancamentoContabilFacade().excluirPorCodOrigemTipoOrigem(contaReceber.getCodigo().toString(), TipoOrigemLancamentoContabilEnum.RECEBER, false, usuario);
		getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().excluidoRegistroNaoExistenteListaPorCodOrigemPorTipoCentroResultadoOrigemEnum(null, contaReceber.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, usuario);
		validarRegistroCobrancaAntesExclusao(" WHERE ((codigo = ?))", new Object[] { contaReceber.getCodigo() });
		String sql = "DELETE FROM ContaReceber WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql, new Object[] { contaReceber.getCodigo() });
		getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(contaReceber, "exclusão", usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public static void excluirContaFilho(ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "EXCLUIR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);

		validarRegistroCobrancaAntesExclusao(" WHERE ((origemNegociacaoReceber = ?))", new Object[] { obj.getCodigo() });
		String sql = "DELETE FROM ContaReceber WHERE ((origemNegociacaoReceber = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql, new Object[] { obj.getCodigo() });
		getFacadeFactory().getContaReceberLogFacade().preencherContaReceberLog(obj, "exclusão", usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public static void incluirContaFilho(List objs, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		Iterator i = objs.iterator();
		while (i.hasNext()) {
			ContaReceberVO obj = (ContaReceberVO) i.next();
			getFacadeFactory().getContaReceberFacade().incluir(obj, configuracaoFinanceiro, usuario);
		}

	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirContasReceberIntegracaoFinanceiro(UsuarioVO usuario) throws Exception {
		validarRegistroCobrancaAntesExclusao(" WHERE situacao = 'AR' and tipoOrigem in ('MAT','MEN')", null);
		String sql = "DELETE FROM ContaReceber WHERE situacao = 'AR' and tipoOrigem in ('MAT','MEN')";
		getConexao().getJdbcTemplate().update(sql + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public boolean incluirContaReceberIntegracaoFinanceiro(ContaReceberVO contaReceber, UsuarioVO usuario) throws Exception {

		// TODO tratar sem excessão
		return false;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorIdentificadorCentroReceitaCentroReceita (java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	@Override
	public List consultarPorIdentificadorCentroReceita(String valorConsulta, Date dataIni, Date dataFim, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), true, usuario);
		String sqlStr = "SELECT ContaReceber.* FROM ContaReceber, CentroReceita WHERE ContaReceber.centroReceita = CentroReceita.codigo and upper( CentroReceita.identificadorCentroReceita ) like('" + valorConsulta.toUpperCase() + "%')";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr = "SELECT ContaReceber.* FROM ContaReceber, CentroReceita WHERE ContaReceber.centroReceita = CentroReceita.codigo and upper( CentroReceita.identificadorCentroReceita ) like('" + valorConsulta.toUpperCase() + "%') and ContaReceber.unidadeensinofinanceira = " + unidadeEnsino.intValue();
		}
		sqlStr += " AND dataVencimento >= '" + Uteis.getDataJDBC(dataIni) + "' ";
		sqlStr += " AND dataVencimento <= '" + Uteis.getDataJDBC(dataFim) + "' ";
		if ((!situacao.equals("")) && (!situacao.equals("TO"))) {
			sqlStr += "and upper(contareceber.situacao) ilike('" + situacao + "%') ";
		}
		sqlStr += " ORDER BY contaReceber.dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	@Override
	public List<ContaReceberVO> consultaRapidaPorIdentificadorCentroReceita(String nomeSacado, String centroReceita, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, List<String> ordenador) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE 1 = 1 ");

		sql.append(" AND (UPPER(centroreceita.descricao) LIKE sem_acentos(?))");
		if (unidadeEnsino.intValue() != 0) {
			sql.append(" AND (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") ");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" AND (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append("))");
		}

		if (!consDataCompetencia) {
			sql.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		if (Uteis.isAtributoPreenchido(ordenador)) {
			sql.append("ORDER BY ").append(UteisTexto.converteListaStringParaString(ordenador));
		} else {
			sql.append(
					"ORDER BY contareceber.datavencimento, contareceber.datacompetencia, contareceber.matriculaaluno ");
		}
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), nomeSacado.toUpperCase() + "%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorIdentificadorCentroReceitaTotalRegistros(String nomeSacado, String centroReceita, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append(" WHERE 1 = 1");

		sql.append(" and UPPER(centroreceita.descricao) LIKE sem_acentos(?) AND ");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("(contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND ");
		}
		if (!consDataCompetencia) {
			sql.append("(contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("(contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), nomeSacado.toUpperCase() + "%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	public List consultaRapidaPorCodigoFormaPagamentoNegociacaoRecebimento(Integer codigoFormaPgtoNegRec, boolean controlarAcesso, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append(" select contareceber.* from formapagamentonegociacaorecebimento ");
		sql.append(" inner join negociacaorecebimento on negociacaorecebimento.codigo = formapagamentonegociacaorecebimento.negociacaorecebimento");
		sql.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo");
		sql.append(" inner join contareceber on contarecebernegociacaorecebimento.contareceber = contareceber.codigo");
		sql.append(" where formapagamentonegociacaorecebimento.codigo = ");
		sql.append(codigoFormaPgtoNegRec);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsulta(tabelaResultado, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
	}

	public List<ContaReceberVO> consultarAlunoNotificarBoleto() throws Exception {
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" where contareceber.situacao = 'AR'");
		sql.append(" and contareceber.tipoorigem in ('MEN', 'MDI', 'NCR')");
//		sql.append(" and matricula.situacao = 'AT' ");
		sql.append(" and contaReceberJaEnviadaAluno = false ");
		sql.append(" and datavencimento >= '").append(Uteis.getDataPrimeiroDiaMes(new Date())).append("' and datavencimento <= '").append(Uteis.getDataUltimoDiaMes(new Date())).append("' ");
		sql.append(" limit  1000 ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(resultado);
	}
	
	public List consultarAlunoNotificarBoleto(PersonalizacaoMensagemAutomaticaVO personalizacaoMensagemAutomaticaVO) throws Exception {
		StringBuilder sql = getSQLPadraoConsultaBasica();
		
		if(isFiltrarNivelEducacional(personalizacaoMensagemAutomaticaVO)) {
			sql.append(" inner join curso on matricula.curso = curso.codigo ");
		}
		sql.append(" where contareceber.situacao = 'AR'");
		sql.append(" and contareceber.tipoorigem in ('MEN', 'MDI', 'NCR')");
//		sql.append(" and matricula.situacao = 'AT' ");
		sql.append(" and contaReceberJaEnviadaAluno = false ");
		sql.append(" and datavencimento >= '").append(Uteis.getDataPrimeiroDiaMes(new Date())).append("' and datavencimento <= '").append(Uteis.getDataUltimoDiaMes(new Date())).append("' ");
		
		if (!personalizacaoMensagemAutomaticaVO.getPersonalizacaoMensagemAutomaticaUnidadeEnsinoVOs().isEmpty()) {
			boolean virgula = false;
			sql.append("AND contareceber.unidadeensino IN(");
			for (PersonalizacaoMensagemAutomaticaUnidadeEnsinoVO personalizacaoMensagemAutomaticaUnidadeEnsinoVO : personalizacaoMensagemAutomaticaVO.getPersonalizacaoMensagemAutomaticaUnidadeEnsinoVOs()) {
				if (personalizacaoMensagemAutomaticaUnidadeEnsinoVO.getUnidadeEnsino().getFiltrarUnidadeEnsino()) {
					if (!virgula) {
						sql.append(personalizacaoMensagemAutomaticaUnidadeEnsinoVO.getUnidadeEnsino().getCodigo());
					} else {
						sql.append(", ").append(personalizacaoMensagemAutomaticaUnidadeEnsinoVO.getUnidadeEnsino().getCodigo());
					}
					virgula = true;
				}
			}
			sql.append(") ");
		}
		
		if(isFiltrarNivelEducacional(personalizacaoMensagemAutomaticaVO)) {
			sql.append(montarFiltroNivelEducacional(personalizacaoMensagemAutomaticaVO));
		}
		
		sql.append(" limit  1000 ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(resultado);
	}
	
	private static StringBuilder montarFiltroNivelEducacional(PersonalizacaoMensagemAutomaticaVO personalizacaoMensagemAutomaticaVO) {
		StringBuilder sb = new StringBuilder();
		sb.append(" and curso.niveleducacional in (");
		sb.append(personalizacaoMensagemAutomaticaVO.getNivelEducacionalInfantil() ? "'IN'," : "");
		sb.append(personalizacaoMensagemAutomaticaVO.getNivelEducacionalBasico() ? "'BA'," : "");
		sb.append(personalizacaoMensagemAutomaticaVO.getNivelEducacionalMedio() ? "'ME'," : "");
		sb.append(personalizacaoMensagemAutomaticaVO.getNivelEducacionalExtensao() ? "'EX'," : "");
		sb.append(personalizacaoMensagemAutomaticaVO.getNivelEducacionalSequencial() ? "'SE'," : "");
		sb.append(personalizacaoMensagemAutomaticaVO.getNivelEducacionalGraduacaoTecnologica() ? "'GT'," : "");
		sb.append(personalizacaoMensagemAutomaticaVO.getNivelEducacionalSuperior() ? "'SU'," : "");
		sb.append(personalizacaoMensagemAutomaticaVO.getNivelEducacionalPosGraduacao()? "'PO'," : "");
		sb.append(personalizacaoMensagemAutomaticaVO.getNivelEducacionalMestrado() ? "'MT'," : "");
		sb.append(personalizacaoMensagemAutomaticaVO.getNivelEducacionalProfissionalizante() ? "'PR'," : "");

		sb = new StringBuilder(sb.substring(0, sb.length()-1));
		sb.append(") ");
		return sb;
	}
	
	private static boolean isFiltrarNivelEducacional(PersonalizacaoMensagemAutomaticaVO personalizacaoMensagemAutomaticaVO){
		if(personalizacaoMensagemAutomaticaVO.getNivelEducacionalInfantil() || personalizacaoMensagemAutomaticaVO.getNivelEducacionalBasico() ||
				personalizacaoMensagemAutomaticaVO.getNivelEducacionalMedio() || personalizacaoMensagemAutomaticaVO.getNivelEducacionalExtensao() ||
				personalizacaoMensagemAutomaticaVO.getNivelEducacionalSequencial() || personalizacaoMensagemAutomaticaVO.getNivelEducacionalGraduacaoTecnologica() ||
				personalizacaoMensagemAutomaticaVO.getNivelEducacionalSuperior() || personalizacaoMensagemAutomaticaVO.getNivelEducacionalPosGraduacao() ||
				personalizacaoMensagemAutomaticaVO.getNivelEducacionalMestrado() || personalizacaoMensagemAutomaticaVO.getNivelEducacionalProfissionalizante()) {
			return true;
		}
		return false;
	}
	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorIdentificadorCentroReceitaCentroReceitaSituacaoPessoa (java.lang.String, java.lang.Integer, java.lang.String, java.lang.Integer, boolean, int)
	 */
	public List consultarPorIdentificadorCentroReceitaSituacaoPessoa(String valorConsulta, Integer pessoa, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), true, usuario);
		String sqlStr = "SELECT ContaReceber.* FROM ContaReceber, CentroReceita WHERE ContaReceber.centroReceita = CentroReceita.codigo and upper( CentroReceita.identificadorCentroReceita ) like('" + valorConsulta.toUpperCase() + "%') " + " and ContaReceber.situacao = 'AR' and ContaReceber.pessoa = " + pessoa.intValue() + "";
		if (situacao.equals("AV")) {
			sqlStr += " and (ContaReceber.dataVencimento >= '" + Uteis.getDataJDBC(new Date()) + "')";
		}
		if (situacao.equals("VE")) {
			sqlStr += " and (ContaReceber.dataVencimento <= '" + Uteis.getDataJDBC(new Date()) + "')";
		}
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " and ContaReceber.unidadeensinofinanceira = " + unidadeEnsino.intValue() + "";
		}
		sqlStr += "  ORDER BY contaReceber.dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorPendeciaFinanceiraAluno(java.lang.Integer, java.lang.Integer, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorPendeciaFinanceiraAluno(java.lang.Integer, java.lang.Integer, int)
	 */
	public List consultarPorPendeciaFinanceiraAluno(Integer pessoa, Integer unidadeEnsino, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), true, usuario);
		String sqlStr = "SELECT * FROM ContaReceber WHERE situacao = 'AR' and pessoa = " + pessoa.intValue() + " and (dataVencimento <= '" + Uteis.getDataJDBC(new Date()) + "') ";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " and unidadeEnsino = " + unidadeEnsino.intValue() + "";
		}
		sqlStr += "  ORDER BY dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public ContaReceberVO consultarNomeUltimaParcela(Integer pessoa) throws Exception {
		String sqlStr = "SELECT parcela, updated FROM ContaReceber WHERE pessoa = " + pessoa + " AND tipoOrigem = 'OUT' Order by codigo desc Limit 1";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		ContaReceberVO obj = new ContaReceberVO();
		if (tabelaResultado.next()) {
			obj.setUpdated(tabelaResultado.getDate("updated"));
			obj.setParcela(tabelaResultado.getString("parcela"));
			obj.setNovoObj(Boolean.FALSE);
		}
		return obj;
	}

	public ContaReceberVO consultarPrimeiraMensalidade(MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		return consultarPrimeiraMensalidade(matriculaPeriodoVO, "MEN", true);
	}

	public ContaReceberVO consultarPrimeiraMensalidade(MatriculaPeriodoVO matriculaPeriodoVO, String tipoOrigem, Boolean considerarAnoSemestre) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT contareceber.codigo, valorDescontoCalculadoPrimeiraFaixaDescontos, contareceber.updated FROM ContaReceber");
		sqlStr.append(" inner join matriculaperiodo on matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		sqlStr.append(" WHERE matriculaaluno = '" + matriculaPeriodoVO.getMatricula() + "' AND tipoOrigem = '" + tipoOrigem + "'");
		if(considerarAnoSemestre){
			if (Uteis.isAtributoPreenchido(matriculaPeriodoVO.getAno()) ) {
				sqlStr.append(" and matriculaperiodo.ano = '").append(matriculaPeriodoVO.getAno()).append("'");
			}
			if (Uteis.isAtributoPreenchido(matriculaPeriodoVO.getSemestre())) {
				sqlStr.append(" and matriculaperiodo.semestre = '").append(matriculaPeriodoVO.getSemestre()).append("'");
			}
		}
		sqlStr.append("  Order by codigo  Limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		ContaReceberVO obj = new ContaReceberVO();
		if (tabelaResultado.next()) {
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setUpdated(tabelaResultado.getDate("updated"));
			obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(tabelaResultado.getDouble("valorDescontoCalculadoPrimeiraFaixaDescontos"));
			obj.setNovoObj(Boolean.FALSE);
		}
		return obj;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorMatriculaAlunoPorTipoOrigem(java.lang. String, java.lang.String, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorMatriculaAlunoPorTipoOrigem(java.lang. String, java.lang.String, boolean, int)
	 */
	public List consultarPorMatriculaAlunoPorTipoOrigem(String matricula, String tipoOrigem, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM ContaReceber WHERE matriculaaluno = '" + matricula + "' AND tipoorigem = '" + tipoOrigem + "' ORDER BY dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarExistenciaPendenciaFinanceiraMatricula(java .lang.String)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarExistenciaPendenciaFinanceiraMatricula(java .lang.String)
	 */
	public Boolean consultarExistenciaPendenciaFinanceiraMatricula(String matricula, UsuarioVO usuario) throws Exception {
		String sqlStr = "SELECT case when (count(codigo) > 0) then true else false end as existe FROM ContaReceber WHERE matriculaaluno = '" + matricula + "' and situacao = 'AR' and tipoOrigem not in ('REQ', 'BCC') ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("existe");
		}
		return false;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarExistenciaPendenciaFinanceiraMatricula(java .lang.String)
	 */
	@Override
	public Boolean consultarExistenciaPendenciaFinanceiraMatriculaEmAtraso(String matricula, UsuarioVO usuario) throws Exception {
		String sqlStr = "SELECT case when (count(codigo) > 0) then true else false end as existe FROM ContaReceber WHERE matriculaaluno = '" + matricula + "' and situacao = 'AR' and tipoOrigem not in ('REQ', 'BCC') and datavencimento < current_date ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("existe");
		}
		return false;
	}

	public Boolean consultarExistenciaPendenciaFinanceiraMatricula(Integer pessoa, String matricula, UsuarioVO usuario) throws Exception {
		String sqlStr = "SELECT case when (count(codigo) > 0) then true else false end as existe FROM ContaReceber ";
		if (!matricula.equals("")) {
			sqlStr += "WHERE matriculaaluno = '" + matricula + "' ";
		} else {
			sqlStr += "WHERE pessoa = " + pessoa + " ";
		}
		sqlStr += "and situacao = 'AR' and tipoOrigem not in ('REQ', 'BCC') ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("existe");
		}
		return false;
	}

	public Boolean consultarExistenciaPendenciaFinanceiraMatriculaEmAtraso(Integer pessoa, String matricula, UsuarioVO usuario) throws Exception {
		String sqlStr = "SELECT case when (count(codigo) > 0) then true else false end as existe FROM ContaReceber ";
		if (!matricula.equals("")) {
			sqlStr += " WHERE matriculaaluno = '" + matricula + "' ";
		} else {
			sqlStr += " WHERE pessoa = " + pessoa + " ";
		}
		sqlStr += " and situacao = 'AR' and tipoOrigem not in ('REQ', 'BCC') and datavencimento < current_date ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("existe");
		}
		return false;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorParceiroPorTipoOrigem(java.lang.Integer, java.lang.String, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorParceiroPorTipoOrigem(java.lang.Integer, java.lang.String, boolean, int)
	 */
	public List consultarPorParceiroPorTipoOrigem(String valorConsulta, Integer codigoParceiro, String tipoOrigem, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append(" SELECT * FROM ContaReceber WHERE parceiro = ").append(codigoParceiro);
		if (tipoOrigem != null && !tipoOrigem.equals("")) {
			sqlStr.append(" AND tipoorigem in (").append(tipoOrigem).append(") ");
		}
		if (valorConsulta.equalsIgnoreCase("VE")) {
			sqlStr.append(" AND situacao = 'AR' AND dataVencimento <= '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("' ");
		}
		if (valorConsulta.equalsIgnoreCase("AV")) {
			sqlStr.append(" AND situacao = 'AR' AND dataVencimento > '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("' ");
		}
		sqlStr.append(" ORDER BY dataVencimento ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorOrigemContaReceber(java.lang.String, java.lang.String, java.lang.String, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorOrigemContaReceber(java.lang.String, java.lang.String, java.lang.String, boolean, int)
	 */
	public List consultarPorOrigemContaReceber(String codigoOrigem, String tipoOrigem, String situacaoFinanceira, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sql = "select * from contareceber where codorigem = ? and tipoorigem = ? and situacao = ?";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql, new Object[] { codigoOrigem, tipoOrigem, situacaoFinanceira });
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}
	
	public Boolean verificarExisteContaReceberPorCodOrigemTipoOrigemSituacaoNegociacaoContaReceber(String codOrigem, String tipoOrigem, String situacao) throws Exception {
		String sqlStr = "SELECT * FROM contareceber WHERE codorigem  = ? AND tipoorigem = ? and situacao  = ? ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr, new Object[] { codOrigem, tipoOrigem, situacao });
		if (tabelaResultado.next()) {
			return true;
		}
		return false;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorNrDocumento(java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorNrDocumento(java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	@Override
	public List consultarPorNrDocumento(String valorConsulta, Date dataIni, Date dataFim, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), true, usuario);
		String sqlStr = "SELECT * FROM ContaReceber WHERE nrDocumento  ilike('" + valorConsulta + "%')";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	@SuppressWarnings("static-access")
	@Override
	public List<ContaReceberVO> consultaRapidaPorNrDocumento(String valorConsulta, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE contareceber.nrdocumento ILIKE (?) ");
		if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" AND (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append("))");
		}

		sql.append("ORDER BY contareceber.nrdocumento");
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorNrDocumentoTotalRegistros(String valorConsulta, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append(" WHERE contareceber.nrdocumento ILIKE (?)");

		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	/*
	 * ALTERADO NA VERSAO 5.0 PARA UTILIZAR O MONTARDADOS CONSULTA RAPIDA
	 */
	public List consultarPorCodOrigemTipoOrigem(String tipoOrigem, Integer codigoOrigem, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = null;
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_TODOS) {
			sql = getSQLPadraoConsultaCompletaSemContaReceberRecebimento();
		} else {
			sql = getSQLPadraoConsultaBasica();
		}
		if (unidadeEnsino.intValue() != 0) {
			sql.append("WHERE upper( tipoOrigem ) = '").append(tipoOrigem.toUpperCase()).append("' and codOrigem = '").append(String.valueOf(codigoOrigem)).append("' and unidadeEnsino =").append(unidadeEnsino.intValue()).append(" ORDER BY contaReceber.dataVencimento");
		} else {
			sql.append("WHERE upper( tipoOrigem ) = '").append(tipoOrigem.toUpperCase()).append("' and codOrigem = '").append(String.valueOf(codigoOrigem)).append("' ").append(" ORDER BY contaReceber.dataVencimento");
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_TODOS) {
			return montarDadosConsultaCompleta(resultado, configuracaoFinanceiroVO, nivelMontarDados, usuario);
		} else {
			return montarDadosConsultaBasica(resultado);
		}
		// String sqlStr =
		// "SELECT * FROM ContaReceber WHERE upper( tipoOrigem ) = '" +
		// tipoOrigem.toUpperCase() + "' and codOrigem = '" +
		// String.valueOf(codigoOrigem) + "' ORDER BY dataVencimento";
		// if (unidadeEnsino.intValue() != 0) {
		// sqlStr = "SELECT * FROM ContaReceber WHERE upper( tipoOrigem ) = '" +
		// tipoOrigem.toUpperCase() + "' and codOrigem = '" +
		// String.valueOf(codigoOrigem) + "' and unidadeEnsino =" +
		// unidadeEnsino.intValue() + " ORDER BY contaReceber.dataVencimento";
		// }
		// SqlRowSet tabelaResultado =
		// getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		// return (montarDadosConsulta(tabelaResultado, nivelMontarDados,
		// configuracaoFinanceiroVO, usuario));
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorTipoOrigem(java.lang.String, java.lang.Integer, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorTipoOrigem(java.lang.String, java.lang.Integer, java.lang.Integer, boolean, int)
	 */
	public List consultarPorTipoOrigem(String tipoOrigem, Integer codigoOrigem, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM ContaReceber WHERE upper( tipoOrigem ) = '" + tipoOrigem.toUpperCase() + "' and codOrigem = '" + String.valueOf(codigoOrigem) + "' ORDER BY dataVencimento";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr = "SELECT * FROM ContaReceber WHERE upper( tipoOrigem ) = '" + tipoOrigem.toUpperCase() + "' and codOrigem = '" + String.valueOf(codigoOrigem) + "' and unidadeEnsino =" + unidadeEnsino.intValue() + " ORDER BY contaReceber.dataVencimento";
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorNrDocumentoSituacaoPessoa(java.lang.String , java.lang.Integer, java.lang.String, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorNrDocumentoSituacaoPessoa(java.lang.String , java.lang.Integer, java.lang.String, java.lang.Integer, boolean, int)
	 */
	@SuppressWarnings("rawtypes")
	@Override
	public List consultarPorNrDocumentoSituacaoPessoa(TipoPessoa tipoPessoa, String valorConsulta, Integer pessoa, Integer parceiro, Integer fornecedor, String matricula, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder("");
		try {
			sqlStr.append(getSQLPadraoConsultaBasica());
			sqlStr.append(" WHERE ContaReceber.nrDocumento  ilike(?) ");

			sqlStr.append("and ContaReceber.situacao = 'AR' ");
			if (tipoPessoa.equals(TipoPessoa.ALUNO)) {
				sqlStr.append(" and ContaReceber.matriculaaluno = '").append(matricula).append("' ");
			}
			if (tipoPessoa.equals(TipoPessoa.FORNECEDOR) && fornecedor != 0) {
				sqlStr.append("and ContaReceber.fornecedor = ").append(fornecedor.intValue()).append(" ");
			}
			if (tipoPessoa.equals(TipoPessoa.PARCEIRO) && parceiro != 0) {
				sqlStr.append("and ContaReceber.parceiro = ").append(parceiro.intValue()).append(" ");
				if (pessoa != 0) {
					sqlStr.append("and (PessoaMatricula.codigo = ").append(pessoa.intValue()).append(") ");
				}
			}
			if (pessoa != 0 && (tipoPessoa.equals(TipoPessoa.ALUNO) || tipoPessoa.equals(TipoPessoa.FUNCIONARIO) || tipoPessoa.equals(TipoPessoa.PROFESSOR))) {
				sqlStr.append("and ContaReceber.pessoa = ").append(pessoa.intValue()).append(" ");
			}
			if (pessoa != 0 && tipoPessoa.equals(TipoPessoa.RESPONSAVEL_FINANCEIRO)) {
				sqlStr.append("and ContaReceber.responsavelFinanceiro = ").append(pessoa.intValue()).append(" ");
			}
			if (situacao.equals("AV")) {
				sqlStr.append("and (ContaReceber.dataVencimento >= '").append(Uteis.getDataJDBC(new Date())).append("') ");
			}
			if (situacao.equals("VE")) {
				sqlStr.append("and (dataVencimento <= '").append(Uteis.getDataJDBC(new Date())).append("') ");
			}
			if (unidadeEnsino.intValue() != 0) {
				sqlStr.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino.intValue()).append(" ");
			}
			if (Uteis.isAtributoPreenchido(usuario.getUnidadeEnsinoLogado())) {
				sqlStr.append(" and ContaReceber.unidadeensino = ").append(usuario.getUnidadeEnsinoLogado().getCodigo());
			}
			sqlStr.append("ORDER BY ContaReceber.dataVencimento ");
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), valorConsulta +"%");
			List<ContaReceberVO> listaConsulta = (montarDadosConsultaBasica(tabelaResultado));
			montarDadosPlanoDescontoContaReceber(listaConsulta, configuracaoFinanceiroVO, usuario);
			return listaConsulta;
		} finally {
			sqlStr = null;
		}
	}

	public List consultarPorNrDocumentoPessoa(String valorConsulta, Integer pessoa, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM ContaReceber WHERE  nrDocumento  ilike('" + valorConsulta + "%') " + " and pessoa = " + pessoa.intValue() + "";
		if (situacao.equals("AV")) {
			sqlStr += " and (dataVencimento >= '" + Uteis.getDataJDBC(new Date()) + "')";
		}
		if (situacao.equals("VE")) {
			sqlStr += " and (dataVencimento <= '" + Uteis.getDataJDBC(new Date()) + "')";
		}
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " and unidadeEnsino = " + unidadeEnsino.intValue() + " ";
		}
		sqlStr += " ORDER BY dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorCodigoBarra(java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorCodigoBarra(java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	public List<ContaReceberVO> consultarPorCodigoBarra(String valorConsulta, Date dataIni, Date dataFim, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM ContaReceber WHERE upper( codigobarra ) like('" + valorConsulta.toUpperCase() + "%')";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " and unidadeEnsino = " + unidadeEnsino.intValue();
		}
		sqlStr += " AND dataVencimento between '" + Uteis.getDataJDBC(dataIni) + "' AND '" + Uteis.getDataJDBC(dataFim) + "' ";
		if ((!situacao.equals("")) && (!situacao.equals("TO"))) {
			sqlStr += "and upper(contareceber.situacao) like('" + situacao + "%') ";
		}
		sqlStr += " ORDER BY codigobarra";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	@Override
	public List<ContaReceberVO> consultaRapidaPorCodigoBarra(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append("WHERE (UPPER(contareceber.codigobarra) LIKE UPPER(?))");
		if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" AND (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append("))");
		}

		sql.append("ORDER BY contareceber.codigobarra");
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		return montarDadosConsultaBasica(resultado);
	}

	public List<ContaReceberVO> consultaRapidaContaReceberSemCodigoBarra() throws Exception {
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append("WHERE contareceber.codigobarra is null ");
		sql.append(" and contareceber.situacao = 'AR' ");
		sql.append(" and contareceber.matriculaAluno is not null ");
		sql.append("ORDER BY contareceber.codigo");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorCodigoBarraTotalRegistros(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append("WHERE contareceber.codigobarra LIKE UPPER(?) ");

		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	@Override
	public List<ContaReceberVO> consultaRapidaPorNossoNumero(String valorConsulta, Date dataIni, Date dataFim, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append("WHERE contareceber.nossoNumero ilike '").append(valorConsulta).append("' AND ");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("(contareceber.unidadeensinofinanceira = ").append(unidadeEnsino).append(") AND ");
		}
		if ((!situacao.equals("")) && (!situacao.equals("TO"))) {
			sql.append("(UPPER(contareceber.situacao) LIKE '").append(situacao).append("%') AND ");
		}
		sql.append("(contareceber.datavencimento BETWEEN '").append(Uteis.getDataJDBC(dataIni)).append("' AND '").append(Uteis.getDataJDBC(dataFim)).append("') ");
		sql.append("ORDER BY contareceber.codigobarra");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public List<ContaReceberVO> consultaRapidaPorNossoNumero(String valorConsulta, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE contareceber.nossoNumero ilike ?");
		if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" AND (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append("))");
		}

		sql.append(" ORDER BY contareceber.nossoNumero");
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorNossoNumeroTotalRegistros(String valorConsulta, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append(" WHERE contareceber.nossoNumero ilike ?");

		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorCodigoBarraSituacaoPessoa(java.lang.String , java.lang.Integer, java.lang.String, java.lang.Integer, boolean, int)
	 */
	@SuppressWarnings("rawtypes")
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorCodigoBarraSituacaoPessoa(java.lang.String , java.lang.Integer, java.lang.String, java.lang.Integer, boolean, int)
	 */
	@Override
	public List consultarPorCodigoBarraSituacaoPessoa(TipoPessoa tipoPessoa, String valorConsulta, Integer pessoa, Integer parceiro, Integer fornecedor, String matricula, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder("");
		try {
			sqlStr.append(getSQLPadraoConsultaBasica());
			sqlStr.append(" WHERE upper( ContaReceber.codigobarra ) like(?) ");
			sqlStr.append("and ContaReceber.situacao = 'AR' ");
			if (tipoPessoa.equals(TipoPessoa.ALUNO)) {
				sqlStr.append(" and ContaReceber.matriculaaluno = '").append(matricula).append("' ");
			}
			if (tipoPessoa.equals(TipoPessoa.FORNECEDOR) && fornecedor != 0) {
				sqlStr.append("and ContaReceber.fornecedor = ").append(fornecedor.intValue()).append(" ");
			}
			if (tipoPessoa.equals(TipoPessoa.PARCEIRO) && parceiro != 0) {
				sqlStr.append("and ContaReceber.parceiro = ").append(parceiro.intValue()).append(" ");
				if (pessoa > 0) {
					sqlStr.append("and (PessoaMatricula.codigo = ").append(pessoa.intValue()).append(") ");
				}
			}
			if (pessoa != 0 && (tipoPessoa.equals(TipoPessoa.ALUNO) || tipoPessoa.equals(TipoPessoa.FUNCIONARIO) || tipoPessoa.equals(TipoPessoa.PROFESSOR))) {
				sqlStr.append("and ContaReceber.pessoa = ").append(pessoa.intValue()).append(" ");
			}
			if (pessoa != 0 && tipoPessoa.equals(TipoPessoa.RESPONSAVEL_FINANCEIRO)) {
				sqlStr.append("and ContaReceber.responsavelFinanceiro = ").append(pessoa.intValue()).append(" ");
			}
			if (situacao.equals("AV")) {
				sqlStr.append("and (ContaReceber.dataVencimento >= '").append(Uteis.getDataJDBC(new Date())).append("') ");
			}
			if (situacao.equals("VE")) {
				sqlStr.append("and (ContaReceber.dataVencimento <= '").append(Uteis.getDataJDBC(new Date())).append("') ");
			}
			if (unidadeEnsino.intValue() != 0) {
				sqlStr.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino.intValue()).append(" ");
			}
			if (Uteis.isAtributoPreenchido(usuario.getUnidadeEnsinoLogado())) {
				sqlStr.append(" and ContaReceber.unidadeensino = ").append(usuario.getUnidadeEnsinoLogado().getCodigo());
			}
			sqlStr.append("ORDER BY ContaReceber.codigobarra ");
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), valorConsulta.toUpperCase() + "%");
			List<ContaReceberVO> listaConsulta = (montarDadosConsultaBasica(tabelaResultado));
			montarDadosPlanoDescontoContaReceber(listaConsulta, configuracaoFinanceiroVO, usuario);
			return listaConsulta;
		} finally {
			sqlStr = null;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorCandidato(java.lang.String, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorCandidato(java.lang.String, java.lang.Integer, boolean, int)
	 */
	public List consultarPorCandidato(String valorConsulta, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM ContaReceber, Pessoa WHERE (contareceber.candidato = pessoa.codigo) and upper( pessoa.cpf ) like('" + valorConsulta.toUpperCase() + "%') ORDER BY contaReceber.candidato";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr = "SELECT * FROM ContaReceber, Pessoa WHERE (contareceber.candidato = pessoa.codigo) and upper( pessoa.cpf ) like('" + valorConsulta.toUpperCase() + "%') and ContaReceber.unidadeensinofinanceira = " + unidadeEnsino.intValue() + " ORDER BY contaReceber.candidato";
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#consultarPorCPF (java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#consultarPorCPF (java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	public List consultarPorCPF(String valorConsulta, Date dataIni, Date dataFim, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), true, usuario);
		String sqlStr = "SELECT * FROM ContaReceber, Pessoa WHERE (contareceber.pessoa = pessoa.codigo) and upper( pessoa.cpf ) like('" + valorConsulta.toUpperCase() + "%')";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr = "SELECT * FROM ContaReceber, Pessoa WHERE (contareceber.pessoa = pessoa.codigo) and upper( pessoa.cpf ) like('" + valorConsulta.toUpperCase() + "%') and ContaReceber.unidadeensinofinanceira = " + unidadeEnsino.intValue();
		}
		sqlStr += " AND dataVencimento >= '" + Uteis.getDataJDBC(dataIni) + "' ";
		sqlStr += " AND dataVencimento <= '" + Uteis.getDataJDBC(dataFim) + "' ";
		if ((!situacao.equals("")) && (!situacao.equals("TO"))) {
			sqlStr += "and upper(contareceber.situacao) like('" + situacao + "%') ";
		}
		sqlStr += " ORDER BY contaReceber.dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	@SuppressWarnings("static-access")
	@Override
	public List<ContaReceberVO> consultaRapidaPorCPF(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE (UPPER(replace(replace((pessoa.cpf),'.',''),'-','')) LIKE UPPER(replace(replace((?),'.',''),'-','')) OR UPPER(replace(replace((responsavelFinanceiro.cpf),'.',''),'-','')) LIKE UPPER(replace(replace((?),'.',''),'-',''))) AND");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("   (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND");
		}if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")) AND");
		}

		if (!consDataCompetencia) {
			sql.append("       (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("       (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sql.append("ORDER BY pessoa.cpf, contareceber.datavencimento, contareceber.datacompetencia ");
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%", valorConsulta + "%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorCPFTotalRegistros(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append(" WHERE (UPPER(replace(replace((pessoa.cpf),'.',''),'-','')) LIKE UPPER(replace(replace((?),'.',''),'-','')) OR UPPER(replace(replace((responsavelFinanceiro.cpf),'.',''),'-','')) LIKE UPPER(replace(replace((?),'.',''),'-',''))) AND");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("(contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND ");
		}

		if (!consDataCompetencia) {
			sql.append("(contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("(contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%", valorConsulta + "%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#consultarPorAluno (java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#consultarPorAluno (java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	public List consultarPorAluno(String valorConsulta, Date dataIni, Date dataFim, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM ContaReceber, Matricula " + "WHERE (contareceber.matriculaaluno = matricula.matricula) " + "and upper( matricula.matricula ) like('" + valorConsulta.toUpperCase() + "%')";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " and ContaReceber.unidadeensinofinanceira = " + unidadeEnsino.intValue();
		}
		sqlStr += " AND dataVencimento between '" + Uteis.getDataJDBC(dataIni) + "' and '" + Uteis.getDataJDBC(dataFim) + "' ";
		if ((!situacao.equals("")) && (!situacao.equals("TO"))) {
			sqlStr += "and upper(contareceber.situacao) like('" + situacao + "%') ";
		}

		sqlStr += " ORDER BY contaReceber.matriculaaluno, contaReceber.dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	@SuppressWarnings("static-access")
	public List<ContaReceberVO> consultaRapidaPorAluno(String valorConsulta, Date dataIni, Date dataFim, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE ((matricula.matricula) iLIKE ('").append(valorConsulta).append("%')) ");
		if (unidadeEnsino.intValue() != 0) {
			sql.append(" AND  (contareceber.unidadeensinofinanceira = ").append(unidadeEnsino).append(") ");
		}
		if ((!situacao.equals("")) && (!situacao.equals("TO"))) {
			sql.append(" AND  (UPPER(contareceber.situacao) LIKE '").append(situacao).append("%') ");
		}
		if ((dataIni != null) && (dataFim != null)) {
			sql.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		sql.append("ORDER BY contareceber.matriculaaluno, contareceber.datavencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(resultado);
	}

	@SuppressWarnings("static-access")
	@Override
	public List<ContaReceberVO> consultaRapidaPorAlunoLimiteOffset(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO,List<String>ordenador) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE ((matricula.matricula) iLIKE (?)) AND");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("   (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")) AND");
		}

		if (!consDataCompetencia) {
			sql.append("       (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("       (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		if(Uteis.isAtributoPreenchido(ordenador)) {
			sql.append(" ORDER BY ").append(UteisTexto.converteListaStringParaString(ordenador));
		}else {
			sql.append("ORDER BY contareceber.matriculaaluno, contareceber.datavencimento, contareceber.datacompetencia ");	
		}
		
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorAlunoTotalRegistros(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		
		sql.append("WHERE ((matricula.matricula) iLIKE (?)) AND ");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("(contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND ");
		}

		if (!consDataCompetencia) {
			sql.append("(contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("(contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta);
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	@SuppressWarnings("static-access")
	@Override
	public List<ContaReceberVO> consultaRapidaPorResponsavelFinanceiroLimiteOffset(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, List<String> ordenador) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE (sem_acentos((responsavelFinanceiro.nome)) iLIKE sem_acentos((?))) AND");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("   (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")) AND");
		}

		if (!consDataCompetencia) {
			sql.append("       (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("       (contareceber.dataCompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		if (Uteis.isAtributoPreenchido(ordenador)) {
			sql.append("ORDER BY ").append(UteisTexto.converteListaStringParaString(ordenador));
		} else {
			sql.append(
					"ORDER BY contareceber.matriculaaluno, contareceber.datavencimento, contareceber.datacompetencia ");
		}
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorResponsavelFinanceiroTotalRegistros(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append(" WHERE (sem_acentos((responsavelFinanceiro.nome)) iLIKE sem_acentos((?))) AND");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("(contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND ");
		}

		if (!consDataCompetencia) {
			sql.append("(contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("(contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	@SuppressWarnings("static-access")
	@Override
	public List<ContaReceberVO> consultaRapidaPorFornecedorLimiteOffset(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, List<String> ordenador) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE (sem_acentos((fornecedor.nome)) iLIKE sem_acentos((?))) AND");
		sql.append("  contareceber.tipoPessoa = 'FO' AND");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("   (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")) AND");
		}

		if (!consDataCompetencia) {
			sql.append("       (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("       (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		if (Uteis.isAtributoPreenchido(ordenador)) {
			sql.append("ORDER BY ").append(UteisTexto.converteListaStringParaString(ordenador));
		} else {
			sql.append("ORDER BY fornecedor.nome, contareceber.datavencimento, contareceber.datacompetencia ");
		}
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorFornecedorTotalRegistros(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append(" WHERE (sem_acentos((fornecedor.nome)) iLIKE sem_acentos((?))) AND");
		sql.append("  contareceber.tipoPessoa = 'FO' AND");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("(contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND ");
		}

		if (!consDataCompetencia) {
			sql.append("(contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("(contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorDataSituacaoPessoa(java.util.Date, java.lang.Integer, java.lang.String, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorDataSituacaoPessoa(java.util.Date, java.lang.Integer, java.lang.String, java.lang.Integer, boolean, int)
	 */
	@SuppressWarnings("rawtypes")
	@Override
	public List consultarPorDataSituacaoPessoa(TipoPessoa tipoPessoa, Date prmIni, Integer pessoa, Integer parceiro, Integer fornecedor, String matricula, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder("");
		try {
			sqlStr.append(getSQLPadraoConsultaBasica());
			sqlStr.append(" WHERE ContaReceber.situacao = 'AR' ");
			if (tipoPessoa.equals(TipoPessoa.ALUNO)) {
				sqlStr.append(" and ContaReceber.matriculaaluno = '").append(matricula).append("' ");
			}
			if (tipoPessoa.equals(TipoPessoa.PARCEIRO) && parceiro != 0) {
				sqlStr.append("and ContaReceber.parceiro = ").append(parceiro.intValue()).append(" ");
				if (pessoa > 0) {
					sqlStr.append("and (PessoaMatricula.codigo = ").append(pessoa.intValue()).append(") ");
				}
			}
			if (tipoPessoa.equals(TipoPessoa.FORNECEDOR) && fornecedor != 0) {
				sqlStr.append("and ContaReceber.fornecedor = ").append(fornecedor.intValue()).append(" ");
			}
			if (pessoa != 0 && (tipoPessoa.equals(TipoPessoa.ALUNO) || tipoPessoa.equals(TipoPessoa.FUNCIONARIO) || tipoPessoa.equals(TipoPessoa.PROFESSOR))) {
				sqlStr.append("and ContaReceber.pessoa = ").append(pessoa.intValue()).append(" ");
			}
			if (pessoa != 0 && tipoPessoa.equals(TipoPessoa.RESPONSAVEL_FINANCEIRO)) {
				sqlStr.append("and ContaReceber.responsavelFinanceiro = ").append(pessoa.intValue()).append(" ");
			}
			if (situacao.equals("AV")) {
				sqlStr.append(" and (ContaReceber.dataVencimento >= '").append(Uteis.getDataJDBC(prmIni)).append("') ");
			} else if (situacao.equals("VE")) {
				sqlStr.append("and (ContaReceber.dataVencimento <= '").append(Uteis.getDataJDBC(prmIni)).append("') ");
			} else {
				sqlStr.append("and (ContaReceber.dataVencimento = '").append(Uteis.getDataJDBC(prmIni)).append("') ");
			}
			if (unidadeEnsino.intValue() != 0) {
				sqlStr.append(" and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino.intValue()).append(" ");
			}
			if (Uteis.isAtributoPreenchido(usuario.getUnidadeEnsinoLogado())) {
				sqlStr.append(" and ContaReceber.unidadeensino = ").append(usuario.getUnidadeEnsinoLogado().getCodigo());
			}
			sqlStr.append(" order by ContaReceber.dataVencimento");
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			List<ContaReceberVO> listaConsulta = (montarDadosConsultaBasica(tabelaResultado));
			montarDadosPlanoDescontoContaReceber(listaConsulta, configuracaoFinanceiroVO, usuario);
			return listaConsulta;
		} finally {
			sqlStr = null;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorFuncionario(java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorFuncionario(java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	public List consultarPorFuncionario(String valorConsulta, Date dataIni, Date dataFim, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM ContaReceber, Funcionario WHERE (contareceber.funcionario = funcionario.codigo) and lower( funcionario.matricula ) like('" + valorConsulta.toLowerCase() + "%')";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr = "SELECT * FROM ContaReceber, Funcionario WHERE (contareceber.funcionario = funcionario.codigo) and lower( funcionario.matricula ) like('" + valorConsulta.toLowerCase() + "%') and ContaReceber.unidadeensinofinanceira = " + unidadeEnsino.intValue();
		}
		sqlStr += " AND dataVencimento between '" + Uteis.getDataJDBC(dataIni) + "' AND '" + Uteis.getDataJDBC(dataFim) + "' ";
		if ((!situacao.equals("")) && (!situacao.equals("TO"))) {
			sqlStr += "and upper(contareceber.situacao) like('" + situacao + "%') ";
		}
		sqlStr += " ORDER BY funcionario.matricula";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	@SuppressWarnings("static-access")
	@Override
	public List<ContaReceberVO> consultaRapidaPorFuncionario(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, List<String> ordenador) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE (sem_acentos(funcionario.matricula) iLIKE sem_acentos(?)) AND");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("   (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")) AND");
		}

		if (!consDataCompetencia) {
			sql.append("       (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("       (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		if (Uteis.isAtributoPreenchido(ordenador)) {
			sql.append("ORDER BY ").append(UteisTexto.converteListaStringParaString(ordenador));
		} else {
			sql.append("ORDER BY funcionario.matricula, contareceber.datavencimento, contareceber.datacompetencia ");
		}
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorFuncionarioToalRegistros(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append("WHERE (sem_acentos(funcionario.matricula) iLIKE sem_acentos(?)) AND ");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("(contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND ");
		}

		if (!consDataCompetencia) {
			sql.append("(contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("(contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta + "%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorConvenio(java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorConvenio(java.lang.String, java.util.Date, java.util.Date, java.lang.String, java.lang.Integer, boolean, int)
	 */
	public List consultarPorConvenio(String valorConsulta, Date dataIni, Date dataFim, String situacao, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM ContaReceber, Convenio WHERE (contareceber.convenio = convenio.codigo) and upper( convenio.descricao ) like('%" + valorConsulta.toUpperCase() + "%') ";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr = "SELECT * FROM ContaReceber, Convenio WHERE (contareceber.convenio = convenio.codigo) and upper( convenio.descricao ) like('%" + valorConsulta.toUpperCase() + "%') and ContaReceber.unidadeensinofinanceira = " + unidadeEnsino.intValue() + " ";
		}
		if (dataFim != null && dataIni != null) {
			sqlStr += " AND dataVencimento between '" + Uteis.getDataJDBC(dataIni) + "' AND '" + Uteis.getDataJDBC(dataFim) + "' ";
		}
		if ((!situacao.equals("")) && (!situacao.equals("TO"))) {
			sqlStr += "and upper(contareceber.situacao) like('" + situacao + "%') ";
		}
		sqlStr += " ORDER BY contaReceber.convenio";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	@SuppressWarnings("static-access")
	@Override
	public List<ContaReceberVO> consultaRapidaPorConvenio(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, List<String> ordenador) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE sem_acentos (convenio.descricao) ILIKE sem_acentos(?) AND");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("   (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")) AND");
		}

		if (!consDataCompetencia) {
			sql.append("       (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("       (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		if (Uteis.isAtributoPreenchido(ordenador)) {
			sql.append("ORDER BY ").append(UteisTexto.converteListaStringParaString(ordenador));
		} else {
			sql.append(
					"ORDER BY contareceber.convenio, contareceber.matriculaaluno, contareceber.datavencimento, contareceber.datacompetencia ");
		}
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), Uteis.removerAcentos(valorConsulta) + "%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorConvenioTotalRegistros(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append(" WHERE sem_acentos (convenio.descricao) ILIKE sem_acentos(?) AND ");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("   (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND");
		}

		if (!consDataCompetencia) {
			sql.append("       (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("       (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(),  Uteis.removerAcentos(valorConsulta) + "%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorTipoEUnidadeEnsino(java.lang.String, java.lang.Integer, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorTipoEUnidadeEnsino(java.lang.String, java.lang.Integer, java.lang.Integer, boolean, int)
	 */
	public List consultarPorTipoEUnidadeEnsino(String valorConsulta, Integer pessoa, Integer unidadeEnsino, String tipoOrigem, List<String> listaTipoOrigemContaCaixa, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {

		String sqlStr = getSQLPadraoConsultaBasica().toString();
		sqlStr += " WHERE (( ContaReceber.pessoa ) = (" + pessoa + ") or (ContaReceber.responsavelFinanceiro) = (" + pessoa + "))";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " AND ContaReceber.unidadeEnsinoFinanceira  = (" + unidadeEnsino + ") ";
		}
		if (valorConsulta.equalsIgnoreCase("VE")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' AND ContaReceber.dataVencimento <= '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (valorConsulta.equalsIgnoreCase("AV")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' AND ContaReceber.dataVencimento > '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (valorConsulta.equalsIgnoreCase("PG")) {
			sqlStr += "AND ContaReceber.situacao = 'RE' ";
		}
		if (valorConsulta.equalsIgnoreCase("NE")) {
			sqlStr += "AND ContaReceber.situacao = 'NE' ";
		}
		if (!tipoOrigem.equals("")) {
			sqlStr += " and tipoorigem = '" + tipoOrigem + "' ";
		}
		if (!listaTipoOrigemContaCaixa.isEmpty()) {
			boolean virgula = false;
			sqlStr += " AND tipoorigem IN(";

			for (String tipoOrigemPermitida : listaTipoOrigemContaCaixa) {
				if (!virgula) {
					sqlStr += "'" + tipoOrigemPermitida + "'";
				} else {
					sqlStr += ", '" + tipoOrigemPermitida + "'";

				}
				virgula = true;
			}

			sqlStr += ") ";
		}
		sqlStr += "ORDER BY ContaReceber.dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List<ContaReceberVO> listaConsulta = (montarDadosConsultaBasica(tabelaResultado));
		montarDadosPlanoDescontoContaReceber(listaConsulta, configuracaoFinanceiroVO, usuario);
		return listaConsulta;
	}

	@Override
	public List<ContaReceberVO> consultarPorTipoUnidadeEnsinoMatricula(String valorConsulta, Integer aluno, String matricula, Integer unidadeEnsino, String tipoOrigem, List<String> listaTipoOrigemContaCaixa, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {

		String sqlStr = getSQLPadraoConsultaBasica().toString();
		if (aluno != null && aluno > 0) {
			sqlStr += " WHERE (( ContaReceber.pessoa ) = ('" + aluno + "'))";
		} else {
			sqlStr += " WHERE (( ContaReceber.matriculaaluno ) = ('" + matricula + "'))";
		}
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " AND ContaReceber.unidadeEnsinoFinanceira  = (" + unidadeEnsino + ") ";
		}
		if (valorConsulta.equalsIgnoreCase("VE")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' AND ContaReceber.dataVencimento <= '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (valorConsulta.equalsIgnoreCase("AV")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' AND ContaReceber.dataVencimento > '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (valorConsulta.equalsIgnoreCase("PG")) {
			sqlStr += "AND ContaReceber.situacao = 'RE' ";
		}
		if (valorConsulta.equalsIgnoreCase("NE")) {
			sqlStr += "AND ContaReceber.situacao = 'NE' ";
		}
		if (!tipoOrigem.equals("")) {
			sqlStr += " and tipoorigem = '" + tipoOrigem + "' ";
		}
		if (!listaTipoOrigemContaCaixa.isEmpty()) {
			boolean virgula = false;
			sqlStr += " AND tipoorigem IN(";

			for (String tipoOrigemPermitida : listaTipoOrigemContaCaixa) {
				if (!virgula) {
					sqlStr += "'" + tipoOrigemPermitida + "'";
				} else {
					sqlStr += ", '" + tipoOrigemPermitida + "'";

				}
				virgula = true;
			}

			sqlStr += ") ";
		}
		sqlStr += " ORDER BY ContaReceber.dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List<ContaReceberVO> listaConsulta = (montarDadosConsultaBasica(tabelaResultado));
		montarDadosPlanoDescontoContaReceber(listaConsulta, configuracaoFinanceiroVO, usuario);
		return listaConsulta;
	}

	@Override
	public List<ContaReceberVO> consultarPorTipoUnidadeEnsinoFornecedor(String valorConsulta, Integer fornecedor, Integer unidadeEnsino, String tipoOrigem, List<String> listaTipoOrigemContaCaixa, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {

		String sqlStr = getSQLPadraoConsultaBasica().toString();

		sqlStr += " WHERE (( ContaReceber.fornecedor ) = ('" + fornecedor + "'))";

		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " AND ContaReceber.unidadeEnsinoFinanceira  = (" + unidadeEnsino + ") ";
		}
		if (valorConsulta.equalsIgnoreCase("VE")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' AND ContaReceber.dataVencimento <= '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (valorConsulta.equalsIgnoreCase("AV")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' AND ContaReceber.dataVencimento > '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (valorConsulta.equalsIgnoreCase("PG")) {
			sqlStr += "AND ContaReceber.situacao = 'RE' ";
		}
		if (valorConsulta.equalsIgnoreCase("NE")) {
			sqlStr += "AND ContaReceber.situacao = 'NE' ";
		}
		if (!tipoOrigem.equals("")) {
			sqlStr += " and tipoorigem = '" + tipoOrigem + "' ";
		}
		if (!listaTipoOrigemContaCaixa.isEmpty()) {
			boolean virgula = false;
			sqlStr += " AND tipoorigem IN(";

			for (String tipoOrigemPermitida : listaTipoOrigemContaCaixa) {
				if (!virgula) {
					sqlStr += "'" + tipoOrigemPermitida + "'";
				} else {
					sqlStr += ", '" + tipoOrigemPermitida + "'";

				}
				virgula = true;
			}

			sqlStr += ") ";
		}
		sqlStr += " ORDER BY ContaReceber.dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List<ContaReceberVO> listaConsulta = (montarDadosConsultaBasica(tabelaResultado));
		montarDadosPlanoDescontoContaReceber(listaConsulta, configuracaoFinanceiroVO, usuario);
		return listaConsulta;
	}

	public List<ContaReceberVO> consultarPorTipoCursoEUnidadeEnsino(String valorConsulta, Integer pessoa, Integer curso, Integer unidadeEnsino, List<String> listaTipoOrigemDesconsiderar, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario, Integer limite, Integer offset, DataModelo dataModelo ,boolean permiteVisualizarParcelasPeriodoContratosEletronico , boolean permitePagamentoParcelasPeriodoContratosEletronico , List<Integer> matriculaPeriodosContratosPendenteRejeitado) throws Exception {	StringBuilder sqlStr = new StringBuilder("SELECT ");
		realizarAdicaoTotalizadoresContaReceber(sqlStr);
		sqlStr.append(" ContaReceber.*  FROM ContaReceber ");
		sqlStr.append("LEFT JOIN matriculaPeriodo ON matriculaPeriodo.codigo = contareceber.matriculaperiodo ");
		sqlStr.append("LEFT JOIN matricula ON matricula.matricula = matriculaperiodo.matricula ");
		sqlStr.append("LEFT JOIN parceiro as parceiro on (parceiro.codigo = contareceber.parceiro)");
		sqlStr.append("WHERE pessoa = ").append(pessoa);
		if (Uteis.isAtributoPreenchido(curso)) {
			sqlStr.append(" AND CASE WHEN (matricula.matricula is not null AND matricula.matricula != '') THEN curso = ").append(curso).append(" ELSE true END");
		}
		if (Uteis.isAtributoPreenchido(unidadeEnsino)) {
			sqlStr.append(" and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		if (valorConsulta.equalsIgnoreCase("EM")) {
			sqlStr.append(" AND ContaReceber.situacao = 'AR'");
			if (!configuracaoFinanceiroVO.getPermitiVisualizarContaReceberVisaoAlunoPreMatricula()) {
				sqlStr.append(" AND CASE WHEN matriculaperiodo.codigo is not null THEN MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ELSE true END");
			}
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		if (valorConsulta.equalsIgnoreCase("MA")) {
			sqlStr.append(" AND ContaReceber.situacao = 'AR'");
			sqlStr.append(" AND contareceber.datavencimento >= '").append(Uteis.getDataJDBC(Uteis.getDataPrimeiroDiaMes(new Date()))).append("' and contareceber.datavencimento <= '").append(Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(new Date()))).append("'");
		}
		if (valorConsulta.equalsIgnoreCase("VE")) {
			sqlStr.append(" AND ContaReceber.situacao = 'AR' AND dataVencimento <= '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("'");
		}
		if (valorConsulta.equalsIgnoreCase("AV")) {
			sqlStr.append(" AND ContaReceber.situacao = 'AR' AND dataVencimento > '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("'");
		}
		if (valorConsulta.equalsIgnoreCase("PG")) {
			sqlStr.append(" AND ContaReceber.situacao = 'RE'");
		}
		if (valorConsulta.equalsIgnoreCase("NE")) {
			sqlStr.append(" AND ContaReceber.situacao = 'NE'");
		}
		if (valorConsulta.equalsIgnoreCase("MB")) {
			sqlStr.append(" AND ((ContaReceber.situacao = 'AR'");
			if (!configuracaoFinanceiroVO.getPermitiVisualizarContaReceberVisaoAlunoPreMatricula()) {
				sqlStr.append(" AND CASE WHEN matriculaperiodo.codigo is not null THEN MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ELSE true END");
			}
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
			sqlStr.append(" ) ");
			sqlStr.append(" or (ContaReceber.situacao = 'RE'))");
		}
		if (valorConsulta.equalsIgnoreCase("TO")) {
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		if (Uteis.isAtributoPreenchido(listaTipoOrigemDesconsiderar)) {
			sqlStr.append(listaTipoOrigemDesconsiderar.stream().collect(Collectors.joining("', '", " AND contareceber.tipoorigem not in ('", "') ")));
		}
		if (valorConsulta.equalsIgnoreCase("MB")) {
		sqlStr.append(" order by");
		sqlStr.append(" case when ContaReceber.situacao = 'AR' then 0");
		sqlStr.append(" else 1 end, contareceber.datavencimento ");
		} else {
			sqlStr.append(" ORDER BY dataVencimento");			
		}
		if (limite != null && offset != null) {
			sqlStr.append(" limit ").append(limite.intValue());
			sqlStr.append(" offset ").append(offset.intValue());
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		realizarMontagemTotalizadoresContaReceber(tabelaResultado, dataModelo);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List<ContaReceberVO> consultaRapidaPorCursoEUnidadeEnsinoSituacao(Integer pessoa, String situacao, Integer curso, Integer unidadeEnsino, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE contareceber.pessoa = ");
		sqlStr.append(pessoa);
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append(" AND unidadeEnsino.codigo = ");
			sqlStr.append(unidadeEnsino);
		}
		if (curso != null && curso != 0) {
			sqlStr.append(" AND matricula.curso = ");
			sqlStr.append(curso);
		}
		if (situacao.equals("VE")) {
			sqlStr.append(" AND contareceber.situacao <> 'RE' AND dataVencimento <= '");
			sqlStr.append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)));
			sqlStr.append("' ");
		}
		if (situacao.equals("PG")) {
			sqlStr.append(" AND contareceber.situacao = 'RE' ");
		}
		sqlStr.append(" ORDER BY contareceber.dataVencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}
	
	public List<ContaReceberVO> consultarPorCursoTurmaMatriculaSituacaoDataVencimento(String matricula, Integer turma, Integer curso, Integer unidadeEnsino, Integer unidadeEnsinoAcademica, String situacao, Date dataIni, Date dataFim, Integer contaCorrenteDestino, boolean regerarCarteiraContaCorrenteDestino, Integer contaCorrenteOrigem, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO,  boolean trazerContasRegistradas, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder(getSQLPadraoConsultaBasica());
		// StringBuilder sqlStr = new
		// StringBuilder("SELECT distinct contaReceber.codigo, contaReceber.* FROM ContaReceber ");
		// sqlStr.append("LEFT JOIN matricula on matricula.matricula = contaReceber.matriculaAluno ");
		sqlStr.append("LEFT JOIN curso on curso.codigo = matricula.curso ");
		sqlStr.append("WHERE 1=1 ");
		if (situacao != null) {
			sqlStr.append("AND contaReceber.situacao = '").append(situacao).append("' ");
		}
		if (unidadeEnsino != null && !unidadeEnsino.equals(0)) {
			sqlStr.append("and ContaReceber.unidadeensinofinanceira  = ").append(unidadeEnsino).append(" ");
		}
		if(Uteis.isAtributoPreenchido(unidadeEnsinoAcademica)) {
			sqlStr.append("and ContaReceber.unidadeensino  = ").append(unidadeEnsinoAcademica).append(" ");
		}
		if(Uteis.isAtributoPreenchido(contaCorrenteDestino) && !regerarCarteiraContaCorrenteDestino) {
			sqlStr.append("and ContaReceber.contaCorrente  != ").append(contaCorrenteDestino).append(" ");
		}
		if (Uteis.isAtributoPreenchido(contaCorrenteOrigem)) {
			sqlStr.append("and ContaReceber.contaCorrente  = ").append(contaCorrenteOrigem).append(" ");
		}
		if (curso != null && !curso.equals(0)) {
			sqlStr.append("AND matricula.curso = ").append(curso).append(" ");
		}
		if (turma != null && !turma.equals(0)) {
			sqlStr.append("AND matricula.matricula IN(SELECT DISTINCT mp.matricula FROM matriculaperiodo mp WHERE mp.turma = ").append(turma).append(") ");
		}
		if (matricula != null && !matricula.equals("")) {
			sqlStr.append("AND matricula.matricula = '").append(matricula).append("' ");
		}
		if (dataIni != null) {
			sqlStr.append("AND contaReceber.dataVencimento >= '").append(Uteis.getDataJDBC(Uteis.getDateTime(dataIni, 0, 0, 0))).append("' ");
		}
		if (dataFim != null) {
			sqlStr.append("AND contaReceber.dataVencimento <= '").append(Uteis.getDataJDBC(Uteis.getDateTime(dataFim, 23, 59, 59))).append("' ");
		}
		sqlStr.append("AND ").append(adicionarFiltroTipoOrigemContaReceber(filtroRelatorioFinanceiroVO, "contaReceber"));		
		if (!trazerContasRegistradas) {
			sqlStr.append(" AND NOT EXISTS(SELECT 1 from controleremessacontareceber WHERE controleremessacontareceber.contareceber = contareceber.codigo) ");
		}
		sqlStr.append("ORDER BY dataVencimento");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
		// return (montarDadosConsulta(tabelaResultado, nivelMontarDados,
		// configuracaoFinanceiroVO, usuario));
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaEUnidadeEnsino(String matricula, String situacao, Integer unidadeEnsino, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE matriculaAluno = '");
		sqlStr.append(matricula);
		sqlStr.append("' ");
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append(" AND unidadeEnsino.codigo = ");
			sqlStr.append(unidadeEnsino);
		}
		if (situacao.equals("EM")) {
			sqlStr.append(" AND contareceber.situacao = 'AR' AND dataVencimento <= '");
			sqlStr.append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)));
			sqlStr.append("' ");
		}
		if (situacao.equals("PG")) {
			sqlStr.append(" AND contareceber.situacao = 'RE' ");
		}
		sqlStr.append(" ORDER BY contareceber.dataVencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaEUnidadeEnsinoVisaoAluno(String matricula, String situacao, Integer unidadeEnsino, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, int nivelMontarDados, UsuarioVO usuario, Integer limite, Integer offset, DataModelo dataModelo) throws Exception {
		// StringBuilder sqlStr = getSQLPadraoConsultaCompleta();

		/*
		 * Regra alterada porque a consulta apresentava mais de um registro para uma conta recebida com mais de uma forma de pagamento, o resultado apresentava em duplicidade por conta da tabela contareceberrecebimento.
		 */
		StringBuilder sqlStr = getSQLPadraoConsultaCompletaSemContaReceberRecebimento();
		sqlStr.append("WHERE matriculaAluno = '");
		sqlStr.append(matricula);
		sqlStr.append("' ");
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append(" AND unidadeEnsino.codigo = ");
			sqlStr.append(unidadeEnsino);
		}
		if (situacao.equals("EM")) {
			sqlStr.append(" AND contareceber.situacao = 'AR' ");
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		} else if (situacao.equals("MA")) {
			sqlStr.append(" AND contareceber.situacao = 'AR' ");
			sqlStr.append(" AND contareceber.datavencimento >= '").append(Uteis.getDataJDBC(Uteis.getDataPrimeiroDiaMes(new Date()))).append("' and contareceber.datavencimento <= '").append(Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(new Date()))).append("'");
		} else if (situacao.equals("PG")) {
			sqlStr.append(" AND contareceber.situacao = 'RE' ");
		} else if (situacao.equals("MB")) {
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		} else if (situacao.equals("TO")) {
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		if (situacao.equals("MB")) {
			sqlStr.append(" order by");
			sqlStr.append(" case when ContaReceber.situacao = 'AR' then 0");
			sqlStr.append(" else 1 end, contareceber.datavencimento ");
		} else {
			sqlStr.append(" ORDER BY contareceber.dataVencimento");
		}
		if (limite != null && offset != null) {
			sqlStr.append(" limit ").append(limite.intValue());
			sqlStr.append(" offset ").append(offset.intValue());
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		realizarMontagemTotalizadoresContaReceber(resultado, dataModelo);
		return montarDadosConsultaCompletaSemRecebimento(resultado, configuracaoFinanceiroVO, nivelMontarDados, usuario);
	}

	public List<ContaReceberVO> montarDadosConsultaCompletaSemRecebimento(SqlRowSet tabelaResultado, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> vetResultado = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			montarDadosCompletoSemRecebimento(obj, tabelaResultado, configuracaoFinanceiroVO, nivelMontarDados, usuario);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorTipoEConvenioEUnidadeEnsino(java.lang. String, java.lang.Integer, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorTipoEConvenioEUnidadeEnsino(java.lang. String, java.lang.Integer, java.lang.Integer, boolean, int)
	 */
	public List consultarPorTipoEConvenioEUnidadeEnsino(String valorConsulta, Integer convenio, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		String sqlStr = "SELECT * FROM ContaReceber WHERE ( convenio ) = (" + convenio + ")";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " AND unidadeEnsino  = (" + unidadeEnsino + ") ";
		}
		if (valorConsulta.equalsIgnoreCase("VE")) {
			sqlStr += "AND situacao = 'AR' AND dataVencimento <= '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (valorConsulta.equalsIgnoreCase("AV")) {
			sqlStr += "AND situacao = 'AR' AND dataVencimento > '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (valorConsulta.equalsIgnoreCase("PG")) {
			sqlStr += "AND situacao = 'RE' ";
		}
		if (valorConsulta.equalsIgnoreCase("NE")) {
			sqlStr += "AND situacao = 'NE' ";
		}
		if (!tipoOrigem.equals("")) {
			sqlStr += " and tipoorigem = '" + tipoOrigem + "' ";
		}
		sqlStr += " ORDER BY dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List<ContaReceberVO> consultarPorTipoEConvenioEUnidadeEnsinoDadosApresentacaoModalNegociacaoRecebimento(String nomeParceiro, String valorConsulta, Integer unidadeEnsino, String tipoOrigem, List<String> listaTipoOrigemContaCaixa, boolean controlarAcesso, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		String sqlStr = "SELECT ContaReceber.codigo, ContaReceber.updated, dataVencimento, tipoorigem, valor, juro, multa, nrdocumento FROM ContaReceber  ";
		sqlStr += " inner join parceiro on parceiro.codigo = contareceber.parceiro ";
		sqlStr += " WHERE upper( Parceiro.nome ) ilike('" + nomeParceiro + "') ";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " AND unidadeEnsinoFinanceira  = (" + unidadeEnsino + ") ";
		}
		if (valorConsulta.equalsIgnoreCase("VE")) {
			sqlStr += "AND situacao = 'AR' AND dataVencimento <= '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (valorConsulta.equalsIgnoreCase("AV")) {
			sqlStr += "AND situacao = 'AR' AND dataVencimento > '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (valorConsulta.equalsIgnoreCase("PG")) {
			sqlStr += "AND situacao = 'RE' ";
		}
		if (valorConsulta.equalsIgnoreCase("NE")) {
			sqlStr += "AND situacao = 'NE' ";
		}
		if (!tipoOrigem.equals("")) {
			sqlStr += " and tipoorigem = '" + tipoOrigem + "' ";
		}
		if (!listaTipoOrigemContaCaixa.isEmpty()) {
			boolean virgula = false;
			sqlStr += " AND tipoorigem IN(";

			for (String tipoOrigemPermitida : listaTipoOrigemContaCaixa) {
				if (!virgula) {
					sqlStr += "'" + tipoOrigemPermitida + "'";
				} else {
					sqlStr += ", '" + tipoOrigemPermitida + "'";

				}
				virgula = true;
			}

			sqlStr += ") ";
		}
		sqlStr += " ORDER BY dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List<ContaReceberVO> listaContaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setUpdated(tabelaResultado.getDate("updated"));
			obj.setDataVencimento(tabelaResultado.getDate("datavencimento"));
			obj.setTipoOrigem(tabelaResultado.getString("tipoorigem"));
			obj.setValor(tabelaResultado.getDouble("valor"));
			obj.setJuro(tabelaResultado.getDouble("juro"));
			obj.setMulta(tabelaResultado.getDouble("multa"));
			obj.setNrDocumento(tabelaResultado.getString("nrDocumento"));
			// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(tabelaResultado.getInt("registrocobrancacontareceber"));
			listaContaReceberVOs.add(obj);
		}
		return listaContaReceberVOs;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorAlunoEMatriculaContasReceberVencidas(java .lang.Integer, java.lang.String, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorAlunoEMatriculaContasReceberVencidas(java .lang.Integer, java.lang.String, int)
	 */
	public List consultarPorAlunoEMatriculaContasReceberVencidas(Integer pessoa, String matricula, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		String sqlStr = "select * from contareceber where pessoa = " + pessoa.toString() + " and tipoorigem in ('MEN', 'MAT', 'REQ', 'BIB') and tipopessoa = 'AL' and matriculaaluno = '" + matricula + "'";
		sqlStr += " and situacao = 'AR' AND dataVencimento < '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		sqlStr += " ORDER BY codigo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	@Override
	public List<ContaReceberVO> consultaRapidaPorAlunoEMatriculaContasReceberVencidas(Integer pessoa, Boolean possuiIntegracaoFinanceira, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sql = new StringBuilder();
		sql.append("select distinct * from (");
		StringBuilder sql2 = getSQLPadraoConsultaBasica();
		sql2.append(" WHERE contareceber.tipoorigem not in ('REQ', 'IPS')  and (contareceber.pessoa = ").append(pessoa.toString()).append(" or contareceber.responsavelfinanceiro in (");
		sql2.append(" select pais from filiacao where aluno = ").append(pessoa.toString()).append(" and responsavelfinanceiro ))");
		sql2.append(" AND ((convenio.codigo is not null and convenio.convenioInadimplenteBloqueaMatricula = true) or (convenio.codigo is null)) AND (contareceber.situacao = 'AR') AND (contareceber.dataVencimento < '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("') ");
		if (possuiIntegracaoFinanceira != null && possuiIntegracaoFinanceira) {
			sql2.append(" AND (contareceber.possuifiesintegracaofinanceiras = false)");
		}
		getSqlValidarInadimplenciaAlunoParcelaParceiroRenovacaoMatricula(sql2);
		sql.append(sql2.toString());
		sql.append(" union ");

		StringBuilder sql3 = getSQLPadraoConsultaBasica();
		sql3.append(" WHERE contareceber.tipoorigem not in ('REQ', 'IPS')  and (contareceber.matriculaaluno IN (select matricula from matricula where aluno =  ").append(pessoa.toString()).append(")) ");
		sql3.append(" AND ((convenio.codigo is not null and convenio.convenioInadimplenteBloqueaMatricula = true) or (convenio.codigo is null)) AND (contareceber.situacao = 'AR') AND (contareceber.dataVencimento < '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("') ");
		if (possuiIntegracaoFinanceira != null && possuiIntegracaoFinanceira) {
			sql3.append(" AND (contareceber.possuifiesintegracaofinanceiras = false)");
		}
		getSqlValidarInadimplenciaAlunoParcelaParceiroRenovacaoMatricula(sql3);
		sql.append(sql3.toString());
		if (possuiIntegracaoFinanceira != null && possuiIntegracaoFinanceira) {
			Date dataCompetenciaMatricula = matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDataCompetenciaMatricula();
			String mesMatricula = Integer.toString(Uteis.getMesData(dataCompetenciaMatricula));
			if (mesMatricula.length() == 1) {
				mesMatricula = "0" + mesMatricula;
			}
			String anoMatricula = Integer.toString(Uteis.getAnoData(dataCompetenciaMatricula));
			String parcelaMatriculaPadraoIntegracao = "MAT_" + mesMatricula + "/" + anoMatricula;
			StringBuilder sql4 = getSQLPadraoConsultaBasica();
			sql4.append(" where matriculaAluno = ");
			sql4.append(" '").append(matriculaPeriodoVO.getMatricula()).append("'");
			sql4.append(" and contareceber.situacao = 'AR' and ");
			sql4.append("(contareceber.parcela = '").append(parcelaMatriculaPadraoIntegracao).append("'");
			sql4.append(" or contareceber.dataCompetencia < '").append(Uteis.getDataJDBC(dataCompetenciaMatricula)).append("'");
			sql4.append(" or possuiPendenciasFinanceirasExternas = true )");
			if (possuiIntegracaoFinanceira != null && possuiIntegracaoFinanceira) {
				sql4.append(" AND (contareceber.possuifiesintegracaofinanceiras = false)");
			}
			getSqlValidarInadimplenciaAlunoParcelaParceiroRenovacaoMatricula(sql4);
			sql.append(" union ");
			sql.append(sql4.toString());
		}
		
//		sql.append(" union ");
//		StringBuilder sql4 = getSQLPadraoConsultaBasica();
//		sql4.append(" WHERE contareceber.codigorenegociacao in (0");
//		List<Integer> codigoNegociacao = validarExisteContaReceberRenegociadadaQueNaoCumpriuAcordo(pessoa);
//		for (Integer codnegociacao : codigoNegociacao) {
//			sql4.append(", ").append(codnegociacao);
//		}
//		sql4.append(")");
//		sql.append(sql4.toString());
		sql.append(") as t ");
//		sql.append(" where ((\"negociacaocontareceber.liberarrenovacaoapospagamentoprimeiraparcela\" and \"primeiraParcelanegociacao\") or \"negociacaocontareceber.liberarrenovacaoapospagamentoprimeiraparcela\" = false or tipoorigem != 'NCR') order by t.codigo");
		sql.append(" order by t.codigo");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(resultado);
	}

	public Boolean validaContaCorrenteBloqueadoEmissaoBoleto(Integer codigoContaReceber) {
		StringBuilder sb = new StringBuilder("");
		try {
			sb.append(" select bloquearEmissaoBoleto from contareceber inner join contacorrente on contacorrente.codigo = contareceber.contacorrente");
			sb.append(" where ContaReceber.codigo = " + codigoContaReceber);
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
			if (tabelaResultado.next()) {
				return tabelaResultado.getBoolean("bloquearEmissaoBoleto");
			}
			return Boolean.FALSE;
		} finally {
			sb = null;
		}

	}

	public Boolean permiteEmitirBoletoAlunoVinculadoParceiro(Integer codigoContaReceber) {
		StringBuilder sb = new StringBuilder("");
		try {
			sb.append(" select coalesce(case when cr.tipoorigem = 'BCC' then (select permiteEmitirBoletoAlunoVinculadoParceiro from contareceber  ");
			sb.append(" inner join parceiro on parceiro.codigo = contareceber.parceiro where contareceber.codigo = cr.codigo ");
			sb.append(" ) else case when cr.tipoorigem in ('MAT', 'MEN', 'MDI') then (select permiteEmitirBoletoAlunoVinculadoParceiro from contareceber ");
			sb.append(" inner join planodescontocontareceber on planodescontocontareceber.contareceber = contareceber.codigo ");
			sb.append(" inner join convenio on planodescontocontareceber.convenio = convenio.codigo ");
			sb.append(" inner join parceiro on convenio.parceiro = parceiro.codigo where contareceber.codigo = cr.codigo ");
			sb.append(" and parceiro.permiteEmitirBoletoAlunoVinculadoParceiro = false limit 1 ");
			sb.append(" ) end end, true) as permiteEmitirBoletoAlunoVinculadoParceiro from contareceber cr where cr.codigo = ");
			sb.append(codigoContaReceber);
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
			if (tabelaResultado.next()) {
				return tabelaResultado.getBoolean("permiteEmitirBoletoAlunoVinculadoParceiro");
			}
			return Boolean.TRUE;
		} finally {
			sb = null;
		}
		
	}

	public Boolean permiteRemessaBoletoAlunoVinculadoParceiro(Integer codigoContaReceber) {
		StringBuilder sb = new StringBuilder("");
		try {
			sb.append(" select permiteRemessaBoletoAlunoVinculadoParceiro from contareceber inner join parceiro on parceiro.codigo = contareceber.parceiro ");
			sb.append(" where tipoorigem = 'BCC' and contareceber.codigo = " + codigoContaReceber);
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
			if (tabelaResultado.next()) {
				return tabelaResultado.getBoolean("permiteRemessaBoletoAlunoVinculadoParceiro");
			}
			return Boolean.TRUE;
		} finally {
			sb = null;
		}
		
	}

	public List consultaRapidaPorAlunoTipoPessoaContasReceberVencidas(Integer pessoa, String tipoPessoa, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE (contareceber.pessoa = ").append(pessoa).append(") ");
		sql.append(" AND (contareceber.situacao = 'AR') AND (contareceber.dataVencimento < '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("') ");
		if (!tipoPessoa.equals("")) {
			sql.append(" AND (contareceber.tipoPessoa = '").append(tipoPessoa).append("') ");
		}
		sql.append(" ORDER BY contareceber.datavencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(resultado);
	}

	public List<ContaReceberVO> montarDadosConsultaCompletaSemRecebimentoAtualizandoPrimeiraFaixaDescontos(SqlRowSet tabelaResultado, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> vetResultado = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			montarDadosCompletoSemRecebimentoAtualizandoPrimeiraFaixaDescontos(obj, tabelaResultado, configuracaoFinanceiroVO, usuario);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorAlunoEMatriculaContasReceberMensalidadeEMatricula (java.lang.Integer, java.lang.String, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorAlunoEMatriculaContasReceberMensalidadeEMatricula (java.lang.Integer, java.lang.String, int)
	 */
	public List<ContaReceberVO> consultarPorAlunoEMatriculaContasReceberMensalidadeEMatricula(Integer pessoa, String matricula, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" select contareceber.codigo, contareceber.updated, contareceber.nossonumero, contareceber.tipoOrigem, contareceber.situacao, contareceber.dataVencimento, contareceber.valor, contareceber.parcela from contareceber ");
		sqlStr.append(" inner join matricula on matricula.matricula = contareceber.matriculaaluno ");
		sqlStr.append(" where matricula.matricula = '");
		sqlStr.append(matricula.toString());
		sqlStr.append("' and contareceber.tipoorigem <> '").append(TipoOrigemContaReceber.REQUERIMENTO.getValor()).append("' ");
		sqlStr.append(" order by contareceber.dataVencimento desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsultaLiberacaoFinanceiro(tabelaResultado, configuracaoFinanceiroVO, usuario));
	}

	public List<ContaReceberVO> consultarPorAlunoEMatriculaContasReceberMensalidadeEMatriculaCancelado(Integer pessoa, String matricula, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" select contareceber.codigo, contareceber.updated, contareceber.nossonumero, contareceber.tipoOrigem, contareceber.situacao, contareceber.dataVencimento, contareceber.valor, contareceber.parcela from contareceber ");
		sqlStr.append(" inner join matricula on matricula.matricula = contareceber.matriculaaluno ");
		sqlStr.append(" where matricula.matricula = '");
		sqlStr.append(matricula.toString());
		sqlStr.append("' ");
		sqlStr.append(" and contareceber.situacao = 'CF' ");
		sqlStr.append("order by contareceber.dataVencimento desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsultaLiberacaoFinanceiro(tabelaResultado, configuracaoFinanceiroVO, usuario));
	}

	public static List<ContaReceberVO> montarDadosConsultaLiberacaoFinanceiro(SqlRowSet tabelaResultado, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> vetResultado = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			vetResultado.add(montarDadosLiberacaoFinanceiro(tabelaResultado, configuracaoFinanceiroVO, usuario));
		}
		return vetResultado;
	}

	public static ContaReceberVO montarDadosLiberacaoFinanceiro(SqlRowSet dadosSQL, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) {
		ContaReceberVO obj = new ContaReceberVO();
		obj.setCodigo(dadosSQL.getInt("codigo"));
		obj.setUpdated(dadosSQL.getDate("updated"));
		obj.setTipoOrigem(dadosSQL.getString("tipoorigem"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setDataVencimento(dadosSQL.getDate("datavencimento"));
		obj.setValor(dadosSQL.getDouble("valor"));
		obj.setParcela(dadosSQL.getString("parcela"));
		obj.setNossoNumero(dadosSQL.getString("nossonumero"));
		// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(dadosSQL.getInt("registrocobrancacontareceber"));
		return obj;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorAlunoEMatriculaContasReceberRequerimentoEBiblioteca (java.lang.Integer, java.lang.String, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @seenegocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorAlunoEMatriculaContasReceberRequerimentoEBiblioteca (java.lang.Integer, java.lang.String, int)
	 */
	public List<ContaReceberVO> consultarPorAlunoEMatriculaContasReceberBiblioteca(Integer pessoa, String matricula, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		String sqlStr = "select * from contareceber where pessoa = " + pessoa.toString() + " and tipoorigem in ('BIB') and tipopessoa = 'AL' and matriculaaluno = '" + matricula + "'";
		sqlStr += " ORDER BY codigo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# verificarContaReceberPessoaTipoBiblioteca(java.lang .Integer, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# verificarContaReceberPessoaTipoBiblioteca(java.lang .Integer, int)
	 */
	public Boolean verificarContaReceberPessoaTipoBiblioteca(Integer pessoa, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		String sqlStr = "SELECT * FROM contareceber WHERE pessoa = " + pessoa + " AND tipoorigem = 'BIB' and situacao = 'AR' ";
		sqlStr += " ORDER BY codigo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return true;
		}
		return false;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorChavePrimariaSituacao(java.lang.Integer, java.lang.String, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorChavePrimariaSituacao(java.lang.Integer, java.lang.String, int)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Throwable.class, propagation = Propagation.REQUIRED)
	public ContaReceberVO consultarPorChavePrimariaSituacao(Integer codigoPrm, String situacao, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		String sql = "SELECT * FROM ContaReceber WHERE codigo = ? and situacao = ?";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql, new Object[] { codigoPrm, situacao });
		if (!tabelaResultado.next()) {
			return null;
		}
		return (montarDados(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}
	
	@Override
	public List<ContaReceberVO> consultaRapidaPorCodigo(Integer valorConsulta,  boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE contareceber.codigo = ").append(valorConsulta);
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(resultado);
	}

	
	public List<ContaReceberVO> consultarPorCodigo(Integer valorConsulta, Integer unidadeEnsino, String tipoOrigem, Integer limite, Integer offset, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT * FROM ContaReceber WHERE codigo = ?");

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta.intValue());
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public Integer consultarPorCodigoTotalRegistros(Integer valorConsulta, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT count(contareceber.codigo) FROM ContaReceber WHERE codigo = ?");

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta.intValue());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("count");
		} else {
			return 0;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarContaReceberPorSituacaoUnidadeEnsino(java .lang.Integer, java.lang.String, java.util.Date, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarContaReceberPorSituacaoUnidadeEnsino(java .lang.Integer, java.lang.String, java.util.Date, int)
	 */
	public List consultarContaReceberPorSituacaoUnidadeEnsino(Integer unidadeEnsino, String situacao, Date dataBase, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		String sql = "Select * from contaReceber where unidadeEnsino = " + unidadeEnsino + " and situacao <> 'RE' ";
		if (situacao.equals("VE")) {
			sql += " and dataVencimento < '" + Uteis.getDataJDBC(dataBase) + " 00:00:00' ";
		} else if (situacao.equals("VH")) {
			sql += " and (dataVencimento >= '" + Uteis.getDataJDBC(dataBase) + " 00:00:00' and dataVencimento <= '" + Uteis.getDataJDBC(dataBase) + " 23:59:59' ) ";
		} else if (situacao.equals("AV")) {
			sql += " and (dataVencimento > '" + Uteis.getDataJDBC(dataBase) + " 23:59:59' and dataVencimento <= '" + Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(dataBase)) + " 23:59:59' ) ";
		}
		sql += " order by dataVencimento ";
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql);
		return montarDadosConsulta(rs, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public Integer consultaRapidaPorSituacaoUnidadeEnsinoTotalRegistros(Integer unidadeEnsino, String situacao, Date dataBase, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append(" where contareceber.unidadeEnsino = ").append(unidadeEnsino).append(" and contareceber.situacao <> 'RE' ");
		if (situacao.equals("VE")) {
			sql.append(" and contareceber.dataVencimento < '").append(Uteis.getDataJDBC(dataBase)).append(" 00:00:00' ");
		} else if (situacao.equals("VH")) {
			sql.append(" and (contareceber.dataVencimento >= '").append(Uteis.getDataJDBC(dataBase)).append(" 00:00:00' and contareceber.dataVencimento <= '").append(Uteis.getDataJDBC(dataBase)).append(" 23:59:59' ) ");
		} else if (situacao.equals("AV")) {
			sql.append(" and (contareceber.dataVencimento > '").append(Uteis.getDataJDBC(dataBase)).append(" 23:59:59' and contareceber.dataVencimento <= '").append(Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(dataBase))).append(" 23:59:59' ) ");
		}
		if (!tipoOrigem.equals("")) {
			sql.append(" and tipoorigem = '").append(tipoOrigem).append("' ");
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	public List<ContaReceberVO> consultaRapidaPorSituacaoUnidadeEnsino(Integer unidadeEnsino, String situacao, Date dataBase, Integer limite, Integer offset, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append("where contareceber.unidadeEnsino = ").append(unidadeEnsino).append(" and contareceber.situacao <> 'RE' and contareceber.situacao <> 'NE' ");
		if (situacao.equals("VE")) {
			sql.append("and contareceber.dataVencimento < '").append(Uteis.getDataJDBC(dataBase)).append(" 00:00:00' ");
		} else if (situacao.equals("VH")) {
			sql.append("and (contareceber.dataVencimento >= '").append(Uteis.getDataJDBC(dataBase)).append(" 00:00:00' and contareceber.dataVencimento <= '").append(Uteis.getDataJDBC(dataBase)).append(" 23:59:59') ");
		} else if (situacao.equals("AV")) {
			sql.append("and (contareceber.dataVencimento > '").append(Uteis.getDataJDBC(dataBase)).append(" 23:59:59' and contareceber.dataVencimento <= '").append(Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(dataBase))).append(" 23:59:59') ");
		}
		if (!tipoOrigem.equals("")) {
			sql.append(" and tipoorigem = '").append(tipoOrigem).append("' ");
		}
		sql.append("ORDER BY contareceber.datavencimento, contareceber.matriculaaluno ");
		if (limite != null) {
			sql.append("LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(resultado);
	}

	
	@Override
	public List<ContaReceberVO> consultaRapidaPorNomeSacado(String nomeSacado, List<String> situacoes, int unidadeEnsino, String tipoOrigem, Boolean consDataCompetencia, Date dataInicio, Date dataFim, Integer limite, Integer offset, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, List<String> ordenador) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);		
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE contareceber.nomesacado ilike sem_acentos (?)  ");
		if (!consDataCompetencia) {
			sql.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sql.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append("and ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")");
		}

		sql.append(montarSqlSituacoes(situacoes));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
	
		if(Uteis.isAtributoPreenchido(ordenador)) {
			sql.append(" ORDER BY ").append(UteisTexto.converteListaStringParaString(ordenador));
		}else {
			sql.append(" ORDER BY contareceber.datavencimento "); 
			sql.append(" , contareceber.nomesacado, contareceber.dataCompetencia");
		}
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}		
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), "%" + nomeSacado + "%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorNomeSacadoTotalRegistros(String nomeSacado, List<String> situacoes, int unidadeEnsino, String tipoOrigem, Boolean consDataCompetencia, Date dataInicio, Date dataFim, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append(" WHERE contareceber.nomesacado ilike sem_acentos (?) ");
		
		if (!consDataCompetencia) {
			sql.append(" and (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append(" and (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sql.append(" and (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(")  ");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" and (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")) ");
		}
		sql.append(montarSqlSituacoes(situacoes));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sql.append(getSQLPadraoConsultaBasicaPorNomeSacadoTipoPessoa());


		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), "%"+nomeSacado+"%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	@Override
	public List<ContaReceberVO> consultaRapidaPorNomeSacadoAnoSemestre(String nomeSacado, String ano, String semestre, List<String> situacoes, int unidadeEnsino, String tipoOrigem, Integer limite, Integer offset, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append("inner JOIN matriculaperiodo ON matriculaperiodo.matricula = matricula.matricula AND matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		sql.append(" WHERE contareceber.nomesacado ilike sem_acentos (?) ");
		if (unidadeEnsino != 0) {
			sql.append(" AND (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(")  ");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" AND (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")) ");
		}

		if (!ano.equals("")) {
			sql.append(" AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sql.append(" AND matriculaperiodo.semestre = '").append(semestre).append("'  ");
		}

		sql.append(montarSqlSituacoes(situacoes));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sql.append(getSQLPadraoConsultaBasicaPorNomeSacadoTipoPessoa());
		sql.append(" ORDER BY contareceber.datavencimento, contareceber.nomesacado ");
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), "%"+nomeSacado+"%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorNomeSacadoAnoSemestreTotalRegistros(String nomeSacado, String ano, String semestre, List<String> situacoes, int unidadeEnsino, String tipoOrigem, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append("inner JOIN matriculaperiodo ON matriculaperiodo.matricula = matricula.matricula AND matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		sql.append(" WHERE contareceber.nomesacado ilike sem_acentos (?) ");
		if (unidadeEnsino != 0) {
			sql.append(" AND (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(")  ");
		}

		if (!ano.equals("")) {
			sql.append(" AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sql.append(" AND matriculaperiodo.semestre = '").append(semestre).append("'  ");
		}

		sql.append(montarSqlSituacoes(situacoes));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sql.append(getSQLPadraoConsultaBasicaPorNomeSacadoTipoPessoa());
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), "%"+nomeSacado+"%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	@Override
	public List<ContaReceberVO> consultaRapidaPorCodigoFinanceiroMatricula(String codigoFinanceiroMatricula, List<String> situacoes, int unidadeEnsino, String tipoOrigem, Integer limite, Integer offset, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append("LEFT JOIN matriculaperiodo ON matriculaperiodo.matricula = matricula.matricula AND matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		sql.append(" WHERE 1=1 ");
		if (unidadeEnsino != 0) {
			sql.append(" AND (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(")  ");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" AND (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append("))");
		}

		if (!codigoFinanceiroMatricula.equals("")) {
			sql.append(" AND matricula.codigoFinanceiroMatricula = ? ");
		}

		sql.append(montarSqlSituacoes(situacoes));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sql.append(" ORDER BY contareceber.datavencimento, contareceber.matriculaaluno ");
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), codigoFinanceiroMatricula);
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorCodigoFinanceiroMatriculaTotalRegistros(String codigoFinanceiroMatricula, List<String> situacoes, int unidadeEnsino, String tipoOrigem, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append(" LEFT JOIN matriculaperiodo ON matriculaperiodo.matricula = matricula.matricula AND matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		sql.append(" WHERE 1=1 ");
		if (unidadeEnsino != 0) {
			sql.append(" AND (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(")  ");
		}

		if (!codigoFinanceiroMatricula.equals("")) {
			sql.append(" AND matricula.codigoFinanceiroMatricula = ? ");
		}

		sql.append(montarSqlSituacoes(situacoes));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), codigoFinanceiroMatricula);
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorMatriculaTipoPessoaSituacaoDiferenteDe (java.lang.String, java.lang.String, java.lang.String, java.lang.Integer, boolean, int)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorMatriculaTipoPessoaSituacaoDiferenteDe (java.lang.String, java.lang.String, java.lang.String, java.lang.Integer, boolean, int)
	 */
	public List consultarPorMatriculaTipoPessoaSituacaoDiferenteDe(String matricula, String situacao, String tipoPessoa, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT contareceber.* FROM contareceber";
		sqlStr += " WHERE contareceber.matriculaAluno = '" + matricula + "' AND contareceber.situacao <> '" + situacao.toUpperCase() + "' AND contareceber.tipoPessoa = '" + tipoPessoa.toUpperCase() + "'";
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " AND unidadeEnsino = " + unidadeEnsino.intValue();
		}
		sqlStr += " ORDER BY contareceber.datavencimento;";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaSituacaoTipoOrigens(String matricula, String situacao, String tipoOrigens, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE contareceber.matriculaAluno = '").append(matricula).append("' AND contareceber.situacao = '").append(situacao.toUpperCase()).append("'");		
		if (Uteis.isAtributoPreenchido(tipoOrigens)) {
			sql.append(" and ContaReceber.tipoorigem in (").append(tipoOrigens).append(") ");
		}
		sql.append(" ORDER BY contareceber.datavencimento;");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());

		return montarDadosConsultaBasica(tabelaResultado);
	}

	public ContaReceberVO consultarPorNossoNumero(String nossoNumero, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		// Consulta em contaReceber pelo nossoNumero encontrado no arquivo de
		// retorno.
		String sqlStr = "SELECT contareceber.* FROM ContaReceber WHERE nossonumero = '" + nossoNumero + "' ";

		// Caso ainda não encontre a conta, ele agora procura pelo nossoNumero
		// que foi gerado pelo SEI.
		// Esse número não contém os zeros a esquerda, encontrados no arquivo de
		// retorno.
		// Logo, a solução é a conversão dessa String para um BigInteger, onde
		// os zeros serão ignorados.
		BigInteger nossoNumeroBig = new BigInteger(nossoNumero);
		String sqlStr3 = "SELECT contareceber.* FROM ContaReceber WHERE nossonumero::bigint = '" + nossoNumeroBig + "' AND nossonumero !~* '[a-zA-Z]' and nossonumero <> ''";

		// Caso não encontre a conta, ele procura esse nossoNumero em uma tabela
		// chamada contaReceber2
		// que contém dados de uma base antiga.
		String sqlStr2 = "SELECT contareceber2.* FROM ContaReceber2 WHERE nossonumero = '" + nossoNumero + "' ";

		try {
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
			if (tabelaResultado.next()) {
				return montarDados(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
			}
			SqlRowSet tabelaResultado3 = getConexao().getJdbcTemplate().queryForRowSet(sqlStr3);
			if (tabelaResultado3.next()) {
				return montarDados(tabelaResultado3, nivelMontarDados, configuracaoFinanceiroVO, usuario);
			}
			SqlRowSet tabelaResultado2 = getConexao().getJdbcTemplate().queryForRowSet(sqlStr2);
			if (tabelaResultado2.next()) {
				// Ao encontrar a conta na tabela contaReceber2, temos que
				// encontrar a conta correspondente,
				// que foi gerada com os dados diferentes na tabela
				// contaReceber.
				return consultarContaCorrespondenteTabelaContaReceber(montarDados(tabelaResultado2, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiroVO, usuario), nivelMontarDados, configuracaoFinanceiroVO, usuario);
			}
			return new ContaReceberVO();
		} finally {
			sqlStr = null;
			// sqlStr2 = null;
			sqlStr3 = null;
			nossoNumeroBig = null;
		}
	}

	public ContaReceberVO consultarPorNossoNumeroControleCobranca(String nossoNumero, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		// String sqlStr =
		// "SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, cr.situacao, p.nome, matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa FROM ContaReceber cr WHERE nossonumero = '"
		// + nossoNumero + "' ";
		//
		// BigInteger nossoNumeroBig = new BigInteger(nossoNumero);
		// String sqlStr1 =
		// "SELECT codigo, dataVencimento, situacao FROM ContaReceber WHERE nossonumero::bigint = '"
		// + nossoNumeroBig +
		// "' AND nossonumero !~* '[a-zA-Z]' and nossonumero <> ''";
		//
		// String sqlStr2 =
		// "SELECT codigo, dataVencimento, situacao FROM ContaReceber2 WHERE nossonumero = '"
		// + nossoNumero + "' ";

		StringBuilder sqlStr = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, cr.situacao, cr.updated, p.nome, ");
		sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\" ");
		sqlStr.append(" FROM ContaReceber cr ");
		sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append(" LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
		sqlStr.append("WHERE nossonumero = '").append(nossoNumero).append("' ");

		BigInteger nossoNumeroBig = new BigInteger(nossoNumero);
		StringBuilder sqlStr1 = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, cr.situacao, cr.updated, p.nome, ");
		sqlStr1.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\" , ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\" ");
		sqlStr.append(" FROM ContaReceber cr ");
		sqlStr1.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr1.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr1.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append(" LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
		sqlStr1.append("WHERE nossonumero::bigint = '").append(nossoNumeroBig).append("' ");
		sqlStr1.append("AND nossonumero !~* '[a-zA-Z]' and nossonumero <> '' ");

		StringBuilder sqlStr2 = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, cr.situacao,  current_timestampt as updated, p.nome, ");
		sqlStr2.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\" , ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\" ");
		sqlStr.append(" FROM ContaReceber2 cr ");
		sqlStr2.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr2.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr2.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append(" LEFT JOIN fornecedor  ON fornecedor.codigo = cr.fornecedor ");

		sqlStr2.append("WHERE nossonumero = '").append(nossoNumero).append("' ");

		try {
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			if (tabelaResultado.next()) {
				return montarDadosTelaControleCobranca(tabelaResultado);
			}
			SqlRowSet tabelaResultado1 = getConexao().getJdbcTemplate().queryForRowSet(sqlStr1.toString());
			if (tabelaResultado1.next()) {
				return montarDadosTelaControleCobranca(tabelaResultado1);
			}
			SqlRowSet tabelaResultado2 = getConexao().getJdbcTemplate().queryForRowSet(sqlStr2.toString());
			if (tabelaResultado2.next()) {
				return montarDadosTelaControleCobranca(tabelaResultado2);
			}
			return new ContaReceberVO();
		} catch (Exception e) {
			throw e;
		} finally {
			sqlStr = null;
			sqlStr2 = null;
			nossoNumeroBig = null;
		}
	}
	
	//public Map<BigInteger, ContaReceberVO> consultarPorNossoNumeroControleCobranca(final RegistroArquivoVO registroArquivoVO, final Boolean bancoBrasil) throws Exception {
	public Map<BigInteger, ContaReceberVO> consultarPorNossoNumeroControleCobranca(final RegistroArquivoVO registroArquivoVO, ProgressBarVO progressBarVO, final Boolean bancoBrasil) throws Exception {
		if (registroArquivoVO.getRegistroDetalheVOs().isEmpty()) {
			return new HashMap<BigInteger, ContaReceberVO>(0);
		}
		boolean modeloAntigo = false;
		if(!modeloAntigo) {
			return consultarContaBaixarArquivoRetorno(registroArquivoVO, progressBarVO, bancoBrasil);
		} else {			
		StringBuilder sqlStr = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
		sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
		sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append("LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
		sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append(" WHERE cr.situacao <> 'NE' ");
		
		boolean virgula = false;
		if (bancoBrasil) {
			sqlStr.append(" AND nossonumero in ( ");
			for (RegistroDetalheVO detalhe : registroArquivoVO.getRegistroDetalheVOs()) {
				if (detalhe != null) {
					if (!detalhe.getIdentificacaoTituloEmpresa().trim().isEmpty()) {
						if (detalhe.getContaReceberAgrupada()) {
							continue;
						}
						if (!virgula) {
							sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa()).append("'");
							sqlStr.append(", substring('").append(detalhe.getIdentificacaoTituloEmpresa()).append("', 8, length('").append(detalhe.getIdentificacaoTituloEmpresa()).append("'))");
							sqlStr.append(", '0'||substring('").append(detalhe.getIdentificacaoTituloEmpresa()).append("', 9, length('").append(detalhe.getIdentificacaoTituloEmpresa()).append("'))");
							virgula = true;
						} else {
							sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa()).append("'");
							sqlStr.append(", substring('").append(detalhe.getIdentificacaoTituloEmpresa()).append("', 8, length('").append(detalhe.getIdentificacaoTituloEmpresa()).append("'))");
							sqlStr.append(", '0'||substring('").append(detalhe.getIdentificacaoTituloEmpresa()).append("', 9, length('").append(detalhe.getIdentificacaoTituloEmpresa()).append("'))");
						}
					}
				}
			}
			sqlStr.append(" )");
		} else {
			sqlStr.append(" AND (nossonumero in ( ");
			String listaNossoNumero = "";
			for (RegistroDetalheVO detalhe : registroArquivoVO.getRegistroDetalheVOs()) {
				if (detalhe != null) {
					if (!detalhe.getIdentificacaoTituloEmpresa().trim().isEmpty()) {
						if (detalhe.getContaReceberAgrupada()) {
							continue;
						}
						if (!virgula) {
							if (detalhe.getCarteira() == 112 && registroArquivoVO.getRegistroHeader().getCodigoBanco() == "341") {
								sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa()).append("', '").append(detalhe.getIdentificacaoTituloBanco()).append("' ");
							} else {
								sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
								listaNossoNumero += " '" + detalhe.getIdentificacaoTituloEmpresa() + "' ";
							}
							virgula = true;
						} else {
							if (detalhe.getCarteira() == 112 && registroArquivoVO.getRegistroHeader().getCodigoBanco() == "341") {
								sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa()).append("', '").append(detalhe.getIdentificacaoTituloBanco()).append("' ");
							} else {
								sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
								listaNossoNumero += ", '" + detalhe.getIdentificacaoTituloEmpresa() + "' ";
							}
						}
					}
				}
			}
			sqlStr.append(" ) or '00000'||nossonumero in (");
			sqlStr.append(listaNossoNumero);
			sqlStr.append(" ) or '0000'||nossonumero in (");
			sqlStr.append(listaNossoNumero);
			sqlStr.append(" ) or '000'||nossonumero in (");
			sqlStr.append(listaNossoNumero);
			sqlStr.append(" ) or '00'||nossonumero in (");
			sqlStr.append(listaNossoNumero);
			sqlStr.append(" ) or '0'||nossonumero in (");
			sqlStr.append(listaNossoNumero);
			sqlStr.append(" ))");
		}
		int qtd = 0;
		try {
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			Map<BigInteger, ContaReceberVO> resultado = new HashMap<BigInteger, ContaReceberVO>(0);
			while (tabelaResultado.next()) {
				ContaReceberVO contaReceber = montarDadosTelaControleCobranca(tabelaResultado);
				if (contaReceber.getNossoNumero().contains("P")) {
					resultado.put(new BigInteger(contaReceber.getNossoNumero().replace("P", "")), contaReceber);
				} else {
					resultado.put(new BigInteger(contaReceber.getNossoNumero()), contaReceber);
				}
			}

			if (registroArquivoVO.getRegistroDetalheVOs().size() != resultado.size()) {
				sqlStr = new StringBuilder("");
				sqlStr.append(" SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
				sqlStr.append(" matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
				sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\" ");
				sqlStr.append(" FROM ContaReceber cr ");
				sqlStr.append(" LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
				sqlStr.append(" LEFT JOIN pessoa p ON m.aluno = p.codigo ");
				sqlStr.append(" LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
				sqlStr.append(" LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
				sqlStr.append(" LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
				sqlStr.append(" WHERE cr.situacao <> 'NE' ");
				if (Uteis.isAtributoPreenchido(registroArquivoVO.getListaContaCorrenteVOs())) {
					 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(registroArquivoVO.getListaContaCorrenteVOs())).append(" )");
				}
				sqlStr.append(" AND nossonumero in ( ");
				virgula = false;

				for (RegistroDetalheVO detalhe : registroArquivoVO.getRegistroDetalheVOs()) {
					if (detalhe != null) {
						if (!detalhe.getIdentificacaoTituloEmpresa().trim().isEmpty()) {
							if (detalhe.getContaReceberAgrupada()) {
								continue;
							}
							if (!detalhe.getIdentificacaoTituloEmpresa().equals("")) {
								if (detalhe.getIdentificacaoTituloEmpresa().contains("P")) {
									if (!resultado.containsKey(new BigInteger(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")))) {
										if (!virgula) {
											sqlStr.append(" '").append(new BigInteger(detalhe.getIdentificacaoTituloEmpresa().replace("P", ""))).append("' ");
											virgula = true;
										} else {
											sqlStr.append(", '").append(new BigInteger(detalhe.getIdentificacaoTituloEmpresa().replace("P", ""))).append("' ");
										}
									}
								} else {
									if (!resultado.containsKey(new BigInteger(detalhe.getIdentificacaoTituloEmpresa()))) {
										if (!virgula) {
											if (detalhe.getCarteira() == 112 && registroArquivoVO.getRegistroHeader().getCodigoBanco() == "341") {
												sqlStr.append(" '").append(new BigInteger(detalhe.getIdentificacaoTituloEmpresa())).append("', '").append(detalhe.getIdentificacaoTituloBanco()).append("' ");
											} else {
												sqlStr.append(" '").append(new BigInteger(detalhe.getIdentificacaoTituloEmpresa())).append("' ");
											}
											virgula = true;
										} else {
											if (detalhe.getCarteira() == 112 && registroArquivoVO.getRegistroHeader().getCodigoBanco() == "341") {
												sqlStr.append(", '").append(new BigInteger(detalhe.getIdentificacaoTituloEmpresa())).append("', '").append(detalhe.getIdentificacaoTituloBanco()).append("' ");
											} else {
												sqlStr.append(", '").append(new BigInteger(detalhe.getIdentificacaoTituloEmpresa())).append("' ");
											}
										}
									}
								}
							}
						}
					}
				}
				sqlStr.append(" )");
				sqlStr.append(" AND nossonumero !~* '[a-zA-Z]'  ");
				if (virgula) {
					tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
					while (tabelaResultado.next()) {
						ContaReceberVO contaReceber = montarDadosTelaControleCobranca(tabelaResultado);
						if (contaReceber.getNossoNumero().contains("P")) {
							resultado.put(new BigInteger(contaReceber.getNossoNumero().replace("P", "")), contaReceber);
						} else {
							resultado.put(new BigInteger(contaReceber.getNossoNumero()), contaReceber);
						}
					}
				}
			}

			if (registroArquivoVO.getRegistroDetalheVOs().size() != resultado.size()) {
				sqlStr = new StringBuilder("");
				sqlStr.append(" SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
				sqlStr.append(" matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
				sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\" ");
				sqlStr.append(" FROM ContaReceber cr ");
				sqlStr.append(" LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
				sqlStr.append(" LEFT JOIN pessoa p ON m.aluno = p.codigo ");
				sqlStr.append(" LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
				sqlStr.append(" LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
				sqlStr.append(" LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
				sqlStr.append(" WHERE cr.situacao <> 'NE' ");
				if (Uteis.isAtributoPreenchido(registroArquivoVO.getListaContaCorrenteVOs())) {
					 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(registroArquivoVO.getListaContaCorrenteVOs())).append(" )");
				}
				sqlStr.append(" AND nossonumero in ( ");
				virgula = false;

				for (RegistroDetalheVO detalhe : registroArquivoVO.getRegistroDetalheVOs()) {
					if (detalhe != null) {
						if (!detalhe.getIdentificacaoTituloEmpresa().trim().isEmpty()) {
							if (detalhe.getContaReceberAgrupada()) {
								continue;
							}
							if (!detalhe.getIdentificacaoTituloEmpresa().equals("")) {
								if (detalhe.getIdentificacaoTituloEmpresa().contains("P")) {
									if (!resultado.containsKey(new BigInteger(detalhe.getIdentificacaoTituloEmpresa().replace("P", ""))) && (detalhe.getIdentificacaoTituloEmpresa().substring(0, 1).equals("0"))) {
										if (!virgula) {
											sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa().replace("P", "").substring(1, 4)).append("0").append(detalhe.getIdentificacaoTituloEmpresa().substring(4)).append("' ");
											virgula = true;
										} else {
											sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa().replace("P", "").substring(1, 4)).append("0").append(detalhe.getIdentificacaoTituloEmpresa().substring(4)).append("' ");
										}
									}
								} else {
									if (!resultado.containsKey(new BigInteger(detalhe.getIdentificacaoTituloEmpresa())) && (detalhe.getIdentificacaoTituloEmpresa().substring(0, 1).equals("0"))) {
										if (!virgula) {
											sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa().substring(1, 4)).append("0").append(detalhe.getIdentificacaoTituloEmpresa().substring(4)).append("' ");
											virgula = true;
										} else {
											sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa().substring(1, 4)).append("0").append(detalhe.getIdentificacaoTituloEmpresa().substring(4)).append("' ");
										}
									}
								}
							}
						}
					}
				}
				sqlStr.append(" )");
				sqlStr.append("  ");
				if (virgula) {
					tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
					while (tabelaResultado.next()) {
						ContaReceberVO contaReceber = montarDadosTelaControleCobranca(tabelaResultado);
						if (contaReceber.getNossoNumero().contains("P")) {
							resultado.put(new BigInteger(contaReceber.getNossoNumero().replace("P", "")), contaReceber);
						} else {
							resultado.put(new BigInteger(contaReceber.getNossoNumero()), contaReceber);
						}
					}
				}
			}

			if (registroArquivoVO.getRegistroDetalheVOs().size() != resultado.size()) {
				sqlStr = new StringBuilder("");
				sqlStr.append(" SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, cr.situacao, current_timestamp as updated, p.nome, ");
				sqlStr.append(" matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
				sqlStr.append(" 0 as \"for.codigo\", '' as \"for.nome\" , '' as \"for.cnpj\" , '' as \"for.cpf\",  '' as \"for.tipoEmpresa\" ");
				sqlStr.append(" FROM ContaReceber2 cr ");
				sqlStr.append(" LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
				sqlStr.append(" LEFT JOIN pessoa p ON m.aluno = p.codigo ");
				sqlStr.append(" LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
				sqlStr.append(" LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
				sqlStr.append(" WHERE cr.situacao <> 'NE' ");
				if (Uteis.isAtributoPreenchido(registroArquivoVO.getListaContaCorrenteVOs())) {
					 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(registroArquivoVO.getListaContaCorrenteVOs())).append(" )");
				}
				sqlStr.append(" AND nossonumero in ( ");
				virgula = false;

				for (RegistroDetalheVO detalhe : registroArquivoVO.getRegistroDetalheVOs()) {
					if (detalhe != null) {
						if (!detalhe.getIdentificacaoTituloEmpresa().trim().isEmpty()) {
							if (detalhe.getContaReceberAgrupada()) {
								continue;
							}
							if (!detalhe.getIdentificacaoTituloEmpresa().equals("")) {
								if (detalhe.getIdentificacaoTituloEmpresa().contains("P")) {
									if (!resultado.containsKey(new BigInteger(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")))) {
										if (!virgula) {
											sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")).append("' ");
											virgula = true;
										} else {
											sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")).append("' ");
										}
									}
								} else {
									if (!resultado.containsKey(new BigInteger(detalhe.getIdentificacaoTituloEmpresa()))) {
										if (!virgula) {
											if (detalhe.getCarteira() == 112 && registroArquivoVO.getRegistroHeader().getCodigoBanco() == "341") {
												sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' , '").append(detalhe.getIdentificacaoTituloBanco()).append("' ");
											} else {
												sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
											}
											virgula = true;
										} else {
											if (detalhe.getCarteira() == 112 && registroArquivoVO.getRegistroHeader().getCodigoBanco() == "341") {
												sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa()).append("', '").append(detalhe.getIdentificacaoTituloBanco()).append("' ");
											} else {
												sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
											}
										}
									}
								}
							}
						}
					}
				}
				sqlStr.append(" )");
				sqlStr.append("  ");
				if (virgula) {
					tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
					while (tabelaResultado.next()) {
						ContaReceberVO contaReceber = montarDadosTelaControleCobranca(tabelaResultado);
						if (contaReceber.getNossoNumero().contains("P")) {
							resultado.put(new BigInteger(contaReceber.getNossoNumero().replace("P", "")), contaReceber);
						} else {
							resultado.put(new BigInteger(contaReceber.getNossoNumero()), contaReceber);
						}
					}
				}
			}

			if (registroArquivoVO.getRegistroDetalheVOs().size() != resultado.size()) {
				sqlStr = new StringBuilder("");
				sqlStr = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
				sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
				sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
				sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
				sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
				sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
				sqlStr.append("LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
				sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
				sqlStr.append(" WHERE cr.situacao <> 'NE' ");
				if (Uteis.isAtributoPreenchido(registroArquivoVO.getListaContaCorrenteVOs())) {
					 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(registroArquivoVO.getListaContaCorrenteVOs())).append(" )");
				}
				sqlStr.append(" AND nossonumero in ( ");
				virgula = false;

				for (RegistroDetalheVO detalhe : registroArquivoVO.getRegistroDetalheVOs()) {
					if (detalhe != null) {
						if (!detalhe.getIdentificacaoTituloEmpresa().trim().isEmpty()) {
							if (detalhe.getContaReceberAgrupada()) {
								continue;
							}
							if (!detalhe.getIdentificacaoTituloEmpresa().equals("")) {
								if (detalhe.getIdentificacaoTituloEmpresa().contains("P")) {
									if (!resultado.containsKey(new BigInteger(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")))) {
										if (!virgula) {
											sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")).append("' ");
											sqlStr.append(", '1'||'").append(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")).append("' ");
											virgula = true;
										} else {
											sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")).append("' ");
											sqlStr.append(", '1'||'").append(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")).append("' ");
										}
									}
								} else {
									if (!resultado.containsKey(new BigInteger(detalhe.getIdentificacaoTituloEmpresa()))) {
										if (!virgula) {
											sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
											sqlStr.append(", '1'||'").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
											virgula = true;
										} else {
											sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
											sqlStr.append(", '1'||'").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
										}
									}
								}
							}
						}
					}
				}
				sqlStr.append(" )");
				sqlStr.append("  ");
				if (virgula) {
					tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
					while (tabelaResultado.next()) {
						ContaReceberVO contaReceber = montarDadosTelaControleCobranca(tabelaResultado);
						if (contaReceber.getNossoNumero().contains("P")) {
							resultado.put(new BigInteger(contaReceber.getNossoNumero().replace("P", "")), contaReceber);
						} else {
							resultado.put(new BigInteger(contaReceber.getNossoNumero()), contaReceber);
						}
					}
				}
			}
			if (registroArquivoVO.getRegistroDetalheVOs().size() != resultado.size()) {
				// Esse SQL serve para buscar as contas a receber pelo campo
				// nossonumeroantigo, que foi criado em 07/03/2014 para
				// localizar contas que foram importadas, e que quando
				// repassou pela matricula os nosso numeros foram deletados.

				sqlStr = new StringBuilder("");
				sqlStr = new StringBuilder("SELECT nrdocumento, nossonumeroantigo AS nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
				sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
				sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
				sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
				sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
				sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
				sqlStr.append("LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
				sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
				sqlStr.append(" WHERE cr.situacao <> 'NE' ");
				if (Uteis.isAtributoPreenchido(registroArquivoVO.getListaContaCorrenteVOs())) {
					 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(registroArquivoVO.getListaContaCorrenteVOs())).append(" )");
				}
				sqlStr.append(" AND nossonumeroantigo in ( ");

				virgula = false;
				for (RegistroDetalheVO detalhe : registroArquivoVO.getRegistroDetalheVOs()) {
					if (detalhe != null) {
						if (!detalhe.getIdentificacaoTituloEmpresa().trim().isEmpty()) {
							if (detalhe.getContaReceberAgrupada()) {
								continue;
							}
							if (detalhe.getIdentificacaoTituloEmpresa().contains("P")) {
								if (!virgula) {
									sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")).append("' ");
									virgula = true;
								} else {
									sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa().replace("P", "")).append("' ");
								}
							} else {
								if (!virgula) {
									if (detalhe.getCarteira() == 112 && registroArquivoVO.getRegistroHeader().getCodigoBanco() == "341") {
										sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa()).append("', '").append(detalhe.getIdentificacaoTituloBanco()).append("' ");
									} else {
										sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
									}
									virgula = true;
								} else {
									if (detalhe.getCarteira() == 112 && registroArquivoVO.getRegistroHeader().getCodigoBanco() == "341") {
										sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa()).append("', '").append(detalhe.getIdentificacaoTituloBanco()).append("' ");
									} else {
										sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
									}
								}
							}
						}
					}
				}
				sqlStr.append(" )");
				if (virgula) {
					tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
					while (tabelaResultado.next()) {
						ContaReceberVO contaReceber = montarDadosTelaControleCobranca(tabelaResultado);
						if (contaReceber.getNossoNumero().contains("P")) {
							resultado.put(new BigInteger(contaReceber.getNossoNumero().replace("P", "")), contaReceber);
						} else {
							resultado.put(new BigInteger(contaReceber.getNossoNumero()), contaReceber);
						}
					}
				}
			}

			if (registroArquivoVO.getRegistroDetalheVOs().size() != resultado.size()) {
				// Consulta específica para buscar as contas da PROCESSUS
				// As contas do banco HSBC foram geradas com 16 dígitos mas no
				// sistema estava sendo gerado com 13,
				// devido esse problema foi criado essa consulta para buscar
				// apenas os 13 primeiros dígitos
				// Autor Carlos
				// 17/03/2014
				sqlStr = new StringBuilder("");
				sqlStr = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
				sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
				sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
				sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
				sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
				sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
				sqlStr.append("LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
				sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
				sqlStr.append(" WHERE cr.situacao <> 'NE' ");
				if (Uteis.isAtributoPreenchido(registroArquivoVO.getListaContaCorrenteVOs())) {
					 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(registroArquivoVO.getListaContaCorrenteVOs())).append(" )");
				}
				sqlStr.append(" AND nossonumero in ( ");

				virgula = false;
				for (RegistroDetalheVO detalhe : registroArquivoVO.getRegistroDetalheVOs()) {
					if (detalhe != null) {
						if (!detalhe.getIdentificacaoTituloEmpresa().trim().isEmpty()) {
							if (detalhe.getContaReceberAgrupada()) {
								continue;
							}
							if (!virgula) {
								sqlStr.append(" substring('").append(detalhe.getIdentificacaoTituloEmpresa()).append("', 1, 13) ");
								virgula = true;
							} else {
								sqlStr.append(", substring('").append(detalhe.getIdentificacaoTituloEmpresa()).append("', 1, 13) ");
							}
						}
					}
				}
				sqlStr.append(" )");
				if (virgula) {
					tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
					while (tabelaResultado.next()) {
						ContaReceberVO contaReceber = montarDadosTelaControleCobranca(tabelaResultado);
						if (contaReceber.getNossoNumero().contains("P")) {
							resultado.put(new BigInteger(contaReceber.getNossoNumero().replace("P", "")), contaReceber);
						} else {
							resultado.put(new BigInteger(contaReceber.getNossoNumero()), contaReceber);
						}
					}
				}
			}

			if (registroArquivoVO.getRegistroDetalheVOs().size() != resultado.size()) {

				virgula = false;
				StringBuilder sqlStrTemp = new StringBuilder();
				for (RegistroDetalheVO detalhe : registroArquivoVO.getRegistroDetalheVOs()) {
					if (detalhe != null) {
						if (!detalhe.getIdentificacaoTituloEmpresa().trim().isEmpty()) {
							if (detalhe.getContaReceberAgrupada()) {
								continue;
							}
							if (!virgula) {
								sqlStrTemp.append(" '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
								virgula = true;
							} else {
								sqlStrTemp.append(", '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
							}
						}
					}
				}
				sqlStrTemp.append(" )");

				sqlStr = new StringBuilder("SELECT nrdocumento, ");
				sqlStr.append(" case ");
				sqlStr.append(" when contarecebernossonumero.nossonumero1 in(").append(sqlStrTemp.toString()).append(" then contarecebernossonumero.nossonumero1 ");
				sqlStr.append(" when contarecebernossonumero.nossonumero2 in(").append(sqlStrTemp.toString()).append(" then contarecebernossonumero.nossonumero2 ");
				sqlStr.append(" when contarecebernossonumero.nossonumero3 in(").append(sqlStrTemp.toString()).append(" then contarecebernossonumero.nossonumero3 ");
				sqlStr.append(" when contarecebernossonumero.nossonumero4 in(").append(sqlStrTemp.toString()).append(" then contarecebernossonumero.nossonumero4 ");
				sqlStr.append(" when contarecebernossonumero.nossonumero5 in(").append(sqlStrTemp.toString()).append(" then contarecebernossonumero.nossonumero5 ");
				sqlStr.append(" end as nossonumero, ");
				sqlStr.append(" valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
				sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
				sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
				sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
				sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
				sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
				sqlStr.append("LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
				sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
				sqlStr.append("INNER JOIN contarecebernossonumero on (contarecebernossonumero.nossonumero1 = cr.nossonumeroantigo or contarecebernossonumero.nossonumero2 = cr.nossonumeroantigo or contarecebernossonumero.nossonumero3 = cr.nossonumeroantigo or contarecebernossonumero.nossonumero4 = cr.nossonumeroantigo or contarecebernossonumero.nossonumero5 = cr.nossonumeroantigo) ");
				sqlStr.append(" WHERE cr.situacao <> 'NE' ");
				if (Uteis.isAtributoPreenchido(registroArquivoVO.getListaContaCorrenteVOs())) {
					 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(registroArquivoVO.getListaContaCorrenteVOs())).append(" )");
				}

				sqlStr.append(" AND (contarecebernossonumero.nossonumero1 in (").append(sqlStrTemp.toString());
				sqlStr.append(" OR contarecebernossonumero.nossonumero2 in (").append(sqlStrTemp.toString());
				sqlStr.append(" OR contarecebernossonumero.nossonumero3 in (").append(sqlStrTemp.toString());
				sqlStr.append(" OR contarecebernossonumero.nossonumero4 in (").append(sqlStrTemp.toString());
				sqlStr.append(" OR contarecebernossonumero.nossonumero5 in (").append(sqlStrTemp.toString()).append(") ");

				if (virgula) {
					tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
					//// System.out.println(sqlStr.toString());
					while (tabelaResultado.next()) {
						ContaReceberVO contaReceber = montarDadosTelaControleCobranca(tabelaResultado);
						if (contaReceber.getNossoNumero().contains("P")) {
							resultado.put(new BigInteger(contaReceber.getNossoNumero().replace("P", "")), contaReceber);
						} else {
							resultado.put(new BigInteger(contaReceber.getNossoNumero()), contaReceber);
						}
					}
				}
			}
			/*
			 * Consulta em nossonumerocontareceber se existe registro do nossonumero.
			 * 
			 */
			if (registroArquivoVO.getRegistroDetalheVOs().size() != resultado.size()) {
				sqlStr = new StringBuilder("");
				sqlStr.append(" SELECT distinct nncc.nossonumero as nossonumeroantigo, cr.nrdocumento, cr.nossonumero, cr.valor, cr.valorrecebido, cr.datavencimento, cr.taxaBoleto, cr.situacao, cr.updated, p.nome,  ");
				sqlStr.append(" cr.matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\",  ");
				sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"  ");
				sqlStr.append(" FROM NossoNumeroContaReceber nncc ");
				sqlStr.append(" LEFT JOIN matriculaPeriodo mp on mp.codigo = nncc.matriculaperiodo ");
				sqlStr.append(" LEFT JOIN matricula m ON mp.matricula = m.matricula  ");
				sqlStr.append(" LEFT JOIN pessoa p ON m.aluno = p.codigo ");
				sqlStr.append(" left join contareceber cr on cr.matriculaperiodo = mp.codigo and cr.parcela = nncc.parcela and extract(month from cr.dataVencimento) = extract(month from nncc.dataVencimento) and extract(year from cr.dataVencimento) = extract(year from nncc.dataVencimento) and nncc.tipoorigem = cr.tipoorigem ");
				if (Uteis.isAtributoPreenchido(registroArquivoVO.getListaContaCorrenteVOs())) {
					 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(registroArquivoVO.getListaContaCorrenteVOs())).append(" )");
				}
				sqlStr.append(" LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro  ");
				sqlStr.append(" LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo  ");
				sqlStr.append(" LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");

				sqlStr.append(" WHERE (nncc.nossonumero in ( ");
				virgula = false;
				String listaNossoNumero = "";
				for (RegistroDetalheVO detalhe : registroArquivoVO.getRegistroDetalheVOs()) {
					if (!detalhe.getIdentificacaoTituloEmpresa().trim().isEmpty()) {
						if (detalhe.getContaReceberAgrupada()) {
							continue;
						}
						String identificacao = detalhe.getIdentificacaoTituloEmpresa();
						if (!detalhe.getIdentificacaoTituloEmpresa().equals("")) {
							if (identificacao.contains("P")) {
								identificacao = identificacao.replace("P", "");
							}
							ContaReceberVO cr = resultado.get(new BigInteger(identificacao));
							if (cr == null) {
								if (!virgula) {
									sqlStr.append(" '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
									listaNossoNumero = " '" + detalhe.getIdentificacaoTituloEmpresa() + "' ";
									virgula = true;
								} else {
									sqlStr.append(", '").append(detalhe.getIdentificacaoTituloEmpresa()).append("' ");
									listaNossoNumero += ", '" + detalhe.getIdentificacaoTituloEmpresa() + "' ";
								}
							}
						}
					}
				}
				sqlStr.append(" )");
				if (virgula) {
					sqlStr.append(" or '00'||nncc.nossonumero in (");
					sqlStr.append(listaNossoNumero);
					sqlStr.append(") or '000'||nncc.nossonumero in ( ");
					sqlStr.append(listaNossoNumero);
					sqlStr.append(") or '0000'||nncc.nossonumero in ( ");
					sqlStr.append(listaNossoNumero);
					sqlStr.append(") or '00000'||nncc.nossonumero in ( ");
					sqlStr.append(listaNossoNumero);
					sqlStr.append(") or '000000'||nncc.nossonumero in ( ");
					sqlStr.append(listaNossoNumero);
					sqlStr.append(") ");
				}
				sqlStr.append(") ");
				if (virgula) {
					tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
					while (tabelaResultado.next()) {
						if (tabelaResultado.getString("nossonumero") == null) {
							continue;
						}
						ContaReceberVO contaReceber = montarDadosTelaControleCobranca(tabelaResultado);
						String nossonumeroantigo = tabelaResultado.getString("nossonumeroantigo");
						if (nossonumeroantigo.contains("P")) {
							resultado.put(new BigInteger(nossonumeroantigo.replace("P", "")), contaReceber);
						} else {
							resultado.put(new BigInteger(nossonumeroantigo), contaReceber);
						}
					}
				}
			}			
			return resultado;
		} catch (Exception e) {
			throw e;
		} finally {
			sqlStr = null;

		}
		}
	}

	/*
	 * public ContaReceberVO montarDadosControleCobranca(SqlRowSet dadosSQL, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) { ContaReceberVO obj = new ContaReceberVO(); obj.setCodigo(dadosSQL.getInt("codigo")); obj.setDataVencimento(dadosSQL.getDate("dataVencimento")); obj.setSituacao(dadosSQL.getString("situacao")); return obj; }
	 */

	public ContaReceberVO consultarPorNossoNumeroBB(String nossoNumero, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE (contareceber.codigo = ?)");
		sql.append(" AND (nossonumero = '").append(nossoNumero).append("' OR ");
		sql.append(" nossonumero = substring('").append(nossoNumero).append("', 8, length('").append(nossoNumero).append("')) OR ");
		sql.append("nossonumero = '0'||substring('").append(nossoNumero).append("', 9, length('").append(nossoNumero).append("')) )");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), new Object[] { nossoNumero });
		ContaReceberVO contaReceberVO = new ContaReceberVO();
		if (tabelaResultado.next()) {
			tabelaResultado.beforeFirst();
			contaReceberVO = new ContaReceberVO();
			montarDadosBasico(contaReceberVO, tabelaResultado);
		}
		return contaReceberVO;

		// String sqlStr = "SELECT * FROM contareceber WHERE nossonumero = '" +
		// nossoNumero + "' OR "
		// + "nossonumero = substring('" + nossoNumero + "', 8, length('" +
		// nossoNumero + "')) OR "
		// + "nossonumero = '0'||substring('" + nossoNumero + "', 9, length('" +
		// nossoNumero + "'))";
		// SqlRowSet tabelaResultado =
		// getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		//
		// // Caso não encontre a conta, ele procura esse nossoNumero em uma
		// tabela chamada contaReceber2
		// // que contém dados de uma base antiga.
		// // String sqlStr2 =
		// "SELECT contareceber2.* FROM ContaReceber2 WHERE ";
		// // sqlStr2 +=
		// "(substring(nossonumero, 0, length(nossonumero) - 1) = '" +
		// nossoNumero + "' ";
		// // sqlStr2 += "or nossonumero = '" + nossoNumero +
		// "') and nossonumero <> ''";
		//
		// try {
		// if (tabelaResultado.next()) {
		// return montarDados(tabelaResultado, nivelMontarDados,
		// configuracaoFinanceiroVO, usuario);
		// }
		// // SqlRowSet tabelaResultado2 =
		// getConexao().getJdbcTemplate().queryForRowSet(sqlStr2);
		// // if (tabelaResultado2.next()) {
		// // Ao encontrar a conta na tabela contaReceber2, temos que encontrar
		// a conta correspondente,
		// // que foi gerada com os dados diferentes na tabela contaReceber.
		// // return
		// consultarContaCorrespondenteTabelaContaReceber(montarDados(tabelaResultado2,
		// Uteis.NIVELMONTARDADOS_DADOSMINIMOS), nivelMontarDados);
		// // }
		// return new ContaReceberVO();

		// } finally {
		// sqlStr = null;
		// // sqlStr2 = null;
		// }
	}

	public ContaReceberVO consultarContaCorrespondenteTabelaContaReceber(ContaReceberVO contaReceberVO, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		String sqlStr = "";
		// Se a parcela for de Matrícula, procura a conta somente pelo código de
		// origem.
		if (contaReceberVO.getParcela().equals("Matrícula")) {
			sqlStr = "SELECT * FROM contareceber WHERE codOrigem = '" + contaReceberVO.getCodOrigem() + "' ";
		} else {
			if (contaReceberVO.getParcela().contains("/")) {
				// Se não for uma parcela de matrícula, as parcelas são
				// divididas pela barra separadora,
				// Ex.: '02/07' separa para 02 e 07
				// E são comparadas como inteiros, ignorando também o zero a
				// esquerda, pois na alteração
				// da conta, a parcela que seria '02/07' pode se transformar em
				// '2/7'
				sqlStr = "SELECT * FROM contareceber WHERE codOrigem = '" + contaReceberVO.getCodOrigem() + "' AND " + "split_part(parcela, '/', 1)::integer = split_part('" + contaReceberVO.getParcela() + "', '/', 1)::integer AND " + "split_part(parcela, '/', 2)::integer = split_part('" + contaReceberVO.getParcela() + "', '/', 2)::integer AND " + "parcela <> 'Matrícula' AND parcela !~* '[a-zA-Z]'";
			} else {
				sqlStr = "SELECT * FROM contareceber WHERE codOrigem = '" + contaReceberVO.getCodOrigem() + "' AND " + "split_part(parcela, '/', 1)::integer = split_part('" + contaReceberVO.getParcela() + "', '/', 1)::integer AND " + "parcela <> 'Matrícula' AND parcela !~* '[a-zA-Z]'";
			}
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return montarDados(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
		}
		return new ContaReceberVO();
	}

	public Integer consultarQtdeContasPorMatriculaPeriodo(Integer codMatriculaPeriodo, String tipoOrigem1, String tipoOrigem2, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("select count(codigo) AS qtde from ContaReceber WHERE matriculaPeriodo = " + codMatriculaPeriodo.intValue());
		if (!tipoOrigem1.equals("")) {
			sqlStr.append(" AND (tipoOrigem = '").append(tipoOrigem1.toUpperCase()).append("'");
		}
		if (!tipoOrigem2.equals("")) {
			if (!tipoOrigem1.equals("")) {
				sqlStr.append(" OR tipoOrigem = '").append(tipoOrigem2.toUpperCase()).append("')");
			} else {
				sqlStr.append(" AND tipoOrigem = '").append(tipoOrigem2.toUpperCase()).append("'");
			}
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("qtde");
		} else {
			return 0;
		}
	}

	/**
	 * Responsável por montar os dados de vários objetos, resultantes de uma consulta ao banco de dados ( <code>ResultSet</code>). Faz uso da operação <code>montarDados</code> que realiza o trabalho para um objeto por vez.
	 * 
	 * @return List Contendo vários objetos da classe <code>ContaReceberVO</code> resultantes da consulta.
	 */
	public static List<ContaReceberVO> montarDadosConsulta(SqlRowSet tabelaResultado, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> vetResultado = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			vetResultado.add(montarDados(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
		}
		return vetResultado;
	}

	public static ContaReceberVO montarDadosConsultaRapidaLog(SqlRowSet dadosSQL) throws Exception {
		ContaReceberVO obj = new ContaReceberVO();
		obj.setTipoPessoa(dadosSQL.getString("tipoPessoa"));
		obj.setCodigo(dadosSQL.getInt("codigo"));
		// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(dadosSQL.getInt("registrocobrancacontareceber"));
		obj.setData(dadosSQL.getDate("data"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setDataVencimento(dadosSQL.getDate("dataVencimento"));
		obj.setValor(dadosSQL.getDouble("valor"));
		obj.getPessoa().setCodigo(dadosSQL.getInt("pessoa"));
		obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor"));
		obj.getResponsavelFinanceiro().setCodigo(dadosSQL.getInt("responsavelFinanceiro"));
		obj.setNrDocumento(dadosSQL.getString("nrDocumento"));
		obj.setTipoOrigem(dadosSQL.getString("tipoOrigem"));
		obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeEnsino"));
		obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaPeriodo"));
		obj.setNovoObj(Boolean.FALSE);
		obj.getMatriculaAluno().setMatricula(dadosSQL.getString("matriculaAluno"));
		obj.getFuncionario().setCodigo(dadosSQL.getInt("funcionario"));
		obj.getCandidato().setCodigo(dadosSQL.getInt("candidato"));
		obj.getConvenio().setCodigo(dadosSQL.getInt("convenio"));
		obj.getParceiroVO().setCodigo(dadosSQL.getInt("parceiro"));
		obj.setValorRecebido(dadosSQL.getDouble("valorRecebido"));
		obj.setJuro(dadosSQL.getDouble("juro"));
		obj.setDescricaoPagamento(dadosSQL.getString("descricaoPagamento"));
		obj.setCodOrigem(dadosSQL.getString("codOrigem"));
		obj.setJuroPorcentagem(dadosSQL.getDouble("juroPorcentagem"));
		obj.setMulta(dadosSQL.getDouble("multa"));
		obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
		obj.setMultaPorcentagem(dadosSQL.getDouble("multaPorcentagem"));
		obj.setParcela(dadosSQL.getString("parcela"));
		obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoProgressivo"));
		obj.setValorDescontoRecebido(dadosSQL.getDouble("valorDescontoRecebido"));
		obj.setTipoDesconto(dadosSQL.getString("tipoDesconto"));
		obj.setDataArquivoRemessa(dadosSQL.getDate("dataArquivoRemessa"));

		obj.setDescontoProgressivoUtilizado(FaixaDescontoProgressivo.getEnum(dadosSQL.getString("descontoprogressivoutilizado")));
		obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
		obj.setDuplicidadeTratada(dadosSQL.getBoolean("duplicidadeTratada"));
		obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
		obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
		obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
		obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
		obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
		obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
		obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
		obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
		obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
		obj.setJustificativaDesconto(dadosSQL.getString("justificativaDesconto"));
		obj.setValorDescontoLancadoRecebimento(dadosSQL.getDouble("valorDescontoLancadoRecebimento"));
		obj.setValorCalculadoDescontoLancadoRecebimento(dadosSQL.getDouble("valorCalculadoDescontoLancadoRecebimento"));
		obj.setTipoDescontoLancadoRecebimento(dadosSQL.getString("tipoDescontoLancadoRecebimento"));
		obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
		obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));
		obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoPrimeiraFaixaDescontos"));
		obj.setValorDescontoCalculadoSegundaFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoSegundaFaixaDescontos"));
		obj.setValorDescontoCalculadoTerceiraFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoTerceiraFaixaDescontos"));
		obj.setValorDescontoCalculadoQuartaFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoQuartaFaixaDescontos"));
		obj.setValorDescontoInstituicao(dadosSQL.getDouble("descontoInstituicao"));
		obj.setValorDescontoConvenio(dadosSQL.getDouble("descontoConvenio"));
		obj.setValorDescontoRateio(dadosSQL.getDouble("valorDescontoRateio"));
		obj.setValorDescontoProgressivo(dadosSQL.getDouble("valorDescontoProgressivo"));
		obj.setContaCorrente(dadosSQL.getInt("contaCorrente"));
		obj.getCentroReceita().setCodigo(dadosSQL.getInt("centroReceita"));
		obj.setOrigemNegociacaoReceber(dadosSQL.getInt("origemNegociacaoReceber"));
		obj.setTipoBoleto(dadosSQL.getString("tipoboleto"));
		obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhaDigitavelCodigoBarras"));
		obj.setCodigoBarra(dadosSQL.getString("codigoBarra"));
		obj.setNossoNumero(dadosSQL.getString("nossonumero"));
		obj.setNossoNumeroBanco(dadosSQL.getString("nossonumerobanco"));
		obj.setTituloImportadoSistemaLegado(dadosSQL.getBoolean("tituloImportadoSistemaLegado"));
		obj.setRecebimentoBancario((Boolean) dadosSQL.getObject("recebimentoBancario"));
		return obj;

	}

	/**
	 * Responsável por montar os dados resultantes de uma consulta ao banco de dados (<code>ResultSet</code>) em um objeto da classe <code>ContaReceberVO</code>.
	 * 
	 * @return O objeto da classe <code>ContaReceberVO</code> com os dados devidamente montados.
	 * @deprecated 26-09-2010
	 */
	public static ContaReceberVO montarDados(SqlRowSet dadosSQL, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		ContaReceberVO obj = new ContaReceberVO();
		obj.setNovoObj(Boolean.FALSE);
		obj.setTipoPessoa(dadosSQL.getString("tipoPessoa"));
		obj.setCodigo(dadosSQL.getInt("codigo"));
		// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(dadosSQL.getInt("registrocobrancacontareceber"));
		obj.setData(dadosSQL.getDate("data"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setDataVencimento(dadosSQL.getDate("dataVencimento"));
		obj.setDataCompetencia(dadosSQL.getDate("dataCompetencia"));
		obj.setDataProcessamentoValorReceber(dadosSQL.getDate("dataProcessamentoValorReceber"));
		obj.setValor(dadosSQL.getDouble("valor"));
		obj.getPessoa().setCodigo(dadosSQL.getInt("pessoa"));
		obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor"));
		obj.getResponsavelFinanceiro().setCodigo(dadosSQL.getInt("responsavelFinanceiro"));
		obj.setNrDocumento(dadosSQL.getString("nrDocumento"));
		obj.setTipoOrigem(dadosSQL.getString("tipoOrigem"));
		obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeEnsino"));
		obj.getUnidadeEnsinoFinanceira().setCodigo(dadosSQL.getInt("unidadeEnsinoFinanceira"));
		obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaPeriodo"));
		obj.setContaReceberAgrupada(dadosSQL.getInt("contaReceberAgrupada"));	
		obj.getMatriculaAluno().setMatricula(dadosSQL.getString("matriculaAluno"));
		obj.getFuncionario().setCodigo(dadosSQL.getInt("funcionario"));
		obj.getCandidato().setCodigo(dadosSQL.getInt("candidato"));
		obj.getConvenio().setCodigo(dadosSQL.getInt("convenio"));
		obj.getParceiroVO().setCodigo(dadosSQL.getInt("parceiro"));
		obj.setValorRecebido(dadosSQL.getDouble("valorRecebido"));
		obj.setJuro(dadosSQL.getDouble("juro"));
		obj.setDescricaoPagamento(dadosSQL.getString("descricaoPagamento"));
		obj.setCodOrigem(dadosSQL.getString("codOrigem"));
		obj.setJuroPorcentagem(dadosSQL.getDouble("juroPorcentagem"));
		obj.setMulta(dadosSQL.getDouble("multa"));
		obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
		obj.setMultaPorcentagem(dadosSQL.getDouble("multaPorcentagem"));
		obj.setValorIndiceReajustePorAtraso(dadosSQL.getBigDecimal("valorIndiceReajustePorAtraso"));
		obj.setLiberadoDoIndiceReajustePorAtraso(dadosSQL.getBoolean("liberadoDoIndiceReajustePorAtraso"));
		obj.setParcela(dadosSQL.getString("parcela"));
		obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoProgressivo"));
		obj.setValorDescontoRecebido(dadosSQL.getDouble("valorDescontoRecebido"));
		obj.setValorDescontoRateio(dadosSQL.getDouble("valorDescontoRateio"));
		obj.setTipoDesconto(dadosSQL.getString("tipoDesconto"));
		obj.setDataArquivoRemessa(dadosSQL.getDate("dataArquivoRemessa"));
		obj.getProcessamentoIntegracaoFinanceiraDetalheVO().setCodigo(dadosSQL.getInt("processamentointegracaofinanceiradetalhe"));
		if (!Uteis.isAtributoPreenchido(obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getCodigo())) {
			obj.setValorReceberCalculado(dadosSQL.getDouble("valorReceberCalculado"));
		}else {
			obj.setProcessamentoIntegracaoFinanceiraDetalheVO(getFacadeFactory().getIntegracaoFinanceiroFacade().consultaPorCodigoProcessamentoIntegracaoFinanceiro(obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getCodigo()));
			obj.setValorReceberCalculado(obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getValorReceber());
		}

		obj.setDescontoProgressivoUtilizado(FaixaDescontoProgressivo.getEnum(dadosSQL.getString("descontoprogressivoutilizado")));
		obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
		obj.setDuplicidadeTratada(dadosSQL.getBoolean("duplicidadeTratada"));
		obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
		obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
		obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
		obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
		obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
		obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
		obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
		obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));

		obj.setContaEditadaManualmente(dadosSQL.getBoolean("contaEditadaManualmente"));
		obj.setUtilizarDescontoProgressivoManual(dadosSQL.getBoolean("utilizarDescontoProgressivoManual"));
		if (obj.getUtilizarDescontoProgressivoManual()) {
			obj.setDiaLimite1(dadosSQL.getInt("diaLimite1"));
			obj.setDiaLimite2(dadosSQL.getInt("diaLimite2"));
			obj.setDiaLimite3(dadosSQL.getInt("diaLimite3"));
			obj.setDiaLimite4(dadosSQL.getInt("diaLimite4"));
		}

		obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
		obj.setValorDescontoCalculado(dadosSQL.getDouble("valorDescontoCalculado"));
		obj.setValorCusteadoContaReceber(dadosSQL.getDouble("valorCusteadoContaReceber"));
		obj.setValorBaseContaReceber(dadosSQL.getDouble("valorBaseContaReceber"));
		obj.setJustificativaDesconto(dadosSQL.getString("justificativaDesconto"));
		obj.setValorDescontoLancadoRecebimento(dadosSQL.getDouble("valorDescontoLancadoRecebimento"));
		obj.setValorCalculadoDescontoLancadoRecebimento(dadosSQL.getDouble("valorCalculadoDescontoLancadoRecebimento"));
		obj.setTipoDescontoLancadoRecebimento(dadosSQL.getString("tipoDescontoLancadoRecebimento"));
		obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
		obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));
		obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoPrimeiraFaixaDescontos"));
		obj.setValorDescontoCalculadoSegundaFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoSegundaFaixaDescontos"));
		obj.setValorDescontoCalculadoTerceiraFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoTerceiraFaixaDescontos"));
		obj.setValorDescontoCalculadoQuartaFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoQuartaFaixaDescontos"));

		obj.setPlanoDescontoContaReceberVOs(PlanoDescontoContaReceber.consultarItensPlanoDescontoContaReceber(obj.getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, usuario));
		obj.setUpdated(dadosSQL.getTimestamp("updated"));
		obj.setUsaDescontoCompostoPlanoDesconto(dadosSQL.getBoolean("usaDescontoCompostoPlanoDesconto"));
		obj.setPossuiPendenciasFinanceirasExternas(dadosSQL.getBoolean("possuiPendenciasFinanceirasExternas"));
		obj.setPossuiFiesIntegracaoFinanceiras(dadosSQL.getBoolean("possuiFiesIntegracaoFinanceiras"));
		obj.getProcessamentoIntegracaoFinanceiraDetalheVO().setCodigo(dadosSQL.getInt("processamentoIntegracaoFinanceiraDetalhe"));

		if (obj.getSituacaoEQuitada()) {
			// Se o titulo esta quitado temos que considerar os descontos
			// calculados,
			// na data da quitacao, nao chamando o método que monta a lista de
			// desconto
			// aplicaveis, considerando a quantidade de dias que falta para o
			// vencimento.
			obj.setValorDescontoInstituicao(dadosSQL.getDouble("descontoInstituicao"));
			obj.setValorDescontoConvenio(dadosSQL.getDouble("descontoConvenio"));
			obj.setValorDescontoProgressivo(dadosSQL.getDouble("valorDescontoProgressivo"));
		} else {
			// Monta a lista de descontos validos para a conta a receber.
			// Adicionalmente, com base na quantidade
			// de dias que faltam para o vencimento do titulo a rotina tambem já
			// define quais descontos devem
			// ser aplicadas para a conta receber, inicializando os mesmos nos
			// devidos campos
			// descontoConvenio, descontoProgressivo, descontoAluno,
			// descontoInstituicao
			montarListaDescontosAplicaveisContaReceber(obj, new Date(), obj.getUsaDescontoCompostoPlanoDesconto(), configuracaoFinanceiro, usuario, null);
			if (obj.getValorReceberCalculado().equals(0.0)) {
				obj.getCalcularValorFinal(new Date(), configuracaoFinanceiro, false, new Date(), usuario);
			}
		}
		obj.setContaCorrente(dadosSQL.getInt("contaCorrente"));
		obj.getCentroReceita().setCodigo(dadosSQL.getInt("centroReceita"));
		obj.setOrigemNegociacaoReceber(dadosSQL.getInt("origemNegociacaoReceber"));
		obj.setTipoBoleto(dadosSQL.getString("tipoboleto"));
		obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhaDigitavelCodigoBarras"));
		obj.setCodigoBarra(dadosSQL.getString("codigoBarra"));
		obj.setNossoNumero(dadosSQL.getString("nossonumero"));
		obj.setNossoNumeroBanco(dadosSQL.getString("nossonumerobanco"));
		obj.setTituloImportadoSistemaLegado(dadosSQL.getBoolean("tituloImportadoSistemaLegado"));
		obj.setRecebimentoBancario((Boolean) dadosSQL.getObject("recebimentoBancario"));
		obj.setValorJuroCalculado(dadosSQL.getDouble("valorjurocalculado"));
		obj.setValorMultaCalculado(dadosSQL.getDouble("valormultacalculado"));

		if (obj.getTipoAluno()) {
			montarDadosMatriculaAluno(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuario);
			obj.setBloquearPagamentoVisaoAluno(obj.getMatriculaAluno().getBloquearEmissaoBoletoMatMenVisaoAluno());
			obj.setPessoa(obj.getMatriculaAluno().getAluno());
		}
		if (obj.getTipoFuncionario()) {
			montarDadosFuncionario(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
			obj.setPessoa(obj.getFuncionario().getPessoa());
		}
		if (obj.getTipoCandidato()) {
			montarDadosCandidato(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
			obj.setPessoa(obj.getCandidato());
		}
		if (obj.getTipoRequerente()) {
			montarDadosPessoa(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
		}
		if (obj.getTipoFornecedor()) {
			montarDadosFornecedor(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		}
		if (obj.getTipoParceiro()) {
			montarDadosParceiro(obj, nivelMontarDados, usuario);
			montarDadosConvenio(obj, nivelMontarDados, usuario);
		}
		if (obj.getTipoResponsavelFinanceiro()) {
			montarDadosMatriculaAluno(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuario);
			if (obj.getMatriculaAluno().getAluno().getCodigo() > 0) {
				obj.setPessoa(obj.getMatriculaAluno().getAluno());
			}
			montarDadosResponsavelFinanceiro(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
		}
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_DADOSMINIMOS) {
			return obj;
		}
		montarDadosDescontoProgressivo(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);

		if (obj.getUtilizarDescontoProgressivoManual()) {
			obj.getDescontoProgressivo().setDescontoProgressivoEditadoManualmenteContaReceber(Boolean.TRUE);
			obj.getDescontoProgressivo().setDiaLimite1(obj.getDiaLimite1());
			obj.getDescontoProgressivo().setDiaLimite2(obj.getDiaLimite2());
			obj.getDescontoProgressivo().setDiaLimite3(obj.getDiaLimite3());
			obj.getDescontoProgressivo().setDiaLimite4(obj.getDiaLimite4());
		}

		montarDadosContaCorrente(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		obj.getBeneficiario().setCodigo(dadosSQL.getInt("beneficiario"));
		montarDadosUnidadeEnsino(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		obj.setUnidadeEnsinoFinanceira(Uteis.montarDadosVO(dadosSQL.getInt("unidadeEnsinoFinanceira"), UnidadeEnsinoVO.class, p -> getFacadeFactory().getUnidadeEnsinoFacade().consultarPorChavePrimaria(p, false, nivelMontarDados, usuario)));
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_DADOSBASICOS) {
			return obj;
		}

		obj.setLancamentoContabil(getFacadeFactory().getConfiguracaoContabilFacade().consultaSeExisteConfiguracaoContabilPorCodigoUnidadeEnsino(obj.getUnidadeEnsino().getCodigo(), usuario));
		obj.setContaReceberRecebimentoVOs(getFacadeFactory().getContaReceberRecebimentoFacade().consultarContaReceberPorRecebimentos(obj.getCodigo(), nivelMontarDados, usuario));
		obj.setListaLancamentoContabeisCredito(getFacadeFactory().getLancamentoContabilFacade().consultaRapidaPorCodOrigemPorTipoOrigemPorTipoPlanoConta(obj.getCodigo().toString(), TipoOrigemLancamentoContabilEnum.RECEBER, TipoPlanoContaEnum.CREDITO, false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
		obj.setListaLancamentoContabeisDebito(getFacadeFactory().getLancamentoContabilFacade().consultaRapidaPorCodOrigemPorTipoOrigemPorTipoPlanoConta(obj.getCodigo().toString(), TipoOrigemLancamentoContabilEnum.RECEBER, TipoPlanoContaEnum.DEBITO, false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
		obj.setListaCentroResultadoOrigem(getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().consultaRapidaPorCodOrigemPorTipoCentroResultadoOrigemEnum(obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, Uteis.NIVELMONTARDADOS_TODOS, usuario));
		obj.setDetalhamentoValorContaVOs(getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().consultaRapidaPorOrigemCodigoOrigemConta(OrigemDetalhamentoContaEnum.CONTA_RECEBER, obj.getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
		obj.setIndiceReajustePadraoPorAtraso(Uteis.montarDadosVO(dadosSQL.getInt("indiceReajustePadraoPorAtraso"), IndiceReajusteVO.class, p -> getFacadeFactory().getIndiceReajusteFacade().consultarPorChavePrimaria(p, Uteis.NIVELMONTARDADOS_TODOS, usuario)));
		montarDadosTurma(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosCentroReceita(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosMatriculaAluno(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiro, usuario);
		montarDadosFuncionario(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosCandidato(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosConvenio(obj, nivelMontarDados, usuario);
		montarDadosBeneficiario(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		if (obj.getTipoRequerente()) {
			montarDadosPessoa(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		}

		return obj;
	}

	/**
	 * Um convenio pode ser configurado no SEI para ter o seu valor de desconto (quanto o aluno deixará de pagar) para que outra entidade pague (por exemplo a OVG ou FIES) abatido do valor da parcela do aluno. Ou seja, se a parcela total é de R$ 800,00 e o convênio irá custear R$ 300,00, então a parcela do aluno deverá ser gerada no final no valor de R$ 500,00 (com os R$ 300,00 abatidos no total de mesma). Isto é melhor pois o SEI irá gerar um parcela de R$ 300,00 para a entidade conveniada. Logo o faturamenta da Instituição de ensino com esta parcela será no total de R$ 800,00. E não teremos nenhum desconto gerado de forma desnecessária. Quando criamos um convênio que não abate no valor do aluno, temos a seguinte dificuldade. O sistema gerá para o aluno uma parcela de R$ 800,00 com desconto de R$ 300,00. E mais um boleto de R$ 300,00 para conveniada. Com isto gera-se a falsa sensação de que a instituição faturou R$ 1.100,00 e deu R$ 300,00 de desconto - dificultanto a avaliação dos dados financeiros no
	 * painel gestor e relatórios
	 * 
	 * ======================================================= LÓGICA DE IMPLEMENTACAO DESTA ROTINA: Ao entrar nesta rotina todos os descontos do convênio foram calculados e estão armazenados no atributo contaReceber.valorDescontoConvenio (o no caso o valor total) e na lista this.listaDescontosAplicavesContaReceber.listaDescontoConvenio que traz a lista de todos os convenio com o valor individual de cada um dos convênios. Contudo, nenhum valor de convenio foi abatido do valor da parcela original, que precisa ser mantido até este local para que os cálculos funcionem adequadamente - é preciso lembrar que existe ordem de aplicação de descontos, definições sobre sobre qual base cada desconto / convenio será aplicado e outras configuracoes. -------------------------------------------------------
	 */
	public static void abaterValorDescontoConvenioNoValorContaReceberParaConvenioConfiguradosComEstaFinalidade(ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		// Ao entrar neste método o valorDescontoConvenio está totalizado o
		// valor de "desconto" de todos
		// os convenios, independentemente se o convênio deve ser abatido ou não
		// do total da parcela.
		// Por isto, iremos varrer os convênios que foram aplicados e caso o
		// mesmo esteja definido para
		// ser abatido, iremos:
		// 1. Abater do valor da parcela o valor do convênio
		// 2. Abater do valorDescontoConvenio o valor do convênio - pois o mesmo
		// não é para ser tratado como desconto
		// 3. Somar o valor do memo no atributo valorCusteadoContaReceber que
		// irá totalizar todo o valor custeado da conta a receber.

		// VALIDO
		obj.setValor(obj.getValorBaseContaReceber());
		for (PlanoFinanceiroAlunoDescricaoDescontosVO planoDescontosContaReceber : obj.getListaDescontosAplicavesContaReceber()) {
			// VAMOS ASSUMIR O PRIMEIRO PLANO COMO PADRÃO, POIS TENDE A SER O
			// PLANO A SER ADOTADO NA CONTA A RECEBER
			// NA DATA ATUAL. ASSIM, O VALOR DO CUSTEADO DO MESMO QUE SERÁ
			// ABATIDO DO VALOR DA CONTA A RECEBER. CONTUDO,
			// NO CASO DE CONVENIO, TODOS OS PLANOS VAO CONTER O MESMO VALOR
			// PARA A VARÍAVEL getValorCusteadoConvenio
			// ASSIM IREMOS EXECUTAR ESTA ROTINA SOMENTE PARA O PRIMEIRO PLANO
			// DE DESCONTO.
			if (planoDescontosContaReceber.getValorCusteadoContaReceber() > 0) {
				// Se entrarmos aqui é por que algum convênio foi configurado
				// para abater o valor do mesmo
				// no valor da parcela. Portanto, é necesssário registrar o
				// valor da parcela que está sendo
				// custeado pelo Convênio e diminuir o mesmo do valor final da
				// parcela.
				// 1. Armazenar o valor original da conta a receber (base) antes
				// de alterá-lo a abaixo
				obj.setValorBaseContaReceber(obj.getValor());
				// 2. Abater do valor da parcela o valor do convênio
				obj.setValor(Uteis.arrendondarForcando2CadasDecimais(obj.getValor() - planoDescontosContaReceber.getValorCusteadoContaReceber()));
				// 3. Registrar o valor do memo no atributo
				// valorCusteadoContaReceber que irá armazenars todo o valor
				// custeado da conta a receber.
				obj.setValorCusteadoContaReceber(Uteis.arrendondarForcando2CadasDecimais(planoDescontosContaReceber.getValorCusteadoContaReceber()));
			}
			break;
		}
	}

	public static void montarListaDescontosAplicaveisContaReceber(ContaReceberVO obj, Date dataReferenciaConsiderarBaixaTitulo, Boolean usaDescontoCompostoPlanoDesconto, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario, Integer diasVariacaoDataVencimento) throws Exception {
		if (obj.getSituacaoEQuitada()) {
			// Se o título está quitado não temos que gerar a lista com
			// possíveis descontos
			// a serem aplicados na conta a receber. Isto por que os descontos a
			// serem aplicados,
			// já foram feitos no momento da quitação do titulo.
			return;
		}
		if ((obj.getTipoOrigem().equals("MAT") || obj.getTipoOrigem().equals("MEN") || obj.getTipoOrigem().equals(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor())) && obj.getMatriculaAluno().getPlanoFinanceiroAluno().getDescontoValidoAteDataParcela() && obj.getRealizandoRecebimento()) {
			if (Uteis.getDateSemHora(obj.getDataVencimento()).before(Uteis.getDateSemHora(dataReferenciaConsiderarBaixaTitulo))) {
				obj.setValorDescontoAlunoJaCalculado(0.0);
			}
		}
		
		if ((obj.getValorBaseContaReceber() == null) || (obj.getValorBaseContaReceber().equals(0.0))) {
			obj.setValorBaseContaReceber(obj.getValor() + obj.getValorCusteadoContaReceber());
		}		
		obj.setListaDescontosAplicavesContaReceber(gerarListaPlanoFinanceiroAlunoDescricaoDesconto(obj, dataReferenciaConsiderarBaixaTitulo, usaDescontoCompostoPlanoDesconto, diasVariacaoDataVencimento, usuario, configuracaoFinanceiroVO));
		/**
		 * Este foi adicionado para resolver a aplicação do desconto do aluno quando a conta a receber está vencida e este desconto é sempre valido, então altera a informação da Data Limite Aplicação Desconto para a data da baixa pois por default vinha a data de vencimento, onde ao validar o getIsAplicavelDataParaQuitacao(Date dataVencimento, Date dataReferenciaQuitacao) em PlanoFinanceiroAlunoDescricaoDescontosVO retornava false quando deveria ser true. Rodrigo Wind 20/05/2015 08:40 em atendimento a reclamações da LS e CIN.
		 */
		obj.setListaDescontosAplicavesContaReceber(realizarValidacaoGeracaoPlanoFinanceiroAlunoDescricaoDescontoAposVencimento(obj.getListaDescontosAplicavesContaReceber(), dataReferenciaConsiderarBaixaTitulo, obj.getDataVencimento(), obj.getTipoOrigem(), obj.getMatriculaAluno().getPlanoFinanceiroAluno().getDescontoValidoAteDataParcela(), configuracaoFinanceiroVO, obj.getUnidadeEnsino().getCidade().getCodigo()));
//		if (!obj.getListaDescontosAplicavesContaReceber().isEmpty()) {
//			PlanoFinanceiroAlunoDescricaoDescontosVO pfadd = obj.getListaDescontosAplicavesContaReceber().get(obj.getListaDescontosAplicavesContaReceber().size() - 1);
//			if (pfadd.getDiaNrAntesVencimento().equals(0) && pfadd.getValorDescontoAluno() > 0 && !pfadd.getReferentePlanoFinanceiroAposVcto()) {
//				if (Uteis.isAtributoPreenchido(dataReferenciaConsiderarBaixaTitulo) && dataReferenciaConsiderarBaixaTitulo.compareTo(obj.getDataVencimento()) >= 0) {
//					boolean gerarDescontoAlunoAposVencimento = false;
//					if ((obj.getTipoOrigem().equals("MAT") || obj.getTipoOrigem().equals("MEN") || obj.getTipoOrigem().equals(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor()))) {
//						if (!obj.getMatriculaAluno().getPlanoFinanceiroAluno().getDescontoValidoAteDataParcela()) {
//							gerarDescontoAlunoAposVencimento = true;
//						}
//					} else {
//						gerarDescontoAlunoAposVencimento = true;
//					}
//					if (gerarDescontoAlunoAposVencimento) {
//						if ((pfadd.getValorDescontoInstituicao() > 0 || pfadd.getValorDescontoProgressivo() > 0)) {
//							PlanoFinanceiroAlunoDescricaoDescontosVO clone = pfadd.clone();
//							if(clone.getReferentePlanoFinanceiroAteVencimento()) {
//								clone.setValorDescontoInstituicao(0.00);
//								clone.setPlanoDescontoVO(new PlanoDescontoVO());
//								clone.getListaDescontosPlanoDesconto().clear();
//								clone.setReferentePlanoFinanceiroAteVencimento(true);
//							}
//							clone.setReferentePlanoFinanceiroAposVcto(true);
//							clone.setDataLimiteAplicacaoDesconto(dataReferenciaConsiderarBaixaTitulo);
//							clone.setValorDescontoProgressivo(0.0);
//							clone.setTipoOrigemDesconto(PlanoFinanceiroAlunoDescricaoDescontosVO.TIPODESCONTOPADRAO);
//							obj.getListaDescontosAplicavesContaReceber().add(clone);
//						} else {
//							pfadd.setDataLimiteAplicacaoDesconto(dataReferenciaConsiderarBaixaTitulo);
//							pfadd.setTipoOrigemDesconto(PlanoFinanceiroAlunoDescricaoDescontosVO.TIPODESCONTOPADRAO);
//						}
//					} else {
//						pfadd.setReferentePlanoFinanceiroAteVencimento(true);
//					}
//				}
//			} else if ((obj.getTipoOrigem().equals("MAT") || obj.getTipoOrigem().equals("MEN") || obj.getTipoOrigem().equals(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor())) && pfadd.getReferentePlanoFinanceiroAposVcto() && obj.getMatriculaAluno().getPlanoFinanceiroAluno().getDescontoValidoAteDataParcela()) {
//				pfadd.setValorDescontoAluno(0.0);
//				if (pfadd.getValorDescontoConvenio().equals(0.0) && pfadd.getValorDescontoInstituicao().equals(0.0)) {
//					obj.getListaDescontosAplicavesContaReceber().remove(obj.getListaDescontosAplicavesContaReceber().size() - 1);
//				}
//			}			
//		}		
		getFacadeFactory().getContaReceberFacade().adicionarDescontoRateioEmPlanoFinanceiroAlunoDescricaoDescontosVO(obj.getListaDescontosAplicavesContaReceber(), obj.getValorBaseContaReceber(), obj.getValorCusteadoContaReceber(), obj.getValorDescontoRateio(), obj.getDataVencimento(), dataReferenciaConsiderarBaixaTitulo);
		validarRegrasParaFinanciamentoProprioConvenio(obj.getPlanoDescontoContaReceberVOs(), obj.getListaDescontosAplicavesContaReceber(), obj.getCodigo(), obj.getMatriculaAluno().getMatricula(),  obj.getTipoOrigem(), dataReferenciaConsiderarBaixaTitulo);
		obj.inicializarDescontosConsiderandoDataEspecificaParaQuitacao(dataReferenciaConsiderarBaixaTitulo);
		if(!obj.getPlanoDescontoConvenioCusteadoContaReceber().isEmpty() 
				&& obj.getPlanoDescontoConvenioCusteadoContaReceber().stream().anyMatch(p-> p.getConvenio().getParceiro().isFinanciamentoProprio())){
			obj.setValorParcelaComCusteioConvenio(obj.getValorBaseContaReceber());
			obj.setValor(obj.getValorBaseContaReceber() - obj.getValorCusteadoContaReceber());	
		}else if(!obj.getPlanoDescontoConvenioCusteadoContaReceber().isEmpty()){
			obj.setValorParcelaComCusteioConvenio(Uteis.arrendondarForcando2CadasDecimais(obj.getValor() + obj.getValorCusteadoContaReceber()));
		}
		if (obj.getAcrescimo() > 0.0) {
			for (PlanoFinanceiroAlunoDescricaoDescontosVO plano : obj.getListaDescontosAplicavesContaReceber()) {
				plano.setAcrescimo(obj.getAcrescimo());
			}
		}
	}
	
	public static List<PlanoFinanceiroAlunoDescricaoDescontosVO> realizarValidacaoGeracaoPlanoFinanceiroAlunoDescricaoDescontoAposVencimento(List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosAplicavesContaReceber, Date dataReferenciaConsiderarBaixaTitulo, Date dataVencimento, String tipoOrigem, Boolean planoDescontoAlunoValidoAteVencimento, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Integer cidade) throws Exception {
		//Adicionado regra para validar se a dataBase do vencimento esta em um dia util caso nao esteja e realizado a processo para colocar Antes alguma rotinas faziam essa verificacao e outras nao gerando assim uma incosistencia de dados no sistema entao foi
		// implementando nessa rotina para que assim todos que chamarem ela seja feita a validacao . Pedro Andrade 12/02/2018
		if (configuracaoFinanceiroVO.getVencimentoParcelaDiaUtil()) {
			dataVencimento = getFacadeFactory().getContaReceberFacade().obterDataVerificandoDiaUtil(dataVencimento,cidade, null);			
		}
		if (!listaDescontosAplicavesContaReceber.isEmpty()) {
			PlanoFinanceiroAlunoDescricaoDescontosVO pfadd = listaDescontosAplicavesContaReceber.get(listaDescontosAplicavesContaReceber.size() - 1);
			if (pfadd.getDiaNrAntesVencimento().equals(0) && pfadd.getValorDescontoAluno() > 0 && !pfadd.getReferentePlanoFinanceiroAposVcto()) {
//				if (Uteis.isAtributoPreenchido(dataReferenciaConsiderarBaixaTitulo) && dataReferenciaConsiderarBaixaTitulo.compareTo(dataVencimento) >= 0) {
					boolean gerarDescontoAlunoAposVencimento = false;
					if ((tipoOrigem.equals("MAT") || tipoOrigem.equals("MEN") || tipoOrigem.equals(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor()))) {
						if (!planoDescontoAlunoValidoAteVencimento) {
							gerarDescontoAlunoAposVencimento = true;
						}
					} else {
						gerarDescontoAlunoAposVencimento = true;
					}
					if (gerarDescontoAlunoAposVencimento) {
						if ((pfadd.getValorDescontoInstituicao() > 0 || pfadd.getValorDescontoProgressivo() > 0)) {
							PlanoFinanceiroAlunoDescricaoDescontosVO clone = pfadd.clone();
							if(clone.getReferentePlanoFinanceiroAteVencimento()) {								
								clone.setValorDescontoInstituicao(0.00);
								clone.setPlanoDescontoVO(new PlanoDescontoVO());
								clone.getListaDescontosPlanoDesconto().clear();
								clone.setReferentePlanoFinanceiroAteVencimento(true);
							}
							clone.setReferentePlanoFinanceiroAposVcto(true);
							if(dataReferenciaConsiderarBaixaTitulo.compareTo(dataVencimento) >= 0) {
								clone.setDataLimiteAplicacaoDesconto(dataReferenciaConsiderarBaixaTitulo);
							}else {
								clone.setDataLimiteAplicacaoDesconto(dataVencimento);
							}
							clone.setValorDescontoProgressivo(0.0);
							clone.setTipoOrigemDesconto(PlanoFinanceiroAlunoDescricaoDescontosVO.TIPODESCONTOPADRAO);
							listaDescontosAplicavesContaReceber.add(clone);
						} else {
							if(dataReferenciaConsiderarBaixaTitulo.compareTo(dataVencimento) >= 0) {
								pfadd.setDataLimiteAplicacaoDesconto(dataReferenciaConsiderarBaixaTitulo);
							}
							pfadd.setTipoOrigemDesconto(PlanoFinanceiroAlunoDescricaoDescontosVO.TIPODESCONTOPADRAO);
						}
					} else {
						pfadd.setReferentePlanoFinanceiroAteVencimento(true);
					}
//				}
			} else if ((tipoOrigem.equals("MAT") || tipoOrigem.equals("MEN") || tipoOrigem.equals(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor())) && pfadd.getReferentePlanoFinanceiroAposVcto() && planoDescontoAlunoValidoAteVencimento) {
				pfadd.setValorDescontoAluno(0.0);
				if (pfadd.getValorDescontoConvenio().equals(0.0) && pfadd.getValorDescontoInstituicao().equals(0.0)) {
					listaDescontosAplicavesContaReceber.remove(listaDescontosAplicavesContaReceber.size() - 1);
				}
			}			
		}	
		return listaDescontosAplicavesContaReceber;
		
	}
	
	public static List<PlanoFinanceiroAlunoDescricaoDescontosVO> gerarListaPlanoFinanceiroAlunoDescricaoDesconto(ContaReceberVO contaReceberVO, Date dataRecebimentoContaAReceber, Boolean usaDescontoCompostoPlanoDesconto, Integer diasVariacaoDataVencimento, UsuarioVO usuario, ConfiguracaoFinanceiroVO conf) throws Exception {
		if (diasVariacaoDataVencimento == null) {
		    diasVariacaoDataVencimento = 0 ; //getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarDiasVariacaoDataVencimentoPeloCodigoContaReceber(contaReceberVO.getCodigo(), usuario);
			if (diasVariacaoDataVencimento < 0) {
				diasVariacaoDataVencimento = 0;
			}
		}
		Boolean aplicarCalculoComBaseDescontosCalculados = false;
		if (!Uteis.isAtributoPreenchido(contaReceberVO.getCodigo()) && Uteis.isAtributoPreenchido(contaReceberVO.getMatriculaAluno().getPlanoFinanceiroAluno().getCondicaoPagamentoPlanoFinanceiroCursoVO().getCodigo())) {
			aplicarCalculoComBaseDescontosCalculados = contaReceberVO.getMatriculaAluno().getPlanoFinanceiroAluno().getCondicaoPagamentoPlanoFinanceiroCursoVO().getAplicarCalculoComBaseDescontosCalculados();
		} else {
			aplicarCalculoComBaseDescontosCalculados = getFacadeFactory().getCondicaoPagamentoPlanoFinanceiroCursoFacade().consultarAplicarCalculoComBaseDescontosCalculadosPorContaReceber(contaReceberVO.getCodigo(), usuario);
			contaReceberVO.getMatriculaAluno().getPlanoFinanceiroAluno().getCondicaoPagamentoPlanoFinanceiroCursoVO().setAplicarCalculoComBaseDescontosCalculados(aplicarCalculoComBaseDescontosCalculados);
		}
		return  getFacadeFactory().getContaReceberFacade().executarGeracaoDescontosAplicaveisPlanoFinanceiroAluno(
				contaReceberVO.getIsContaReceberReferenteMatricula(), contaReceberVO.getValorBaseContaReceber(), contaReceberVO.getTipoDesconto(), 
				contaReceberVO.getValorDesconto(), contaReceberVO.getValorDesconto(), contaReceberVO.getDescontoAlunoValidoAteVencimento(), 
				contaReceberVO.getDataVencimento(), contaReceberVO.getDataOriginalVencimento(), contaReceberVO.obterOrdemAplicacaoDescontosPadraoAtual(), 
				contaReceberVO.getDescontoProgressivo(), contaReceberVO.getListaPlanoDescontoInstitucionalVOs(), contaReceberVO.getListaConvenioVOs(), 
				diasVariacaoDataVencimento, usaDescontoCompostoPlanoDesconto, conf, contaReceberVO.getRealizandoRecebimento(), 
				dataRecebimentoContaAReceber, contaReceberVO.getMatriculaAluno().getMatricula(), aplicarCalculoComBaseDescontosCalculados, contaReceberVO.getUnidadeEnsino().getCidade().getCodigo());
	}
	
	@Override
	public void validarRegrasParaFinanciamentoProprioConvenioImprimirBoleto(List<PlanoDescontoContaReceberVO> planoDescontoContaReceberVOs, List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaPlanoFinanceiroAlunoDescricaoDescontos , Integer codigoContaReceber, String matricula, String tipoOrigem, Date dataReferenciaQuitacao) throws Exception{
		validarRegrasParaFinanciamentoProprioConvenio(planoDescontoContaReceberVOs, listaPlanoFinanceiroAlunoDescricaoDescontos, codigoContaReceber, matricula, tipoOrigem, dataReferenciaQuitacao);
    }
	
	private static void validarRegrasParaFinanciamentoProprioConvenio(List<PlanoDescontoContaReceberVO> planoDescontoContaReceberVOs, List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaPlanoFinanceiroAlunoDescricaoDescontos, Integer codigoContaReceber, String matricula, String tipoOrigem, Date dataReferenciaQuitacao) throws Exception{
		if(Uteis.isAtributoPreenchido(planoDescontoContaReceberVOs)){
			for (PlanoDescontoContaReceberVO pdcr : planoDescontoContaReceberVOs) {
				if(pdcr.getIsConvenio()
						&& getFacadeFactory().getParceiroFacade().validarSeParceiroUtilizarFinanciamentoProprioPorCodigoConvenio(pdcr.getConvenio().getCodigo())
						&& !getFacadeFactory().getOperacaoFuncionalidadeFacade().consultarPorCodigoOrigemPorOrigemOperacaoFuncionalidadePorOperacaoFuncionalidade(pdcr.getCodigo(), OrigemOperacaoFuncionalidadeEnum.PLANO_DESCONTO_CONTA_RECEBER, OperacaoFuncionalidadeEnum.CONTA_RECEBER_LIBERAR_SUSPENSAO_CONVENIO, null)
						&& validarSeQuantidadeContaReceberVencidasPorBolsaCusteadoConvenioAptaSuspensao(matricula, pdcr.getConvenio().getCodigo(), pdcr.getConvenio().getParceiro().getCodigo(), dataReferenciaQuitacao)){
					pdcr.setSuspensoFinanciamentoProprio(true);
					
					if((pdcr.getConvenio().getAbaterDescontoNoValorMatricula() && tipoOrigem.equals(TipoOrigemContaReceber.MATRICULA.getValor()))
							|| (pdcr.getConvenio().getAbaterDescontoNoValorParcela() && !tipoOrigem.equals(TipoOrigemContaReceber.MATRICULA.getValor()))) {
						listaPlanoFinanceiroAlunoDescricaoDescontos.stream()
						.filter(p-> p.getListaDescontosConvenio().containsKey(pdcr.getConvenio().getCodigo()))
						.forEach(p->{p.setValorCusteadoContaReceber(Uteis.arrendondarForcando2CadasDecimais(p.getValorCusteadoContaReceber() - Uteis.arrendondarForcando2CadasDecimais(p.getListaDescontosConvenio().get(pdcr.getConvenio().getCodigo()))));});
								
					}
					if((!pdcr.getConvenio().getAbaterDescontoNoValorMatricula() && tipoOrigem.equals(TipoOrigemContaReceber.MATRICULA.getValor()))
									|| (!pdcr.getConvenio().getAbaterDescontoNoValorParcela() && !tipoOrigem.equals(TipoOrigemContaReceber.MATRICULA.getValor()))) {
						listaPlanoFinanceiroAlunoDescricaoDescontos.stream()
						.filter(p-> p.getListaDescontosConvenio().containsKey(pdcr.getConvenio().getCodigo()))
						.forEach(p->{p.setValorDescontoConvenio(Uteis.arrendondarForcando2CadasDecimais(p.getValorDescontoConvenio() - Uteis.arrendondarForcando2CadasDecimais(p.getListaDescontosConvenio().get(pdcr.getConvenio().getCodigo()))));});
					}
					
					
					listaPlanoFinanceiroAlunoDescricaoDescontos.stream()
					.filter(p-> p.getListaDescontosConvenio().containsKey(pdcr.getConvenio().getCodigo()))
					.forEach(p->{p.getListaDescontosConvenio().put(pdcr.getConvenio().getCodigo(),0.0);});
					
				}
			}	
		}
		
	}
	
	public static Boolean consultarSeExisteContaReceberDifenteDoTipoOrigemMensalidademParaAplicarIndiceReajuste(String codigoOrigem) {
		if(Uteis.isAtributoPreenchido(codigoOrigem)) {
		StringBuilder sql = new StringBuilder("select count(1) as qtd from contarecebernegociado   ");
		sql.append(" inner join contareceber on contareceber.codigo  = contarecebernegociado.contareceber ");
		sql.append(" where contarecebernegociado.negociacaocontareceber =  ").append(codigoOrigem);
		sql.append(" and contareceber.tipoorigem not in ('MEN', 'NCR', 'OUT') ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return Uteis.isAtributoPreenchido(tabelaResultado, "qtd", TipoCampoEnum.INTEIRO);
	}
		return false;
	}

	/**
	 * Operação responsável por montar os dados de um objeto da classe <code>PessoaVO</code> relacionado ao objeto <code>ContaReceberVO</code>. Faz uso da chave primária da classe <code>PessoaVO</code> para realizar a consulta.
	 * 
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 */
	public static void montarDadosFuncionario(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getFuncionario().getCodigo().intValue() == 0) {
			return;
		}
		obj.setFuncionario(getFacadeFactory().getFuncionarioFacade().consultarPorChavePrimaria(obj.getFuncionario().getCodigo(), 0, false, nivelMontarDados, usuario));
	}

	public static void montarDadosFornecedor(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getFornecedor().getCodigo().intValue() == 0) {
			return;
		}
		obj.setFornecedor(getFacadeFactory().getFornecedorFacade().consultarPorChavePrimaria(obj.getFornecedor().getCodigo(), false, nivelMontarDados, usuario));
	}

	public static void montarDadosTurma(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getTurma().getCodigo().intValue() == 0) {
			return;
		}
		obj.setTurma(getFacadeFactory().getTurmaFacade().consultarPorChavePrimaria(obj.getTurma().getCodigo(), Uteis.NIVELMONTARDADOS_COMBOBOX, usuario));
	}

	/**
	 * Operação responsável por montar os dados de um objeto da classe <code>PessoaVO</code> relacionado ao objeto <code>ContaReceberVO</code>. Faz uso da chave primária da classe <code>PessoaVO</code> para realizar a consulta.
	 * 
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 */
	public static void montarDadosConvenio(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getConvenio().getCodigo().intValue() == 0) {
			return;
		}
		obj.setConvenio(getFacadeFactory().getConvenioFacade().consultarPorChavePrimaria(obj.getConvenio().getCodigo(), false, nivelMontarDados, usuario));
	}

	public static void montarDadosParceiro(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getParceiroVO().getCodigo().intValue() == 0) {
			return;
		}
		obj.setParceiroVO(getFacadeFactory().getParceiroFacade().consultarPorChavePrimaria(obj.getParceiroVO().getCodigo(), false, nivelMontarDados, usuario));
	}

	public static void montarDadosUnidadeEnsino(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getUnidadeEnsino().getCodigo().intValue() == 0) {
			return;
		}
		obj.setUnidadeEnsino(getFacadeFactory().getUnidadeEnsinoFacade().consultarPorChavePrimaria(obj.getUnidadeEnsino().getCodigo(), false, nivelMontarDados, usuario));
	}

	public static void montarDadosDescontoProgressivo(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getDescontoProgressivo().getCodigo().intValue() == 0) {
			return;
		}
		obj.setDescontoProgressivo(getFacadeFactory().getDescontoProgressivoFacade().consultarPorChavePrimaria(obj.getDescontoProgressivo().getCodigo(), usuario));
	}

	public static void montarDadosCandidato(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getCandidato().getCodigo().intValue() == 0) {
			return;
		}
		obj.setCandidato(getFacadeFactory().getPessoaFacade().consultaRapidaPorChavePrimaria(obj.getCandidato().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));

	}

	public static void montarDadosPessoa(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getPessoa().getCodigo().intValue() == 0) {
			return;
		}

		obj.setPessoa(getFacadeFactory().getPessoaFacade().consultaRapidaPorChavePrimaria(obj.getPessoa().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
	}

	public static void montarDadosBeneficiario(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getBeneficiario().getCodigo().intValue() == 0) {
			return;
		}

		obj.setBeneficiario(getFacadeFactory().getPessoaFacade().consultaRapidaPorChavePrimaria(obj.getBeneficiario().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
	}

	public static void montarDadosResponsavelFinanceiro(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getResponsavelFinanceiro().getCodigo().intValue() == 0) {
			return;
		}

		obj.setResponsavelFinanceiro(getFacadeFactory().getPessoaFacade().consultaRapidaPorChavePrimaria(obj.getResponsavelFinanceiro().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
	}

	/**
	 * Operação responsável por montar os dados de um objeto da classe <code>MatriculaVO</code> relacionado ao objeto <code>ContaReceberVO</code>. Faz uso da chave primária da classe <code>MatriculaVO</code> para realizar a consulta.
	 * 
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 */
	public static void montarDadosMatriculaAluno(ContaReceberVO obj, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		try {
			if ((obj.getMatriculaAluno().getMatricula() == null) || (obj.getMatriculaAluno().getMatricula().equals(""))) {
				return;
			}
			obj.setMatriculaAluno(getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(obj.getMatriculaAluno().getMatricula(), 0, nivelMontarDados, configuracaoFinanceiro, usuario));
		} catch (Exception e) {
			throw e;
		}
	}

	/**
	 * Operação responsável por montar os dados de um objeto da classe <code>CentroReceitaVO</code> relacionado ao objeto <code>ContaReceberVO</code>. Faz uso da chave primária da classe <code>CentroReceitaVO</code> para realizar a consulta.
	 * 
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 */
	public static void montarDadosCentroReceita(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getCentroReceita().getCodigo().intValue() == 0) {
			return;
		}
		obj.setCentroReceita(getFacadeFactory().getCentroReceitaFacade().consultarPorChavePrimaria(obj.getCentroReceita().getCodigo(), false, nivelMontarDados, usuario));
	}

	public static void montarDadosContaCorrente(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getContaCorrente().intValue() == 0) {
			return;
		}
		obj.setContaCorrenteVO(getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(obj.getContaCorrente(), false, nivelMontarDados, usuario));
	}

	public static void montarDadosRegistroCobranca(ContaReceberVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		// if (obj.getRegistroNegativacaoCobrancaContaReceber().getCodigo().intValue() == 0) {
		// return;
		// }
		// obj.setRegistroNegativacaoCobrancaContaReceber(getFacadeFactory().getRegistroNegativacaoCobrancaContaReceberFacade().consultarPorChavePrimaria(obj.getRegistroNegativacaoCobrancaContaReceber().getCodigo(), false, usuario));
	}

	public List<ContaReceberVO> executarCalculoValorFinalASerPago(List<ContaReceberVO> listaContaReceber, UsuarioVO usuario, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Date dataBaseCalcular) throws Exception {
		for (ContaReceberVO contaReceberVO : listaContaReceber) {
			contaReceberVO.setRealizandoRecebimento(Boolean.TRUE);
			contaReceberVO.setSelecionado(Boolean.TRUE);
			contaReceberVO.getMatriculaAluno().setPlanoFinanceiroAluno(getFacadeFactory().getPlanoFinanceiroAlunoFacade().consultarPorMatriculaPeriodo(contaReceberVO.getMatriculaPeriodo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
			contaReceberVO.setValorFinalCalculado(contaReceberVO.getCalcularValorFinal(null, configuracaoFinanceiroVO, false, dataBaseCalcular, usuario));
		}
		return listaContaReceber;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# consultarPorChavePrimaria(java.lang.Integer, boolean, int)
	 */
	public ContaReceberVO consultarPorChavePrimaria(Integer codigoPrm, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		String sql = "SELECT * FROM ContaReceber WHERE codigo = ?";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql, new Object[] { codigoPrm });
		if (!tabelaResultado.next()) {
			throw new ConsistirException("Dados Não Encontrados ( ContaReceber = " +codigoPrm+ ").");
		}
		return (montarDados(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	@SuppressWarnings("static-access")
	public SqlRowSet consultaRapidaPorChavePrimariaDadosBasicos(Integer codigoPrm, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE (contareceber.codigo = ?)");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), new Object[] { codigoPrm });
		if (!tabelaResultado.next()) {
			throw new ConsistirException("Dados Não Encontrados ( ContaReceber = " +codigoPrm+ ").");
		}
		// Reposiciona cursor para posição anterior ao primeiro registro.
		// tabelaResultado.beforeFirst();
		return tabelaResultado;
	}

	public List consultaRapidaPorCodigoContaReceberAgrupada(Integer codigoContaReceberAgrupada, UsuarioVO usuario) throws Exception {
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE contareceber.contaReceberAgrupada = ").append(codigoContaReceberAgrupada).append(" AND contareceber.situacao = 'AR'");
		sql.append(" ORDER BY contareceber.datavencimento;");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	@SuppressWarnings("static-access")
	public SqlRowSet consultaRapidaPorChavePrimariaDadosCompletos(Integer codigoPrm, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaCompleta();
		sql.append(" WHERE (contareceber.codigo = ?)");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), new Object[] { codigoPrm });
		if (!tabelaResultado.next()) {
			throw new ConsistirException("Dados Não Encontrados ( ContaReceber = " +codigoPrm+ ").");
		}
		// Reposiciona cursor para posição anterior ao primeiro registro.
		tabelaResultado.beforeFirst();
		return tabelaResultado;
	}

	/**
	 * Operação reponsável por retornar o identificador desta classe. Este identificar é utilizado para verificar as permissões de acesso as operações desta classe.
	 */
	public static String getIdEntidade() {
		return ContaReceber.idEntidade;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#setIdEntidade (java.lang.String)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade#setIdEntidade (java.lang.String)
	 */
	public void setIdEntidade(String idEntidade) {
		ContaReceber.idEntidade = idEntidade;
	}

	private StringBuilder getSQLPadraoConsultaBasica() {
		StringBuilder sql = new StringBuilder(getSQLPadraoConsultaBasicaSelect());
		sql.append(getSQLPadraoConsultaBasicaFrom());
		return sql;
	}
	
	
	private StringBuilder getSQLPadraoConsultaBasicaSelect() {
		/*
		 * AO ADD CAMPOS NESTE SELECT VEJA O METODO getSQLPadraoConsultaBasicaPorSacadoTabelaTemporaria E ADD OS CAMPOS CONFORME OS DADOS DO TIPO DA PESSOA
		 */
		StringBuilder sql = new StringBuilder("SELECT ");
		realizarAdicaoTotalizadoresContaReceber(sql);
		sql.append(" contareceber.codigo, contareceber.impressaoBoletoRealizada, contareceber.tipopessoa, contareceber.nrdocumento, contareceber.nossonumero, contareceber.nossonumerobanco, contareceber.pessoa, contareceber.notafiscalsaidaservico, pessoamatricula.nome AS \"Aluno.nome\", pessoa.nome AS \"Pessoa.nome\", pessoamatricula.cpf AS \"Pessoa.cpf\", pessoamatricula.email AS \"Pessoa.email\", contareceber.parcela, contareceber.contacorrente, cc.carteiraregistrada AS \"contacorrente.carteiraregistrada\", contareceber.codorigem, ");
		sql.append("contareceber.codigobarra, contareceber.linhadigitavelcodigobarras, contareceber.descontoProgressivo, contareceber.turma, contareceber.duplicidadeTratada, contareceber.descontoconvenio, contareceber.descontoinstituicao, contareceber.valordescontoprogressivo,  ");
		sql.append("contareceber.valor, contareceber.valorBaseContaReceber, contareceber.valorRecebido, contareceber.juro, contareceber.multa, contareceber.acrescimo, contareceber.dataVencimento, contareceber.dataCompetencia, contareceber.dataProcessamentoValorReceber, contareceber.situacao, contareceber.multaporcentagem, contareceber.juroporcentagem, contareceber.tipoorigem, ");
		sql.append("contareceber.valorDesconto, contareceber.tipoDesconto, contareceber.valordescontolancadorecebimento, contareceber.valorcalculadodescontolancadorecebimento, contareceber.tipodescontolancadorecebimento, contareceber.valorDescontoAlunoJaCalculado, contareceber.updated, contareceber.usaDescontoCompostoPlanoDesconto, ");
		sql.append(" contareceber.ordemConvenio, contareceber.OrdemConvenioValorCheio, contareceber.OrdemDescontoAluno, contareceber.matriculaperiodo, contaReceber.valorDescontoCalculado, contaReceber.valorReceberCalculado, contareceber.valorDescontoRateio,  ");
		sql.append(" contareceber.OrdemDescontoAlunoValorCheio, contareceber.OrdemDescontoProgressivo, contareceber.OrdemDescontoProgressivoValorCheio, ");
		sql.append(" contareceber.possuiPendenciasFinanceirasExternas, contareceber.possuiFiesIntegracaoFinanceiras, contareceber.OrdemPlanoDesconto, contareceber.OrdemPlanoDescontoValorCheio, contareceber.responsavelFinanceiro, contareceber.contareceberagrupada, ");
		sql.append(" contareceber.contaEditadaManualmente, contareceber.utilizarDescontoProgressivoManual, contareceber.diaLimite1, contareceber.diaLimite2, contareceber.diaLimite3, contareceber.diaLimite4, ");
		sql.append(" contareceber.valorIndiceReajustePorAtraso, contareceber.liberadoDoIndiceReajustePorAtraso, ");
		sql.append(" indicereajuste.codigo as \"indicereajuste.codigo\" , indicereajuste.descricao as \"indicereajuste.descricao\", ");
		sql.append(" matricula.matricula AS \"Matricula.matricula\", funcionario.codigo AS \"Funcionario.codigo\", funcionario.matricula AS \"Funcionario.matricula\", pessoafuncionario.nome AS \"Funcionario.nome\", pessoafuncionario.codigo AS \"Funcionario.codigo\",  ");
		sql.append(" unidadeEnsino.codigo AS \"UnidadeEnsino.codigo\",  unidadeEnsino.nome AS \"UnidadeEnsino.nome\", ");
		sql.append(" unidadeEnsinoFinanceira.codigo AS \"unidadeensinofinanceira.codigo\", unidadeEnsinoFinanceira.nome AS \"unidadeEnsinoFinanceira.nome\",");
		/*
		 * AO ADD CAMPOS NESTE SELECT VEJA O METODO getSQLPadraoConsultaBasicaPorSacadoTabelaTemporaria E ADD OS CAMPOS CONFORME OS DADOS DO TIPO DA PESSOA
		 */
		sql.append(" pessoacandidato.nome AS \"Candidato.nome\", pessoacandidato.codigo AS \"Candidato.codigo\", pessoacandidato.cpf AS \"Candidato.cpf\", parceiro.nome AS \"Parceiro.nome\", parceiro.cnpj AS \"Parceiro.cnpj\", parceiro.cpf AS \"Parceiro.cpf\", parceiro.codigo AS \"Parceiro.codigo\", Parceiro.isentarJuro as \"Parceiro.isentarJuro\", Parceiro.isentarMulta as \"Parceiro.isentarMulta\", ");
		sql.append(" responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.cpf as \"responsavelFinanceiro.cpf\", responsavelFinanceiro.email as \"responsavelFinanceiro.email\", ");
		sql.append(" turma.identificadorturma,fornecedor.codigo as \"fornecedor.codigo\", fornecedor.nome as \"fornecedor.nome\", fornecedor.rg as \"fornecedor.rg\", ");
		sql.append(" fornecedor.cpf as \"fornecedor.cpf\", fornecedor.cnpj as \"fornecedor.cnpj\", fornecedor.tipoEmpresa as \"fornecedor.tipoEmpresa\", pessoamatricula.codigo as \"pessoamatricula.codigo\", ");
		sql.append(" contareceber.pagocomdcc, ");
		sql.append(" case when contareceber.tipoorigem in ('MAT', 'MEN') then matricula.bloquearEmissaoBoletoMatMenVisaoAluno else false end as \"Matricula.bloquearEmissaoBoletoMatMenVisaoAluno\", ");
		sql.append(" CentroReceita.codigo as \"CentroReceita.codigo\", CentroReceita.descricao as \"CentroReceita.descricao\", contareceber.processamentointegracaofinanceiradetalhe, contareceber.valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa as \"valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa\"  ");
		/*
		 * AO ADD CAMPOS NESTE SELECT VEJA O METODO getSQLPadraoConsultaBasicaPorSacadoTabelaTemporaria E ADD OS CAMPOS CONFORME OS DADOS DO TIPO DA PESSOA
		 */
		return sql;
	}
	
	private StringBuilder getSQLPadraoConsultaBasicaFrom() {
		StringBuilder sql = new StringBuilder();
		sql.append("FROM contareceber ");
		sql.append("INNER JOIN contacorrente cc ON (contareceber.contacorrente = cc.codigo) ");
		sql.append("INNER JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sql.append("INNER JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sql.append("LEFT JOIN centroreceita ON (centroreceita.codigo = contareceber.centroreceita) ");
		sql.append("LEFT JOIN turma ON (turma.codigo = contareceber.turma) ");		
		sql.append("LEFT JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) ");
		sql.append("LEFT JOIN convenio ON (convenio.codigo = contareceber.convenio) ");
		sql.append("LEFT JOIN indicereajuste ON (contareceber.indiceReajustePadraoPorAtraso = indicereajuste.codigo) ");
		sql.append("LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo) ");
		sql.append("LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) ");
		sql.append("LEFT JOIN parceiro ON (parceiro.codigo = contareceber.parceiro) ");
		sql.append("LEFT JOIN pessoa AS pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sql.append("LEFT JOIN pessoa AS pessoamatricula ON (matricula.aluno = pessoamatricula.codigo) ");
		sql.append("LEFT JOIN pessoa AS pessoacandidato ON (contareceber.candidato = pessoacandidato.codigo) ");
		sql.append("LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sql.append("LEFT JOIN fornecedor ON (fornecedor.codigo = contareceber.fornecedor) ");
		return sql;
	}

//	private StringBuilder getSQLPadraoConsultaBasicaPorSacadoTabelaTemporaria() {
//		StringBuilder sql = new StringBuilder();
//		sql.append(" with cte_pessoa as (");
//		sql.append("       select codigo, nome, cpf, email from pessoa where sem_acentos(pessoa.nome) ilike sem_acentos(?) order by pessoa.nome ");
//		sql.append(" ), cte_fornecedor as (");
//		sql.append("       select codigo, nome, cpf, cnpj, tipoEmpresa, RG from fornecedor where sem_acentos(fornecedor.nome) ilike sem_acentos(?) order by fornecedor.nome ");
//		sql.append(" ), cte_parceiro as (");
//		sql.append("       select codigo ,nome,  cpf, cnpj, isentarJuro, isentarMulta from parceiro  where sem_acentos(parceiro.nome) ilike sem_acentos(?) order by parceiro.nome ");
//		sql.append("  )");	
//		return sql;
//	}

//	private StringBuilder getSQLPadraoConsultaBasicaPorSacado() {
//		StringBuilder sql = new StringBuilder(getSQLPadraoConsultaBasicaPorSacadoTabelaTemporaria());			
//		sql.append(getSQLPadraoConsultaBasicaSelect());
//		sql.append(getSQLPadraoConsultaBasicaFrom("cte_pessoa", "cte_fornecedor", "cte_parceiro"));
//		return sql;
//	}
//
	private StringBuilder getSQLPadraoConsultaBasicaTotalRegistros() {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT count  (distinct contareceber.codigo) ");
		sql.append(getSQLPadraoConsultaBasicaFrom());		
		return sql;
	}

//	private StringBuilder getSQLPadraoConsultaBasicaTotalRegistrosPorSacado() {
//		StringBuilder sql = new StringBuilder(getSQLPadraoConsultaBasicaPorSacadoTabelaTemporaria());
//		
//		sql.append("SELECT count  (contareceber.codigo) ");
//		sql.append(getSQLPadraoConsultaBasicaFrom("cte_pessoa", "cte_fornecedor", "cte_parceiro"));		
//		return sql;
//	}

	private StringBuilder getSQLConsultaAlterarResponsavelFinanceiro() {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT contareceber.codigo, contareceber.impressaoBoletoRealizada, contareceber.tipopessoa, contareceber.nrdocumento, contareceber.nossonumero, contareceber.nossonumerobanco, contareceber.pessoa, contareceber.notafiscalsaidaservico, pessoamatricula.nome AS \"Aluno.nome\", pessoa.nome AS \"Pessoa.nome\", pessoamatricula.cpf AS \"Pessoa.cpf\", pessoamatricula.email AS \"Pessoa.email\", contareceber.parcela, contareceber.contacorrente, contareceber.codorigem, cc.carteiraregistrada AS \"contacorrente.carteiraregistrada\", ");
		sql.append("contareceber.codigobarra, contareceber.linhadigitavelcodigobarras, contareceber.descontoProgressivo, contareceber.turma, contareceber.duplicidadeTratada,  ");
		sql.append("contareceber.valor, contareceber.valorBaseContaReceber, contareceber.valorRecebido, contareceber.juro, contareceber.multa, contareceber.acrescimo, contareceber.dataVencimento, contareceber.dataCompetencia, contareceber.dataProcessamentoValorReceber, contareceber.situacao, contareceber.multaporcentagem, contareceber.juroporcentagem, contareceber.tipoorigem, ");
		sql.append("contareceber.descontoConvenio, contareceber.descontoInstituicao, contareceber.valorDescontoProgressivo, ");
		sql.append("contareceber.valorDesconto, contareceber.tipoDesconto, contareceber.valordescontolancadorecebimento, contareceber.valorcalculadodescontolancadorecebimento, contareceber.tipodescontolancadorecebimento, contareceber.valorDescontoAlunoJaCalculado, contareceber.updated, contareceber.usaDescontoCompostoPlanoDesconto, ");
		sql.append(" contareceber.ordemConvenio, contareceber.OrdemConvenioValorCheio, contareceber.OrdemDescontoAluno, contareceber.matriculaperiodo, contaReceber.valorDescontoCalculado, contaReceber.valorReceberCalculado, ");
		sql.append(" contareceber.OrdemDescontoAlunoValorCheio, contareceber.OrdemDescontoProgressivo, contareceber.OrdemDescontoProgressivoValorCheio, ");
		sql.append(" contareceber.OrdemPlanoDesconto, contareceber.OrdemPlanoDescontoValorCheio,centroReceita.codigo as \"CentroReceita.codigo\",centroReceita.descricao as \"CentroReceita.descricao\", contareceber.descontoConvenio,contareceber.descontoInstituicao,contareceber.valorDescontoProgressivo,contareceber.responsavelFinanceiro, contareceber.contareceberagrupada, ");
		sql.append(" contareceber.contaEditadaManualmente, contareceber.utilizarDescontoProgressivoManual, contareceber.diaLimite1, contareceber.diaLimite2, contareceber.diaLimite3, contareceber.diaLimite4, ");
		sql.append(" contareceber.valorIndiceReajustePorAtraso, contareceber.liberadoDoIndiceReajustePorAtraso, ");
		sql.append(" indicereajuste.codigo as \"indicereajuste.codigo\" , indicereajuste.descricao as \"indicereajuste.descricao\", ");
		sql.append(" matricula.matricula AS \"Matricula.matricula\", matricula.bloquearEmissaoBoletoMatMenVisaoAluno AS \"Matricula.bloquearEmissaoBoletoMatMenVisaoAluno\" ,funcionario.codigo AS \"Funcionario.codigo\", funcionario.matricula AS \"Funcionario.matricula\", pessoafuncionario.nome AS \"Funcionario.nome\", pessoafuncionario.codigo AS \"Funcionario.codigo\", ");
		sql.append(" unidadeEnsino.codigo AS \"UnidadeEnsino.codigo\", unidadeEnsino.nome AS \"UnidadeEnsino.nome\",  ");
		sql.append(" unidadeEnsinoFinanceira.codigo AS \"unidadeEnsinoFinanceira.codigo\",  unidadeEnsinoFinanceira.nome AS \"unidadeEnsinoFinanceira.nome\", ");
		sql.append(" pessoacandidato.nome AS \"Candidato.nome\", pessoacandidato.codigo AS \"Candidato.codigo\", pessoacandidato.cpf AS \"Candidato.cpf\", parceiro.nome AS \"Parceiro.nome\", parceiro.cnpj AS \"Parceiro.cnpj\", parceiro.cpf AS \"Parceiro.cpf\", parceiro.codigo AS \"Parceiro.codigo\", Parceiro.isentarJuro as \"Parceiro.isentarJuro\", Parceiro.isentarMulta as \"Parceiro.isentarMulta\", ");
		sql.append(" responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.cpf as \"responsavelFinanceiro.cpf\", responsavelFinanceiro.email as \"responsavelFinanceiro.email\", ");
		sql.append(" turma.identificadorturma,fornecedor.codigo as \"fornecedor.codigo\", fornecedor.nome as \"fornecedor.nome\", fornecedor.rg as \"fornecedor.rg\", ");
		sql.append(" fornecedor.cpf as \"fornecedor.cpf\", fornecedor.cnpj as \"fornecedor.cnpj\", fornecedor.tipoEmpresa as \"fornecedor.tipoEmpresa\", pessoamatricula.codigo as \"pessoamatricula.codigo\", ");
		sql.append(" (SELECT count(notafiscalsaida.codigo) > 0 FROM contareceberrecebimento ");
		sql.append(" INNER JOIN notafiscalsaida ON notafiscalsaida.codigo = contareceberrecebimento.notafiscalsaida ");
		sql.append(" WHERE contareceber = contareceber.codigo AND notafiscalsaida.situacao = 'AU') AS notafiscalemitida, contareceber.processamentointegracaofinanceiradetalhe,contareceber.possuipendenciasfinanceirasexternas, contareceber.possuiFiesIntegracaoFinanceiras, contareceber.valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa as valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa, ");
		sql.append(" contareceber.pagocomdcc, contareceber.valordescontorateio as \"valorDescontoRateio\" FROM contareceber ");
		sql.append("INNER JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sql.append("INNER JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sql.append("LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo) ");
		sql.append("LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) ");
		sql.append("LEFT JOIN parceiro ON (parceiro.codigo = contareceber.parceiro) ");
		sql.append("LEFT JOIN pessoa AS pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sql.append("LEFT JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) ");
		sql.append("LEFT JOIN matriculaperiodo ON matriculaperiodo.matricula = matricula.matricula AND matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		sql.append("LEFT JOIN pessoa AS pessoamatricula ON (matricula.aluno = pessoamatricula.codigo) ");
		sql.append("LEFT JOIN pessoa AS pessoacandidato ON (contareceber.candidato = pessoacandidato.codigo) ");
		sql.append("LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sql.append("LEFT JOIN centroreceita ON (centroreceita.codigo = contareceber.centroreceita) ");
		sql.append("LEFT JOIN convenio ON (convenio.codigo = contareceber.convenio) ");
		sql.append("LEFT JOIN turma ON (turma.codigo = contareceber.turma) ");
		sql.append("LEFT JOIN fornecedor ON (fornecedor.codigo = contareceber.fornecedor) ");
		sql.append("left join contacorrente cc on contareceber.contacorrente = cc.codigo ");
		sql.append(" LEFT JOIN indicereajuste ON (contareceber.indiceReajustePadraoPorAtraso = indicereajuste.codigo) ");
		return sql;
	}

	private StringBuilder getSQLPadraoConsultaTotalReceber() {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT sum(valor) AS valorAReceber, 0 AS valorRecebido ");
		sql.append("FROM contareceber ");
		sql.append("INNER JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sql.append("INNER JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sql.append("LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo) ");
		sql.append("LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) ");
		sql.append("LEFT JOIN parceiro ON (parceiro.codigo = contareceber.parceiro) ");
		sql.append("LEFT JOIN pessoa AS pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sql.append("LEFT JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) ");
		sql.append("LEFT JOIN pessoa AS pessoamatricula ON (matricula.aluno = pessoamatricula.codigo) ");
		sql.append("LEFT JOIN pessoa AS pessoacandidato ON (contareceber.candidato = pessoacandidato.codigo) ");
		sql.append("LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sql.append("LEFT JOIN centroreceita ON (centroreceita.codigo = contareceber.centroreceita) ");
		sql.append("LEFT JOIN convenio ON (convenio.codigo = contareceber.convenio) ");
		sql.append("LEFT JOIN fornecedor ON (fornecedor.codigo = contareceber.fornecedor) ");
		return sql;
	}

	private StringBuilder getSQLPadraoConsultaTotalRecebido() {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT 0 AS valorAReceber, sum(valorRecebido) AS valorRecebido ");
		sql.append("FROM contareceber ");
		sql.append("INNER JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sql.append("INNER JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sql.append("LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo) ");
		sql.append("LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) ");
		sql.append("LEFT JOIN parceiro ON (parceiro.codigo = contareceber.parceiro) ");
		sql.append("LEFT JOIN pessoa AS pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sql.append("LEFT JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) ");
		sql.append("LEFT JOIN pessoa AS pessoamatricula ON (matricula.aluno = pessoamatricula.codigo) ");
		sql.append("LEFT JOIN pessoa AS pessoacandidato ON (contareceber.candidato = pessoacandidato.codigo) ");
		sql.append("LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sql.append("LEFT JOIN centroreceita ON (centroreceita.codigo = contareceber.centroreceita) ");
		sql.append("LEFT JOIN convenio ON (convenio.codigo = contareceber.convenio) ");
		sql.append("LEFT JOIN fornecedor ON (fornecedor.codigo = contareceber.fornecedor) ");

		return sql;
	}

	private StringBuilder getSQLPadraoConsultaCompleta() {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT contareceber.*, descontoProgressivo.codigo as \"descontoProgressivo.codigo\", pessoamatricula.nome AS \"Aluno.nome\", pessoamatricula.cpf AS \"Aluno.cpf\", pessoacandidato.nome AS \"Candidato.nome\", pessoacandidato.codigo AS \"Candidato.codigo\", pessoacandidato.cpf AS \"Candidato.cpf\", unidadeEnsino.codigo AS \"UnidadeEnsino.codigo\", unidadeEnsino.nome AS \"UnidadeEnsino.nome\", ");
		sql.append(" indicereajuste.codigo as \"indicereajuste.codigo\" , indicereajuste.descricao as \"indicereajuste.descricao\", ");
		sql.append("descontoProgressivo.dialimite1 as \"descontoProgressivo.dialimite1\", descontoProgressivo.dialimite2 as \"descontoProgressivo.dialimite2\", descontoProgressivo.dialimite3 as \"descontoProgressivo.dialimite3\", descontoProgressivo.dialimite4 as \"descontoProgressivo.dialimite4\", ");
		sql.append("descontoProgressivo.percdescontolimite1 as \"descontoProgressivo.percdescontolimite1\", descontoProgressivo.percdescontolimite2 as \"descontoProgressivo.percdescontolimite2\", descontoProgressivo.percdescontolimite3 as \"descontoProgressivo.percdescontolimite3\", descontoProgressivo.percdescontolimite4 as \"descontoProgressivo.percdescontolimite4\", ");
		sql.append("descontoProgressivo.valordescontolimite1 as \"descontoProgressivo.valordescontolimite1\", descontoProgressivo.valordescontolimite2 as \"descontoProgressivo.valordescontolimite2\", descontoProgressivo.valordescontolimite3 as \"descontoProgressivo.valordescontolimite3\", descontoProgressivo.valordescontolimite4 as \"descontoProgressivo.valordescontolimite4\", ");
		sql.append("descontoProgressivo.utilizarDiaFixo as \"descontoProgressivo.utilizarDiaFixo\", descontoProgressivo.utilizarDiaUtil as \"descontoProgressivo.utilizarDiaUtil\", descontoProgressivo.nome as \"descontoProgressivo.nome\", ");
		sql.append("pessoa.nome AS \"Pessoa.nome\", pessoa.cpf AS \"Pessoa.cpf\", Pessoa.email as \"Pessoa.email\", cc.carteiraregistrada AS \"contacorrente.carteiraregistrada\", ");
		sql.append("matricula.matricula AS \"Matricula.matricula\", funcionario.codigo AS \"Funcionario.codigo\",funcionario.matricula AS \"Funcionario.matricula\", pessoafuncionario.nome AS \"Funcionario.nome\", pessoafuncionario.codigo AS \"Funcionario.codigo\", parceiro.nome AS \"Parceiro.nome\", parceiro.cnpj AS \"Parceiro.cnpj\", parceiro.cpf AS \"Parceiro.cpf\", Parceiro.isentarJuro as \"Parceiro.isentarJuro\", Parceiro.isentarMulta as \"Parceiro.isentarMulta\", ");
		sql.append("parceiro.codigo AS \"Parceiro.codigo\", centroreceita.codigo AS \"CentroReceita.codigo\", centroreceita.descricao AS \"CentroReceita.descricao\", contareceberrecebimento.codigo AS \"Recebimento.codigo\", contareceberrecebimento.datarecebimento AS \"Recebimento.datarecebimento\", contareceberrecebimento.tiporecebimento AS \"Recebimento.tiporecebimento\", ");
		sql.append("contareceberrecebimento.formapagamento AS \"Recebimento.formapagamento\", contareceberrecebimento.negociacaoRecebimento AS \"contareceberrecebimento.negociacaoRecebimento\", contareceberrecebimento.recebimentoTerceirizado AS \"contareceberrecebimento.recebimentoTerceirizado\", formapagamento.nome AS \"FormaPagamento.nome\", contareceberrecebimento.valorrecebimento AS \"Recebimento.valorrecebimento\", contareceberrecebimento.formapagamentonegociacaorecebimento AS \"Recebimento.formapagamentonegociacaorecebimento\", ");
		sql.append("usuario.codigo AS \"Responsavel.codigo\", usuario.nome AS \"Responsavel.nome\", contareceberrecebimento.motivo AS \"Recebimento.motivo\", responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.cpf as \"responsavelFinanceiro.cpf\", responsavelFinanceiro.email as \"responsavelFinanceiro.email\", ");
		sql.append(" turma.identificadorturma,fornecedor.codigo as \"fornecedor.codigo\", fornecedor.nome as \"fornecedor.nome\", fornecedor.rg as \"fornecedor.rg\", ");
		sql.append(" planofinanceiroaluno.codigo AS \"planofinanceiroaluno.codigo\", planofinanceiroaluno.descontoValidoAteDataParcela as \"planofinanceiroaluno.descontoValidoAteDataParcela\", planofinanceiroaluno.valorDescontoParcela AS \"planofinanceiroaluno.valorDescontoParcela\", planofinanceiroaluno.valorDescontoMatricula AS \"planofinanceiroaluno.valorDescontoMatricula\", planofinanceiroaluno.percDescontoParcela AS \"planofinanceiroaluno.percDescontoParcela\", planofinanceiroaluno.percDescontoMatricula AS \"planofinanceiroaluno.percDescontoMatricula\", planofinanceiroaluno.tipoDescontoParcela AS \"planofinanceiroaluno.tipoDescontoParcela\", planofinanceiroaluno.tipoDescontoMatricula AS \"planofinanceiroaluno.tipoDescontoMatricula\", ");
		sql.append(" planofinanceiroaluno.descontoValidoAteDataParcela as \"planofinanceiroaluno.descontoValidoAteDataParcela\",  ");
		sql.append(" fornecedor.cpf as \"fornecedor.cpf\", fornecedor.cnpj as \"fornecedor.cnpj\", fornecedor.tipoEmpresa as \"fornecedor.tipoEmpresa\", pessoamatricula.codigo as \"pessoamatricula.codigo\", ");
		sql.append(" CentroReceita.codigo as \"CentroReceita.codigo\", CentroReceita.descricao as \"CentroReceita.descricao\", contareceber.processamentointegracaofinanceiradetalhe, ");
		sql.append("notaFiscalSaida.codigo as notaFiscalSaida_codigo, notaFiscalSaida.numero as notaFiscalSaida_numero, notaFiscalSaida.dataEmissao as notaFiscalSaida_dataEmissao, ");
		sql.append("responsavel.codigo as notaFiscalSaida_responsavel_codigo, responsavel.nome as notaFiscalSaida_responsavel_nome , ");
		sql.append(" contareceber.pagocomdcc, ");
		sql.append(" case when contareceber.tipoorigem in ('MAT', 'MEN') then matricula.bloquearEmissaoBoletoMatMenVisaoAluno else false end as \"Matricula.bloquearEmissaoBoletoMatMenVisaoAluno\", ");
		sql.append(" CentroReceita.codigo as \"CentroReceita.codigo\", CentroReceita.descricao as \"CentroReceita.descricao\", contareceber.processamentointegracaofinanceiradetalhe, responsavelCancelamento.nome AS \"responsavelCancelamento.nome\",  ");
		sql.append(" responsavel.codigo as notaFiscalSaida_responsavel_codigo, responsavel.nome as notaFiscalSaida_responsavel_nome, cidade.codigo as cidade, ");
		sql.append(" unidadeensinofinanceira.codigo as \"unidadeensinofinanceira.codigo\", unidadeensinofinanceira.nome as \"unidadeensinofinanceira.nome\" ");

		sql.append("FROM contareceber ");
		sql.append("INNER JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sql.append("INNER JOIN unidadeensino as unidadeensinofinanceira ON (unidadeensinofinanceira.codigo = contareceber.unidadeensinofinanceira) ");
		sql.append("INNER join contacorrente cc on contareceber.contacorrente = cc.codigo ");
		sql.append("LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo) ");
		sql.append("LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) ");
		sql.append("LEFT JOIN parceiro ON (parceiro.codigo = contareceber.parceiro) ");
		sql.append("LEFT JOIN pessoa as pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sql.append("LEFT JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) ");
		sql.append("LEFT JOIN pessoa as pessoamatricula ON (matricula.aluno = pessoamatricula.codigo) ");
		sql.append("LEFT JOIN pessoa as pessoacandidato ON (contareceber.candidato = pessoacandidato.codigo) ");
		sql.append("LEFT JOIN cidade ON (unidadeensinofinanceira.cidade = cidade.codigo) ");
		sql.append("LEFT JOIN centroreceita ON (centroreceita.codigo = contareceber.centroreceita) ");
		sql.append("LEFT JOIN contareceberrecebimento ON (contareceberrecebimento.contareceber = contareceber.codigo) ");
		sql.append("LEFT JOIN formapagamento ON (formapagamento.codigo = contareceberrecebimento.formapagamento) ");
		sql.append("LEFT JOIN usuario ON (usuario.codigo = contareceberrecebimento.responsavel) ");
		sql.append("LEFT JOIN descontoprogressivo ON (contareceber.descontoprogressivo = descontoprogressivo.codigo) ");
		sql.append("LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sql.append("LEFT JOIN turma as turma ON (contareceber.turma = turma.codigo) ");
		sql.append("LEFT JOIN planofinanceiroaluno on (planofinanceiroaluno.matriculaperiodo = contareceber.matriculaperiodo) ");
		sql.append("LEFT JOIN fornecedor ON (fornecedor.codigo = contareceber.fornecedor) ");
		sql.append("left join notafiscalsaidaservico on notafiscalsaidaservico.codigo = contareceberrecebimento.notafiscalsaidaservico ");
		sql.append("left join notafiscalsaida on notafiscalsaida.codigo = notafiscalsaidaservico.notafiscalsaida ");
		sql.append("left join usuario responsavel on responsavel.codigo = notafiscalsaida.responsavel ");
		sql.append("left join usuario responsavelCancelamento on responsavelCancelamento.codigo = contaReceber.responsavelCancelamento ");
		sql.append("LEFT JOIN indicereajuste ON (contareceber.indiceReajustePadraoPorAtraso = indicereajuste.codigo) ");
		return sql;
	}

	private StringBuilder getSQLPadraoConsultaCompletaSemContaReceberRecebimento() {
		StringBuilder sql = new StringBuilder("SELECT ");
		realizarAdicaoTotalizadoresContaReceber(sql);
		sql.append(" contareceber.*, descontoProgressivo.codigo as \"descontoProgressivo.codigo\", pessoamatricula.nome AS \"Aluno.nome\", pessoamatricula.cpf AS \"Aluno.cpf\", pessoacandidato.nome AS \"Candidato.nome\", pessoacandidato.codigo AS \"Candidato.codigo\", pessoacandidato.cpf AS \"Candidato.cpf\", cc.carteiraregistrada AS \"contacorrente.carteiraregistrada\", ");
		sql.append(" indicereajuste.codigo as \"indicereajuste.codigo\" , indicereajuste.descricao as \"indicereajuste.descricao\", ");
		sql.append("descontoProgressivo.dialimite1 as \"descontoProgressivo.dialimite1\", descontoProgressivo.dialimite2 as \"descontoProgressivo.dialimite2\", descontoProgressivo.dialimite3 as \"descontoProgressivo.dialimite3\", descontoProgressivo.dialimite4 as \"descontoProgressivo.dialimite4\", ");
		sql.append("descontoProgressivo.percdescontolimite1 as \"descontoProgressivo.percdescontolimite1\", descontoProgressivo.percdescontolimite2 as \"descontoProgressivo.percdescontolimite2\", descontoProgressivo.percdescontolimite3 as \"descontoProgressivo.percdescontolimite3\", descontoProgressivo.percdescontolimite4 as \"descontoProgressivo.percdescontolimite4\", ");
		sql.append("descontoProgressivo.valordescontolimite1 as \"descontoProgressivo.valordescontolimite1\", descontoProgressivo.valordescontolimite2 as \"descontoProgressivo.valordescontolimite2\", descontoProgressivo.valordescontolimite3 as \"descontoProgressivo.valordescontolimite3\", descontoProgressivo.valordescontolimite4 as \"descontoProgressivo.valordescontolimite4\", ");
		sql.append("descontoProgressivo.utilizarDiaFixo as \"descontoProgressivo.utilizarDiaFixo\", descontoProgressivo.utilizarDiaUtil as \"descontoProgressivo.utilizarDiaUtil\", descontoProgressivo.nome as \"descontoProgressivo.nome\", ");
		sql.append(" unidadeEnsino.codigo AS \"UnidadeEnsino.codigo\", unidadeEnsino.nome AS \"UnidadeEnsino.nome\", ");
		sql.append(" unidadeEnsinoFinanceira.codigo AS \"unidadeEnsinoFinanceira.codigo\", unidadeEnsinoFinanceira.nome AS \"unidadeEnsinoFinanceira.nome\", ");
		sql.append("pessoa.nome AS \"Pessoa.nome\", pessoa.cpf AS \"Pessoa.cpf\", Pessoa.email as \"Pessoa.email\", ");
		sql.append("matricula.matricula AS \"Matricula.matricula\", funcionario.codigo AS \"Funcionario.codigo\",funcionario.matricula AS \"Funcionario.matricula\", pessoafuncionario.nome AS \"Funcionario.nome\", pessoafuncionario.codigo AS \"Funcionario.codigo\", parceiro.nome AS \"Parceiro.nome\", parceiro.cnpj AS \"Parceiro.cnpj\", parceiro.cpf AS \"Parceiro.cpf\", parceiro.isentarjuro AS \"Parceiro.isentarjuro\", parceiro.isentarmulta AS \"Parceiro.isentarmulta\",  ");
		sql.append("parceiro.codigo AS \"Parceiro.codigo\", centroreceita.codigo AS \"CentroReceita.codigo\", centroreceita.descricao AS \"CentroReceita.descricao\", ");
		sql.append(" case when contareceber.tipoorigem in ('MAT', 'MEN') then matricula.bloquearEmissaoBoletoMatMenVisaoAluno else false end as \"Matricula.bloquearEmissaoBoletoMatMenVisaoAluno\", ");
		// sql.append("parceiro.codigo AS \"Parceiro.codigo\", centroreceita.descricao AS \"CentroReceita.descricao\", contareceberrecebimento.codigo AS \"Recebimento.codigo\", contareceberrecebimento.datarecebimento AS \"Recebimento.datarecebimento\", contareceberrecebimento.tiporecebimento AS \"Recebimento.tiporecebimento\", ");
		// sql.append("contareceberrecebimento.formapagamento AS \"Recebimento.formapagamento\", formapagamento.nome AS \"FormaPagamento.nome\", contareceberrecebimento.valorrecebimento AS \"Recebimento.valorrecebimento\", ");
		// sql.append("usuario.codigo AS \"Responsavel.codigo\", usuario.nome AS \"Responsavel.nome\", contareceberrecebimento.motivo AS \"Recebimento.motivo\", responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.cpf as \"responsavelFinanceiro.cpf\", ");
		sql.append("responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.cpf as \"responsavelFinanceiro.cpf\", responsavelFinanceiro.email as \"responsavelFinanceiro.email\",  ");
		sql.append(" turma.identificadorturma,fornecedor.codigo as \"fornecedor.codigo\", fornecedor.nome as \"fornecedor.nome\", fornecedor.rg as \"fornecedor.rg\", ");
		sql.append(" planofinanceiroaluno.codigo AS \"planofinanceiroaluno.codigo\", planofinanceiroaluno.descontoValidoAteDataParcela as \"planofinanceiroaluno.descontoValidoAteDataParcela\", planofinanceiroaluno.valorDescontoParcela AS \"planofinanceiroaluno.valorDescontoParcela\", planofinanceiroaluno.valorDescontoMatricula AS \"planofinanceiroaluno.valorDescontoMatricula\", planofinanceiroaluno.percDescontoParcela AS \"planofinanceiroaluno.percDescontoParcela\", planofinanceiroaluno.percDescontoMatricula AS \"planofinanceiroaluno.percDescontoMatricula\", planofinanceiroaluno.tipoDescontoParcela AS \"planofinanceiroaluno.tipoDescontoParcela\", planofinanceiroaluno.tipoDescontoMatricula AS \"planofinanceiroaluno.tipoDescontoMatricula\", ");
		sql.append(" fornecedor.cpf as \"fornecedor.cpf\", fornecedor.cnpj as \"fornecedor.cnpj\", fornecedor.tipoEmpresa as \"fornecedor.tipoEmpresa\", pessoamatricula.codigo as \"pessoamatricula.codigo\", contareceber.processamentointegracaofinanceiradetalhe, ");
		sql.append(" contareceber.pagocomdcc, unidadeEnsinoFinanceira.codigo AS \"unidadeensinofinanceira.codigo\", unidadeensinofinanceira.cidade, ");
		sql.append(" case when contareceber.situacao = 'RE' then valorRecebido else valorReceberCalculado end AS \"valorfinalcalculado\" ");
//		sql.append(" case when contareceber.situacao =  'AR' and cc.bloquearEmitirBoletoSemRegistroRemessa and exists ( ");
//		sql.append("  SELECT DISTINCT controleremessacontareceber.codigo ");
//		sql.append("  from controleRemessaContaReceber  ");
//		sql.append("  WHERE controleRemessaContaReceber.contareceber = contareceber.codigo ");
//		sql.append("  and controleRemessaContaReceber.situacao in ('AGUARDANDO_PROCESSAMENTO', 'REMETIDA') ");
//		sql.append(" order by controleRemessaContaReceber.codigo limit 1 ) then true  ");
//		sql.append(" else false end as bloquearPagamentoAluno,  ");
//		sql.append(" case when (configuracaoFinanceiro.bloquearcalouropagarmatriculavisaoaluno and contareceber.tipoorigem = 'MAT' ");
//		sql.append(" and (select count(mp.codigo) from matriculaPeriodo as mp where mp.matricula = matricula.matricula and  mp.situacaoMatriculaPeriodo in ('PR', 'AT', 'FI')) > 1) or ");
//		
//		sql.append(" (contareceber.tipoorigem = 'MAT' and configuracaoFinanceiro.bloquearPagarMatriculaRenovacaoVisaoAlunoInadimplente and curso.periodicidade != 'IN' and ");
//		sql.append(" ((configuracaoFinanceiro.utilizarIntegracaoFinanceira and exists (select cr.codigo from contareceber as cr where cr.matriculaaluno =  matricula.matricula and cr.possuipendenciasfinanceirasexternas and cr.situacao = 'AR' limit 1)) ");
//		sql.append(" or (exists ( ");
//		sql.append(" select cr.codigo from contareceber as cr where cr.matriculaaluno =  matricula.matricula and cr.datavencimento < current_date and cr.tipoorigem in ('MEN', 'MDI', 'NCR', 'IRE') and cr.situacao = 'AR' limit 1 ");
//		sql.append(" )) ");
//		sql.append(" )) ");
//		sql.append(" then true ");
//		sql.append(" else false end as 	bloquearPagamentoCartaoPorOutrosDebitos ");
		sql.append("FROM contareceber ");
		sql.append("INNER JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sql.append("INNER JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sql.append("INNER join contacorrente cc on contareceber.contacorrente = cc.codigo ");
//		sql.append("left join configuracoes on (unidadeEnsinoFinanceira.configuracoes is not null and  configuracoes.codigo = unidadeEnsinoFinanceira.configuracoes) or (unidadeEnsinoFinanceira.configuracoes is null and configuracoes.padrao ) ");
//		sql.append("left join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = configuracoes.codigo ");		
		sql.append("LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo) ");		
		sql.append("LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) ");
		sql.append("LEFT JOIN parceiro ON (parceiro.codigo = contareceber.parceiro) ");
		sql.append("LEFT JOIN pessoa as pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sql.append("LEFT JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) ");
//		sql.append("LEFT JOIN curso ON (matricula.curso = curso.codigo) ");
		sql.append("LEFT JOIN pessoa as pessoamatricula ON (matricula.aluno = pessoamatricula.codigo) ");
		sql.append("LEFT JOIN pessoa as pessoacandidato ON (contareceber.candidato = pessoacandidato.codigo) ");
		sql.append("LEFT JOIN centroreceita ON (centroreceita.codigo = contareceber.centroreceita) ");
		// sql.append("LEFT JOIN contareceberrecebimento ON (contareceberrecebimento.contareceber = contareceber.codigo) ");
		// sql.append("LEFT JOIN formapagamento ON (formapagamento.codigo = contareceberrecebimento.formapagamento) ");
		// sql.append("LEFT JOIN usuario ON (usuario.codigo = contareceberrecebimento.responsavel) ");
		sql.append("LEFT JOIN descontoprogressivo ON (contareceber.descontoprogressivo = descontoprogressivo.codigo) ");
		sql.append("LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sql.append("LEFT JOIN turma as turma ON (contareceber.turma = turma.codigo) ");
		sql.append("LEFT JOIN planofinanceiroaluno on (planofinanceiroaluno.matriculaperiodo = contareceber.matriculaperiodo) ");
		sql.append("LEFT JOIN fornecedor ON (fornecedor.codigo = contareceber.fornecedor) ");
		sql.append(" LEFT JOIN indicereajuste ON (contareceber.indiceReajustePadraoPorAtraso = indicereajuste.codigo) ");
		return sql;
	}

	private StringBuilder getSQLPadraoConsultaCompletaSemContaReceberRecebimentoDistinct() {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT distinct contareceber.*, descontoProgressivo.codigo as \"descontoProgressivo.codigo\", pessoamatricula.nome AS \"Aluno.nome\", pessoamatricula.cpf AS \"Aluno.cpf\", pessoacandidato.nome AS \"Candidato.nome\", pessoacandidato.codigo AS \"Candidato.codigo\", pessoacandidato.cpf AS \"Candidato.cpf\",  cc.carteiraregistrada AS \"contacorrente.carteiraregistrada\", ");
		sql.append(" indicereajuste.codigo as \"indicereajuste.codigo\" , indicereajuste.descricao as \"indicereajuste.descricao\", ");
		sql.append("descontoProgressivo.dialimite1 as \"descontoProgressivo.dialimite1\", descontoProgressivo.dialimite2 as \"descontoProgressivo.dialimite2\", descontoProgressivo.dialimite3 as \"descontoProgressivo.dialimite3\", descontoProgressivo.dialimite4 as \"descontoProgressivo.dialimite4\", ");
		sql.append("descontoProgressivo.percdescontolimite1 as \"descontoProgressivo.percdescontolimite1\", descontoProgressivo.percdescontolimite2 as \"descontoProgressivo.percdescontolimite2\", descontoProgressivo.percdescontolimite3 as \"descontoProgressivo.percdescontolimite3\", descontoProgressivo.percdescontolimite4 as \"descontoProgressivo.percdescontolimite4\", ");
		sql.append("descontoProgressivo.valordescontolimite1 as \"descontoProgressivo.valordescontolimite1\", descontoProgressivo.valordescontolimite2 as \"descontoProgressivo.valordescontolimite2\", descontoProgressivo.valordescontolimite3 as \"descontoProgressivo.valordescontolimite3\", descontoProgressivo.valordescontolimite4 as \"descontoProgressivo.valordescontolimite4\", ");
		sql.append("descontoProgressivo.utilizarDiaFixo as \"descontoProgressivo.utilizarDiaFixo\", descontoProgressivo.utilizarDiaUtil as \"descontoProgressivo.utilizarDiaUtil\", descontoProgressivo.nome as \"descontoProgressivo.nome\", ");
		sql.append("unidadeEnsino.codigo AS \"UnidadeEnsino.codigo\", unidadeEnsino.nome AS \"UnidadeEnsino.nome\", ");
		sql.append("unidadeEnsinoFinanceira.codigo AS \"unidadeEnsinoFinanceira.codigo\", unidadeEnsinoFinanceira.nome AS \"unidadeEnsinoFinanceira.nome\", ");
		sql.append("pessoa.nome AS \"Pessoa.nome\", pessoa.cpf AS \"Pessoa.cpf\", Pessoa.email as \"Pessoa.email\", ");
		sql.append("matricula.matricula AS \"Matricula.matricula\", funcionario.codigo AS \"Funcionario.codigo\",funcionario.matricula AS \"Funcionario.matricula\", pessoafuncionario.nome AS \"Funcionario.nome\", pessoafuncionario.codigo AS \"Funcionario.codigo\", parceiro.nome AS \"Parceiro.nome\", parceiro.cnpj AS \"Parceiro.cnpj\", parceiro.cpf AS \"Parceiro.cpf\", parceiro.isentarjuro AS \"Parceiro.isentarjuro\", parceiro.isentarmulta AS \"Parceiro.isentarmulta\",  ");
		sql.append("parceiro.codigo AS \"Parceiro.codigo\", centroreceita.codigo AS \"CentroReceita.codigo\", centroreceita.descricao AS \"CentroReceita.descricao\", ");
		sql.append(" case when contareceber.tipoorigem in ('MAT', 'MEN') then matricula.bloquearEmissaoBoletoMatMenVisaoAluno else false end as \"Matricula.bloquearEmissaoBoletoMatMenVisaoAluno\", ");
		// sql.append("parceiro.codigo AS \"Parceiro.codigo\", centroreceita.descricao AS \"CentroReceita.descricao\", contareceberrecebimento.codigo AS \"Recebimento.codigo\", contareceberrecebimento.datarecebimento AS \"Recebimento.datarecebimento\", contareceberrecebimento.tiporecebimento AS \"Recebimento.tiporecebimento\", ");
		// sql.append("contareceberrecebimento.formapagamento AS \"Recebimento.formapagamento\", formapagamento.nome AS \"FormaPagamento.nome\", contareceberrecebimento.valorrecebimento AS \"Recebimento.valorrecebimento\", ");
		// sql.append("usuario.codigo AS \"Responsavel.codigo\", usuario.nome AS \"Responsavel.nome\", contareceberrecebimento.motivo AS \"Recebimento.motivo\", responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.cpf as \"responsavelFinanceiro.cpf\", ");
		sql.append("responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.cpf as \"responsavelFinanceiro.cpf\", responsavelFinanceiro.email as \"responsavelFinanceiro.email\",  ");
		sql.append(" turma.identificadorturma,fornecedor.codigo as \"fornecedor.codigo\", fornecedor.nome as \"fornecedor.nome\", fornecedor.rg as \"fornecedor.rg\", ");
		sql.append(" planofinanceiroaluno.codigo AS \"planofinanceiroaluno.codigo\", planofinanceiroaluno.descontoValidoAteDataParcela as \"planofinanceiroaluno.descontoValidoAteDataParcela\", planofinanceiroaluno.valorDescontoParcela AS \"planofinanceiroaluno.valorDescontoParcela\", planofinanceiroaluno.valorDescontoMatricula AS \"planofinanceiroaluno.valorDescontoMatricula\", planofinanceiroaluno.percDescontoParcela AS \"planofinanceiroaluno.percDescontoParcela\", planofinanceiroaluno.percDescontoMatricula AS \"planofinanceiroaluno.percDescontoMatricula\", planofinanceiroaluno.tipoDescontoParcela AS \"planofinanceiroaluno.tipoDescontoParcela\", planofinanceiroaluno.tipoDescontoMatricula AS \"planofinanceiroaluno.tipoDescontoMatricula\", ");
		sql.append(" fornecedor.cpf as \"fornecedor.cpf\", fornecedor.cnpj as \"fornecedor.cnpj\", fornecedor.tipoEmpresa as \"fornecedor.tipoEmpresa\", pessoamatricula.codigo as \"pessoamatricula.codigo\", contareceber.processamentointegracaofinanceiradetalhe, ");
		sql.append(" contareceber.pagocomdcc, ");
		sql.append(" case when contareceber.situacao = 'RE' then valorRecebido else valorReceberCalculado end AS \"valorfinalcalculado\" ");
		sql.append("FROM contareceber ");
		sql.append("INNER JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sql.append("INNER JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sql.append("INNER join contacorrente cc on contareceber.contacorrente = cc.codigo ");
		sql.append("LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo) ");
		sql.append("LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) ");
		sql.append("LEFT JOIN parceiro ON (parceiro.codigo = contareceber.parceiro) ");
		sql.append("LEFT JOIN pessoa as pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sql.append("LEFT JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) ");
		sql.append("LEFT JOIN pessoa as pessoamatricula ON (matricula.aluno = pessoamatricula.codigo) ");
		sql.append("LEFT JOIN pessoa as pessoacandidato ON (contareceber.candidato = pessoacandidato.codigo) ");
		sql.append("LEFT JOIN centroreceita ON (centroreceita.codigo = contareceber.centroreceita) ");
		// sql.append("LEFT JOIN contareceberrecebimento ON (contareceberrecebimento.contareceber = contareceber.codigo) ");
		// sql.append("LEFT JOIN formapagamento ON (formapagamento.codigo = contareceberrecebimento.formapagamento) ");
		// sql.append("LEFT JOIN usuario ON (usuario.codigo = contareceberrecebimento.responsavel) ");
		sql.append("LEFT JOIN descontoprogressivo ON (contareceber.descontoprogressivo = descontoprogressivo.codigo) ");
		sql.append("LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sql.append("LEFT JOIN turma as turma ON (contareceber.turma = turma.codigo) ");
		sql.append("LEFT JOIN planofinanceiroaluno on (planofinanceiroaluno.matriculaperiodo = contareceber.matriculaperiodo) ");
		sql.append("LEFT JOIN fornecedor ON (fornecedor.codigo = contareceber.fornecedor) ");
		sql.append(" LEFT JOIN indicereajuste ON (contareceber.indiceReajustePadraoPorAtraso = indicereajuste.codigo) ");
		return sql;
	}

	public void carregarDados(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		carregarDados(obj, NivelMontarDados.TODOS, configuracaoFinanceiroVO, usuario);
	}

	public void carregarDados(ContaReceberVO obj, NivelMontarDados nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		SqlRowSet resultado = null;
		if ((nivelMontarDados.equals(NivelMontarDados.BASICO)) && (obj.getIsNivelMontarDadosNaoInicializado())) {
			resultado = consultaRapidaPorChavePrimariaDadosBasicos(obj.getCodigo(), Boolean.FALSE, usuario);
			montarDadosBasico(obj, resultado);
		}
		if ((nivelMontarDados.equals(NivelMontarDados.TODOS)) && (!obj.getIsNivelMontarDadosTodos())) {
			resultado = consultaRapidaPorChavePrimariaDadosCompletos(obj.getCodigo(), Boolean.FALSE, usuario);
			montarDadosCompleto(obj, resultado, configuracaoFinanceiroVO, usuario);
		}
	}

	@Override
	public void montarDadosBasico(ContaReceberVO obj, SqlRowSet dadosSQL) throws Exception {
		obj.setCodigo(dadosSQL.getInt("codigo"));
		// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(dadosSQL.getInt("registrocobrancacontareceber"));
		obj.setCodOrigem(dadosSQL.getString("codorigem"));
		obj.setCodigoBarra(dadosSQL.getString("codigobarra"));
		obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhaDigitavelCodigoBarras"));
		obj.setTipoPessoa(dadosSQL.getString("tipopessoa"));
		obj.setNrDocumento(dadosSQL.getString("nrdocumento"));
		obj.setNossoNumero(dadosSQL.getString("nossonumero"));
		obj.setNossoNumeroBanco(dadosSQL.getString("nossonumerobanco"));
		obj.setDuplicidadeTratada(dadosSQL.getBoolean("duplicidadeTratada"));
		obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaperiodo"));
		obj.setContaReceberAgrupada(dadosSQL.getInt("contareceberagrupada"));
		obj.setPossuiPendenciasFinanceirasExternas(dadosSQL.getBoolean("possuiPendenciasFinanceirasExternas"));
		obj.setPossuiFiesIntegracaoFinanceiras(dadosSQL.getBoolean("possuiFiesIntegracaoFinanceiras"));
		obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
		obj.getTurma().setIdentificadorTurma(dadosSQL.getString("identificadorTurma"));
		obj.getPessoa().setCodigo(dadosSQL.getInt("pessoa"));
		obj.getPessoa().setNome(dadosSQL.getString("Pessoa.nome"));
		obj.getPessoa().setCPF(dadosSQL.getString("Pessoa.cpf"));
		obj.getPessoa().setEmail(dadosSQL.getString("Pessoa.email"));
		obj.getResponsavelFinanceiro().setCodigo(dadosSQL.getInt("responsavelFinanceiro"));
		obj.getResponsavelFinanceiro().setNome(dadosSQL.getString("responsavelFinanceiro.nome"));
		obj.getResponsavelFinanceiro().setCPF(dadosSQL.getString("responsavelFinanceiro.cpf"));
		obj.getResponsavelFinanceiro().setEmail(dadosSQL.getString("responsavelFinanceiro.email"));
		obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("UnidadeEnsino.codigo"));
		obj.getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
		obj.getUnidadeEnsinoFinanceira().setCodigo(dadosSQL.getInt("unidadeensinofinanceira.codigo"));
		obj.getUnidadeEnsinoFinanceira().setNome(dadosSQL.getString("unidadeEnsinoFinanceira.nome"));
		obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor.codigo"));
		obj.getFornecedor().setNome(dadosSQL.getString("fornecedor.nome"));
		obj.getFornecedor().setRG(dadosSQL.getString("fornecedor.rg"));
		obj.getFornecedor().setCPF(dadosSQL.getString("fornecedor.cpf"));
		obj.getFornecedor().setCNPJ(dadosSQL.getString("fornecedor.cnpj"));
		obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("fornecedor.tipoEmpresa"));
		obj.getNotaFiscalSaidaServicoVO().setCodigo(dadosSQL.getInt("notafiscalsaidaservico"));

		switch (TipoPessoa.getEnum(obj.getTipoPessoa())) {
		case ALUNO:
			obj.getMatriculaAluno().setMatricula(dadosSQL.getString("Matricula.matricula"));
			obj.getMatriculaAluno().setBloquearEmissaoBoletoMatMenVisaoAluno(dadosSQL.getBoolean("Matricula.bloquearEmissaoBoletoMatMenVisaoAluno"));
			obj.setBloquearPagamentoVisaoAluno(dadosSQL.getBoolean("Matricula.bloquearEmissaoBoletoMatMenVisaoAluno"));
			if (dadosSQL.getString("Aluno.nome") != null) {
				obj.getMatriculaAluno().getAluno().setNome(dadosSQL.getString("Aluno.nome"));
				obj.getMatriculaAluno().getAluno().setCodigo(dadosSQL.getInt("pessoamatricula.codigo"));
			} else {
				obj.getMatriculaAluno().getAluno().setNome(obj.getPessoa().getNome());
				obj.getMatriculaAluno().getAluno().setCodigo(obj.getPessoa().getCodigo());
			}

			break;
		case RESPONSAVEL_FINANCEIRO:
			obj.getMatriculaAluno().setMatricula(dadosSQL.getString("Matricula.matricula"));
			obj.getMatriculaAluno().getAluno().setNome(dadosSQL.getString("Aluno.nome"));
			obj.getMatriculaAluno().getAluno().setCodigo(dadosSQL.getInt("pessoamatricula.codigo"));
			// obj.getMatriculaAluno().getAluno().setNome(obj.getPessoa().getNome());
			// obj.getMatriculaAluno().getAluno().setCodigo(obj.getPessoa().getCodigo());
			break;
		case CANDIDATO:
			obj.getCandidato().setNome(dadosSQL.getString("Candidato.nome"));
			obj.getCandidato().setCodigo(dadosSQL.getInt("Candidato.codigo"));
			obj.getCandidato().setCPF(dadosSQL.getString("Candidato.cpf"));
			break;
		case FUNCIONARIO:
			obj.getFuncionario().setCodigo(dadosSQL.getInt("Funcionario.codigo"));
			obj.getFuncionario().setMatricula(dadosSQL.getString("Funcionario.matricula"));
			obj.getFuncionario().getPessoa().setNome(dadosSQL.getString("Funcionario.nome"));
			obj.getFuncionario().getPessoa().setCodigo(obj.getPessoa().getCodigo());
			break;
		case PARCEIRO:
			obj.getParceiroVO().setNome(dadosSQL.getString("Parceiro.nome"));
			obj.getParceiroVO().setCPF(dadosSQL.getString("Parceiro.cpf"));
			obj.getParceiroVO().setCNPJ(dadosSQL.getString("Parceiro.cnpj"));
			obj.getParceiroVO().setCodigo(dadosSQL.getInt("Parceiro.codigo"));
			obj.getParceiroVO().setIsentarJuro(dadosSQL.getBoolean("Parceiro.isentarJuro"));
			obj.getParceiroVO().setIsentarMulta(dadosSQL.getBoolean("Parceiro.isentarMulta"));
			obj.getMatriculaAluno().setMatricula(dadosSQL.getString("Matricula.matricula"));
			obj.getMatriculaAluno().getAluno().setNome(dadosSQL.getString("Aluno.nome"));
			obj.getMatriculaAluno().getAluno().setCodigo(dadosSQL.getInt("pessoamatricula.codigo"));
			obj.getPessoa().setNome(dadosSQL.getString("Aluno.nome"));
			obj.getPessoa().setCodigo(dadosSQL.getInt("pessoamatricula.codigo"));
			// obj.getMatriculaAluno().getAluno().setCodigo(obj.getPessoa().getCodigo());
			break;
		}
		obj.setContaCorrente(dadosSQL.getInt("contacorrente"));
		obj.getContaCorrenteVO().setCodigo(dadosSQL.getInt("contacorrente"));
		obj.getContaCorrenteVO().setCarteiraRegistrada(dadosSQL.getBoolean("contacorrente.carteiraregistrada"));
		obj.setParcela(dadosSQL.getString("parcela"));
		obj.setValor(dadosSQL.getDouble("valor"));
		obj.setValorBaseContaReceber(dadosSQL.getDouble("valorBaseContaReceber"));
		obj.setValorRecebido(dadosSQL.getDouble("valorRecebido"));
		obj.setValorDescontoCalculado(dadosSQL.getDouble("valorDescontoCalculado"));
		obj.setValorDescontoRateio(dadosSQL.getDouble("valorDescontoRateio"));
		obj.setValorReceberCalculado(dadosSQL.getDouble("valorReceberCalculado"));
		obj.setJuro(dadosSQL.getDouble("juro"));
		obj.setMulta(dadosSQL.getDouble("multa"));
		Optional<BigDecimal> valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa = Optional.ofNullable(dadosSQL.getBigDecimal("valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa"));
		obj.setValorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa(valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa.orElse(BigDecimal.ZERO));
		obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
		obj.setValorIndiceReajustePorAtraso(dadosSQL.getBigDecimal("valorIndiceReajustePorAtraso"));
		obj.setLiberadoDoIndiceReajustePorAtraso(dadosSQL.getBoolean("liberadoDoIndiceReajustePorAtraso"));
		obj.setDataVencimento(dadosSQL.getTimestamp("dataVencimento"));
		obj.setDataVencimentoAntesAlteracao(dadosSQL.getTimestamp("dataVencimento"));
		obj.setDataCompetencia(dadosSQL.getTimestamp("dataCompetencia"));
		obj.setDataProcessamentoValorReceber(dadosSQL.getTimestamp("dataProcessamentoValorReceber"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setMultaPorcentagem(dadosSQL.getDouble("multaPorcentagem"));
		obj.setJuroPorcentagem(dadosSQL.getDouble("juroPorcentagem"));
		obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
		obj.setTipoOrigem(dadosSQL.getString("tipoOrigem"));
		obj.setTipoDesconto(dadosSQL.getString("tipoDesconto"));
		obj.setUpdated(dadosSQL.getTimestamp("updated"));
		// Desconto Lançado Recebimento
		obj.setValorDescontoLancadoRecebimento(dadosSQL.getDouble("valorDescontoLancadoRecebimento"));
		obj.setValorCalculadoDescontoLancadoRecebimento(dadosSQL.getDouble("valorCalculadoDescontoLancadoRecebimento"));
		obj.setTipoDescontoLancadoRecebimento(dadosSQL.getString("tipoDescontoLancadoRecebimento"));
		obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
		obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));
		obj.setUsaDescontoCompostoPlanoDesconto(dadosSQL.getBoolean("usaDescontoCompostoPlanoDesconto"));
		obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoProgressivo"));
		obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
		obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
		obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
		obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
		obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
		obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
		obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
		obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
		obj.setContaEditadaManualmente(dadosSQL.getBoolean("contaEditadaManualmente"));
		obj.setUtilizarDescontoProgressivoManual(dadosSQL.getBoolean("utilizarDescontoProgressivoManual"));
		if (obj.getUtilizarDescontoProgressivoManual()) {
			obj.setDiaLimite1(dadosSQL.getInt("diaLimite1"));
			obj.setDiaLimite2(dadosSQL.getInt("diaLimite2"));
			obj.setDiaLimite3(dadosSQL.getInt("diaLimite3"));
			obj.setDiaLimite4(dadosSQL.getInt("diaLimite4"));
		}
		obj.getCentroReceita().setCodigo(dadosSQL.getInt("CentroReceita.codigo"));
		obj.getCentroReceita().setDescricao(dadosSQL.getString("CentroReceita.descricao"));
		obj.setValorDescontoConvenio(dadosSQL.getDouble("descontoConvenio"));
		obj.setValorDescontoInstituicao(dadosSQL.getDouble("descontoInstituicao"));
		obj.setValorDescontoProgressivo(dadosSQL.getDouble("valorDescontoProgressivo"));
		obj.getProcessamentoIntegracaoFinanceiraDetalheVO().setCodigo(dadosSQL.getInt("processamentointegracaofinanceiradetalhe"));
		obj.getNotaFiscalSaidaServicoVO().setCodigo(dadosSQL.getInt("notafiscalsaidaservico"));		
		
		obj.getIndiceReajustePadraoPorAtraso().setCodigo(dadosSQL.getInt("indicereajuste.codigo"));
		obj.getIndiceReajustePadraoPorAtraso().setDescricao(dadosSQL.getString("indicereajuste.descricao"));
		montarDadosContaCorrente(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, null);
		montarDadosRegistroCobranca(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, null);
		obj.setHistoricoNegativacoes(getFacadeFactory().getRegistroNegativacaoCobrancaContaReceberItemFacade().carregarHistoricoNegativacaoContaReceber(obj.getCodigo()));
		obj.setEmissaoBloqueada(this.verificaBloqueioEmissaoBoleto(obj, null));
		if (Uteis.isAtributoPreenchido(dadosSQL.getBoolean("pagocomdcc"))) {
			obj.setPagoComDCC(dadosSQL.getBoolean("pagocomdcc"));
		}
		if (Uteis.isAtributoPreenchido(obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getCodigo())) {
			obj.setProcessamentoIntegracaoFinanceiraDetalheVO(getFacadeFactory().getIntegracaoFinanceiroFacade().consultaPorCodigoProcessamentoIntegracaoFinanceiro(obj.getProcessamentoIntegracaoFinanceiraDetalheVO().getCodigo()));
		}
	}

	private void montarDadosCompleto(ContaReceberVO obj, SqlRowSet dadosSQL, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<ContaReceberRecebimentoVO> listaRecebimentos = new ArrayList<ContaReceberRecebimentoVO>(0);
		try {
			if (dadosSQL.next()) {
				montarDadosBasico(obj, dadosSQL);
				//montarDadosContaCorrente(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
				obj.setDataLimitePrimeiraFaixaDescontos(dadosSQL.getDate("datalimiteprimeirafaixadescontos"));
				obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(dadosSQL.getDouble("valordescontocalculadoprimeirafaixadescontos"));
				obj.setDataLimiteSegundaFaixaDescontos(dadosSQL.getDate("datalimitesegundafaixadescontos"));
				obj.setValorDescontoCalculadoSegundaFaixaDescontos(dadosSQL.getDouble("valordescontocalculadosegundafaixadescontos"));
				obj.setDataLimiteTerceiraFaixaDescontos(dadosSQL.getDate("datalimiteterceirafaixadescontos"));
				obj.setValorDescontoCalculadoTerceiraFaixaDescontos(dadosSQL.getDouble("valordescontocalculadoterceirafaixadescontos"));
				obj.setDataLimiteQuartaFaixaDescontos(dadosSQL.getDate("datalimiteQuartafaixadescontos"));
				obj.setValorDescontoCalculadoQuartaFaixaDescontos(dadosSQL.getDouble("valordescontocalculadoQuartafaixadescontos"));
				obj.setIdentificacaoTituloBanco(dadosSQL.getString("identificacaoTituloBanco"));
				obj.setData(dadosSQL.getDate("data"));
				obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
				obj.getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
				obj.getUnidadeEnsino().getCidade().setCodigo(dadosSQL.getInt("cidade"));
				obj.getUnidadeEnsinoFinanceira().setCodigo(dadosSQL.getInt("unidadeensinofinanceira.codigo"));
				obj.getUnidadeEnsinoFinanceira().setNome(dadosSQL.getString("unidadeensinofinanceira.nome"));
				obj.getUnidadeEnsinoFinanceira().getCidade().setCodigo(dadosSQL.getInt("cidade"));
				obj.setCodOrigem(dadosSQL.getString("codorigem"));
				obj.setTipoOrigem(dadosSQL.getString("tipoorigem"));
				obj.setDescricaoPagamento(dadosSQL.getString("descricaopagamento"));
				obj.setValorRecebido(dadosSQL.getDouble("valorrecebido"));
				obj.setJuroPorcentagem(dadosSQL.getDouble("juroporcentagem"));
				obj.setJuro(dadosSQL.getDouble("juro"));
				obj.setMultaPorcentagem(dadosSQL.getDouble("multaporcentagem"));
				obj.setMulta(dadosSQL.getDouble("multa"));
				obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
				obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhadigitavelcodigobarras"));
				obj.setContaCorrente(dadosSQL.getInt("contacorrente"));
				obj.getCentroReceita().setCodigo(dadosSQL.getInt("centroreceita"));
				obj.getCentroReceita().setDescricao(dadosSQL.getString("CentroReceita.descricao"));
				obj.setTipoBoleto(dadosSQL.getString("tipoboleto"));
				obj.getConvenio().setCodigo(dadosSQL.getInt("convenio"));
				obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaperiodo"));
				obj.setDataArquivoRemessa(dadosSQL.getDate("dataArquivoRemessa"));
				obj.setContaReceberAgrupada(dadosSQL.getInt("contaReceberAgrupada"));
				obj.getRenegociacaoContaReceberOrigem().setCodigo(dadosSQL.getInt("codigoRenegociacao"));
				obj.setPagoComDCC(dadosSQL.getBoolean("pagocomdcc"));
				obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor.codigo"));
				obj.getFornecedor().setNome(dadosSQL.getString("fornecedor.nome"));
				obj.getFornecedor().setRG(dadosSQL.getString("fornecedor.rg"));
				obj.getFornecedor().setCPF(dadosSQL.getString("fornecedor.cpf"));
				obj.getFornecedor().setCNPJ(dadosSQL.getString("fornecedor.cnpj"));
				obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("fornecedor.tipoEmpresa"));

				obj.setDuplicidadeTratada(dadosSQL.getBoolean("duplicidadeTratada"));
				obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
				obj.getTurma().setIdentificadorTurma(dadosSQL.getString("identificadorTurma"));

				// obj.setDescontoProgressivoUtilizado(dadosSQL.getString("descontoprogressivoutilizado"));

				obj.setOrigemNegociacaoReceber(dadosSQL.getInt("origemnegociacaoreceber"));
				obj.setCodigoBarra(dadosSQL.getString("codigobarra"));
				obj.setNossoNumero(dadosSQL.getString("nossonumero"));
				obj.setTituloImportadoSistemaLegado(dadosSQL.getBoolean("tituloImportadoSistemaLegado"));
				obj.setRecebimentoBancario((Boolean) dadosSQL.getObject("recebimentoBancario"));

				obj.setContaEditadaManualmente(dadosSQL.getBoolean("contaEditadaManualmente"));
				obj.setUtilizarDescontoProgressivoManual(dadosSQL.getBoolean("utilizarDescontoProgressivoManual"));
				if (obj.getUtilizarDescontoProgressivoManual()) {
					obj.setDiaLimite1(dadosSQL.getInt("diaLimite1"));
					obj.setDiaLimite2(dadosSQL.getInt("diaLimite2"));
					obj.setDiaLimite3(dadosSQL.getInt("diaLimite3"));
					obj.setDiaLimite4(dadosSQL.getInt("diaLimite4"));
				}

				// Dados do Desconto Progressivo
				obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoprogressivo"));
				obj.setDescontoProgressivoUtilizado(FaixaDescontoProgressivo.getEnum(dadosSQL.getString("descontoprogressivoutilizado")));
				obj.getDescontoProgressivo().setNome(dadosSQL.getString("descontoprogressivo.nome"));
				obj.getDescontoProgressivo().setDiaLimite1(dadosSQL.getInt("descontoprogressivo.dialimite1"));
				obj.getDescontoProgressivo().setDiaLimite2(dadosSQL.getInt("descontoprogressivo.dialimite2"));
				obj.getDescontoProgressivo().setDiaLimite3(dadosSQL.getInt("descontoprogressivo.dialimite3"));
				obj.getDescontoProgressivo().setDiaLimite4(dadosSQL.getInt("descontoprogressivo.dialimite4"));
				if (obj.getUtilizarDescontoProgressivoManual()) {
					obj.getDescontoProgressivo().setDescontoProgressivoEditadoManualmenteContaReceber(Boolean.TRUE);
					obj.getDescontoProgressivo().setDiaLimite1(obj.getDiaLimite1());
					obj.getDescontoProgressivo().setDiaLimite2(obj.getDiaLimite2());
					obj.getDescontoProgressivo().setDiaLimite3(obj.getDiaLimite3());
					obj.getDescontoProgressivo().setDiaLimite4(obj.getDiaLimite4());
				}
				obj.getDescontoProgressivo().setPercDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.percdescontolimite1"));
				obj.getDescontoProgressivo().setPercDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.percdescontolimite2"));
				obj.getDescontoProgressivo().setPercDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.percdescontolimite3"));
				obj.getDescontoProgressivo().setPercDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.percdescontolimite4"));			
				obj.getDescontoProgressivo().setValorDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.valordescontolimite1"));
				obj.getDescontoProgressivo().setValorDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.valordescontolimite2"));
				obj.getDescontoProgressivo().setValorDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.valordescontolimite3"));
				obj.getDescontoProgressivo().setValorDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.valordescontolimite4"));
				obj.getDescontoProgressivo().setUtilizarDiaFixo(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaFixo"));
				obj.getDescontoProgressivo().setUtilizarDiaUtil(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaUtil"));
				// TODO Alberto 08/12/10 acrescentado valor fixo desconto
				// progressivo
				// Desconto Lançado Recebimento
				obj.setValorDescontoLancadoRecebimento(dadosSQL.getDouble("valorDescontoLancadoRecebimento"));
				obj.setValorCalculadoDescontoLancadoRecebimento(dadosSQL.getDouble("valorCalculadoDescontoLancadoRecebimento"));
				obj.setTipoDescontoLancadoRecebimento(dadosSQL.getString("tipoDescontoLancadoRecebimento"));
				// montar dados plano desconto
				obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
				obj.setDetalhamentoValorContaVOs(getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().consultaRapidaPorOrigemCodigoOrigemConta(OrigemDetalhamentoContaEnum.CONTA_RECEBER, obj.getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
				obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
				obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
				obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
				obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
				obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
				obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
				obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
				obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
				obj.setTipoDesconto(dadosSQL.getString("tipodesconto"));
				obj.setValorDescontoRecebido(dadosSQL.getDouble("valordescontorecebido"));
				obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
				obj.setValorCusteadoContaReceber(dadosSQL.getDouble("valorCusteadoContaReceber"));
				obj.setValorBaseContaReceber(dadosSQL.getDouble("valorBaseContaReceber"));
				obj.setJustificativaDesconto(dadosSQL.getString("justificativaDesconto"));
				obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
				obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));
				obj.setMotivoCancelamento(dadosSQL.getString("motivoCancelamento"));
				obj.setDataCancelamento(dadosSQL.getDate("dataCancelamento"));
				obj.getResponsavelCancelamentoVO().setCodigo(dadosSQL.getInt("responsavelCancelamento"));
				obj.getResponsavelCancelamentoVO().setNome(dadosSQL.getString("responsavelCancelamento.nome"));
				obj.getMatriculaAluno().getPlanoFinanceiroAluno().setDescontoValidoAteDataParcela(dadosSQL.getBoolean("planofinanceiroaluno.descontoValidoAteDataParcela"));
				obj.getMatriculaAluno().getPlanoFinanceiroAluno().setCodigo(dadosSQL.getInt("planofinanceiroaluno.codigo"));
				obj.getMatriculaAluno().getPlanoFinanceiroAluno().setValorDescontoParcela(dadosSQL.getDouble("planofinanceiroaluno.valorDescontoParcela"));
				obj.getMatriculaAluno().getPlanoFinanceiroAluno().setValorDescontoMatricula(dadosSQL.getDouble("planofinanceiroaluno.valorDescontoMatricula"));
				obj.getMatriculaAluno().getPlanoFinanceiroAluno().setPercDescontoParcela(dadosSQL.getDouble("planofinanceiroaluno.percDescontoParcela"));
				obj.getMatriculaAluno().getPlanoFinanceiroAluno().setPercDescontoMatricula(dadosSQL.getDouble("planofinanceiroaluno.percDescontoMatricula"));
				obj.getMatriculaAluno().getPlanoFinanceiroAluno().setTipoDescontoParcela(dadosSQL.getString("planofinanceiroaluno.tipoDescontoParcela"));
				obj.getMatriculaAluno().getPlanoFinanceiroAluno().setTipoDescontoMatricula(dadosSQL.getString("planofinanceiroaluno.tipoDescontoMatricula"));
				if (obj.getTipoOrigem().equals(TipoOrigemContaReceber.MENSALIDADE.getValor()) || obj.getTipoOrigem().equals(TipoOrigemContaReceber.BOLSA_CUSTEADA_CONVENIO.getValor()) ) {
					obj.setValorIndiceReajuste(dadosSQL.getBigDecimal("valorIndiceReajuste"));
//					obj.setValorIndiceReajuste(getFacadeFactory().getIndiceReajustePeriodoMatriculaPeriodoVencimentoFacade().consultarValorIndiceReajusteASerAplicadoContaReceberPorMatriculaPeriodoSituacao(obj.getMatriculaPeriodo(), SituacaoExecucaoEnum.PROCESSADO, obj.getParcela(), usuario));
//					obj.setValorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa(getFacadeFactory().getIndiceReajustePeriodoMatriculaPeriodoVencimentoFacade().consultarValorReajusteDiferencaParcelaRecebidaOuEnviadaRemessaASerAplicadoContaReceberPorMatriculaPeriodoSituacaoParcela(obj.getMatriculaPeriodo(), SituacaoExecucaoEnum.PROCESSADO, obj.getParcela(), usuario));
				}
				obj.setEmissaoBloqueada(this.verificaBloqueioEmissaoBoleto(obj, usuario));
				// montar dados nota fiscal saida
				if (Uteis.isAtributoPreenchido(obj.getNotaFiscalSaidaServicoVO().getCodigo())) {
				obj.setNotaFiscalSaidaServicoVO(getFacadeFactory().getNotaFiscalSaidaServicoFacade().consultarPorChavePrimaria(obj.getNotaFiscalSaidaServicoVO().getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, usuario));
				}
				
				if (obj.getSituacaoEQuitada()) {
					// Se o titulo esta quitado temos que considerar os
					// descontos calculados,
					// na data da quitacao, nao chamando o método que monta a
					// lista de desconto
					// aplicaveis, considerando a quantidade de dias que falta
					// para o vencimento.
					obj.setValorDescontoInstituicao(dadosSQL.getDouble("descontoInstituicao"));
					obj.setValorDescontoConvenio(dadosSQL.getDouble("descontoConvenio"));
					obj.setValorDescontoProgressivo(dadosSQL.getDouble("valorDescontoProgressivo"));
				} else {					
					obj.getCalcularValorFinal(new Date(), configuracaoFinanceiroVO, false, new Date(), usuario);
					if (configuracaoFinanceiroVO.getVencimentoParcelaDiaUtil()) {
						obj.setDataVencimento(obj.getDataOriginalVencimento());
					}
				}
				// Monta dados da entidade subordinada.
				do {
					// Se existir alguma recebimento vinculado, então adiciona a
					// lista de objetos.
					if (dadosSQL.getInt("Recebimento.codigo") > 0) {
						ContaReceberRecebimentoVO recebimento = new ContaReceberRecebimentoVO();
						recebimento.setCodigo(dadosSQL.getInt("Recebimento.codigo"));
						recebimento.setDataRecebimeto(dadosSQL.getTimestamp("Recebimento.datarecebimento"));
						recebimento.setTipoRecebimento(dadosSQL.getString("Recebimento.tiporecebimento"));
						recebimento.getFormaPagamento().setCodigo(dadosSQL.getInt("Recebimento.formapagamento"));
						recebimento.getFormaPagamento().setNome(dadosSQL.getString("FormaPagamento.nome"));
						recebimento.setValorRecebimento(dadosSQL.getDouble("Recebimento.valorrecebimento"));
						recebimento.getResponsavel().setCodigo(dadosSQL.getInt("Responsavel.codigo"));
						recebimento.getResponsavel().setNome(dadosSQL.getString("Responsavel.nome"));
						recebimento.setMotivo(dadosSQL.getString("Recebimento.motivo"));
						recebimento.setRecebimentoTerceirizado(dadosSQL.getBoolean("contareceberrecebimento.recebimentoTerceirizado"));
						recebimento.getNegociacaoRecebimentoVO().setCodigo(dadosSQL.getInt("contareceberrecebimento.negociacaoRecebimento"));
						recebimento.setFormaPagamentoNegociacaoRecebimento(dadosSQL.getInt("Recebimento.formapagamentonegociacaorecebimento"));
						if (Uteis.isAtributoPreenchido(dadosSQL.getInt("notaFiscalSaida_codigo"))) {
							recebimento.getNotaFiscalSaidaServicoVO().getNotaFiscalSaida().setCodigo(dadosSQL.getInt("notaFiscalSaida_codigo"));
							recebimento.getNotaFiscalSaidaServicoVO().getNotaFiscalSaida().setNumero(dadosSQL.getLong("notaFiscalSaida_numero"));
							recebimento.getNotaFiscalSaidaServicoVO().getNotaFiscalSaida().setDataEmissao(Uteis.getDataJDBC(dadosSQL.getDate("notaFiscalSaida_dataEmissao")));
							recebimento.getNotaFiscalSaidaServicoVO().getNotaFiscalSaida().getResponsavel().setCodigo(dadosSQL.getInt("notaFiscalSaida_responsavel_codigo"));
							recebimento.getNotaFiscalSaidaServicoVO().getNotaFiscalSaida().getResponsavel().setNome(dadosSQL.getString("notaFiscalSaida_responsavel_nome"));
						}
						listaRecebimentos.add(recebimento);
					}
				} while (dadosSQL.next());
				// Atribui a lista de recebimentos.
				if (!listaRecebimentos.isEmpty()) {
					obj.setContaReceberRecebimentoVOs(listaRecebimentos);
				}
				obj.getContaReceberNegociacaoRecebimentoVOs().addAll(getFacadeFactory().getContaReceberNegociacaoRecebimentoDCCFacade().consultarPorCodigoContaReceber(obj.getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, configuracaoFinanceiroVO, usuario));
				obj.setListaLancamentoContabeisCredito(getFacadeFactory().getLancamentoContabilFacade().consultaRapidaPorCodOrigemPorTipoOrigemPorTipoPlanoConta(obj.getCodigo().toString(), TipoOrigemLancamentoContabilEnum.RECEBER, TipoPlanoContaEnum.CREDITO, false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
				obj.setListaLancamentoContabeisDebito(getFacadeFactory().getLancamentoContabilFacade().consultaRapidaPorCodOrigemPorTipoOrigemPorTipoPlanoConta(obj.getCodigo().toString(), TipoOrigemLancamentoContabilEnum.RECEBER, TipoPlanoContaEnum.DEBITO, false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
				obj.setListaCentroResultadoOrigem(getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().consultaRapidaPorCodOrigemPorTipoCentroResultadoOrigemEnum(obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, Uteis.NIVELMONTARDADOS_TODOS, usuario));				
				obj.setLancamentoContabil(getFacadeFactory().getConfiguracaoContabilFacade().consultaSeExisteConfiguracaoContabilPorCodigoUnidadeEnsino(obj.getUnidadeEnsino().getCodigo(), usuario));
				obj.setNivelMontarDados(NivelMontarDados.TODOS);
				
			}
		} catch (Exception e) {
			throw e;
		}
	}

	private void montarDadosCompletoSemRecebimento(ContaReceberVO obj, SqlRowSet dadosSQL, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		List<ContaReceberRecebimentoVO> listaRecebimentos = new ArrayList<ContaReceberRecebimentoVO>(0);
		try {
			montarDadosBasico(obj, dadosSQL);
			obj.setData(dadosSQL.getDate("data"));
			obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
			obj.getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
			obj.setCodOrigem(dadosSQL.getString("codorigem"));
			obj.setTipoOrigem(dadosSQL.getString("tipoorigem"));
			obj.setDescricaoPagamento(dadosSQL.getString("descricaopagamento"));
			obj.setValorRecebido(dadosSQL.getDouble("valorrecebido"));
			obj.setJuroPorcentagem(dadosSQL.getDouble("juroporcentagem"));
			obj.setJuro(dadosSQL.getDouble("juro"));
			obj.setMultaPorcentagem(dadosSQL.getDouble("multaporcentagem"));
			obj.setMulta(dadosSQL.getDouble("multa"));
			obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
			obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhadigitavelcodigobarras"));
			obj.setContaCorrente(dadosSQL.getInt("contacorrente"));
			obj.getCentroReceita().setCodigo(dadosSQL.getInt("centroreceita"));
			obj.getCentroReceita().setDescricao(dadosSQL.getString("CentroReceita.descricao"));
			obj.setTipoBoleto(dadosSQL.getString("tipoboleto"));
			obj.getConvenio().setCodigo(dadosSQL.getInt("convenio"));
			obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaperiodo"));
			obj.setDataArquivoRemessa(dadosSQL.getDate("dataArquivoRemessa"));
			obj.getRenegociacaoContaReceberOrigem().setCodigo(dadosSQL.getInt("codigoRenegociacao"));
			obj.setPossuiPendenciasFinanceirasExternas(dadosSQL.getBoolean("possuiPendenciasFinanceirasExternas"));
			obj.setPossuiFiesIntegracaoFinanceiras(dadosSQL.getBoolean("possuiFiesIntegracaoFinanceiras"));
//			obj.setBloquearPagamentoVisaoAluno(dadosSQL.getBoolean("bloquearPagamentoAluno"));
//			obj.setBloquearPagamentoCartaoPorOutrosDebitos(dadosSQL.getBoolean("bloquearPagamentoCartaoPorOutrosDebitos"));
//			if(obj.getBloquearPagamentoCartaoPorOutrosDebitos()) {
//				obj.setBloquearPagamentoVisaoAluno(true);
//			}
			obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor.codigo"));
			obj.getFornecedor().setNome(dadosSQL.getString("fornecedor.nome"));
			obj.getFornecedor().setRG(dadosSQL.getString("fornecedor.rg"));
			obj.getFornecedor().setCPF(dadosSQL.getString("fornecedor.cpf"));
			obj.getFornecedor().setCNPJ(dadosSQL.getString("fornecedor.cnpj"));
			obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("fornecedor.tipoEmpresa"));

			obj.setDuplicidadeTratada(dadosSQL.getBoolean("duplicidadeTratada"));
			obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
			obj.getTurma().setIdentificadorTurma(dadosSQL.getString("identificadorTurma"));

			// obj.setDescontoProgressivoUtilizado(dadosSQL.getString("descontoprogressivoutilizado"));

			obj.setOrigemNegociacaoReceber(dadosSQL.getInt("origemnegociacaoreceber"));
			obj.setCodigoBarra(dadosSQL.getString("codigobarra"));
			obj.setNossoNumero(dadosSQL.getString("nossonumero"));
			obj.setTituloImportadoSistemaLegado(dadosSQL.getBoolean("tituloImportadoSistemaLegado"));
			obj.setRecebimentoBancario((Boolean) dadosSQL.getObject("recebimentoBancario"));
			// Dados do Desconto Progressivo
			obj.setDescontoProgressivoUtilizado(FaixaDescontoProgressivo.getEnum(dadosSQL.getString("descontoprogressivoutilizado")));
			obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoprogressivo"));
			obj.getDescontoProgressivo().setNome(dadosSQL.getString("descontoprogressivo.nome"));
			obj.getDescontoProgressivo().setDiaLimite1(dadosSQL.getInt("descontoprogressivo.dialimite1"));
			obj.getDescontoProgressivo().setDiaLimite2(dadosSQL.getInt("descontoprogressivo.dialimite2"));
			obj.getDescontoProgressivo().setDiaLimite3(dadosSQL.getInt("descontoprogressivo.dialimite3"));
			obj.getDescontoProgressivo().setDiaLimite4(dadosSQL.getInt("descontoprogressivo.dialimite4"));
			obj.getDescontoProgressivo().setPercDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.percdescontolimite1"));
			obj.getDescontoProgressivo().setPercDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.percdescontolimite2"));
			obj.getDescontoProgressivo().setPercDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.percdescontolimite3"));
			obj.getDescontoProgressivo().setPercDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.percdescontolimite4"));
			obj.getDescontoProgressivo().setValorDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.valordescontolimite1"));
			obj.getDescontoProgressivo().setValorDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.valordescontolimite2"));
			obj.getDescontoProgressivo().setValorDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.valordescontolimite3"));
			obj.getDescontoProgressivo().setValorDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.valordescontolimite4"));
			obj.getDescontoProgressivo().setUtilizarDiaFixo(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaFixo"));
			obj.getDescontoProgressivo().setUtilizarDiaUtil(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaUtil"));
			obj.setContaEditadaManualmente(dadosSQL.getBoolean("contaEditadaManualmente"));
			obj.setUtilizarDescontoProgressivoManual(dadosSQL.getBoolean("utilizarDescontoProgressivoManual"));
			if (obj.getUtilizarDescontoProgressivoManual()) {
				obj.setDiaLimite1(dadosSQL.getInt("diaLimite1"));
				obj.setDiaLimite2(dadosSQL.getInt("diaLimite2"));
				obj.setDiaLimite3(dadosSQL.getInt("diaLimite3"));
				obj.setDiaLimite4(dadosSQL.getInt("diaLimite4"));
			}
			if (obj.getUtilizarDescontoProgressivoManual()) {
				obj.getDescontoProgressivo().setDescontoProgressivoEditadoManualmenteContaReceber(Boolean.TRUE);
				obj.getDescontoProgressivo().setDiaLimite1(obj.getDiaLimite1());
				obj.getDescontoProgressivo().setDiaLimite2(obj.getDiaLimite2());
				obj.getDescontoProgressivo().setDiaLimite3(obj.getDiaLimite3());
				obj.getDescontoProgressivo().setDiaLimite4(obj.getDiaLimite4());
			}

			// Desconto Lançado Recebimento
			obj.setValorDescontoLancadoRecebimento(dadosSQL.getDouble("valorDescontoLancadoRecebimento"));
			obj.setValorCalculadoDescontoLancadoRecebimento(dadosSQL.getDouble("valorCalculadoDescontoLancadoRecebimento"));
			obj.setValorReceberCalculado(dadosSQL.getDouble("valorReceberCalculado"));
			obj.setTipoDescontoLancadoRecebimento(dadosSQL.getString("tipoDescontoLancadoRecebimento"));
			// montar dados plano desconto
			obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));

			obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
			obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
			obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
			obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
			obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
			obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
			obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
			obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
			obj.setTipoDesconto(dadosSQL.getString("tipodesconto"));
			obj.setValorDescontoRecebido(dadosSQL.getDouble("valordescontorecebido"));
			obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
			obj.setValorCusteadoContaReceber(dadosSQL.getDouble("valorCusteadoContaReceber"));
			obj.setJustificativaDesconto(dadosSQL.getString("justificativaDesconto"));
			obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
			obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));

			obj.getMatriculaAluno().getPlanoFinanceiroAluno().setCodigo(dadosSQL.getInt("planofinanceiroaluno.codigo"));
			obj.getMatriculaAluno().getPlanoFinanceiroAluno().setDescontoValidoAteDataParcela(dadosSQL.getBoolean("planofinanceiroaluno.descontoValidoAteDataParcela"));
			obj.getMatriculaAluno().getPlanoFinanceiroAluno().setValorDescontoParcela(dadosSQL.getDouble("planofinanceiroaluno.valorDescontoParcela"));
			obj.getMatriculaAluno().getPlanoFinanceiroAluno().setValorDescontoMatricula(dadosSQL.getDouble("planofinanceiroaluno.valorDescontoMatricula"));
			obj.getMatriculaAluno().getPlanoFinanceiroAluno().setPercDescontoParcela(dadosSQL.getDouble("planofinanceiroaluno.percDescontoParcela"));
			obj.getMatriculaAluno().getPlanoFinanceiroAluno().setPercDescontoMatricula(dadosSQL.getDouble("planofinanceiroaluno.percDescontoMatricula"));
			obj.getMatriculaAluno().getPlanoFinanceiroAluno().setTipoDescontoParcela(dadosSQL.getString("planofinanceiroaluno.tipoDescontoParcela"));
			obj.getMatriculaAluno().getPlanoFinanceiroAluno().setTipoDescontoMatricula(dadosSQL.getString("planofinanceiroaluno.tipoDescontoMatricula"));
			obj.getMatriculaAluno().setBloquearEmissaoBoletoMatMenVisaoAluno(dadosSQL.getBoolean("Matricula.bloquearEmissaoBoletoMatMenVisaoAluno"));
			obj.setBloquearPagamentoVisaoAluno(dadosSQL.getBoolean("Matricula.bloquearEmissaoBoletoMatMenVisaoAluno"));
			obj.setValorFinalCalculado(dadosSQL.getDouble("valorfinalcalculado"));

			if (obj.getSituacaoEQuitada()) {
				// Se o titulo esta quitado temos que considerar os
				// descontos calculados,
				// na data da quitacao, nao chamando o método que monta a
				// lista de desconto
				// aplicaveis, considerando a quantidade de dias que falta
				// para o vencimento.
				obj.setValorDescontoInstituicao(dadosSQL.getDouble("descontoInstituicao"));
				obj.setValorDescontoConvenio(dadosSQL.getDouble("descontoConvenio"));
				obj.setValorDescontoProgressivo(dadosSQL.getDouble("valorDescontoProgressivo"));
			} else {
				// Monta a lista de descontos validos para a conta a
				// receber. Adicionalmente, com base na quantidade
				// de dias que faltam para o vencimento do titulo a rotina
				// tambem já define quais descontos devem
				// ser aplicadas para a conta receber, inicializando os
				// mesmos nos devidos campos
				// descontoConvenio, descontoProgressivo, descontoAluno,
				// descontoInstituicao
				// configuracaoFinanceiroVO.setUsaDescontoCompostoPlanoDesconto(obj.getUsaDescontoCompostoPlanoDesconto());
				if (configuracaoFinanceiroVO.getCodigo().intValue() == 0) {
					configuracaoFinanceiroVO = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarPorUnidadeEnsino(obj.getUnidadeEnsino().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				}
				montarListaDescontosAplicaveisContaReceber(obj, new Date(), obj.getUsaDescontoCompostoPlanoDesconto(), configuracaoFinanceiroVO, usuario, null);
			}
			montarDadosContaCorrente(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			// Atribui a lista de recebimentos.
			if (configuracaoFinanceiroVO.isApresentarFormaRecebimentoContaReceberVisaoAluno() && obj.getSituacaoEQuitada() && nivelMontarDados == Uteis.NIVELMONTARDADOS_DADOSENTIDADESUBORDINADAS) {
				obj.setContaReceberRecebimentoVOs(getFacadeFactory().getContaReceberRecebimentoFacade().consultarContasRecebidasComFormaPagamento(obj.getCodigo(), usuario));
			}
			if (!listaRecebimentos.isEmpty()) {
				obj.setContaReceberRecebimentoVOs(listaRecebimentos);
			}
		} catch (Exception e) {
			throw e;
		}
	}

	public List<ContaReceberVO> consultarTodasContaAReceberTurma(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlsb = new StringBuilder();
		sqlsb.append("SELECT contareceber.*, descontoProgressivo.*, pessoamatricula.nome AS \"Aluno.nome\", pessoamatricula.cpf AS \"Aluno.cpf\", pessoacandidato.nome AS \"Candidato.nome\", pessoacandidato.codigo AS \"Candidato.codigo\", pessoacandidato.cpf AS \"Candidato.cpf\", unidadeEnsino.codigo AS \"UnidadeEnsino.codigo\", unidadeEnsino.nome AS \"UnidadeEnsino.nome\", ");
		sqlsb.append(" indicereajuste.codigo as \"indicereajuste.codigo\" , indicereajuste.descricao as \"indicereajuste.descricao\", ");
		sqlsb.append("unidadeEnsinoFinanceira.codigo AS \"unidadeEnsinoFinanceira.codigo\", unidadeEnsinoFinanceira.nome AS \"unidadeEnsinoFinanceira.nome\", ");
		sqlsb.append("pessoa.nome AS \"Pessoa.nome\", pessoa.cpf AS \"Pessoa.cpf\", Pessoa.email as \"Pessoa.email\", ");
		sqlsb.append("matricula.matricula AS \"Matricula.matricula\", funcionario.codigo AS \"Funcionario.codigo\",funcionario.matricula AS \"Funcionario.matricula\", pessoafuncionario.nome AS \"Funcionario.nome\", pessoafuncionario.codigo AS \"Funcionario.codigo\", parceiro.nome AS \"Parceiro.nome\", parceiro.cnpj AS \"Parceiro.cnpj\", parceiro.cpf AS \"Parceiro.cpf\", ");
		sqlsb.append("parceiro.codigo AS \"Parceiro.codigo\", Parceiro.isentarJuro AS \"Parceiro.isentarJuro\", Parceiro.isentarMulta AS \"Parceiro.isentarMulta\", centroreceita.descricao AS \"CentroReceita.descricao\", ");
		sqlsb.append("responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.cpf as \"responsavelFinanceiro.cpf\", ");
		sqlsb.append(" turma.identificadorturma,fornecedor.codigo as \"fornecedor.codigo\", fornecedor.nome as \"fornecedor.nome\", fornecedor.rg as \"fornecedor.rg\", ");
		sqlsb.append(" planofinanceiroaluno.descontoValidoAteDataParcela as \"planofinanceiroaluno.descontoValidoAteDataParcela\",  ");
		sqlsb.append(" fornecedor.cpf as \"fornecedor.cpf\", fornecedor.cnpj as \"fornecedor.cnpj\", fornecedor.tipoEmpresa as \"fornecedor.tipoEmpresa\", pessoamatricula.codigo as \"pessoamatricula.codigo\" ");
		sqlsb.append(" FROM contareceber LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) LEFT JOIN parceiro ON (parceiro.codigo = contareceber.parceiro) LEFT JOIN pessoa as pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa)  ");
		sqlsb.append(" LEFT JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) LEFT JOIN pessoa as pessoamatricula ON (matricula.aluno = pessoamatricula.codigo) LEFT JOIN pessoa as pessoacandidato ON (contareceber.candidato = pessoacandidato.codigo) LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo)  ");
		sqlsb.append(" LEFT JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) LEFT JOIN centroreceita ON (centroreceita.codigo = contareceber.centroreceita) LEFT JOIN descontoprogressivo ON (contareceber.descontoprogressivo = descontoprogressivo.codigo) LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo)  ");
		sqlsb.append(" LEFT JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sqlsb.append(" LEFT JOIN turma as turma ON (contareceber.turma = turma.codigo) LEFT JOIN planofinanceiroaluno on (planofinanceiroaluno.matriculaperiodo = contareceber.matriculaperiodo) LEFT JOIN fornecedor ON (fornecedor.codigo = contareceber.fornecedor) inner join matriculaperiodo on matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		sqlsb.append(" LEFT JOIN indicereajuste ON (contareceber.indiceReajustePadraoPorAtraso = indicereajuste.codigo) ");
		sqlsb.append(" where contareceber.matriculaaluno = '").append(matricula).append("' ");
		sqlsb.append(" and contareceber.parcela not ilike '%M%' and contareceber.tipoorigem not ilike '%NCR%' order by contareceber.matriculaaluno, contareceber.datavencimento  ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlsb.toString());
		return montarDadosConsultaCompletaSemRecebimentoAtualizandoPrimeiraFaixaDescontos(resultado, configuracaoFinanceiroVO, usuario);
	}

	public List<ContaReceberVO> montarDadosConsultaBasica(SqlRowSet tabelaResultado) throws Exception {
		List<ContaReceberVO> vetResultado = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			montarDadosBasico(obj, tabelaResultado);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<ContaReceberVO> montarDadosConsultaCompleta(SqlRowSet tabelaResultado, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> vetResultado = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			// montarDadosCompleto(obj, tabelaResultado, configuracaoFinanceiroVO, usuario);
			montarDadosCompletoSemRecebimento(obj, tabelaResultado, configuracaoFinanceiroVO, nivelMontarDados, usuario);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<ContaReceberVO> montarDadosConsultaAlterarResponsavelFinanceiro(SqlRowSet tabelaResultado) throws Exception {
		List<ContaReceberVO> vetResultado = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			montarDadosAlterarResponsavelFinanceiro(obj, tabelaResultado);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	private void montarDadosAlterarResponsavelFinanceiro(ContaReceberVO obj, SqlRowSet dadosSQL) throws Exception {
		montarDadosBasico(obj, dadosSQL);
		obj.setNotaFiscalEmitida(dadosSQL.getBoolean("notafiscalemitida"));
	}

	private void montarDadosCompletoSemRecebimentoAtualizandoPrimeiraFaixaDescontos(ContaReceberVO obj, SqlRowSet dadosSQL, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<ContaReceberRecebimentoVO> listaRecebimentos = new ArrayList<ContaReceberRecebimentoVO>(0);
		try {
			montarDadosBasico(obj, dadosSQL);
			obj.setData(dadosSQL.getDate("data"));
			obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
			obj.getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
			obj.getUnidadeEnsinoFinanceira().setCodigo(dadosSQL.getInt("unidadeensinofinanceira"));
			obj.getUnidadeEnsinoFinanceira().setNome(dadosSQL.getString("unidadeensinofinanceira.nome"));
			obj.setCodOrigem(dadosSQL.getString("codorigem"));
			obj.setTipoOrigem(dadosSQL.getString("tipoorigem"));
			obj.setDescricaoPagamento(dadosSQL.getString("descricaopagamento"));
			obj.setValorRecebido(dadosSQL.getDouble("valorrecebido"));
			obj.setJuroPorcentagem(dadosSQL.getDouble("juroporcentagem"));
			obj.setJuro(dadosSQL.getDouble("juro"));
			obj.setMultaPorcentagem(dadosSQL.getDouble("multaporcentagem"));
			obj.setMulta(dadosSQL.getDouble("multa"));
			obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
			obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhadigitavelcodigobarras"));
			obj.setContaCorrente(dadosSQL.getInt("contacorrente"));
			obj.getCentroReceita().setCodigo(dadosSQL.getInt("centroreceita"));
			obj.getCentroReceita().setDescricao(dadosSQL.getString("CentroReceita.descricao"));
			obj.setTipoBoleto(dadosSQL.getString("tipoboleto"));
			obj.getConvenio().setCodigo(dadosSQL.getInt("convenio"));
			obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaperiodo"));
			obj.setDataArquivoRemessa(dadosSQL.getDate("dataArquivoRemessa"));
			obj.getRenegociacaoContaReceberOrigem().setCodigo(dadosSQL.getInt("codigoRenegociacao"));

			obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor.codigo"));
			obj.getFornecedor().setNome(dadosSQL.getString("fornecedor.nome"));
			obj.getFornecedor().setRG(dadosSQL.getString("fornecedor.rg"));
			obj.getFornecedor().setCPF(dadosSQL.getString("fornecedor.cpf"));
			obj.getFornecedor().setCNPJ(dadosSQL.getString("fornecedor.cnpj"));
			obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("fornecedor.tipoEmpresa"));

			obj.setDuplicidadeTratada(dadosSQL.getBoolean("duplicidadeTratada"));
			obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
			obj.getTurma().setIdentificadorTurma(dadosSQL.getString("identificadorTurma"));

			// obj.setDescontoProgressivoUtilizado(dadosSQL.getString("descontoprogressivoutilizado"));
			obj.setDescontoProgressivoUtilizado(FaixaDescontoProgressivo.getEnum(dadosSQL.getString("descontoprogressivoutilizado")));

			obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoprogressivo"));
			obj.setOrigemNegociacaoReceber(dadosSQL.getInt("origemnegociacaoreceber"));
			obj.setCodigoBarra(dadosSQL.getString("codigobarra"));
			obj.setNossoNumero(dadosSQL.getString("nossonumero"));
			obj.setTituloImportadoSistemaLegado(dadosSQL.getBoolean("tituloImportadoSistemaLegado"));
			obj.setRecebimentoBancario((Boolean) dadosSQL.getObject("recebimentoBancario"));
			// Dados do Desconto Progressivo
			obj.getDescontoProgressivo().setNome(dadosSQL.getString("nome"));
			obj.getDescontoProgressivo().setDiaLimite1(dadosSQL.getInt("dialimite1"));
			obj.getDescontoProgressivo().setDiaLimite2(dadosSQL.getInt("dialimite2"));
			obj.getDescontoProgressivo().setDiaLimite3(dadosSQL.getInt("dialimite3"));
			obj.getDescontoProgressivo().setDiaLimite4(dadosSQL.getInt("dialimite4"));
			obj.getDescontoProgressivo().setPercDescontoLimite1(dadosSQL.getDouble("percdescontolimite1"));
			obj.getDescontoProgressivo().setPercDescontoLimite2(dadosSQL.getDouble("percdescontolimite2"));
			obj.getDescontoProgressivo().setPercDescontoLimite3(dadosSQL.getDouble("percdescontolimite3"));
			obj.getDescontoProgressivo().setPercDescontoLimite4(dadosSQL.getDouble("percdescontolimite4"));
			// TODO Alberto 08/12/10 acrescentado valor fixo desconto
			// progressivo
			obj.getDescontoProgressivo().setValorDescontoLimite1(dadosSQL.getDouble("valordescontolimite1"));
			obj.getDescontoProgressivo().setValorDescontoLimite2(dadosSQL.getDouble("valordescontolimite2"));
			obj.getDescontoProgressivo().setValorDescontoLimite3(dadosSQL.getDouble("valordescontolimite3"));
			obj.getDescontoProgressivo().setValorDescontoLimite4(dadosSQL.getDouble("valordescontolimite4"));
			// TODO Alberto 08/12/10 acrescentado valor fixo desconto
			// progressivo
			// Desconto Lançado Recebimento
			obj.setValorDescontoLancadoRecebimento(dadosSQL.getDouble("valorDescontoLancadoRecebimento"));
			obj.setValorCalculadoDescontoLancadoRecebimento(dadosSQL.getDouble("valorCalculadoDescontoLancadoRecebimento"));
			obj.setTipoDescontoLancadoRecebimento(dadosSQL.getString("tipoDescontoLancadoRecebimento"));
			// montar dados plano desconto
			obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));

			obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
			obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
			obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
			obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
			obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
			obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
			obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
			obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
			obj.setTipoDesconto(dadosSQL.getString("tipodesconto"));
			obj.setValorDescontoRecebido(dadosSQL.getDouble("valordescontorecebido"));
			obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
			obj.setValorCusteadoContaReceber(dadosSQL.getDouble("valorCusteadoContaReceber"));
			obj.setJustificativaDesconto(dadosSQL.getString("justificativaDesconto"));
			obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
			obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));

			obj.setSituacao("AR");
			obj.setValorRecebido(0.0);
			obj.setValorReceberCalculado(0.0);

			// Monta a lista de descontos validos para a conta a
			// receber. Adicionalmente, com base na quantidade
			// de dias que faltam para o vencimento do titulo a rotina
			// tambem já define quais descontos devem
			// ser aplicadas para a conta receber, inicializando os
			// mesmos nos devidos campos
			// descontoConvenio, descontoProgressivo, descontoAluno,
			// descontoInstituicao
			// configuracaoFinanceiroVO.setUsaDescontoCompostoPlanoDesconto(obj.getUsaDescontoCompostoPlanoDesconto());
			if (configuracaoFinanceiroVO.getCodigo().intValue() == 0) {
				configuracaoFinanceiroVO = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarPorUnidadeEnsino(obj.getUnidadeEnsino().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			}
			montarListaDescontosAplicaveisContaReceber(obj, new Date(), obj.getUsaDescontoCompostoPlanoDesconto(), configuracaoFinanceiroVO, usuario, null);
			// Atribui a lista de recebimentos.
			obj.setSituacao("AR");
			obj.setValorRecebido(0.0);
			obj.setMulta(0.0);
			obj.setJuro(0.0);
			obj.setValorDescontoRecebido(0.0);
			obj.setValorDescontoLancadoRecebimento(0.0);
			obj.setValorReceberCalculado(0.0);
			obj.setRealizandoRecebimento(Boolean.TRUE);
			obj.setValorRecebido(obj.getCalcularValorFinal(Uteis.obterDataAntiga(obj.getDataVencimento(), 365), configuracaoFinanceiroVO, false, Uteis.obterDataAntiga(obj.getDataVencimento(), 365), usuario));

		} catch (Exception e) {
			throw e;
		}
	}

	// public List<EstatisticaContaPagarReceberVO>
	// consultarEstatisticaInadimplenciaUnidades(Integer unidadeEnsino) throws
	// Exception {
	// StringBuilder sql = new StringBuilder(
	// " Select sum(valorVencidoContaPagar) as valorVencidoContaPagar,sum(valorContaPagar) as valorContaPagar,sum(valorVencerContaPagar) as valorVencerContaPagar , "
	// +
	// " sum(valorVencidoContaReceber) as valorVencidoContaReceber, sum(valorContaReceber) as valorContaReceber, sum(valorVencerContaReceber) as valorVencerContaReceber, "
	// +
	// " unidadeEnsino.codigo,UnidadeEnsino.abreviatura from (");
	// sql.append(" ( select sum(valorVencido) as valorVencidoContaPagar,sum(valor) as valorContaPagar,sum(valorAVencer) as valorVencerContaPagar , 0 as valorVencidoContaReceber, 0 as valorContaReceber,0 as valorVencerContaReceber, unidadeEnsino from (");
	// sql.append(" (select sum(valor) as valorVencido, 0 as valor, 0 as valorAVencer, unidadeEnsino "
	// +
	// " from contaPagar where dataVencimento < '"+Uteis.getDataJDBC(dataBase)+" 00:00:00' and situacao <> 'PA' group by unidadeEnsino)");
	// sql.append(" union all ");
	// sql.append(" (select 0 ,sum(valor) as valor, 0 as valorAVencer , unidadeEnsino"
	// +
	// " from contaPagar where (dataVencimento >= '"+Uteis.getDataJDBC(dataBase)+" 00:00:00' and dataVencimento <= '"+Uteis.getDataJDBC(dataBase)+" 23:59:59') and situacao <> 'PA' group by unidadeEnsino)");
	// sql.append(" union all ");
	// sql.append(" (select 0 as valorVencido, 0 as valor, sum(valor) as valorAVencer , unidadeEnsino"
	// +
	// " from contaPagar where (dataVencimento > '"+Uteis.getDataJDBC(dataBase)+" 23:59:59' and dataVencimento <= '"+Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(dataBase))+" 23:59:59') and situacao <> 'PA' group by unidadeEnsino)");
	// sql.append(" ) as contaPagar group by unidadeEnsino)");
	// sql.append(" union all ");
	// sql.append(" (select 0 as valorVencidoContaPagar, 0 as valorContaPagar, 0 as valorVencerContaPagar, sum(valorVencido) as valorVencidoContaReceber,sum(valor) as valorContaReceber,sum(valorAVencer) as valorVencerContaReceber, unidadeEnsino from (");
	// sql.append(" (select sum(valor) as valorVencido, 0 as valor, 0 as valorAVencer , unidadeEnsino "
	// +
	// " from contaReceber where dataVencimento < '"+Uteis.getDataJDBC(dataBase)+" 00:00:00' and situacao <> 'RE' group by unidadeEnsino)");
	// sql.append(" union all ");
	// sql.append(" (select 0 ,sum(valor) as valor, 0 as valorAVencer , unidadeEnsino"
	// +
	// " from contaReceber where (dataVencimento >= '"+Uteis.getDataJDBC(dataBase)+" 00:00:00' and dataVencimento <= '"+Uteis.getDataJDBC(dataBase)+" 23:59:59') and situacao <> 'RE' group by unidadeEnsino)");
	// sql.append(" union all ");
	// sql.append(" (select 0 as valorVencido, 0 as valor, sum(valor) as valorAVencer , unidadeEnsino "
	// +
	// " from contaReceber where (dataVencimento > '"+Uteis.getDataJDBC(dataBase)+" 23:59:59') and situacao <> 'RE' group by unidadeEnsino)");
	// sql.append(" ) as contaReceber group by unidadeEnsino)");
	// sql.append(" ) as conta left join UnidadeEnsino on conta.unidadeEnsino = UnidadeEnsino.codigo ");
	// if (unidadeEnsino.intValue() > 0) {
	// sql.append(" where unidadeEnsino.codigo = "+unidadeEnsino);
	// }
	// sql.append(" group by conta.unidadeEnsino, UnidadeEnsino.codigo, UnidadeEnsino.abreviatura ");
	// Statement st = con.createStatement();
	//
	// ResultSet rs = st.executeQuery(sql.toString());
	// return montarDadosConsultaEstatisticaContaPagarReceber(rs);
	// }
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# baixarContaReceberConcedendoDescontoTotalAMesma(java .lang.Integer, java.lang.String, negocio.comuns.arquitetura.UsuarioVO)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# baixarContaReceberConcedendoDescontoTotalAMesma(java .lang.Integer, java.lang.String, negocio.comuns.arquitetura.UsuarioVO)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void baixarContaReceberConcedendoDescontoTotalAMesmaPorNegociacaoRecebimento(NegociacaoRecebimentoVO obj, String justificativa, UsuarioVO responsavel, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		if (obj.getFormaPagamentoNegociacaoRecebimentoVOs().isEmpty()) {
			ContaReceberVO contaBaixar = new ContaReceberVO();
			for (ContaReceberNegociacaoRecebimentoVO contaReceberNegociacaoRecebimentoVO : obj.getContaReceberNegociacaoRecebimentoVOs()) {
				contaBaixar = consultarPorChavePrimaria(contaReceberNegociacaoRecebimentoVO.getContaReceber().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
				Double valorDesconto = contaBaixar.getValor();
				contaBaixar.setValorDescontoRecebido(Uteis.arredondar(valorDesconto, 2, 0));
				contaBaixar.setSituacao("RE");
				Double somaDescontos = contaBaixar.getValorDescontoAlunoJaCalculado() + contaBaixar.getValorDescontoConvenio() + contaBaixar.getValorDescontoInstituicao();
				if (!somaDescontos.equals(valorDesconto)) {
					contaBaixar.setTipoDesconto("VA");
					contaBaixar.setValorDesconto(Uteis.arredondar(valorDesconto, 2, 0));
					contaBaixar.setValorDescontoConvenio(0.0);
					contaBaixar.setValorDescontoInstituicao(0.0);
				}
				contaBaixar.setValorRecebido(0.0);
				contaBaixar.setDescricaoPagamento(contaBaixar.getDescricaoPagamento() + "(" + justificativa + ")");
				if (contaBaixar.getTipoAluno() && contaBaixar.getPessoa().getCodigo().equals(0) && contaBaixar.getTipoOrigem().equals("REQ")) {
					contaBaixar.setPessoa(getFacadeFactory().getPessoaFacade().consultaRapidaPorChavePrimaria(obj.getPessoa().getCodigo(), false, Uteis.NIVELMONTARDADOS_COMBOBOX, usuario));
				}
				getFacadeFactory().getContaReceberNegociacaoRecebimentoFacade().alterar(contaReceberNegociacaoRecebimentoVO, configuracaoFinanceiroVO, usuario);
				// obj.getContaReceberNegociacaoRecebimentoVOs().add(criarContaReceberNegociacaoRecebimentoVO(contaBaixar));
			}
			obj.getFormaPagamentoNegociacaoRecebimentoVOs().add(criarFormaPagamentoNegociacaoRecebimentoVO(contaBaixar, configuracaoFinanceiroVO, responsavel));
			obj.setObservacao(obj.getObservacao() + "(" + justificativa + ")");
			obj.setResponsavel(responsavel);
			obj.setUnidadeEnsino(contaBaixar.getUnidadeEnsino());
			obj.setTipoPessoa(contaBaixar.getTipoPessoa());
			obj.setPessoa(contaBaixar.getPessoa());
			if (!Uteis.isAtributoPreenchido(obj.getContaCorrenteCaixa())) {
				obj.setContaCorrenteCaixa(consultarContaCorrentePadrao(configuracaoFinanceiroVO, responsavel));
			}
			if (Uteis.isAtributoPreenchido(contaBaixar.getPessoa())) {
				if (obj.getTipoAluno()) {
					obj.setMatricula(contaBaixar.getMatriculaAluno().getMatricula());
				} else if (obj.getTipoFuncionario()) {
					obj.setMatricula(contaBaixar.getFuncionario().getMatricula());
				}
			} else if (Uteis.isAtributoPreenchido(contaBaixar.getParceiroVO())) {
				obj.setParceiroVO(contaBaixar.getParceiroVO());
			}
			obj.setValorTotalRecebimento(contaBaixar.getValorRecebido());
			obj.setData(new Date());
			obj.setValorTotal(contaBaixar.getValorRecebido());
			obj.setAlterouConteudo(true);
			obj.setMotivoAlteracao("Desconto 100% no recebimento.");
			getFacadeFactory().getNegociacaoRecebimentoFacade().alterar(obj, configuracaoFinanceiroVO, usuario);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void baixarContaReceberVOConcedendoDescontoTotalAMesma(ContaReceberVO contaBaixar, Date dataBaseBaixa, String justificativa, Boolean liberacaoCancelamentoTrancamento, UsuarioVO responsavel, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		// contaBaixar.setRealizandoRecebimento(true);
		// contaBaixar.getCalcularValorFinal(Uteis.getData("10/01/2016", "dd/mm/yyyy"), configuracaoFinanceiroVO, false, Uteis.getData("10/01/2016", "dd/mm/yyyy"));
		if (liberacaoCancelamentoTrancamento) {
			Double valorRestanteDaParcela = contaBaixar.getCalcularValorFinal(configuracaoFinanceiroVO, usuario);
			contaBaixar.setTipoDescontoLancadoRecebimento("VA");
			contaBaixar.setValorDescontoLancadoRecebimento(valorRestanteDaParcela);
			contaBaixar.getCalcularValorFinal(configuracaoFinanceiroVO, usuario);
		}
		Double valorDesconto = contaBaixar.getValorTotalDescontoContaReceber();
		if (valorDesconto < Uteis.arrendondarForcando2CadasDecimais(contaBaixar.getValor())) {
			throw new Exception("ERRO - Não é possível registrar uma baixa automática de uma conta a receber cujo soma dos descontos não correspondem ao valor total da conta.");
		}
		contaBaixar.setValorDescontoRecebido(valorDesconto);
		contaBaixar.setSituacao("RE");
		// Double somaDescontos = contaBaixar.getValorDescontoAlunoJaCalculado()
		// + contaBaixar.getValorDescontoConvenio() +
		// contaBaixar.getValorDescontoInstituicao();
		// if (!somaDescontos.equals(valorDesconto)) {
		// contaBaixar.setTipoDesconto("VE");
		// contaBaixar.setValorDescontoConvenio(0.0);
		// contaBaixar.setValorDescontoInstituicao(0.0);
		// contaBaixar.setValorRecebido(0.0);
		// contaBaixar.setValorDesconto(valorDesconto);
		// }
		contaBaixar.setDescricaoPagamento(contaBaixar.getDescricaoPagamento() + "(" + justificativa + ")");

		NegociacaoRecebimentoVO negociacaoRecebimentoVO = new NegociacaoRecebimentoVO();
		negociacaoRecebimentoVO.setObservacao(negociacaoRecebimentoVO.getObservacao() + "(" + justificativa + ")");
		negociacaoRecebimentoVO.setResponsavel(responsavel);
		negociacaoRecebimentoVO.setUnidadeEnsino(contaBaixar.getUnidadeEnsino());
		negociacaoRecebimentoVO.setTipoPessoa(contaBaixar.getTipoPessoa());
		if (contaBaixar.getTipoPessoa().equals(TipoPessoa.RESPONSAVEL_FINANCEIRO.getValor())) {
			negociacaoRecebimentoVO.setPessoa(contaBaixar.getResponsavelFinanceiro());
		}else if (contaBaixar.getPessoa() != null && contaBaixar.getPessoa().getCodigo() != 0 && !contaBaixar.getTipoPessoa().equals(TipoPessoa.PARCEIRO.getValor())) {
			if (contaBaixar.getPessoa().getNome().equals("")) {
				negociacaoRecebimentoVO.setPessoa(getFacadeFactory().getPessoaFacade().consultaRapidaPorChavePrimaria(contaBaixar.getPessoa().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
			}else{
				negociacaoRecebimentoVO.setPessoa(contaBaixar.getPessoa());
			}
		} else if (contaBaixar.getParceiroVO() != null && contaBaixar.getParceiroVO().getCodigo() != 0) {
			negociacaoRecebimentoVO.setParceiroVO(contaBaixar.getParceiroVO());
		} else if (contaBaixar.getFornecedor() != null && contaBaixar.getFornecedor().getCodigo() != 0) {
			negociacaoRecebimentoVO.setFornecedor(getFacadeFactory().getFornecedorFacade().consultarPorChavePrimaria(contaBaixar.getFornecedor().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
			contaBaixar.setFornecedor(negociacaoRecebimentoVO.getFornecedor());
		}
		negociacaoRecebimentoVO.setContaCorrenteCaixa(consultarContaCorrentePadrao(configuracaoFinanceiroVO, responsavel));
		if (Uteis.isAtributoPreenchido(contaBaixar.getPessoa())) {
			negociacaoRecebimentoVO.setMatricula(contaBaixar.getMatriculaAluno().getMatricula());
		} else if (Uteis.isAtributoPreenchido(contaBaixar.getParceiroVO())) {
			negociacaoRecebimentoVO.setParceiroVO(contaBaixar.getParceiroVO());
		}
		negociacaoRecebimentoVO.setValorTotalRecebimento(contaBaixar.getValorRecebido());
		negociacaoRecebimentoVO.setData(dataBaseBaixa);
		negociacaoRecebimentoVO.getFormaPagamentoNegociacaoRecebimentoVOs().add(criarFormaPagamentoNegociacaoRecebimentoVO(contaBaixar, configuracaoFinanceiroVO, responsavel));

		negociacaoRecebimentoVO.getContaReceberNegociacaoRecebimentoVOs().add(criarContaReceberNegociacaoRecebimentoVO(contaBaixar));
		negociacaoRecebimentoVO.setValorTotal(contaBaixar.getValorRecebido());
		negociacaoRecebimentoVO.setTipoPessoa(contaBaixar.getTipoPessoa());
		if (negociacaoRecebimentoVO.getTipoPessoa().equals("AL")) {
			negociacaoRecebimentoVO.setMatricula(contaBaixar.getMatriculaAluno().getMatricula());
		}
		getFacadeFactory().getNegociacaoRecebimentoFacade().incluir(negociacaoRecebimentoVO, configuracaoFinanceiroVO, false, usuario);
		// alterar(contaBaixar, false, configuracaoFinanceiroVO, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void baixarContaReceberConcedendoDescontoTotalAMesma(Integer codigoContaReceber, Date dataBaseBaixa, String justificativa, Boolean liberacaoCancelamentoTrancamento, Boolean realizandoRecebimentoAutomaticoMatricula, UsuarioVO responsavel, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ContaReceberVO contaBaixar = new ContaReceberVO();
		contaBaixar.setCodigo(codigoContaReceber);
		carregarDados(contaBaixar, NivelMontarDados.TODOS, configuracaoFinanceiroVO, usuario);
		contaBaixar.setRealizandoRecebimentoAutomaticoMatricula(realizandoRecebimentoAutomaticoMatricula);
		baixarContaReceberVOConcedendoDescontoTotalAMesma(contaBaixar, dataBaseBaixa, justificativa, liberacaoCancelamentoTrancamento, responsavel, configuracaoFinanceiroVO, usuario);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarMatriculaPeriodoFinanceiroManualPelaContaReceber (java.lang.Integer)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarMatriculaPeriodoFinanceiroManualPelaContaReceber (java.lang.Integer)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarMatriculaPeriodoFinanceiroManualPelaContaReceber(Integer codigoMatriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		MatriculaPeriodoVO matriculaPeriodo = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(codigoMatriculaPeriodo.intValue(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuario);
		getFacadeFactory().getMatriculaPeriodoFacade().mudarMatriculaPeridoFinanceiroParaManual(matriculaPeriodo, usuario.getCodigo());
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void validarDadosMatriculaPeriodoFinanceiroManual(Integer codigoMatriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		MatriculaPeriodoVO matriculaPeriodo = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(codigoMatriculaPeriodo.intValue(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuario);
		if (!matriculaPeriodo.getFinanceiroManual()) {
			throw new Exception("Atenção, conta não pode ser alterada, controle financeiro manual não se encontra ativo!");
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarMatriculaPeriodoVencimentoDaContaReceber(negocio .comuns.financeiro.ContaReceberVO)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarMatriculaPeriodoVencimentoDaContaReceber(negocio .comuns.financeiro.ContaReceberVO)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarMatriculaPeriodoVencimentoDaContaReceber(ContaReceberVO contaReceberVo, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		try {
			if(contaReceberVo.getTipoOrigem().equals("MEN") || contaReceberVo.getTipoOrigem().equals("MDI") || contaReceberVo.getTipoOrigem().equals("MAT")) {
				MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVo = getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarMatriculaVencimentoPorContaReceber(contaReceberVo.getCodigo().intValue(), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuario);
				if (matriculaPeriodoVencimentoVo.getCodigo() != 0) {
					getFacadeFactory().getMatriculaPeriodoVencimentoFacade().atualizarMatriculaPeriodoVencimentoPelaContaReceberVO(contaReceberVo, matriculaPeriodoVencimentoVo, usuario);
				}
			}
		} catch (Exception e) {
			throw e;
			// nao existe um MatriculaPeriodoVencimentoVO para ser atualizado
		}
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarContaReceberPelaMatriculaPeriodoVencimento( negocio.comuns.financeiro.MatriculaPeriodoVencimentoVO)
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see negocio.facade.jdbc.financeiro.ContaReceberInterfaceFacade# alterarContaReceberPelaMatriculaPeriodoVencimento( negocio.comuns.financeiro.MatriculaPeriodoVencimentoVO)
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public ContaReceberVO alterarContaReceberPelaMatriculaPeriodoVencimento(MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ContaReceberVO contaReceberVo = matriculaPeriodoVencimentoVo.getContaReceber();
		contaReceberVo.setParcela(matriculaPeriodoVencimentoVo.getParcela());
		contaReceberVo.setValor(matriculaPeriodoVencimentoVo.getValor());
		contaReceberVo.setValorDesconto(matriculaPeriodoVencimentoVo.getValorDesconto());
		contaReceberVo.setDataVencimento(matriculaPeriodoVencimentoVo.getDataVencimento());
		contaReceberVo.setDataCompetencia(matriculaPeriodoVencimentoVo.getDataCompetencia());
		contaReceberVo.setTipoDesconto("VA");
		contaReceberVo.setDescricaoPagamento(matriculaPeriodoVencimentoVo.getDescricaoPagamento());
		ContaCorrenteVO contaCorrenteVO = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(contaReceberVo.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
		if (configuracaoFinanceiroVO.getGerarBoletoComDescontoSemValidade()) {
			contaReceberVo.setGerarBoletoComDescontoSemValidade(Boolean.TRUE);
			getFacadeFactory().getContaReceberFacade().executarCalculoValorBoletoDescontoSemValidade(contaReceberVo, configuracaoFinanceiroVO, usuario);
		}
		contaReceberVo.criarBoleto(contaCorrenteVO);
		return contaReceberVo;
	}

	public List<ContaReceberVO> consultaRapidaPorMatricula(String matricula) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE matriculaAluno = '");
		sqlStr.append(matricula);
		sqlStr.append("'");
		sqlStr.append(" ORDER BY contareceber.codigo");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaPeriodo(Integer codMatriculaPeriodo) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE contaReceber.matriculaPeriodo = ");
		sqlStr.append(codMatriculaPeriodo);
		sqlStr.append(" ORDER BY contareceber.codigo");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaSomentePessoaESituacaoAReceber(String matricula) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE matriculaAluno = '");
		sqlStr.append(matricula);
		sqlStr.append("' AND contareceber.pessoa is not null AND contareceber.situacao = 'AR' ");
		sqlStr.append(" ORDER BY contareceber.codigo");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaESituacaoAReceberCompleto(String matricula, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, Boolean consultaContaVencida, Date dataInicial, Date dataFinal, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaCompletaSemContaReceberRecebimento();
		sqlStr.append(" WHERE matriculaAluno = ? ");
		sqlStr.append(" AND contareceber.situacao = 'AR' ");
		sqlStr.append(" AND ").append(adicionarFiltroTipoOrigemContaReceber(filtroRelatorioFinanceiroVO, "contareceber"));
		if (consultaContaVencida && dataInicial != null && dataFinal != null) {
			sqlStr.append(" AND ( contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicial)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFinal)).append("' ) ");
		}else if (!consultaContaVencida && dataInicial != null && dataFinal != null) {
			if(UteisData.getCompareData(new Date(), dataInicial) > 0){
				dataInicial = new Date();
			}
			sqlStr.append(" AND ( contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicial)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFinal)).append("' ) ");			
		}else if (!consultaContaVencida) {
			sqlStr.append(" AND contareceber.dataVencimento >= current_date ");
		}
		sqlStr.append(" AND contareceber.pagocomdcc = 'f' ");
		sqlStr.append(" ORDER BY contareceber.datavencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), matricula);
		return montarDadosConsultaCompletaSemRecebimento(resultado, configuracaoFinanceiroVO, nivelMontarDados, usuario);
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaESituacaoAReceber(String matricula, Boolean consultaContaVencida, Optional<FiltroRelatorioFinanceiroVO> filtroRelatorioFinanceiroVO) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE matriculaAluno = ? AND contareceber.situacao = 'AR' ");
		if (!consultaContaVencida) {
			sqlStr.append(" AND contareceber.dataVencimento >= current_date ");
		}
		filtroRelatorioFinanceiroVO.ifPresent(filtro -> sqlStr.append(" AND ").append(adicionarFiltroTipoOrigemContaReceber(filtro, "contaReceber")));
		sqlStr.append(" ORDER BY contareceber.datavencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), matricula);
		return montarDadosConsultaBasica(resultado);
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaESituacaoAReceber(String matricula, String tipoOrigem) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE matriculaAluno = '");
		sqlStr.append(matricula);
		sqlStr.append("' AND contareceber.situacao = 'AR' ");
		if (!tipoOrigem.equals("")) {
			sqlStr.append(" AND contareceber.tipoOrigem = '").append(tipoOrigem).append("' ");
		}
		sqlStr.append(" ORDER BY contareceber.datavencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaParaSerasa(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE matriculaAluno = '");
		sqlStr.append(matricula);
		sqlStr.append("' ");
		sqlStr.append("AND datavencimento < current_date - INTERVAL '").append(configuracaoFinanceiroVO.getQtdeMinimaDiasAntesNegativacaoSerasa()).append(" day' AND contareceber.situacao = 'AR' ");
		sqlStr.append(" ORDER BY contareceber.dataVencimento DESC");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	/*
	 * Método criado para buscar as contas a receber de alunos do tipo MATRICULA e do tipo MENSALIDADE, que tiveram seus boletos emitidos e que estão com situação a receber, assim podera ser apresentado para o usuario uma mensagem informando que o boleto possivelmente está na mão do aluno e assim caso essa conta sofra alterações o nosso numero sofrerá alterações e ocorrerá assim problemas no arquivo de retorno do banco. Thyago Jayme Diniz
	 */
	public List<ContaReceberVO> consultaRapidaPorMatriculaContaReceberMatriculaMensalidadeImpressaoBoletoTrue(String matricula, Integer codMatriculaPeriodo) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE matriculaAluno = '");
		sqlStr.append(matricula);
		sqlStr.append("' ");
		sqlStr.append("AND (contareceber.tipoorigem in ('MEN', 'MAT')) ");
		sqlStr.append("and contareceber.situacao = 'AR' ");
		sqlStr.append("and contareceber.impressaoBoletoRealizada = TRUE ");
		sqlStr.append("and contareceber.codorigem = '");
		sqlStr.append(codMatriculaPeriodo);
		sqlStr.append("' ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	public Boolean consultarPendenciaFinanceiraPorCodPessoaFichaAluno(Integer codPessoa, UsuarioVO usuario) throws Exception {
		String sqlStr = "select * from ContaReceber WHERE pessoa = " + codPessoa.intValue() + " and situacao = 'AR' and  (dataVencimento <= '" + Uteis.getDataJDBC(new Date()) + "') limit 1";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return true;
		}
		return false;
	}

	/**
	 * Método que consulta contas a receber relacionada a matriculaPerido que estejam vencidas. Caso possua alguma retorna true, caso contrário retorna false;
	 * 
	 * @param codMatriculaPeriodo
	 * @return Boolean
	 * @throws Exception
	 */
	public Boolean consultarPendenciaFinanceiraPorCodMatriculaPeriodoFichaAluno(Integer codMatriculaPeriodo, UsuarioVO usuario) throws Exception {

		String sqlStr = "select * from ContaReceber WHERE matriculaPeriodo = " + codMatriculaPeriodo.intValue() + " and situacao = 'AR' and  (dataVencimento <= '" + Uteis.getDataJDBC(new Date()) + "')";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return tabelaResultado.next();
	}

	/**
	 * Método que consulta contas a receber relacionada a matriculaPerido que estejam vencidas. Caso possua alguma retorna true, caso contrário retorna false;
	 * 
	 * @param codMatriculaPeriodo
	 * @return Boolean
	 * @throws Exception
	 */
	@Override
	public Boolean consultarSeExistePendenciaFinanceiraPorRestricoesRenovacaoMatriculaVisaoAluno(String codMatricula, UsuarioVO usuario) throws Exception {
		StringBuilder sb = new StringBuilder("select contareceber.codigo from contareceber ");
		sb.append(" WHERE contareceber.matriculaAluno ='").append(codMatricula).append("' ");
		sb.append(" and contareceber.situacao ='").append(SituacaoContaReceber.A_RECEBER.getValor()).append("' ");
		sb.append(" and contareceber.dataVencimento <= '").append(Uteis.getDataJDBC(new Date())).append("' ");
		sb.append(" and contareceber.pessoa is not null ");
		getSqlValidarInadimplenciaAlunoParcelaParceiroRenovacaoMatricula(sb);		
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		return tabelaResultado.next();
	}

	private void getSqlValidarInadimplenciaAlunoParcelaParceiroRenovacaoMatricula(StringBuilder sb) {
		sb.append(" and not exists  (select cr.codigo ");
		sb.append(" from contareceber as  cr ");
		sb.append(" inner join parceiro on parceiro.codigo  = cr.parceiro ");
		sb.append(" where cr.codigo = contareceber.codigo ");
		sb.append(" and cr.tipoorigem in  ('OUT', 'BCC') ");
		sb.append(" and parceiro.validarInadimplenciaAlunoParcelaParceiroRenovacaoMatricula = false ");
		sb.append("	)");
	}

	public List<ContaReceberVO> consultarPorNossoNumeroLista(String nossoNumero, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT contareceber.* FROM ContaReceber WHERE nossonumero = '" + nossoNumero + "'";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List<ContaReceberVO> consultarPorMatriculaNaoAtiva(boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "select distinct matricula.situacao, matriculaperiodo.situacao, matriculaperiodo.situacaomatriculaperiodo, contareceber.* from contareceber " + " inner join matricula on (contareceber.matriculaaluno = matricula.matricula) " + " inner join matriculaperiodo on (matriculaperiodo.matricula = matricula.matricula) " + " where matricula.situacao != 'AT' and " + " contareceber.situacao = 'AR' ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List<ContaReceberVO> consultarPorCursoTurmaSituacaoAreceberAlunosComContasPagas(Integer curso, Integer turma, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "select distinct contareceber.codigo, contareceber.* from contareceber " + "inner join matriculaperiodo on (matriculaperiodo.matricula = contareceber.matriculaaluno) " + "inner join turma on (turma.codigo = matriculaperiodo.turma) " + "where contareceber.situacao = 'AR' ";
		if (curso != null && !curso.equals(0)) {
			sqlStr += "AND turma.curso = " + curso + " ";
		}
		if (turma != null && !turma.equals(0)) {
			sqlStr += "AND turma.codigo = " + turma + " ";
		}
		sqlStr += "AND contareceber.matriculaaluno in( " + "select distinct cr2.matriculaaluno from contareceber cr2 " + "inner join matriculaperiodo on (matriculaperiodo.matricula = cr2.matriculaaluno) " + "inner join turma on (turma.codigo = matriculaperiodo.turma) " + "where cr2.situacao = 'RE' ";
		if (curso != null && !curso.equals(0)) {
			sqlStr += "AND turma.curso = " + curso + " ";
		}
		if (turma != null && !turma.equals(0)) {
			sqlStr += "AND turma.codigo = " + turma + " ";
		}
		sqlStr += ")";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List<ContaReceberVO> consultarPorParceiroSituacaoAreceber(boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "select distinct contareceber.codigo, contareceber.* from contareceber " + " where parceiro is not null and pessoa is null and situacao = 'AR' ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public Integer consultarQuantidadeContasRecebidasPorMatricula(String matricula) {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select count(codigo) as qtde from contareceber where matriculaaluno = '");
		sqlStr.append(matricula);
		sqlStr.append("' and situacao = 'RE'");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		Integer quantidade = 0;
		if (tabelaResultado.next()) {
			quantidade = tabelaResultado.getInt("qtde");
			return quantidade;
		}
		return quantidade;
	}

	public List<String> obterListaDisciplinaIdealParaManterNaBaseDeDados(UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		String sqlStr = "select nossonumero, count(nossonumero) nrOcorrencias " + "from contareceber " + "group by nossonumero " + "order by nrOcorrencias desc, nossonumero desc";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List<String> vetResultado = new ArrayList<String>();
		while (tabelaResultado.next()) {
			int nrOcorrencias = tabelaResultado.getInt("nrOcorrencias");
			if (nrOcorrencias >= 2) {
				vetResultado.add(tabelaResultado.getString("nossonumero"));
			} else {
				break;
			}
		}
		return vetResultado;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarNossoNumero(ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		String sqlStr = "UPDATE ContaReceber set nossoNumero=? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { obj.getNossoNumero(), obj.getCodigo() });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void registrarAlunoRecebeuNotificacaoBoleto(Integer codigo, UsuarioVO usuario) throws Exception {
		String sqlStr = "UPDATE ContaReceber set contaReceberJaEnviadaAluno= true WHERE (codigo = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { codigo });
	}

	public void processarContaReceberComNossoNumeroDuplicado(String nossoNumeroDuplicado, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> listaProcessar = consultarPorNossoNumeroLista(nossoNumeroDuplicado, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		int contador = 1;
		for (ContaReceberVO contaReceber : listaProcessar) {
			if (contaReceber.getSituacaoEQuitada()) {
				String nossoNr = contaReceber.getNossoNumero();
				String contadorStr = String.valueOf(contador);
				if (contadorStr.length() < 2) {
					contadorStr = "0" + contadorStr;
				}
				nossoNr = nossoNr + "REC" + contadorStr;
				// nossoNr = nossoNr.substring(4);
				contaReceber.setNossoNumero(nossoNr);
				alterarNossoNumero(contaReceber, usuario);
				contador++;
			} else {
				if (contaReceber.getDataVencimento().compareTo(Uteis.getDate("01/04/2010")) < 0) {
					String nossoNr = contaReceber.getNossoNumero();
					nossoNr = nossoNr.substring(1);
					nossoNr = "9" + nossoNr;
					contaReceber.setNossoNumero(nossoNr);
					alterarNossoNumero(contaReceber, usuario);
					//// System.out.println("MODIFICADO: " + contaReceber.toString());
				} else {
					//// System.out.println("NÃO MODIFICADA: " + contaReceber.toString());
				}
			}
		}
	}

	public void executarAjusteNossoNumeroRepetido(ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<String> listaContaReceberParaProcessamento = obterListaDisciplinaIdealParaManterNaBaseDeDados(usuario);
		for (String nossoNumeroDuplicado : listaContaReceberParaProcessamento) {
			// //System.out.println("===============================");
			// //System.out.println(nossoNumeroDuplicado);
			processarContaReceberComNossoNumeroDuplicado(nossoNumeroDuplicado, configuracaoFinanceiroVO, usuario);
		}
	}

	public void executarAjusteNossoNumeroMatriculaCancelada(ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> listaProcessar = consultarPorMatriculaNaoAtiva(false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		int contador = 1;
		for (ContaReceberVO contaReceber : listaProcessar) {
			//// System.out.println(contador + " :========================================");
			contador++;
			try {
				//// System.out.println(" Atualizando Código de Barra Conta Receber: " + contaReceber.getCodigo());
				// String nossoNr = contaReceber.getNossoNumero();
				// a/lterarNossoNumero(contaReceber);
				gerarDadosBoleto(contaReceber, configuracaoFinanceiroVO, false, usuario);
				//// System.out.println(" Ok ");
			} catch (Exception e) {
				//// System.out.println(" Erro " + e.getMessage());
			}
			//// System.out.println("----------------------------------------");
		}
	}

	public void executarAjusteNossoNumeroParceiro(ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> listaProcessar = consultarPorParceiroSituacaoAreceber(false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		int contador = 1;
		for (ContaReceberVO contaReceber : listaProcessar) {
			//// System.out.println(contador + " :========================================");
			contador++;
			try {
				//// System.out.println(" Atualizando Código de Barra Conta Receber: " + contaReceber.getCodigo());
				// String nossoNr = contaReceber.getNossoNumero();
				// a/lterarNossoNumero(contaReceber);
				gerarDadosBoleto(contaReceber, configuracaoFinanceiroVO, false, usuario);
				//// System.out.println(" Ok ");
			} catch (Exception e) {
				//// System.out.println(" Erro " + e.getMessage());
			}
			//// System.out.println("----------------------------------------");
		}
	}

	public void executarAjusteNossoNumeroPorCursoTurmaSituacaoAreceberAlunosComContasPagas(Integer curso, Integer turma, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> listaProcessar = consultarPorCursoTurmaSituacaoAreceberAlunosComContasPagas(curso, turma, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		int contador = 1;
		for (ContaReceberVO contaReceber : listaProcessar) {
			//// System.out.println(contador + " :========================================");
			contador++;
			try {
				//// System.out.println(" Atualizando Código de Barra Conta Receber: " + contaReceber.getCodigo());
				// String nossoNr = contaReceber.getNossoNumero();
				// a/lterarNossoNumero(contaReceber);
				gerarDadosBoleto(contaReceber, configuracaoFinanceiroVO, false, usuario);
				//// System.out.println(" Ok ");
			} catch (Exception e) {
				//// System.out.println(" Erro " + e.getMessage());
			}
			//// System.out.println("----------------------------------------");
		}
	}

	public void calcularDescontoAluno(Boolean valorCheio, String tipoDescontoAluno, Double percDescontoAluno, Double valorDescontoAluno, PlanoFinanceiroAlunoDescricaoDescontosVO planoComValoresCalculadosParaDataEspecifica, Boolean aplicarCalculoComBaseDescontosCalculados, Boolean descontoAlunoValidoAteDataVencimento) {
		Double valorBaseCalculoUtilizar = 0.0;
		if (valorCheio) {
			valorBaseCalculoUtilizar = planoComValoresCalculadosParaDataEspecifica.getValorBase();
		} else {
			valorBaseCalculoUtilizar = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();
		}
		if (valorBaseCalculoUtilizar.doubleValue() <= 0) {
			// Uma vez que tenho uma base de calculo do próximo desconto zerada,
			// o que pode ocorrer quando
			// os descontos anteriormente aplicados são superiores ao valor da
			// conta a receber, então já
			// temos que assimir o desconto do alnuo como zero, pois não existe
			// como aplicá-lo, mais
			planoComValoresCalculadosParaDataEspecifica.setValorDescontoAluno(0.0);
			return;
		}
		if (tipoDescontoAluno.equals("PO")) {
			if (percDescontoAluno == 100.0) {
				planoComValoresCalculadosParaDataEspecifica.setDescontoCemPorCento(true);
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoAluno(valorBaseCalculoUtilizar);
				valorDescontoAluno = valorBaseCalculoUtilizar;
			} else {
				valorDescontoAluno = Uteis.arrendondarForcando2CadasDecimais(valorBaseCalculoUtilizar * (percDescontoAluno / 100.0));
			}
		} else {
			// Se o desconto do aluno está sendo dado em valor e não em
			// percentual, temos que verificar se o mesmo é maior que
			// o valorRestanteDaContaAReceber (já descontados outros possíveis
			// descontos - como convenio, instituicao - dada a ordem
			// de aplicacao dos mesmos.
			if (valorDescontoAluno > planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados()) {
				// O desconto em valor fornecido ao aluno é maior que o valor
				// que resta na conta receber, já aplicados outros descontos
				// então definimos que o maximo que o valor do desconto do aluno
				// pode assumir é próprio valor restante da conta
				// armazenado em
				// planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados().
				// Caso contrário
				// o valor do desconto seria maior que o valor da conta a
				// receber.
				valorDescontoAluno = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();
			}
		}
		// Comentado por Edigar em 23/01/2014
		// if (valorDescontoAluno.equals(valorBaseCalculoUtilizar)) {
		// planoComValoresCalculadosParaDataEspecifica.setDescontoCemPorCento(true);
		// planoComValoresCalculadosParaDataEspecifica.setValorDescontoAluno(valorBaseCalculoUtilizar);
		// } else {
		// planoComValoresCalculadosParaDataEspecifica.setValorDescontoAluno(valorDescontoAluno);
		// Double valorComDescontoAtualizado =
		// Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados()
		// - valorDescontoAluno);
		// planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(valorComDescontoAtualizado);
		// }
		if (descontoAlunoValidoAteDataVencimento) {
			planoComValoresCalculadosParaDataEspecifica.setValorDescontoComValidade(planoComValoresCalculadosParaDataEspecifica.getValorDescontoComValidade() + valorDescontoAluno);
		} else {
			planoComValoresCalculadosParaDataEspecifica.setValorDescontoSemValidade(planoComValoresCalculadosParaDataEspecifica.getValorDescontoSemValidade() + valorDescontoAluno);
		}
		planoComValoresCalculadosParaDataEspecifica.setValorDescontoAluno(valorDescontoAluno);
		Double valorComDescontoAtualizado = Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados() - valorDescontoAluno);
		planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(valorComDescontoAtualizado);
	}

	public PlanoFinanceiroAlunoDescricaoDescontosVO gerarDescontoProcessarParaDescontoAlunoEConvenio(Date dataBaseVencimento) {
		PlanoFinanceiroAlunoDescricaoDescontosVO plano = new PlanoFinanceiroAlunoDescricaoDescontosVO();
		plano.setDiaNrAntesVencimento(0);
		plano.setDataLimiteAplicacaoDesconto(dataBaseVencimento);
		plano.setTipoOrigemDesconto(PlanoFinanceiroAlunoDescricaoDescontosVO.TIPODESCONTOPADRAO);
		return plano;
	}

	/**
	 * Método alterar por Edigar na versão 5.0.3. O mesmo foi alterado para implementar um controle novo de forma que na descricao dos descontos da Conta a Receber/Boleto, também seja apresentado uma descrição de descontos válidos após o vencimento do parcela do aluno. Antes desta versão o SEI só listavas os descontos válidos até a data de vencimento. Assim, caso o aluno tenha dois descontos, um válido até a data de vencimento e outro não, no boleto não ficava claro esta situação. Com este método, verificamos se há um desconto que vence na data de vencimento, caso exista, então geramos a descrição de pagamento após o vencimento. Ficando claro para quem visualiza a conta a receber / boletos, qual o valor a ser pago após o vencimento.
	 */                                                   
	public List<PlanoFinanceiroAlunoDescricaoDescontosVO> executarGeracaoDescontosAplicaveisPlanoFinanceiroAluno(Boolean parcelaReferenteMatricula, Double valorBase, String tipoDescontoAluno, // valor
			Double percDescontoAluno, Double valorDescontoAluno, Boolean descontoAlunoValidoAteVencimento, Date dataBaseVencimento, Date dataOriginalVencimento, List<OrdemDescontoVO> ordemAplicacaoDescontos,
			DescontoProgressivoVO descontoProgressivoVO, List<PlanoDescontoVO> listaPlanosDescontosAluno, List<ConvenioVO> listaConveniosAluno, Integer diasVariacaoDataVencimento, Boolean usaDescontoCompostoPlanoDesconto, ConfiguracaoFinanceiroVO conf,
			Boolean realizandoRecebimento, Date dataReferenciaConsiderarBaixaTitulo, String matricula, Boolean aplicarCalculoComBaseDescontosCalculados, Integer cidade) throws Exception {
		
		
		//Adicionado regra para validar se a dataBase do vencimento esta em um dia util caso nao esteja e realizado a processo para colocar Antes alguma rotinas faziam essa verificacao e outras nao gerando assim uma incosistencia de dados no sistema entao foi
		// implementando nessa rotina para que assim todos que chamarem ela seja feita a validacao . Pedro Andrade 12/02/2018
		if (conf.getVencimentoParcelaDiaUtil()) {
			dataBaseVencimento = getFacadeFactory().getContaReceberFacade().obterDataVerificandoDiaUtil(dataBaseVencimento,cidade, null);			
		}
		boolean existeDescontoComValidadeAteVencimento = false;
		for (PlanoDescontoVO planoDescontoVO : listaPlanosDescontosAluno) {
			planoDescontoVO.setConsiderarApenasCalculoComBaseDescontosCalculados(false);
		}
		for (PlanoDescontoVO planoDescontoVO : listaPlanosDescontosAluno) {
			/**
			 * As verificações abaixo tem a finalidade de verificar se tem algum desconto da instutição cujo o valor coincide com a data de vencimento da conta a receber, sendo assim irá marcar true no campo existeDescontoComValidadeAteVencimento para que gere um outro desconto com o vencimento após a validade da conta a receber
			 */
			if ((parcelaReferenteMatricula && planoDescontoVO.getPercDescontoMatricula() > 0) || (!parcelaReferenteMatricula && planoDescontoVO.getPercDescontoParcela() > 0)) {
				if (planoDescontoVO.getDescontoValidoAteDataVencimento()) {
					existeDescontoComValidadeAteVencimento = true;
					planoDescontoVO.setDataLimiteAplicarDesconto(dataBaseVencimento);
				} else if (planoDescontoVO.getUtilizarDiaFixo()) {
					Date dataLimiteAplicacao = null;
					if (!Uteis.getMesmoMesAno(dataBaseVencimento, dataOriginalVencimento)) {
						dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(planoDescontoVO.getDiasValidadeVencimento(), dataOriginalVencimento, 0);
					} else {
						dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(planoDescontoVO.getDiasValidadeVencimento(), dataBaseVencimento, 0);
					}
					if(planoDescontoVO.getUtilizarAvancoDiaUtil()){
						dataLimiteAplicacao = getFacadeFactory().getFeriadoFacade().obterDataFuturaProximoDiaUtil(dataLimiteAplicacao, cidade, false, false, ConsiderarFeriadoEnum.NENHUM, null);
					}
					//Aqui trata se a dataLimiteAplicacao não ultrapassa o vencimento da conta a receber caso ultrapasse o desconto ficará limitado ao vencimento da conta a receber
					if(dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0 ) {
						dataLimiteAplicacao = dataBaseVencimento;						
					}
					planoDescontoVO.setDataLimiteAplicarDesconto(dataLimiteAplicacao);
					if (Uteis.getObterDiferencaDiasEntreDuasData(dataBaseVencimento, dataLimiteAplicacao).equals(0)) {
						existeDescontoComValidadeAteVencimento = true;
					}
				} else if (planoDescontoVO.getUtilizarDiaUtil()) {
					Date dataLimiteAplicacao = null;
					if (!Uteis.getMesmoMesAno(dataBaseVencimento, dataOriginalVencimento)) {
						dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataOriginalVencimento, planoDescontoVO.getDiasValidadeVencimento(), true);
					} else {
						dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, planoDescontoVO.getDiasValidadeVencimento(), true);
						int x = 1;
						while ((Uteis.getData(dataLimiteAplicacao).equals(Uteis.getData(dataBaseVencimento)) && Uteis.getDiaMesData(dataLimiteAplicacao) < planoDescontoVO.getDiasValidadeVencimento()) || dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0) {
							dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(Uteis.obterDataAntigaPorMes(dataBaseVencimento, x), planoDescontoVO.getDiasValidadeVencimento(), true);
							x++;
						}
					}					
					planoDescontoVO.setDataLimiteAplicarDesconto(dataLimiteAplicacao);
					if (Uteis.getObterDiferencaDiasEntreDuasData(dataBaseVencimento, dataLimiteAplicacao).equals(0)) {
						existeDescontoComValidadeAteVencimento = true;
					}
				}
			}
		}
		// Adicionado regra para validar se caso esteja sendo dado um desconto  do aluno manual e nao existe nenhum plano de desconto valido ate  o vencimento pois o cenario nao estava permitindo a geraçao desse desconto. 
		// Pedro Andrade 21/02/2018
		if(!existeDescontoComValidadeAteVencimento && 
				descontoAlunoValidoAteVencimento && 
				(Uteis.isAtributoPreenchido(dataReferenciaConsiderarBaixaTitulo) && UteisData.getCompareData(dataReferenciaConsiderarBaixaTitulo, dataBaseVencimento) <= 0 )&&
				(Uteis.isAtributoPreenchido(percDescontoAluno) || Uteis.isAtributoPreenchido(valorDescontoAluno))){
			existeDescontoComValidadeAteVencimento = true;	
		}
		
		return executarGeracaoDescontosAplicaveisPlanoFinanceiroAluno(parcelaReferenteMatricula, valorBase, tipoDescontoAluno,
				percDescontoAluno, valorDescontoAluno, descontoAlunoValidoAteVencimento, dataBaseVencimento, dataOriginalVencimento, ordemAplicacaoDescontos,
				descontoProgressivoVO, listaPlanosDescontosAluno,
				listaConveniosAluno, diasVariacaoDataVencimento, usaDescontoCompostoPlanoDesconto,
				conf.getVencimentoDescontoProgressivoDiaUtil(), realizandoRecebimento, dataReferenciaConsiderarBaixaTitulo,
				matricula, aplicarCalculoComBaseDescontosCalculados, existeDescontoComValidadeAteVencimento, cidade);
	}

	public List<PlanoFinanceiroAlunoDescricaoDescontosVO> executarGeracaoDescontosAplicaveisPlanoFinanceiroAluno(Boolean parcelaReferenteMatricula, Double valorBase, String tipoDescontoAluno, // valor
			Double percDescontoAluno, Double valorDescontoAluno, Boolean descontoAlunoValidoAteVencimento, Date dataBaseVencimento, Date dataOriginalVencimento, List<OrdemDescontoVO> ordemAplicacaoDescontos, DescontoProgressivoVO descontoProgressivoVO,
			List<PlanoDescontoVO> listaPlanosDescontosAluno, List<ConvenioVO> listaConveniosAluno, Integer diasVariacaoDataVencimento, Boolean usaDescontoCompostoPlanoDesconto, Boolean vencimentoDescontoProgressivoDiaUtil, Boolean realizandoRecebimento, Date dataReferenciaConsiderarBaixaTitulo,
			String matricula, Boolean aplicarCalculoComBaseDescontosCalculados, Boolean gerarDescontosAplicaveisAposVencimento, Integer cidade) throws Exception {
		List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaPadraoDescontos = executarGeracaoDescontosAplicaveisPlanoFinanceiroAlunoPadrao(parcelaReferenteMatricula, valorBase, tipoDescontoAluno,
				percDescontoAluno, valorDescontoAluno, descontoAlunoValidoAteVencimento, dataBaseVencimento, dataOriginalVencimento, ordemAplicacaoDescontos,
				descontoProgressivoVO, listaPlanosDescontosAluno,
				listaConveniosAluno, diasVariacaoDataVencimento, usaDescontoCompostoPlanoDesconto,
				vencimentoDescontoProgressivoDiaUtil, realizandoRecebimento, dataReferenciaConsiderarBaixaTitulo,
				matricula, aplicarCalculoComBaseDescontosCalculados, cidade);

		if (!vencimentoDescontoProgressivoDiaUtil) {
			if (descontoProgressivoVO != null) {
				vencimentoDescontoProgressivoDiaUtil = descontoProgressivoVO.getUtilizarDiaUtil();
			}
		}
		// vencimentoDescontoProgressivoDiaUtil = vencimentoDescontoProgressivoDiaUtil == false ? descontoProgressivoVO.getUtilizarDiaUtil() : vencimentoDescontoProgressivoDiaUtil;

		if (gerarDescontosAplicaveisAposVencimento) {

			/*
			 * Gerar uma nova lista de plano de desconto removendo os desconto que possuem validade é antes ou até o vencimento
			 */
			List<PlanoDescontoVO> planoDescontoAplicaveisAposVencimento = new ArrayList<PlanoDescontoVO>(0);
			for (PlanoDescontoVO planoDescontoVO : listaPlanosDescontosAluno) {
				boolean aplicavelAposVencimento = true;
				if (planoDescontoVO.getDescontoValidoAteDataVencimento()) {
					aplicavelAposVencimento = false;
				} else if (planoDescontoVO.getUtilizarDiaFixo()) {
					Date dataLimiteAplicacao = null;
					if (!Uteis.getMesmoMesAno(dataBaseVencimento, dataOriginalVencimento)) {
						dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(planoDescontoVO.getDiasValidadeVencimento(), dataOriginalVencimento, 0);
					} else {
						dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(planoDescontoVO.getDiasValidadeVencimento(), dataBaseVencimento, 0);
					}
					if(planoDescontoVO.getUtilizarAvancoDiaUtil()){
						dataLimiteAplicacao = getFacadeFactory().getFeriadoFacade().obterDataFuturaProximoDiaUtil(dataLimiteAplicacao, cidade, false, false, ConsiderarFeriadoEnum.NENHUM, null);
					}
					//Aqui trata se a dataLimiteAplicacao não ultrapassa o vencimento da conta a receber caso ultrapasse o desconto ficará limitado ao vencimento da conta a receber
					if(dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0 ) {
						dataLimiteAplicacao = dataBaseVencimento;						
					}
					if (Uteis.getObterDiferencaDiasEntreDuasData(dataBaseVencimento, dataLimiteAplicacao).equals(0)) {
						aplicavelAposVencimento = false;
					}
				} else if (planoDescontoVO.getUtilizarDiaUtil()) {
					Date dataLimiteAplicacao = realizarCalculoDataLimiteAplicacaoDescontoConsiderandoDiaUtil(
							dataBaseVencimento, dataOriginalVencimento, planoDescontoVO.getDiasValidadeVencimento());
					if (Uteis.getObterDiferencaDiasEntreDuasData(dataBaseVencimento, dataLimiteAplicacao).equals(0)) {
						aplicavelAposVencimento = false;
					}
				}
				if (aplicavelAposVencimento) {
					planoDescontoAplicaveisAposVencimento.add(planoDescontoVO);
				} else if (aplicarCalculoComBaseDescontosCalculados) {
					planoDescontoVO.setConsiderarApenasCalculoComBaseDescontosCalculados(true);
					planoDescontoAplicaveisAposVencimento.add(planoDescontoVO);
				}
			}

			// Abaixo chamamos o método que gera a lista de descontos, de forma a garantir que gere
			// a condição de pagamento que será aplicada para o aluno após o vencimento do boleto
			// Esta descrição é útil quando existem descontos que vencem na data de vencimento. Ou seja,
			// nestes casos é importante que o SEI imprima os valores a serem adotados após o pagamento
			// do boleto.
			Date dataReferenciaConsiderarBaixaTituloAposVcto = Uteis.getDataFutura(dataBaseVencimento, Calendar.DAY_OF_MONTH, 1);
			List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaComDescontoAposVcto = executarGeracaoDescontosAplicaveisPlanoFinanceiroAlunoPadrao(
					parcelaReferenteMatricula, valorBase, tipoDescontoAluno,
					percDescontoAluno, valorDescontoAluno, descontoAlunoValidoAteVencimento, dataBaseVencimento, dataOriginalVencimento, ordemAplicacaoDescontos,
					aplicarCalculoComBaseDescontosCalculados ? descontoProgressivoVO : null, planoDescontoAplicaveisAposVencimento,
					listaConveniosAluno, diasVariacaoDataVencimento, usaDescontoCompostoPlanoDesconto,
					vencimentoDescontoProgressivoDiaUtil, Boolean.TRUE, dataReferenciaConsiderarBaixaTituloAposVcto,
					matricula, aplicarCalculoComBaseDescontosCalculados, cidade);
			if ((listaComDescontoAposVcto != null) && (listaComDescontoAposVcto.size() > 0)) {
				if (!listaPadraoDescontos.isEmpty() && listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getDiaNrAntesVencimento().equals(0)) {
					listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).setReferentePlanoFinanceiroAteVencimento(true);
				}
				PlanoFinanceiroAlunoDescricaoDescontosVO planoAposVcto = listaComDescontoAposVcto.get(listaComDescontoAposVcto.size() - 1);
				if (!planoAposVcto.getValorBaseComDescontosJaCalculadosAplicados().equals(planoAposVcto.getValorBase())) {
					/**
					 * Quando o desconto é válido após a data de vencimento, se o atributo dataReferenciaConsiderarBaixaTitulo for maior que a dataBaseVencimento, seta a data limite aplicação do desconto como sendo a data referência considerar baixa título para que o desconto possa ser aplicado após o vencimento.
					 */
					if (Uteis.isAtributoPreenchido(dataReferenciaConsiderarBaixaTitulo) && dataReferenciaConsiderarBaixaTitulo.compareTo(dataBaseVencimento) >= 0) {
						planoAposVcto.setDataLimiteAplicacaoDesconto(dataReferenciaConsiderarBaixaTitulo);
					}
					planoAposVcto.setReferentePlanoFinanceiroAposVcto(Boolean.TRUE);
					planoAposVcto.setValorDescontoComValidade(0.0);					
					planoAposVcto.setDescontoProgressivoVO(null);
					planoAposVcto.setValorDescontoProgressivo(0.0);
					listaPadraoDescontos.add(planoAposVcto);
				}
			}
		} else {
			/**
			 * Este foi adicionado para resolver a aplicação do desconto de instituição quando a conta a receber está vencida e este desconto é sempre valido, então altera a informação da Data Limite Aplicação Desconto para a data da baixa pois por default vinha a data de vencimento, onde ao validar o getIsAplicavelDataParaQuitacao(Date dataVencimento, Date dataReferenciaQuitacao) em PlanoFinanceiroAlunoDescricaoDescontosVO retornava false quando deveria ser true. Rodrigo Wind 20/05/2015 08:40 em atendimento a reclamações da LS e CIN.
			 */
			if (!listaPadraoDescontos.isEmpty() && (listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getDiaNrAntesVencimento().equals(0))
					|| listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getDiaNrAntesVencimento() < 0) {
				if (Uteis.isAtributoPreenchido(dataReferenciaConsiderarBaixaTitulo) && dataReferenciaConsiderarBaixaTitulo.compareTo(dataBaseVencimento) >= 0
						&& !listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getReferentePlanoFinanceiroAteVencimento()
						&& (listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getValorDescontoInstituicao() > 0.0
								|| listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getValorDescontoConvenio() > 0.0) && (listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getReferentePlanoFinanceiroAposVcto()) || listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getReferentePlanoFinanceiroAteVencimento()) {
					/**
					 * Este foi adicionado para resolver o caso do aluno ter um desconto progressivo que é valido até o vencimento e um desconto institucional que sempre deve ser aplicado, no caso deve ser criado um novo obj de PlanoFinanceiroAlunoDescricaoDescontosVO marcado como referentePlanoFinanceiroAposVcto = true e com o valor do desconto progressivo zerado, pois o sistema esta considerando o desconto progressivo mesmo após o vencimento. Rodrigo Wind 10/06/2015 11:20 em atendimento ao chamado da unifimes 8668.
					 */
					if (listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getValorDescontoProgressivo() > 0.0) {
						PlanoFinanceiroAlunoDescricaoDescontosVO clone = listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).clone();
						clone.setDataLimiteAplicacaoDesconto(dataReferenciaConsiderarBaixaTitulo);
						clone.setValorDescontoProgressivo(0.0);
						clone.setValorDescontoComValidade(0.0);
						
						clone.setReferentePlanoFinanceiroAposVcto(Boolean.TRUE);
						listaPadraoDescontos.add(clone);
					} else {
						listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).setDataLimiteAplicacaoDesconto(dataReferenciaConsiderarBaixaTitulo);
						listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).setReferentePlanoFinanceiroAposVcto(Boolean.TRUE);
						listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).setDiaNrAntesVencimento(0);
					}
				} else if (!listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getReferentePlanoFinanceiroAteVencimento()
						&& (listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getValorDescontoInstituicao() > 0.0
								|| listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getValorDescontoConvenio() > 0.0)
						&& listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getValorDescontoProgressivo() > 0.0) {
					PlanoFinanceiroAlunoDescricaoDescontosVO clone = listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).clone();
					clone.setValorDescontoProgressivo(0.0);
					clone.setValorDescontoComValidade(0.0);
					
					clone.setReferentePlanoFinanceiroAposVcto(Boolean.TRUE);
					listaPadraoDescontos.add(clone);
				} else if (!listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getReferentePlanoFinanceiroAteVencimento() && (listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getValorDescontoConvenio() > 0.0) && listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getValorDescontoProgressivo().equals(0.0)) {
					if (listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).getValorDescontoInstituicao() > 0.0) {
						PlanoFinanceiroAlunoDescricaoDescontosVO clone = listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).clone();
						clone.setValorDescontoProgressivo(0.0);
						clone.setValorDescontoComValidade(0.0);
						
						clone.setReferentePlanoFinanceiroAposVcto(Boolean.TRUE);
						listaPadraoDescontos.add(clone);
					} else {
						listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).setReferentePlanoFinanceiroAposVcto(Boolean.TRUE);
						listaPadraoDescontos.get(listaPadraoDescontos.size() - 1).setDiaNrAntesVencimento(0);
					}
				}
			}
		}
		return listaPadraoDescontos;
	}

	private Date realizarCalculoDataLimiteAplicacaoDescontoConsiderandoDiaUtil(Date dataBaseVencimento,
			Date dataOriginalVencimento, int diasUteis ) throws Exception {
		Date dataLimiteAplicacao = null;
		if (!Uteis.getMesmoMesAno(dataBaseVencimento, dataOriginalVencimento)) {
			dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataOriginalVencimento, diasUteis, true);
		} else {
			dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, diasUteis, true);
			int x = 1;
			while ((Uteis.getData(dataLimiteAplicacao).equals(Uteis.getData(dataBaseVencimento)) && Uteis.getDiaMesData(dataLimiteAplicacao) < diasUteis) || dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0) {
				dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(Uteis.obterDataAntigaPorMes(dataBaseVencimento, x), diasUteis, true);
				x++;
			}
		}
		return dataLimiteAplicacao;
	}

	/**
	 * Método responsável por retornar uma lista com os descontos previstos para uma determinada parcela, considerando todos os tipos de descontos possíveis, como desconto do aluno, progressivo, da instituicao, e assim por diante.
	 * 
	 * @param parcelaReferenteMatricula
	 * @param valorBase
	 * @param valorDescontoAluno
	 * @param valorDescontoConvenio
	 * @param dataBaseVencimento
	 * @param descontoProgressivoVO
	 * @param listaPlanosDescontosAluno
	 * @return
	 * @throws Exception
	 */
	@Override
	public List<PlanoFinanceiroAlunoDescricaoDescontosVO> executarGeracaoDescontosAplicaveisPlanoFinanceiroAlunoPadrao(Boolean parcelaReferenteMatricula, Double valorBase, String tipoDescontoAluno, // valor
			Double percDescontoAluno, Double valorDescontoAluno, Boolean descontoAlunoValidoAteVencimento, Date dataBaseVencimento, Date dataOriginalVencimento, List<OrdemDescontoVO> ordemAplicacaoDescontos,
			DescontoProgressivoVO descontoProgressivoVO, List<PlanoDescontoVO> listaPlanosDescontosAluno,
			List<ConvenioVO> listaConveniosAluno, Integer diasVariacaoDataVencimento, Boolean usaDescontoCompostoPlanoDesconto,
			Boolean vencimentoDescontoProgressivoDiaUtil, Boolean realizandoRecebimento, Date dataReferenciaConsiderarBaixaTitulo,
			String matricula, Boolean aplicarCalculoComBaseDescontosCalculados, Integer cidade) throws Exception {
		List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosProcessar = new ArrayList<PlanoFinanceiroAlunoDescricaoDescontosVO>(0);

		if (descontoProgressivoVO != null && !descontoProgressivoVO.getCodigo().equals(0)) {
			Boolean utilizarDescontoProgressivoManual = descontoProgressivoVO.getDescontoProgressivoEditadoManualmenteContaReceber();
			Integer dia1 = descontoProgressivoVO.getDiaLimite1();
			Integer dia2 = descontoProgressivoVO.getDiaLimite2();
			Integer dia3 = descontoProgressivoVO.getDiaLimite3();
			Integer dia4 = descontoProgressivoVO.getDiaLimite4();
			if(descontoProgressivoVO.getNivelMontarDados() == null || !descontoProgressivoVO.getNivelMontarDados().equals(NivelMontarDados.TODOS)) {
			getFacadeFactory().getDescontoProgressivoFacade().carregarDados(descontoProgressivoVO, null);
			}
			vencimentoDescontoProgressivoDiaUtil = vencimentoDescontoProgressivoDiaUtil == false ? descontoProgressivoVO.getUtilizarDiaUtil() : vencimentoDescontoProgressivoDiaUtil;
			if (utilizarDescontoProgressivoManual) {
				// se o desconto progressivo sofreu alteracao na conta a receber, isto ocorreu nos nrdias de aplicacao.
				// Entao vamos garantir que os dados informados na conta a reeber prevalecam sobre os dados padroes do desconto progressivo
				descontoProgressivoVO.setDiaLimite1(dia1);
				descontoProgressivoVO.setDiaLimite2(dia2);
				descontoProgressivoVO.setDiaLimite3(dia3);
				descontoProgressivoVO.setDiaLimite4(dia4);
				descontoProgressivoVO.setDescontoProgressivoEditadoManualmenteContaReceber(Boolean.TRUE);
			}
		}

		inicializarListaDescontosComDescontoProgressivo(listaDescontosProcessar, dataBaseVencimento, dataOriginalVencimento, descontoProgressivoVO);
		inicializarListaDescontosComPlanoDescontoInstituicao(listaDescontosProcessar, dataBaseVencimento, dataOriginalVencimento, listaPlanosDescontosAluno, parcelaReferenteMatricula, realizandoRecebimento, dataReferenciaConsiderarBaixaTitulo, vencimentoDescontoProgressivoDiaUtil, cidade);

		if (descontoProgressivoVO != null && !descontoProgressivoVO.getCodigo().equals(0)) {
			if (descontoProgressivoVO.getUtilizarDiaUtil()) {
				// Esta variável é utilizada para controlar o número de dias que
				// deve ser
				// antecipado o desconto, em decorrência de meses com menos dias
				// do
				// que 30
				// (Exemplo: fevereiro). Ou seja, quando a conta vence 10 antes
				// do
				// vcto
				// e a data de vencimento nao é dia 30, mas 28, entao de
				// aplicacao
				// de descontp
				// deve ser dia 18 (dez dias antes). Mas quando estamos
				// aplicando
				// desconto progressivo
				// isto não é necessário, pois não se trata de dias antes do
				// vcto
				diasVariacaoDataVencimento = 0;
			}
		}

		Boolean geradoPlanoSomenteApresentacaoDescontoAlunoEConvenio = false;
		PlanoFinanceiroAlunoDescricaoDescontosVO descontoGerado = gerarDescontoProcessarParaDescontoAlunoEConvenio(dataBaseVencimento);
		listaDescontosProcessar.add(descontoGerado);

		ordenarListaDescontoDeAcordoComNrDiasAntesVcto(listaDescontosProcessar);
		List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosOrganizadaParaPorDataParaCalculoDescontos = new ArrayList<PlanoFinanceiroAlunoDescricaoDescontosVO>(0);
		List<Integer> listaDatasAplicacaoDescontoComBaseNrDiasAntesVcto = definirDatasAplicacaoDescontoComBaseNrDiasAntesVcto(listaDescontosProcessar);

		// Processando a lista na ordem inversa - para os descontos maiores
		// sejam definidos primeiro que os demais
		int posicao = listaDatasAplicacaoDescontoComBaseNrDiasAntesVcto.size() - 1;
		Integer diaVctoComecaASerAplicado = null;
		while (posicao >= 0) {
			Integer diaUnificarValorDescontosAplicaveis = listaDatasAplicacaoDescontoComBaseNrDiasAntesVcto.get(posicao);
			PlanoFinanceiroAlunoDescricaoDescontosVO planoProcessado = executarGeracaoPlanoFinanceiroAlunoUnificadoParaNrDiasAntesVcto(diaUnificarValorDescontosAplicaveis, diaVctoComecaASerAplicado, listaDescontosProcessar, parcelaReferenteMatricula, valorBase, tipoDescontoAluno, percDescontoAluno, valorDescontoAluno, descontoAlunoValidoAteVencimento, dataBaseVencimento, ordemAplicacaoDescontos, listaConveniosAluno, diasVariacaoDataVencimento, usaDescontoCompostoPlanoDesconto, vencimentoDescontoProgressivoDiaUtil && (descontoProgressivoVO != null && descontoProgressivoVO.getCodigo() > 0), matricula, aplicarCalculoComBaseDescontosCalculados, descontoProgressivoVO, cidade);
			validarSePlanoProcessadoNrDiasAntesVctoJaExisteNaLista(listaDescontosOrganizadaParaPorDataParaCalculoDescontos, planoProcessado);
			diaVctoComecaASerAplicado = diaUnificarValorDescontosAplicaveis - 1;
			posicao--;
		}
		if (!geradoPlanoSomenteApresentacaoDescontoAlunoEConvenio) {
			// como foram geradas vários planos, com data de aplicação definidas
			// com base no nr de dias antes vcto aplicar. Temos que providenciar
			// a geracao de um plano final, que descreve, os descontos que o
			// aluno
			// terá mesmo que .
			PlanoFinanceiroAlunoDescricaoDescontosVO planoProcessado = null;
		}
		return listaDescontosOrganizadaParaPorDataParaCalculoDescontos;
	}

	// Verificar se o plano a ser adicionador ja existe na lista pois só pode existe um desconto por dia, pois pode acontecer que ao processar nr de dias antes do Vcto do tipo util tenho acarregado de dias terem ficados iguais por exemplo:
	// a lista contendo os dias 25 e 23 antes do vencimento ao calcular o dias util os dois podem ficar no mesmo dia pois um caiu no sabado e vai para o proximo dia util que é segunda feira e o outro ja cai na segunda feria
	// por isso da verificação da lista novamente.
	public void validarSePlanoProcessadoNrDiasAntesVctoJaExisteNaLista(List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosOrganizadaParaPorDataParaCalculoDescontos, PlanoFinanceiroAlunoDescricaoDescontosVO planoProcessado) {
		int index = 0;
		for (PlanoFinanceiroAlunoDescricaoDescontosVO objExistente : listaDescontosOrganizadaParaPorDataParaCalculoDescontos) {
			if (objExistente.getDiaNrAntesVencimento().equals(planoProcessado.getDiaNrAntesVencimento())
					&& objExistente.getReferentePlanoFinanceiroAposVcto().equals(planoProcessado.getReferentePlanoFinanceiroAposVcto())
					&& objExistente.getReferentePlanoFinanceiroAteVencimento().equals(planoProcessado.getReferentePlanoFinanceiroAteVencimento())) {

				if (((objExistente.getPercentualDescontoProgressivo() < planoProcessado.getPercentualDescontoProgressivo())
						|| (objExistente.getValorDescontoProgressivo() < planoProcessado.getValorDescontoProgressivo())
						|| (objExistente.getValorFixoDescontoProgressivo() < planoProcessado.getValorFixoDescontoProgressivo()))) {
					listaDescontosOrganizadaParaPorDataParaCalculoDescontos.set(index, planoProcessado);
				}
				return;
			}
			index++;
		}
		listaDescontosOrganizadaParaPorDataParaCalculoDescontos.add(planoProcessado);
	}

	/**
	 * Rotina responsável por processar todos os descontos, cuja aplicação depende do número de dias antes do vencimento. A mesma é responsável por gerar uma lista ordenada, com base no nr dias antes do vencimento Sendo capaz de unificar o desconto progressivo com um plano de desconto do aluno, caso o nr dias antes do vencimento da mesma seja igual. Ou seja, se um desconto progressivo deve ser aplicado até 10 antes do vencimento, e um plano de desconto do aluno também pode ser aplicado até o dia 10 antes do vencimento, então o valor destes dois descontos devem ser apresentado em uma única linha, que descreve o valor a ser pago até 10 dias antes do vencimento. Vale considerar que caso exista um desconto progressivo, com aplicacao até 20 dias antes do vencimento, o mesmo também devera ser apresentado considerado o desconto do plano de aluno, que se é aplicável para 10 dias antes, também é aplicável para 20 dias antes.
	 * 
	 * @param listaDescontos
	 */
	private List<Integer> definirDatasAplicacaoDescontoComBaseNrDiasAntesVcto(List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontos) throws Exception {
		List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosFinal = new ArrayList<PlanoFinanceiroAlunoDescricaoDescontosVO>(0);
		Set<Integer> listaDiasQueImpactamFinalDesconto = new HashSet<Integer>();
		for (PlanoFinanceiroAlunoDescricaoDescontosVO descontos : listaDescontos) {
			listaDiasQueImpactamFinalDesconto.add(descontos.getDiaNrAntesVencimento());
		}

		List<Integer> vetorComDiasQueImpactamFinalDesconto = new ArrayList<Integer>(listaDiasQueImpactamFinalDesconto);
		Collections.sort(vetorComDiasQueImpactamFinalDesconto);

		return vetorComDiasQueImpactamFinalDesconto;
	}

	private PlanoFinanceiroAlunoDescricaoDescontosVO obterPrimeiroPlanoDescontoNrDiasIgualAoQueEstaSendoProcessado(Integer diaUnificarValorDescontosAplicaveis, List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosAplicaviesMesmoNrDiasAntesVcto) {
		for (PlanoFinanceiroAlunoDescricaoDescontosVO planoVerificar : listaDescontosAplicaviesMesmoNrDiasAntesVcto) {
			if (planoVerificar.getDiaNrAntesVencimento().equals(diaUnificarValorDescontosAplicaveis)) {
				return planoVerificar;
			}
		}
		return listaDescontosAplicaviesMesmoNrDiasAntesVcto.get(0);
	}

	private PlanoFinanceiroAlunoDescricaoDescontosVO executarGeracaoPlanoFinanceiroAlunoUnificadoParaNrDiasAntesVcto(Integer diaUnificarValorDescontosAplicaveis, Integer diaVctoComecaASerAplicado, List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontos, Boolean parcelaReferenteMatricula, Double valorBase, String tipoDescontoAluno, // valor
			// ou
			// percentual
			Double percDescontoAluno, Double valorDescontoAluno, Boolean descontoAlunoValidoAteVencimento, Date dataBaseVencimento, List<OrdemDescontoVO> ordemAplicacaoDescontos, List<ConvenioVO> listaConveniosAluno, Integer diasVariacaoDataVencimento, Boolean usaDescontoCompostoPlanoDesconto, Boolean vencimentoDescontoProgressivoDiaUtil, String matricula, Boolean aplicarCalculoComBaseDescontosCalculados, DescontoProgressivoVO descontoProgressivoVO, Integer cidade) throws Exception {
		List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosAplicaviesMesmoNrDiasAntesVcto = new ArrayList<PlanoFinanceiroAlunoDescricaoDescontosVO>(0);
		Boolean planoDescontoPadrao = false;
		Boolean planoDescontoDiaUtil = false;
		Boolean planoDescontoDiaFixo = false;
		List<Integer> ordensPlanoDescontoBase = new ArrayList<Integer>(0);
		Integer ordemPlanoDescontoBase = null;
		Integer maiorOrdemPlanoDescontoBase = 0;
		List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontoParaCalculoAnterior = new ArrayList<PlanoFinanceiroAlunoDescricaoDescontosVO>(0);
		List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaPlanoDescontoParaCalculoAnterior = new ArrayList<PlanoFinanceiroAlunoDescricaoDescontosVO>(0);
		PlanoFinanceiroAlunoDescricaoDescontosVO planoDescontoProgressivoConsiderarAnterior = null;
		PlanoFinanceiroAlunoDescricaoDescontosVO planoDescontoProgressivoConsiderar = null;
		Boolean considerarPlanoDescontoAnterior = false;
		for (PlanoFinanceiroAlunoDescricaoDescontosVO planoVerificar : listaDescontos) {
			if (planoVerificar.getTipoOrigemDesconto().equals("DescontoProgressivo")
					&& (planoDescontoProgressivoConsiderarAnterior == null
							|| (planoDescontoProgressivoConsiderarAnterior.getDiaNrAntesVencimento() < planoVerificar.getDiaNrAntesVencimento()
									&& ((planoDescontoProgressivoConsiderarAnterior.getPercentualDescontoProgressivo() > 0 && planoDescontoProgressivoConsiderarAnterior.getPercentualDescontoProgressivo() <= planoVerificar.getPercentualDescontoProgressivo())
											|| (planoDescontoProgressivoConsiderarAnterior.getValorDescontoProgressivo() > 0 && planoDescontoProgressivoConsiderarAnterior.getValorDescontoProgressivo() <= planoVerificar.getValorDescontoProgressivo())
											|| (planoDescontoProgressivoConsiderarAnterior.getValorFixoDescontoProgressivo() > 0 && planoDescontoProgressivoConsiderarAnterior.getValorFixoDescontoProgressivo() < planoVerificar.getValorFixoDescontoProgressivo()))))) {
				planoDescontoProgressivoConsiderarAnterior = planoVerificar;
//			} else if (!planoVerificar.getTipoOrigemDesconto().equals("DescontoProgressivo") && !planoVerificar.getIsAplicavelDia(diaUnificarValorDescontosAplicaveis)) {				
			} else if (!planoVerificar.getTipoOrigemDesconto().equals("DescontoProgressivo")) {				
				listaDescontoParaCalculoAnterior.add(planoVerificar);		
				if(!planoVerificar.getIsAplicavelDia(diaUnificarValorDescontosAplicaveis)) {
					listaPlanoDescontoParaCalculoAnterior.add(planoVerificar);
				}
			}
			if (planoVerificar.getTipoOrigemDesconto().equals("DescontoProgressivo")
					&& ((planoDescontoProgressivoConsiderar == null && diaUnificarValorDescontosAplicaveis >= planoVerificar.getDiaNrAntesVencimento())
							|| (diaUnificarValorDescontosAplicaveis >= planoVerificar.getDiaNrAntesVencimento() && planoDescontoProgressivoConsiderar != null &&
									((planoDescontoProgressivoConsiderar.getPercentualDescontoProgressivo() > 0 && planoDescontoProgressivoConsiderar.getPercentualDescontoProgressivo() < planoVerificar.getPercentualDescontoProgressivo())
											|| (planoDescontoProgressivoConsiderar.getValorDescontoProgressivo() > 0 && planoDescontoProgressivoConsiderar.getValorDescontoProgressivo() < planoVerificar.getValorDescontoProgressivo())
											|| (planoDescontoProgressivoConsiderar.getValorFixoDescontoProgressivo() > 0 && planoDescontoProgressivoConsiderar.getValorFixoDescontoProgressivo() < planoVerificar.getValorFixoDescontoProgressivo()))))) {
				planoDescontoProgressivoConsiderar = planoVerificar;				

			}
			if (planoVerificar.getIsAplicavelDia(diaUnificarValorDescontosAplicaveis) && !planoVerificar.getTipoOrigemDesconto().equals("DescontoProgressivo")) {
				if ((planoVerificar.getIsPlanoDescontoPadrao()) && (listaDescontos.size() == 1)) {
					// se for o padrao e tiver somente ele para processamento,
					// pois vale lembrar que como ele padrao, podera ser
					// aplicado para qualquer
					// antes vcto
					planoDescontoPadrao = true;
				}
				if (planoVerificar.getPlanoDescontoVO().getCodigo() > 0 && planoVerificar.getPlanoDescontoVO().getUtilizarDiaUtil() && planoVerificar.getPlanoDescontoVO().getPercDescontoMatricula() > 0 && parcelaReferenteMatricula) {
					planoDescontoDiaUtil = true;
				} else if (planoVerificar.getPlanoDescontoVO().getCodigo() > 0 && planoVerificar.getPlanoDescontoVO().getUtilizarDiaUtil() && planoVerificar.getPlanoDescontoVO().getPercDescontoParcela() > 0 && !parcelaReferenteMatricula) {
					planoDescontoDiaUtil = true;
				} else if (planoVerificar.getPlanoDescontoVO().getCodigo() > 0 && planoVerificar.getPlanoDescontoVO().getUtilizarDiaFixo() && planoVerificar.getPlanoDescontoVO().getPercDescontoParcela() > 0 && !parcelaReferenteMatricula) {
					planoDescontoDiaFixo = true;
				} else if (planoVerificar.getPlanoDescontoVO().getCodigo() > 0 && planoVerificar.getPlanoDescontoVO().getUtilizarDiaFixo() && planoVerificar.getPlanoDescontoVO().getPercDescontoMatricula() > 0 && parcelaReferenteMatricula) {
					planoDescontoDiaFixo = true;
				}
				listaDescontosAplicaviesMesmoNrDiasAntesVcto.add(planoVerificar);
				if ((Uteis.isAtributoPreenchido(planoVerificar.getPlanoDescontoVO()) && planoVerificar.getPlanoDescontoVO().getConsiderarApenasCalculoComBaseDescontosCalculados())) {
					if (!ordensPlanoDescontoBase.contains(planoVerificar.getPlanoDescontoVO().getOrdemPrioridadeParaCalculo())) {
						ordensPlanoDescontoBase.add(planoVerificar.getPlanoDescontoVO().getOrdemPrioridadeParaCalculo());
					}				
				}		
				if(Uteis.isAtributoPreenchido(planoVerificar.getPlanoDescontoVO()) && planoVerificar.getPlanoDescontoVO().getAplicarSobreValorBaseDeduzidoValorOutrosPlanosDesconto()) {
					for (PlanoFinanceiroAlunoDescricaoDescontosVO planoVerificar2 : listaDescontos) {
						if(Uteis.isAtributoPreenchido(planoVerificar2.getPlanoDescontoVO()) 
								&& !planoVerificar2.getIsAplicavelDia(diaUnificarValorDescontosAplicaveis)
								&& planoVerificar2.getPlanoDescontoVO().getOrdemPrioridadeParaCalculo() < planoVerificar.getPlanoDescontoVO().getOrdemPrioridadeParaCalculo() ) {
							considerarPlanoDescontoAnterior =  true;
							if (!ordensPlanoDescontoBase.contains(planoVerificar.getPlanoDescontoVO().getOrdemPrioridadeParaCalculo())) {
								ordensPlanoDescontoBase.add(planoVerificar.getPlanoDescontoVO().getOrdemPrioridadeParaCalculo());
							}	
						}
					}
				}
				if (Uteis.isAtributoPreenchido(planoVerificar.getPlanoDescontoVO()) && !planoVerificar.getPlanoDescontoVO().getConsiderarApenasCalculoComBaseDescontosCalculados() && maiorOrdemPlanoDescontoBase < planoVerificar.getPlanoDescontoVO().getOrdemPrioridadeParaCalculo()) {
					maiorOrdemPlanoDescontoBase = planoVerificar.getPlanoDescontoVO().getOrdemPrioridadeParaCalculo();
				}
				
			}
		}
		if (!ordensPlanoDescontoBase.isEmpty()) {
			for (Integer ordem : ordensPlanoDescontoBase) {
				if (ordem < maiorOrdemPlanoDescontoBase) {
					if (ordemPlanoDescontoBase == null || ordemPlanoDescontoBase > ordem) {
						ordemPlanoDescontoBase = ordem;
					}
				}
			}
		}
 		if (planoDescontoProgressivoConsiderarAnterior != null) {
			listaDescontoParaCalculoAnterior.add(planoDescontoProgressivoConsiderarAnterior);
		}
		if (planoDescontoProgressivoConsiderar != null) {
			listaDescontosAplicaviesMesmoNrDiasAntesVcto.add(planoDescontoProgressivoConsiderar);
		}
		// Integer diaAntesVctoComecaASerAplicado = Integer.MAX_VALUE;
		PlanoFinanceiroAlunoDescricaoDescontosVO planoComValoresCalculadosParaDataEspecifica = new PlanoFinanceiroAlunoDescricaoDescontosVO();
		if (planoDescontoPadrao) {
			planoComValoresCalculadosParaDataEspecifica.setTipoOrigemDesconto(PlanoFinanceiroAlunoDescricaoDescontosVO.TIPODESCONTOPADRAO);
		}
		planoComValoresCalculadosParaDataEspecifica.setDiaNrAntesVencimento(diaUnificarValorDescontosAplicaveis);
		if (diaVctoComecaASerAplicado == null) {
			// significa que estamos na primeira interacao, logo a data de
			// inicio de aplicacao deve ser inicializada,
			// com uma data bem antiga, garantindo que isto nao seja um
			// impecilho para a aplicacao do plano
			diaVctoComecaASerAplicado = PlanoFinanceiroAlunoDescricaoDescontosVO.NRDIASCOMECARACONTARVALIDADEPLANODESCONTO;
		}
		planoComValoresCalculadosParaDataEspecifica.setDiaNrAntesVencimentoDescontoComecaASerAplicado(diaVctoComecaASerAplicado);
		Date dataInicioAplicacao = Uteis.obterDataPassada(dataBaseVencimento, diaVctoComecaASerAplicado - 1);
		if (diaVctoComecaASerAplicado < 0) {
			dataInicioAplicacao = dataBaseVencimento;
		}
		planoComValoresCalculadosParaDataEspecifica.setDataInicioAplicacaoDesconto(dataInicioAplicacao);
		// Date dataLimiteAplicacao = Uteis.obterDataPassada(dataBaseVencimento,
		// diaUnificarValorDescontosAplicaveis - 1 +
		// diasVariacaoDataVencimento);
		Date dataLimiteAplicacao = Uteis.obterDataAntiga(dataBaseVencimento, diaUnificarValorDescontosAplicaveis);
		// Se na configuracao financeira estiver marcado o booleano
		// vencimentoDescontoProgressivoDiaUtil ele vai verificar se a data está
		// no dia Util
		if ((vencimentoDescontoProgressivoDiaUtil && planoDescontoProgressivoConsiderar != null && Uteis.isAtributoPreenchido(planoDescontoProgressivoConsiderar.getDescontoProgressivoVO())) || planoDescontoDiaUtil) {
			dataLimiteAplicacao = obterDataLimitAplicacaoDescontosVerificandoDiaUtil(dataBaseVencimento, diaUnificarValorDescontosAplicaveis, diasVariacaoDataVencimento, planoComValoresCalculadosParaDataEspecifica, cidade, null);
			//aqui trata para que a data limit de desconto não ultrapasse a data de vencimento da conta a receber
			if(dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0) {
				dataLimiteAplicacao = dataBaseVencimento;
			}
			int numeroNrAntesVencimentoUtil = Uteis.getObterDiferencaDiasEntreDuasData(dataBaseVencimento, dataLimiteAplicacao);
			if (numeroNrAntesVencimentoUtil != planoComValoresCalculadosParaDataEspecifica.getDiaNrAntesVencimento()) {
				planoComValoresCalculadosParaDataEspecifica.setDiaNrAntesVencimento(numeroNrAntesVencimentoUtil);
			}
		}
		planoComValoresCalculadosParaDataEspecifica.setVencimentoDescontoProgressivoDiaUtil(vencimentoDescontoProgressivoDiaUtil);
		planoComValoresCalculadosParaDataEspecifica.setDataLimiteAplicacaoDesconto(dataLimiteAplicacao);
		planoComValoresCalculadosParaDataEspecifica.setValorBase(valorBase);
		planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(valorBase);
		/**
		 * A regra abaixo foi adicionado pois quando um plano de desconto estiver marcado como Dia Fixo ou Dia Util e coincidentemente este desconto ficou sendo válido até o vencimento então o boolean referentePlanoFinanceiroAteVencimento deve ser definido como true para que o sistema não considere este desconto válido após o vencimento.
		 */
		if ((planoDescontoDiaFixo || planoDescontoDiaUtil) && planoComValoresCalculadosParaDataEspecifica.getDiaNrAntesVencimento().equals(0)) {
			planoComValoresCalculadosParaDataEspecifica.setReferentePlanoFinanceiroAteVencimento(true);
		}
		Ordenacao.ordenarLista(ordemAplicacaoDescontos, "posicaoAtual");
		Integer controladorOrdemAplicarDesconto = 0;

		for (Iterator<OrdemDescontoVO> iterator = ordemAplicacaoDescontos.iterator(); iterator.hasNext();) {
			OrdemDescontoVO ordem = (OrdemDescontoVO) iterator.next();
			if (ordem.isDescontoAluno()) {
				if (!ordem.getValorCheio() && aplicarCalculoComBaseDescontosCalculados && listaDescontos.size() > 1 && !valorDescontoAluno.equals(0.0)) {
					PlanoFinanceiroAlunoDescricaoDescontosVO planoComDescontoBaseCalculado = calcularDescontoAnterior(ordem, ordemAplicacaoDescontos, diaUnificarValorDescontosAplicaveis, diaVctoComecaASerAplicado, listaDescontoParaCalculoAnterior, parcelaReferenteMatricula, valorBase, tipoDescontoAluno, percDescontoAluno, valorDescontoAluno, descontoAlunoValidoAteVencimento, dataBaseVencimento, listaConveniosAluno, diasVariacaoDataVencimento, usaDescontoCompostoPlanoDesconto, vencimentoDescontoProgressivoDiaUtil, dataLimiteAplicacao, null, descontoProgressivoVO);
					planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(planoComDescontoBaseCalculado.getValorBaseComDescontosJaCalculadosAplicados());
					planoComDescontoBaseCalculado = null;
				}
				calcularDescontoAluno(ordem.getValorCheio(), tipoDescontoAluno, percDescontoAluno, valorDescontoAluno, planoComValoresCalculadosParaDataEspecifica, aplicarCalculoComBaseDescontosCalculados, descontoAlunoValidoAteVencimento);
			}
			if (ordem.isConvenio()) {
				if (!ordem.getValorCheio() && aplicarCalculoComBaseDescontosCalculados && listaDescontos.size() > 1 && !listaConveniosAluno.isEmpty()) {
					PlanoFinanceiroAlunoDescricaoDescontosVO planoComDescontoBaseCalculado = calcularDescontoAnterior(ordem, ordemAplicacaoDescontos, diaUnificarValorDescontosAplicaveis, diaVctoComecaASerAplicado, listaDescontoParaCalculoAnterior, parcelaReferenteMatricula, valorBase, tipoDescontoAluno, percDescontoAluno, valorDescontoAluno, descontoAlunoValidoAteVencimento, dataBaseVencimento, listaConveniosAluno, diasVariacaoDataVencimento, usaDescontoCompostoPlanoDesconto, vencimentoDescontoProgressivoDiaUtil, dataLimiteAplicacao, null, descontoProgressivoVO);
					planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(planoComDescontoBaseCalculado.getValorBaseComDescontosJaCalculadosAplicados());
					planoComDescontoBaseCalculado = null;
				}
				calcularDescontoConvenio(ordem.getValorCheio(), listaConveniosAluno, listaDescontosAplicaviesMesmoNrDiasAntesVcto, parcelaReferenteMatricula, planoComValoresCalculadosParaDataEspecifica, aplicarCalculoComBaseDescontosCalculados);
			}
			if (ordem.isDescontoProgressivo()) {
				if (!ordem.getValorCheio() && aplicarCalculoComBaseDescontosCalculados && listaDescontos.size() > 1) {
					PlanoFinanceiroAlunoDescricaoDescontosVO planoComDescontoBaseCalculado = calcularDescontoAnterior(ordem, ordemAplicacaoDescontos, diaUnificarValorDescontosAplicaveis, diaVctoComecaASerAplicado, listaDescontoParaCalculoAnterior, parcelaReferenteMatricula, valorBase, tipoDescontoAluno, percDescontoAluno, valorDescontoAluno, descontoAlunoValidoAteVencimento, dataBaseVencimento, listaConveniosAluno, diasVariacaoDataVencimento, usaDescontoCompostoPlanoDesconto, vencimentoDescontoProgressivoDiaUtil, dataLimiteAplicacao, null, descontoProgressivoVO);
					planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(planoComDescontoBaseCalculado.getValorBaseComDescontosJaCalculadosAplicados());
					planoComDescontoBaseCalculado = null;
				}
				calcularDescontoProgressivo(ordem.getValorCheio(), listaDescontosAplicaviesMesmoNrDiasAntesVcto, planoComValoresCalculadosParaDataEspecifica, aplicarCalculoComBaseDescontosCalculados, true, descontoProgressivoVO);
			}
			if (ordem.isPlanoDesconto()) {
				if (!ordem.getValorCheio() && aplicarCalculoComBaseDescontosCalculados && listaDescontos.size() > 1) {
						PlanoFinanceiroAlunoDescricaoDescontosVO planoComDescontoBaseCalculado = calcularDescontoAnterior(ordem, ordemAplicacaoDescontos, diaUnificarValorDescontosAplicaveis, diaVctoComecaASerAplicado, listaDescontoParaCalculoAnterior, parcelaReferenteMatricula, valorBase, tipoDescontoAluno, percDescontoAluno, valorDescontoAluno, descontoAlunoValidoAteVencimento, dataBaseVencimento, listaConveniosAluno, diasVariacaoDataVencimento, usaDescontoCompostoPlanoDesconto, vencimentoDescontoProgressivoDiaUtil, dataLimiteAplicacao, ordemPlanoDescontoBase, descontoProgressivoVO);
						planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(planoComDescontoBaseCalculado.getValorBaseComDescontosJaCalculadosAplicados());
						planoComDescontoBaseCalculado = null;
				}
				if(!ordem.getValorCheio() && considerarPlanoDescontoAnterior && listaPlanoDescontoParaCalculoAnterior.size()> 0)  {
					PlanoFinanceiroAlunoDescricaoDescontosVO planoFinanceiroAlunoDescricaoDescontosVO = new PlanoFinanceiroAlunoDescricaoDescontosVO();
					planoFinanceiroAlunoDescricaoDescontosVO.setVencimentoDescontoProgressivoDiaUtil(vencimentoDescontoProgressivoDiaUtil);
					planoFinanceiroAlunoDescricaoDescontosVO.setDataLimiteAplicacaoDesconto(dataLimiteAplicacao);
					planoFinanceiroAlunoDescricaoDescontosVO.setValorBase(valorBase);
					planoFinanceiroAlunoDescricaoDescontosVO.setValorBaseComDescontosJaCalculadosAplicados(valorBase);
					calcularDescontoPlanoDesconto(ordem.getValorCheio(), listaPlanoDescontoParaCalculoAnterior, parcelaReferenteMatricula, planoFinanceiroAlunoDescricaoDescontosVO, usaDescontoCompostoPlanoDesconto, false, true, ordemPlanoDescontoBase);
					planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados() - planoFinanceiroAlunoDescricaoDescontosVO.getValorDescontoInstituicao());
				}
				calcularDescontoPlanoDesconto(ordem.getValorCheio(), listaDescontosAplicaviesMesmoNrDiasAntesVcto, parcelaReferenteMatricula, planoComValoresCalculadosParaDataEspecifica, usaDescontoCompostoPlanoDesconto, aplicarCalculoComBaseDescontosCalculados, false, null);
			}
			controladorOrdemAplicarDesconto++;
		}
		executarCalculoTodosDescontosValidandoPercentualCemPorCento(planoDescontoPadrao, tipoDescontoAluno, percDescontoAluno, valorDescontoAluno, parcelaReferenteMatricula, listaConveniosAluno, planoComValoresCalculadosParaDataEspecifica, listaDescontosAplicaviesMesmoNrDiasAntesVcto, matricula);
		return planoComValoresCalculadosParaDataEspecifica;
	}

	public PlanoFinanceiroAlunoDescricaoDescontosVO calcularDescontoAnterior(OrdemDescontoVO ordemAtual, List<OrdemDescontoVO> ordemAplicacaoDescontos, Integer diaUnificarValorDescontosAplicaveis, Integer diaVctoComecaASerAplicado, List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontos, Boolean parcelaReferenteMatricula, Double valorBase, String tipoDescontoAluno, Double percDescontoAluno, Double valorDescontoAluno, Boolean descontoAlunoValidoAteVencimento, Date dataBaseVencimento, List<ConvenioVO> listaConveniosAluno, Integer diasVariacaoDataVencimento, Boolean usaDescontoCompostoPlanoDesconto, Boolean vencimentoDescontoProgressivoDiaUtil, Date dataLimiteAplicacao, Integer ordemAplicacaoPlanoDescontoBase, DescontoProgressivoVO descontoProgressivoVO) throws Exception {
		Integer controladorOrdemAplicarDesconto = 0;
		// Ordenacao.ordenarLista(ordemAplicacaoDescontos, "posicaoAtual");
		PlanoFinanceiroAlunoDescricaoDescontosVO planoFinanceiroAlunoDescricaoDescontosVO = new PlanoFinanceiroAlunoDescricaoDescontosVO();
		planoFinanceiroAlunoDescricaoDescontosVO.setVencimentoDescontoProgressivoDiaUtil(vencimentoDescontoProgressivoDiaUtil);
		planoFinanceiroAlunoDescricaoDescontosVO.setDataLimiteAplicacaoDesconto(dataLimiteAplicacao);
		planoFinanceiroAlunoDescricaoDescontosVO.setValorBase(valorBase);
		planoFinanceiroAlunoDescricaoDescontosVO.setValorBaseComDescontosJaCalculadosAplicados(valorBase);
		for (OrdemDescontoVO ordem : ordemAplicacaoDescontos) {
			if (ordem.isDescontoAluno() && !ordemAtual.isDescontoAluno() && ordemAplicacaoPlanoDescontoBase == null) {
				calcularDescontoAluno(ordem.getValorCheio(), tipoDescontoAluno, percDescontoAluno, valorDescontoAluno, planoFinanceiroAlunoDescricaoDescontosVO, false, descontoAlunoValidoAteVencimento);
			} else if (ordem.isDescontoAluno() && ordemAtual.isDescontoAluno()) {
				break;
			}
			if (ordem.isConvenio() && !ordemAtual.isConvenio() && ordemAplicacaoPlanoDescontoBase == null) {
				calcularDescontoConvenio(ordem.getValorCheio(), listaConveniosAluno, listaDescontos, parcelaReferenteMatricula, planoFinanceiroAlunoDescricaoDescontosVO, false);
			} else if (ordem.isConvenio() && ordemAtual.isConvenio()) {
				break;
			}
			if (ordem.isDescontoProgressivo() && !ordemAtual.isDescontoProgressivo() && ordemAplicacaoPlanoDescontoBase == null) {
				calcularDescontoProgressivo(ordem.getValorCheio(), listaDescontos, planoFinanceiroAlunoDescricaoDescontosVO, false, false, descontoProgressivoVO);
			} else if (ordem.isDescontoProgressivo() && ordemAtual.isDescontoProgressivo()) {
				break;
			}
			if (ordem.isPlanoDesconto() && (!ordemAtual.isPlanoDesconto() || ordemAplicacaoPlanoDescontoBase != null)) {
				calcularDescontoPlanoDesconto(ordem.getValorCheio(), listaDescontos, parcelaReferenteMatricula, planoFinanceiroAlunoDescricaoDescontosVO, usaDescontoCompostoPlanoDesconto, false, true, ordemAplicacaoPlanoDescontoBase);
			} else if (ordem.isPlanoDesconto() && ordemAtual.isPlanoDesconto()) {
				break;
			}
			controladorOrdemAplicarDesconto++;
		}
		return planoFinanceiroAlunoDescricaoDescontosVO;
	}

	public Date obterDataLimitAplicacaoDescontosVerificandoDiaUtil(Date dataBaseVencimento,  Integer diaUnificarValorDescontosAplicaveis, Integer diasVariacaoDataVencimento, PlanoFinanceiroAlunoDescricaoDescontosVO planoComValoresCalculadosParaDataEspecifica, Integer cidade, UsuarioVO usuario) throws Exception {
		Date dataLimiteAplicacao = Uteis.obterDataAntiga(dataBaseVencimento, diaUnificarValorDescontosAplicaveis - diasVariacaoDataVencimento);
		List<FeriadoVO> listaFeriadoVOs = getFacadeFactory().getFeriadoFacade().consultarPorData(dataLimiteAplicacao, ConsiderarFeriadoEnum.FINANCEIRO.name(), cidade, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		if (planoComValoresCalculadosParaDataEspecifica != null) {
			planoComValoresCalculadosParaDataEspecifica.setListaFeriadoVOs(listaFeriadoVOs);
		}
		Date data = getNextWorkingDay(dataLimiteAplicacao, dataBaseVencimento, listaFeriadoVOs, cidade);		
		return data;
	}

	public Date obterDataVerificandoDiaUtil(Date dataBaseVencimento, Integer cidade, UsuarioVO usuario) throws Exception {
		return getFacadeFactory().getFeriadoFacade().obterDataFuturaProximoDiaUtil(dataBaseVencimento, cidade, false, false, ConsiderarFeriadoEnum.FINANCEIRO, usuario);
		// return getFacadeFactory().getFeriadoFacade().realizarValidacaoEObterDataProximoDiaUtil(dataBaseVencimento, cidade, false, false, true, usuario);
	}
	
	/**
	 * Metodo criado exclusivamente para ser usado dentro do VO de conta RECeber pois o mesmo nao tem uma instancia do facadeFactory para utilizar o metodo obterDataVerificandoDiaUtil.
	 * @param dataBaseVencimento
	 * @param cidade
	 * @param usuario
	 * @return
	 * @throws Exception
	 */
	@Deprecated
	public static Date obterDataVerificandoDiaUtilStatic(Date dataBaseVencimento, Integer cidade, UsuarioVO usuario) throws Exception {
		return getFacadeFactory().getFeriadoFacade().obterDataFuturaProximoDiaUtil(dataBaseVencimento, cidade, false, false, ConsiderarFeriadoEnum.FINANCEIRO, usuario);
	}

	public CursoVO obterCursoVerificandoTurmaOrMatricula(ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		if (Uteis.isAtributoPreenchido(obj.getTurma())) {
			return getFacadeFactory().getCursoFacade().consultarCursoPorTurma(obj.getTurma().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSCONSULTA, usuario);
		} else if (Uteis.isAtributoPreenchido(obj.getMatriculaAluno())) {
			return getFacadeFactory().getCursoFacade().consultaRapidaPorMatricula(obj.getMatriculaAluno().getMatricula(), false, usuario);
		}
		return new CursoVO();
	}

	public TurnoVO obterTurnoVerificandoTurmaOrMatricula(ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		if (Uteis.isAtributoPreenchido(obj.getTurma())) {
			return getFacadeFactory().getTurnoFacade().consultarTurnoPorCodigoTurma(obj.getTurma().getCodigo(), false, Uteis.NIVELMONTARDADOS_COMBOBOX, usuario);
		} else if (Uteis.isAtributoPreenchido(obj.getMatriculaAluno())) {
			return getFacadeFactory().getTurnoFacade().consultaRapidaPorMatricula(obj.getMatriculaAluno().getMatricula(), usuario);
		}
		return new TurnoVO();
	}

	@SuppressWarnings("static-access")
	public Date getNextWorkingDay(Date aDate, Date dataLimiteAvancar, List<FeriadoVO> listaFeriadoVOs, Integer cidade) throws Exception {
		Date dataIncremental = aDate;
		Date dataAuxIncremental = aDate;
		while (!isWorkingDay(dataAuxIncremental, listaFeriadoVOs)) {
			dataAuxIncremental = new Date(dataAuxIncremental.getTime() + ONE_DAY);
			if(dataLimiteAvancar != null && Uteis.getData(dataLimiteAvancar).equals(Uteis.getData(dataAuxIncremental))) {
				break;
		}
			listaFeriadoVOs.addAll(getFacadeFactory().getFeriadoFacade().consultarPorData(dataAuxIncremental, ConsiderarFeriadoEnum.FINANCEIRO.name(), cidade, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, null));
		}
		Calendar cal1 = new GregorianCalendar();
		cal1.setTime(dataAuxIncremental);
		Calendar cal2 = new GregorianCalendar();
		cal2.setTime(dataIncremental);
		dataIncremental = dataAuxIncremental;
		return dataIncremental;
	}

	public boolean isWorkingDay(Date date, List<FeriadoVO> listaFeriadoVOs) throws Exception {
		if (!UteisData.getValidaDiaUtil(date)) {
			return false;
		}

		for (FeriadoVO holiday : listaFeriadoVOs) {
			if (holiday.isHoliday(date)) {
				return false;
			}
		}

		return true;
	}

	/**
	 * Método responsável por somar todos os descontos adicionados e verificar se é maior ou igual ao valor da matricula ou da parcela, caso seja, o valor do desconto deve ser igual ao valor de pagamento.
	 * 
	 * @param valorCheio
	 * @param tipoDesconto
	 * @param percDescontoAluno
	 * @param valorDescontoAluno
	 * @param parcelaReferenteMatricula
	 * @param listaConvenio
	 * @param planoComValoresCalculadosParaDataEspecifica
	 * @param listaDescontosAplicaviesMesmoNrDiasAntesVcto
	 * @throws Exception
	 * @Autor Carlos.
	 */
	public void executarCalculoTodosDescontosValidandoPercentualCemPorCento(Boolean valorCheio, String tipoDesconto, Double percDescontoAluno, Double valorDescontoAluno, Boolean parcelaReferenteMatricula, List<ConvenioVO> listaConvenio, PlanoFinanceiroAlunoDescricaoDescontosVO planoComValoresCalculadosParaDataEspecifica, List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosAplicaviesMesmoNrDiasAntesVcto, String matricula) throws Exception {
		Double valorTotalDescontos = Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoProgressivo() + planoComValoresCalculadosParaDataEspecifica.getValorDescontoAluno() + planoComValoresCalculadosParaDataEspecifica.getValorDescontoConvenio() + planoComValoresCalculadosParaDataEspecifica.getValorDescontoInstituicao() + planoComValoresCalculadosParaDataEspecifica.getValorCusteadoContaReceber() + planoComValoresCalculadosParaDataEspecifica.getValorDescontoRateio());
		// TODO Alberto Correção ordem dos descontos
		Double diferencaValorTotalDescontosTotalConta = Uteis.arrendondarForcando2CadasDecimais(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorBase()) - valorTotalDescontos);
		if ((diferencaValorTotalDescontosTotalConta > 0) && (diferencaValorTotalDescontosTotalConta <= 0.01)) {
			// Se o desconto ficou 0.01 inferior ao valor da conta, então o
			// sistema irá arrendondar o desconto
			// para termos o 100%. Para isto o sistema irá lançar esta difereça
			// no desconto da instituicao.
			planoComValoresCalculadosParaDataEspecifica.setValorDescontoInstituicao(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoInstituicao() + 0.01));

			if (Uteis.isAtributoPreenchido(planoComValoresCalculadosParaDataEspecifica.getValorDescontoInstituicao()) && planoComValoresCalculadosParaDataEspecifica.getValorDescontoInstituicao() >= 0.01) {
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoInstituicao(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoInstituicao() + 0.01));
			} else if (Uteis.isAtributoPreenchido(planoComValoresCalculadosParaDataEspecifica.getValorDescontoAluno()) && planoComValoresCalculadosParaDataEspecifica.getValorDescontoAluno() >= 0.01) {
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoAluno(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoAluno() + 0.01));
			} else if (Uteis.isAtributoPreenchido(planoComValoresCalculadosParaDataEspecifica.getValorDescontoRateio()) && planoComValoresCalculadosParaDataEspecifica.getValorDescontoRateio() >= 0.01) {
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoAluno(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoRateio() + 0.01));
			} else if (Uteis.isAtributoPreenchido(planoComValoresCalculadosParaDataEspecifica.getValorDescontoProgressivo()) && planoComValoresCalculadosParaDataEspecifica.getValorDescontoProgressivo() >= 0.01) {
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoProgressivo(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoProgressivo() + 0.01));
			} else if (Uteis.isAtributoPreenchido(planoComValoresCalculadosParaDataEspecifica.getValorDescontoConvenio()) && planoComValoresCalculadosParaDataEspecifica.getValorDescontoConvenio() >= 0.01) {
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoConvenio(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoConvenio() + 0.01));
			}

			valorTotalDescontos = Uteis.arrendondarForcando2CadasDecimais(valorTotalDescontos + 0.01);
		}
		if ((diferencaValorTotalDescontosTotalConta < 0) && (diferencaValorTotalDescontosTotalConta >= -0.01)) {
			// Se o desconto ficou 0.01 maior que o valor da conta, então o
			// sistema irá arrendondar o desconto
			// para termos o 100%, deduzindo o mesmo -0.01. Para isto o sistema
			// irá lançar esta difereça em um
			// dos descontos existentes verificando qual tem valor para ser deduzido.
			// Pedro Andrade 03/07/2018
			if (Uteis.isAtributoPreenchido(planoComValoresCalculadosParaDataEspecifica.getValorDescontoInstituicao()) && planoComValoresCalculadosParaDataEspecifica.getValorDescontoInstituicao() >= 0.01) {
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoInstituicao(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoInstituicao() + diferencaValorTotalDescontosTotalConta));
			} else if (Uteis.isAtributoPreenchido(planoComValoresCalculadosParaDataEspecifica.getValorDescontoAluno()) && planoComValoresCalculadosParaDataEspecifica.getValorDescontoAluno() >= 0.01) {
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoAluno(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoAluno() + diferencaValorTotalDescontosTotalConta));
			} else if (Uteis.isAtributoPreenchido(planoComValoresCalculadosParaDataEspecifica.getValorDescontoRateio()) && planoComValoresCalculadosParaDataEspecifica.getValorDescontoRateio() >= 0.01) {
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoAluno(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoRateio() + diferencaValorTotalDescontosTotalConta));
			} else if (Uteis.isAtributoPreenchido(planoComValoresCalculadosParaDataEspecifica.getValorDescontoProgressivo()) && planoComValoresCalculadosParaDataEspecifica.getValorDescontoProgressivo() >= 0.01) {
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoProgressivo(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoProgressivo() + diferencaValorTotalDescontosTotalConta));
			} else if (Uteis.isAtributoPreenchido(planoComValoresCalculadosParaDataEspecifica.getValorDescontoConvenio()) && planoComValoresCalculadosParaDataEspecifica.getValorDescontoConvenio() >= 0.01) {
				planoComValoresCalculadosParaDataEspecifica.setValorDescontoConvenio(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorDescontoConvenio() + diferencaValorTotalDescontosTotalConta));
			}
			valorTotalDescontos = Uteis.arrendondarForcando2CadasDecimais(valorTotalDescontos + diferencaValorTotalDescontosTotalConta);
		}
		// if
		// (valorTotalDescontos.equals(planoComValoresCalculadosParaDataEspecifica.getValorBase()
		// + 0.01)) {
		// planoComValoresCalculadosParaDataEspecifica.setValorDescontoInstituicao(Uteis.arredondar((planoComValoresCalculadosParaDataEspecifica.getValorDescontoInstituicao()
		// - 0.01), 2, 0));
		// valorTotal = valorTotal - 0.01;
		// }
		if (valorTotalDescontos > 0 && valorTotalDescontos > Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorBase())) {
			planoComValoresCalculadosParaDataEspecifica.setValorDescontoAluno(0.0);
			planoComValoresCalculadosParaDataEspecifica.setValorDescontoConvenio(0.0);
			planoComValoresCalculadosParaDataEspecifica.setValorDescontoInstituicao(0.0);
			throw new ConsistirException("A soma dos descontos é maior que o valor da Matrícula ou Parcela (" + matricula + ")." , true);
		}
		// TODO Alberto Correção ordem dos descontos
		if (valorTotalDescontos.equals(planoComValoresCalculadosParaDataEspecifica.getValorBase())) {
			planoComValoresCalculadosParaDataEspecifica.setDescontoCemPorCento(true);
		}
	}

	public void calcularDescontoProgressivo(Boolean valorCheio, List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosAplicaviesMesmoNrDiasAntesVcto, PlanoFinanceiroAlunoDescricaoDescontosVO planoComValoresCalculadosParaDataEspecifica, Boolean aplicarCalculoComBaseDescontosCalculados, boolean isCalcularValoresFaixaDesconto, DescontoProgressivoVO descontoProgressivoVO) {
		Double valorBaseCalculoUtilizar = 0.0;
		if (valorCheio) {
			valorBaseCalculoUtilizar = planoComValoresCalculadosParaDataEspecifica.getValorBase();
		} else {
			valorBaseCalculoUtilizar = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();
			// - planoComValoresCalculadosParaDataEspecifica.getValorCusteadoContaReceber();
		}

		if (valorBaseCalculoUtilizar.doubleValue() <= 0) {
			// Uma vez que tenho uma base de calculo do próximo desconto zerada,
			// o que pode ocorrer quando
			// os descontos anteriormente aplicados são superiores ao valor da
			// conta a receber, então já
			// temos que assimir o desconto progressivo como zero, pois não
			// existe como aplicá-lo, mais
			planoComValoresCalculadosParaDataEspecifica.setValorDescontoProgressivo(0.0);
			return;
		}

		PlanoFinanceiroAlunoDescricaoDescontosVO planoAplicarParaProgressivo = null;
		for (PlanoFinanceiroAlunoDescricaoDescontosVO obj : listaDescontosAplicaviesMesmoNrDiasAntesVcto) {
			if (obj.getTipoOrigemDesconto().equals("DescontoProgressivo")) {
				planoAplicarParaProgressivo = obj;
				break;
			}
		}

		if (planoAplicarParaProgressivo == null) {
			// nao existe nenhum desconto progressivo determinado para o dia,
			// logo podemos sair desta rotirna
			return;
		}
		planoComValoresCalculadosParaDataEspecifica.setIndicadorDescontoProgressivo(planoAplicarParaProgressivo.getIndicadorDescontoProgressivo());
		planoComValoresCalculadosParaDataEspecifica.setPercentualDescontoProgressivo(planoAplicarParaProgressivo.getPercentualDescontoProgressivo());
		Double descontoProgressivoASerAplicado = 0.0;
		// TODO Alberto 08/12/10 acrescentado valor fixo desconto progressivo
		if (planoAplicarParaProgressivo.getDescontoProgressivoVO().getIsUsarValorFixo()) {
			Date dataBaseValidade = null;
			descontoProgressivoASerAplicado = Uteis.arrendondarForcando2CadasDecimais(planoAplicarParaProgressivo.getValorFixoDescontoProgressivo());

			// Se o desconto progressivo está sendo dado em valor e não em
			// percentual, temos que verificar se o mesmo é maior que
			// o valorRestanteDaContaAReceber (já descontados outros possíveis
			// descontos - como convenio, instituicao - dada a ordem
			// de aplicacao dos mesmos.
			if (descontoProgressivoASerAplicado > planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados()) {
				// O desconto progressivo é maior que o valor que resta na conta
				// receber, já aplicados outros descontos
				// então definimos que o maximo que o valor do desconto do aluno
				// pode assumir é próprio valor restante da conta
				// armazenado em
				// planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados().
				// Caso contrário
				// o valor do desconto seria maior que o valor da conta a
				// receber.
				descontoProgressivoASerAplicado = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();
			}

			dataBaseValidade = planoComValoresCalculadosParaDataEspecifica.getVencimentoDescontoProgressivoDiaUtil() ? planoComValoresCalculadosParaDataEspecifica.getDataLimiteAplicacaoDesconto() : planoAplicarParaProgressivo.getDataLimiteAplicacaoDesconto();
			if(isCalcularValoresFaixaDesconto){
				if (descontoProgressivoVO.getValorDescontoLimite1().equals(planoAplicarParaProgressivo.getValorFixoDescontoProgressivo())) {
					descontoProgressivoVO.setDataBaseValidade1(dataBaseValidade);
					descontoProgressivoVO.setValorBaseCalculo1(valorBaseCalculoUtilizar);
					descontoProgressivoVO.setValorDescontoCalculado1(descontoProgressivoASerAplicado);
				} else if (descontoProgressivoVO.getValorDescontoLimite2().equals(planoAplicarParaProgressivo.getValorFixoDescontoProgressivo())) {
					descontoProgressivoVO.setDataBaseValidade2(dataBaseValidade);
					descontoProgressivoVO.setValorBaseCalculo2(valorBaseCalculoUtilizar);
					descontoProgressivoVO.setValorDescontoCalculado2(descontoProgressivoASerAplicado);
				} else if (descontoProgressivoVO.getValorDescontoLimite3().equals(planoAplicarParaProgressivo.getValorFixoDescontoProgressivo())) {
					descontoProgressivoVO.setDataBaseValidade3(dataBaseValidade);
					descontoProgressivoVO.setValorBaseCalculo3(valorBaseCalculoUtilizar);
					descontoProgressivoVO.setValorDescontoCalculado3(descontoProgressivoASerAplicado);
				} else if (descontoProgressivoVO.getValorDescontoLimite4().equals(planoAplicarParaProgressivo.getValorFixoDescontoProgressivo())) {
					descontoProgressivoVO.setDataBaseValidade4(dataBaseValidade);
					descontoProgressivoVO.setValorBaseCalculo4(valorBaseCalculoUtilizar);
					descontoProgressivoVO.setValorDescontoCalculado4(descontoProgressivoASerAplicado);
				}	
			}
			
		} else {
			descontoProgressivoASerAplicado = Uteis.arrendondarForcando2CadasDecimais((planoAplicarParaProgressivo.getPercentualDescontoProgressivo() / 100) * valorBaseCalculoUtilizar);
			if(isCalcularValoresFaixaDesconto){
				if (descontoProgressivoVO.getPercDescontoLimite1().equals(planoAplicarParaProgressivo.getPercentualDescontoProgressivo())) {
					descontoProgressivoVO.setDataBaseValidade1(planoComValoresCalculadosParaDataEspecifica.getDataLimiteAplicacaoDesconto());
					descontoProgressivoVO.setValorBaseCalculo1(valorBaseCalculoUtilizar);
					descontoProgressivoVO.setValorDescontoCalculado1(descontoProgressivoASerAplicado);
				} else if (descontoProgressivoVO.getPercDescontoLimite2().equals(planoAplicarParaProgressivo.getPercentualDescontoProgressivo())) {
					descontoProgressivoVO.setDataBaseValidade2(planoComValoresCalculadosParaDataEspecifica.getDataLimiteAplicacaoDesconto());
					descontoProgressivoVO.setValorBaseCalculo2(valorBaseCalculoUtilizar);
					descontoProgressivoVO.setValorDescontoCalculado2(descontoProgressivoASerAplicado);
				} else if (descontoProgressivoVO.getPercDescontoLimite3().equals(planoAplicarParaProgressivo.getPercentualDescontoProgressivo())) {
					descontoProgressivoVO.setDataBaseValidade3(planoComValoresCalculadosParaDataEspecifica.getDataLimiteAplicacaoDesconto());
					descontoProgressivoVO.setValorBaseCalculo3(valorBaseCalculoUtilizar);
					descontoProgressivoVO.setValorDescontoCalculado3(descontoProgressivoASerAplicado);
				} else if (descontoProgressivoVO.getPercDescontoLimite4().equals(planoAplicarParaProgressivo.getPercentualDescontoProgressivo())) {
					descontoProgressivoVO.setDataBaseValidade4(planoComValoresCalculadosParaDataEspecifica.getDataLimiteAplicacaoDesconto());
					descontoProgressivoVO.setValorBaseCalculo4(valorBaseCalculoUtilizar);
					descontoProgressivoVO.setValorDescontoCalculado4(descontoProgressivoASerAplicado);
				}
			}
		}
		// TODO Alberto 08/12/10 acrescentado valor fixo desconto progressivo
		planoComValoresCalculadosParaDataEspecifica.setValorDescontoProgressivo(descontoProgressivoASerAplicado);
		if (descontoProgressivoASerAplicado > 0) {
			planoComValoresCalculadosParaDataEspecifica.setDescontoProgressivoVO(planoAplicarParaProgressivo.getDescontoProgressivoVO());
		}

		planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados() - descontoProgressivoASerAplicado));
		planoComValoresCalculadosParaDataEspecifica.setValorDescontoComValidade(planoComValoresCalculadosParaDataEspecifica.getValorDescontoComValidade() + descontoProgressivoASerAplicado);

	}

	public void calcularDescontoPlanoDesconto(Boolean valorCheio, List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosAplicaviesMesmoNrDiasAntesVcto, Boolean parcelaReferenteMatricula, PlanoFinanceiroAlunoDescricaoDescontosVO planoComValoresCalculadosParaDataEspecifica, Boolean usaDescontoCompostoPlanoDesconto, Boolean aplicarCalculoComBaseDescontosCalculados, Boolean usarDescontoApenasCalculoComBaseDescontosCalculados, Integer ordemAplicacaoPlanoDescontoBase) throws Exception {

		// Esta variável irá guardar o valor base de cálculo já aplicado outros
		// descontos
		// (como progressivo, convenio, do próprio), caso estes estejam
		// configurados para serem
		// calculados antes dos descontos do Plano de Desconto. Ela é
		// importante, pois registra
		// o valor base de cálculo inicial para os Planos de Descontos. Caso um
		// plano de desconto
		// esteja configurado para NÃO ser calculado sobre o valor cheio e NÃO
		// ser calculado
		// sobre o valor base deduzido do valor dos outros planos (quando um
		// plano reduz a base do outro)
		// então o mesmo utilizará esta base de cálculo. Ver exemplo B: no
		// javaDoc PlanoDescontoVO.
		Double valorBaseCalculoUtilizarSemDeducaoOutrosPlanosDesconto = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();

		Double valorBaseValorCheio = planoComValoresCalculadosParaDataEspecifica.getValorBase();

		// Esta variável irá armazenar o valor da conta a receber já deduzidos
		// de outros descontos (progessivo,
		// convenios) que pela ordem de cálculo, já foram calculados.
		// Adicionalmente, a mesma irá sendo atualizada
		// sempre que um plano de desconto for calculado. Ou seja, a mesma irá
		// refletir o valor da conta a receber
		// com todos os descontos aplicados (anterior ao plano de desconto
		// (progressvio, convenio, etc) e também os
		// os descontos de cada plano, conforme a ordem de execução dos mesmos).
		// É caso descrito no exemplo C:
		// javaDoc PlanoDescontoVO.
		Double valorBaseComDeducoesOutrosDescontosCalculados = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();

		// Variável responsável por totalizar todos os descontos dos planos, de
		// forma que possamos
		// ter o total de todos os descontos somados, para que esta informação
		// seja registrada na conta a receber.
		Double valorDescontoInstituicaoASerAplicado = 0.0;

		// Esta ordenação é importante para que possamos determinar a ordem
		// correta de aplicação dos descontos.
		// A ordenação é feita por meio da variável OrdemPrioridadeCalculo que
		// determina qual plano de desconto
		// deve ser calculado primeio, e qual deverá ser calculado
		// posteriormente. Lembrando que a ordem pode
		// resultar em valores de descontos diferentes. Já que um desconto pode
		// ser deduzido da base de calculo
		// do próximo desconto.
		Ordenacao.ordenarLista(listaDescontosAplicaviesMesmoNrDiasAntesVcto, "codigoPlanoDesconto");
		Collections.sort(listaDescontosAplicaviesMesmoNrDiasAntesVcto);

		for (PlanoFinanceiroAlunoDescricaoDescontosVO obj : listaDescontosAplicaviesMesmoNrDiasAntesVcto) {
			if (obj.getTipoOrigemDesconto().equals("PlanoDesconto")) {
				// Abaixo determina-se a base de calculo do plano de desconto,
				// conforme as possibilidades
				// descritas no javaDoc PlanoDescontoVO - ver ExemploA, ExemploB
				// e ExemploC
				Double valorBaseCalculoUtilizar = 0.0;
				if (usarDescontoApenasCalculoComBaseDescontosCalculados && ordemAplicacaoPlanoDescontoBase != null
						&& Uteis.isAtributoPreenchido(obj.getPlanoDescontoVO())
						&& obj.getPlanoDescontoVO().getOrdemPrioridadeParaCalculo() > ordemAplicacaoPlanoDescontoBase) {
					continue;
				}
				if (obj.getPlanoDescontoVO().getConsiderarApenasCalculoComBaseDescontosCalculados() && !usarDescontoApenasCalculoComBaseDescontosCalculados) {
					continue;
				}
				if (obj.getPlanoDescontoVO().getAplicarSobreValorCheio() || valorCheio) {
					valorBaseCalculoUtilizar = valorBaseValorCheio;
				} else {
					if (!obj.getPlanoDescontoVO().getAplicarSobreValorBaseDeduzidoValorOutrosPlanosDesconto()) {
						// Exemplo B
						valorBaseCalculoUtilizar = valorBaseCalculoUtilizarSemDeducaoOutrosPlanosDesconto;
					} else {
						// Exemplo C
						valorBaseCalculoUtilizar = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();
					}
				}

				Double valorDescAplicar = 0.0;
				if (valorBaseCalculoUtilizar.doubleValue() > 0) {
					// Sé entra para processar o plano de desconto se existe um
					// base para que o mesmo seja aplicado/calculado

					if (parcelaReferenteMatricula) {
						if (obj.getPlanoDescontoVO().getTipoDescontoMatricula().equals("VA")) {
							valorDescAplicar = Uteis.arrendondarForcando2CadasDecimais(obj.getPlanoDescontoVO().getPercDescontoMatricula());
						} else {
							valorDescAplicar = Uteis.arrendondarForcando2CadasDecimais((obj.getPlanoDescontoVO().getPercDescontoMatricula() / 100) * valorBaseCalculoUtilizar);
						}

						if (valorDescAplicar > planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados()) {
							// O desconto em valor para o convênio é maior que o
							// valor que resta na conta receber, já aplicados
							// outros descontos
							// então definimos que o máximo que o valor do
							// desconto do aluno pode assumir é próprio valor
							// restante da conta
							// armazenado em
							// planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados().
							// Caso contrário
							// o valor do desconto seria maior que o valor da
							// conta a receber.
							valorDescAplicar = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();
						}

					} else {
						if (obj.getPlanoDescontoVO().getTipoDescontoParcela().equals("VA")) {
							valorDescAplicar = Uteis.arrendondarForcando2CadasDecimais(obj.getPlanoDescontoVO().getPercDescontoParcela());
						} else {
							valorDescAplicar = Uteis.arrendondarForcando2CadasDecimais((obj.getPlanoDescontoVO().getPercDescontoParcela() / 100) * valorBaseCalculoUtilizar);
						}

						if (valorDescAplicar > planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados()) {
							// O desconto em valor para o convênio é maior que o
							// valor que resta na conta receber, já aplicados
							// outros descontos
							// então definimos que o máximo que o valor do
							// desconto do aluno pode assumir é próprio valor
							// restante da conta
							// armazenado em
							// planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados().
							// Caso contrário
							// o valor do desconto seria maior que o valor da
							// conta a receber.
							valorDescAplicar = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();
						}
					}
				}
				valorDescontoInstituicaoASerAplicado = Uteis.arrendondarForcando2CadasDecimais(valorDescontoInstituicaoASerAplicado + valorDescAplicar);
				planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados() - valorDescAplicar));
				valorBaseComDeducoesOutrosDescontosCalculados = Uteis.arrendondarForcando2CadasDecimais(valorBaseComDeducoesOutrosDescontosCalculados - valorDescAplicar);
				// Adiciona em um HashMap o código do plano de desconto e o
				// valor a ser aplicado, para que em métodos posteriores,
				// termos a informação de quanto de desconto de plano(s) de
				// desconto o aluno recebeu.
				if (!usarDescontoApenasCalculoComBaseDescontosCalculados) {
					planoComValoresCalculadosParaDataEspecifica.getListaDescontosPlanoDesconto().put(obj.getPlanoDescontoVO().getCodigo(), valorDescAplicar);
				}
				if (!usarDescontoApenasCalculoComBaseDescontosCalculados) {
					if (obj.getPlanoDescontoVO().getDescontoValidoAteDataVencimento() || ((obj.getPlanoDescontoVO().getUtilizarDiaFixo() || obj.getPlanoDescontoVO().getUtilizarDiaUtil() || obj.getPlanoDescontoVO().getUtilizarDiasAntesVctoPadrao()) && obj.getPlanoDescontoVO().getDiasValidadeVencimento() > 0)) {
						planoComValoresCalculadosParaDataEspecifica.setValorDescontoComValidade(planoComValoresCalculadosParaDataEspecifica.getValorDescontoComValidade() + valorDescAplicar);
					} else {
						planoComValoresCalculadosParaDataEspecifica.setValorDescontoSemValidade(planoComValoresCalculadosParaDataEspecifica.getValorDescontoSemValidade() + valorDescAplicar);
					}
				}

			}
		}
		planoComValoresCalculadosParaDataEspecifica.setValorDescontoInstituicao(valorDescontoInstituicaoASerAplicado);
	}

	public void calcularDescontoConvenio(Boolean valorCheio, List<ConvenioVO> listaConveniosAluno, List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosAplicaviesMesmoNrDiasAntesVcto, Boolean parcelaReferenteMatricula, PlanoFinanceiroAlunoDescricaoDescontosVO planoComValoresCalculadosParaDataEspecifica, Boolean aplicarCalculoComBaseDescontosCalculados) throws Exception {
		// Double valorBaseCalculoUtilizar = 0.0;
		// if (valorCheio) {
		// valorBaseCalculoUtilizar =
		// planoComValoresCalculadosParaDataEspecifica.getValorBase();
		// } else {
		// valorBaseCalculoUtilizar =
		// planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados()
		// -
		// planoComValoresCalculadosParaDataEspecifica.getValorCusteadoContaReceber();
		// }
		//
		//
		// if (valorBaseCalculoUtilizar.doubleValue() <= 0) {
		// // Uma vez que tenho uma base de calculo do próximo desconto zerada,
		// o que pode ocorrer quando
		// // os descontos anteriormente aplicados são superiores ao valor da
		// conta a receber, então já
		// // temos que assimir o desconto do alnuo como zero, pois não existe
		// como aplicá-lo, mais
		// planoComValoresCalculadosParaDataEspecifica.setValorDescontoConvenio(0.0);
		// return;
		// }

		// Esta variável irá guardar o valor base de cálculo já aplicado outros
		// descontos
		// (como progressivo, plano desconto, do próprio), caso estes estejam
		// configurados para serem
		// calculados antes dos convênios. Ela é importante, pois registra
		// o valor base de cálculo inicial para os Convênios. Caso um convênio
		// esteja configurado para NÃO ser calculado sobre o valor cheio e NÃO
		// ser calculado
		// sobre o valor base deduzido do valor dos outros convênios (quando um
		// convênio reduz a base do outro)
		// então o mesmo utilizará esta base de cálculo. Ver exemplo B: no
		// javaDoc PlanoDescontoVO - funcionamento é idêntico para convênio
		Double valorBaseCalculoUtilizarSemDeducaoOutrosConvenios = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();

		Double valorBaseValorCheio = planoComValoresCalculadosParaDataEspecifica.getValorBase();

		// Esta variável irá armazenar o valor da conta a receber já deduzidos
		// de outros descontos (progessivo,
		// plano de desconto) que pela ordem de cálculo, já foram calculados.
		// Adicionalmente, a mesma irá sendo atualizada
		// sempre que um convênio for calculado. Ou seja, a mesma irá refletir o
		// valor da conta a receber
		// com todos os descontos aplicados (anterior ao convenio (progressvio,
		// plano desconto, etc) e também os
		// os descontos de cada convenio, conforme a ordem de execução dos
		// mesmos). É caso descrito no exemplo C:
		// javaDoc PlanoDescontoVO - apesar de descrito no javaDoc
		// PlanoDescontoVO é identico para convênio
		Double valorBaseComDeducoesOutrosConveniosCalculados = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();

		// Variável responsável por totalizar todos os descontos dos convenios,
		// de forma que possamos
		// ter o total de todos os convenios somados, para que esta informação
		// seja registrada na conta a receber.
		Double valorDescontoConvenioASerAplicado = 0.0;

		//
		Double valorTotalCusteadoContaReceberTodosConvenios = 0.0;

		// Esta ordenação é importante para que possamos determinar a ordem
		// correta de aplicação dos convenios.
		// A ordenação é feita por meio da variável OrdemPrioridadeCalculo que
		// determina qual convenio
		// deve ser calculado primeio, e qual deverá ser calculado
		// posteriormente. Lembrando que a ordem pode
		// resultar em valores de convenios diferentes. Já que um convenio pode
		// ser deduzido da base de calculo
		// do próximo.
		Collections.sort(listaConveniosAluno);

		for (ConvenioVO convenio : listaConveniosAluno) {
			Double valorBaseCalculoUtilizar = 0.0;
			if (convenio.getAplicarSobreValorCheio() || valorCheio) {
				valorBaseCalculoUtilizar = valorBaseValorCheio;
			} else {
				if (!convenio.getAplicarSobreValorBaseDeduzidoValorOutrosConvenios()) {
					// Exemplo B
					valorBaseCalculoUtilizar = valorBaseCalculoUtilizarSemDeducaoOutrosConvenios;
				} else {
					// Exemplo C
					valorBaseCalculoUtilizar = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();
				}
			}

			Double valorDescontoConvenio = 0.0;
			if (parcelaReferenteMatricula) {
				if (convenio.getTipoDescontoMatricula().equals("VA")) {
					valorDescontoConvenio = convenio.getDescontoMatricula();
				} else {
					valorDescontoConvenio = ((valorBaseCalculoUtilizar * convenio.getDescontoMatricula()) / 100.0);
				}
				if (valorDescontoConvenio > planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados()) {
					// O desconto em valor para o convênio é maior que o valor
					// que resta na conta receber, já aplicados outros descontos
					// então definimos que o máximo que o valor do desconto do
					// aluno pode assumir é próprio valor restante da conta
					// armazenado em
					// planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados().
					// Caso contrário
					// o valor do desconto seria maior que o valor da conta a
					// receber.
					valorDescontoConvenio = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();
				}
			} else {
				if (convenio.getTipoDescontoParcela().equals("VA")) {
					valorDescontoConvenio = convenio.getDescontoParcela();
				} else {
					valorDescontoConvenio = ((valorBaseCalculoUtilizar * convenio.getDescontoParcela()) / 100.0);
				}
				if (valorDescontoConvenio > planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados()) {
					// O desconto em valor para o convênio é maior que o valor
					// que resta na conta receber, já aplicados outros descontos
					// então definimos que o máximo que o valor do desconto do
					// aluno pode assumir é próprio valor restante da conta
					// armazenado em
					// planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados().
					// Caso contrário
					// o valor do desconto seria maior que o valor da conta a
					// receber.
					valorDescontoConvenio = planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados();
				}
			}
			if (((parcelaReferenteMatricula) && (convenio.getAbaterDescontoNoValorMatricula())) || ((!parcelaReferenteMatricula) && (convenio.getAbaterDescontoNoValorParcela()))) {
				// Neste caso temos que abater o valor do convênio no valor da
				// parcela. Pois trata-se de um convenio
				// que não será tratado como desconto, mas sim como redução do
				// valor base da parcela. Por exmeplo: se a
				// parcela é de R$ 800,00 e o convênio for R$ 300,00 então a
				// parcela, quando gravada deverá ser gravada
				// com R$ 500,0. E o valor de R$ 300,00 não poderá ser computado
				// como um desconto. Quando o convenio
				// não é marcado para abater no valor da parcela, que o valor
				// pago pela conveniada deverá ser tratada como
				// desconto. Estamos totalizando na variável abaixo todos os convenios
				// e depois setamos este total calculado na em planoComValoresCalculadosParaDataEspecifica.valorCusteadoContaReceber
				valorTotalCusteadoContaReceberTodosConvenios = Uteis.arrendondarForcando2CadasDecimais(valorTotalCusteadoContaReceberTodosConvenios + valorDescontoConvenio);
			} else {
				// aqui segue o comportamento anterior, no qual a parcela será
				// gravada com R$ 800,00 e os R$ 300,00 do convênio
				// serão armazenados como desconto.
				valorDescontoConvenioASerAplicado = Uteis.arrendondarForcando2CadasDecimais(valorDescontoConvenioASerAplicado + valorDescontoConvenio);
			}
			planoComValoresCalculadosParaDataEspecifica.setValorBaseComDescontosJaCalculadosAplicados(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorBaseComDescontosJaCalculadosAplicados() - valorDescontoConvenio));
			valorBaseComDeducoesOutrosConveniosCalculados = Uteis.arrendondarForcando2CadasDecimais(valorBaseComDeducoesOutrosConveniosCalculados - valorDescontoConvenio);
			// Adiciona em um HashMap o código do convênio e o valor
			// correspondente para em métodos posteriores,
			// termos a informação de quanto de desconto de convênio(s) o aluno
			// recebeu.
			planoComValoresCalculadosParaDataEspecifica.getListaDescontosConvenio().put(convenio.getCodigo(), valorDescontoConvenio);
		}
		planoComValoresCalculadosParaDataEspecifica.setValorCusteadoContaReceber(Uteis.arrendondarForcando2CadasDecimais(planoComValoresCalculadosParaDataEspecifica.getValorCusteadoContaReceber() + valorTotalCusteadoContaReceberTodosConvenios));

		planoComValoresCalculadosParaDataEspecifica.setValorDescontoConvenio(valorDescontoConvenioASerAplicado);
		planoComValoresCalculadosParaDataEspecifica.setValorDescontoSemValidade(planoComValoresCalculadosParaDataEspecifica.getValorDescontoSemValidade() + valorDescontoConvenioASerAplicado + valorTotalCusteadoContaReceberTodosConvenios);
	}

	private void ordenarListaDescontoDeAcordoComNrDiasAntesVcto(List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontos) {
		Ordenacao.ordenarLista(listaDescontos, "codigoPlanoDesconto");
		Ordenacao.ordenarLista(listaDescontos, "diaNrAntesVencimentoParaOrdenacao");
	}

	// TODO Alberto 08/12/10 acrescentado valor fixo desconto progressivo
	private void inicializarListaDescontosComDescontoProgressivo(List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontos, Date dataBaseVencimento, Date dataOriginalVencimento, DescontoProgressivoVO descontoProgressivoVO) throws Exception {
		if ((descontoProgressivoVO == null) || (descontoProgressivoVO.getCodigo().equals(0))) {
			return;
		}
		Integer diaLimite1 = descontoProgressivoVO.getDiaLimite1();

		if (descontoProgressivoVO.getDescontoProgressivoEditadoManualmenteContaReceber()) {
			// se o desconto progressivo foi editado manualmente na conta a receber, nao podemos recarregar os
			// dados do mesmo do banco de dados. Temos que utilizar o desconto progressivo fornecido como parametro
			// pois o mesmo já estará com as alteraões feitas na conta a receber refletidas no mesmo.
		} else if(descontoProgressivoVO.getNivelMontarDados() == null || !descontoProgressivoVO.getNivelMontarDados().equals(NivelMontarDados.TODOS)){
			
			descontoProgressivoVO = getFacadeFactory().getDescontoProgressivoFacade().consultarPorChavePrimaria(descontoProgressivoVO.getCodigo(), null);
		}

		if ((descontoProgressivoVO.getDiaLimite1() != null) && ((descontoProgressivoVO.getPercDescontoLimite1() != null && descontoProgressivoVO.getPercDescontoLimite1() > 0) || (descontoProgressivoVO.getValorDescontoLimite1() != null && descontoProgressivoVO.getValorDescontoLimite1() > 0)) // &&
		// (!descontoProgressivoVO.getDiaLimite1().equals(0))
		// --
		// Comentado
		// para permitir que o Desconto Progressivo seja valido até a data de
		// vencimento da conta
		) {
			PlanoFinanceiroAlunoDescricaoDescontosVO desc1 = new PlanoFinanceiroAlunoDescricaoDescontosVO();

			// Pode ser apicado de uma data indeterminada do passado até a data
			// limite 1
			if (descontoProgressivoVO.getNrDiasAntesVcto()) {
				desc1.setDiaNrAntesVencimentoDescontoComecaASerAplicado(Integer.MAX_VALUE);
				desc1.setDiaNrAntesVencimento(descontoProgressivoVO.getDiaLimite1());
			} else if (descontoProgressivoVO.getUtilizarDiaFixo()) {
				// Se entrar aqui é por que utiliza
				// dias fixos pré-determinados para dar o desconto progressivo
				// ao aluno,
				// exemplo: até dia 05 x% desc, até 10 xx% de desc, ....
				Calendar c = Calendar.getInstance();
				c.setTime(dataBaseVencimento);
				c.set(Calendar.DAY_OF_MONTH, c.getActualMaximum(Calendar.DAY_OF_MONTH));
				if (descontoProgressivoVO.getDiaLimite1() > c.getActualMaximum(Calendar.DAY_OF_MONTH)) {
					descontoProgressivoVO.setDiaLimite1(c.getActualMaximum(Calendar.DAY_OF_MONTH));
				}
				Date dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite1(), dataBaseVencimento, 0);
				/**
				 * Adicionada regra devido ao vencimento não ser dia útil, o que acarretava na alteração da data de vencimento da contareceber para o primeiro dia útil próximo mês, ou seja, considerava o próximo mês para o cálculo do desconto progressivo.
				 */
				int diaBase = Uteis.getDiaMesData(dataBaseVencimento);
				if (diaBase < descontoProgressivoVO.getDiaLimite1()) {
					dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite1(), Uteis.obterDataAntigaPorMes(dataBaseVencimento, 1), 0);
				}
				
				desc1.setDataLimiteAplicacaoDesconto(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimiteAplicacao));
				//No dia 14/09/2018 foi adicionado o parametro do boolean true pois o desconto progressivo com dataBaseVencimento 31/10/2018 para dias fixo 5 estava sendo contabilizado no dia 6 e com a passagem do parametro foi corridigo. Pedro Andrade
				desc1.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDateHoraInicialDia(dataBaseVencimento), Uteis.getDateHoraInicialDia(dataLimiteAplicacao), true));
				desc1.setDiaNrAntesVencimentoDescontoComecaASerAplicado(Integer.MAX_VALUE);
			} else {
				// Se entrar aqui é por que utiliza dias útis (pré-fixados)
				// para dar o desconto progressivo ao aluno,
				// exemplo: até QUINTO DIA ÚTIL x% desc, ATÉ 10 DIA ÚTIL 10 xx%
				// de desc, ....
				// Date dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, descontoProgressivoVO.getDiaLimite1());
				// int x = 1;
				// while((Uteis.getData(dataLimiteAplicacao).equals(Uteis.getData(dataBaseVencimento)) && Uteis.getDiaMesData(dataLimiteAplicacao) < descontoProgressivoVO.getDiaLimite1()) || dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0){
				// dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(Uteis.obterDataAntigaPorMes(dataBaseVencimento, x), descontoProgressivoVO.getDiaLimite1());
				// x++;
				// }

				Date dataLimiteAplicacao = realizarCalculoDataLimiteAplicacaoDescontoConsiderandoDiaUtil(dataBaseVencimento, dataOriginalVencimento, descontoProgressivoVO.getDiaLimite1());
				desc1.setDataLimiteAplicacaoDesconto(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimiteAplicacao));
				desc1.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDateHoraFinalDia(dataBaseVencimento), Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimiteAplicacao), false));
				desc1.setDiaNrAntesVencimentoDescontoComecaASerAplicado(Integer.MAX_VALUE);
			}
			desc1.setPercentualDescontoProgressivo(descontoProgressivoVO.getPercDescontoLimite1());
			desc1.setValorFixoDescontoProgressivo(descontoProgressivoVO.getValorDescontoLimite1());
			desc1.setTipoOrigemDesconto("DescontoProgressivo");
			desc1.setDescontoProgressivoVO(descontoProgressivoVO);
			listaDescontos.add(desc1);
		}

		if ((descontoProgressivoVO.getDiaLimite2() != null) && ((descontoProgressivoVO.getPercDescontoLimite2() != null && descontoProgressivoVO.getPercDescontoLimite2() > 0) || (descontoProgressivoVO.getValorDescontoLimite2() != null && descontoProgressivoVO.getValorDescontoLimite2() > 0)) // &&
		// (!descontoProgressivoVO.getDiaLimite2().equals(0))
		) {
			PlanoFinanceiroAlunoDescricaoDescontosVO desc2 = new PlanoFinanceiroAlunoDescricaoDescontosVO();
			desc2.setTipoOrigemDesconto(PlanoFinanceiroAlunoDescricaoDescontosVO.TIPODESCONTOPROGRESSIVO);

			// Pode ser apicado de um dias apos o limite do desconto 1
			if (descontoProgressivoVO.getNrDiasAntesVcto()) {
				desc2.setDiaNrAntesVencimentoDescontoComecaASerAplicado(descontoProgressivoVO.getDiaLimite1() - 1);
				desc2.setDiaNrAntesVencimento(descontoProgressivoVO.getDiaLimite2());
			} else if (descontoProgressivoVO.getUtilizarDiaFixo()) {

				Date dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite2(), dataBaseVencimento, 0);
				int diaBase = Uteis.getDiaMesData(dataBaseVencimento);
				if (diaBase < descontoProgressivoVO.getDiaLimite2()) {
					dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite2(), Uteis.obterDataAntigaPorMes(dataBaseVencimento, 1), 0);
				}
				desc2.setDataLimiteAplicacaoDesconto(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimiteAplicacao));
				desc2.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDateHoraInicialDia(dataBaseVencimento), Uteis.getDateHoraInicialDia(dataLimiteAplicacao), true));

				Date dataLimite1Aplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite1(), dataBaseVencimento, 0);
				/**
				 * Adicionada regra devido ao vencimento não ser dia útil, o que acarretava na alteração da data de vencimento da contareceber para o primeiro dia útil próximo mês, ou seja, considerava o próximo mês para o cálculo do desconto progressivo.
				 */
				if (diaBase < descontoProgressivoVO.getDiaLimite1()) {
					dataLimite1Aplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite1(), Uteis.obterDataAntigaPorMes(dataBaseVencimento, 1), 0);
				}
				desc2.setDiaNrAntesVencimentoDescontoComecaASerAplicado(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDateHoraFinalDia(dataBaseVencimento), Uteis.getDateHoraFinalDia(dataLimite1Aplicacao)));
			} else {
				Date dataLimiteAplicacao = realizarCalculoDataLimiteAplicacaoDescontoConsiderandoDiaUtil(dataBaseVencimento, dataOriginalVencimento, descontoProgressivoVO.getDiaLimite2());
//				Date dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, descontoProgressivoVO.getDiaLimite2(), true);
//				int x = 1;
//				while ((Uteis.getData(dataLimiteAplicacao).equals(Uteis.getData(dataBaseVencimento)) && Uteis.getDiaMesData(dataLimiteAplicacao) < descontoProgressivoVO.getDiaLimite2()) || dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0) {
//					dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(Uteis.obterDataAntigaPorMes(dataBaseVencimento, x), descontoProgressivoVO.getDiaLimite2(), true);
//					x++;
//				}
				desc2.setDataLimiteAplicacaoDesconto(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimiteAplicacao));
				desc2.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataBaseVencimento), Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimiteAplicacao)));
				Date dataLimite1Aplicacao = realizarCalculoDataLimiteAplicacaoDescontoConsiderandoDiaUtil(dataBaseVencimento, dataOriginalVencimento, descontoProgressivoVO.getDiaLimite1());
				//Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, descontoProgressivoVO.getDiaLimite1(), true);
				desc2.setDiaNrAntesVencimentoDescontoComecaASerAplicado(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataBaseVencimento), Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimite1Aplicacao)) - 1);
			}
			desc2.setPercentualDescontoProgressivo(descontoProgressivoVO.getPercDescontoLimite2());
			desc2.setValorFixoDescontoProgressivo(descontoProgressivoVO.getValorDescontoLimite2());
			desc2.setTipoOrigemDesconto("DescontoProgressivo");
			desc2.setDescontoProgressivoVO(descontoProgressivoVO);
			listaDescontos.add(desc2);
		}

		if ((descontoProgressivoVO.getDiaLimite3() != null) && ((descontoProgressivoVO.getPercDescontoLimite3() != null && descontoProgressivoVO.getPercDescontoLimite3() > 0) || (descontoProgressivoVO.getValorDescontoLimite3() != null && descontoProgressivoVO.getValorDescontoLimite3() > 0)) // &&
		// (!descontoProgressivoVO.getDiaLimite3().equals(0))
		) {
			PlanoFinanceiroAlunoDescricaoDescontosVO desc3 = new PlanoFinanceiroAlunoDescricaoDescontosVO();

			// Pode ser apicado de um dias apos o limite do desconto 2
			if (descontoProgressivoVO.getNrDiasAntesVcto()) {
				desc3.setDiaNrAntesVencimentoDescontoComecaASerAplicado(descontoProgressivoVO.getDiaLimite2() - 1);
				desc3.setDiaNrAntesVencimento(descontoProgressivoVO.getDiaLimite3());
			} else if (descontoProgressivoVO.getUtilizarDiaFixo()) {
				Date dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite3(), dataBaseVencimento, 0);
				int diaBase = Uteis.getDiaMesData(dataBaseVencimento);
				/**
				 * Adicionada regra devido ao vencimento não ser dia útil, o que acarretava na alteração da data de vencimento da contareceber para o primeiro dia útil próximo mês, ou seja, considerava o próximo mês para o cálculo do desconto progressivo.
				 */
				if (diaBase < descontoProgressivoVO.getDiaLimite3()) {
					dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite3(), Uteis.obterDataAntigaPorMes(dataBaseVencimento, 1), 0);
				}
				desc3.setDataLimiteAplicacaoDesconto(dataLimiteAplicacao);
				desc3.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDateHoraInicialDia(dataBaseVencimento), Uteis.getDateHoraInicialDia(dataLimiteAplicacao), true));
				Date dataLimite2Aplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite2(), dataBaseVencimento, 0);
				/**
				 * Adicionada regra devido ao vencimento não ser dia útil, o que acarretava na alteração da data de vencimento da contareceber para o primeiro dia útil próximo mês, ou seja, considerava o próximo mês para o cálculo do desconto progressivo.
				 */
				if (diaBase < descontoProgressivoVO.getDiaLimite2()) {
					dataLimite2Aplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite2(), Uteis.obterDataAntigaPorMes(dataBaseVencimento, 1), 0);
				}
				desc3.setDiaNrAntesVencimentoDescontoComecaASerAplicado(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDateHoraFinalDia(dataBaseVencimento), Uteis.getDateHoraFinalDia(dataLimite2Aplicacao)));
			} else {
				Date dataLimiteAplicacao = realizarCalculoDataLimiteAplicacaoDescontoConsiderandoDiaUtil(dataBaseVencimento, dataOriginalVencimento, descontoProgressivoVO.getDiaLimite3());
//				Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, descontoProgressivoVO.getDiaLimite3(), true);
//				int x = 1;
//				while ((Uteis.getData(dataLimiteAplicacao).equals(Uteis.getData(dataBaseVencimento)) && Uteis.getDiaMesData(dataLimiteAplicacao) < descontoProgressivoVO.getDiaLimite3()) || dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0) {
//					dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(Uteis.obterDataAntigaPorMes(dataBaseVencimento, x), descontoProgressivoVO.getDiaLimite3(), true);
//					x++;
//				}
				desc3.setDataLimiteAplicacaoDesconto(dataLimiteAplicacao);
				desc3.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataBaseVencimento), dataLimiteAplicacao));
				Date dataLimite2Aplicacao = realizarCalculoDataLimiteAplicacaoDescontoConsiderandoDiaUtil(dataBaseVencimento, dataOriginalVencimento, descontoProgressivoVO.getDiaLimite2()); 
						//Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, descontoProgressivoVO.getDiaLimite2(), true);
				desc3.setDiaNrAntesVencimentoDescontoComecaASerAplicado(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataBaseVencimento), Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimite2Aplicacao)) - 1);
			}
			desc3.setPercentualDescontoProgressivo(descontoProgressivoVO.getPercDescontoLimite3());
			desc3.setValorFixoDescontoProgressivo(descontoProgressivoVO.getValorDescontoLimite3());
			desc3.setTipoOrigemDesconto("DescontoProgressivo");
			desc3.setDescontoProgressivoVO(descontoProgressivoVO);
			listaDescontos.add(desc3);
		}

		if ((descontoProgressivoVO.getDiaLimite4() != null) && ((descontoProgressivoVO.getPercDescontoLimite4() != null && descontoProgressivoVO.getPercDescontoLimite4() > 0) || (descontoProgressivoVO.getValorDescontoLimite4() != null && descontoProgressivoVO.getValorDescontoLimite4() > 0)) // &&
		// (!descontoProgressivoVO.getDiaLimite4().equals(0))
		) {
			PlanoFinanceiroAlunoDescricaoDescontosVO desc4 = new PlanoFinanceiroAlunoDescricaoDescontosVO();

			// Pode ser apicado de um dias apos o limite do desconto 4
			if (descontoProgressivoVO.getNrDiasAntesVcto()) {
				desc4.setDiaNrAntesVencimentoDescontoComecaASerAplicado(descontoProgressivoVO.getDiaLimite3() - 1);
				desc4.setDiaNrAntesVencimento(descontoProgressivoVO.getDiaLimite4());
			} else if (descontoProgressivoVO.getUtilizarDiaFixo()) {
				Date dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite4(), dataBaseVencimento, 0);
				int diaBase = Uteis.getDiaMesData(dataBaseVencimento);
				/**
				 * Adicionada regra devido ao vencimento não ser dia útil, o que acarretava na alteração da data de vencimento da contareceber para o primeiro dia útil próximo mês, ou seja, considerava o próximo mês para o cálculo do desconto progressivo.
				 */
				if (diaBase < descontoProgressivoVO.getDiaLimite4()) {
					dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite4(), Uteis.obterDataAntigaPorMes(dataBaseVencimento, 1), 0);
				}
				desc4.setDataLimiteAplicacaoDesconto(dataLimiteAplicacao);
				desc4.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDateHoraInicialDia(dataBaseVencimento), Uteis.getDateHoraInicialDia(dataLimiteAplicacao), true));
				Date dataLimite3Aplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite3(), dataBaseVencimento, 0);
				/**
				 * Adicionada regra devido ao vencimento não ser dia útil, o que acarretava na alteração da data de vencimento da contareceber para o primeiro dia útil próximo mês, ou seja, considerava o próximo mês para o cálculo do desconto progressivo.
				 */
				if (diaBase < descontoProgressivoVO.getDiaLimite3()) {
					dataLimite3Aplicacao = Uteis.getDataVencimentoPadrao(descontoProgressivoVO.getDiaLimite3(), Uteis.obterDataAntigaPorMes(dataBaseVencimento, 1), 0);
				}
				desc4.setDiaNrAntesVencimentoDescontoComecaASerAplicado(Uteis.getObterDiferencaDiasEntreDuasData(dataBaseVencimento, dataLimite3Aplicacao) - 1);
			} else {
				Date dataLimiteAplicacao = realizarCalculoDataLimiteAplicacaoDescontoConsiderandoDiaUtil(dataBaseVencimento, dataOriginalVencimento, descontoProgressivoVO.getDiaLimite4());
//						Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, descontoProgressivoVO.getDiaLimite4(), true);
//				int x = 1;
//				while ((Uteis.getData(dataLimiteAplicacao).equals(Uteis.getData(dataBaseVencimento)) && Uteis.getDiaMesData(dataLimiteAplicacao) < descontoProgressivoVO.getDiaLimite4()) || dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0) {
//					dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(Uteis.obterDataAntigaPorMes(dataBaseVencimento, x), descontoProgressivoVO.getDiaLimite4(), true);
//					x++;
//				}
				desc4.setDataLimiteAplicacaoDesconto(dataLimiteAplicacao);
				desc4.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataBaseVencimento), dataLimiteAplicacao));
				Date dataLimite3Aplicacao = realizarCalculoDataLimiteAplicacaoDescontoConsiderandoDiaUtil(dataBaseVencimento, dataOriginalVencimento, descontoProgressivoVO.getDiaLimite3());
						//Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, descontoProgressivoVO.getDiaLimite3(), true);
				desc4.setDiaNrAntesVencimentoDescontoComecaASerAplicado(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataBaseVencimento), dataLimite3Aplicacao) - 1);
			}
			desc4.setPercentualDescontoProgressivo(descontoProgressivoVO.getPercDescontoLimite4());
			desc4.setValorFixoDescontoProgressivo(descontoProgressivoVO.getValorDescontoLimite4());
			desc4.setTipoOrigemDesconto("DescontoProgressivo");
			desc4.setDescontoProgressivoVO(descontoProgressivoVO);
			listaDescontos.add(desc4);
		}
		descontoProgressivoVO.setDiaLimite1(diaLimite1);
	}
	// TODO Alberto 08/12/10 acrescentado valor fixo desconto progressivo

	private void inicializarListaDescontosComPlanoDescontoInstituicao(List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontos, Date dataBaseVencimento, Date dataOriginalVencimento, List<PlanoDescontoVO> listaPlanosDescontosAluno, Boolean parcelaReferenteMatricula, Boolean realizandoRecebimento, Date dataReferenciaConsiderarBaixaTitulo, Boolean vencimentoDescontoProgressivoDiaUtil, Integer cidade) throws Exception {
		if ((listaPlanosDescontosAluno == null) || (listaPlanosDescontosAluno.isEmpty())) {
			return;
		}
		if (parcelaReferenteMatricula == null) {
			parcelaReferenteMatricula = false;
		}
		for (PlanoDescontoVO planoDescontoAluno : listaPlanosDescontosAluno) {
			if (((parcelaReferenteMatricula && planoDescontoAluno.getPercDescontoMatricula() > 0) || (!parcelaReferenteMatricula && planoDescontoAluno.getPercDescontoParcela() > 0)) && deveAdicionarPlanoDesconto(planoDescontoAluno, dataBaseVencimento, dataOriginalVencimento, realizandoRecebimento, dataReferenciaConsiderarBaixaTitulo, vencimentoDescontoProgressivoDiaUtil, cidade)) {
				PlanoFinanceiroAlunoDescricaoDescontosVO desc1 = new PlanoFinanceiroAlunoDescricaoDescontosVO();
				desc1.setDiaNrAntesVencimentoDescontoComecaASerAplicado(Integer.MAX_VALUE);
				desc1.setTipoOrigemDesconto("PlanoDesconto");
				desc1.setPlanoDescontoVO(planoDescontoAluno);
				if (planoDescontoAluno.getDescontoValidoAteDataVencimento()) {
					desc1.setDiaNrAntesVencimento(0);
				} else if (planoDescontoAluno.getUtilizarDiaFixo()) {
					Date dataLimiteAplicacao = null;				
					if (!Uteis.getMesmoMesAno(dataBaseVencimento, dataOriginalVencimento)) {
						dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(planoDescontoAluno.getDiasValidadeVencimento(), dataOriginalVencimento, 0);				
					} else {
						dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(planoDescontoAluno.getDiasValidadeVencimento(), dataBaseVencimento, 0);
					}
					//Adicionado regra para caso a data limite aplicacadas seja em um dia nao util e esteja marcado para avancar o dia util do dia fixo.
					if(planoDescontoAluno.getUtilizarAvancoDiaUtil()){
						dataLimiteAplicacao = getFacadeFactory().getFeriadoFacade().obterDataFuturaProximoDiaUtil(dataLimiteAplicacao, cidade, false, false, ConsiderarFeriadoEnum.NENHUM, null);
					}
					//Aqui trata se a dataLimiteAplicacao não ultrapassa o vencimento da conta a receber caso ultrapasse o desconto ficará limitado ao vencimento da conta a receber
					if(dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0 ) {
						dataLimiteAplicacao = dataBaseVencimento;
						desc1.setDataLimiteAplicacaoDesconto(dataBaseVencimento);
					}else {
						desc1.setDataLimiteAplicacaoDesconto(dataLimiteAplicacao);
					}
					desc1.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDateHoraInicialDia(dataBaseVencimento), Uteis.getDateHoraInicialDia(dataLimiteAplicacao), true));
				} else if (planoDescontoAluno.getUtilizarDiaUtil()) {
					// TODO Verificar pois o mesmo não considera feriados, se descomentar o metodo abaixo irá considerar (Verificar linha 8221 pois lá usa este metodo) - Rodrigo Wind 10/06/15
					// Date dataLimiteAplicacao = obterDataLimitAplicacaoDescontosVerificandoDiaUtil(dataBaseVencimento, planoDescontoAluno.getDiasValidadeVencimento(), planoDescontoAluno.getDiasValidadeVencimento(), desc1, null);
					Date dataLimiteAplicacao = null;
					if (!Uteis.getMesmoMesAno(dataBaseVencimento, dataOriginalVencimento)) {
						dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataOriginalVencimento, planoDescontoAluno.getDiasValidadeVencimento(), true);
					} else {
						dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, planoDescontoAluno.getDiasValidadeVencimento(), true);
						int x = 1;
						while ((Uteis.getData(dataLimiteAplicacao).equals(Uteis.getData(dataBaseVencimento)) && Uteis.getDiaMesData(dataLimiteAplicacao) < planoDescontoAluno.getDiasValidadeVencimento()) || dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0) {
							dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(Uteis.obterDataAntigaPorMes(dataBaseVencimento, x), planoDescontoAluno.getDiasValidadeVencimento(), true);
							x++;
						}
					}
					desc1.setDataLimiteAplicacaoDesconto(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimiteAplicacao));
					desc1.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDateHoraFinalDia(dataBaseVencimento), Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimiteAplicacao), false));

				} else {
					if(planoDescontoAluno.getUtilizarAvancoDiaUtil() && planoDescontoAluno.getDiasValidadeVencimento()> 0){ 
						Date dataLimiteAplicacao =Uteis.obterDataPassada(dataBaseVencimento, (planoDescontoAluno.getDiasValidadeVencimento()-1));
						 dataLimiteAplicacao = getFacadeFactory().getFeriadoFacade().obterDataFuturaProximoDiaUtil(dataLimiteAplicacao, cidade, false, false, ConsiderarFeriadoEnum.NENHUM, null);
						 desc1.setDiaNrAntesVencimento(Uteis.getObterDiferencaDiasEntreDuasData(Uteis.getDateHoraInicialDia(dataBaseVencimento), Uteis.getDateHoraInicialDia(dataLimiteAplicacao), true));
						 desc1.setDataLimiteAplicacaoDesconto(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataLimiteAplicacao));
					 }else{
						 desc1.setDiaNrAntesVencimento(planoDescontoAluno.getDiasValidadeVencimento());	 
					 }
					
				}

				listaDescontos.add(desc1);
			}
			// Date dataLimiteAplicacao =
			// Uteis.obterDataPassada(dataBaseVencimento,
			// planoDescontoAluno.getDiasValidadeVencimento());
			// desc1.setDataLimiteAplicacaoDesconto(dataLimiteAplicacao);
			// desc1.setValorBase(valorBase);
			// desc1.setValorDescontoAluno(valorDescontoAluno);
			// desc1.setValorDescontoConvenio(valorDescontoConvenio);
			// desc1.setValorDescontoProgressivo(0.0);
			// Double valorDescontoInstituicaoCalculado = 0.0;
			// if (parcelaReferenteMatricula) {
			// processamento de matricula....
			// if (planoDescontoAluno.getTipoDescontoMatricula().equals("VE")) {
			// valorDescontoInstituicaoCalculado =
			// Uteis.arrendondarForcando2CadasDecimais(planoDescontoAluno.getPercDescontoMatricula());
			// } else {
			// valorDescontoInstituicaoCalculado =
			// Uteis.arrendondarForcando2CadasDecimais(valorBase *
			// (planoDescontoAluno.getPercDescontoMatricula() / 100));
			// }
			// } else {
			// processamento de mensalidade....
			// if (planoDescontoAluno.getTipoDescontoParcela().equals("VE")) {
			// valorDescontoInstituicaoCalculado =
			// Uteis.arrendondarForcando2CadasDecimais(planoDescontoAluno.getPercDescontoParcela());
			// } else {
			// valorDescontoInstituicaoCalculado =
			// Uteis.arrendondarForcando2CadasDecimais(valorBase *
			// (planoDescontoAluno.getPercDescontoParcela() / 100));
			// }
			// }
			// desc1.setValorDescontoInstituicao(valorDescontoInstituicaoCalculado);
			// desc1.setValorParaPagamentoDentroDataLimiteDesconto(desc1.executarCalculoValorParaPagamentoDentroDataLimiteDesconto());
		}
	}

	public Boolean deveAdicionarPlanoDesconto(PlanoDescontoVO planoDescontoVO, Date dataBaseVencimento, Date dataOriginalVencimento, Boolean realizandoRecebimento, Date dataReferenciaConsiderarBaixaTitulo, Boolean vencimentoDescontoProgressivoDiaUtil, Integer cidade) throws Exception {
		if (realizandoRecebimento) {
			if (planoDescontoVO.getConsiderarApenasCalculoComBaseDescontosCalculados()) {
				return true;
			}
			if (!planoDescontoVO.getDescontoValidoAteDataVencimento() && !planoDescontoVO.getUtilizarDiaFixo() && !planoDescontoVO.getUtilizarDiaUtil() && planoDescontoVO.getDiasValidadeVencimento().equals(0)) {
				return true;
			} else if (planoDescontoVO.getDataLimiteAplicarDesconto() != null) {
				if (Uteis.getDateSemHora(dataBaseVencimento).before(Uteis.getDateSemHora(planoDescontoVO.getDataLimiteAplicarDesconto()))) {
					return false;
				}
			} else if (planoDescontoVO.getDescontoValidoAteDataVencimento()) {
				if (dataReferenciaConsiderarBaixaTitulo == null && Uteis.getDateSemHora(dataBaseVencimento).before(Uteis.getDateSemHora(new Date()))) {
					return false;
				} else if (dataReferenciaConsiderarBaixaTitulo != null && Uteis.getDateSemHora(dataBaseVencimento).before(Uteis.getDateSemHora(dataReferenciaConsiderarBaixaTitulo))) {
					return false;
				}
			} else if (planoDescontoVO.getUtilizarDiaFixo() && !planoDescontoVO.getDiasValidadeVencimento().equals(0)) {
				Date dataLimiteAplicacao = null;
				if (!Uteis.getMesmoMesAno(dataBaseVencimento, dataOriginalVencimento)) {
					dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(planoDescontoVO.getDiasValidadeVencimento(), dataOriginalVencimento, 0);
				} else {
					dataLimiteAplicacao = Uteis.getDataVencimentoPadrao(planoDescontoVO.getDiasValidadeVencimento(), dataBaseVencimento, 0);
				}
				if(planoDescontoVO.getUtilizarAvancoDiaUtil()){
					dataLimiteAplicacao = getFacadeFactory().getFeriadoFacade().obterDataFuturaProximoDiaUtil(dataLimiteAplicacao, cidade, false, false, ConsiderarFeriadoEnum.NENHUM, null);
				}
				//Aqui trata se a dataLimiteAplicacao não ultrapassa o vencimento da conta a receber caso ultrapasse o desconto ficará limitado ao vencimento da conta a receber
				if(dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0 ) {
					dataLimiteAplicacao = dataBaseVencimento;						
				}
				planoDescontoVO.setDataLimiteAplicarDesconto(dataLimiteAplicacao);
				if (Uteis.getDateSemHora(dataBaseVencimento).before(Uteis.getDateSemHora(dataLimiteAplicacao))) {
					return false;
				}
			} else if (planoDescontoVO.getUtilizarDiaUtil() && !planoDescontoVO.getDiasValidadeVencimento().equals(0)) {
				Date dataLimiteAplicacao = null;
				if (!Uteis.getMesmoMesAno(dataBaseVencimento, dataOriginalVencimento)) {
					dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataOriginalVencimento, planoDescontoVO.getDiasValidadeVencimento(), true);
				} else {
					dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(dataBaseVencimento, planoDescontoVO.getDiasValidadeVencimento(), true);
					int x = 1;
					while ((Uteis.getData(dataLimiteAplicacao).equals(Uteis.getData(dataBaseVencimento)) && Uteis.getDiaMesData(dataLimiteAplicacao) < planoDescontoVO.getDiasValidadeVencimento()) || dataLimiteAplicacao.compareTo(dataBaseVencimento) > 0) {
						dataLimiteAplicacao = Uteis.getDataAvancandoNumeroEspecificoDiasUteisInicioMes(Uteis.obterDataAntigaPorMes(dataBaseVencimento, x), planoDescontoVO.getDiasValidadeVencimento(), true);
						x++;
					}
				}		
				planoDescontoVO.setDataLimiteAplicarDesconto(dataLimiteAplicacao);
				if (Uteis.getDateSemHora(dataBaseVencimento).before(Uteis.getDateSemHora(dataLimiteAplicacao))) {
					return false;
				}
			} else if (!planoDescontoVO.getDiasValidadeVencimento().equals(0)) {
				Date dataTemp = null;
				if (vencimentoDescontoProgressivoDiaUtil) {
					dataTemp = obterDataLimitAplicacaoDescontosVerificandoDiaUtil(dataBaseVencimento, planoDescontoVO.getDiasValidadeVencimento(), 0, null, cidade, null);
				} else {
					dataTemp = Uteis.getDateSemHora(Uteis.obterDataPassada(Uteis.getDateHoraFinalDia(dataBaseVencimento), planoDescontoVO.getDiasValidadeVencimento()));
				}
				if (dataReferenciaConsiderarBaixaTitulo != null) {
					if (Uteis.getDateSemHora(dataReferenciaConsiderarBaixaTitulo).after(dataTemp)) {
						return false;
					}
				} else if (dataTemp.before(Uteis.getDateSemHora(new Date()))) {
					return false;
				}
			}
			return true;
		}
		return true;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarVencimentoTurma(List<MatriculaPeriodoVencimentoVO> matriculaPeriodoVencimentoVOs, Date novaDataVencimentoContasAluno, Boolean atualizarContaPorParcela, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		//int contadorMesesContasRecebidas = 0;
		for (MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO : matriculaPeriodoVencimentoVOs) {
			if (matriculaPeriodoVencimentoVO.getContaReceber().getSelecionado() && !matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA) 
					&& matriculaPeriodoVencimentoVO.getContaReceber().getCodigo() != 0
					&& !matriculaPeriodoVencimentoVO.getContaReceber().getSituacaoEQuitada()){
					/*if (!atualizarContaPorParcela) {
						matriculaPeriodoVencimentoVO.getContaReceber().setDataVencimento(Uteis.getDataFutura(novaDataVencimentoContasAluno, GregorianCalendar.MONTH, contadorMesesContasRecebidas));
					} else {
						matriculaPeriodoVencimentoVO.getContaReceber().setDataVencimento(novaDataVencimentoContasAluno);
					}*/
					matriculaPeriodoVencimentoVO.getContaReceber().setAtualizandoVencimento(Boolean.TRUE);
					ControleRemessaContaReceberVO crcr = getFacadeFactory().getControleRemessaContaReceberFacade().consultaRapidaContaArquivoRemessaPorCodigoContaReceber(matriculaPeriodoVencimentoVO.getContaReceber().getCodigo());
					verificarAlteracoesContaRemessa(crcr, matriculaPeriodoVencimentoVO.getContaReceber(), configuracaoFinanceiro, matriculaPeriodoVencimentoVO.getContaReceber());
					if (matriculaPeriodoVencimentoVO.getContaReceber().getContaRemetidaComAlteracao()) {
						alterarContaReceberRemetidaComAlteracao(matriculaPeriodoVencimentoVO.getContaReceber().getCodigo(), matriculaPeriodoVencimentoVO.getContaReceber());
					}
					atualizarDataVencimentoParaRegerarBoleto(matriculaPeriodoVencimentoVO.getContaReceber(), configuracaoFinanceiro, true, usuario, crcr);
					
			}
			/*if(matriculaPeriodoVencimentoVO.getContaReceber().getSelecionado() && !matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA)) {
				contadorMesesContasRecebidas++;
			}*/
			
		}
	}
	

	public void validarDadosAtualizarVencimentoTurma(String parcela, String periodicidade, String ano, String semestre, Boolean atualizarContaPorParcela, UsuarioVO usuarioVO) throws Exception {
		if (atualizarContaPorParcela) {
			if (parcela.equals("")) {
				throw new Exception("O campo (PARCELA) deve ser informado.");
			}

		} else {
			if (parcela.equals("")) {
				throw new Exception("O campo (PARCELA) deve ser informado.");
			}
		}
		if (periodicidade.equals("SE")) {
			if (ano.equals("")) {
				throw new Exception("O campo (ANO) deve ser informado.");
			}
			if (semestre.equals("")) {
				throw new Exception("O campo (SEMESTRE) deve ser informado.");
			}
		}
		if (periodicidade.equals("AN")) {
			if (ano.equals("")) {
				throw new Exception("O campo (ANO) deve ser informado.");
			}
		}
	}


	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarDataVencimentoParaRegerarBoleto(ContaReceberVO contaReceberVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Boolean validarPermissao, UsuarioVO usuario, ControleRemessaContaReceberVO crcr) throws Exception {
		contaReceberVO.setRealizandoRecebimento(Boolean.TRUE);
		verificarCompetenciaBloqueadaParaRegistrosEntidade(contaReceberVO, "ALTERAR", contaReceberVO.getDataVencimento(), contaReceberVO.getDataCompetencia(), contaReceberVO.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);

		String sqlStr = "";
		if (contaReceberVO.getDataVencimento().after(new Date())) {
			sqlStr = "UPDATE contareceber SET datavencimento = ?, multa = 0.0, juro = 0.0 WHERE codigo = ?" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		} else {

			sqlStr = "UPDATE contareceber SET datavencimento = ? WHERE codigo = ?" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		}
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { Uteis.getDataJDBC(contaReceberVO.getDataVencimento()), contaReceberVO.getCodigo() });
		ConfiguracaoFinanceiroVO conf = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarPorUnidadeEnsino(contaReceberVO.getUnidadeEnsino().getCodigo(), Uteis.NIVELMONTARDADOS_COMBOBOX, usuario);
		if (conf.getCodigo().intValue() != configuracaoFinanceiroVO.getCodigo().intValue()) {
			conf = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarPorUnidadeEnsino(contaReceberVO.getUnidadeEnsino().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			configuracaoFinanceiroVO = conf;
		}
		contaReceberVO.setRealizandoRecebimento(Boolean.FALSE);
		Boolean sofreuAlteracao = realizarAtualizacaoValorFaixaDescontoContaReceber(contaReceberVO, configuracaoFinanceiroVO);
		contaReceberVO.setRealizandoRecebimento(Boolean.TRUE);
		contaReceberVO.setValorRecebido(contaReceberVO.getCalcularValorFinal(new Date(), configuracaoFinanceiroVO, false, new Date(), usuario));
		gravarValorFinalContaReceberAtualizadoComAcrescimosEDescontos(contaReceberVO, sofreuAlteracao, usuario, true);
		//getFacadeFactory().getRegerarBoletosFacade().gerarDadosBoleto(contaReceberVO, configuracaoFinanceiroVO, usuario, crcr);
		
		if ((crcr.getCodigo().intValue() > 0) && (contaReceberVO.getContaCorrenteVO().getAgencia().getBanco().getNrBanco().equals(Bancos.SICOOB.getNumeroBanco()) 
				|| contaReceberVO.getContaCorrenteVO().getAgencia().getBanco().getNrBanco().equals(Bancos.CAIXA_ECONOMICA_FEDERAL.getNumeroBanco())
				|| contaReceberVO.getContaCorrenteVO().getAgencia().getBanco().getNrBanco().equals(Bancos.BANCO_DO_BRASIL.getNumeroBanco())
				|| contaReceberVO.getContaCorrenteVO().getAgencia().getBanco().getNrBanco().equals(Bancos.BRADESCO.getNumeroBanco())
				|| contaReceberVO.getContaCorrenteVO().getAgencia().getBanco().getNrBanco().equals(Bancos.SANTANDER.getNumeroBanco())
				|| contaReceberVO.getContaCorrenteVO().getAgencia().getBanco().getNrBanco().equals(Bancos.ITAU.getNumeroBanco())
				|| contaReceberVO.getContaCorrenteVO().getAgencia().getBanco().getNrBanco().equals(Bancos.BANESTE.getNumeroBanco())
				)) {
			contaReceberVO.setConfiguracaoFinanceiro(configuracaoFinanceiroVO);
			contaReceberVO.setNossoNumero("");
			}
		getFacadeFactory().getContaReceberFacade().gerarDadosBoleto(contaReceberVO, configuracaoFinanceiroVO, validarPermissao, usuario);
		getFacadeFactory().getMatriculaPeriodoVencimentoFacade().atualizarDataVencimentoMatriculaPeriodoVencimentoAposRegerarBoleto(contaReceberVO, usuario);
		if (contaReceberVO.getMatriculaAluno() != null && contaReceberVO.getMatriculaAluno().getMatricula() != null && !contaReceberVO.getMatriculaAluno().getMatricula().isEmpty()) {
			getFacadeFactory().getMatriculaFacade().realizarVerificacaoELiberacaoSuspensaoMatricula(contaReceberVO.getMatriculaAluno().getMatricula());
		}
	}

	public void processarRotinaRemoverContaReceberDuplicada(String mesReferencia, UsuarioVO usuario, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		Connection con = getConexaoJDBC();
		int ano = Uteis.getAnoData(new Date());
		int mes = new Integer(mesReferencia);
		Date dataInicio = Uteis.gerarDataInicioMes(mes, ano);
		Date dataFim = Uteis.gerarDataFimMes(mes, ano);
		List listaContaReceber = consultarContaReceberDuplicada(dataInicio, dataFim, usuario);
		Iterator i = listaContaReceber.iterator();
		while (i.hasNext()) {
			ContaReceberVO conta = (ContaReceberVO) i.next();
			List contaReceberDuplicada = consultaRapidaPorAluno(conta.getMatriculaAluno().getMatricula(), dataInicio, dataFim, "AR", 0, true, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
			Iterator j = contaReceberDuplicada.iterator();
			while (j.hasNext()) {
				ContaReceberVO c = (ContaReceberVO) j.next();
				try {
					MatriculaPeriodoVencimentoVO m = getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarPorContaReceber(c.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, configuracaoFinanceiroVO, usuario);
				} catch (Exception e) {
					ContaReceberVO contaEx = getFacadeFactory().getContaReceberFacade().consultarPorChavePrimaria(c.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, configuracaoFinanceiroVO, usuario);
					// if (contaEx == null) {
					// abrir conexao base correta
					if (!consultarSeContaExisteBaseAtual(contaEx.getCodigo(), con)) {
						incluir(contaEx, con);
						// //System.out.println(" ============================================== ");
						// //System.out.println(" CONTA INCLUIDA ");
						// //System.out.println(" PARCELA = " +
						// conta.getParcela());
						// //System.out.println(" VALOR = " + conta.getValor());
						// //System.out.println(" MATRICULA = " +
						// conta.getMatriculaAluno().getMatricula());
						// //System.out.println(" DATA VENCIMENTO = " +
						// conta.getDataVencimento_Apresentar());
						// //System.out.println(" ============================================== ");
					}
					// }
				}
			}
		}

	}

	private Connection getConexaoJDBC() throws Exception {
		Class.forName("org.postgresql.Driver").newInstance();
		Connection conn = DriverManager.getConnection("jdbc:postgresql://localhost:5432/" + "SEIBD", "postgres", "admin");
		return conn;
	}

	public List<ContaReceberVO> consultarContaReceberDuplicada(Date dataInicio, Date dataFim, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		String sqlStr = "select c1.parcela, c1.matriculaaluno, c1.valor from contareceber as c1, contareceber as c2 where c1.unidadeensino = 2 and c1.tipopessoa = 'AL' " + " and c1.datavencimento >= '" + Uteis.getDataJDBC(dataInicio) + "' and c1.datavencimento <= '" + Uteis.getDataJDBC(dataFim) + "'" + " and c1.codigo <> c2.codigo and c1.parcela = c2.parcela and c1.matriculaaluno = c2.matriculaaluno and c1.valor = c2.valor" + " group by c1.parcela, c1.matriculaaluno, c1.valor " + " order by c1.matriculaAluno";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsultaDuplicada(tabelaResultado, Uteis.NIVELMONTARDADOS_TODOS);
	}

	public static List<ContaReceberVO> montarDadosConsultaDuplicada(SqlRowSet tabelaResultado, int nivelMontarDados) throws Exception {
		List<ContaReceberVO> vetResultado = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			vetResultado.add(montarDadosDuplicada(tabelaResultado, nivelMontarDados));
		}
		return vetResultado;
	}

	public static ContaReceberVO montarDadosDuplicada(SqlRowSet dadosSQL, int nivelMontarDados) throws Exception {
		ContaReceberVO obj = new ContaReceberVO();
		// obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.setParcela(dadosSQL.getString("parcela"));
		obj.getMatriculaAluno().setMatricula(dadosSQL.getString("matriculaAluno"));
		obj.setValor(dadosSQL.getDouble("valor"));
		return obj;
	}

	public void incluir(ContaReceberVO obj, Connection con) throws Exception {
		try {
			con.setAutoCommit(false);
			String sql = "INSERT INTO ContaReceber( data, codOrigem, tipoOrigem, situacao, descricaoPagamento, " + "dataVencimento, valor, valorDesconto, juro, juroPorcentagem, multa, multaPorcentagem, " + "nrDocumento, parcela, centroReceita, matriculaAluno, " + "funcionario, origemNegociacaoReceber, candidato, tipoPessoa , pessoa, contaCorrente, " + "descontoProgressivo, valorRecebido, tipoDesconto, unidadeEnsino, valorDescontoRecebido, " + "descontoInstituicao, descontoConvenio, convenio, tipoBoleto, linhaDigitavelCodigoBarras, " + "codigoBarra, beneficiario, nossonumero, parceiro, matriculaPeriodo, valorDescontoProgressivo, recebimentoBancario, " + "ordemConvenio, ordemConvenioValorCheio, ordemDescontoAluno, ordemDescontoAlunoValorCheio, " + "ordemDescontoProgressivo, ordemDescontoProgressivoValorCheio, ordemPlanoDesconto, ordemPlanoDescontoValorCheio, justificativaDesconto, valorCusteadoContaReceber, valorReceberCalculado, dataCompetencia "
					+ ") VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?," + " ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, " + " ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
			PreparedStatement sqlInserir = con.prepareStatement(sql);
			int i = 0;
			sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getData()));
			sqlInserir.setString(++i, obj.getCodOrigem());
			sqlInserir.setString(++i, obj.getTipoOrigem());
			sqlInserir.setString(++i, obj.getSituacao());
			sqlInserir.setString(++i, obj.getDescricaoPagamento());
			sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataVencimento()));
			sqlInserir.setDouble(++i, obj.getValor().doubleValue());
			sqlInserir.setDouble(++i, obj.getValorDesconto().doubleValue());
			sqlInserir.setDouble(++i, obj.getJuro().doubleValue());
			sqlInserir.setDouble(++i, obj.getJuroPorcentagem().doubleValue());
			sqlInserir.setDouble(++i, obj.getMulta().doubleValue());
			sqlInserir.setDouble(++i, obj.getMultaPorcentagem().doubleValue());
			sqlInserir.setString(++i, obj.getNrDocumento());
			sqlInserir.setString(++i, obj.getParcela());
			if (obj.getCentroReceita().getCodigo().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getCentroReceita().getCodigo().intValue());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (!obj.getMatriculaAluno().getMatricula().equals("")) {
				sqlInserir.setString(++i, obj.getMatriculaAluno().getMatricula());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getFuncionario().getCodigo().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getFuncionario().getCodigo());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getOrigemNegociacaoReceber().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getOrigemNegociacaoReceber().intValue());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getCandidato().getCodigo().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getCandidato().getCodigo());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			sqlInserir.setString(++i, obj.getTipoPessoa());
			if (obj.getPessoa().getCodigo().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getPessoa().getCodigo());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getContaCorrente().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getContaCorrente());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getDescontoProgressivo().getCodigo().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getDescontoProgressivo().getCodigo().intValue());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			sqlInserir.setDouble(++i, obj.getValorRecebido().doubleValue());
			sqlInserir.setString(++i, obj.getTipoDesconto());
			if (obj.getUnidadeEnsino().getCodigo().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getUnidadeEnsino().getCodigo().intValue());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			sqlInserir.setDouble(++i, obj.getValorDescontoRecebido().doubleValue());
			if (obj.getValorDescontoInstituicao().doubleValue() != 0.0) {
				sqlInserir.setDouble(++i, obj.getValorDescontoInstituicao().doubleValue());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getValorDescontoConvenio().doubleValue() != 0.0) {
				sqlInserir.setDouble(++i, obj.getValorDescontoConvenio().doubleValue());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getConvenio().getCodigo().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getConvenio().getCodigo().intValue());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getTipoBoleto().equals("")) {
				obj.setTipoBoleto("OU");
				sqlInserir.setString(++i, obj.getTipoBoleto());
			} else {
				sqlInserir.setString(++i, obj.getTipoBoleto());
			}
			sqlInserir.setString(++i, obj.getLinhaDigitavelCodigoBarras());
			sqlInserir.setString(++i, obj.getCodigoBarra());
			if (obj.getTipoOrigem().equals("BCC")) {
				sqlInserir.setInt(++i, obj.getBeneficiario().getCodigo());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			sqlInserir.setString(++i, obj.getNossoNumero());
			if (obj.getParceiroVO().getCodigo().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getParceiroVO().getCodigo().intValue());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getMatriculaPeriodo().intValue() != 0) {
				sqlInserir.setInt(++i, obj.getMatriculaPeriodo().intValue());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getValorDescontoProgressivo().doubleValue() != 0.0) {
				sqlInserir.setDouble(++i, obj.getValorDescontoProgressivo().doubleValue());
			} else {
				sqlInserir.setNull(++i, 0);
			}
			if (obj.getRecebimentoBancario() == null) {
				sqlInserir.setNull(++i, 0);
			} else {
				sqlInserir.setBoolean(++i, obj.getRecebimentoBancario());
			}
			sqlInserir.setInt(++i, obj.getOrdemConvenio());
			sqlInserir.setBoolean(++i, obj.getOrdemConvenioValorCheio());
			sqlInserir.setInt(++i, obj.getOrdemDescontoAluno());
			sqlInserir.setBoolean(++i, obj.getOrdemDescontoAlunoValorCheio());
			sqlInserir.setInt(++i, obj.getOrdemDescontoProgressivo());
			sqlInserir.setBoolean(++i, obj.getOrdemDescontoProgressivoValorCheio());
			sqlInserir.setInt(++i, obj.getOrdemPlanoDesconto());
			sqlInserir.setBoolean(++i, obj.getOrdemPlanoDescontoValorCheio());
			sqlInserir.setString(++i, obj.getJustificativaDesconto());
			sqlInserir.setDouble(++i, obj.getValorCusteadoContaReceber().doubleValue());
			sqlInserir.setDouble(++i, obj.getValorReceberCalculado().doubleValue());
			sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataCompetencia()));
			sqlInserir.execute();
			obj.setNovoObj(Boolean.FALSE);
			con.commit();
		} catch (Exception e) {
			con.rollback();
			con.setAutoCommit(true);
			throw e;
		} finally {
			con.setAutoCommit(true);
		}
	}

	public boolean consultarSeContaExisteBaseAtual(Integer codigo, Connection con) throws Exception {
		String sql = "SELECT * FROM ContaReceber WHERE codigo = ?";
		PreparedStatement sqlConsultar = con.prepareStatement(sql);
		sqlConsultar.setInt(1, codigo.intValue());
		ResultSet tabelaResultado = sqlConsultar.executeQuery();
		if (!tabelaResultado.next()) {
			return false;
		} else {
			// //System.out.println(" ****************************************** ");
			// //System.out.println(" CONTA ENCONTRADA ");
			// //System.out.println(" PARCELA = " + codigo);
			// //System.out.println(" ****************************************** ");

			return true;
		}
	}

	public List<ContaReceberVO> consultarContasVinculadasNegociacao(Integer codigoNegociacaoContaReceber, String matricula, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE codorigem = '" + codigoNegociacaoContaReceber + "' and tipoOrigem = 'NCR' ");
		if (matricula != null && !matricula.equals("")) {
			sqlStr.append(" AND matriculaAluno = '" + matricula + "'");
		}
		try {
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			return montarDadosConsultaBasica(tabelaResultado);
		} finally {
			sqlStr = null;
		}
	}

	public ContaReceberVO consultarContaReceberReferentePreMatriculaPorMatriculaPerido(Integer matriculaPeriodo) throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT contaReceber.codigo AS codigo, contaReceber.updated, contaReceber.situacao AS situacao FROM contaReceber ");
		sql.append("WHERE contaReceber.matriculaPeriodo = ").append(matriculaPeriodo);
		sql.append(" AND tipoOrigem = 'MAT'");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		ContaReceberVO contaReceber = new ContaReceberVO();
		if (tabelaResultado.next()) {
			contaReceber.setCodigo(tabelaResultado.getInt("codigo"));
			contaReceber.setUpdated(tabelaResultado.getDate("updated"));
			contaReceber.setSituacao(tabelaResultado.getString("situacao"));
		}
		return contaReceber;
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Throwable.class, propagation = Propagation.REQUIRED)
	public void alterarValoresDaContaReceberPorEstorno(Integer codigoContaReceber, String situacao, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Boolean bloqueioPorFechamentoMesLiberado,  UsuarioVO usuario) throws Exception {
		try {
			ContaReceberVO contaReceber = getFacadeFactory().getContaReceberFacade().consultarPorChavePrimariaSituacao(codigoContaReceber, situacao, Uteis.NIVELMONTARDADOS_TODOS, configuracaoFinanceiroVO, usuario);
			if (contaReceber != null) {
				if(bloqueioPorFechamentoMesLiberado) {
					contaReceber.liberarVerificacaoBloqueioFechamentoMes();
				}
				contaReceber.setValorRecebido(0.0);
				contaReceber.setJuro(0.0);
				contaReceber.setMulta(0.0);
				//Foi verificado que ao realizar o estorno de uma conta receber e sendo zerado o campo valordesconto e ao repassar no calculo da contareceber
				//esse valor estaria recebendo o desconto salvo no plano financeiro do aluno porem se o mesmo foi alterado depois que essa conta foi recebida				
				//perdendo assim o desconto dado anterior, por esse motivo entao voi comentando a linha abaixo e alterado a regra na hora de repassar pelo calculo da contareceber
				//contaReceber.setValorDesconto(0.0);
				contaReceber.setValorDescontoRecebido(0.0);
				contaReceber.setValorDescontoConvenio(0.0);
				contaReceber.setValorDescontoInstituicao(0.0);
				if (!Uteis.isAtributoPreenchido(contaReceber.getProcessamentoIntegracaoFinanceiraDetalheVO())) {
					contaReceber.setValorDescontoAlunoJaCalculado(0.0);
				}
				contaReceber.setValorDescontoProgressivo(0.0);
				contaReceber.setValorDescontoLancadoRecebimento(0.0);
				contaReceber.setValorCalculadoDescontoLancadoRecebimento(0.0);
				contaReceber.setTipoDescontoLancadoRecebimento("");
				contaReceber.setSituacao("AR");					
				contaReceber.setDescontoProgressivoUtilizado(null);
				getFacadeFactory().getPlanoDescontoContaReceberFacade().modificarValorUtilizadoRecebimentoDosPlanos(contaReceber.getCodigo(), 0.0);
				if (contaReceber.getTipoAluno() && contaReceber.getPessoa().getCodigo().equals(0) && contaReceber.getTipoOrigem().equals("REQ")) {
					contaReceber.setPessoa(getFacadeFactory().getPessoaFacade().consultaRapidaPorContaReceberTipoAlunoSemMatricula(contaReceber.getCodigo(), false, Uteis.NIVELMONTARDADOS_COMBOBOX, usuario));
				}
				contaReceber.setEstornandoRecebimento(true);
				alterar(contaReceber, true, configuracaoFinanceiroVO, usuario);
				realizarVerificacaoELiberacaoSuspensaoConvenioFinanciamentoProprio(contaReceber, true, usuario);
				contaReceber.setJuro(contaReceber.getValorJuroCalculado());
				contaReceber.setMulta(contaReceber.getValorMultaCalculado());
				gravarValorFinalContaReceberAtualizadoComAcrescimosEDescontos(contaReceber, false, usuario, true);
				if (!contaReceber.getSituacaoEQuitada()) {
					MatriculaPeriodoVencimentoVO mpvVO = getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarMatriculaVencimentoPorContaReceber(codigoContaReceber, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
					if (mpvVO.getCodigo() != 0) {
						mpvVO.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA);
						getFacadeFactory().getMatriculaPeriodoVencimentoFacade().alterarSituacaoValorDescontosMatriculaPeriodoVencimento(mpvVO, usuario);
					}
				}
			}
		} catch (Exception e) {
			throw e;
		}
	}	
	

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Throwable.class, propagation = Propagation.REQUIRED)
	private FaixaDescontoProgressivo modificarValorDescontoProgressivoUtilizado(ContaReceberVO contaReceberVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("select case when (cr.datavencimento::date - nr.data::date) >= dp.dialimite1 then 1 else ");
		sqlStr.append("       case when (cr.datavencimento::date - nr.data::date) >= dp.dialimite2 then 2 else ");
		sqlStr.append("       case when (cr.datavencimento::date - nr.data::date) >= dp.dialimite3 then 3 else ");
		sqlStr.append("       case when (cr.datavencimento::date - nr.data::date) >= dp.dialimite4 then 4 else 0 ");
		sqlStr.append("end end end end ");
		sqlStr.append("from contarecebernegociacaorecebimento crnc ");
		sqlStr.append("inner join negociacaorecebimento nr on crnc.negociacaorecebimento = nr.codigo ");
		sqlStr.append("inner join contareceber cr on crnc.contareceber = cr.codigo ");
		sqlStr.append("inner join descontoprogressivo dp on cr.descontoprogressivo = dp.codigo ");
		sqlStr.append("where cr.codigo = ").append(contaReceberVO.getCodigo()).append(" ");

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		Integer faixaDesconto = 0;

		String sqlAtualizacao = "update contareceber set descontoprogressivoutilizado = ? where codigo = ?" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		try {
			if (tabelaResultado.next()) {
				faixaDesconto = tabelaResultado.getInt("case");
				getConexao().getJdbcTemplate().update(sqlAtualizacao, new Object[] { FaixaDescontoProgressivo.getDescricao(faixaDesconto), contaReceberVO.getCodigo() });
				return FaixaDescontoProgressivo.getEnum(faixaDesconto);
			}
			return null;
		} finally {
			faixaDesconto = null;
			sqlAtualizacao = null;
		}

	}

	public List<ContaReceberVO> consultarContasQueNaoForamAdicionadasAoArquivoRemessaEntreDatas(Date dataInicio, Date dataFim, Integer codigoUnidadeEnsino, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("SELECT * FROM contareceber WHERE dataArquivoRemessa IS NULL AND data >= '").append(Uteis.getDataJDBC(dataInicio)).append("' ");
		sqlStr.append("AND data <= '").append(Uteis.getDataJDBC(dataFim)).append("' AND unidadeEnsino = ").append(codigoUnidadeEnsino).append(" AND pessoa IS NOT NULL");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiro, usuario);
	}

	public Boolean consultarExistenciaContaReceberRecebidaOuNegociadaPorMatriculaPeriodo(Integer matriculaPeriodo) throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT CASE WHEN COUNT(contaReceber.codigo) > 0 THEN true ELSE false END AS existe ");
		sql.append("FROM contaReceber ");
		sql.append("WHERE contaReceber.matriculaPeriodo = ? ");
		// sql.append("AND tipoOrigem = 'MAT' ");
		sql.append("AND (contaReceber.situacao in ('RE', 'NE') or tipoorigem = 'NCR') ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), new Object[] { matriculaPeriodo });
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("existe");
		}
		return false;
	}
	

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarValor(ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "ALTERAR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);
		String sqlStr = "UPDATE ContaReceber set valor=? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { obj.getValor(), obj.getCodigo() });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarValorBaseContaReceber(Integer codigo, Double valor, UsuarioVO usuario) throws Exception {
		String sqlStr = "UPDATE ContaReceber set valorBaseContaReceber=? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { valor, codigo });
	}


	public ContaReceberVO consultarPorNossoNumeroTelaControleCobranca(String nossoNumero) throws Exception {
		StringBuilder sqlStr = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, cr.situacao, cr.updated, p.nome, ");
		sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\" , ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
		sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append(" LEFT JOIN fornecedor  ON fornecedor.codigo = cr.fornecedor ");

		sqlStr.append("WHERE nossonumero = '").append(nossoNumero).append("' ");
		BigInteger nossoNumeroBig = new BigInteger(nossoNumero);
		StringBuilder sqlStr3 = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, cr.situacao, cr.updated,  p.nome, ");
		sqlStr3.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\" , ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
		sqlStr3.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr3.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr3.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr3.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append(" LEFT JOIN fornecedor  ON fornecedor.codigo = cr.fornecedor ");
		sqlStr3.append("WHERE nossonumero::bigint = '").append(nossoNumeroBig).append("' AND nossonumero !~* '[a-zA-Z]' and nossonumero <> ''");

		try {
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			if (tabelaResultado.next()) {
				return montarDadosTelaControleCobranca(tabelaResultado);
			}
			SqlRowSet tabelaResultado3 = getConexao().getJdbcTemplate().queryForRowSet(sqlStr3.toString());
			if (tabelaResultado3.next()) {
				return montarDadosTelaControleCobranca(tabelaResultado3);
			}
			return new ContaReceberVO();
		} finally {
			sqlStr = null;
			sqlStr3 = null;
			nossoNumeroBig = null;
		}
	}

	private ContaReceberVO montarDadosTelaControleCobranca(SqlRowSet dadosSQL) throws Exception {
		ContaReceberVO obj = new ContaReceberVO();
		obj.setUpdated(dadosSQL.getDate("updated"));
		obj.getMatriculaAluno().setMatricula(dadosSQL.getString("matriculaaluno"));
		obj.getMatriculaAluno().getAluno().setNome(dadosSQL.getString("nome"));
		obj.setNrDocumento(dadosSQL.getString("nrdocumento"));
		obj.setNossoNumero(dadosSQL.getString("nossonumero"));
		obj.setTipoPessoa(dadosSQL.getString("tipoPessoa"));
		obj.setCodigo(dadosSQL.getInt("codigo"));
		// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(dadosSQL.getInt("registrocobrancacontareceber"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setDataVencimento(dadosSQL.getDate("dataVencimento"));
		obj.setValor(dadosSQL.getDouble("valor"));
		obj.setTaxaBoleto(dadosSQL.getDouble("taxaBoleto"));
		obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
		obj.getPessoa().setCodigo(dadosSQL.getInt("pessoa"));
		obj.getPessoa().setNome(dadosSQL.getString("nome"));

		if (obj.getTipoPessoa().equals("RF")) {
			obj.getResponsavelFinanceiro().setCodigo(dadosSQL.getInt("responsavelFinanceiro"));
			obj.getResponsavelFinanceiro().setNome(dadosSQL.getString("responsavelFinanceiro.nome"));
		}
		if (obj.getTipoPessoa().equals("PA")) {
			obj.getParceiroVO().setCodigo(dadosSQL.getInt("parceiro"));
			obj.getParceiroVO().setNome(dadosSQL.getString("parc.nome"));
		}
		if (obj.getTipoPessoa().equals("FO")) {
			obj.getFornecedor().setCodigo(dadosSQL.getInt("for.codigo"));
			obj.getFornecedor().setNome(dadosSQL.getString("for.nome"));
			obj.getFornecedor().setCPF(dadosSQL.getString("for.cpf"));
			obj.getFornecedor().setCNPJ(dadosSQL.getString("for.cnpj"));
			obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("for.tipoEmpresa"));
		}
		return obj;
	}
	
	/*private ContaReceberVO montarDadosTelaControleCobrancaOpcao8(SqlRowSet dadosSQL) throws Exception {
		ContaReceberVO obj = new ContaReceberVO();
		obj.setUpdated(dadosSQL.getDate("updated"));
		obj.getMatriculaAluno().setMatricula(dadosSQL.getString("matriculaaluno"));
		obj.getMatriculaAluno().getAluno().setNome(dadosSQL.getString("nome"));
		obj.setNrDocumento(dadosSQL.getString("nrdocumento"));
		obj.setNossoNumero(dadosSQL.getString("nossonumero"));
		obj.setTipoPessoa(dadosSQL.getString("tipoPessoa"));
		obj.setCodigo(dadosSQL.getInt("codigo"));
		// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(dadosSQL.getInt("registrocobrancacontareceber"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setDataVencimento(dadosSQL.getDate("dataVencimento"));
		obj.setValor(dadosSQL.getDouble("valor"));
		obj.setTaxaBoleto(dadosSQL.getDouble("taxaBoleto"));
		obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
		obj.getPessoa().setCodigo(dadosSQL.getInt("pessoa"));
		obj.getPessoa().setNome(dadosSQL.getString("nome"));
		
		if (obj.getTipoPessoa().equals("RF")) {
			obj.getResponsavelFinanceiro().setCodigo(dadosSQL.getInt("responsavelFinanceiro"));
			obj.getResponsavelFinanceiro().setNome(dadosSQL.getString("responsavelFinanceiro.nome"));
		}
		if (obj.getTipoPessoa().equals("PA")) {
			obj.getParceiroVO().setCodigo(dadosSQL.getInt("parceiro"));
			obj.getParceiroVO().setNome(dadosSQL.getString("parc.nome"));
		}
		if (obj.getTipoPessoa().equals("FO")) {
			obj.getFornecedor().setCodigo(dadosSQL.getInt("for.codigo"));
			obj.getFornecedor().setNome(dadosSQL.getString("for.nome"));
			obj.getFornecedor().setCPF(dadosSQL.getString("for.cpf"));
			obj.getFornecedor().setCNPJ(dadosSQL.getString("for.cnpj"));
			obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("for.tipoEmpresa"));
		}
		return obj;
	}*/

	private ContaReceberVO montarDadosTelaControleCobrancaOpcao8(SqlRowSet dadosSQL) throws Exception {
		ContaReceberVO obj = new ContaReceberVO();
		obj.setUpdated(dadosSQL.getDate("updated"));
		obj.getMatriculaAluno().setMatricula(dadosSQL.getString("matriculaaluno"));
		obj.getMatriculaAluno().getAluno().setNome(dadosSQL.getString("nome"));
		obj.setNrDocumento(dadosSQL.getString("nrdocumento"));
		obj.setNossoNumero(dadosSQL.getString("nossonumero"));
		obj.setTipoPessoa(dadosSQL.getString("tipoPessoa"));
		obj.setCodigo(dadosSQL.getInt("codigo"));
		// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(dadosSQL.getInt("registrocobrancacontareceber"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setDataVencimento(dadosSQL.getDate("dataVencimento"));
		obj.setValor(dadosSQL.getDouble("valor"));
		obj.setTaxaBoleto(dadosSQL.getDouble("taxaBoleto"));
		obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
		obj.getPessoa().setCodigo(dadosSQL.getInt("pessoa"));
		obj.getPessoa().setNome(dadosSQL.getString("nome"));
		
		if (obj.getTipoPessoa().equals("RF")) {
			obj.getResponsavelFinanceiro().setCodigo(dadosSQL.getInt("responsavelFinanceiro"));
			obj.getResponsavelFinanceiro().setNome(dadosSQL.getString("responsavelFinanceiro.nome"));
		}
		if (obj.getTipoPessoa().equals("PA")) {
			obj.getParceiroVO().setCodigo(dadosSQL.getInt("parceiro"));
			obj.getParceiroVO().setNome(dadosSQL.getString("parc.nome"));
		}
		if (obj.getTipoPessoa().equals("FO")) {
			obj.getFornecedor().setCodigo(dadosSQL.getInt("for.codigo"));
			obj.getFornecedor().setNome(dadosSQL.getString("for.nome"));
			obj.getFornecedor().setCPF(dadosSQL.getString("for.cpf"));
			obj.getFornecedor().setCNPJ(dadosSQL.getString("for.cnpj"));
			obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("for.tipoEmpresa"));
		}
		return obj;
	}
	
	private List<ContaReceberVO> consultarContasConvenioComBaseNaParcela(String parcela, String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuarioLogado) throws Exception {
		String sqlStr = "select * from contareceber where matriculaaluno = '" + matricula + "' and parcela = '" + parcela + "' and tipoorigem = 'BCC'";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuarioLogado);
	}

	private List<ContaReceberVO> consultarContasConvenioMatricula(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuarioLogado) throws Exception {
		String sqlStr = "select * from contareceber where matriculaaluno = '" + matricula + "' and tipoorigem = 'BCC' and (parcela in ('1/1', 'Matrícula'))";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuarioLogado);
	}

	public void verificarContaReceberMatriculaPodemSerExcluidas(String matricula, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> listaConta = consultaRapidaPorMatricula(matricula);
		if ((listaConta == null) || (listaConta.isEmpty())) {
			return;
		}
		for (ContaReceberVO obj : listaConta) {
			if (consultarExistenciaContaReceberAlunoVinculadoRegistroNegativacao(obj.getCodigo())) {
				throw new Exception("Não é possível realizar a exclusão da conta a receber de nosso número "+obj.getNossoNumero()+", a mesma possui um registro de negativação/cobrança vinculado!");
			}else {
				getFacadeFactory().getRegistroNegativacaoCobrancaContaReceberItemFacade().removerVinculoContaReceberRegistroNegativacaoContaReceber(obj.getCodigo(), usuario);
			}
			getFacadeFactory().getLancamentoContabilFacade().excluirPorCodOrigemTipoOrigem(obj.getCodigo().toString(), TipoOrigemLancamentoContabilEnum.RECEBER, false, usuario);
			getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().excluidoRegistroNaoExistenteListaPorCodOrigemPorTipoCentroResultadoOrigemEnum(null, obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, usuario);
			verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "EXCLUIR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);
		}
	}

	public void verificarContaReceberPodemSerExcluidas(String clausulaEhere, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(clausulaEhere.toString());
		sqlStr.append(" ORDER BY contareceber.codigo");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<ContaReceberVO> listaConta = montarDadosConsultaBasica(resultado);
		if ((listaConta == null) || (listaConta.isEmpty())) {
			return;
		}
		for (ContaReceberVO obj : listaConta) {
			if (consultarExistenciaContaReceberAlunoVinculadoRegistroNegativacao(obj.getCodigo())) {
				throw new Exception("Não é possível realizar a exclusão da conta a receber de nosso número "+obj.getNossoNumero()+", a mesma possui um registro de negativação/cobrança vinculado!");
			}else {
				getFacadeFactory().getRegistroNegativacaoCobrancaContaReceberItemFacade().removerVinculoContaReceberRegistroNegativacaoContaReceber(obj.getCodigo(), usuario);
			}
			getFacadeFactory().getLancamentoContabilFacade().excluirPorCodOrigemTipoOrigem(obj.getCodigo().toString(), TipoOrigemLancamentoContabilEnum.RECEBER, false, usuario);
			getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().excluidoRegistroNaoExistenteListaPorCodOrigemPorTipoCentroResultadoOrigemEnum(null, obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, usuario);
			verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "EXCLUIR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);
		}
	}

	public void verificarContaReceberMatriculaPodemSerExcluidas(Integer codigoMatriculaPeriodo, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> listaConta = consultaRapidaPorMatriculaPeriodo(codigoMatriculaPeriodo);
		if ((listaConta == null) || (listaConta.isEmpty())) {
			return;
		}
		for (ContaReceberVO obj : listaConta) {
			if (consultarExistenciaContaReceberAlunoVinculadoRegistroNegativacao(obj.getCodigo())) {
				throw new Exception("Não é possível realizar a exclusão da conta a receber de nosso número "+obj.getNossoNumero()+", a mesma possui um registro de negativação/cobrança vinculado!");
			}else {
				getFacadeFactory().getRegistroNegativacaoCobrancaContaReceberItemFacade().removerVinculoContaReceberRegistroNegativacaoContaReceber(obj.getCodigo(), usuario);
			}
			getFacadeFactory().getLancamentoContabilFacade().excluirPorCodOrigemTipoOrigem(obj.getCodigo().toString(), TipoOrigemLancamentoContabilEnum.RECEBER, false, usuario);
			getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().excluidoRegistroNaoExistenteListaPorCodOrigemPorTipoCentroResultadoOrigemEnum(null, obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, usuario);
			verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "EXCLUIR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirComBaseNaMatricula(String matricula, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		validarRegistroCobrancaAntesExclusao(" WHERE matriculaaluno = '\").append(matricula).append(\"'", null);

		verificarContaReceberMatriculaPodemSerExcluidas(matricula, usuarioLogado);

		StringBuilder sqlStr = new StringBuilder("DELETE FROM contareceber WHERE matriculaaluno = '").append(matricula).append("' ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirNossoNumeroContaReceberComBaseNaMatricula(String matricula, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("DELETE FROM nossonumerocontareceber WHERE matriculaperiodo in (select codigo from matriculaperiodo where matricula = '").append(matricula).append("') ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirComBaseNaMatriculaPeriodo(Integer codMatriculaPeriodo, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		validarRegistroCobrancaAntesExclusao(" WHERE matriculaperiodo = " + codMatriculaPeriodo, null);

		verificarContaReceberMatriculaPodemSerExcluidas(codMatriculaPeriodo, usuarioLogado);

		StringBuilder sqlStr = new StringBuilder("DELETE FROM contareceber WHERE matriculaperiodo = ").append(codMatriculaPeriodo).append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirNossoNumeroContaReceberComBaseNaMatriculaPeriodo(Integer codMatriculaPeriodo, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("DELETE FROM nossonumerocontareceber WHERE matriculaperiodo = ").append(codMatriculaPeriodo).append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}

	public List<ContaReceberVO> consultaCompletaPorMatriculaPeriodoTipoMensalidade(Integer matriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		if (matriculaPeriodo == null || matriculaPeriodo == 0) {
			return new ArrayList<ContaReceberVO>(0);

		}
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE matriculaPeriodo = ");
		sqlStr.append(matriculaPeriodo);
		sqlStr.append(" and  tipoOrigem = 'MEN' ");
		sqlStr.append(" ORDER BY contareceber.dataVencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	/**
	 * Este método é responsável por alterar os descontos da conta a receber do aluno conforme os dados de desconto progressivo e plano desconto informado no mapa de pendencia de controle de conbrança. A conta a receber será totalmente modificado e todos os seus descontos serão apagados e será aplicado somente o desconto progressivo e o plano de desconto.
	 * 
	 * @param matriculaPeriodo
	 * @param planoDesconto
	 * @param descontoProgressivo
	 * @param usuarioVO
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarAlteracaoContaReceberConformeMapaPendenciaControleCobranca(List<ContaReceberVO> contaReceberVOs, PlanoDescontoVO planoDesconto, DescontoProgressivoVO descontoProgressivo, UsuarioVO usuarioVO) throws Exception {

		PlanoDescontoContaReceberVO planoDescontoContaReceberVO = null;
		if (descontoProgressivo != null && descontoProgressivo.getCodigo() > 0) {
			descontoProgressivo = getFacadeFactory().getDescontoProgressivoFacade().consultarPorChavePrimaria(descontoProgressivo.getCodigo(), usuarioVO);
		}
		if (planoDesconto != null && planoDesconto.getCodigo() > 0) {
			planoDesconto = getFacadeFactory().getPlanoDescontoFacade().consultarPorChavePrimaria(planoDesconto.getCodigo(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO);
		}
		try {
			for (ContaReceberVO contaReceberVO : contaReceberVOs) {
				if (contaReceberVO.getSituacao().equals("AR")) {
					contaReceberVO.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(contaReceberVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO));
					executarCriacaoLogAlteracaoContaReceber(contaReceberVO, planoDesconto, descontoProgressivo, usuarioVO);
					contaReceberVO.getDescontoProgressivo().setCodigo(descontoProgressivo.getCodigo());
					contaReceberVO.setValorDesconto(0.0);
					contaReceberVO.setValorDescontoAlunoJaCalculado(0.0);
					contaReceberVO.setTipoDesconto("VA");
					realizarCalculoValorDescontoSeremAplicadosContaReceberConformeMapaPendenciaControleCobranca(planoDesconto, descontoProgressivo, contaReceberVO);
					contaReceberVO.getPlanoDescontoContaReceberVOs().clear();
					if (planoDesconto != null && planoDesconto.getCodigo().intValue() > 0) {
						planoDescontoContaReceberVO = new PlanoDescontoContaReceberVO();
						planoDescontoContaReceberVO.setTipoItemPlanoFinanceiro("PD");
						planoDescontoContaReceberVO.setContaReceber(contaReceberVO.getCodigo());
						planoDescontoContaReceberVO.getPlanoDescontoVO().setCodigo(planoDesconto.getCodigo());
						contaReceberVO.getPlanoDescontoContaReceberVOs().add(planoDescontoContaReceberVO);
					}

					alterarDescontoContaReceber(contaReceberVO, usuarioVO);
				}
			}
		} catch (Exception e) {
			throw e;
		} finally {
			Uteis.removerObjetoMemoria(planoDescontoContaReceberVO);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void executarCriacaoLogAlteracaoContaReceber(ContaReceberVO contaReceberVO, PlanoDescontoVO planoDesconto, DescontoProgressivoVO descontoProgressivo, UsuarioVO usuarioVO) throws Exception {
		AplicarDescontoContaReceberLogVO aplicarDescontoContaReceberLogVO = new AplicarDescontoContaReceberLogVO();
		try {
			aplicarDescontoContaReceberLogVO.getContaReceberVO().setCodigo(contaReceberVO.getCodigo());
			aplicarDescontoContaReceberLogVO.getResponsavel().setCodigo(usuarioVO.getCodigo());
			aplicarDescontoContaReceberLogVO.getPlanoDescontoVO().setCodigo(planoDesconto.getCodigo());
			aplicarDescontoContaReceberLogVO.getDescontoProgressivoVO().setCodigo(descontoProgressivo.getCodigo());
			if (contaReceberVO.getDescontoProgressivo().getCodigo().intValue() > 0) {
				aplicarDescontoContaReceberLogVO.setObservacao("\nRemovido o desconto progressivo de código - " + contaReceberVO.getDescontoProgressivo().getCodigo());
			}
			if (contaReceberVO.getValorDesconto() > 0.0) {
				aplicarDescontoContaReceberLogVO.setObservacao("\nRemovido o desconto do aluno no valor de - " + contaReceberVO.getValorDesconto());
			}
			for (PlanoDescontoContaReceberVO paContaReceberVO : contaReceberVO.getPlanoDescontoContaReceberVOs()) {
				if (paContaReceberVO.getIsConvenio()) {
					aplicarDescontoContaReceberLogVO.setObservacao("\nRemovido o convênio de código - " + paContaReceberVO.getConvenio().getCodigo());
				} else {
					aplicarDescontoContaReceberLogVO.setObservacao("\nRemovido o plano de desconto de código - " + paContaReceberVO.getPlanoDescontoVO().getCodigo());

				}
			}
			incluirLogContaReceber(aplicarDescontoContaReceberLogVO);
		} catch (Exception e) {
			throw e;
		} finally {
			Uteis.removerObjetoMemoria(aplicarDescontoContaReceberLogVO);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void incluirLogContaReceber(final AplicarDescontoContaReceberLogVO aplicarDescontoContaReceberLogVO) throws Exception {
		final String sql = "insert into aplicarDescontoContaReceberLog (data, contaReceber, responsavel, observacao, planoDesconto, descontoProgressivo) values (?,?,?,?,?,?)";

		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlIncluir = cnctn.prepareStatement(sql);
				int i = 0;
				sqlIncluir.setTimestamp(++i, Uteis.getDataJDBCTimestamp(aplicarDescontoContaReceberLogVO.getData()));
				sqlIncluir.setInt(++i, aplicarDescontoContaReceberLogVO.getContaReceberVO().getCodigo());
				sqlIncluir.setInt(++i, aplicarDescontoContaReceberLogVO.getResponsavel().getCodigo());
				sqlIncluir.setString(++i, aplicarDescontoContaReceberLogVO.getObservacao());
				if (aplicarDescontoContaReceberLogVO.getPlanoDescontoVO().getCodigo() > 0) {
					sqlIncluir.setInt(++i, aplicarDescontoContaReceberLogVO.getPlanoDescontoVO().getCodigo());
				} else {
					sqlIncluir.setNull(++i, 0);
				}
				if (aplicarDescontoContaReceberLogVO.getDescontoProgressivoVO().getCodigo() > 0) {
					sqlIncluir.setInt(++i, aplicarDescontoContaReceberLogVO.getDescontoProgressivoVO().getCodigo());
				} else {
					sqlIncluir.setNull(++i, 0);
				}
				return sqlIncluir;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void realizarCalculoValorDescontoSeremAplicadosContaReceberConformeMapaPendenciaControleCobranca(PlanoDescontoVO planoDesconto, DescontoProgressivoVO descontoProgressivo, ContaReceberVO contaReceberVO) throws Exception {
		contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValor());
		contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValor());
		contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValor());
		contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValor());
		for (int i = 0; i < 4; ++i) {
			if (contaReceberVO.getOrdemDescontoProgressivo().intValue() == i && descontoProgressivo != null && descontoProgressivo.getCodigo() > 0 && contaReceberVO.getOrdemDescontoProgressivoValorCheio()) {
				if (descontoProgressivo.getPercDescontoLimite1() > 0) {
					contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() - ((contaReceberVO.getValor() * descontoProgressivo.getPercDescontoLimite1()) / 100));
				} else if (descontoProgressivo.getValorDescontoLimite1() > 0) {
					contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() - descontoProgressivo.getValorDescontoLimite1());
				}
				if (descontoProgressivo.getPercDescontoLimite2() > 0) {
					contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos() - ((contaReceberVO.getValor() * descontoProgressivo.getPercDescontoLimite2()) / 100));
				} else if (descontoProgressivo.getValorDescontoLimite2() > 0) {
					contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos() - descontoProgressivo.getValorDescontoLimite2());
				}
				if (descontoProgressivo.getPercDescontoLimite3() > 0) {
					contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() - ((contaReceberVO.getValor() * descontoProgressivo.getPercDescontoLimite3()) / 100));
				} else if (descontoProgressivo.getValorDescontoLimite3() > 0) {
					contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() - descontoProgressivo.getValorDescontoLimite3());
				}
				if (descontoProgressivo.getPercDescontoLimite4() > 0) {
					contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() - ((contaReceberVO.getValor() * descontoProgressivo.getPercDescontoLimite4()) / 100));
				} else if (descontoProgressivo.getValorDescontoLimite4() > 0) {
					contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() - descontoProgressivo.getValorDescontoLimite4());
				}
			} else if (contaReceberVO.getOrdemDescontoProgressivo().intValue() == i && descontoProgressivo != null && descontoProgressivo.getCodigo() > 0 && !contaReceberVO.getOrdemDescontoProgressivoValorCheio()) {
				if (descontoProgressivo.getPercDescontoLimite1() > 0) {
					contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() - ((contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() * descontoProgressivo.getPercDescontoLimite1()) / 100));
				} else if (descontoProgressivo.getValorDescontoLimite1() > 0) {
					contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() - descontoProgressivo.getValorDescontoLimite1());
				}
				if (descontoProgressivo.getPercDescontoLimite2() > 0) {
					contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos() - ((contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() * descontoProgressivo.getPercDescontoLimite2()) / 100));
				} else if (descontoProgressivo.getValorDescontoLimite2() > 0) {
					contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos() - descontoProgressivo.getValorDescontoLimite2());
				}
				if (descontoProgressivo.getPercDescontoLimite3() > 0) {
					contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() - ((contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() * descontoProgressivo.getPercDescontoLimite3()) / 100));
				} else if (descontoProgressivo.getValorDescontoLimite3() > 0) {
					contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() - descontoProgressivo.getValorDescontoLimite3());
				}
				if (descontoProgressivo.getPercDescontoLimite4() > 0) {
					contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() - ((contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() * descontoProgressivo.getPercDescontoLimite4()) / 100));
				} else if (descontoProgressivo.getValorDescontoLimite4() > 0) {
					contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() - descontoProgressivo.getValorDescontoLimite4());
				}
			}

			if (contaReceberVO.getOrdemPlanoDesconto().intValue() == i && planoDesconto != null && planoDesconto.getCodigo() > 0 && contaReceberVO.getOrdemPlanoDescontoValorCheio() && planoDesconto.getPercDescontoParcela() > 0) {
				if (planoDesconto.getTipoDescParcela().equals("PO")) {
					contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() - ((contaReceberVO.getValor() * planoDesconto.getPercDescontoParcela()) / 100));
					contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos() - ((contaReceberVO.getValor() * planoDesconto.getPercDescontoParcela()) / 100));
					contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() - ((contaReceberVO.getValor() * planoDesconto.getPercDescontoParcela()) / 100));
					contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() - ((contaReceberVO.getValor() * planoDesconto.getPercDescontoParcela()) / 100));
				} else {
					contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() - planoDesconto.getPercDescontoParcela());
					contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos() - planoDesconto.getPercDescontoParcela());
					contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() - planoDesconto.getPercDescontoParcela());
					contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() - planoDesconto.getPercDescontoParcela());
				}
			} else if (contaReceberVO.getOrdemPlanoDesconto().intValue() == i && planoDesconto != null && planoDesconto.getCodigo() > 0 && !contaReceberVO.getOrdemPlanoDescontoValorCheio() && planoDesconto.getPercDescontoParcela() > 0) {
				if (planoDesconto.getTipoDescParcela().equals("PO")) {
					contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() - ((contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() * planoDesconto.getPercDescontoParcela()) / 100));
					contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos() - ((contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos() * planoDesconto.getPercDescontoParcela()) / 100));
					contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() - ((contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() * planoDesconto.getPercDescontoParcela()) / 100));
					contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() - ((contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() * planoDesconto.getPercDescontoParcela()) / 100));
				} else {
					contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() - planoDesconto.getPercDescontoParcela());
					contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos() - planoDesconto.getPercDescontoParcela());
					contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() - planoDesconto.getPercDescontoParcela());
					contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() - planoDesconto.getPercDescontoParcela());
				}
			}
		}
		contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() - contaReceberVO.getValorDescontoRateio());
		contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos() - contaReceberVO.getValorDescontoRateio());
		contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos() - contaReceberVO.getValorDescontoRateio());
		contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos() - contaReceberVO.getValorDescontoRateio());
		if (contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() < 0) {
			throw new Exception("A soma dos desconto não pode ser maior que o valor da conta a receber.");
		}

	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void alterarDescontoContaReceber(final ContaReceberVO contaReceberVO, UsuarioVO usuarioVO) throws Exception {
		if (contaReceberVO.getSituacao().equals("AR")) {
			verificarCompetenciaBloqueadaParaRegistrosEntidade(contaReceberVO, "ALTERAR", contaReceberVO.getDataVencimento(), contaReceberVO.getDataCompetencia(), contaReceberVO.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuarioVO);

			final String sql = "UPDATE ContaReceber set descontoProgressivo=?, valordesconto=?, tipodesconto=?, " + " valorDescontoCalculadoPrimeiraFaixaDescontos = ?, valorDescontoCalculadoSegundaFaixaDescontos = ?, valorDescontoCalculadoTerceiraFaixaDescontos = ?, " + " valorDescontoCalculadoQuartaFaixaDescontos = ? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
					PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
					int i = 0;
					if (contaReceberVO.getDescontoProgressivo().getCodigo().intValue() > 0) {
						sqlAlterar.setInt(++i, contaReceberVO.getDescontoProgressivo().getCodigo());
					} else {
						sqlAlterar.setNull(++i, 0);
					}
					sqlAlterar.setDouble(++i, contaReceberVO.getValorDesconto());
					sqlAlterar.setString(++i, contaReceberVO.getTipoDesconto());
					sqlAlterar.setDouble(++i, contaReceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos());
					sqlAlterar.setDouble(++i, contaReceberVO.getValorDescontoCalculadoSegundaFaixaDescontos());
					sqlAlterar.setDouble(++i, contaReceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos());
					sqlAlterar.setDouble(++i, contaReceberVO.getValorDescontoCalculadoQuartaFaixaDescontos());
					sqlAlterar.setInt(++i, contaReceberVO.getCodigo());
					return sqlAlterar;
				}
			});
			getFacadeFactory().getPlanoDescontoContaReceberFacade().excluirItensPlanoDescontoContaReceber(contaReceberVO.getCodigo(), usuarioVO);
			getFacadeFactory().getPlanoDescontoContaReceberFacade().incluirItensPlanoDescontoContaReceber(contaReceberVO.getCodigo(), contaReceberVO.getPlanoDescontoContaReceberVOs(), usuarioVO);

		}
	}

	private ContaCorrenteVO consultarContaCorrentePadrao(ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		if (Uteis.isAtributoPreenchido(configuracaoFinanceiroVO) && Uteis.isAtributoPreenchido(configuracaoFinanceiroVO.getContaCorrentePadraoControleCobranca())) {
			return configuracaoFinanceiroVO.getContaCorrentePadraoControleCobranca();
		}
		throw new Exception("Não há Conta-Corrente padrão para Controle Cobrança na configuração padrão no sistema ou não há configuração vinculada a esta Unidade de Ensino.");
	}

	private FormaPagamentoNegociacaoRecebimentoVO criarFormaPagamentoNegociacaoRecebimentoVO(ContaReceberVO contaReceberVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		FormaPagamentoNegociacaoRecebimentoVO formaPagamentoNegociacaoRecebimentoVO = new FormaPagamentoNegociacaoRecebimentoVO();
		if (contaReceberVO.getContaCorrente() != null && contaReceberVO.getContaCorrente().intValue() != 0) {
			formaPagamentoNegociacaoRecebimentoVO.setContaCorrente(getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(contaReceberVO.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_COMBOBOX, usuarioVO));
		} else {
			formaPagamentoNegociacaoRecebimentoVO.setContaCorrente(configuracaoFinanceiroVO.getContaCorrentePadraoControleCobranca());
		}
		formaPagamentoNegociacaoRecebimentoVO.setFormaPagamento(getFacadeFactory().getFormaPagamentoFacade().consultarPorTipo(TipoFormaPagamento.ISENCAO.getValor(), Uteis.NIVELMONTARDADOS_DADOSBASICOS));
		if (formaPagamentoNegociacaoRecebimentoVO.getFormaPagamento().getCodigo().equals(0)) {
			throw new Exception("Deve existir uma Forma de Pagamento registrada do tipo Isenção (Financeiro -> Forma de Pagamento).");
		}
		formaPagamentoNegociacaoRecebimentoVO.setValorRecebimento(contaReceberVO.getValorRecebido());
		return formaPagamentoNegociacaoRecebimentoVO;
	}

	private ContaReceberNegociacaoRecebimentoVO criarContaReceberNegociacaoRecebimentoVO(ContaReceberVO contaReceberVO) throws Exception {
		ContaReceberNegociacaoRecebimentoVO contaReceberNegociacaoRecebimentoVO = new ContaReceberNegociacaoRecebimentoVO();
		contaReceberNegociacaoRecebimentoVO.setContaReceber(contaReceberVO);
		contaReceberNegociacaoRecebimentoVO.setValorTotal(contaReceberVO.getValorRecebido());
		return contaReceberNegociacaoRecebimentoVO;
	}

	public Integer consultarQtdeContasComBaseNaDataVencimento(String matricula, String tipoPessoa, String parcelaMatricula, Boolean somenteMensalidade) throws Exception {
		String sqlStr = "SELECT COUNT(codigo) AS qtdeContas FROM contareceber ";
		sqlStr += " WHERE matriculaaluno = '" + matricula + "' AND tipoPessoa = '" + tipoPessoa + "' ";
		sqlStr += " AND dataVencimento < '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		if (parcelaMatricula != null && !parcelaMatricula.equals("")) {
			sqlStr += " AND parcela != '" + parcelaMatricula + "' ";
		}
		if (somenteMensalidade != null && somenteMensalidade) {
			sqlStr += " AND UPPER(tipoorigem) = 'MEN' ";
		}
		sqlStr += " and matriculaperiodo in(select codigo from matriculaperiodo mp where mp.matricula = contareceber.matriculaaluno order by (mp.ano||'/'|| mp.semestre) desc, mp.codigo desc limit 1) ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("qtdeContas");
		} else {
			return 0;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirComBaseNaDataVencimentoSituacaoMatricula(String matricula, String situacao, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder where = new StringBuilder(" WHERE contareceber.matriculaAluno = '").append(matricula).append("' ");
		where.append(" AND contareceber.dataVencimento >= '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("' AND contareceber.situacao = '").append(situacao).append("' AND tipoorigem IN ('MAT', 'MEN') ");
		validarRegistroCobrancaAntesExclusao(where.toString(), null);

		verificarContaReceberPodemSerExcluidas(where.toString(), usuarioLogado);

		StringBuilder sqlStr = new StringBuilder("DELETE FROM contaReceber WHERE matriculaAluno = '").append(matricula).append("' ");
		sqlStr.append(" AND dataVencimento >= '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("' AND situacao = '").append(situacao).append("' AND tipoorigem IN ('MAT', 'MEN') ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Boolean consultarAlunoPossuiContasRenegociadas(String matricula, String situacao, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("SELECT codigo FROM contaReceber WHERE matriculaAluno = '").append(matricula).append("' AND tipoOrigem = 'NCR'");
		sqlStr.append(" AND situacao = '").append(situacao).append("' ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (tabelaResultado.next());
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public String consultarUltimaParcelaInclusaoDisciplinaForaPrazo(String matricula, Integer matriculaPeriodo, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("SELECT parcela FROM contaReceber ");
		sqlStr.append(" WHERE matriculaAluno = '").append(matricula).append("' AND matriculaPeriodo = ").append(matriculaPeriodo);
		sqlStr.append(" AND UPPER(parcela) like ('%IN%') ");
		sqlStr.append(" Order by codigo desc limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getString("parcela");
		} else {
			return "";
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public String consultarUltimaParcelaReposicaoDisciplina(String matricula, Integer matriculaPeriodo, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("SELECT parcela FROM contaReceber ");
		sqlStr.append(" WHERE matriculaAluno = '").append(matricula).append("' AND matriculaPeriodo = ").append(matriculaPeriodo);
		sqlStr.append(" AND UPPER(parcela) like ('%RP%') ");
		sqlStr.append(" Order by codigo desc limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getString("parcela");
		} else {
			return "";
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarComDescontoCemPorCento(final ContaReceberVO contaReceber, UsuarioVO usuario) throws Exception {
		if (contaReceber.getSituacao().equals("RE") && contaReceber.getValorRecebido() < 0) {
			throw new Exception("Falha ao registrar a conta a receber  (Valor Recebido menor que zero). ");
		}
		verificarCompetenciaBloqueadaParaRegistrosEntidade(contaReceber, "ALTERAR", contaReceber.getDataVencimento(), contaReceber.getDataCompetencia(), contaReceber.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);

		final String sql = "UPDATE ContaReceber set situacao=?, valorDesconto=?, valorRecebido=?, descontoInstituicao=?, descontoConvenio=?, valorDescontoProgressivo=?" + " WHERE (codigo = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setString(1, contaReceber.getSituacao());
				sqlAlterar.setDouble(2, contaReceber.getValorDesconto());
				sqlAlterar.setDouble(3, contaReceber.getValorRecebido());
				sqlAlterar.setDouble(4, contaReceber.getValorDescontoInstituicao());
				sqlAlterar.setDouble(5, contaReceber.getValorDescontoConvenio());
				sqlAlterar.setDouble(6, contaReceber.getValorDescontoProgressivo());
				sqlAlterar.setInt(7, contaReceber.getCodigo());
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Date consultarDataVencimento(Integer codigoContaReceber) throws Exception {
		StringBuilder sqlStr = new StringBuilder("SELECT dataVencimento FROM contaReceber ");
		sqlStr.append(" WHERE codigo = ").append(codigoContaReceber);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getDate("dataVencimento");
		} else {
			return null;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ControleRemessaContaReceberVO> consultaRapidaContasArquivoRemessaEntreDatasUtilizandoIntegracaoFinanceira(Date dataInicio, Date dataFim, Integer codigoUnidadeEnsino, ControleRemessaVO controleRemessaVO, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		return this.consultaRapidaContasArquivoRemessaEntreDatasUtilizandoIntegracaoFinanceira("", dataInicio, dataFim, codigoUnidadeEnsino, controleRemessaVO, filtroRelatorioFinanceiroVO, configuracaoFinanceiro, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ControleRemessaContaReceberVO> consultaRapidaContasArquivoRemessaEntreDatasUtilizandoIntegracaoFinanceira(String nossonumero, Date dataInicio, Date dataFim, Integer codigoUnidadeEnsino, ControleRemessaVO controleRemessaVO, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append(" select unidadeEnsino.codigo AS \"unidadeEnsino.codigo\", unidadeEnsino.nome AS \"unidadeEnsino.nome\", unidadeEnsino.cnpj AS \"unidadeEnsino.cnpj\", contareceber.codigo as \"contaReceber.codigo\" , contareceber.nossonumero, processamentointegracaofinanceiradetalhe.controleCliente,  ");
		sqlStr.append(" processamentointegracaofinanceiradetalhe.datamaximapagamento  as \"dataVencimento\", processamentointegracaofinanceiradetalhe.valorreceber  as \"valor\", '01' AS codigoInscricao, ");
		sqlStr.append(" pessoa.codigo AS \"codigoSacado\", pessoa.nome, pessoa.cpf, pessoa.endereco, pessoa.numero, pessoa.complemento, pessoa.setor, pessoa.cep, pessoa.numero, cidade.nome AS \"cidade\", estado.sigla, contareceber.tipoorigem, contaReceber.acrescimo, cidadeunidadeensino.codigo as cidadeunidadeensino, ");
		// sqlStr.append(" case when contaCorrente.controlarBloqueioEmissaoBoleto then contareceber.impressaoBoletoRealizada else true end as situacaoContaReceber ");
		sqlStr.append(" case when contaCorrente.remessaBoletoEmitido then contareceber.impressaoBoletoRealizada else true end as situacaoContaReceber ");
		sqlStr.append(" from contaReceber  ");
		sqlStr.append(" INNER JOIN processamentointegracaofinanceiradetalhe ON processamentointegracaofinanceiradetalhe.codigo = contaReceber.processamentointegracaofinanceiradetalhe ");
		sqlStr.append(" INNER JOIN pessoa ON pessoa.codigo = contaReceber.pessoa  ");
		sqlStr.append(" LEFT JOIN cidade ON cidade.codigo = pessoa.cidade  ");
		sqlStr.append(" LEFT JOIN estado ON estado.codigo = cidade.estado  ");
		sqlStr.append(" INNER JOIN unidadeEnsino ON unidadeEnsino.codigo = contaReceber.unidadeEnsinoFinanceira  ");
		sqlStr.append(" INNER JOIN cidade as cidadeunidadeEnsino ON unidadeEnsino.cidade = cidadeunidadeEnsino.codigo  ");
		sqlStr.append(" INNER JOIN contaCorrente ON contaReceber.contaCorrente = contaCorrente.codigo ");
		sqlStr.append(" LEFT JOIN controleremessacontareceber ON contaReceber.codigo = controleremessacontareceber.contareceber ");
		sqlStr.append(" and controleremessacontareceber.situacao not in ('ESTORNADO', '')  ");

		sqlStr.append(" WHERE 1=1 ");
		sqlStr.append(" and (controleremessacontareceber.codigo IS NULL) ");
		if (Uteis.isAtributoPreenchido(codigoUnidadeEnsino)) {
			sqlStr.append(" and unidadeensino.codigo = ").append(codigoUnidadeEnsino);
		}
		if (nossonumero.equals("")) {
			sqlStr.append(" AND processamentointegracaofinanceiradetalhe.datamaximapagamento >= '").append(Uteis.getDataJDBC(dataInicio)).append("' ");
			sqlStr.append(" AND processamentointegracaofinanceiradetalhe.datamaximapagamento <= '").append(Uteis.getDataJDBC(dataFim)).append("' ");
			sqlStr.append(" AND contareceber.contaCorrente = ");
			sqlStr.append(controleRemessaVO.getContaCorrenteVO().getCodigo());

			sqlStr.append(" AND contaReceber.tipoOrigem in (''");
			if (filtroRelatorioFinanceiroVO.getTipoOrigemBiblioteca()) {
				sqlStr.append(", 'BIB'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemBolsaCusteadaConvenio()) {
				sqlStr.append(", 'BCC'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemContratoReceita()) {
				sqlStr.append(", 'CTR'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemDevolucaoCheque()) {
				sqlStr.append(", 'DCH'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemInclusaoReposicao()) {
				sqlStr.append(", 'IRE'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemInscricaoProcessoSeletivo()) {
				sqlStr.append(", 'IPS'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemMatricula()) {
				sqlStr.append(", 'MAT'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemMensalidade()) {
				sqlStr.append(", 'MEN'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemNegociacao()) {
				sqlStr.append(", 'NCR'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemOutros()) {
				sqlStr.append(", 'OUT'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemRequerimento()) {
				sqlStr.append(", 'REQ'");
			}
			if (filtroRelatorioFinanceiroVO.getTipoOrigemMaterialDidatico()) {
				sqlStr.append(", 'MDI'");
			}
			sqlStr.append(" ) ");
		} else {
			sqlStr.append("and contareceber.nossonumero = '").append(nossonumero).append("'");
		}
		sqlStr.append(" AND contaReceber.situacao = 'AR' and (pessoa.aluno = true or pessoa.funcionario = true) order by pessoa.nome, contareceber.codigo ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosArquivoRemessaUtilizandoIntegracaoFinanceira(tabelaResultado, controleRemessaVO, configuracaoFinanceiro, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ControleRemessaContaReceberVO> montarDadosArquivoRemessaUtilizandoIntegracaoFinanceira(SqlRowSet tabelaResultado, ControleRemessaVO controleRemessaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		List vetResultado = new ArrayList(0);
		boolean ultimo = false;
		while (tabelaResultado.next()) {
			// if (tabelaResultado.getBoolean("situacaoContaReceber")) {
			ControleRemessaContaReceberVO obj = new ControleRemessaContaReceberVO();
			// DADOS DA CONTA A RECEBER
			obj.getUnidadeEnsino().setCodigo(tabelaResultado.getInt("unidadeEnsino.codigo"));
			obj.getUnidadeEnsino().setNome(tabelaResultado.getString("unidadeEnsino.nome"));
			// DADOS DA CONTA A RECEBER
			obj.setContaReceber(tabelaResultado.getInt("contaReceber.codigo"));
			obj.setNossoNumero(tabelaResultado.getString("nossoNumero"));
			// obj.setNrDocumento(tabelaResultado.getString("nrDocumento"));
			obj.setNrDocumento(tabelaResultado.getString("controleCliente"));
			obj.setDataVencimento(tabelaResultado.getDate("dataVencimento"));
			obj.setCodigoInscricao(Integer.parseInt(tabelaResultado.getString("codigoInscricao")));
			obj.setValor(tabelaResultado.getDouble("valor"));
			// obj.setAcrescimo(tabelaResultado.getDouble("acrescimo"));
			obj.setTipoOrigem(tabelaResultado.getString("tipoorigem"));
			obj.setNumeroInscricao(tabelaResultado.getString("cpf"));
			obj.setNomeSacado(tabelaResultado.getString("nome"));
			obj.setLogradouro(tabelaResultado.getString("endereco") + " " + tabelaResultado.getString("numero") + " " + tabelaResultado.getString("complemento"));
			obj.setBairro(tabelaResultado.getString("setor"));
			obj.setComplementoLogradouro(tabelaResultado.getString("complemento"));
			obj.setNrLogradouro(tabelaResultado.getString("numero"));
			obj.setCep(tabelaResultado.getString("cep"));
			obj.setCidade(tabelaResultado.getString("cidade"));
			obj.setEstado(tabelaResultado.getString("sigla"));
			obj.setCnpj(tabelaResultado.getString("unidadeEnsino.cnpj"));
			obj.setAgencia(controleRemessaVO.getContaCorrenteVO().getAgencia().getNumeroAgencia());
			obj.setDigitoAgencia(controleRemessaVO.getContaCorrenteVO().getAgencia().getDigito());
			obj.setContaCorrente(controleRemessaVO.getContaCorrenteVO().getNumero());
			obj.setDigitoContaCorrente(controleRemessaVO.getContaCorrenteVO().getDigito());
			obj.setCarteira(controleRemessaVO.getContaCorrenteVO().getCarteira());
			obj.setCodigocarteira(controleRemessaVO.getContaCorrenteVO().getDigito());
			if (configuracaoFinanceiroVO.getVencimentoParcelaDiaUtil()) {
				obj.setDataVencimento(getFacadeFactory().getContaReceberFacade().obterDataVerificandoDiaUtil(tabelaResultado.getDate("dataVencimento"), tabelaResultado.getInt("cidadeunidadeensino"), null));
			}
			verificarPossiveisErrosRemessa(obj, controleRemessaVO);
			vetResultado.add(obj);
			// }
		}
		return vetResultado;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ControleRemessaContaReceberVO> consultaRapidaContasArquivoRemessaEntreDatas(Date dataInicio, Date dataFim, Integer codigoUnidadeEnsino, ControleRemessaVO controleRemessaVO, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		return this.consultaRapidaContasArquivoRemessaEntreDatas("", 0, dataInicio, dataFim, codigoUnidadeEnsino, controleRemessaVO, filtroRelatorioFinanceiroVO, false, configuracaoFinanceiro, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ControleRemessaContaReceberVO> consultaRapidaContasArquivoRemessaEntreDatas(String nossoNumero, Integer codigoContaReceber, Date dataInicio, Date dataFim, Integer codigoUnidadeEnsino, ControleRemessaVO controleRemessaVO, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, boolean isGeracaoPix, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		String parcela = inicializarDadosParcelaVerificarReajustePreco(dataInicio, dataFim, usuario);
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("SELECT (valor - case when valordescontocalculadoprimeirafaixadescontos is null or valordescontocalculadoprimeirafaixadescontos = 0 then valor else valordescontocalculadoprimeirafaixadescontos end )::numeric(20,2)  AS valorDesconto, * FROM (");
		sqlStr.append("SELECT DISTINCT case when parceiro.codigo is not null then parceiro.permiteenviarremessa else case when fornecedor.codigo is not null then fornecedor.permiteenviarremessa else true end end as permiteenviarremessa, contaReceber.codigo AS \"contaReceber.codigo\", contaReceber.valordescontocalculadoprimeirafaixadescontos, contaReceber.nossoNumero, contaReceber.nrDocumento, contaReceber.dataVencimento, contaReceber.valor, contaReceber.juro, contaReceber.juroporcentagem, contaReceber.multaporcentagem,");
		sqlStr.append(" CASE WHEN contareceber.valorDesconto IS NULL THEN 0 ELSE contareceber.valordesconto END AS valorDesconto, ");
		sqlStr.append(" CASE WHEN contareceber.descontoInstituicao IS NULL THEN 0 ELSE contareceber.descontoInstituicao END AS descontoInstituicao, ");
		sqlStr.append(" CASE WHEN contareceber.descontoConvenio IS NULL THEN 0 ELSE contareceber.descontoConvenio END AS descontoConvenio, ");
		sqlStr.append(" CASE WHEN contareceber.valorDescontoRateio IS NULL THEN 0 ELSE contareceber.valorDescontoRateio END AS valorDescontoRateio, ");
		sqlStr.append("(CASE WHEN ((pessoa.codigo is not null or contareceber.responsavelFinanceiro is not null) and parceiro.codigo is null) THEN '01' ELSE '02' END) AS codigoInscricao, contareceber.valorDesconto AS valorDescontoAluno, contaReceber.valorBaseContaReceber AS \"contaReceber.valorBaseContaReceber\", ");

		sqlStr.append(" pessoa.codigo AS \"codigoSacado\", pessoa.nome, pessoa.email, pessoa.cpf, pessoa.endereco, pessoa.numero, pessoa.complemento, pessoa.setor, pessoa.cep, cidade.nome AS \"cidade\", estado.sigla,  pessoa.nomeFiador, pessoa.telefoneres ,  pessoa.telefoneres ,  pessoa.telefonerecado,  pessoa.telefonecomer ,  pessoa.celular ,  ");
		sqlStr.append(" (case when responsavelFinanceiro.codigo is not null then true else false end) as possuiRespFin, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.email as \"responsavelFinanceiro.email\", responsavelFinanceiro.cpf as \"responsavelFinanceiro.cpf\",   responsavelFinanceiro.telefoneres as \"responsavelFinanceiro.telefoneres\" ,  responsavelFinanceiro.telefoneres as \"responsavelFinanceiro.telefoneres\" ,  responsavelFinanceiro.telefonerecado as \"responsavelFinanceiro.telefonerecado\",  responsavelFinanceiro.telefonecomer as \"responsavelFinanceiro.telefonecomer\" ,  responsavelFinanceiro.celular as \"responsavelFinanceiro.celular\" ,  ");
		sqlStr.append(" responsavelFinanceiro.endereco as \"responsavelFinanceiro.endereco\", responsavelFinanceiro.numero as \"responsavelFinanceiro.numero\", ");
		sqlStr.append(" responsavelFinanceiro.complemento as \"responsavelFinanceiro.complemento\", responsavelFinanceiro.setor as \"responsavelFinanceiro.setor\", ");
		sqlStr.append(" responsavelFinanceiro.cep as \"responsavelFinanceiro.cep\", cidaderespfin.nome as \"cidaderespfin.nome\", ");
		sqlStr.append(" estadorespfin.sigla as \"estadorespfin.sigla\", ");

		sqlStr.append(" convenio.codigo AS \"convenio.codigo\", convenio.descricao AS \"convenio.descricao\", parceiro.nome AS \"parceiro.nome\", parceiro.cnpj AS \"parceiro.cnpj\", parceiro.cpf AS \"parceiro.cpf\",  parceiro.endereco AS \"parceiro.endereco\", parceiro.numero AS \"parceiro.numero\", parceiro.complemento AS \"parceiro.complemento\", parceiro.setor AS \"parceiro.setor\",   parceiro.telcomercial1 as \"parceiro.telcomercial1\"  ,parceiro.telcomercial2 as \"parceiro.telcomercial2\"  ,parceiro.telcomercial3 as \"parceiro.telcomercial3\" , parceiro.isentarmulta AS \"parceiro.isentarmulta\", ");
		sqlStr.append(" case when parceiro.codigo is not null then true else false end AS \"isparceiro\", parceiro.cep AS \"parceiro.cep\", c1.nome AS \"cidadeParceiro\", e1.sigla AS \"estadoParceiro\", ");

		sqlStr.append(" fornecedor.nome AS \"fornecedor.nome\", fornecedor.cnpj as \"fornecedor.cnpj\", fornecedor.cpf as \"fornecedor.cpf\", fornecedor.endereco AS \"fornecedor.endereco\", fornecedor.numero AS \"fornecedor.numero\", fornecedor.complemento AS \"fornecedor.complemento\", fornecedor.setor AS \"fornecedor.setor\",  fornecedor.telcomercial1  AS \"fornecedor.telcomercial1\" , fornecedor.telcomercial2  AS \"fornecedor.telcomercial2\" ,  fornecedor.telcomercial3  AS \"fornecedor.telcomercial3\" ,");
		sqlStr.append(" fornecedor.cep AS \"fornecedor.cep\", c2.nome AS \"cidadeFornecedor\",");
		sqlStr.append(" e2.sigla AS \"estadoFornecedor\",  dataArquivoRemessa, unidadeEnsino.codigo AS \"unidadeEnsino.codigo\", unidadeEnsino.nome AS \"unidadeEnsino.nome\", unidadeEnsino.cnpj AS \"unidadeEnsino.cnpj\",  ");
		sqlStr.append(" contareceber.tipoorigem, contareceber.tipodesconto, contareceber.usadescontocompostoplanodesconto as contareceber_usadescontocompostoplanodesconto, ");
		// Ddos Ordem Desconto
		sqlStr.append(" contareceber.ordemConvenio as contareceber_ordemConvenio, contareceber.ordemConvenioValorCheio as contareceber_ordemConvenioValorCheio, ");
		sqlStr.append(" contareceber.ordemDescontoAluno as contareceber_ordemDescontoAluno, contareceber.ordemDescontoAlunoValorCheio as contareceber_ordemDescontoAlunoValorCheio, ");
		sqlStr.append(" contareceber.ordemDescontoProgressivo as contareceber_ordemDescontoProgressivo, contareceber.ordemDescontoProgressivoValorCheio as contareceber_ordemDescontoProgressivoValorCheio, ");
		sqlStr.append(" contareceber.ordemPlanoDesconto as contareceber_ordemPlanoDesconto, contareceber.ordemPlanoDescontoValorCheio as contareceber_ordemPlanoDescontoValorCheio, ");

		sqlStr.append(" contareceber.contaEditadaManualmente as contareceber_contaEditadaManualmente, contareceber.diaLimite1 as contareceber_diaLimite1, contareceber.diaLimite2 as contareceber_diaLimite2, ");
		sqlStr.append(" contareceber.diaLimite3 as contareceber_diaLimite3, contareceber.diaLimite4 as contareceber_diaLimite4, contareceber.utilizarDescontoProgressivoManual as contareceber_utilizarDescontoProgressivoManual, ");
		// Dados Desconto Progressivo
		sqlStr.append(" descontoProgressivo.codigo AS descontoProgressivo, descontoprogressivo.utilizarDiaFixo as descontoprogressivo_utilizarDiaFixo,  descontoprogressivo.utilizarDiaUtil as descontoprogressivo_utilizarDiaUtil,  ");
		sqlStr.append(" descontoprogressivo.dialimite1 as descontoprogressivo_dialimite1, descontoprogressivo.dialimite2 as descontoprogressivo_dialimite2, ");
		sqlStr.append(" descontoprogressivo.dialimite3 as descontoprogressivo_dialimite3, descontoprogressivo.dialimite4 as descontoprogressivo_dialimite4, ");
		sqlStr.append(" descontoprogressivo.percdescontolimite1 as descontoprogressivo_percdescontolimite1, descontoprogressivo.percdescontolimite2 as descontoprogressivo_percdescontolimite2, ");
		sqlStr.append(" descontoprogressivo.percdescontolimite3 as descontoprogressivo_percdescontolimite3, descontoprogressivo.percdescontolimite4 as descontoprogressivo_percdescontolimite4, ");
		sqlStr.append(" descontoprogressivo.valordescontolimite1 as descontoprogressivo_valordescontolimite1, descontoprogressivo.valordescontolimite2 as descontoprogressivo_valordescontolimite2, ");
		sqlStr.append(" descontoprogressivo.valordescontolimite3 as descontoprogressivo_valordescontolimite3, descontoprogressivo.valordescontolimite4 as descontoprogressivo_valordescontolimite4, controleremessacontareceber.codigo, ");

		sqlStr.append(" (contareceber.tipoorigem in ('MAT', 'MEN', 'MDI') and planofinanceiroaluno.descontovalidoatedataparcela) as descontovalidoatedataparcela, contareceber.contaRemetidaComAlteracao, contareceber.acrescimo, contareceber.valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa, contareceber.valorIndiceReajustePorAtraso, contareceber.liberadoDoIndiceReajustePorAtraso,  cidadeunidadeensino.codigo as cidadeunidadeensino, ");
		sqlStr.append(" contareceber.contaRemetidaComAlteracao_valorBase, contareceber.contaRemetidaComAlteracao_valorComAbatimentoAdicionadoOuModificado, contareceber.contaRemetidaComAlteracao_valorComAbatimentoRemovido, ");
		sqlStr.append(" contareceber.contaRemetidaComAlteracao_valorDescProgressivo, contareceber.contaRemetidaComAlteracao_dataDescProgressivo, contareceber.contaRemetidaComAlteracao_dataVencimento , controleremessacontareceber.situacao, case when matriculaperiodo.data is not null then matriculaperiodo.data else contareceber.data end as dataemissao, ");
		sqlStr.append(" case when contaCorrente.remessaBoletoEmitido then contareceber.impressaoBoletoRealizada else true end as situacaoContaReceber, ");
		sqlStr.append(" ( select u2.cnpj from unidadeensinocontacorrente u  inner join unidadeensino u2  on u2.codigo = u.unidadeensino  where  u.utilizarremessa  and  u.contacorrente = contaCorrente.codigo ) as cnpjUtilizarRemessaOnline , ");
		sqlStr.append(getSQLExistenciaContaReceberValidasParaAplicacaoReajuste(parcela, dataInicio, dataFim, usuario));
		sqlStr.append(" from contaReceber  ");
		sqlStr.append(" INNER JOIN contaCorrente ON contaReceber.contaCorrente = contaCorrente.codigo ");
		sqlStr.append(" LEFT JOIN matriculaperiodo ON matriculaperiodo.codigo = contaReceber.matriculaperiodo ");
		sqlStr.append(" LEFT JOIN pessoa ON pessoa.codigo = contaReceber.pessoa  ");
		sqlStr.append(" LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sqlStr.append(" LEFT JOIN convenio ON convenio.codigo = contareceber.convenio ");
		sqlStr.append(" LEFT JOIN controleremessacontareceber ON contaReceber.codigo = controleremessacontareceber.contareceber ");
		sqlStr.append(" and controleremessacontareceber.codigo in (select h.codigo from (select nossonumero, max(controleremessacontareceber.codigo) as codigo from controleremessacontareceber inner join controleremessa on controleremessa.codigo = controleremessacontareceber.controleremessa where controleremessacontareceber.contareceber = contareceber.codigo and controleremessa.contacorrente = contareceber.contacorrente and controleremessacontareceber.nossonumero = contareceber.nossonumero and controleremessacontareceber.situacao not in ('ESTORNADO','ESTORNADO_PELO_USUARIO', '')  group by nossonumero) as h) ");
		sqlStr.append(" LEFT JOIN parceiro ON parceiro.codigo = contareceber.parceiro and parceiro.permiteenviarremessa = true and parceiro.permiteRemessaBoletoAlunoVinculadoParceiro = true ");
		sqlStr.append(" LEFT JOIN fornecedor ON fornecedor.codigo = contareceber.fornecedor and fornecedor.permiteenviarremessa =true   ");
		sqlStr.append(" LEFT JOIN cidade ON cidade.codigo = pessoa.cidade  ");
		sqlStr.append(" LEFT JOIN cidade as cidaderespfin ON cidaderespfin.codigo = responsavelfinanceiro.cidade  ");
		sqlStr.append(" LEFT JOIN estado as estadorespfin ON estadorespfin.codigo = cidaderespfin.estado  ");
		sqlStr.append(" LEFT JOIN estado ON estado.codigo = cidade.estado  ");
		sqlStr.append(" LEFT JOIN cidade c1 ON c1.codigo = parceiro.cidade  ");
		sqlStr.append(" LEFT JOIN estado e1 ON e1.codigo = c1.estado  ");
		sqlStr.append(" LEFT JOIN cidade c2 ON c2.codigo = fornecedor.cidade  ");
		sqlStr.append(" LEFT JOIN estado e2 ON e2.codigo = c2.estado  ");
		sqlStr.append(" INNER JOIN unidadeEnsino ON unidadeEnsino.codigo = contaReceber.unidadeEnsinoFinanceira  ");
		sqlStr.append(" INNER JOIN cidade as cidadeunidadeensino ON unidadeEnsino.cidade = cidadeunidadeensino.codigo  ");
		sqlStr.append(" LEFT JOIN descontoProgressivo ON descontoprogressivo.codigo = contareceber.descontoProgressivo ");
		sqlStr.append(" LEFT JOIN planofinanceiroaluno on planofinanceiroaluno.matriculaperiodo = contareceber.matriculaperiodo ");

		sqlStr.append(" WHERE 1=1 ");
		if(!isGeracaoPix) {
			sqlStr.append(" and (controleremessacontareceber.codigo IS NULL or (controleremessacontareceber.codigo is not null and controleremessacontareceber.situacao = 'REMETIDA_TITULO_CANCELADO')) ");	
		}

		if (!nossoNumero.equals("") || codigoContaReceber > 0) {
			if (!nossoNumero.equals("")) {
				sqlStr.append(" AND contareceber.nossoNumero = '").append(nossoNumero).append("' ");
			} 
			if (codigoContaReceber > 0) {
				sqlStr.append(" AND contareceber.codigo = ").append(codigoContaReceber).append(" ");
			}
		} else {
			sqlStr.append(" AND contaReceber.dataVencimento >= '").append(Uteis.getDataJDBC(dataInicio)).append("' ");
			sqlStr.append("AND contaReceber.dataVencimento <= '").append(Uteis.getDataJDBC(dataFim)).append("' ");
			sqlStr.append(" AND contareceber.contaCorrente = ");
			sqlStr.append(controleRemessaVO.getContaCorrenteVO().getCodigo());

			if (codigoUnidadeEnsino > 0) {
				sqlStr.append(" AND contareceber.unidadeEnsinoFinanceira = ");
				sqlStr.append(codigoUnidadeEnsino);
			}
			if (filtroRelatorioFinanceiroVO != null) {
				sqlStr.append(" AND contaReceber.tipoOrigem in (''");
				if (filtroRelatorioFinanceiroVO.getTipoOrigemBiblioteca()) {
					sqlStr.append(", 'BIB'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemBolsaCusteadaConvenio()) {
					sqlStr.append(", 'BCC'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemContratoReceita()) {
					sqlStr.append(", 'CTR'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemDevolucaoCheque()) {
					sqlStr.append(", 'DCH'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemInclusaoReposicao()) {
					sqlStr.append(", 'IRE'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemInscricaoProcessoSeletivo()) {
					sqlStr.append(", 'IPS'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemMatricula()) {
					sqlStr.append(", 'MAT'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemMensalidade()) {
					sqlStr.append(", 'MEN'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemNegociacao()) {
					sqlStr.append(", 'NCR'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemOutros()) {
					sqlStr.append(", 'OUT'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemRequerimento()) {
					sqlStr.append(", 'REQ'");
				}
				if (filtroRelatorioFinanceiroVO.getTipoOrigemMaterialDidatico()) {
					sqlStr.append(", 'MDI'");
				}
				sqlStr.append(" ) ");
			}
			sqlStr.append(" AND contaReceber.situacao = 'AR' ");
			sqlStr.append(" and (parceiro.codigo is not null or fornecedor.codigo is not null or (pessoa.codigo is not null or responsavelfinanceiro.codigo is not null and contareceber.parceiro is null and contareceber.fornecedor is null))");
			sqlStr.append(" order by pessoa.nome, contareceber.codigo, controleremessacontareceber.codigo desc");
		}
		sqlStr.append(" ) AS t where t.permiteenviarremessa = true ");
		sqlStr.append(" order by t.datavencimento, t.nome, t.nossonumero ");		
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());		
		

		List<ControleRemessaContaReceberVO> lista = montarDadosArquivoRemessa(tabelaResultado, controleRemessaVO, configuracaoFinanceiro, usuario);

		return this.consultaRapidaContasArquivoRemessaEntreDatasParaBaixa(lista, dataInicio, dataFim, codigoUnidadeEnsino, controleRemessaVO, filtroRelatorioFinanceiroVO, configuracaoFinanceiro, usuario);

	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ControleRemessaContaReceberVO> consultaRapidaContasArquivoRemessaEntreDatasParaBaixa(List<ControleRemessaContaReceberVO> lista, Date dataInicio, Date dataFim, Integer codigoUnidadeEnsino, ControleRemessaVO controleRemessaVO, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		if (filtroRelatorioFinanceiroVO != null && (filtroRelatorioFinanceiroVO.getSituacaoCancelado() || filtroRelatorioFinanceiroVO.getSituacaoExcluida() || filtroRelatorioFinanceiroVO.getSituacaoRenegociado())) {
			StringBuilder sqlStr = new StringBuilder("");
			sqlStr.append(" SELECT controleremessacontareceber.*, pessoa.cpf, pessoa.nome, pessoa.email, pessoa.endereco, pessoa.numero, pessoa.complemento, pessoa.setor, pessoa.cep, cidade.nome as cidade, estado.sigla, contareceber.codigo as  contareceber_codigo, contareceber.situacao as contareceber_situacao ");
			sqlStr.append("  FROM nossonumerocontareceber   ");
			sqlStr.append(" INNER JOIN contacorrente 				ON contacorrente.codigo = nossonumerocontareceber.contacorrente ");
			sqlStr.append(" INNER JOIN controleremessacontareceber  ON controleremessacontareceber.nossonumero = nossonumerocontareceber.nossonumero ");
			sqlStr.append(" INNER JOIN LATERAL (   ");
			sqlStr.append("  	SELECT MAX(crcr.codigo) AS codigo_crcr  FROM controleremessacontareceber crcr WHERE crcr.nossonumero = nossonumerocontareceber.nossonumero   ");
			sqlStr.append(" 	AND controleremessacontareceber.contacorrente = contacorrente.numero  ");
			sqlStr.append(" ) AS crcr_temp 							ON controleremessacontareceber.codigo = crcr_temp.codigo_crcr  ");
			sqlStr.append(" AND controleremessacontareceber.situacao NOT IN ('REMETIDA_TITULO_CANCELADO') AND (controleremessacontareceber.baixarconta IS NULL OR  controleremessacontareceber.baixarconta = false)  ");		
			sqlStr.append(" LEFT JOIN contareceber 				    ON contareceber.nossonumero = nossonumerocontareceber.nossonumero ");
			sqlStr.append(" INNER JOIN matriculaperiodo 			ON matriculaperiodo.codigo = nossonumerocontareceber.matriculaperiodo ");
			sqlStr.append(" INNER JOIN matricula 					ON matricula.matricula 	   = matriculaperiodo.matricula ");
			sqlStr.append(" INNER JOIN pessoa 						ON pessoa.codigo 		   = matricula.aluno ");
			sqlStr.append(" INNER JOIN cidade 						ON cidade.codigo 		   = pessoa.cidade ");
			sqlStr.append(" INNER JOIN estado 						ON estado.codigo 		   = cidade.estado ");		
			sqlStr.append(" WHERE ((contareceber.codigo is null AND true = ").append(filtroRelatorioFinanceiroVO.getSituacaoExcluida().toString()).append(") or (contareceber.situacao = 'CF' and true = ").append(filtroRelatorioFinanceiroVO.getSituacaoCancelado().toString()).append(") or (contareceber.situacao = 'NE' and true = ").append(filtroRelatorioFinanceiroVO.getSituacaoRenegociado().toString()).append(")) ");
			sqlStr.append(" AND contacorrente.codigo = ");
			sqlStr.append(controleRemessaVO.getContaCorrenteVO().getCodigo());
			if (codigoUnidadeEnsino > 0) {
				sqlStr.append(" AND controleremessacontareceber.unidadeensino = ");
				sqlStr.append(codigoUnidadeEnsino);
			}
			sqlStr.append("  ");
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			List<ControleRemessaContaReceberVO> listaBaixa = montarDadosArquivoRemessaBaixa(lista, tabelaResultado, controleRemessaVO, configuracaoFinanceiro, usuario);
			return listaBaixa;
		} else {
			return lista;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ControleRemessaContaReceberVO> montarDadosArquivoRemessaBaixa(List<ControleRemessaContaReceberVO> listaBaixa, SqlRowSet tabelaResultado, ControleRemessaVO controleRemessaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		while (tabelaResultado.next()) {
			ControleRemessaContaReceberVO obj = new ControleRemessaContaReceberVO();
			obj.setBaixarConta(Boolean.TRUE);
			obj.getUnidadeEnsino().setCodigo(tabelaResultado.getInt("unidadeEnsino"));
			// DADOS DA CONTA A RECEBER
			obj.setNossoNumero(tabelaResultado.getString("nossoNumero"));
			obj.setNrDocumento(tabelaResultado.getString("nrDocumento"));
			obj.setDataVencimento(tabelaResultado.getDate("dataVencimento"));
			// obj.setDataEmissao(tabelaResultado.getDate("dataEmissao"));
			obj.setDataVencimento(tabelaResultado.getDate("dataVencimento"));
			obj.setValor(tabelaResultado.getDouble("valor"));
			obj.setAcrescimo(tabelaResultado.getDouble("acrescimo"));
			obj.setValorBase(tabelaResultado.getDouble("valorbase"));
			obj.setValorDesconto(tabelaResultado.getDouble("valorDesconto"));
			obj.setValorDescontoRateio(tabelaResultado.getDouble("valorDescontoRateio"));
			obj.setValorDescontoAluno(tabelaResultado.getDouble("valorDescontoAluno"));
			obj.setJuro(tabelaResultado.getDouble("juro"));
			obj.setJuroPorcentagem(tabelaResultado.getDouble("juroPorcentagem"));
			obj.setMultaPorcentagem(tabelaResultado.getDouble("multaPorcentagem"));
			obj.setCodigoInscricao(Integer.parseInt(tabelaResultado.getString("codigoInscricao")));
			obj.setTipoOrigem(tabelaResultado.getString("tipoorigem"));
			obj.setTipoDesconto(tabelaResultado.getString("tipodesconto"));

			obj.setCnpj(tabelaResultado.getString("cnpj"));
			obj.setAgencia(tabelaResultado.getString("agencia"));
			obj.setDigitoAgencia(tabelaResultado.getString("digitoagencia"));
			obj.setContaCorrente(tabelaResultado.getString("contacorrente"));
			obj.setDigitoContaCorrente(tabelaResultado.getString("digitocontacorrente"));
			obj.setCodigocarteira(tabelaResultado.getString("digitocontacorrente"));
			obj.setCarteira(tabelaResultado.getString("carteira"));

			obj.setDataLimiteConcessaoDesconto(tabelaResultado.getDate("DataLimiteConcessaoDesconto"));
			obj.setValorDescontoDataLimite(tabelaResultado.getDouble("valorDescontoDataLimite"));
			obj.setDataLimiteConcessaoDesconto2(tabelaResultado.getDate("dataLimiteConcessaoDesconto2"));
			obj.setValorDescontoDataLimite2(tabelaResultado.getDouble("valorDescontoDataLimite2"));
			obj.setDataLimiteConcessaoDesconto3(tabelaResultado.getDate("dataLimiteConcessaoDesconto3"));
			obj.setValorDescontoDataLimite3(tabelaResultado.getDouble("valorDescontoDataLimite3"));
			obj.setValorAbatimento(tabelaResultado.getDouble("valorAbatimento"));

			obj.setNumeroInscricao(tabelaResultado.getString("cpf"));
			obj.setNomeSacado(tabelaResultado.getString("nome"));
			obj.setEmailSacado(tabelaResultado.getString("email"));
			obj.setLogradouro(tabelaResultado.getString("endereco") + " " + tabelaResultado.getString("numero") + " " + tabelaResultado.getString("complemento"));
			obj.setBairro(tabelaResultado.getString("setor"));
			obj.setCep(tabelaResultado.getString("cep"));
			obj.setCidade(tabelaResultado.getString("cidade"));
			obj.setEstado(tabelaResultado.getString("sigla"));
			obj.setSituacaoConta(tabelaResultado.getString("contareceber_situacao"));
			if (!Uteis.isAtributoPreenchido(tabelaResultado.getInt("contareceber_codigo"))) {
				obj.setSituacaoConta("EX");
			}
			listaBaixa.add(obj);
		}
		return listaBaixa;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ControleRemessaContaReceberVO> montarDadosArquivoRemessa(SqlRowSet tabelaResultado, ControleRemessaVO controleRemessaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		List vetResultado = new ArrayList(0);
		boolean ultimo = false;
		while (tabelaResultado.next()) {
			if (tabelaResultado.getBoolean("situacaoContaReceber")) {
				ControleRemessaContaReceberVO obj = new ControleRemessaContaReceberVO();
				// DADOS DA CONTA A RECEBER
				obj.getUnidadeEnsino().setCodigo(tabelaResultado.getInt("unidadeEnsino.codigo"));
				obj.getUnidadeEnsino().setNome(tabelaResultado.getString("unidadeEnsino.nome"));
				// DADOS DA CONTA A RECEBER
				obj.setContaReceber(tabelaResultado.getInt("contaReceber.codigo"));
				obj.setNossoNumero(tabelaResultado.getString("nossoNumero"));
				obj.setNrDocumento(tabelaResultado.getString("nrDocumento"));
				obj.setDataVencimento(tabelaResultado.getDate("dataVencimento"));
				obj.setDataEmissao(tabelaResultado.getDate("dataEmissao"));
				if (tabelaResultado.getString("situacao") != null) {
					obj.setSituacaoControleRemessaContaReceber(SituacaoControleRemessaContaReceberEnum.getEnum(tabelaResultado.getString("situacao")));
				}
				if (configuracaoFinanceiroVO.getVencimentoParcelaDiaUtil()) {
					obj.setDataVencimento(getFacadeFactory().getContaReceberFacade().obterDataVerificandoDiaUtil(tabelaResultado.getDate("dataVencimento"), tabelaResultado.getInt("cidadeunidadeensino"), null));
				}
				obj.setValor(tabelaResultado.getDouble("valor"));
				obj.setAcrescimo(tabelaResultado.getDouble("acrescimo"));
				obj.setValorBase(tabelaResultado.getDouble("contaReceber.valorBaseContaReceber"));
				if (obj.getValorBase().equals(0.0) && obj.getValor() > 0) {
					obj.setValorBase(obj.getValor());
				}
				obj.setValorDesconto(tabelaResultado.getDouble("valorDesconto"));
				obj.setValorDescontoRateio(tabelaResultado.getDouble("valorDescontoRateio"));
				obj.setValorDescontoAluno(tabelaResultado.getDouble("valorDescontoAluno"));
				obj.setJuro(tabelaResultado.getDouble("juro"));
				obj.setCodigoInscricao(Integer.parseInt(tabelaResultado.getString("codigoInscricao")));
				obj.setTipoOrigem(tabelaResultado.getString("tipoorigem"));
				obj.setTipoDesconto(tabelaResultado.getString("tipodesconto"));
				obj.setUsaDescontoCompostoPlanoDesconto(tabelaResultado.getBoolean("contareceber_usadescontocompostoplanodesconto"));
				obj.setDescontoValidoAteDataParcela(tabelaResultado.getBoolean("descontovalidoatedataparcela"));
				// obj.setValorDescontoDataLimite(tabelaResultado.getDouble("contareceber_valordescontocalculadoprimeirafaixadescontos"));
				// Dados Desconto Progressivo
				obj.setDescontoprogressivo_codigo(tabelaResultado.getInt("descontoProgressivo"));
				obj.setDescontoprogressivo_dialimite1(tabelaResultado.getInt("descontoprogressivo_dialimite1"));
				obj.setDescontoprogressivo_dialimite2(tabelaResultado.getInt("descontoprogressivo_dialimite2"));
				obj.setDescontoprogressivo_dialimite3(tabelaResultado.getInt("descontoprogressivo_dialimite3"));
				obj.setDescontoprogressivo_dialimite4(tabelaResultado.getInt("descontoprogressivo_dialimite4"));
				obj.setDescontoprogressivo_percdescontolimite1(tabelaResultado.getDouble("descontoprogressivo_percdescontolimite1"));
				obj.setDescontoprogressivo_percdescontolimite2(tabelaResultado.getDouble("descontoprogressivo_percdescontolimite2"));
				obj.setDescontoprogressivo_percdescontolimite3(tabelaResultado.getDouble("descontoprogressivo_percdescontolimite3"));
				obj.setDescontoprogressivo_percdescontolimite4(tabelaResultado.getDouble("descontoprogressivo_percdescontolimite4"));
				obj.setDescontoprogressivo_valordescontolimite1(tabelaResultado.getDouble("descontoprogressivo_valordescontolimite1"));
				obj.setDescontoprogressivo_valordescontolimite2(tabelaResultado.getDouble("descontoprogressivo_valordescontolimite2"));
				obj.setDescontoprogressivo_valordescontolimite3(tabelaResultado.getDouble("descontoprogressivo_valordescontolimite3"));
				obj.setDescontoprogressivo_valordescontolimite4(tabelaResultado.getDouble("descontoprogressivo_valordescontolimite4"));
				obj.setDescontoprogressivo_utilizaDiaFixo(tabelaResultado.getBoolean("descontoprogressivo_utilizarDiaFixo"));
				obj.setDescontoprogressivo_utilizaDiaUtil(tabelaResultado.getBoolean("descontoprogressivo_utilizarDiaUtil"));
				obj.setContareceber_contaEditadaManualmente(tabelaResultado.getBoolean("contareceber_contaEditadaManualmente"));
				obj.setContareceber_utilizarDescontoProgressivoManual(tabelaResultado.getBoolean("contareceber_utilizarDescontoProgressivoManual"));
				obj.setContareceber_diaLimite1(tabelaResultado.getInt("contareceber_diaLimite1"));
				obj.setContareceber_diaLimite2(tabelaResultado.getInt("contareceber_diaLimite2"));
				obj.setContareceber_diaLimite3(tabelaResultado.getInt("contareceber_diaLimite3"));
				obj.setContareceber_diaLimite4(tabelaResultado.getInt("contareceber_diaLimite4"));
				if ((obj.getContareceber_contaEditadaManualmente()) &&
						(obj.getContareceber_utilizarDescontoProgressivoManual())) {
					obj.setDescontoprogressivo_dialimite1(obj.getContareceber_diaLimite1());
					obj.setDescontoprogressivo_dialimite2(obj.getContareceber_diaLimite2());
					obj.setDescontoprogressivo_dialimite3(obj.getContareceber_diaLimite3());
					obj.setDescontoprogressivo_dialimite4(obj.getContareceber_diaLimite4());
				}
				obj.setParcelaDeveReceberReajustePreco(tabelaResultado.getBoolean("parcelaDeveReceberReajustePreco"));
				if (obj.getParcelaDeveReceberReajustePreco()) {
					obj.setApresentarArquivoRemessa(false);
				}
				if(tabelaResultado.getDouble("valorIndiceReajustePorAtraso") >= 0.0){
					obj.setAcrescimo(obj.getAcrescimo() + tabelaResultado.getDouble("valorIndiceReajustePorAtraso"));
				}else if (tabelaResultado.getDouble("valorIndiceReajustePorAtraso") < 0.0){
					obj.setValorDescontoRateio(obj.getValorDescontoRateio() - tabelaResultado.getDouble("valorIndiceReajustePorAtraso"));
				}
				if(tabelaResultado.getDouble("valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa") >= 0.0) {
					obj.setAcrescimo(obj.getAcrescimo() + tabelaResultado.getDouble("valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa"));
				}
				

				ContaReceberVO contaObterOrdemDesconto = new ContaReceberVO();
				contaObterOrdemDesconto.setOrdemConvenio(tabelaResultado.getInt("contareceber_ordemConvenio"));
				contaObterOrdemDesconto.setOrdemConvenioValorCheio(tabelaResultado.getBoolean("contareceber_ordemConvenioValorCheio"));
				contaObterOrdemDesconto.setOrdemDescontoAluno(tabelaResultado.getInt("contareceber_ordemDescontoAluno"));
				contaObterOrdemDesconto.setOrdemDescontoAlunoValorCheio(tabelaResultado.getBoolean("contareceber_ordemDescontoAlunoValorCheio"));
				contaObterOrdemDesconto.setOrdemDescontoProgressivo(tabelaResultado.getInt("contareceber_ordemDescontoProgressivo"));
				contaObterOrdemDesconto.setOrdemDescontoProgressivoValorCheio(tabelaResultado.getBoolean("contareceber_ordemDescontoProgressivoValorCheio"));
				contaObterOrdemDesconto.setOrdemPlanoDesconto(tabelaResultado.getInt("contareceber_ordemPlanoDesconto"));
				contaObterOrdemDesconto.setOrdemPlanoDescontoValorCheio(tabelaResultado.getBoolean("contareceber_ordemPlanoDescontoValorCheio"));
				obj.setListaOrdemDescontoVOs(contaObterOrdemDesconto.obterOrdemAplicacaoDescontosPadraoAtual());
				obj.setCodigoInscricao(new Integer(tabelaResultado.getString("codigoInscricao")));
				if (tabelaResultado.getString("codigoInscricao").equals("01")) {
					if (tabelaResultado.getBoolean("possuiRespFin")) {
						obj.setNumeroInscricao(tabelaResultado.getString("responsavelFinanceiro.cpf"));
						obj.setNomeSacado(tabelaResultado.getString("responsavelFinanceiro.nome"));
						obj.setEmailSacado(tabelaResultado.getString("responsavelFinanceiro.email"));
						obj.setLogradouro(tabelaResultado.getString("responsavelFinanceiro.endereco") + " " + tabelaResultado.getString("responsavelFinanceiro.numero") + " " + tabelaResultado.getString("responsavelFinanceiro.complemento"));
						obj.setBairro(tabelaResultado.getString("responsavelFinanceiro.setor"));
						obj.setCep(tabelaResultado.getString("responsavelFinanceiro.cep"));
						obj.setCidade(tabelaResultado.getString("cidaderespfin.nome"));
						obj.setEstado(tabelaResultado.getString("estadorespfin.sigla"));
						obj.setComplementoLogradouro(tabelaResultado.getString("responsavelFinanceiro.complemento"));
						obj.setNrLogradouro(tabelaResultado.getString("responsavelFinanceiro.numero"));
						validarPreenchimentoTelefonePessoa(tabelaResultado , obj );					
					} else {
						obj.setNumeroInscricao(tabelaResultado.getString("cpf"));
						obj.setNomeSacado(tabelaResultado.getString("nome"));
						obj.setEmailSacado(tabelaResultado.getString("email"));
						obj.setLogradouro(tabelaResultado.getString("endereco") + " " + tabelaResultado.getString("numero") + " " + tabelaResultado.getString("complemento"));
						obj.setBairro(tabelaResultado.getString("setor"));
						obj.setCep(tabelaResultado.getString("cep"));
						obj.setCidade(tabelaResultado.getString("cidade"));
						obj.setEstado(tabelaResultado.getString("sigla"));
						obj.setAvalista(tabelaResultado.getString("nomeFiador"));
						obj.setNumeroInscricao(tabelaResultado.getString("cpf"));
						obj.setComplementoLogradouro(tabelaResultado.getString("complemento"));
						obj.setNrLogradouro(tabelaResultado.getString("numero"));
						validarPreenchimentoTelefonePessoa(tabelaResultado , obj );
					}
				} else {
					if (tabelaResultado.getBoolean("isparceiro")) {
						obj.setNomeSacado(tabelaResultado.getString("parceiro.nome"));
						// obj.setNomeSacado(tabelaResultado.getString("convenio.descricao"));
						if (tabelaResultado.getString("parceiro.cnpj") != null && !tabelaResultado.getString("parceiro.cnpj").equals("")) {
							obj.setNumeroInscricao(Uteis.removerMascara(tabelaResultado.getString("parceiro.cnpj")));
						} else {
							if (tabelaResultado.getString("parceiro.cpf") != null) {
							obj.setNumeroInscricao(Uteis.removerMascara(tabelaResultado.getString("parceiro.cpf")));
						}
						}
						obj.setLogradouro(tabelaResultado.getString("parceiro.endereco") + " " + tabelaResultado.getString("parceiro.numero") + " " + tabelaResultado.getString("parceiro.complemento"));
						obj.setBairro(tabelaResultado.getString("parceiro.setor"));
						obj.setCep(tabelaResultado.getString("parceiro.cep"));
						obj.setCidade(tabelaResultado.getString("cidadeParceiro"));
						obj.setEstado(tabelaResultado.getString("estadoParceiro"));
						obj.setComplementoLogradouro(tabelaResultado.getString("parceiro.complemento"));
						obj.setNrLogradouro(tabelaResultado.getString("parceiro.numero"));
						obj.setParceiroPermiteIsentarMulta(tabelaResultado.getBoolean("parceiro.isentarmulta"));
						validarPreenchimentoTelefonePessoa(tabelaResultado , obj );
					} else {
						obj.setNomeSacado(tabelaResultado.getString("fornecedor.nome"));
						// obj.setNomeSacado(tabelaResultado.getString("convenio.descricao"));
						if (tabelaResultado.getString("fornecedor.cnpj") != null && !tabelaResultado.getString("fornecedor.cnpj").equals("")) {
							obj.setNumeroInscricao(Uteis.removerMascara(tabelaResultado.getString("fornecedor.cnpj")));
						} else {
							obj.setNumeroInscricao(Uteis.removerMascara(tabelaResultado.getString("fornecedor.cpf")));
						}
						obj.setLogradouro(tabelaResultado.getString("fornecedor.endereco") + " " + tabelaResultado.getString("fornecedor.numero") + " " + tabelaResultado.getString("fornecedor.complemento"));
						obj.setBairro(tabelaResultado.getString("fornecedor.setor"));
						obj.setCep(tabelaResultado.getString("fornecedor.cep"));
						obj.setCidade(tabelaResultado.getString("cidadeFornecedor"));
						obj.setEstado(tabelaResultado.getString("estadoFornecedor"));
						obj.setComplementoLogradouro(tabelaResultado.getString("fornecedor.complemento"));
						obj.setNrLogradouro(tabelaResultado.getString("fornecedor.numero"));
						validarPreenchimentoTelefonePessoa(tabelaResultado , obj );
					}
					// obj.setNumeroInscricaoEmpresa(Integer.parseInt(Uteis.removerMascara(tabelaResultado.getString("cnpj"))));
				}
				if(Uteis.isAtributoPreenchido(tabelaResultado.getString("cnpjUtilizarRemessaOnline"))) {
					obj.setCnpj(tabelaResultado.getString("cnpjUtilizarRemessaOnline"));
				}else {
			   	   obj.setCnpj(tabelaResultado.getString("unidadeEnsino.cnpj"));
				}
				obj.setAgencia(controleRemessaVO.getContaCorrenteVO().getAgencia().getNumeroAgencia());
				obj.setDigitoAgencia(controleRemessaVO.getContaCorrenteVO().getAgencia().getDigito());
				obj.setContaCorrente(controleRemessaVO.getContaCorrenteVO().getNumero());
				obj.setDigitoContaCorrente(controleRemessaVO.getContaCorrenteVO().getDigito());
				obj.setCarteira(controleRemessaVO.getContaCorrenteVO().getCarteira());
				obj.setCodigocarteira(controleRemessaVO.getContaCorrenteVO().getDigito());
				executarCalculoValorDiferencaContaDescontos(obj, configuracaoFinanceiroVO);
				boolean encontrou = false;
				if (!vetResultado.isEmpty()) {
					Iterator i = vetResultado.iterator();
					while (i.hasNext()) {
						ControleRemessaContaReceberVO dadosRemessaVO = (ControleRemessaContaReceberVO) i.next();
						if (dadosRemessaVO.getContaReceber().intValue() == obj.getContaReceber().intValue() && obj.getCodMovRemessa().equals(dadosRemessaVO.getCodMovRemessa())) {
							encontrou = true;
						}
					}
				}
				verificarPossiveisErrosRemessa(obj, controleRemessaVO);
				if (!encontrou) {
					if (!controleRemessaVO.getTipoRemessa().equals("RE")) {
						// if (obj.getCodMovRemessa().equals("10_06_31")) {
						// obj.setCodMovRemessa("10");
						// vetResultado.add(obj.clone());
						// obj.setCodMovRemessa("06");
						// vetResultado.add(obj.clone());
						// obj.setCodMovRemessa("31");
						// vetResultado.add(obj);
						// } else if (obj.getCodMovRemessa().equals("10_06")) {
						// obj.setCodMovRemessa("10");
						// vetResultado.add(obj.clone());
						// obj.setCodMovRemessa("06");
						// vetResultado.add(obj);
						// } else if (obj.getCodMovRemessa().equals("10_31")) {
						// obj.setCodMovRemessa("10");
						// vetResultado.add(obj.clone());
						// obj.setCodMovRemessa("31");
						// vetResultado.add(obj);
						// } else if (obj.getCodMovRemessa().equals("06_31")) {
						// obj.setCodMovRemessa("06");
						// vetResultado.add(obj.clone());
						// obj.setCodMovRemessa("31");
						// vetResultado.add(obj);
						// } else {
						// vetResultado.add(obj);
						// }
					} else {
						vetResultado.add(obj);
					}
				}
			}
		}
		return vetResultado;

	}

	public void verificarPossiveisErrosRemessa(ControleRemessaContaReceberVO obj, ControleRemessaVO controleRemessa) {
		try {
			String msgErro = "";
			if (obj.getNomeSacado().replaceAll(" ", "").length() <= 0) {
				msgErro += "Nome sacado em branco (" + obj.getNomeSacado() + "); ";
			}
			if (obj.getCodigoInscricao() == 0 || obj.getCodigoInscricao() == 1) {
				if (!Uteis.validaCPF(Uteis.removerAcentos(Uteis.removeCaractersEspeciais(obj.getNumeroInscricao())).replaceAll(" ", ""))) {
					msgErro += "CPF inválido (" + obj.getNumeroInscricao() + "); ";
				}
			} else {
				if (obj.getNumeroInscricao().length() != 14) {
					boolean validouCPF = false;
					boolean validouCNPJ = false;
					if (Uteis.validaCPF(Uteis.removerAcentos(Uteis.removeCaractersEspeciais(obj.getNumeroInscricao())).replaceAll(" ", ""))) {
						validouCPF = true;
					}
					if (!validouCNPJ && !validouCPF) {
						msgErro += "CNPJ/CPF inválido (" + obj.getNumeroInscricao() + "); ";
					}
				}
			}
			String cep = Uteis.removerAcentos(Uteis.removeCaractersEspeciais(obj.getCep()).replaceAll(" ", ""));
			if (cep.length() != 8) {
				msgErro += "CEP inválido (" + obj.getCep() + "); ";
			}
			String cidade = obj.getCidade();
			if (cidade.trim().equals("")) {
				msgErro += "Cidade inválida (" + obj.getCidade() + "); ";
			}
			String estado = obj.getEstado();
			if (estado.trim().equals("")) {
				msgErro += "Estado inválido (" + obj.getEstado() + "); ";
			}
			String endereco = obj.getLogradouro();
			if (endereco.trim().equals("")) {
				msgErro += "Endereço inválido (" + obj.getLogradouro() + "); ";
			}
//			if (controleRemessa.getContaCorrenteVO().getPermiteEnviarBoletoVencido()) {
//				if (controleRemessa.getContaCorrenteVO().getQtdDiasBoletoVencido() > 0) {
//					if (obj.getDataVencimento().before(Uteis.obterDataAntiga(new Date(), controleRemessa.getContaCorrenteVO().getQtdDiasBoletoVencido()))) {
//						msgErro += "Data de Vencimento do boleto menor que a data limite para envio (" + Uteis.getData(Uteis.obterDataAntiga(new Date(), controleRemessa.getContaCorrenteVO().getQtdDiasBoletoVencido())) + "), configuração realizada no cadastro da Conta Corrente; ";
//					}
//				}
//			} else {
//				if (controleRemessa.getContaCorrenteVO().getQtdDiasBoletoAVencer() > 0) {
//					if (obj.getDataVencimento().before(Uteis.obterDataFutura(new Date(), controleRemessa.getContaCorrenteVO().getQtdDiasBoletoAVencer()))) {
//						msgErro += "Data de Vencimento do boleto menor que a data limite para envio (" + Uteis.getData(Uteis.obterDataFutura(new Date(), controleRemessa.getContaCorrenteVO().getQtdDiasBoletoVencido())) + "), configuração realizada no cadastro da Conta Corrente; ";
//					}
//				} else {
//					if (obj.getDataVencimento().before(Uteis.obterDataAntiga(new Date(), 1))) {
//						msgErro += "Data de Vencimento menor que data atual (" + Uteis.getData(new Date()) + "), configuração realizada no cadastro da Conta Corrente; ";
//					}
//				}
//			}
			if (obj.getValorComAcrescimo().doubleValue() < 0) {
				msgErro += "Valor menor que zero (0) (" + obj.getValorComAcrescimo() + "); ";
			}
			if (!msgErro.equals("")) {
				obj.setMotivoErro(msgErro);
				obj.setSituacaoControleRemessaContaReceber(SituacaoControleRemessaContaReceberEnum.ERRO_ENVIO);
			}
		} catch (Exception e) {
			obj.setSituacaoControleRemessaContaReceber(SituacaoControleRemessaContaReceberEnum.ERRO_ENVIO);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public boolean realizarVerificacaoTipoOrigemContaReceber(String tipoOrigem) {
		boolean eMatricula = false;
		if (tipoOrigem.equals("MAT")) {
			eMatricula = true;
		}
		return eMatricula;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public DescontoProgressivoVO realizarCriacaoDescontoProgressivoControleRemessa(ControleRemessaContaReceberVO dadosRemessaVO) {
		DescontoProgressivoVO descontoProgressivoVO = null;
		if (dadosRemessaVO.getDescontoprogressivo_codigo() != null && dadosRemessaVO.getDescontoprogressivo_codigo() > 0) {
			descontoProgressivoVO = new DescontoProgressivoVO();
			descontoProgressivoVO.setNovoObj(false);
			descontoProgressivoVO.setCodigo(dadosRemessaVO.getDescontoprogressivo_codigo());
			descontoProgressivoVO.setDiaLimite1(dadosRemessaVO.getDescontoprogressivo_dialimite1());
			descontoProgressivoVO.setDiaLimite2(dadosRemessaVO.getDescontoprogressivo_dialimite2());
			descontoProgressivoVO.setDiaLimite3(dadosRemessaVO.getDescontoprogressivo_dialimite3());
			descontoProgressivoVO.setDiaLimite4(dadosRemessaVO.getDescontoprogressivo_dialimite4());
			descontoProgressivoVO.setPercDescontoLimite1(dadosRemessaVO.getDescontoprogressivo_percdescontolimite1());
			descontoProgressivoVO.setPercDescontoLimite2(dadosRemessaVO.getDescontoprogressivo_percdescontolimite2());
			descontoProgressivoVO.setPercDescontoLimite3(dadosRemessaVO.getDescontoprogressivo_percdescontolimite3());
			descontoProgressivoVO.setPercDescontoLimite4(dadosRemessaVO.getDescontoprogressivo_valordescontolimite4());
			descontoProgressivoVO.setValorDescontoLimite1(dadosRemessaVO.getDescontoprogressivo_valordescontolimite1());
			descontoProgressivoVO.setValorDescontoLimite2(dadosRemessaVO.getDescontoprogressivo_valordescontolimite2());
			descontoProgressivoVO.setValorDescontoLimite3(dadosRemessaVO.getDescontoprogressivo_valordescontolimite3());
			descontoProgressivoVO.setValorDescontoLimite4(dadosRemessaVO.getDescontoprogressivo_valordescontolimite4());
			descontoProgressivoVO.setValorDescontoLimite4(dadosRemessaVO.getDescontoprogressivo_valordescontolimite4());
			descontoProgressivoVO.setUtilizarDiaFixo(dadosRemessaVO.getDescontoprogressivo_utilizaDiaFixo());
			descontoProgressivoVO.setUtilizarDiaUtil(dadosRemessaVO.getDescontoprogressivo_utilizaDiaUtil());
			descontoProgressivoVO.setDescontoProgressivoEditadoManualmenteContaReceber(dadosRemessaVO.getContareceber_contaEditadaManualmente() && dadosRemessaVO.getContareceber_utilizarDescontoProgressivoManual());
		}
		return descontoProgressivoVO;
	}

	/**
	 * Método responsavel por calcular o valor da diferença dos descontos sem validade e descontos com validade, caso o aluno possua descontos com validade. Será registrado no arquivo de remessa a data limite para aplicação dos descontos e o valor do desconto.
	 * 
	 * @param dadosRemessaVO
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void executarCalculoValorDiferencaContaDescontos(ControleRemessaContaReceberVO dadosRemessaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		List<PlanoDescontoVO> listaPlanoDesconto = new ArrayList<PlanoDescontoVO>(0);
		List<ConvenioVO> listaConvenios = new ArrayList<ConvenioVO>(0);
		boolean eMatricula = realizarVerificacaoTipoOrigemContaReceber(dadosRemessaVO.getTipoOrigem());
		dadosRemessaVO.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPlanoDescontoContaReceberParaGeracaoRemessa(dadosRemessaVO.getContaReceber()));
		DescontoProgressivoVO descontoProgressivoVO = realizarCriacaoDescontoProgressivoControleRemessa(dadosRemessaVO);
		for (PlanoDescontoContaReceberVO planoDescontoContaReceberVO : dadosRemessaVO.getPlanoDescontoContaReceberVOs()) {
			if (planoDescontoContaReceberVO.getIsConvenio()) {
				listaConvenios.add(planoDescontoContaReceberVO.getConvenio());
			} else {
				listaPlanoDesconto.add(planoDescontoContaReceberVO.getPlanoDescontoVO());
			}
		}
		Date dataVencimentoOriginal = dadosRemessaVO.getDataVencimento();
		if (configuracaoFinanceiroVO.getVencimentoParcelaDiaUtil()) {
			dadosRemessaVO.setDataVencimento(getFacadeFactory().getContaReceberFacade().obterDataVerificandoDiaUtil(dataVencimentoOriginal, dadosRemessaVO.getUnidadeEnsino().getCidade().getCodigo(), null));
		}
		Boolean aplicarCalculoComBaseDescontosCalculados = getFacadeFactory().getCondicaoPagamentoPlanoFinanceiroCursoFacade().consultarAplicarCalculoComBaseDescontosCalculadosPorContaReceber(dadosRemessaVO.getContaReceber(), null);
		String matricula = getFacadeFactory().getMatriculaFacade().consultarUltimaMatriculaAtivaPorContaReceber(dadosRemessaVO.getContaReceber());
		List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaPlanoFinanceiroAlunoDescricaoDescontos = executarGeracaoDescontosAplicaveisPlanoFinanceiroAluno(eMatricula,
				dadosRemessaVO.getValorBase(), dadosRemessaVO.getTipoDesconto(), dadosRemessaVO.getValorDescontoAluno(), dadosRemessaVO.getValorDescontoAluno(), dadosRemessaVO.getDescontoValidoAteDataParcela(),
				dadosRemessaVO.getDataVencimento(), dataVencimentoOriginal, dadosRemessaVO.getListaOrdemDescontoVOs(), descontoProgressivoVO, listaPlanoDesconto, listaConvenios, 0,
				dadosRemessaVO.getUsaDescontoCompostoPlanoDesconto(), configuracaoFinanceiroVO, false, null, matricula, aplicarCalculoComBaseDescontosCalculados, dadosRemessaVO.getUnidadeEnsino().getCidade().getCodigo());
		// GERA OS DESCONTOS SEPARANDO OS DESCONTOS COM VALIDADE E SEM VALIDADE
		// List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaPlanoFinanceiroAlunoDescricaoDescontos = executarGeracaoDescontosAplicaveisPlanoFinanceiroAlunoRemessaBancaria(null, eMatricula, dadosRemessaVO.getValorBase(), dadosRemessaVO.getTipoDesconto(), dadosRemessaVO.getValorDescontoAluno(), dadosRemessaVO.getValorDescontoAluno(), dadosRemessaVO.getDataVencimento(), dadosRemessaVO.getDataVencimento(), dadosRemessaVO.getListaOrdemDescontoVOs(), descontoProgressivoVO, listaPlanoDesconto, listaConvenios, 0, dadosRemessaVO.getUsaDescontoCompostoPlanoDesconto(),
		// configuracaoFinanceiroVO.getVencimentoDescontoProgressivoDiaUtil(), false, null, "", false, dadosRemessaVO.getDescontoValidoAteDataParcela(), dadosRemessaVO.getValorDescontoRateio());
		adicionarDescontoRateioEmPlanoFinanceiroAlunoDescricaoDescontosVO(listaPlanoFinanceiroAlunoDescricaoDescontos, dadosRemessaVO.getValorBase(), 0.0, dadosRemessaVO.getValorDescontoRateio(), dadosRemessaVO.getDataVencimento(), dadosRemessaVO.getDataVencimento());
		if (configuracaoFinanceiroVO.getGerarBoletoComDescontoSemValidade()) {
			int cont = 0;
			for (PlanoFinanceiroAlunoDescricaoDescontosVO planoFinanceiroAlunoDescontoVO : listaPlanoFinanceiroAlunoDescricaoDescontos) {
				// PlanoFinanceiroAlunoDescricaoDescontosVO planoFinanceiroAlunoDescontoVO = null;
				// planoFinanceiroAlunoDescontoVO = (PlanoFinanceiroAlunoDescricaoDescontosVO) listaPlanoFinanceiroAlunoDescricaoDescontos.get(0);
				if (cont == 0) {
					dadosRemessaVO.setValor(dadosRemessaVO.getValorBase() - (planoFinanceiroAlunoDescontoVO.getValorDescontoSemValidade()));
					dadosRemessaVO.setValorDescontoDataLimite(planoFinanceiroAlunoDescontoVO.getValorDescontoComValidade());
					dadosRemessaVO.setDataLimiteConcessaoDesconto(planoFinanceiroAlunoDescontoVO.getDataLimiteAplicacaoDesconto());
				} else if (cont == 1) {
					dadosRemessaVO.setValorDescontoDataLimite2(planoFinanceiroAlunoDescontoVO.getValorDescontoComValidade());
					dadosRemessaVO.setDataLimiteConcessaoDesconto2(planoFinanceiroAlunoDescontoVO.getDataLimiteAplicacaoDesconto());
				} else if (cont == 2) {
					dadosRemessaVO.setValorDescontoDataLimite3(planoFinanceiroAlunoDescontoVO.getValorDescontoComValidade());
					dadosRemessaVO.setDataLimiteConcessaoDesconto3(planoFinanceiroAlunoDescontoVO.getDataLimiteAplicacaoDesconto());
				}
				cont++;
			}
		} else {
			int cont = 0;
			for (PlanoFinanceiroAlunoDescricaoDescontosVO planoFinanceiroAlunoDescontoVO : listaPlanoFinanceiroAlunoDescricaoDescontos) {
				if (cont == 0) {
					dadosRemessaVO.setValor(dadosRemessaVO.getValorBase());
					dadosRemessaVO.setValorDescontoDataLimite(planoFinanceiroAlunoDescontoVO.getValorDescontoComValidade());
					dadosRemessaVO.setDataLimiteConcessaoDesconto(planoFinanceiroAlunoDescontoVO.getDataLimiteAplicacaoDesconto());
					dadosRemessaVO.setValorAbatimento(planoFinanceiroAlunoDescontoVO.getValorDescontoSemValidade());
				} else if (cont == 1) {
					dadosRemessaVO.setValorDescontoDataLimite2(planoFinanceiroAlunoDescontoVO.getValorDescontoComValidade());
					dadosRemessaVO.setDataLimiteConcessaoDesconto2(planoFinanceiroAlunoDescontoVO.getDataLimiteAplicacaoDesconto());
				} else if (cont == 2) {
					dadosRemessaVO.setValorDescontoDataLimite3(planoFinanceiroAlunoDescontoVO.getValorDescontoComValidade());
					dadosRemessaVO.setDataLimiteConcessaoDesconto3(planoFinanceiroAlunoDescontoVO.getDataLimiteAplicacaoDesconto());
				}
				cont++;
			}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarDataArquivoRemessa(List<ControleRemessaContaReceberVO> dadosRemessaVOs, Date dataArquivoRemessa, UsuarioVO usuario) throws Exception {
		StringBuilder sql = new StringBuilder(" UPDATE contaReceber SET dataArquivoRemessa = '");
		sql.append(Uteis.getDataJDBC(dataArquivoRemessa)).append("' WHERE codigo in ( ");
		StringBuilder sbIn = new StringBuilder("");
		dadosRemessaVOs.stream()
		.filter(p-> (p.getApresentarArquivoRemessa() && p.getContaReceber().intValue() != 0))
		.forEach(p->UteisTexto.addCampoParaClausaIn(sbIn, p.getContaReceber().toString()));
		if(!sbIn.toString().isEmpty()){
			sql.append(sbIn.toString()).append(" ) ");
			sql.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
			getConexao().getJdbcTemplate().update(sql.toString());		
		}
	}

	/**
	 * Responsável por executar a criação do vínculo de conta receber com turma, levando em consideração se a turma não está preenchida e que se a contareceber está vínculada a alguma matrícula periodo, ele utiliza a turma dela, caso não esteja vículada a matrícula período e esteja vínculada a matrícula ele traz a turma da última matrícula período ativa
	 * 
	 * @author Wellington Rodrigues - 09/04/2015
	 * @param contaReceber
	 * @param usuarioLogado
	 * @throws Exception
	 */
	private void executarCriacaoVinculoContaReceberComTurma(ContaReceberVO contaReceber, UsuarioVO usuarioLogado) throws Exception {
		if (!Uteis.isAtributoPreenchido(contaReceber.getTurma())) {
			if (contaReceber.getTipoAluno() || contaReceber.getTipoResponsavelFinanceiro() || contaReceber.getTipoParceiro()) {
				MatriculaPeriodoVO ultimaMatriculaPeriodoAtiva = new MatriculaPeriodoVO();
				if (Uteis.isAtributoPreenchido(contaReceber.getMatriculaPeriodo())) {
					ultimaMatriculaPeriodoAtiva = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(contaReceber.getMatriculaPeriodo(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, null, usuarioLogado);
				} else {
					ultimaMatriculaPeriodoAtiva = getFacadeFactory().getMatriculaPeriodoFacade().consultaRapidaBasicaUltimaMatriculaPeriodoPorMatriculaOrdenandoPorAnoSemestrePeriodoLetivo(contaReceber.getMatriculaAluno().getMatricula(), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioLogado);
				}
				contaReceber.setTurma(ultimaMatriculaPeriodoAtiva.getTurma());

			} else {
				contaReceber.setTurma(getFacadeFactory().getTurmaFacade().consultaRapidaPorMatriculaUltimaMatriculaPeriodo(contaReceber.getMatriculaAluno().getMatricula(), usuarioLogado));
			}
		}
	}

	private void executarCriacaoVinculoContaReceberComCodigoOrigem(ContaReceberVO contaReceber, UsuarioVO usuarioLogado) throws Exception {
		if (contaReceber.isContaReceberReferenteMaterialDidatico()) {
			MatriculaPeriodoVO ultimaMatriculaPeriodoAtiva = getFacadeFactory().getMatriculaPeriodoFacade().consultaRapidaBasicaUltimaMatriculaPeriodoPorMatriculaOrdenandoPorAnoSemestrePeriodoLetivo(contaReceber.getMatriculaAluno().getMatricula(), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioLogado);
			contaReceber.setCodOrigem(ultimaMatriculaPeriodoAtiva.getCodigo().toString());
		}
	}

	public boolean consultarExistenciaContaGeradaVinculadaOutraContaCorrente(Integer turma, Integer contaCorrente, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("select contareceber.codigo from contareceber ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		sb.append(" where matriculaperiodo.turma = ").append(turma);
		sb.append(" and contacorrente <> ").append(contaCorrente);
		sb.append(" and contareceber.situacao = 'AR' ");
		return getConexao().getJdbcTemplate().queryForRowSet(sb.toString()).next();
	}

	@Override
	public Double consultarValorDevedorBibliotecaPorPessoa(Integer codigoPessoa) {
		StringBuilder sb = new StringBuilder();
		sb.append("select sum(valorrecebercalculado) as valorrecebercalculado from contareceber where tipoOrigem = 'BIB' and situacao = 'AR' and pessoa = ").append(codigoPessoa);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getDouble("valorrecebercalculado");
		}
		return 0.0;
	}

	@Override
	public void realizarCriacaoContaReceberMultaBiblioteca(EmprestimoVO emprestimoVO, List<ItemEmprestimoVO> listaItensEmprestimo, ConfiguracaoBibliotecaVO configuracaoBibliotecaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UnidadeEnsinoVO unidadeEnsinoVO, UsuarioVO usuarioVO) throws Exception {
		Double valorMulta = getFacadeFactory().getEmprestimoFacade().realizarCalculoMultaDevolucaoEmprestimo(listaItensEmprestimo, emprestimoVO.getPessoa().getCodigo(), TipoPessoa.getEnum(emprestimoVO.getTipoPessoa()), true, configuracaoBibliotecaVO, emprestimoVO.getBiblioteca().getCidade(), usuarioVO);
		if (Uteis.isAtributoPreenchido(valorMulta)) {
			String descricaoMulta = "";
			Integer emprestimo = listaItensEmprestimo.get(0).getEmprestimo().getCodigo();
			for (ItemEmprestimoVO ie : listaItensEmprestimo) {
				descricaoMulta += UteisJSF.internacionalizar("msg_ContaReceber_descricaoMultaBiblioteca").replace("{0}", ie.getExemplar().getCodigoBarra().toString()).replace("{1}", ie.getExemplar().getCatalogo().getTitulo()).replace("{2}", ie.getEmprestimo().getData_Apresentar()).replace("{3}", ie.getDataPrevisaoDevolucao_Apresentar()).replace("{4}", ie.getDataDevolucao_Apresentar()) + "\n";
			}
			ContaReceberVO contaReceberVO = new ContaReceberVO();
			contaReceberVO.getPessoa().setCodigo(emprestimoVO.getPessoa().getCodigo());
			contaReceberVO.setCodOrigem(emprestimo.toString());
			contaReceberVO.setDescricaoPagamento(descricaoMulta);
			contaReceberVO.setTipoOrigem("BIB");
			contaReceberVO.setTipoBoleto(TipoBoletoBancario.BIBLIOTECA.getValor());
			Integer numeroParcela = consultarParcelaPorCodOrigemTipoOrigem("BIB", emprestimo, false, configuracaoFinanceiroVO, usuarioVO) + 1;
			contaReceberVO.setParcela(numeroParcela.toString());
			contaReceberVO.setValor(valorMulta);
			contaReceberVO.setValorBaseContaReceber(valorMulta);			
			contaReceberVO.setData(new Date());
			Integer diasVencimento = 0;
			contaReceberVO.setTipoPessoa(emprestimoVO.getTipoPessoa());
			if (emprestimoVO.getTipoPessoa().equals(TipoPessoa.ALUNO.getValor()) || emprestimoVO.getTipoPessoa().equals(TipoPessoa.RESPONSAVEL_FINANCEIRO.getValor())) {
				contaReceberVO.setTipoPessoa(emprestimoVO.getTipoPessoa());
				contaReceberVO.getMatriculaAluno().setMatricula(emprestimoVO.getMatricula().getMatricula());
				contaReceberVO.setMatriculaAluno(getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(emprestimoVO.getMatricula().getMatricula(), null, NivelMontarDados.BASICO, usuarioVO));
				diasVencimento = configuracaoBibliotecaVO.getQtdeDiaVencimentoMultaAluno();
				contaReceberVO.getUnidadeEnsino().setCodigo(contaReceberVO.getMatriculaAluno().getUnidadeEnsino().getCodigo());
				contaReceberVO.setMatriculaPeriodo(getFacadeFactory().getMatriculaPeriodoFacade().consultaCodigoUltimaMatriculaPeriodoPorMatricula(contaReceberVO.getMatriculaAluno().getMatricula(), false, usuarioVO));
			} else if (emprestimoVO.getTipoPessoa().equals(TipoPessoa.FUNCIONARIO.getValor())) {
				contaReceberVO.setTipoPessoa(emprestimoVO.getTipoPessoa());
				contaReceberVO.setFuncionario(getFacadeFactory().getFuncionarioFacade().consultarPorCodigoPessoa(emprestimoVO.getPessoa().getCodigo(), 0, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO));
				contaReceberVO.getUnidadeEnsino().setCodigo(unidadeEnsinoVO.getCodigo());
				diasVencimento = configuracaoBibliotecaVO.getQtdeDiaVencimentoMultaFuncionario();
			} else if (emprestimoVO.getTipoPessoa().equals(TipoPessoa.PROFESSOR.getValor())) {
				contaReceberVO.setTipoPessoa(TipoPessoa.FUNCIONARIO.getValor());
				contaReceberVO.setFuncionario(getFacadeFactory().getFuncionarioFacade().consultarPorCodigoPessoa(emprestimoVO.getPessoa().getCodigo(), 0, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO));
				contaReceberVO.getUnidadeEnsino().setCodigo(unidadeEnsinoVO.getCodigo());
				diasVencimento = configuracaoBibliotecaVO.getQtdeDiaVencimentoMultaProfessor();
			} else if (emprestimoVO.getTipoPessoa().equals(TipoPessoa.MEMBRO_COMUNIDADE.getValor())) {
				contaReceberVO.setTipoPessoa(TipoPessoa.RESPONSAVEL_FINANCEIRO.getValor());
				contaReceberVO.setPessoa(null);
				contaReceberVO.setResponsavelFinanceiro(emprestimoVO.getPessoa());
				contaReceberVO.getUnidadeEnsino().setCodigo(unidadeEnsinoVO.getCodigo());
				diasVencimento = configuracaoBibliotecaVO.getQtdeDiaVencimentoMultaVisitante();
			} else {
				contaReceberVO.setTipoPessoa(emprestimoVO.getTipoPessoa());
			}
			if (diasVencimento == 0) {
				contaReceberVO.setDataVencimento(new Date());
				contaReceberVO.setDataCompetencia(Uteis.getDataPrimeiroDiaMes(new Date()));
			} else {
				contaReceberVO.setDataVencimento(Uteis.obterDataFuturaMesContabilConsiderandoDiaInicial(new Date(), diasVencimento));
				contaReceberVO.setDataCompetencia(Uteis.getDataPrimeiroDiaMes(Uteis.obterDataFuturaMesContabilConsiderandoDiaInicial(new Date(), diasVencimento)));
			}
			contaReceberVO.setConfiguracaoFinanceiro(configuracaoFinanceiroVO);
			contaReceberVO.getCentroReceita().setCodigo(configuracaoFinanceiroVO.getCentroReceitaBibliotecaPadrao().getCodigo());
			contaReceberVO.setUnidadeEnsino(getAplicacaoControle().getUnidadeEnsinoVO(contaReceberVO.getUnidadeEnsino().getCodigo(), usuarioVO));
			if (Uteis.isAtributoPreenchido(contaReceberVO.getUnidadeEnsino().getContaCorrentePadraoBiblioteca())) {
				contaReceberVO.setContaCorrente(contaReceberVO.getUnidadeEnsino().getContaCorrentePadraoBiblioteca());
			} else {
				contaReceberVO.setContaCorrente(configuracaoFinanceiroVO.getContaCorrentePadraoBiblioteca());
			}
			contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(valorMulta);
			contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(valorMulta);
			contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(valorMulta);
			contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(valorMulta);
			incluir(contaReceberVO, false, configuracaoFinanceiroVO, usuarioVO);
			getFacadeFactory().getItemEmprestimoFacade().executarVinculoDaContaReceberParaItemEmprestimo(listaItensEmprestimo, contaReceberVO.getCodigo(), usuarioVO);
		}
	}

	@Override
	public void realizarVinculoContaReceberComResponsavelFinanceiro(ContaReceberVO contaReceberVO, UsuarioVO usuarioLogado) throws Exception {
		if (contaReceberVO.getTipoAluno()) {
			PessoaVO responsavelFinanceiro = getFacadeFactory().getPessoaFacade().consultarResponsavelFinanceiroAluno(contaReceberVO.getPessoa().getCodigo(), usuarioLogado);
			if (responsavelFinanceiro != null) {
				contaReceberVO.setResponsavelFinanceiro(responsavelFinanceiro);
				contaReceberVO.setTipoPessoa(TipoPessoa.RESPONSAVEL_FINANCEIRO.getValor());
			}
		}
	}

	public void realizarVinculoContaReceberComTurma(ContaReceberVO contaReceber, UsuarioVO usuarioLogado) throws Exception {
		TurmaVO turma = null;
		if (!contaReceber.getTipoOrigem().equals("IRE") && contaReceber.getTurma().getCodigo().intValue() == 0) {
			if (!contaReceber.getMatriculaAluno().getMatricula().equals("")) {
				turma = getFacadeFactory().getTurmaFacade().consultaRapidaPorMatriculaUltimaMatriculaPeriodo(contaReceber.getMatriculaAluno().getMatricula(), usuarioLogado);
				if (turma != null) {
					contaReceber.setTurma(turma);
				}
			}
		}
	}

	@Override
	public List<ContaReceberVO> consultarPorResponsavelFinanceiroVisaoPais(String situacao, Integer pais, Integer filho, String matriculaAluno, Integer unidadeEnsino, List<String> listaTipoOrigemDesconsiderar, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario, Integer limite, Integer offset, DataModelo dataModelo , boolean permiteVisualizarParcelasPeriodoContratosEletronico , List<Integer> matriculaPeriodosContratosPendenteRejeitado) throws Exception {
		String sqlStr = getSQLPadraoConsultaBasica().toString();
		if (!situacao.equalsIgnoreCase("MB")) {
			sqlStr = getSQLPadraoConsultaBasica().toString().replace("SELECT", "SELECT distinct ");
		}
		sqlStr += " left JOIN matriculaPeriodo ON matriculaPeriodo.codigo = contareceber.matriculaperiodo ";
		if (situacao.equalsIgnoreCase("EM")) {
			sqlStr += "AND MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ";
		}

		sqlStr += " WHERE ";
		if (pais != null && matriculaAluno != null) {
			sqlStr += " ( contareceber.responsavelFinanceiro = " + pais + " or ( matricula.matricula ) = ('" + matriculaAluno + "') )";
		} else if (pais != null && filho != null) {
			sqlStr += " ( contareceber.responsavelFinanceiro = " + pais + " or (contareceber.pessoa ) = (" + filho + ") )";
		} else {
			sqlStr += " contareceber.responsavelFinanceiro = " + pais;
		}
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " and ContaReceber.unidadeensinofinanceira  = (" + unidadeEnsino + ") ";
		}
		if (situacao.equalsIgnoreCase("EM")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' ";			
			if (!configuracaoFinanceiroVO.getPermitiVisualizarContaReceberVisaoAlunoPreMatricula()) {
				sqlStr += (" AND CASE WHEN matriculaperiodo.codigo is not null THEN MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ELSE true END");
			}
			if (!configuracaoFinanceiroVO.getPermitiVisualizarContaReceberVisaoAlunoPreMatricula()) {
				sqlStr += (" AND CASE WHEN matriculaperiodo.codigo is not null THEN MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ELSE true END");
			}
			sqlStr += getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO);
		}
		if (situacao.equalsIgnoreCase("VE")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' AND dataVencimento <= '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (situacao.equalsIgnoreCase("AV")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' AND dataVencimento > '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (situacao.equalsIgnoreCase("PG")) {
			sqlStr += "AND ContaReceber.situacao = 'RE' ";
		}
		if (situacao.equalsIgnoreCase("NE")) {
			sqlStr += "AND ContaReceber.situacao = 'NE' ";
		}
		if (situacao.equalsIgnoreCase("MB")) {
			sqlStr += (" AND ((ContaReceber.situacao = 'AR'");
			if (!configuracaoFinanceiroVO.getPermitiVisualizarContaReceberVisaoAlunoPreMatricula()) {
				sqlStr += (" AND CASE WHEN matriculaperiodo.codigo is not null THEN MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ELSE true END");
			}
			sqlStr += getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO);
			sqlStr += (" ) ");
			sqlStr += (" or (ContaReceber.situacao = 'RE'))");
		}
		if (situacao.equalsIgnoreCase("MA")) {
			sqlStr += " AND ContaReceber.situacao = 'AR'";
			sqlStr += " AND contareceber.datavencimento >= '";
			sqlStr += Uteis.getDataJDBC(Uteis.getDataPrimeiroDiaMes(new Date()));
			sqlStr += "' and contareceber.datavencimento <= '";
			sqlStr += Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(new Date()));
			sqlStr += "'";
			sqlStr += getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO);
		}
		if (situacao.equalsIgnoreCase("TO")) {
			sqlStr += getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO);
		}
		if (Uteis.isAtributoPreenchido(listaTipoOrigemDesconsiderar)) {
			sqlStr += listaTipoOrigemDesconsiderar.stream().collect(Collectors.joining("', '", " AND contareceber.tipoorigem not in ('", "') "));
		}
		if (Uteis.isAtributoPreenchido(matriculaPeriodosContratosPendenteRejeitado) && !permiteVisualizarParcelasPeriodoContratosEletronico) {
			sqlStr += matriculaPeriodosContratosPendenteRejeitado.stream().map(p-> String.valueOf(p)).collect(Collectors.joining("', '", " AND contareceber.matriculaperiodo not in ('", "') "));
		}
		if (situacao.equalsIgnoreCase("MB")) {
			sqlStr += " order by";
			sqlStr += " case when ContaReceber.situacao = 'AR' then 0";
			sqlStr += " else 1 end, contareceber.datavencimento ";
		} else {
			sqlStr += " ORDER BY dataVencimento";			
		}
		if (limite != null && offset != null) {
			sqlStr += " limit ";
			sqlStr += limite.intValue();
			sqlStr += " offset ";
			sqlStr += offset.intValue();
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		realizarMontagemTotalizadoresContaReceber(tabelaResultado, dataModelo);
		List<ContaReceberVO> listaConsulta = (montarDadosConsultaBasica(tabelaResultado));
		for (ContaReceberVO obj : listaConsulta) {
			obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
			if (!obj.getSituacaoEQuitada()) {
				montarListaDescontosAplicaveisContaReceber(obj, new Date(), obj.getUsaDescontoCompostoPlanoDesconto(), configuracaoFinanceiroVO, usuario, null);
			}
		}
		return listaConsulta;
	}

	@Override
	public List<ContaReceberVO> consultaRapidaPorMatriculaEUnidadeEnsinoVisaoPais(Integer pais, Integer filho, String matricula, String situacao, Integer unidadeEnsino, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, int nivelMontarDados, UsuarioVO usuario, Integer limite, Integer offset, DataModelo dataModelo) throws Exception {
		// StringBuilder sqlStr = getSQLPadraoConsultaCompleta();

		/*
		 * Regra alterada porque a consulta apresentava mais de um registro para uma conta recebida com mais de uma forma de pagamento, o resultado apresentava em duplicidade por conta da tabela contareceberrecebimento.
		 */
		StringBuilder sqlStr = getSQLPadraoConsultaCompletaSemContaReceberRecebimento();

		sqlStr.append(" WHERE ");
		if (pais != null && matricula != null) {
			sqlStr.append(" ( contareceber.responsavelFinanceiro = " + pais + " or ( matricula.matricula ) = ('" + matricula + "') )");
		} else if (pais != null && filho != null) {
			sqlStr.append(" ( contareceber.responsavelFinanceiro = " + pais + " or (contareceber.pessoa ) = (" + filho + ") )");
		} else {
			sqlStr.append(" contareceber.responsavelFinanceiro = " + pais);
		}
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append(" AND unidadeEnsino.codigo = ");
			sqlStr.append(unidadeEnsino);
		}
		if (situacao.equals("EM")) {
			sqlStr.append(" AND contareceber.situacao = 'AR' ");
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		if (situacao.equals("PG")) {
			sqlStr.append(" AND contareceber.situacao = 'RE' ");
		}
		
		if (situacao.equals("MB")) {
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		
		if (situacao.equalsIgnoreCase("MA")) {
			sqlStr.append(" AND ContaReceber.situacao = 'AR'");
			sqlStr.append(" AND contareceber.datavencimento >= '").append(Uteis.getDataJDBC(Uteis.getDataPrimeiroDiaMes(new Date()))).append("' and contareceber.datavencimento <= '").append(Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(new Date()))).append("'");
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		if (situacao.equalsIgnoreCase("TO")) {
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		if (situacao.equalsIgnoreCase("MB")) {
			sqlStr.append(" order by");
			sqlStr.append(" case when ContaReceber.situacao = 'AR' then 0");
			sqlStr.append(" else 1 end, contareceber.datavencimento ");
		} else {
			sqlStr.append(" ORDER BY dataVencimento");			
		}
		if (limite != null && offset != null) {
			sqlStr.append(" limit ").append(limite.intValue());
			sqlStr.append(" offset ").append(offset.intValue());
		}		
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		realizarMontagemTotalizadoresContaReceber(resultado, dataModelo);
		return montarDadosConsultaCompletaSemRecebimento(resultado, configuracaoFinanceiroVO, nivelMontarDados, usuario);
	}

	public List consultarUnidadeEnsinoFinanceiraDaContaReceberPorMatriculaOuResponsavelFinanceiro(String valorConsulta, String matricula, Integer responsavelFinanceiro, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sql = new StringBuilder("");
		sql.append("SELECT distinct unidadeEnsinoFinanceira.codigo AS \"unidadeEnsinoFinanceira.codigo\", unidadeEnsinoFinanceira.nome AS \"unidadeEnsinoFinanceira.nome\" ");
		sql.append("FROM contareceber ");
		sql.append("LEFT JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		if (Uteis.isAtributoPreenchido(matricula)) {
			sql.append(" WHERE ContaReceber.matriculaAluno = '").append(matricula).append("' ");
		} else {
			sql.append(" WHERE responsavelFinanceiro.codigo = ").append(responsavelFinanceiro).append(" ");
		}
		montarFiltrosParaConsultarRenegocicaoContaReceber(sql, valorConsulta, unidadeEnsino, configuracaoFinanceiroVO, usuario);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		List<ContaReceberVO> listaConsulta = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.getUnidadeEnsinoFinanceira().setCodigo(tabelaResultado.getInt("unidadeEnsinoFinanceira.codigo"));
			obj.getUnidadeEnsinoFinanceira().setNome(tabelaResultado.getString("unidadeEnsinoFinanceira.nome"));
			listaConsulta.add(obj);
		}
		return listaConsulta;
	}
	
	@Override
	public void verificarPermissaoNegociacaoContaReceber(List<ContaReceberVO> listaTemp, UsuarioVO usuarioLogado) throws Exception {
		if (!listaTemp.isEmpty()) {
			List<ContaReceberVO> listaContaReceberNRCTipoOrigemNCR = listaTemp.stream().filter(c -> c.getTipoOrigem().equals("NCR")).collect(Collectors.toList());
			if (!listaContaReceberNRCTipoOrigemNCR.isEmpty()) {
				for (ContaReceberVO obj : listaContaReceberNRCTipoOrigemNCR) {
					boolean isTemPermissao = getFacadeFactory().getNegociacaoContaReceberFacade().validarPermissaoNegociacarParcelaNegociadaNaoCumprida(obj, usuarioLogado);
					if (!isTemPermissao) {
						listaTemp.remove(obj);
					}
				}
			}
			listaTemp.removeIf(this::validarPermissaoNegociarContaReceberVinculadaParceiro);
		}
	}

	public List consultarPorMatriculaEUnidadeEnsino(String valorConsulta, String matricula, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder(getSQLPadraoConsultaBasica().toString());
		sqlStr.append(" WHERE ContaReceber.matriculaAluno = '").append(matricula).append("'");
		montarFiltrosParaConsultarRenegocicaoContaReceber(sqlStr, valorConsulta, unidadeEnsino, configuracaoFinanceiroVO, usuario);
		sqlStr.append(" and not exists ( ");
		sqlStr.append(" select registronegativacaocobrancacontareceberitem.codigo from registronegativacaocobrancacontareceberitem "); 
		sqlStr.append(" inner join  registronegativacaocobrancacontareceber  ");
		sqlStr.append(" on registronegativacaocobrancacontareceber.codigo = registronegativacaocobrancacontareceberitem.registronegativacaocobrancacontareceber ");
		sqlStr.append(" where registronegativacaocobrancacontareceberitem.contareceber = contareceber.codigo ");
//		sqlStr.append(" and tipoagente  = '").append(TipoAgenteNegativacaoCobrancaContaReceberEnum.COBRANCA.name()).append("' ");
		sqlStr.append(" and registronegativacaocobrancacontareceberitem.dataexclusao is null ) ");
		
		sqlStr.append(" ORDER BY ContaReceber.dataVencimento");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<ContaReceberVO> listaConsulta = (montarDadosConsultaBasica(tabelaResultado));
		montarDadosPlanoDescontoContaReceber(listaConsulta, configuracaoFinanceiroVO, usuario);
		return listaConsulta;
	}

	@Override
	public List consultarContaReceberRenegociacaoResponsavelFinanceiro(String valorConsulta, Integer responsavelFinanceiro, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder(getSQLPadraoConsultaBasica().toString().replace("SELECT", "SELECT distinct "));
		sqlStr.append(" WHERE responsavelFinanceiro.codigo = ").append(responsavelFinanceiro).append(" ");
		montarFiltrosParaConsultarRenegocicaoContaReceber(sqlStr, valorConsulta, unidadeEnsino, configuracaoFinanceiroVO, usuario);
		sqlStr.append(" and not exists ( ");
		sqlStr.append(" select registronegativacaocobrancacontareceberitem.codigo from registronegativacaocobrancacontareceberitem "); 
		sqlStr.append(" inner join  registronegativacaocobrancacontareceber  ");
		sqlStr.append(" on registronegativacaocobrancacontareceber.codigo = registronegativacaocobrancacontareceberitem.registronegativacaocobrancacontareceber ");
		sqlStr.append(" where registronegativacaocobrancacontareceberitem.contareceber = contareceber.codigo ");
//		sqlStr.append(" and tipoagente  = '").append(TipoAgenteNegativacaoCobrancaContaReceberEnum.COBRANCA.name()).append("' ");
		sqlStr.append(" and registronegativacaocobrancacontareceberitem.dataexclusao is null ) ");
		
		sqlStr.append(" ORDER BY ContaReceber.dataVencimento");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<ContaReceberVO> listaConsulta = (montarDadosConsultaBasica(tabelaResultado));
		montarDadosPlanoDescontoContaReceber(listaConsulta, configuracaoFinanceiroVO, usuario);
		return listaConsulta;
	}

	private void montarFiltrosParaConsultarRenegocicaoContaReceber(StringBuilder sqlStr, String valorConsulta, Integer unidadeEnsino, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) {
		if (unidadeEnsino.intValue() != 0) {
			sqlStr.append(" and ContaReceber.unidadeensinofinanceira  = ").append(unidadeEnsino).append(" ");
		}
		if (valorConsulta.equalsIgnoreCase("VE")) {
			sqlStr.append("AND ContaReceber.situacao = 'AR' AND ContaReceber.dataVencimento < '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("' ");
		}
		if (valorConsulta.equalsIgnoreCase("AM") || valorConsulta.equalsIgnoreCase("AR")) {
			sqlStr.append("AND ContaReceber.situacao = 'AR'");
		}

		if (valorConsulta.equalsIgnoreCase("PG")) {
			sqlStr.append("AND ContaReceber.situacao = 'RE' ");
		}
		if (usuario.getIsApresentarVisaoPais() || usuario.getIsApresentarVisaoAluno()) {
			sqlStr.append("AND ContaReceber.tipoOrigem not in ('").append(TipoOrigemContaReceber.REQUERIMENTO.getValor());
			sqlStr.append("', '").append(TipoOrigemContaReceber.INSCRICAO_PROCESSO_SELETIVO.getValor());
			sqlStr.append("', '").append(TipoOrigemContaReceber.BOLSA_CUSTEADA_CONVENIO.getValor()).append("') ");
			sqlStr.append("AND ContaReceber.tipoOrigem in ('' ");
			if (configuracaoFinanceiroVO.getPermiteNegociarParcelaMatricula().booleanValue()) {
				sqlStr.append(",'").append(TipoOrigemContaReceber.MATRICULA.getValor()).append("' ");
			}
			if (configuracaoFinanceiroVO.getPermiteNegociarParcelaMensalidade().booleanValue()) {
				sqlStr.append(",'").append(TipoOrigemContaReceber.MENSALIDADE.getValor()).append("' ");
			}
			if (configuracaoFinanceiroVO.isPermiteNegociarParcelaMaterialDidatico()) {
				sqlStr.append(",'").append(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor()).append("' ");
			}
			if (configuracaoFinanceiroVO.getPermiteNegociarParcelaBiblioteca().booleanValue()) {
				sqlStr.append(",'").append(TipoOrigemContaReceber.BIBLIOTECA.getValor()).append("' ");
			}
			if (configuracaoFinanceiroVO.getPermiteNegociarParcelaOutras().booleanValue()) {
				sqlStr.append(",'").append(TipoOrigemContaReceber.OUTROS.getValor()).append("' ");
			}
			if (configuracaoFinanceiroVO.getPermiteNegociarParcelaContratoReceita().booleanValue()) {
				sqlStr.append(",'").append(TipoOrigemContaReceber.CONTRATO_RECEITA.getValor()).append("' ");
			}
			if (configuracaoFinanceiroVO.getPermiteNegociarParcelaDevolucaoCheque().booleanValue()) {
				sqlStr.append(",'").append(TipoOrigemContaReceber.DEVOLUCAO_CHEQUE.getValor()).append("' ");
			}
			if (configuracaoFinanceiroVO.getPermiteNegociarParcelaNegociacao().booleanValue()) {
				sqlStr.append(",'").append(TipoOrigemContaReceber.NEGOCIACAO.getValor()).append("' ");
			}
			if (configuracaoFinanceiroVO.getPermiteNegociarParcelaInclusaoReposicao().booleanValue()) {
				sqlStr.append(",'").append(TipoOrigemContaReceber.INCLUSAOREPOSICAO.getValor()).append("' ");
			}
			sqlStr.append(") ");
		}

	}

	private void montarDadosPlanoDescontoContaReceber(List<ContaReceberVO> listaConsulta, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		for (ContaReceberVO obj : listaConsulta) {
			obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
			if (!obj.getSituacaoEQuitada()) {
				montarListaDescontosAplicaveisContaReceber(obj, new Date(), obj.getUsaDescontoCompostoPlanoDesconto(), configuracaoFinanceiroVO, usuario, null);
			}
		}
	}

	@Override
	public String validarDadosExisteContaReceberRenegociadadaQueNaoCumpriuAcordo(String matriculaAluno, String nomeAluno) {
		StringBuilder sb = new StringBuilder("");
		try {
			sb.append(" select sum(existePrimeiraPagamento) as existePrimeiraPagamento, sum(existeTodosPagamentos) as existeTodosPagamentos from (");
			sb.append(" select count(codigo) as existePrimeiraPagamento, 0 as existeTodosPagamentos from contareceber inner join (");
			sb.append(" select MIN(ContaReceber.dataVencimento) as dataVencimento, ContaReceber.codOrigem from ContaReceber where tipoOrigem = 'NCR' and codOrigem in (");
			sb.append(" select distinct(negociacaoContaReceber)::varchar from ContaReceber inner join ContaReceberNegociado on ContaReceber.codigo = ContaReceberNegociado.contaReceber");
			sb.append(" inner join negociacaoContaReceber on negociacaoContaReceber.codigo = ContaReceberNegociado.negociacaoContaReceber");
			sb.append(" where ContaReceber.situacao = 'NE' and ContaReceber.matriculaAluno = '" + matriculaAluno + "' and liberarRenovacaoAposPagamentoPrimeiraParcela = true )");
			sb.append(" group by ContaReceber.codOrigem) as t on t.codOrigem = contareceber.codOrigem and tipoOrigem = 'NCR' and t.dataVencimento = contareceber.dataVencimento");
			sb.append(" and contareceber.situacao = 'AR'");
			sb.append(" union");
			sb.append(" select 0 as existePrimeiraPagamento, count(codigo) as existeTodosPagamentos from ContaReceber where tipoOrigem = 'NCR' and codOrigem in (");
			sb.append(" select distinct(negociacaoContaReceber)::varchar from ContaReceber inner join ContaReceberNegociado on ContaReceber.codigo = ContaReceberNegociado.contaReceber");
			sb.append(" inner join negociacaoContaReceber on negociacaoContaReceber.codigo = ContaReceberNegociado.negociacaoContaReceber");
			sb.append(" where ContaReceber.situacao = 'NE' and ContaReceber.matriculaAluno = '" + matriculaAluno + "' and liberarRenovacaoAposPagamentoTodasParcelas = true )");
			sb.append(" and ContaReceber.situacao = 'AR') as final");
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
			if (tabelaResultado.next()) {
				if (tabelaResultado.getInt("existePrimeiraPagamento") > 0) {
					return UteisJSF.internacionalizar("msg_RenegociacaoContaReceber_aguardandoPagamentoPrimeiraParcela").replace("NOME_ALUNO", nomeAluno.toUpperCase());
				}
				if (tabelaResultado.getInt("existeTodosPagamentos") > 0) {
					return UteisJSF.internacionalizar("msg_RenegociacaoContaReceber_aguardandoPagamentoTodasParcelas").replace("NOME_ALUNO", nomeAluno.toUpperCase());
				}
			}
			return "";
		} finally {
			sb = null;
		}

	}

	@Override
	public List<ContaReceberVO> consultarContaReceberNotificarVencimentoConta() throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append(" SELECT contareceber.codigo, contareceber.updated, contareceber.tipopessoa, contareceber.pessoa, pessoa.nome AS \"Pessoa.nome\", pessoa.email AS \"Pessoa.email\", pessoa.celular AS \"Pessoa.celular\", ");
		sql.append(" contareceber.codigobarra, contareceber.linhadigitavelcodigobarras, contareceber.dataVencimento, contareceber.tipoorigem, ");
		sql.append(" contareceber.responsavelFinanceiro, funcionario.codigo AS \"Funcionario.codigo\", ");
		sql.append(" pessoafuncionario.nome AS \"pessoaFuncionario.nome\", pessoafuncionario.codigo AS \"pessoaFuncionario.codigo\", pessoafuncionario.email as \"pessoaFuncionario.email\", pessoafuncionario.celular as \"pessoaFuncionario.celular\", ");
		sql.append(" responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.email as \"responsavelFinanceiro.email\", responsavelFinanceiro.celular as \"responsavelFinanceiro.celular\", "); //
		sql.append(" configuracoes.codigo AS \"configuracoes.codigo\" ");
		sql.append(" ,contareceber.parcela, funcionariounidade.email as funcionariounidadeemail, unidadeensino.codigo as unidadeensino, unidadeensinofinanceira.codigo as unidadeensinofinanceira ");
		sql.append(" FROM contareceber ");
		sql.append(" inner JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sql.append(" inner JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sql.append(" inner join configuracoes on configuracoes.codigo = unidadeEnsinoFinanceira.configuracoes");
		sql.append(" inner join configuracaofinanceiro on configuracaofinanceiro.configuracoes = configuracoes.codigo");
		sql.append(" LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) ");
		sql.append(" LEFT JOIN pessoa AS pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sql.append(" LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo) ");
		sql.append(" LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sql.append(" left JOIN pessoa as funcionariounidade on unidadeEnsinoFinanceira.responsavelcobrancaunidade = funcionariounidade.codigo ");
		sql.append(" where contareceber.datavencimento::DATE - numeroDiasNotificarVencimentoContaReceber =  current_date and contareceber.situacao = 'AR' and contareceber.tipoPessoa in ('AL', 'RF', 'FU', 'RE') and numeroDiasNotificarVencimentoContaReceber > 0 ");
		SqlRowSet dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		List<ContaReceberVO> vetResultado = new ArrayList<ContaReceberVO>(0);
		while (dadosSQL.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(dadosSQL.getInt("codigo"));
			// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(dadosSQL.getInt("registrocobrancacontareceber"));
			obj.setUpdated(dadosSQL.getDate("updated"));
			obj.setCodigoBarra(dadosSQL.getString("codigobarra"));
			obj.setTipoPessoa(dadosSQL.getString("tipopessoa"));
			obj.getPessoa().setCodigo(dadosSQL.getInt("pessoa"));
			obj.getPessoa().setNome(dadosSQL.getString("Pessoa.nome"));
			obj.getPessoa().setEmail(dadosSQL.getString("Pessoa.email"));
			obj.getResponsavelFinanceiro().setCodigo(dadosSQL.getInt("responsavelFinanceiro"));
			obj.getResponsavelFinanceiro().setNome(dadosSQL.getString("responsavelFinanceiro.nome"));
			obj.getResponsavelFinanceiro().setEmail(dadosSQL.getString("responsavelFinanceiro.email"));
			obj.getFuncionario().setCodigo(dadosSQL.getInt("Funcionario.codigo"));
			obj.getFuncionario().getPessoa().setNome(dadosSQL.getString("pessoaFuncionario.nome"));
			obj.getFuncionario().getPessoa().setEmail(dadosSQL.getString("pessoaFuncionario.email"));
			obj.getFuncionario().getPessoa().setCodigo(dadosSQL.getInt("pessoaFuncionario.codigo"));
			obj.setTipoOrigem(dadosSQL.getString("tipoOrigem"));
			obj.setDataVencimento(dadosSQL.getDate("dataVencimento"));
			obj.getUnidadeEnsino().getConfiguracoes().setCodigo(dadosSQL.getInt("configuracoes.codigo"));
			obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
			obj.getUnidadeEnsinoFinanceira().getConfiguracoes().setCodigo(dadosSQL.getInt("configuracoes.codigo"));
			obj.getUnidadeEnsinoFinanceira().setCodigo(dadosSQL.getInt("unidadeensinofinanceira"));
			obj.setParcela(dadosSQL.getString("parcela"));
			obj.getUnidadeEnsino().getResponsavelCobrancaUnidade().setEmail(dadosSQL.getString("funcionariounidadeemail"));
			obj.getUnidadeEnsinoFinanceira().getResponsavelCobrancaUnidade().setEmail(dadosSQL.getString("funcionariounidadeemail"));
			obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhadigitavelcodigobarras"));
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<ContaReceberVO> consultarContaReceberMatriculaNaoPaga(Integer unidadeEnsino) throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT contareceber.codigo, contareceber.updated, turma.identificadorturma, contareceber.tipopessoa, contareceber.matriculaaluno, contareceber.pessoa, pessoa.nome AS \"Pessoa.nome\", pessoa.email AS \"Pessoa.email\", ");
		sql.append("contareceber.codigobarra, contareceber.dataVencimento, contareceber.tipoorigem ");
		sql.append("contareceber.responsavelFinanceiro, funcionario.codigo AS \"Funcionario.codigo\", ");
		sql.append("pessoafuncionario.nome AS \"pessoaFuncionario.nome\", pessoafuncionario.codigo AS \"pessoaFuncionario.codigo\", pessoafuncionario.email as \"pessoaFuncionario.email\", ");
		sql.append("responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.email as \"responsavelFinanceiro.email\", configuracaofinanceiro.numerodiasenviarnotificacaomatriculanaopagaconsultor AS numerodiasenviarnotificacaomatriculanaopagaconsultor "); //
		sql.append("FROM contareceber ");
		sql.append("INNER JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) ");
		sql.append("INNER JOIN pessoa ON (matricula.aluno = pessoa.codigo) ");
		sql.append(" inner join matriculaperiodo on contareceber.matriculaperiodo = matriculaperiodo.codigo and matriculaperiodo.matricula = contareceber.matriculaaluno ");
		sql.append(" inner join turma on matriculaperiodo.turma = turma.codigo ");
		sql.append("INNER JOIN funcionario ON (funcionario.codigo = matricula.consultor) ");
		sql.append("INNER JOIN pessoa AS pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sql.append("LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sql.append("inner JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sql.append("inner JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sql.append(" inner join configuracoes on configuracoes.codigo = unidadeEnsinoFinanceira.configuracoes");
		sql.append(" inner join configuracaofinanceiro on configuracaofinanceiro.configuracoes = configuracoes.codigo");
		sql.append(" where contareceber.tipoOrigem = 'MAT' AND contareceber.situacao = 'AR' AND configuracaofinanceiro.enviarnotificacaoconsultormatricula = true  ");
		sql.append(" and unidadeEnsinoFinanceira.codigo = ").append(unidadeEnsino);
		SqlRowSet dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		List<ContaReceberVO> vetResultado = new ArrayList<ContaReceberVO>(0);
		while (dadosSQL.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(dadosSQL.getInt("codigo"));
			// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(dadosSQL.getInt("registrocobrancacontareceber"));
			obj.setUpdated(dadosSQL.getDate("updated"));
			obj.setCodigoBarra(dadosSQL.getString("codigobarra"));
			obj.setTipoPessoa(dadosSQL.getString("tipopessoa"));
			obj.getMatriculaAluno().setMatricula(dadosSQL.getString("matriculaaluno"));
			obj.getPessoa().setCodigo(dadosSQL.getInt("pessoa"));
			obj.getPessoa().setNome(dadosSQL.getString("Pessoa.nome"));
			obj.getPessoa().setEmail(dadosSQL.getString("Pessoa.email"));
			obj.getResponsavelFinanceiro().setCodigo(dadosSQL.getInt("responsavelFinanceiro"));
			obj.getResponsavelFinanceiro().setNome(dadosSQL.getString("responsavelFinanceiro.nome"));
			obj.getResponsavelFinanceiro().setEmail(dadosSQL.getString("responsavelFinanceiro.email"));
			obj.getFuncionario().setCodigo(dadosSQL.getInt("Funcionario.codigo"));
			obj.getFuncionario().getPessoa().setNome(dadosSQL.getString("pessoaFuncionario.nome"));
			obj.getFuncionario().getPessoa().setEmail(dadosSQL.getString("pessoaFuncionario.email"));
			obj.getFuncionario().getPessoa().setCodigo(dadosSQL.getInt("pessoaFuncionario.codigo"));
			obj.setTipoOrigem(dadosSQL.getString("tipoOrigem"));
			obj.setDataVencimento(dadosSQL.getDate("dataVencimento"));
			obj.getTurma().setIdentificadorTurma("identificadorturma");
			obj.getConfiguracaoFinanceiro().setNumeroDiasEnviarNotificacaoMatriculaNaoPagaConsultor(dadosSQL.getInt("numerodiasenviarnotificacaomatriculanaopagaconsultor"));
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<String> consultarParcelaPorTurma(TurmaVO turma, UsuarioVO usuarioVO) throws Exception {
		return consultarParcelaPorTurma(turma, Optional.ofNullable(null), usuarioVO);
	}

	public List<String> consultarParcelaPorTurma(TurmaVO turma, Optional<FiltroRelatorioFinanceiroVO> filtroRelatorioFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("select distinct contareceber.parcela from contareceber ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		sb.append(" inner join turma on turma.codigo = matriculaperiodo.turma ");
		
		if(turma.getTurmaAgrupada()) {				
			if (!turma.getTurmaAgrupadaVOs().isEmpty()) {
				boolean virgula = false;
				sb.append(" where turma.codigo IN(");
				for (TurmaAgrupadaVO turmaAgrupadaVO : turma.getTurmaAgrupadaVOs()) {

						if (!virgula) {
							sb.append(turmaAgrupadaVO.getTurma().getCodigo());
						} else {
							sb.append(", ").append(turmaAgrupadaVO.getTurma().getCodigo());
						}
						virgula = true;
					
				}
				sb.append(") ");
			}else {
				sb.append(" where turma.codigo = ").append(turma.getCodigo());
			}
			
		}
		else {
			sb.append(" where turma.codigo = ").append(turma.getCodigo());
		}

		filtroRelatorioFinanceiroVO.ifPresent(filtro -> sb.append(" AND ").append(adicionarFiltroTipoOrigemContaReceber(filtro, "contareceber")));
		sb.append(" order by parcela");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<String> listaParcela = new ArrayList<String>(0);
		String parcela = null;
		while (tabelaResultado.next()) {
			parcela = "";
			parcela = tabelaResultado.getString("parcela");
			listaParcela.add(parcela);
		}
		return listaParcela;
	}

	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	@Override
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAlunosInadimentesPrimeiraMsg(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		Map<Integer, GrupoDestinatariosVO> grupoDestinatario = new HashMap<Integer, GrupoDestinatariosVO>(0);
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<ContaReceberCobrancaRelVO>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		ContaReceberVO contaReceberVO = null;
		String matriculaAtual = "";
		StringBuilder sb = new StringBuilder();
		sb.append(" select contareceber.codigo, contareceber.updated, contaReceber.valor, contaReceber.parcela, contareceber.dataVencimento, (current_date - contareceber.dataVencimento::DATE) as diasAtraso,");
		sb.append(" matricula.matricula, unidadeensino.nome as unidadeEnsino, unidadeensino.codigo as codigoUnidadeEnsino,  case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.codigo else pessoa.codigo end as codigoAluno,");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.nome else pessoa.nome end as nomeAluno, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.email else pessoa.email end as email,");
		sb.append(" configuracaoFinanceiro.grupoDestinatarioMensagemCobrancaInadimplente as grupoDestinatarioMensagemCobrancaInadimplente, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then 'RF' else 'AL' end as tipoPessoa, ");
		sb.append(" responsavelcobranca.email as emailresponsavelcobranca ");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" left join pessoa as responsavelcobranca on unidadeensino.responsavelcobrancaunidade = responsavelcobranca.codigo ");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where matricula.naoEnviarMensagemCobranca =  false and configuracaoFinanceiro.quantidadeDiasEnviarPrimeiraMensagemCobrancaInadimplente > 0 and configuracaoFinanceiro.tipoEnvioInadimplencia = 'periodicidade' ");
		sb.append(" AND contareceber.datavencimento < current_date ");
		sb.append(" and contareceber.situacao = 'AR' ");
		sb.append(" and (");
		sb.append("   (configuracaoFinanceiro.tipoOrigemMatriculaRotinaInadimplencia         and contareceber.tipoorigem = 'MAT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemBibliotecaRotinaInadimplencia        and contareceber.tipoorigem = 'BIB') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMensalidadeRotinaInadimplencia       and contareceber.tipoorigem = 'MEN') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemDevolucaoChequeRotinaInadimplencia   and contareceber.tipoorigem = 'DCH') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemNegociacaoRotinaInadimplencia        and contareceber.tipoorigem = 'NCR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemContratoReceitaRotinaInadimplencia   and contareceber.tipoorigem = 'CTR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemOutrosRotinaInadimplencia            and contareceber.tipoorigem = 'OUT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMaterialDidaticoRotinaInadimplencia  and contareceber.tipoorigem = 'MDI') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemInclusaoReposicaoRotinaInadimplencia and contareceber.tipoorigem = 'IRE') ");
		sb.append(") ");
		sb.append(" AND matricula.matricula = '").append(matricula).append("'");
		sb.append(" order by matricula.matricula, contareceber.datavencimento ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (rs.next()) {
			if (matriculaAtual.equals("") || !matriculaAtual.equals(rs.getString("matricula"))) {
				matriculaAtual = rs.getString("matricula");
				contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
				contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
				contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setCodigo(rs.getInt("codigoAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setEmail(rs.getString("email"));
				contaReceberCobrancaRelVO.setUnidadeEnsino(rs.getString("unidadeEnsino"));
				contaReceberCobrancaRelVO.setEmailResponsavelCobranca(rs.getString("emailresponsavelcobranca"));
				contaReceberCobrancaRelVO.setCodigoUnidadeEnsino(rs.getInt("codigoUnidadeEnsino"));
				contaReceberCobrancaRelVO.setTipoDestinatario(rs.getString("tipoPessoa"));
				if (rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente") != 0) {
					if (!grupoDestinatario.containsKey(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"))) {
						grupoDestinatario.put(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"), getFacadeFactory().getGrupoDestinatariosFacade().consultarPorChavePrimaria(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"), false, Uteis.NIVELMONTARDADOS_TODOS, null));
					}
					contaReceberCobrancaRelVO.setGrupoDestinatariosVO(grupoDestinatario.get(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente")));
				}
				contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
			}
			contaReceberVO = consultarPorChavePrimaria(rs.getInt("codigo"), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiroVO, new UsuarioVO());
			//contaReceberVO = new ContaReceberVO();
			//contaReceberVO.setCodigo(rs.getInt("codigo"));
			// contaReceberVO.getRegistroNegativacaoCobrancaContaReceber().setCodigo(rs.getInt("registrocobrancacontareceber"));
			//contaReceberVO.setUpdated(rs.getDate("updated"));
			//contaReceberVO.setValor(rs.getDouble("valor"));
			//contaReceberVO.setParcela(rs.getString("parcela"));
			//contaReceberVO.setDataVencimento(rs.getDate("dataVencimento"));
			contaReceberCobrancaRelVO.setValorTotalParcela(contaReceberCobrancaRelVO.getValorTotalParcela() + (contaReceberVO.getValorBaseContaReceber() - contaReceberVO.getListaDescontosAplicavesContaReceber().get(0).getValorDescontoSemValidade()));
			contaReceberCobrancaRelVO.getContaReceberVOs().add(contaReceberVO);
		}
		return contaReceberCobrancaRelVOs;
	}

	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	@Override
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAlunosInadimentesSegundaMsg(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		Map<Integer, GrupoDestinatariosVO> grupoDestinatario = new HashMap<Integer, GrupoDestinatariosVO>(0);
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<ContaReceberCobrancaRelVO>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		ContaReceberVO contaReceberVO = null;
		String matriculaAtual = "";
		StringBuilder sb = new StringBuilder();
		sb.append(" select contareceber.codigo, contareceber.updated, contaReceber.valor, contaReceber.parcela, contareceber.dataVencimento, (current_date - contareceber.dataVencimento::DATE) as diasAtraso,");
		sb.append(" matricula.matricula, unidadeensino.nome as unidadeEnsino, unidadeensino.codigo as codigoUnidadeEnsino,  case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.codigo else pessoa.codigo end as codigoAluno,");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.nome else pessoa.nome end as nomeAluno, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.email else pessoa.email end as email,");
		sb.append(" configuracaoFinanceiro.grupoDestinatarioMensagemCobrancaInadimplente as grupoDestinatarioMensagemCobrancaInadimplente, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then 'RF' else 'AL' end as tipoPessoa, ");
		sb.append(" responsavelcobranca.email as emailresponsavelcobranca ");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" left join pessoa as responsavelcobranca on unidadeensino.responsavelcobrancaunidade = responsavelcobranca.codigo ");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where matricula.naoEnviarMensagemCobranca =  false and configuracaoFinanceiro.quantidadeDiasEnviarSegundaMensagemCobrancaInadimplente > 0 and configuracaoFinanceiro.tipoEnvioInadimplencia = 'periodicidade' ");
		sb.append(" AND contareceber.datavencimento < current_date ");
		sb.append(" and contareceber.situacao = 'AR' ");
		sb.append(" and (");
		sb.append("   (configuracaoFinanceiro.tipoOrigemMatriculaRotinaInadimplencia         and contareceber.tipoorigem = 'MAT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemBibliotecaRotinaInadimplencia        and contareceber.tipoorigem = 'BIB') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMensalidadeRotinaInadimplencia       and contareceber.tipoorigem = 'MEN') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemDevolucaoChequeRotinaInadimplencia   and contareceber.tipoorigem = 'DCH') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemNegociacaoRotinaInadimplencia        and contareceber.tipoorigem = 'NCR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemContratoReceitaRotinaInadimplencia   and contareceber.tipoorigem = 'CTR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemOutrosRotinaInadimplencia            and contareceber.tipoorigem = 'OUT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMaterialDidaticoRotinaInadimplencia  and contareceber.tipoorigem = 'MDI') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemInclusaoReposicaoRotinaInadimplencia and contareceber.tipoorigem = 'IRE') ");
		sb.append(") ");
		sb.append(" AND matricula.matricula = '").append(matricula).append("'");
		sb.append(" order by matricula.matricula, contareceber.datavencimento ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (rs.next()) {
			if (matriculaAtual.equals("") || !matriculaAtual.equals(rs.getString("matricula"))) {
				matriculaAtual = rs.getString("matricula");
				contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
				contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
				contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setCodigo(rs.getInt("codigoAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setEmail(rs.getString("email"));
				contaReceberCobrancaRelVO.setUnidadeEnsino(rs.getString("unidadeEnsino"));
				contaReceberCobrancaRelVO.setEmailResponsavelCobranca(rs.getString("emailresponsavelcobranca"));
				contaReceberCobrancaRelVO.setCodigoUnidadeEnsino(rs.getInt("codigoUnidadeEnsino"));
				contaReceberCobrancaRelVO.setTipoDestinatario(rs.getString("tipoPessoa"));
				if (rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente") != 0) {
					if (!grupoDestinatario.containsKey(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"))) {
						grupoDestinatario.put(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"), getFacadeFactory().getGrupoDestinatariosFacade().consultarPorChavePrimaria(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"), false, Uteis.NIVELMONTARDADOS_TODOS, null));
					}
					contaReceberCobrancaRelVO.setGrupoDestinatariosVO(grupoDestinatario.get(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente")));
				}
				contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
			}
			contaReceberVO = consultarPorChavePrimaria(rs.getInt("codigo"), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiroVO, new UsuarioVO());
			//contaReceberVO = new ContaReceberVO();
			//contaReceberVO.setCodigo(rs.getInt("codigo"));
			// contaReceberVO.getRegistroNegativacaoCobrancaContaReceber().setCodigo(rs.getInt("registrocobrancacontareceber"));
			//contaReceberVO.setUpdated(rs.getDate("updated"));
			//contaReceberVO.setValor(rs.getDouble("valor"));
			//contaReceberVO.setParcela(rs.getString("parcela"));
			//contaReceberVO.setDataVencimento(rs.getDate("dataVencimento"));
			contaReceberCobrancaRelVO.setValorTotalParcela(contaReceberCobrancaRelVO.getValorTotalParcela() + (contaReceberVO.getValorBaseContaReceber() - contaReceberVO.getListaDescontosAplicavesContaReceber().get(0).getValorDescontoSemValidade()));
			contaReceberCobrancaRelVO.getContaReceberVOs().add(contaReceberVO);
		}
		return contaReceberCobrancaRelVOs;
	}

	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	@Override
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAlunosInadimentesTerceiraMsg(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		Map<Integer, GrupoDestinatariosVO> grupoDestinatario = new HashMap<Integer, GrupoDestinatariosVO>(0);
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<ContaReceberCobrancaRelVO>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		ContaReceberVO contaReceberVO = null;
		String matriculaAtual = "";
		StringBuilder sb = new StringBuilder();
		sb.append(" select contareceber.codigo, contareceber.updated, contaReceber.valor, contaReceber.parcela, contareceber.dataVencimento, (current_date - contareceber.dataVencimento::DATE) as diasAtraso,");
		sb.append(" matricula.matricula, unidadeensino.nome as unidadeEnsino, unidadeensino.codigo as codigoUnidadeEnsino,  case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.codigo else pessoa.codigo end as codigoAluno,");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.nome else pessoa.nome end as nomeAluno, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.email else pessoa.email end as email,");
		sb.append(" configuracaoFinanceiro.grupoDestinatarioMensagemCobrancaInadimplente as grupoDestinatarioMensagemCobrancaInadimplente, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then 'RF' else 'AL' end as tipoPessoa, ");
		sb.append(" responsavelcobranca.email as emailresponsavelcobranca ");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" left join pessoa as responsavelcobranca on unidadeensino.responsavelcobrancaunidade = responsavelcobranca.codigo ");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where matricula.naoEnviarMensagemCobranca =  false  and configuracaoFinanceiro.quantidadeDiasEnviarTerceiraMensagemCobrancaInadimplente > 0 and configuracaoFinanceiro.tipoEnvioInadimplencia = 'periodicidade' ");
		sb.append(" AND contareceber.datavencimento < current_date ");
		sb.append(" and contareceber.situacao = 'AR' ");
		sb.append(" and (");
		sb.append("   (configuracaoFinanceiro.tipoOrigemMatriculaRotinaInadimplencia         and contareceber.tipoorigem = 'MAT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemBibliotecaRotinaInadimplencia        and contareceber.tipoorigem = 'BIB') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMensalidadeRotinaInadimplencia       and contareceber.tipoorigem = 'MEN') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemDevolucaoChequeRotinaInadimplencia   and contareceber.tipoorigem = 'DCH') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemNegociacaoRotinaInadimplencia        and contareceber.tipoorigem = 'NCR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemContratoReceitaRotinaInadimplencia   and contareceber.tipoorigem = 'CTR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemOutrosRotinaInadimplencia            and contareceber.tipoorigem = 'OUT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMaterialDidaticoRotinaInadimplencia  and contareceber.tipoorigem = 'MDI') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemInclusaoReposicaoRotinaInadimplencia and contareceber.tipoorigem = 'IRE') ");
		sb.append(") ");
		sb.append(" AND matricula.matricula = '").append(matricula).append("'");
		sb.append(" order by matricula.matricula, contareceber.datavencimento ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (rs.next()) {
			if (matriculaAtual.equals("") || !matriculaAtual.equals(rs.getString("matricula"))) {
				matriculaAtual = rs.getString("matricula");
				contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
				contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
				contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setCodigo(rs.getInt("codigoAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setEmail(rs.getString("email"));
				contaReceberCobrancaRelVO.setUnidadeEnsino(rs.getString("unidadeEnsino"));
				contaReceberCobrancaRelVO.setEmailResponsavelCobranca(rs.getString("emailresponsavelcobranca"));
				contaReceberCobrancaRelVO.setCodigoUnidadeEnsino(rs.getInt("codigoUnidadeEnsino"));
				contaReceberCobrancaRelVO.setTipoDestinatario(rs.getString("tipoPessoa"));
				if (rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente") != 0) {
					if (!grupoDestinatario.containsKey(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"))) {
						grupoDestinatario.put(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"), getFacadeFactory().getGrupoDestinatariosFacade().consultarPorChavePrimaria(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"), false, Uteis.NIVELMONTARDADOS_TODOS, null));
					}
					contaReceberCobrancaRelVO.setGrupoDestinatariosVO(grupoDestinatario.get(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente")));
				}
				contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
			}
			contaReceberVO = consultarPorChavePrimaria(rs.getInt("codigo"), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiroVO, new UsuarioVO());
			//contaReceberVO = new ContaReceberVO();
			//contaReceberVO.setCodigo(rs.getInt("codigo"));
			// contaReceberVO.getRegistroNegativacaoCobrancaContaReceber().setCodigo(rs.getInt("registrocobrancacontareceber"));
			//contaReceberVO.setUpdated(rs.getDate("updated"));
			//contaReceberVO.setValor(rs.getDouble("valor"));
			//contaReceberVO.setParcela(rs.getString("parcela"));
			//contaReceberVO.setDataVencimento(rs.getDate("dataVencimento"));
			contaReceberCobrancaRelVO.setValorTotalParcela(contaReceberCobrancaRelVO.getValorTotalParcela() + (contaReceberVO.getValorBaseContaReceber() - contaReceberVO.getListaDescontosAplicavesContaReceber().get(0).getValorDescontoSemValidade()));
			contaReceberCobrancaRelVO.getContaReceberVOs().add(contaReceberVO);
		}
		return contaReceberCobrancaRelVOs;
	}

	@Override
	public List<ContaReceberVO> consultaContaReceberRecebidaEmDuplicidadePorNossoNumero(String valorConsulta) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE ");
		sqlStr.append(" contareceber.nossonumero ilike '%").append(valorConsulta);
		sqlStr.append("%'");
		sqlStr.append(" and (select count(ContaReceberHistorico.codigo) from ContaReceberHistorico where ContaReceberHistorico.contaReceber = contaReceber.codigo ) >= 1 ");
		sqlStr.append(" and (select count(contareceberregistroarquivo.codigo) from contareceberregistroarquivo where contareceberregistroarquivo.contaReceber = contaReceber.codigo ) >= 1  ");
		sqlStr.append(" ORDER BY contareceber.dataVencimento, pessoa.nome ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public List<ContaReceberVO> consultaContaReceberRecebidaEmDuplicidadePorPeriodoDataVcto(Date dataInicio, Date dataFim) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE ");
		sqlStr.append(" contareceber.dataVencimento >= '").append(dataInicio);
		sqlStr.append("' and contareceber.dataVencimento <= '").append(dataFim).append("'");
		sqlStr.append(" and (select count(ContaReceberHistorico.codigo) from ContaReceberHistorico where ContaReceberHistorico.contaReceber = contaReceber.codigo ) >= 1 ");
		sqlStr.append(" and (select count(contareceberregistroarquivo.codigo) from contareceberregistroarquivo where contareceberregistroarquivo.contaReceber = contaReceber.codigo ) >= 1 ");
		sqlStr.append(" ORDER BY contareceber.dataVencimento, pessoa.nome ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public List<ContaReceberVO> consultaContaReceberRecebidaEmDuplicidadePorTratada(Boolean tratada) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE ");
		if (tratada) {
			sqlStr.append(" contareceber.duplicidadeTratada = true ");
		} else if (!tratada) {
			sqlStr.append(" (contareceber.duplicidadeTratada = false or contareceber.duplicidadeTratada is null) ");
		}
		sqlStr.append(" AND (select count(ContaReceberHistorico.codigo) from ContaReceberHistorico where ContaReceberHistorico.contaReceber = contaReceber.codigo ) >= 1 ");

		sqlStr.append(" ORDER BY contareceber.dataVencimento, pessoa.nome ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	/**
	 * Método Utilizado Apenas Para Contas Importadas
	 * 
	 * @param configuracaoFinanceiroVO
	 * @param usuario
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	@Override
	public void realizarProcessamentoCalculoValorPrimeiraFaixaDesconto(ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sql = new StringBuilder(getSQLPadraoConsultaCompletaSemContaReceberRecebimento());
		sql.append(" WHERE ( valorDescontoCalculadoPrimeiraFaixaDescontos is null or valorDescontoCalculadoPrimeiraFaixaDescontos <= 0.0  or valorDescontoCalculadoPrimeiraFaixaDescontos = valor) ");
		try {
			SqlRowSet dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
			while (dadosSQL.next()) {
				ContaReceberVO obj = new ContaReceberVO();
				try {
					obj.setCodigo(dadosSQL.getInt("codigo"));
					// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(dadosSQL.getInt("registrocobrancacontareceber"));
					obj.setCodOrigem(dadosSQL.getString("codorigem"));
					obj.setTipoPessoa(dadosSQL.getString("tipopessoa"));
					obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
					obj.getPessoa().setCodigo(dadosSQL.getInt("pessoa"));
					obj.getResponsavelFinanceiro().setCodigo(dadosSQL.getInt("responsavelFinanceiro"));
					obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeEnsino"));
					obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor"));
					switch (TipoPessoa.getEnum(obj.getTipoPessoa())) {
					case ALUNO:
						obj.getMatriculaAluno().getAluno().setCodigo(obj.getPessoa().getCodigo());
						break;
					case RESPONSAVEL_FINANCEIRO:
						obj.getMatriculaAluno().getAluno().setCodigo(obj.getPessoa().getCodigo());
						break;
					case CANDIDATO:
						obj.getCandidato().setCodigo(dadosSQL.getInt("candidato"));
						break;
					case FUNCIONARIO:
						obj.getFuncionario().setCodigo(dadosSQL.getInt("funcionario"));
						obj.getFuncionario().getPessoa().setCodigo(obj.getPessoa().getCodigo());
						break;
					case PARCEIRO:
						obj.getParceiroVO().setCodigo(dadosSQL.getInt("parceiro"));
						obj.getMatriculaAluno().getAluno().setCodigo(obj.getPessoa().getCodigo());
						break;
					}
					obj.setValor(dadosSQL.getDouble("valor"));

					obj.setValorCusteadoContaReceber(dadosSQL.getDouble("valorCusteadoContaReceber"));
					obj.setValorBaseContaReceber(dadosSQL.getDouble("valorBaseContaReceber"));

					obj.setDataVencimento(dadosSQL.getTimestamp("dataVencimento"));
					obj.setSituacao("AR");
					obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
					obj.setValorDescontoRateio(dadosSQL.getDouble("valorDescontoRateio"));
					obj.setTipoOrigem(dadosSQL.getString("tipoOrigem"));
					obj.setTipoDesconto(dadosSQL.getString("tipoDesconto"));
					obj.setUpdated(dadosSQL.getTimestamp("updated"));
					obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
					obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));
					obj.setUsaDescontoCompostoPlanoDesconto(dadosSQL.getBoolean("usaDescontoCompostoPlanoDesconto"));
					obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoProgressivo"));
					obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
					obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
					obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
					obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
					obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
					obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
					obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
					obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
					obj.setData(dadosSQL.getDate("data"));
					obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
					obj.setCodOrigem(dadosSQL.getString("codorigem"));
					obj.setTipoOrigem(dadosSQL.getString("tipoorigem"));
					obj.setValorRecebido(0.0);
					obj.setJuroPorcentagem(0.0);
					obj.setJuro(0.0);
					obj.setMultaPorcentagem(0.0);
					obj.setMulta(0.0);
					obj.setAcrescimo(0.0);
					obj.setContaCorrente(dadosSQL.getInt("contacorrente"));
					obj.getCentroReceita().setCodigo(dadosSQL.getInt("centroreceita"));
					obj.setTipoBoleto(dadosSQL.getString("tipoboleto"));
					obj.getConvenio().setCodigo(dadosSQL.getInt("convenio"));
					obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaperiodo"));

					obj.getTurma().setCodigo(dadosSQL.getInt("turma"));

					obj.setOrigemNegociacaoReceber(dadosSQL.getInt("origemnegociacaoreceber"));
					// Dados do Desconto Progressivo
					obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoprogressivo"));
					obj.setDescontoProgressivoUtilizado(FaixaDescontoProgressivo.getEnum(dadosSQL.getString("descontoprogressivoutilizado")));
					obj.getDescontoProgressivo().setNome(dadosSQL.getString("descontoprogressivo.nome"));
					obj.getDescontoProgressivo().setDiaLimite1(dadosSQL.getInt("descontoprogressivo.dialimite1"));
					obj.getDescontoProgressivo().setDiaLimite2(dadosSQL.getInt("descontoprogressivo.dialimite2"));
					obj.getDescontoProgressivo().setDiaLimite3(dadosSQL.getInt("descontoprogressivo.dialimite3"));
					obj.getDescontoProgressivo().setDiaLimite4(dadosSQL.getInt("descontoprogressivo.dialimite4"));
					obj.getDescontoProgressivo().setPercDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.percdescontolimite1"));
					obj.getDescontoProgressivo().setPercDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.percdescontolimite2"));
					obj.getDescontoProgressivo().setPercDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.percdescontolimite3"));
					obj.getDescontoProgressivo().setPercDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.percdescontolimite4"));			
					obj.getDescontoProgressivo().setValorDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.valordescontolimite1"));
					obj.getDescontoProgressivo().setValorDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.valordescontolimite2"));
					obj.getDescontoProgressivo().setValorDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.valordescontolimite3"));
					obj.getDescontoProgressivo().setValorDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.valordescontolimite4"));
					obj.getDescontoProgressivo().setUtilizarDiaFixo(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaFixo"));
					obj.getDescontoProgressivo().setUtilizarDiaUtil(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaUtil"));
					obj.setContaEditadaManualmente(dadosSQL.getBoolean("contaEditadaManualmente"));
					obj.setUtilizarDescontoProgressivoManual(dadosSQL.getBoolean("utilizarDescontoProgressivoManual"));
					if (obj.getUtilizarDescontoProgressivoManual()) {
						obj.setDiaLimite1(dadosSQL.getInt("diaLimite1"));
						obj.setDiaLimite2(dadosSQL.getInt("diaLimite2"));
						obj.setDiaLimite3(dadosSQL.getInt("diaLimite3"));
						obj.setDiaLimite4(dadosSQL.getInt("diaLimite4"));
					}
					if (obj.getUtilizarDescontoProgressivoManual()) {
						obj.getDescontoProgressivo().setDescontoProgressivoEditadoManualmenteContaReceber(Boolean.TRUE);
						obj.getDescontoProgressivo().setDiaLimite1(obj.getDiaLimite1());
						obj.getDescontoProgressivo().setDiaLimite2(obj.getDiaLimite2());
						obj.getDescontoProgressivo().setDiaLimite3(obj.getDiaLimite3());
						obj.getDescontoProgressivo().setDiaLimite4(obj.getDiaLimite4());
					}
					// TODO Alberto 08/12/10 acrescentado valor fixo desconto
					// progressivo
					// Desconto Lançado Recebimento
					obj.setValorDescontoLancadoRecebimento(0.0);
					obj.setValorCalculadoDescontoLancadoRecebimento(0.0);
					obj.setTipoDescontoLancadoRecebimento("");
					// montar dados plano desconto
					obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));

					obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
					obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
					obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
					obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
					obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
					obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
					obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
					obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
					obj.setTipoDesconto(dadosSQL.getString("tipodesconto"));
					obj.setValorDescontoRecebido(dadosSQL.getDouble("valordescontorecebido"));
					obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
					obj.setJustificativaDesconto(dadosSQL.getString("justificativaDesconto"));
					obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
					obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));
					obj.setPrecisaCalcularDesconto(true);
					obj.setAcrescimo(0.0);
					obj.setJuro(0.0);
					obj.setMulta(0.0);
					obj.setJuroPorcentagem(0.0);
					obj.setMultaPorcentagem(0.0);
					
					realizarAtualizacaoValorDescontoFaixaContaReceber(obj, configuracaoFinanceiroVO, true);
					//obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(obj.getCalcularValorFinal(Uteis.obterDataAntiga(obj.getDataVencimento(), 120), configuracaoFinanceiroVO, false, Uteis.obterDataAntiga(obj.getDataVencimento(), 120), usuario));
					if (obj.getValorDescontoCalculadoPrimeiraFaixaDescontos() < 0) {
						obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(0.0);
					}
					
					final String sqlUpdateContaReceber = "UPDATE ContaReceber set valorDescontoCalculadoPrimeiraFaixaDescontos=?, datalimiteprimeirafaixadescontos=?, valorDescontoCalculadoSegundaFaixaDescontos=?, datalimitesegundafaixadescontos=?, valorDescontoCalculadoTerceiraFaixaDescontos=?, datalimiteterceirafaixadescontos=?, valorDescontoCalculadoQuartaFaixaDescontos=?, datalimitequartafaixadescontos=?  WHERE ((contareceber.codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);

					getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

						public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
							PreparedStatement sqlAlterar = arg0.prepareStatement(sqlUpdateContaReceber);
							sqlAlterar.setDouble(1, obj.getValorDescontoCalculadoPrimeiraFaixaDescontos());
							sqlAlterar.setDate(2, Uteis.getDataJDBC(obj.getDataLimitePrimeiraFaixaDescontos()));
							sqlAlterar.setDouble(3, obj.getValorDescontoCalculadoSegundaFaixaDescontos());
							sqlAlterar.setDate(4, Uteis.getDataJDBC(obj.getDataLimiteSegundaFaixaDescontos()));
							sqlAlterar.setDouble(5, obj.getValorDescontoCalculadoTerceiraFaixaDescontos());
							sqlAlterar.setDate(6, Uteis.getDataJDBC(obj.getDataLimiteTerceiraFaixaDescontos()));
							sqlAlterar.setDouble(7, obj.getValorDescontoCalculadoQuartaFaixaDescontos());
							sqlAlterar.setDate(8, Uteis.getDataJDBC(obj.getDataLimiteQuartaFaixaDescontos()));
							sqlAlterar.setInt(9, obj.getCodigo());
							return sqlAlterar;
						}
					});
					
					final String sqlUpdateMatriculaPeriodoVencimento = "UPDATE matriculaperiodovencimento set valorDescontoCalculadoPrimeiraFaixaDescontos=?, valorDescontoCalculadoSegundaFaixaDescontos=?, valorDescontoCalculadoTerceiraFaixaDescontos=?, valorDescontoCalculadoQuartaFaixaDescontos=?  WHERE ((contareceber = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
					
					getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

						public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
							PreparedStatement sqlAlterar = arg0.prepareStatement(sqlUpdateMatriculaPeriodoVencimento);
							sqlAlterar.setDouble(1, obj.getValorDescontoCalculadoPrimeiraFaixaDescontos());
							sqlAlterar.setDouble(2, obj.getValorDescontoCalculadoSegundaFaixaDescontos());
							sqlAlterar.setDouble(3, obj.getValorDescontoCalculadoTerceiraFaixaDescontos());
							sqlAlterar.setDouble(4, obj.getValorDescontoCalculadoQuartaFaixaDescontos());
							sqlAlterar.setInt(5, obj.getCodigo());
							return sqlAlterar;
						}
					});
					
				} catch (Exception e) {
					//// System.out.println("NAO FOI POSSIVEL ATUALIZAR PRIMERIA FAIXA DESCONTO CONTA A RECEBER" + obj.toString() + "(" + e.getMessage() + ")");
				}
			}
		} catch (Exception e) {
			throw e;
		}
	}

	/**
	 * Metodo chamado por uma Job que é executada todos os dias às 01:00h da madrugada. Este método é responsável por atualizar os valores dos descontos, juros e multas da conta a receber, considerando a realidade destes valores para o novo dia que está inniciando. Esta Rotina que acionada por este Job é VITAL para garantir que os dados apresentados no painel gestor esteja corretos e alinhados com os do relatório. Pois quando o Painel Gestor é acionado pelo usuário o mesmo totaliza descontos, jutos e multas com valores atualizados para o dia de hoje. Valores estes que são atualizados pela rotina abaixo. É importante lembrar que todo dia um aluno pode perder algum desconto progressivo ou algum tipo de desconto, assim como ter sua divida aumentada em função de juros e multas.
	 * 
	 * @param configuracaoFinanceiroVO
	 * @param usuario
	 * @throws Exception
	 */
	@Override
	public void realizarProcessamentoValorFinalContaReceberAtualizadoComAcrescimosEDescontos(Integer nrAnosProcessar, List<ContaReceberVO> contaReceberProcessar, Boolean validarRealizadoProcessamento, String competencia, Boolean considerarDataFutura, UsuarioVO usuario, Boolean lancarExcecao, Boolean considerarPeriodoVencimento,Date dataInicioPeriodoVencimento , Date dataFimPeriodoVencimento, Boolean verificarCompetencia) throws Exception {
		Date dataReceber = new Date();
		Boolean bloqueioPorFechamentoMesLiberado = false;
		StringBuilder sql = new StringBuilder(getSQLPadraoConsultaCompletaSemContaReceberRecebimento());
		sql.append(" WHERE contareceber.situacao = 'AR' ");		
		if(Uteis.isAtributoPreenchido(competencia) && competencia.length() == 7 && competencia.contains("/")) {
			sql.append(" and (to_char(contareceber.datacompetencia, 'MM/YYYY') = '").append(competencia).append("') ");	
		}
		if (validarRealizadoProcessamento) {
			if(!Uteis.isAtributoPreenchido(contaReceberProcessar) && considerarDataFutura){
				sql.append(" and contareceber.datavencimento <= (current_date+30) ");	
			}if(considerarPeriodoVencimento) {
			   sql.append(" and (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicioPeriodoVencimento)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFimPeriodoVencimento)).append("') ");
			}
			sql.append(" and (dataProcessamentoValorReceber is null or dataProcessamentoValorReceber <  current_date) and (processamentoIntegracaoFinanceiraDetalhe is null or processamentoIntegracaoFinanceiraDetalhe = 0) ");
			
		}
		if (nrAnosProcessar != null && nrAnosProcessar > 0 && (contaReceberProcessar == null || contaReceberProcessar.isEmpty())) {
			sql.append(" and  contareceber.datavencimento::DATE >= (current_date - '").append(nrAnosProcessar).append(" year'::INTERVAL) ");
		}
		if (contaReceberProcessar != null && !contaReceberProcessar.isEmpty()) {
			bloqueioPorFechamentoMesLiberado  = contaReceberProcessar.stream().anyMatch(p-> p.getBloqueioPorFechamentoMesLiberado());
			sql.append(" and contareceber.codigo in (0 ");
			for (ContaReceberVO obj : contaReceberProcessar) {
				sql.append(", ").append(obj.getCodigo());
			}
			sql.append(") ");
		}

		sql.append(" order by contareceber.dataVencimento desc limit 1000");
		Map<Integer, ConfiguracaoFinanceiroVO> configuracaoFinanceiroMap = new HashMap<Integer, ConfiguracaoFinanceiroVO>(0);
		List<Integer> listaContaReceberCanceladaPorFinanciamentoProprio = new ArrayList<Integer>();
		SqlRowSet dadosSQL = null;
		Stopwatch stopwatch = new Stopwatch();
		stopwatch.start();
		RegistroExecucaoJobVO registroExecucaoJobVO = new RegistroExecucaoJobVO();
		registroExecucaoJobVO.setTempoExecucao(stopwatch.getElapsedTicks());
		registroExecucaoJobVO.setDataInicio(new Date());
		registroExecucaoJobVO.setNome(JobCalculoValorTemporarioContaReceber.class.getSimpleName());
		try {
			dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		
			while (dadosSQL.next()) {
				do {
					ContaReceberVO obj = new ContaReceberVO();
					try {
						if(!listaContaReceberCanceladaPorFinanciamentoProprio.contains(dadosSQL.getInt("codigo"))){
							montarDadosBasico(obj, dadosSQL);
							if(bloqueioPorFechamentoMesLiberado) {
								obj.liberarVerificacaoBloqueioFechamentoMes();
							}							
							obj.setDataLimitePrimeiraFaixaDescontos(dadosSQL.getDate("dataLimitePrimeiraFaixaDescontos"));
							obj.setDataLimiteSegundaFaixaDescontos(dadosSQL.getDate("dataLimiteSegundaFaixaDescontos"));
							obj.setDataLimiteTerceiraFaixaDescontos(dadosSQL.getDate("dataLimiteTerceiraFaixaDescontos"));
							obj.setDataLimiteQuartaFaixaDescontos(dadosSQL.getDate("dataLimiteQuartaFaixaDescontos"));							
							obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoPrimeiraFaixaDescontos"));
							obj.setValorDescontoCalculadoSegundaFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoSegundaFaixaDescontos"));
							obj.setValorDescontoCalculadoTerceiraFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoTerceiraFaixaDescontos"));
							obj.setValorDescontoCalculadoQuartaFaixaDescontos(dadosSQL.getDouble("valorDescontoCalculadoQuartaFaixaDescontos"));
							
							obj.setData(dadosSQL.getDate("data"));
							obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
							obj.getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
							obj.setCodOrigem(dadosSQL.getString("codorigem"));
							obj.setTipoOrigem(dadosSQL.getString("tipoorigem"));
							obj.setDescricaoPagamento(dadosSQL.getString("descricaopagamento"));
							obj.setValorRecebido(dadosSQL.getDouble("valorrecebido"));
							obj.setJuroPorcentagem(dadosSQL.getDouble("juroporcentagem"));
							obj.setJuro(dadosSQL.getDouble("juro"));
							obj.setMultaPorcentagem(dadosSQL.getDouble("multaporcentagem"));
							obj.setMulta(dadosSQL.getDouble("multa"));
							obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
							obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhadigitavelcodigobarras"));
							obj.setContaCorrente(dadosSQL.getInt("contacorrente"));
							obj.getCentroReceita().setCodigo(dadosSQL.getInt("centroreceita"));
							obj.getCentroReceita().setDescricao(dadosSQL.getString("CentroReceita.descricao"));
							obj.setTipoBoleto(dadosSQL.getString("tipoboleto"));
							obj.getConvenio().setCodigo(dadosSQL.getInt("convenio"));
							obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaperiodo"));
							obj.setDataArquivoRemessa(dadosSQL.getDate("dataArquivoRemessa"));
							obj.setContaReceberAgrupada(dadosSQL.getInt("contaReceberAgrupada"));
							obj.getRenegociacaoContaReceberOrigem().setCodigo(dadosSQL.getInt("codigoRenegociacao"));

							obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor.codigo"));
							obj.getFornecedor().setNome(dadosSQL.getString("fornecedor.nome"));
							obj.getFornecedor().setRG(dadosSQL.getString("fornecedor.rg"));
							obj.getFornecedor().setCPF(dadosSQL.getString("fornecedor.cpf"));
							obj.getFornecedor().setCNPJ(dadosSQL.getString("fornecedor.cnpj"));
							obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("fornecedor.tipoEmpresa"));

							obj.setDuplicidadeTratada(dadosSQL.getBoolean("duplicidadeTratada"));
							obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
							obj.getTurma().setIdentificadorTurma(dadosSQL.getString("identificadorTurma"));


							obj.setOrigemNegociacaoReceber(dadosSQL.getInt("origemnegociacaoreceber"));
							obj.setCodigoBarra(dadosSQL.getString("codigobarra"));
							obj.setNossoNumero(dadosSQL.getString("nossonumero"));
							obj.setTituloImportadoSistemaLegado(dadosSQL.getBoolean("tituloImportadoSistemaLegado"));
							obj.setRecebimentoBancario((Boolean) dadosSQL.getObject("recebimentoBancario"));
							
							// Dados do Desconto Progressivo						
							obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoprogressivo"));
							obj.setDescontoProgressivoUtilizado(FaixaDescontoProgressivo.getEnum(dadosSQL.getString("descontoprogressivoutilizado")));
							obj.getDescontoProgressivo().setNome(dadosSQL.getString("descontoprogressivo.nome"));
							obj.getDescontoProgressivo().setDiaLimite1(dadosSQL.getInt("descontoprogressivo.dialimite1"));
							obj.getDescontoProgressivo().setDiaLimite2(dadosSQL.getInt("descontoprogressivo.dialimite2"));
							obj.getDescontoProgressivo().setDiaLimite3(dadosSQL.getInt("descontoprogressivo.dialimite3"));
							obj.getDescontoProgressivo().setDiaLimite4(dadosSQL.getInt("descontoprogressivo.dialimite4"));											
							obj.getDescontoProgressivo().setPercDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.percdescontolimite1"));
							obj.getDescontoProgressivo().setPercDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.percdescontolimite2"));
							obj.getDescontoProgressivo().setPercDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.percdescontolimite3"));
							obj.getDescontoProgressivo().setPercDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.percdescontolimite4"));						
							obj.getDescontoProgressivo().setValorDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.valordescontolimite1"));
							obj.getDescontoProgressivo().setValorDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.valordescontolimite2"));
							obj.getDescontoProgressivo().setValorDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.valordescontolimite3"));
							obj.getDescontoProgressivo().setValorDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.valordescontolimite4"));
							obj.getDescontoProgressivo().setUtilizarDiaFixo(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaFixo"));
							obj.getDescontoProgressivo().setUtilizarDiaUtil(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaUtil"));
							obj.setContaEditadaManualmente(dadosSQL.getBoolean("contaEditadaManualmente"));
							obj.setUtilizarDescontoProgressivoManual(dadosSQL.getBoolean("utilizarDescontoProgressivoManual"));
							if (obj.getUtilizarDescontoProgressivoManual()) {
								obj.setDiaLimite1(dadosSQL.getInt("diaLimite1"));
								obj.setDiaLimite2(dadosSQL.getInt("diaLimite2"));
								obj.setDiaLimite3(dadosSQL.getInt("diaLimite3"));
								obj.setDiaLimite4(dadosSQL.getInt("diaLimite4"));
							}
							if (obj.getUtilizarDescontoProgressivoManual()) {
								obj.getDescontoProgressivo().setDescontoProgressivoEditadoManualmenteContaReceber(Boolean.TRUE);
								obj.getDescontoProgressivo().setDiaLimite1(obj.getDiaLimite1());
								obj.getDescontoProgressivo().setDiaLimite2(obj.getDiaLimite2());
								obj.getDescontoProgressivo().setDiaLimite3(obj.getDiaLimite3());
								obj.getDescontoProgressivo().setDiaLimite4(obj.getDiaLimite4());
							}
							// TODO Alberto 08/12/10 acrescentado valor fixo
							// desconto
							// progressivo
							// Desconto Lançado Recebimento
							obj.setValorDescontoLancadoRecebimento(dadosSQL.getDouble("valorDescontoLancadoRecebimento"));
							obj.setValorCalculadoDescontoLancadoRecebimento(dadosSQL.getDouble("valorCalculadoDescontoLancadoRecebimento"));
							obj.setTipoDescontoLancadoRecebimento(dadosSQL.getString("tipoDescontoLancadoRecebimento"));
							// montar dados plano desconto
							obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
							obj.setListaCentroResultadoOrigem(getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().consultaRapidaPorCodOrigemPorTipoCentroResultadoOrigemEnum(obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
							obj.setDetalhamentoValorContaVOs(getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().consultaRapidaPorOrigemCodigoOrigemConta(OrigemDetalhamentoContaEnum.CONTA_RECEBER, obj.getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
							obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
							obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
							obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
							obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
							obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
							obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
							obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
							obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
							obj.setTipoDesconto(dadosSQL.getString("tipodesconto"));
							obj.setValorDescontoRecebido(dadosSQL.getDouble("valordescontorecebido"));
							obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
							obj.setValorCusteadoContaReceber(dadosSQL.getDouble("valorCusteadoContaReceber"));
							obj.setValorBaseContaReceber(dadosSQL.getDouble("valorBaseContaReceber"));
							obj.setJustificativaDesconto(dadosSQL.getString("justificativaDesconto"));
							obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
							obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));
							obj.getMatriculaAluno().getPlanoFinanceiroAluno().setDescontoValidoAteDataParcela(dadosSQL.getBoolean("planofinanceiroaluno.descontoValidoAteDataParcela"));

							obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeEnsino"));
							obj.getUnidadeEnsino().getCidade().setCodigo(dadosSQL.getInt("cidade"));
							if (!configuracaoFinanceiroMap.containsKey(obj.getUnidadeEnsinoFinanceira().getCodigo())) {
								configuracaoFinanceiroMap.put(obj.getUnidadeEnsinoFinanceira().getCodigo(), getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarPorUnidadeEnsino(obj.getUnidadeEnsinoFinanceira().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
							}
							ConfiguracaoFinanceiroVO configuracaoFinanceiroVO = configuracaoFinanceiroMap.get(obj.getUnidadeEnsinoFinanceira().getCodigo());
							/**
							 * O metodo abaixo simula a melhor data de pagamento da conta pelo aluno, atualizando os valores de 1ª, 2ª, 3ª e 4ª faixa de pagamento
							 */
							Boolean sofreuAlteracao = realizarAtualizacaoValorFaixaDescontoContaReceber(obj, configuracaoFinanceiroVO);
							obj.setRealizandoRecebimento(true);
							obj.setTelaEdicaoContaReceber(true);
							if (configuracaoFinanceiroVO.getVencimentoParcelaDiaUtil()) {
								obj.getDataOriginalVencimento();
								obj.setDataVencimentoDiaUtil(obj.getDataVencimento());
								obj.setDataVencimentoDiaUtil(getFacadeFactory().getContaReceberFacade().obterDataVerificandoDiaUtil(obj.getDataVencimento(), obj.getUnidadeEnsino().getCidade().getCodigo(), null));
								obj.setDataVencimento(obj.getDataVencimentoDiaUtil());
							}						
							obj.setValorRecebido(obj.getCalcularValorFinal(dataReceber, configuracaoFinanceiroVO, false, dataReceber, usuario));
							obj.setDataVencimento(obj.getDataOriginalVencimento());
							getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().geracaoCentroResultadoOrigemPadraoPorContaReceber(obj, true, usuario);
							obj.setRealizandoRecebimento(false);
							getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().realizarProcessamentoDeAtualizacaoDetalhamentoValorContaReceber(obj, dataReceber, configuracaoFinanceiroVO, usuario);
							for (CentroResultadoOrigemVO cro : obj.getListaCentroResultadoOrigem()) {
								cro.calcularValor(obj.getValorReceberCalculado());
								if(Uteis.isAtributoPreenchido(cro)){
									getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().atualizarCentroResultadoOrigemVOCampoValor(cro, usuario);
								}else{
									getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().persistir(cro, obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, false, false, usuario, false);	
								}
							}
							suspenderConvenioDeFinanciamentoProprioContaReceber(listaContaReceberCanceladaPorFinanciamentoProprio, obj, dataReceber);
					
							
							gravarValorFinalContaReceberAtualizadoComAcrescimosEDescontos(obj, sofreuAlteracao, usuario, verificarCompetencia);
							if (contaReceberProcessar != null && !contaReceberProcessar.isEmpty()) {
								for (ContaReceberVO cr : contaReceberProcessar) {
									if (cr.getCodigo().equals(obj.getCodigo())) {
										cr.setValorIndiceReajustePorAtraso(obj.getValorIndiceReajustePorAtraso());
										cr.setJuro(obj.getJuro());
										cr.setMulta(obj.getMulta());
										cr.setAcrescimo(obj.getAcrescimo());
										cr.setValorReceberCalculado(obj.getSituacao().equals(SituacaoContaReceber.NEGOCIADO.getValor()) ? obj.getValorReceberCalculado() : obj.getValorRecebido());
										cr.setValorDescontoCalculado(obj.getValorTotalDescontoContaReceber());
										cr.setValorDescontoInstituicao(obj.getValorDescontoInstituicao());
										cr.setValorDescontoConvenio(obj.getValorDescontoConvenio());
										cr.setValorDescontoProgressivo(obj.getValorDescontoProgressivo());
										cr.setValorDesconto(obj.getValorDesconto());
										cr.setValorCalculadoDescontoLancadoRecebimento(obj.getValorCalculadoDescontoLancadoRecebimento());
										cr.setValorDescontoAlunoJaCalculado(obj.getValorDescontoAlunoJaCalculado());
										break;
									}
								}
							}
						}
					} catch (Exception e) {
						//System.out.println("NAO FOI POSSIVEL ATUALIZAR PRIMERIA FAIXA DESCONTO CONTA A RECEBER" + obj.toString() + "(" + e.getMessage() + ")");
						getConexao().getJdbcTemplate().update("UPDATE ContaReceber set dataProcessamentoValorReceber = current_date where codigo = " + obj.getCodigo() + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
						registroExecucaoJobVO.setErro(registroExecucaoJobVO.getErro() + "ERRO CONTA RECEBER CODIGO: " + obj.getCodigo() + "  \n");
						// Para a execução via job desse método, não pode ser encerrada caso uma conta dê exceção.
						if (lancarExcecao) {
							throw e;
						}
					} finally {
						obj = null;
					}
				} while (dadosSQL.next());
				if (contaReceberProcessar != null && !contaReceberProcessar.isEmpty()) {
					break;
				}
				dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
			}
		} catch (Exception e) {
			throw e;
		} finally {		
			dataReceber = null;
			configuracaoFinanceiroMap = null;
			dadosSQL = null;
			sql = null;
			registroExecucaoJobVO.setDataTermino(new Date());
			stopwatch.stop();
			getFacadeFactory().getRegistroExecucaoJobFacade().incluirRegistroExecucaoJob(registroExecucaoJobVO, null);
		}

	}
	
	/**
	 * O metodo abaixo simula a melhor data de pagamento da conta pelo aluno, atualizando os valores de 1ª, 2ª, 3ª e 4ª faixa de pagamento
	 * o retorno indica se houve alteraçao na informacao.
	 */
	public Boolean realizarAtualizacaoValorFaixaDescontoContaReceber(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {

		Double valorDescontoCalculadoPrimeiraFaixaDescontos = obj.getValorDescontoCalculadoPrimeiraFaixaDescontos();
		Date dataLimitePrimeiraFaixaDescontos = obj.getDataLimitePrimeiraFaixaDescontos();
		Double valorDescontoCalculadoSegundaFaixaDescontos = obj.getValorDescontoCalculadoSegundaFaixaDescontos();
		Date dataLimiteSegundaFaixaDescontos = obj.getDataLimiteSegundaFaixaDescontos();
		Double valorDescontoCalculadoTerceiraFaixaDescontos = obj.getValorDescontoCalculadoTerceiraFaixaDescontos();
		Date dataLimiteTerceiraFaixaDescontos = obj.getDataLimiteTerceiraFaixaDescontos();
		Double valorDescontoCalculadoQuartaFaixaDescontos = obj.getValorDescontoCalculadoQuartaFaixaDescontos();
		Date dataLimiteQuartaFaixaDescontos = obj.getDataLimiteQuartaFaixaDescontos();
	
		this.realizarAtualizacaoValorDescontoFaixaContaReceber(obj, configuracaoFinanceiroVO, true);
		Boolean sofreuAlteracao = false;
		if (obj.getValorDescontoCalculadoPrimeiraFaixaDescontos() != null && obj.getValorDescontoCalculadoPrimeiraFaixaDescontos() > 0) {
			if (valorDescontoCalculadoPrimeiraFaixaDescontos == null || valorDescontoCalculadoPrimeiraFaixaDescontos.doubleValue() != obj.getValorDescontoCalculadoPrimeiraFaixaDescontos().doubleValue()) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getDataLimitePrimeiraFaixaDescontos() != null) {
			if (dataLimitePrimeiraFaixaDescontos == null || !Uteis.getData(dataLimitePrimeiraFaixaDescontos).equals(Uteis.getData(obj.getDataLimitePrimeiraFaixaDescontos()))) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getValorDescontoCalculadoSegundaFaixaDescontos() != null && obj.getValorDescontoCalculadoSegundaFaixaDescontos() > 0) {
			if (valorDescontoCalculadoSegundaFaixaDescontos == null || valorDescontoCalculadoSegundaFaixaDescontos.doubleValue() != obj.getValorDescontoCalculadoSegundaFaixaDescontos().doubleValue()) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getDataLimitePrimeiraFaixaDescontos() != null) {
			if (dataLimiteSegundaFaixaDescontos == null || !Uteis.getData(dataLimiteSegundaFaixaDescontos).equals(Uteis.getData(obj.getDataLimiteSegundaFaixaDescontos()))) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getValorDescontoCalculadoSegundaFaixaDescontos() != null && obj.getValorDescontoCalculadoSegundaFaixaDescontos() > 0) {
			if (valorDescontoCalculadoSegundaFaixaDescontos == null || valorDescontoCalculadoSegundaFaixaDescontos.doubleValue() != obj.getValorDescontoCalculadoSegundaFaixaDescontos().doubleValue()) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getDataLimitePrimeiraFaixaDescontos() != null) {
			if (dataLimiteSegundaFaixaDescontos == null || !Uteis.getData(dataLimiteSegundaFaixaDescontos).equals(Uteis.getData(obj.getDataLimiteSegundaFaixaDescontos()))) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getValorDescontoCalculadoSegundaFaixaDescontos() != null && obj.getValorDescontoCalculadoSegundaFaixaDescontos() > 0) {
			if (valorDescontoCalculadoSegundaFaixaDescontos == null || valorDescontoCalculadoSegundaFaixaDescontos.doubleValue() != obj.getValorDescontoCalculadoSegundaFaixaDescontos().doubleValue()) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getDataLimiteSegundaFaixaDescontos() != null) {
			if (dataLimiteSegundaFaixaDescontos == null || !Uteis.getData(dataLimiteSegundaFaixaDescontos).equals(Uteis.getData(obj.getDataLimiteSegundaFaixaDescontos()))) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getValorDescontoCalculadoTerceiraFaixaDescontos() != null && obj.getValorDescontoCalculadoTerceiraFaixaDescontos() > 0) {
			if (valorDescontoCalculadoTerceiraFaixaDescontos == null || valorDescontoCalculadoTerceiraFaixaDescontos.doubleValue() != obj.getValorDescontoCalculadoTerceiraFaixaDescontos().doubleValue()) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getDataLimiteTerceiraFaixaDescontos() != null) {
			if (dataLimiteTerceiraFaixaDescontos == null || !Uteis.getData(dataLimiteTerceiraFaixaDescontos).equals(Uteis.getData(obj.getDataLimiteTerceiraFaixaDescontos()))) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getValorDescontoCalculadoQuartaFaixaDescontos() != null && obj.getValorDescontoCalculadoQuartaFaixaDescontos() > 0) {
			if (valorDescontoCalculadoQuartaFaixaDescontos == null || valorDescontoCalculadoQuartaFaixaDescontos.doubleValue() != obj.getValorDescontoCalculadoQuartaFaixaDescontos().doubleValue()) {
				sofreuAlteracao = true;
			}
		}
		if (obj.getDataLimiteQuartaFaixaDescontos() != null) {
			if (dataLimiteQuartaFaixaDescontos == null || !Uteis.getData(dataLimiteQuartaFaixaDescontos).equals(Uteis.getData(obj.getDataLimiteQuartaFaixaDescontos()))) {
				sofreuAlteracao = true;
			}
		}	
		return sofreuAlteracao;
	}

	/**
	 * Este método é responsável por gravar uma conta a receber atualizando somente os valores que podem sofrer variações, todos os dias, em função de novos acrescimos (por exemplo, uma multa/juro que foi gerada a mais por atraso) e/ou em função de variações nos descontos (perca de um desconto progressivo e assim po diante). Este método é utilizado pela Job que todos os dias atualiza todos os valores de um conta a receber (do ponto de vista de acrescimos / descontos) para que os relatórios e o painel gestor do SEI tenham seus dados atualizados e consistentes.
	 * 
	 * @param contaReceber
	 */
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRES_NEW)
	public void gravarValorFinalContaReceberAtualizadoComAcrescimosEDescontos(ContaReceberVO obj, UsuarioVO usuario, Boolean sofreuAlteracao, Boolean verificarCompetencia) throws Exception {
		this.gravarValorFinalContaReceberAtualizadoComAcrescimosEDescontos(obj, sofreuAlteracao, usuario, verificarCompetencia);
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRES_NEW)
	public void gravarValorFinalContaReceberAtualizadoComAcrescimosEDescontos(ContaReceberVO obj, Boolean alterarDescontos, UsuarioVO usuario, Boolean verificarCompetencia) throws Exception {
		if(verificarCompetencia && !obj.getSituacao().equals(SituacaoContaReceber.CANCELADO_FINANCEIRO.getValor()) && !obj.getSituacao().equals(SituacaoContaReceber.NEGOCIADO.getValor())) {
			verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "ALTERAR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);	
		}
		Double valorRecebido = !obj.getSituacao().equals(SituacaoContaReceber.RECEBIDO.getValor()) ? obj.getValorReceberCalculado() : obj.getValorRecebido();		
		AtributoPersistencia atributoPersistencia = new AtributoPersistencia();
		atributoPersistencia.add("valorReceberCalculado", valorRecebido);
		atributoPersistencia.add("valorJuroCalculado",obj.getValorJuroCalculado());
		atributoPersistencia.add("valorMultaCalculado",obj.getValorMultaCalculado());
		atributoPersistencia.add("valordescontoalunojacalculado",obj.getValorDescontoAlunoJaCalculado());
		atributoPersistencia.add("valorDescontoCalculado", obj.getValorTotalDescontoContaReceber());
		atributoPersistencia.add("dataProcessamentoValorReceber", Uteis.getDataJDBC(new Date()));
		atributoPersistencia.add("descontoConvenio",obj.getValorDescontoConvenio());
		atributoPersistencia.add("descontoInstituicao",obj.getValorDescontoInstituicao());
		atributoPersistencia.add("valorDescontoProgressivo",obj.getValorDescontoProgressivo());
		atributoPersistencia.add("valorcalculadodescontolancadorecebimento",obj.getValorCalculadoDescontoLancadoRecebimento());
		atributoPersistencia.add("juro",obj.getSituacao().equals(SituacaoContaReceber.A_RECEBER.getValor()) ? obj.getValorJuroCalculado() : obj.getJuro());
		atributoPersistencia.add("multa",obj.getSituacao().equals(SituacaoContaReceber.A_RECEBER.getValor()) ? obj.getValorMultaCalculado() : obj.getMulta());
		atributoPersistencia.add("valor",obj.getValor());
		atributoPersistencia.add("valorCusteadoContaReceber",obj.getValorCusteadoContaReceber());
		atributoPersistencia.add("valorDesconto", obj.getValorDesconto());
		atributoPersistencia.add("valorIndiceReajustePorAtraso",obj.getValorIndiceReajustePorAtraso());
		atributoPersistencia.add("indiceReajustePadraoPorAtraso",obj.getIndiceReajustePadraoPorAtraso());		
		if (alterarDescontos) {
			atributoPersistencia.add("valorDescontoCalculadoPrimeiraFaixaDescontos",obj.getValorDescontoCalculadoPrimeiraFaixaDescontos());
			atributoPersistencia.add("dataLimitePrimeiraFaixaDescontos", obj.getDataLimitePrimeiraFaixaDescontos() != null ? Uteis.getDataJDBC(obj.getDataLimitePrimeiraFaixaDescontos()): null);
			atributoPersistencia.add("valorDescontoCalculadoSegundaFaixaDescontos",obj.getValorDescontoCalculadoSegundaFaixaDescontos());
			atributoPersistencia.add("dataLimiteSegundaFaixaDescontos", obj.getDataLimiteSegundaFaixaDescontos() != null ? Uteis.getDataJDBC(obj.getDataLimiteSegundaFaixaDescontos()): null);
			atributoPersistencia.add("valorDescontoCalculadoTerceiraFaixaDescontos",obj.getValorDescontoCalculadoTerceiraFaixaDescontos());
			atributoPersistencia.add("dataLimiteTerceiraFaixaDescontos", obj.getDataLimiteTerceiraFaixaDescontos() != null ? Uteis.getDataJDBC(obj.getDataLimiteTerceiraFaixaDescontos()): null);
			atributoPersistencia.add("valorDescontoCalculadoQuartaFaixaDescontos",obj.getValorDescontoCalculadoQuartaFaixaDescontos());
			atributoPersistencia.add("dataLimiteQuartaFaixaDescontos", obj.getDataLimiteQuartaFaixaDescontos() != null ? Uteis.getDataJDBC(obj.getDataLimiteQuartaFaixaDescontos()): null);			
		}
		alterar(obj, "contareceber", atributoPersistencia , new AtributoPersistencia().add("codigo", obj.getCodigo()), usuario);
		atributoPersistencia =  null;
		getFacadeFactory().getPlanoDescontoContaReceberFacade().alterarItensPlanoDescontoContaReceber(obj.getCodigo(), obj.getPlanoDescontoContaReceberVOs(), null);
	}
	
	private void suspenderConvenioDeFinanciamentoProprioContaReceber(List<Integer> listaContaReceberCanceladaPorFinanciamentoProprio, ContaReceberVO contaReceber, Date dataReferenciaQuitacao) throws Exception{
		for (PlanoDescontoContaReceberVO pdcr : contaReceber.getPlanoDescontoContaReceberVOs()) {
			if(pdcr.getIsConvenio()
					&& getFacadeFactory().getParceiroFacade().validarSeParceiroUtilizarFinanciamentoProprioPorCodigoConvenio(pdcr.getConvenio().getCodigo())
					&& !getFacadeFactory().getOperacaoFuncionalidadeFacade().consultarPorCodigoOrigemPorOrigemOperacaoFuncionalidadePorOperacaoFuncionalidade(pdcr.getCodigo(), OrigemOperacaoFuncionalidadeEnum.PLANO_DESCONTO_CONTA_RECEBER, OperacaoFuncionalidadeEnum.CONTA_RECEBER_LIBERAR_SUSPENSAO_CONVENIO, null)
					&& validarSeQuantidadeContaReceberVencidasPorBolsaCusteadoConvenioAptaSuspensao(contaReceber.getMatriculaAluno().getMatricula(), pdcr.getConvenio().getCodigo(), pdcr.getConvenio().getParceiro().getCodigo(), dataReferenciaQuitacao)
					&& ((!pdcr.getConvenio().getAbaterDescontoNoValorMatricula() && contaReceber.getTipoOrigem().equals(TipoOrigemContaReceber.MATRICULA.getValor()))
							|| (!pdcr.getConvenio().getAbaterDescontoNoValorParcela() && !contaReceber.getTipoOrigem().equals(TipoOrigemContaReceber.MATRICULA.getValor())))){
					
				cancelarContaReceberPorSuspensaoFinanciamentoProprio(listaContaReceberCanceladaPorFinanciamentoProprio, contaReceber.getMatriculaAluno().getMatricula(), pdcr.getConvenio().getCodigo(), pdcr.getConvenio().getParceiro().getCodigo());
			}else if(pdcr.getIsConvenio() 
					&& !validarSeQuantidadeContaReceberVencidasPorBolsaCusteadoConvenioAptaSuspensao(contaReceber.getMatriculaAluno().getMatricula(), pdcr.getConvenio().getCodigo(), pdcr.getConvenio().getParceiro().getCodigo(), dataReferenciaQuitacao)){
				pdcr.setSuspensoFinanciamentoProprio(false);
			}
		}
	}
	
	private static boolean validarSeQuantidadeContaReceberVencidasPorBolsaCusteadoConvenioAptaSuspensao(String matricula, Integer convenio, Integer parceiro, Date dataReferenciaQuitacao) throws Exception{
		StringBuilder sb = new StringBuilder();
		sb.append(" select qtdParcelas from ( ");
		sb.append(" select count(distinct contareceber.codigo)as qtdParcelas,  ");
		sb.append(" (select numeroParcelaVencidasSuspenderFinanciamento from  parceiro where codigo = ").append(parceiro).append(" ) as  numeroParcelaVencidasSuspenderFinanciamento  ");
		sb.append(" FROM contareceber ");
		sb.append(" inner join planodescontocontareceber on planodescontocontareceber.contareceber = contareceber.codigo ");
		sb.append(" inner join convenio on convenio.codigo = planodescontocontareceber.convenio ");
		sb.append(" left join contarecebernegociado  on contarecebernegociado.contareceber = contareceber.codigo ");
		sb.append(" where contareceber.tipoorigem  in ('MAT', 'MEN') ");
		sb.append(" and contareceber.datavencimento <  '").append(Uteis.getDataJDBC(dataReferenciaQuitacao)).append("' ");
		sb.append(" and contareceber.matriculaaluno  = '").append(matricula).append("' ");
		sb.append(" and convenio.codigo = ").append(convenio);
		sb.append(" and not exists (  ");
		sb.append(" select 1 from operacaofuncionalidade ");
		sb.append(" where operacaofuncionalidade.codigoOrigem = contareceber.codigo::text ");
		sb.append(" and operacaofuncionalidade.origem='CONTA_RECEBER' ");
		sb.append(" and operacaofuncionalidade.operacao = 'CONTA_RECEBER_LIBERAR_SUSPENSAO_CONVENIO' ) ");
		sb.append(" and (contareceber.situacao  = 'AR'  ");
		sb.append("  or (contareceber.situacao  = 'NE' and not exists ( ");
		sb.append("  select codigo from contareceber cr where cr.tipoorigem = 'NCR' ");
		sb.append("  and cr.codorigem = contarecebernegociado.negociacaocontareceber::VARCHAR ");
		sb.append("  and cr.situacao = 'RE'))) ");
		sb.append("   ");
		sb.append(" ) as tabela where qtdParcelas >= numeroParcelaVencidasSuspenderFinanciamento ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		return Uteis.isAtributoPreenchido(tabelaResultado, "qtdParcelas", TipoCampoEnum.INTEIRO);
	}
	
	
	
	
	private void cancelarContaReceberPorSuspensaoFinanciamentoProprio(List<Integer> listaContaReceberCanceladaPorFinanciamentoProprio, String matricula, Integer convenio, Integer parceiro) throws Exception{
		StringBuilder sb = new StringBuilder();
		StringBuilder sbIn = new StringBuilder();
		sb.append(" select contareceber.codigo ");
		sb.append(" FROM contareceber ");
		sb.append(" where contareceber.tipoorigem  = 'BCC' and contareceber.situacao  = 'AR' ");
		sb.append(" and contareceber.matriculaaluno  = '").append(matricula).append("' ");
		sb.append(" and contareceber.convenio = ").append(convenio);
		sb.append(" and contareceber.parceiro = ").append(parceiro);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while(tabelaResultado.next()) {
			UteisTexto.addCampoParaClausaIn(sbIn, tabelaResultado.getString("codigo"));
			listaContaReceberCanceladaPorFinanciamentoProprio.add(tabelaResultado.getInt("codigo"));	
		}
		if(!sbIn.toString().isEmpty()){
			sb = new StringBuilder();
			sb.append(" UPDATE ContaReceber set ");
			sb.append(" situacao = '").append(SituacaoContaReceber.CANCELADO_FINANCEIRO.getValor()).append("', ");
			sb.append(" motivoCancelamento = '").append("Cancelamento por suspensão do convenio financiamento proprio.").append("', ");
			/*sb.append(" responsavelCancelamento = ").append(usuario.getCodigo()).append(", ");*/
			sb.append(" dataCancelamento = '").append(Uteis.getDataJDBCTimestamp(new Date())).append("', ");
			sb.append(" updated = '").append(Uteis.getDataJDBCTimestamp(new Date())).append("' ");
			sb.append(" Where codigo in (").append(sbIn).append(") ");			
			getConexao().getJdbcTemplate().update(sb.toString());	
		}
	}
	
	private void realizarVerificacaoELiberacaoSuspensaoConvenioFinanciamentoProprio(ContaReceberVO contaReceber, boolean estorno, UsuarioVO usuario) throws Exception{
		List<PlanoDescontoContaReceberVO> listaPlanoDescontoContaReceberVO = new ArrayList<>();
		if(contaReceber.getTipoOrigem().equals("NCR") && !Uteis.isAtributoPreenchido(contaReceber.getPlanoDescontoContaReceberVOs())){
			listaPlanoDescontoContaReceberVO = getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorCodigoOrigemDaContaReceberNegociada(contaReceber.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
		}else{
			listaPlanoDescontoContaReceberVO = contaReceber.getPlanoDescontoContaReceberVOs();	
		}
		for (PlanoDescontoContaReceberVO pdcr : listaPlanoDescontoContaReceberVO) {
			if(pdcr.isSuspensoFinanciamentoProprio() && pdcr.getIsConvenio()
					&& (
							(!estorno && !validarSeQuantidadeContaReceberVencidasPorBolsaCusteadoConvenioAptaSuspensao(contaReceber.getMatriculaAluno().getMatricula(), pdcr.getConvenio().getCodigo(), pdcr.getConvenio().getParceiro().getCodigo(), new Date()))
							|| 
							(estorno && validarSeExisteContaReceberDaMatriculaNaoSuspensa(contaReceber.getMatriculaAluno().getMatricula(), pdcr.getConvenio().getCodigo()))
						)
					){
				processarLiberacaoSuspensaoConvenioFinanciamentoProprio(contaReceber.getMatriculaAluno().getMatricula(), pdcr.getConvenio().getCodigo(), pdcr.getConvenio().getParceiro().getCodigo() , estorno, usuario);
				if(estorno 
						&& Uteis.isAtributoPreenchido(contaReceber.getValorDescontoConvenio()) 
						&& Uteis.isAtributoPreenchido(pdcr.getValorUtilizadoRecebimento())){
					contaReceber.setValorDescontoConvenio(Uteis.arrendondarForcando2CadasDecimais(contaReceber.getValorDescontoConvenio() - pdcr.getValorUtilizadoRecebimento()));
					pdcr.setValorUtilizadoRecebimento(0.0);
				}
			}
		}
		
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public  void processarLiberacaoSuspensaoConvenioFinanciamentoProprio(String matricula, Integer convenio, Integer parceiro, boolean estorno, UsuarioVO usuario) throws Exception {
		List<ContaReceberVO> contaReceberProcessar = new ArrayList<>();
		StringBuilder sb = new StringBuilder();
		StringBuilder sbIn = new StringBuilder();
		sb.append(" select contareceber.codigo,  contareceber.dataCompetencia ");
		sb.append(" FROM contareceber ");
		sb.append(" inner join planodescontocontareceber on planodescontocontareceber.contareceber = contareceber.codigo ");
		sb.append(" inner join convenio on convenio.codigo = planodescontocontareceber.convenio ");
		sb.append(" where contareceber.tipoorigem  in ('MAT', 'MEN') and contareceber.situacao  = 'AR' ");
		sb.append(" and contareceber.matriculaaluno  = '").append(matricula).append("' ");
		sb.append(" and convenio.codigo = ").append(convenio);
		if(estorno){
			sb.append(" and planodescontocontareceber.suspensofinanciamentoproprio = false ");
		}else{
			sb.append(" and planodescontocontareceber.suspensofinanciamentoproprio = true ");
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while(tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			contaReceberProcessar.add(obj);
			UteisTexto.addCampoParaClausaIn(sbIn, "'"+Uteis.getDataMesAnoConcatenado(tabelaResultado.getDate("datacompetencia"))+"'");
		}
		if(!contaReceberProcessar.isEmpty()){
			realizarProcessamentoValorFinalContaReceberAtualizadoComAcrescimosEDescontos(null, contaReceberProcessar, false, "", true, usuario, true , false , null , null, true);
			if(Uteis.isAtributoPreenchido(parceiro)){
				atualizarContaReceberDoConvenioPorValidacaoFinanciamentoProprio(matricula ,convenio, parceiro , estorno, sbIn);	
			}
		}
	}
	
	

	private void atualizarContaReceberDoConvenioPorValidacaoFinanciamentoProprio(String matricula, Integer convenio, Integer parceiro, boolean estorno, StringBuilder sbIn) throws Exception {
		if(!estorno){
			StringBuilder sb = new StringBuilder();
			sb.append(" UPDATE ContaReceber set ");
			sb.append(" situacao = '").append(SituacaoContaReceber.A_RECEBER.getValor()).append("', ");
			sb.append(" motivoCancelamento = null, ");
			sb.append(" responsavelCancelamento =  null, ");
			sb.append(" dataCancelamento = null, ");
			sb.append(" updated = '").append(Uteis.getDataJDBCTimestamp(new Date())).append("' ");
			sb.append(" Where codigo in ( ");
			sb.append(" select contareceber.codigo ");
			sb.append(" FROM contareceber ");
			sb.append(" where contareceber.tipoorigem  = 'BCC' and contareceber.situacao  = 'CF' ");
			sb.append(" and contareceber.matriculaaluno  = '").append(matricula).append("' ");
			sb.append(" and contareceber.convenio = ").append(convenio);
			sb.append(" and contareceber.parceiro = ").append(parceiro);
			sb.append(" and (to_char(contareceber.datacompetencia, 'MM/YYYY') in (").append(sbIn.toString()).append(")) ");
			sb.append(" )" );				
			getConexao().getJdbcTemplate().update(sb.toString());
		}
	}
	
	private boolean validarSeExisteContaReceberDaMatriculaNaoSuspensa(String matricula, Integer convenio) throws Exception{
		StringBuilder sb = new StringBuilder();
		sb.append(" select count(contareceber.codigo) as qtd ");
		sb.append(" FROM contareceber ");
		sb.append(" inner join planodescontocontareceber on planodescontocontareceber.contareceber = contareceber.codigo ");
		sb.append(" inner join convenio on convenio.codigo = planodescontocontareceber.convenio ");
		sb.append(" where contareceber.tipoorigem  in ('MAT', 'MEN') and contareceber.situacao  = 'AR' ");
		sb.append(" and contareceber.matriculaaluno  = '").append(matricula).append("' ");
		sb.append(" and convenio.codigo = ").append(convenio);
		sb.append(" and planodescontocontareceber.suspensofinanciamentoproprio = false ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		return Uteis.isAtributoPreenchido(tabelaResultado, "qtd", TipoCampoEnum.INTEIRO);
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Throwable.class, propagation = Propagation.REQUIRED)
	public void realizarLiberacaoSuspensaoConvenioPorOperacaoFuncionalidade(ContaReceberVO contaReceber, PlanoDescontoContaReceberVO pdcr, UsuarioVO usuarioVerif, ConfiguracaoFinanceiroVO config,  UsuarioVO usuario) throws Exception {
		try {
			if(!Uteis.isAtributoPreenchido(pdcr)){
				for (PlanoDescontoContaReceberVO objExistente : contaReceber.getPlanoDescontoConvenioCusteadoContaReceber()) {
					objExistente.setSuspensoFinanciamentoProprio(false);	
					OperacaoFuncionalidadeVO of = getFacadeFactory().getOperacaoFuncionalidadeFacade().executarGeracaoOperacaoFuncionalidade(OrigemOperacaoFuncionalidadeEnum.PLANO_DESCONTO_CONTA_RECEBER, objExistente.getCodigo().toString(), OperacaoFuncionalidadeEnum.CONTA_RECEBER_LIBERAR_SUSPENSAO_CONVENIO, usuarioVerif, "");
					getFacadeFactory().getOperacaoFuncionalidadeFacade().incluir(of);
				}
			}else{
				for (PlanoDescontoContaReceberVO objExistente : contaReceber.getPlanoDescontoConvenioContaReceber()) {
					if(objExistente.getCodigo().equals(pdcr.getCodigo())){
						objExistente.setSuspensoFinanciamentoProprio(false);
						OperacaoFuncionalidadeVO of = getFacadeFactory().getOperacaoFuncionalidadeFacade().executarGeracaoOperacaoFuncionalidade(OrigemOperacaoFuncionalidadeEnum.PLANO_DESCONTO_CONTA_RECEBER, objExistente.getCodigo().toString(), OperacaoFuncionalidadeEnum.CONTA_RECEBER_LIBERAR_SUSPENSAO_CONVENIO, usuarioVerif, "");
						getFacadeFactory().getOperacaoFuncionalidadeFacade().incluir(of);
						break;
					}
				}
			}
			contaReceber.getCalcularValorFinal(new Date(), config, false, new Date(), usuario);
			StringBuilder sbIn =new StringBuilder();
			UteisTexto.addCampoParaClausaIn(sbIn, "'"+Uteis.getDataMesAnoConcatenado(contaReceber.getDataCompetencia())+"'");
			getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().realizarProcessamentoDeAtualizacaoDetalhamentoValorContaReceber(contaReceber, new Date(), config, usuario);
			gravarValorFinalContaReceberAtualizadoComAcrescimosEDescontos(contaReceber, usuario, false, true);
			if(Uteis.isAtributoPreenchido(pdcr)){
				atualizarContaReceberDoConvenioPorValidacaoFinanciamentoProprio(contaReceber.getMatriculaAluno().getMatricula(), pdcr.getConvenio().getCodigo(), pdcr.getConvenio().getParceiro().getCodigo(), false, sbIn);
			}
		} catch (Exception e) {
			throw e;
		}
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public  void realizarProcessamentoLiberacaoSuspensaoConvenioFinanciamentoProprio(ContaReceberVO contaReceber, PlanoDescontoContaReceberVO pdcr, UsuarioVO usuario) throws Exception {
		if(!Uteis.isAtributoPreenchido(pdcr)){
			for (PlanoDescontoContaReceberVO objExistente : contaReceber.getPlanoDescontoConvenioCusteadoContaReceber()) {
				processarLiberacaoSuspensaoConvenioFinanciamentoProprio(contaReceber.getMatriculaAluno().getMatricula(), objExistente.getConvenio().getCodigo(), null, false, usuario);
			}
		}else{
			processarLiberacaoSuspensaoConvenioFinanciamentoProprio(contaReceber.getMatriculaAluno().getMatricula(), pdcr.getConvenio().getCodigo(), pdcr.getConvenio().getParceiro().getCodigo(), false, usuario);
		}
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void regerarBolsaCusteadaConvenio(ContaReceberVO contaReceber, ConfiguracaoFinanceiroVO configFinan, UsuarioVO usuario) throws Exception {
		MatriculaVO mat = getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(contaReceber.getMatriculaAluno().getMatricula(), contaReceber.getMatriculaAluno().getUnidadeEnsino().getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, configFinan, usuario);
		MatriculaPeriodoVO matriculaPeriodoVO = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(contaReceber.getMatriculaPeriodo(), Uteis.NIVELMONTARDADOS_TODOS, configFinan, usuario)	;
		matriculaPeriodoVO.setConfiguracaoFinanceiro(configFinan);
		
		MatriculaPeriodoVencimentoVO  vctoGerar = null; 
		for (MatriculaPeriodoVencimentoVO mpvExistente : matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()) {
			if(mpvExistente.getContaReceber().getCodigo().equals(contaReceber.getCodigo())) {
				mpvExistente.setValor(contaReceber.getValorBaseContaReceber());
				vctoGerar = mpvExistente;
				break;
			}
		}		
		if(contaReceber.getIsContaReceberReferenteMatricula()){
			getFacadeFactory().getMatriculaPeriodoFacade().criarContaReceberBolsaCusteadaMatricula(mat, matriculaPeriodoVO, matriculaPeriodoVO.getProcessoMatriculaCalendarioVO(), configFinan, vctoGerar, contaReceber, usuario);	
		} else if (contaReceber.getIsContaReceberReferenteMensalidade()) {
			getFacadeFactory().getMatriculaPeriodoFacade().criarContaReceberNaoPagasBolsaCusteadaMensalidades(mat, matriculaPeriodoVO, configFinan, vctoGerar, usuario, false);	
		} 
	}
	
	

	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarAtualizacaoNumeroParcelaContaReceberMensalidade(Integer matriculaPeriodo, Integer totalParcela, UsuarioVO usuario) throws Exception {
		StringBuilder sql = new StringBuilder("select codigo, parcela from contareceber ");
		sql.append(" where codorigem = '").append(matriculaPeriodo).append("' and tipoorigem  = 'MEN' order by datavencimento ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		Map<Integer, String> contaReceberParcela = new HashMap<Integer, String>(0);
		int totalParcelaCriada = 0;
		while (rs.next()) {
			contaReceberParcela.put(rs.getInt("codigo"), rs.getString("parcela"));
			totalParcelaCriada++;
		}
		if (totalParcelaCriada > totalParcela) {
			totalParcela = totalParcelaCriada;
		}
		String parcela = null;
		for (Integer key : contaReceberParcela.keySet()) {
			parcela = contaReceberParcela.get(key);
			if (parcela.contains("/")) {
				parcela = parcela.substring(0, parcela.indexOf("/")) + "/" + totalParcela;
				getConexao().getJdbcTemplate().update("UPDATE contareceber set parcela = '" + parcela + "', descricaopagamento = replace(descricaopagamento, '" + contaReceberParcela.get(key) + "', '" + parcela + "') where codigo = " + key + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
				getConexao().getJdbcTemplate().update("UPDATE matriculaperiodovencimento set parcela = '" + parcela + "', descricaopagamento = replace(descricaopagamento, '" + contaReceberParcela.get(key) + "', '" + parcela + "')  where contareceber = " + key + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
			}
		}

	}

	@Override
	public List<ContaReceberVO> consultaRapidaPorNomeAlunoLimiteOffset(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO,List<String> ordenador) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE (sem_acentos(pessoamatricula.nome) iLIKE sem_acentos(?)) AND");
		if (unidadeEnsino.intValue() != 0) {
			sql.append(" (contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append(" (ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")) AND");
		}

		if (!consDataCompetencia) {
			sql.append(" (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append(" (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}

		sql.append(" AND contareceber.convenio is null ");
		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		if (Uteis.isAtributoPreenchido(ordenador)) {
			sql.append("ORDER BY ").append(UteisTexto.converteListaStringParaString(ordenador));
		} else {
			sql.append(
					" ORDER BY contareceber.matriculaaluno, contareceber.datavencimento, contareceber.datacompetencia ");
		}
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta+"%");
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public Integer consultaRapidaPorNomeAlunoTotalRegistros(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasicaTotalRegistros();
		sql.append("WHERE (sem_acentos(pessoamatricula.nome) ilike sem_acentos(?)) AND ");
		if (unidadeEnsino.intValue() != 0) {
			sql.append("(contareceber.unidadeEnsinoFinanceira = ").append(unidadeEnsino).append(") AND ");
		}

		if (!consDataCompetencia) {
			sql.append("(contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sql.append("(contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		sql.append(montarSqlSituacoes(situacao));
		sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sql.append(" AND contareceber.convenio is null ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta+"%");
		if (resultado.next()) {
			return resultado.getInt("count");
		} else {
			return 0;
		}
	}

	public int consultarParcelaPorCodOrigemTipoOrigem(String tipoOrigem, Integer codigoOrigem, boolean controlarAcesso, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT COUNT(codOrigem) as qtdeParcela FROM ContaReceber WHERE upper( tipoOrigem ) = '" + tipoOrigem.toUpperCase() + "' and codOrigem = '" + String.valueOf(codigoOrigem) + "'";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("qtdeParcela");
		} else {
			return 0;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarCorrecaoValorRecebidoPlanoDescontoEConvenioContaReceber(UsuarioVO usuario) throws Exception {
		try {
			realizarCorrecaoValorRecebidoPlanoDescontoContaReceber(usuario);
			realizarCorrecaoValorRecebidoConvenioContaReceber(usuario);
		} catch (Exception e) {
			//// System.out.println(e.getMessage());
			throw e;
		}
	}

	private void realizarCorrecaoValorRecebidoPlanoDescontoContaReceber(UsuarioVO usuario) throws Exception {

		StringBuilder sql = new StringBuilder("");
		sql.append(" select planodescontocontareceber.codigo as planodescontocontareceber, valorutilizadorecebimento, contareceber.codigo, contareceber.tipoOrigem, contareceber.valorrecebido, ");
		sql.append(" contareceber.descontoinstituicao, planodesconto.tipoDescontoParcela, planodesconto.percDescontoParcela, planodesconto.tipoDescontoMatricula, planodesconto.percDescontoMatricula, qtdeDesconto ");
		sql.append(" from  planodescontocontareceber");
		sql.append(" inner join ( ");
		sql.append(" select contareceber.codigo, descontoinstituicao, contareceber.valorrecebido, contareceber.tipoOrigem, ");
		sql.append(" (select count(planodescontocontareceber.codigo) from planodescontocontareceber ");
		sql.append(" where tipoitemplanofinanceiro = 'PD' and  planodescontocontareceber.contareceber = contareceber.codigo  ) as qtdeDesconto ");
		sql.append(" from contareceber where situacao = 'RE' and descontoinstituicao > 0 ");
		sql.append(" and (select sum(case when planodescontocontareceber.valorutilizadorecebimento is null then 0.0 else valorutilizadorecebimento end) from planodescontocontareceber ");
		sql.append(" where tipoitemplanofinanceiro = 'PD' and  planodescontocontareceber.contareceber = contareceber.codigo  ) !=  descontoinstituicao ");
		sql.append(" ) as contareceber on contareceber.codigo = planodescontocontareceber.contareceber ");
		sql.append(" inner join planodesconto on planodesconto.codigo = planodescontocontareceber.planodesconto ");
		sql.append(" where (planodescontocontareceber.valorutilizadorecebimento is null or planodescontocontareceber.valorutilizadorecebimento = 0.0) ");
		sql.append(" and planodescontocontareceber.tipoitemplanofinanceiro='PD' order by contareceber.codigo ");

		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		Double valorUtilizado = 0.0;
		Double valorUtilizar = 0.0;
		String tipoDesconto = "";
		Double percDesconto = 0.0;
		Integer codigoContaReceber = 0;
		Integer count = 1;
		while (rs.next()) {
			if (codigoContaReceber == 0 || codigoContaReceber != rs.getInt("codigo")) {
				count = 1;
				valorUtilizado = 0.0;
				valorUtilizar = 0.0;
				codigoContaReceber = rs.getInt("codigo");
			}
			if (rs.getDouble("valorutilizadorecebimento") > 0) {
				valorUtilizado += rs.getDouble("valorutilizadorecebimento");
			} else if (valorUtilizado < rs.getDouble("descontoinstituicao")) {
				if (rs.getString("tipoOrigem").equals("MAT")) {
					percDesconto = rs.getDouble("percDescontoMatricula");
					tipoDesconto = rs.getString("tipoDescontoMatricula");
				} else {
					percDesconto = rs.getDouble("percDescontoParcela");
					tipoDesconto = rs.getString("tipoDescontoParcela");
				}
				if (count == rs.getInt("qtdeDesconto")) {
					valorUtilizar = rs.getDouble("descontoinstituicao") - valorUtilizado;
				} else {
					if (tipoDesconto.equals("VE")) {
						if (percDesconto > rs.getDouble("descontoinstituicao") - valorUtilizado) {
							valorUtilizar = rs.getDouble("descontoinstituicao") - valorUtilizado;
						} else {
							valorUtilizar = percDesconto;
						}
					} else {
						valorUtilizar = rs.getDouble("descontoinstituicao") - ((rs.getDouble("descontoinstituicao") * percDesconto) / 100);
						if (valorUtilizar > rs.getDouble("descontoinstituicao") - valorUtilizado) {
							valorUtilizar = rs.getDouble("descontoinstituicao") - valorUtilizado;
						}
					}
				}
				getConexao().getJdbcTemplate().update("UPDATE planodescontocontareceber set valorutilizadorecebimento = " + valorUtilizar + " where codigo = " + rs.getInt("planodescontocontareceber") + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
				valorUtilizado += valorUtilizar;
			}
			count++;
		}

	}

	private void realizarCorrecaoValorRecebidoConvenioContaReceber(UsuarioVO usuario) throws Exception {
		StringBuilder sql = new StringBuilder("");
		sql.append(" select planodescontocontareceber.codigo as planodescontocontareceber, valorutilizadorecebimento, contareceber.codigo, contareceber.tipoOrigem, contareceber.valorrecebido, ");
		sql.append(" contareceber.descontoconvenio, convenio.tipoDescontoParcela, convenio.descontoParcela, convenio.tipoDescontoMatricula, convenio.descontoMatricula, qtdeDesconto ");
		sql.append(" from  planodescontocontareceber");
		sql.append(" inner join ( ");
		sql.append(" select contareceber.codigo, descontoconvenio, contareceber.valorrecebido, contareceber.tipoOrigem, ");
		sql.append(" (select count(planodescontocontareceber.codigo) from planodescontocontareceber ");
		sql.append(" where tipoitemplanofinanceiro = 'CO' and  planodescontocontareceber.contareceber = contareceber.codigo  ) as qtdeDesconto ");
		sql.append(" from contareceber where situacao = 'RE' and descontoconvenio > 0 ");
		sql.append(" and (select sum(case when planodescontocontareceber.valorutilizadorecebimento is null then 0.0 else valorutilizadorecebimento end) from planodescontocontareceber ");
		sql.append(" where tipoitemplanofinanceiro = 'CO' and  planodescontocontareceber.contareceber = contareceber.codigo  ) !=  descontoconvenio ");
		sql.append(" ) as contareceber on contareceber.codigo = planodescontocontareceber.contareceber ");
		sql.append(" inner join convenio on convenio.codigo = planodescontocontareceber.convenio ");
		// sql.append(" where (planodescontocontareceber.valorutilizadorecebimento is null or planodescontocontareceber.valorutilizadorecebimento = 0.0) ");
		// sql.append(" and planodescontocontareceber.tipoitemplanofinanceiro='CO' ");
		sql.append(" order by contareceber.codigo ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		Double valorUtilizado = 0.0;
		Double valorUtilizar = 0.0;
		String tipoDesconto = "";
		Double percDesconto = 0.0;
		Integer codigoContaReceber = 0;
		Integer count = 1;
		while (rs.next()) {
			if (codigoContaReceber == 0 || codigoContaReceber != rs.getInt("codigo")) {
				count = 1;
				valorUtilizado = 0.0;
				codigoContaReceber = rs.getInt("codigo");
			}
			if (rs.getDouble("valorutilizadorecebimento") > 0) {
				valorUtilizado += rs.getDouble("valorutilizadorecebimento");
			} else if (valorUtilizado < rs.getDouble("descontoconvenio")) {
				if (rs.getString("tipoOrigem").equals("MAT")) {
					percDesconto = rs.getDouble("descontoMatricula");
					tipoDesconto = rs.getString("tipoDescontoMatricula");
				} else {
					percDesconto = rs.getDouble("descontoParcela");
					tipoDesconto = rs.getString("tipoDescontoParcela");
				}
				if (count == rs.getInt("qtdeDesconto")) {
					valorUtilizar = rs.getDouble("descontoconvenio") - valorUtilizado;
				} else {
					if (tipoDesconto.equals("VA")) {
						if (percDesconto > rs.getDouble("descontoconvenio") - valorUtilizado) {
							valorUtilizar = rs.getDouble("descontoconvenio") - valorUtilizado;
						} else {
							valorUtilizar = percDesconto;
						}
					} else {
						valorUtilizar = rs.getDouble("descontoconvenio") - ((rs.getDouble("descontoconvenio") * percDesconto) / 100);
						if (valorUtilizar > rs.getDouble("descontoconvenio") - valorUtilizado) {
							valorUtilizar = rs.getDouble("descontoconvenio") - valorUtilizado;
						}
					}
				}
				getConexao().getJdbcTemplate().update("UPDATE planodescontocontareceber set valorutilizadorecebimento = " + valorUtilizar + " where codigo = " + rs.getInt("planodescontocontareceber") + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
				valorUtilizado += valorUtilizar;
			}
			count++;
		}

	}

	@Override
	public List<ContaReceberVO> consultarPorCodigoAgrupamento(Integer codigoAgrupamento, NivelMontarDados nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		List<ContaReceberVO> contaReceberVOs = new ArrayList<ContaReceberVO>(0);
		StringBuilder sql = null;
		SqlRowSet tabelaResultado = null;
		if (nivelMontarDados.equals(NivelMontarDados.TODOS)) {
			sql = new StringBuilder("SELECT codigo from ContaReceber ");
			sql.append(" WHERE (contareceber.contareceberagrupada = ?) order by contareceber.codigo ");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), new Object[] { codigoAgrupamento });
			while (tabelaResultado.next()) {
				ContaReceberVO obj = new ContaReceberVO();
				obj.setCodigo(tabelaResultado.getInt("codigo"));
				carregarDados(obj, nivelMontarDados, configuracaoFinanceiroVO, usuarioVO);
				contaReceberVOs.add(obj);
			}
		} else {
			sql = getSQLPadraoConsultaBasica();
			sql.append(" WHERE (contareceber.contareceberagrupada = ?) order by contareceber.codigo ");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), new Object[] { codigoAgrupamento });
			while (tabelaResultado.next()) {
				ContaReceberVO obj = new ContaReceberVO();
				montarDadosBasico(obj, tabelaResultado);
				contaReceberVOs.add(obj);
			}
		}
		return contaReceberVOs;
	}

	@Override
	public List<ContaReceberVO> consultarContaReceberPorAptaAdicionarAgrupamento(Integer codigoUnidadeEnsino, Date dataVencimento, TipoPessoa tipoPessoa, String matricula, Integer responsavelFinanceiro, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE (contareceber.contareceberagrupada is null) ");
		sql.append(" and contareceber.situacao = 'AR' and contareceber.dataVencimento::DATE >= current_date ");
		sql.append(" and ((contareceber.tipoOrigem not in ('BCC', 'IPS') and contareceber.dataVencimento::DATE = '").append(Uteis.getDataJDBC(dataVencimento)).append("'::DATE ) ");
		sql.append(" or (contareceber.tipoOrigem in ('REQ', 'BIB', 'CTR') and to_char(contareceber.dataVencimento, 'MM/yyyy') = to_char('").append(Uteis.getDataJDBC(dataVencimento)).append("'::DATE, 'MM/yyyy'))) ");
		sql.append(" and ContaReceber.unidadeensinofinanceira = ").append(codigoUnidadeEnsino);
		if (tipoPessoa.equals(TipoPessoa.ALUNO)) {
			sql.append(" and contareceber.matriculaaluno = '").append(matricula).append("' ");
			sql.append(" and contareceber.tipoPessoa = 'AL' ");
		} else {
			sql.append(" and contareceber.responsavelfinanceiro = ").append(responsavelFinanceiro);
			sql.append(" and contareceber.tipoPessoa = 'RF' ");
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		List<ContaReceberVO> contaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			montarDadosBasico(obj, tabelaResultado);
			contaReceberVOs.add(obj);
		}
		return contaReceberVOs;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<Integer> consultarContaReceberPorContaAgrupada(Integer contaReceberAgrupada) {
		StringBuilder sb = new StringBuilder();
		sb.append("select codigo from contareceber where contareceberagrupada = ").append(contaReceberAgrupada);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<Integer> listaCodigoContaReceber = new ArrayList<Integer>(0);
		while (tabelaResultado.next()) {
			listaCodigoContaReceber.add(tabelaResultado.getInt("codigo"));
		}
		return listaCodigoContaReceber;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ContaReceberVO> consultarContaReceberPorNossoNumeroContaAgrupada(String nossoNumero) {
		StringBuilder sb = new StringBuilder();
		sb.append("select contareceber.codigo, contareceber.updated, contareceber.nossoNumero from contareceber ");
		sb.append(" inner join contareceberAgrupada on contareceberAgrupada.codigo = contaReceber.contaReceberAgrupada ");
		sb.append(" where contareceberagrupada.nossoNumero = '").append(nossoNumero).append("' ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<ContaReceberVO> listaContaReceber = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setUpdated(tabelaResultado.getDate("updated"));
			obj.setNossoNumero(tabelaResultado.getString("nossoNumero"));
			listaContaReceber.add(obj);
		}
		return listaContaReceber;
	}

	/**
	 * Método responsável por corrigir todas as contas a receber (recebidas) cuja a soma dos descontos dados armazenados na própria conta a receber são maiores que o valor da conta. Este problema ocorreu em diversas contas a receber quando o SEI não tratava este problema (geralmente existentes para contas com desconto de 100%). Corrigir estas contas a receber é importante para que possamos ter dados confiáveis no painel gestor e nos relatórios do SEI. Como mencionado se entrarmos aqui é por que a conta possui uma soma de descontos superior ao valor da conta original. Logo temos que preservar os descontos de forma proporcional, conforme a ordem de aplicação dos mesmos. Ou seja, se o desconto progressivo for o primeiro a ser aplicado e o mesmo é inferior ao valor da conta a receber, então o mesmo deve ser mantido integralmente. Caso contrário somente parte dele possível de ser aplicado pode ser mantido na conta. Se o segundo desconto a ser aplicado for o desconto institucional temos que avaliar se é possível
	 * aplicar o mesmo integralmente na conta (sem que a soma do desconto seja maior que o valor da conta a receber. Caso não, somente parte do desconto institucional previamente gerado pelo sistema pode ser registrado. E, isto, deve ser feito até o final de todos os descontos. Criado em 22/01/2014. Deve ser executado para todos os clientes ao instalar a versão 4.4.9 do SEI.
	 */
	public void executarCorrecaoBaseDadosDistribuicaoDescontosQuandoDescontoForMaiorQueValorContaReceber(Date dataInicioAtualizacao, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();

		sb.append("select * from (");
		// inicio sub select
		sb.append("select distinct contareceber.tipoOrigem, contareceber.codigo, nossonumero, datavencimento, situacao,  ");
		sb.append("contareceber.valor::NUMERIC(20,2) as valor,  ");
		sb.append("contareceber.valorRecebido::NUMERIC(20,2) as valorRecebido,  ");
		sb.append("case when (contareceber.acrescimo > 0) then contareceber.acrescimo::numeric(20,2) else 0.0::numeric(20,2) end as acrescimo,  ");
		sb.append("case when (contareceber.juro > 0) then contareceber.juro::numeric(20,2) else 0.0::numeric(20,2) end as juro,  ");
		sb.append("case when (contareceber.multa > 0) then contareceber.multa::numeric(20,2) else 0.0::numeric(20,2) end as multa,  ");
		sb.append("case when (descontoconvenio > 0) then descontoconvenio::numeric(20,2) else 0.0::numeric(20,2) end as descontoconvenio,  ");
		sb.append("case when (descontoinstituicao > 0) then descontoinstituicao::numeric(20,2) else 0.0::numeric(20,2) end as descontoinstituicao,  ");
		sb.append("case when (valordescontoprogressivo > 0) then valordescontoprogressivo::numeric(20,2) else 0.0::numeric(20,2) end as descontoprogressivo,  ");
		sb.append("case when (valordescontoalunojacalculado > 0) then valordescontoalunojacalculado::numeric(20,2) else 0.0::numeric(20,2) end as descontoaluno,  ");
		sb.append("case when (valorcalculadodescontolancadorecebimento > 0) then valorcalculadodescontolancadorecebimento::numeric(20,2) else 0.0::numeric(20,2) end as descontorecebimento ");
		sb.append("from contaReceber  ");
		sb.append("where (contaReceber.situacao in ('RE')) "); // and
																// (contaReceber.nossoNumero
																// = '10234896')
		sb.append(" and (contaReceber.dataVencimento >= '").append(Uteis.getDataJDBC(dataInicioAtualizacao)).append("') ");
		// --- fim sub select
		sb.append(") as t ");
		sb.append("where ((valor + acrescimo + juro + multa - descontoConvenio - descontoInstituicao - descontoProgressivo - descontoRecebimento - descontoAluno) != valorRecebido) ");
		// sb.append(" or ((tipoOrigem in ('MAT','MEN')) and (valorRecebido = 0))");
		SqlRowSet tabelResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		HashMap<Integer, ConfiguracaoFinanceiroVO> configuracoesCarregadas = new HashMap<Integer, ConfiguracaoFinanceiroVO>();
		ConfiguracaoFinanceiroVO configuracaoUsar = null;
		while (tabelResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelResultado.getInt("codigo"));
			consultarDadosCompletoCarregandoDescontosOriginaisContaReceberIdenpendenteSituacao(obj, configuracaoUsar, usuarioVO);
			Integer codigoUnidade = obj.getUnidadeEnsino().getCodigo();
			if (!configuracoesCarregadas.containsKey(codigoUnidade)) {
				configuracaoUsar = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_TODOS, codigoUnidade, usuarioVO);
				configuracoesCarregadas.put(codigoUnidade, configuracaoUsar);
			} else {
				configuracaoUsar = configuracoesCarregadas.get(codigoUnidade);
			}
			atualizarValoresDescontoContaReceberQuandoDescontoMaiorQueValorContaReceber(obj, configuracaoUsar, usuarioVO);
		}
	}

	public void consultarDadosCompletoCarregandoDescontosOriginaisContaReceberIdenpendenteSituacao(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		SqlRowSet resultado = null;
		resultado = consultaRapidaPorChavePrimariaDadosCompletos(obj.getCodigo(), Boolean.FALSE, usuarioVO);
		montarDadosCompletoMontandoDescontosOriginais(obj, resultado, configuracaoFinanceiroVO, usuarioVO);
	}

	public void atualizarValoresDescontoContaReceberQuandoDescontoMaiorQueValorContaReceber(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoUsar, UsuarioVO usuarioVO) throws Exception {
		// Se entrarmos aqui é por que a conta possui uma incompatibilidade
		// entre o valorRecebido e a soma
		// dos acrescimentos / soma dos descontos. Ou seja, se pergarmos o valor
		// da conta, somarmos os acrescimentos
		// e deduzirmos os descontos, não chegamos ao valor recebido. O objetivo
		// desta rotina é atualizar os valores
		// dos descontos e os valores dos acrescimento, mas nunca alterar o
		// valor da conta original ou o valor de fato
		// recebido da conta.
		// Aqui podemos ter duas situações:
		// a) a soma dos descontos é inferior ao total de desconto que fato foi
		// dado. Isto pode ter ocorrido em
		// decorrencia de erros no SEI, principalmente quando se trata de contas
		// baixadas com 100% de desconto.
		// Quando o SEI concluia que o desconto era de 100% ele jogava todo o
		// desconto para o valorDesconto do
		// do aluno. Contudo, muitas vezes os demais descontos eram
		// reprocessados de forma errada, gerando a diferença
		// em questão. Para esta situação iremos chamar o método espírita para a
		// conta e deduzir de forma
		// correta a proporcionalidade dos descontos (o que é fies, o que é
		// progressivo, e assim por diante).
		// Recalcular se falta desconto a ser registrado e lançar o mesmo na
		// valorDescontoAluno. Caso o desconto
		// seja superior ao valor da conta original iremos ajustar o desconto,
		// considerando a ordem de aplicação
		// do desconto. Assim, se o progressivo é o primeiro, então o mesmo será
		// mantido integralmente (se for
		// menor que o valor da conta). Depois aplica-se o próximo desconto,
		// considerando também a ordem se o
		// valor do mesmo pode ser aplicado de forma integral.
		// Recapitulando, se o desconto progressivo for o primeiro a ser
		// aplicado e o mesmo é inferior ao valor da
		// conta a receber, então o mesmo deve ser mantido integralmente. Caso
		// contrário somente parte dele possível
		// de ser aplicado pode ser mantido na conta. Se o segundo desconto a
		// ser aplicado for o desconto
		// institucional temos que avaliar se é possível aplicar o mesmo
		// integralmente na conta (sem que a soma
		// do desconto seja maior que o valor da conta a receber. Caso não,
		// somente parte do desconto institucional
		// previamente gerado pelo sistema pode ser registrado. E, isto, deve
		// ser feito até o final de todos os
		// descontos.
		//// System.out.println("======================================");
		//// System.out.println("ANTES - " + obj.toString());

		// Chamando o método espírita para que os valores dos descontos sejam
		// atualizados conforme
		// os convênios, descontos institucionais, progressivos e do aluno.
		String situacaoTemp = obj.getSituacao();
		Double valorRecebidoTemp = obj.getValorRecebido();
		obj.setSituacao("AR");
		// A data de recebimento da conta é importante, pois ela determina quais
		// desconto a pessoa teria direito
		// no ato da quitação da conta a receber.
		Date dataRecebimentoContaAReceber = obj.getDataVencimento();
		try {
			NegociacaoRecebimentoVO neg = getFacadeFactory().getNegociacaoRecebimentoFacade().consultaRapidaPorNossoNumeroUnicaContaReceber(obj.getNossoNumero(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoUsar, usuarioVO);
			dataRecebimentoContaAReceber = neg.getData();
		} catch (Exception e) {
			// Se der erro na obtençao da data do recebimento da conta, então
			// assumimos a data de vcto da mesma.
		}
		obj.getCalcularValorFinal(dataRecebimentoContaAReceber, configuracaoUsar, false, dataRecebimentoContaAReceber, usuarioVO);
		obj.setSituacao(situacaoTemp);

		// Como o método esperíta altera o atrivuto valorRecebido da conta a
		// receber,
		// temos que retornar com valor recebido anteriormente gravado, pois não
		// podemos
		// alterar este valor nunca. E uma possível diferença é gerenciada por
		// meio de acrescimo//
		// desconto no recebimento da conta a receber. Caso contrário a
		// validação não irá funcionar
		Double novoValorRecebidoCalculado = obj.getValorRecebido();
		obj.setValorRecebido(valorRecebidoTemp);

		if (obj.getValorRecebido().compareTo(novoValorRecebidoCalculado) > 0) {
			// se o valorRecebido na realidade é maior que o
			// novoValorRecebidoCalculado
			// então esta diferença será registrada em acrescimo da conta a
			// receber
			Double diferenca = Uteis.arrendondarForcando2CadasDecimais(obj.getValorRecebido() - novoValorRecebidoCalculado);
			obj.setAcrescimo(Uteis.arrendondarForcando2CadasDecimais(obj.getAcrescimo() + diferenca));
		}
		if (obj.getValorRecebido().compareTo(novoValorRecebidoCalculado) < 0) {
			// se o valorRecebido na realidade é menor que o
			// novoValorRecebidoCalculado
			// então esta diferença será registrada em descontoDoRecebimento da
			// conta a receber
			Double diferenca = Uteis.arrendondarForcando2CadasDecimais(novoValorRecebidoCalculado - obj.getValorRecebido());
			obj.setValorCalculadoDescontoLancadoRecebimento(Uteis.arrendondarForcando2CadasDecimais(obj.getValorCalculadoDescontoLancadoRecebimento() + diferenca));
		}
		//// System.out.println("DEPOIS - " + obj.toString());
		try {
			obj.validarValoresAcrescimoDescontosERecebidoContaReceber();
		} catch (Exception e) {
			//// System.out.println("ERRO - " + obj.toString() + " - " + e.getMessage());
		}
		verificarCompetenciaBloqueadaParaRegistrosEntidade(obj, "ALTERAR", obj.getDataVencimento(), obj.getDataCompetencia(), obj.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuarioVO);
		getConexao().getJdbcTemplate().update("UPDATE contaReceber set " + "  valorDescontoAlunoJaCalculado = " + obj.getValorDescontoAlunoJaCalculado() + ", valorCalculadoDescontoLancadoRecebimento = " + obj.getValorCalculadoDescontoLancadoRecebimento() + ", descontoconvenio = " + obj.getValorDescontoConvenio() + ", descontoInstituicao = " + obj.getValorDescontoInstituicao() + ", valorDescontoProgressivo = " + obj.getValorDescontoProgressivo() + ", juro = " + obj.getJuro() + ", multa = " + obj.getMulta() + ", acrescimo = " + obj.getAcrescimo() + "  where codigo = " + obj.getCodigo() + "" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
		getFacadeFactory().getPlanoDescontoContaReceberFacade().alterarItensPlanoDescontoContaReceber(obj.getCodigo(), obj.getPlanoDescontoContaReceberVOs(), usuarioVO);
	}

	private void montarDadosCompletoMontandoDescontosOriginais(ContaReceberVO obj, SqlRowSet dadosSQL, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		try {
			if (dadosSQL.next()) {
				montarDadosBasico(obj, dadosSQL);
				obj.setData(dadosSQL.getDate("data"));
				obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
				obj.getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
				obj.setCodOrigem(dadosSQL.getString("codorigem"));
				obj.setTipoOrigem(dadosSQL.getString("tipoorigem"));
				obj.setDescricaoPagamento(dadosSQL.getString("descricaopagamento"));
				obj.setValorRecebido(dadosSQL.getDouble("valorrecebido"));
				obj.setJuroPorcentagem(dadosSQL.getDouble("juroporcentagem"));
				obj.setJuro(dadosSQL.getDouble("juro"));
				obj.setMultaPorcentagem(dadosSQL.getDouble("multaporcentagem"));
				obj.setMulta(dadosSQL.getDouble("multa"));
				obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
				obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhadigitavelcodigobarras"));
				obj.setContaCorrente(dadosSQL.getInt("contacorrente"));
				obj.getCentroReceita().setCodigo(dadosSQL.getInt("centroreceita"));
				obj.getCentroReceita().setDescricao(dadosSQL.getString("CentroReceita.descricao"));
				obj.setTipoBoleto(dadosSQL.getString("tipoboleto"));
				obj.getConvenio().setCodigo(dadosSQL.getInt("convenio"));
				obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaperiodo"));
				obj.setDataArquivoRemessa(dadosSQL.getDate("dataArquivoRemessa"));
				obj.setContaReceberAgrupada(dadosSQL.getInt("contaReceberAgrupada"));
				obj.getRenegociacaoContaReceberOrigem().setCodigo(dadosSQL.getInt("codigoRenegociacao"));

				obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor.codigo"));
				obj.getFornecedor().setNome(dadosSQL.getString("fornecedor.nome"));
				obj.getFornecedor().setRG(dadosSQL.getString("fornecedor.rg"));
				obj.getFornecedor().setCPF(dadosSQL.getString("fornecedor.cpf"));
				obj.getFornecedor().setCNPJ(dadosSQL.getString("fornecedor.cnpj"));
				obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("fornecedor.tipoEmpresa"));

				obj.setDuplicidadeTratada(dadosSQL.getBoolean("duplicidadeTratada"));
				obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
				obj.getTurma().setIdentificadorTurma(dadosSQL.getString("identificadorTurma"));

				// obj.setDescontoProgressivoUtilizado(dadosSQL.getString("descontoprogressivoutilizado"));

				obj.setOrigemNegociacaoReceber(dadosSQL.getInt("origemnegociacaoreceber"));
				obj.setCodigoBarra(dadosSQL.getString("codigobarra"));
				obj.setNossoNumero(dadosSQL.getString("nossonumero"));
				obj.setTituloImportadoSistemaLegado(dadosSQL.getBoolean("tituloImportadoSistemaLegado"));
				obj.setRecebimentoBancario((Boolean) dadosSQL.getObject("recebimentoBancario"));
				// Dados do Desconto Progressivo
				obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoprogressivo"));
				obj.setDescontoProgressivoUtilizado(FaixaDescontoProgressivo.getEnum(dadosSQL.getString("descontoprogressivoutilizado")));
				obj.getDescontoProgressivo().setNome(dadosSQL.getString("descontoprogressivo.nome"));
				obj.getDescontoProgressivo().setDiaLimite1(dadosSQL.getInt("descontoprogressivo.dialimite1"));
				obj.getDescontoProgressivo().setDiaLimite2(dadosSQL.getInt("descontoprogressivo.dialimite2"));
				obj.getDescontoProgressivo().setDiaLimite3(dadosSQL.getInt("descontoprogressivo.dialimite3"));
				obj.getDescontoProgressivo().setDiaLimite4(dadosSQL.getInt("descontoprogressivo.dialimite4"));
				obj.getDescontoProgressivo().setPercDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.percdescontolimite1"));
				obj.getDescontoProgressivo().setPercDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.percdescontolimite2"));
				obj.getDescontoProgressivo().setPercDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.percdescontolimite3"));
				obj.getDescontoProgressivo().setPercDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.percdescontolimite4"));			
				obj.getDescontoProgressivo().setValorDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.valordescontolimite1"));
				obj.getDescontoProgressivo().setValorDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.valordescontolimite2"));
				obj.getDescontoProgressivo().setValorDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.valordescontolimite3"));
				obj.getDescontoProgressivo().setValorDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.valordescontolimite4"));
				obj.getDescontoProgressivo().setUtilizarDiaFixo(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaFixo"));
				obj.getDescontoProgressivo().setUtilizarDiaUtil(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaUtil"));
				obj.setContaEditadaManualmente(dadosSQL.getBoolean("contaEditadaManualmente"));
				obj.setUtilizarDescontoProgressivoManual(dadosSQL.getBoolean("utilizarDescontoProgressivoManual"));
				if (obj.getUtilizarDescontoProgressivoManual()) {
					obj.setDiaLimite1(dadosSQL.getInt("diaLimite1"));
					obj.setDiaLimite2(dadosSQL.getInt("diaLimite2"));
					obj.setDiaLimite3(dadosSQL.getInt("diaLimite3"));
					obj.setDiaLimite4(dadosSQL.getInt("diaLimite4"));
				}
				if (obj.getUtilizarDescontoProgressivoManual()) {
					obj.getDescontoProgressivo().setDescontoProgressivoEditadoManualmenteContaReceber(Boolean.TRUE);
					obj.getDescontoProgressivo().setDiaLimite1(obj.getDiaLimite1());
					obj.getDescontoProgressivo().setDiaLimite2(obj.getDiaLimite2());
					obj.getDescontoProgressivo().setDiaLimite3(obj.getDiaLimite3());
					obj.getDescontoProgressivo().setDiaLimite4(obj.getDiaLimite4());
				}
				// TODO Alberto 08/12/10 acrescentado valor fixo desconto
				// progressivo
				// Desconto Lançado Recebimento
				obj.setValorDescontoLancadoRecebimento(dadosSQL.getDouble("valorDescontoLancadoRecebimento"));
				obj.setValorCalculadoDescontoLancadoRecebimento(dadosSQL.getDouble("valorCalculadoDescontoLancadoRecebimento"));
				obj.setTipoDescontoLancadoRecebimento(dadosSQL.getString("tipoDescontoLancadoRecebimento"));
				// montar dados plano desconto
				obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));

				obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
				obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
				obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
				obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
				obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
				obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
				obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
				obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
				obj.setTipoDesconto(dadosSQL.getString("tipodesconto"));
				obj.setValorDescontoRecebido(dadosSQL.getDouble("valordescontorecebido"));
				obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));

				obj.setValorDescontoInstituicao(dadosSQL.getDouble("descontoInstituicao"));
				obj.setValorDescontoConvenio(dadosSQL.getDouble("descontoConvenio"));
				obj.setValorDescontoProgressivo(dadosSQL.getDouble("valorDescontoProgressivo"));

				obj.setValorCusteadoContaReceber(dadosSQL.getDouble("valorCusteadoContaReceber"));
				obj.setValorBaseContaReceber(dadosSQL.getDouble("valorBaseContaReceber"));
				obj.setDataProcessamentoValorReceber(dadosSQL.getDate("dataProcessamentoValorReceber"));
				obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));

				obj.setJustificativaDesconto(dadosSQL.getString("justificativaDesconto"));
				obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));

			}
		} catch (Exception e) {
			throw e;
		}
	}

	@Override
	public ContaReceberVO consultarDadosGerarNotaFiscalSaida(Integer codigoPrm, boolean controlarAcesso, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Integer unidadeEnsino, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("SELECT contareceber.codigo as contareceber, contareceber.updated, matriculaAluno, tipoPessoa, tipoOrigem, parcela, ");
		sqlStr.append("pessoa, responsavelfinanceiro, candidato, funcionario, fornecedor, parceiro ");
		sqlStr.append("FROM ContaReceber ");
		sqlStr.append("WHERE contareceber.codigo = ?");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { codigoPrm });
		if (rs.next()) {
			return montarDadosGerarNotaFiscalSaida(rs, configuracaoFinanceiroVO, unidadeEnsino, usuario);
		}
		return new ContaReceberVO();
	}

	public ContaReceberVO montarDadosGerarNotaFiscalSaida(SqlRowSet rs, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Integer unidadeEnsino, UsuarioVO usuarioVO) throws Exception {
		ContaReceberVO obj = new ContaReceberVO();
		obj.setCodigo(rs.getInt("contareceber"));
		obj.setUpdated(rs.getDate("updated"));
		obj.setTipoPessoa(rs.getString("tipoPessoa"));
		obj.setTipoOrigem(rs.getString("tipoOrigem"));
		obj.setParcela(rs.getString("parcela"));
		obj.getMatriculaAluno().setMatricula(rs.getString("matriculaAluno"));
		obj.getPessoa().setCodigo(rs.getInt("pessoa"));
		obj.getResponsavelFinanceiro().setCodigo(rs.getInt("responsavelFinanceiro"));
		obj.getCandidato().setCodigo(rs.getInt("candidato"));
		obj.getFuncionario().setCodigo(rs.getInt("funcionario"));
		obj.getFornecedor().setCodigo(rs.getInt("fornecedor"));
		obj.getParceiroVO().setCodigo(rs.getInt("parceiro"));
		return obj;
	}

	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	@Override
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAlunosInadimentesQuartaMsgPrimeiraConsulta(Integer codigoUnidadeEnsino) throws Exception {
		Map<Integer, GrupoDestinatariosVO> grupoDestinatario = new HashMap<Integer, GrupoDestinatariosVO>(0);
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<ContaReceberCobrancaRelVO>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		ContaReceberVO contaReceberVO = null;
		String matriculaAtual = "";
		StringBuilder sb = new StringBuilder();
		sb.append(" select distinct  matricula.matricula, pessoa.nome as nomeAluno");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" left join pessoa as responsavelcobranca on unidadeensino.responsavelcobrancaunidade = responsavelcobranca.codigo ");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where matricula.naoEnviarMensagemCobranca =  false  and configuracaoFinanceiro.quantidadeDiasEnviarQuartaMensagemCobrancaInadimplente > 0 and configuracaoFinanceiro.tipoEnvioInadimplencia = 'periodicidade'   ");
		sb.append(" and contareceber.datavencimento < (current_date - configuracaoFinanceiro.quantidadeDiasEnviarQuartaMensagemCobrancaInadimplente)   ");
		sb.append(" and (current_date > matricula.dataTerceiraNotInadimplencia)  ");
		sb.append(" and matricula.dataPrimeiraNotInadimplencia is not null and matricula.dataSegundaNotInadimplencia is not null and matricula.dataTerceiraNotInadimplencia is not null  and matricula.dataQuartaNotInadimplencia is null ");
//		sb.append(" AND  contareceber.tipoorigem not in ('REQ','BCC','IPS') ");
		sb.append(" and (");
		sb.append("   (configuracaoFinanceiro.tipoOrigemMatriculaRotinaInadimplencia         and contareceber.tipoorigem = 'MAT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemBibliotecaRotinaInadimplencia        and contareceber.tipoorigem = 'BIB') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMensalidadeRotinaInadimplencia       and contareceber.tipoorigem = 'MEN') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemDevolucaoChequeRotinaInadimplencia   and contareceber.tipoorigem = 'DCH') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemNegociacaoRotinaInadimplencia        and contareceber.tipoorigem = 'NCR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemContratoReceitaRotinaInadimplencia   and contareceber.tipoorigem = 'CTR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemOutrosRotinaInadimplencia            and contareceber.tipoorigem = 'OUT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMaterialDidaticoRotinaInadimplencia  and contareceber.tipoorigem = 'MDI') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemInclusaoReposicaoRotinaInadimplencia and contareceber.tipoorigem = 'IRE') ");
		sb.append(") ");
		sb.append(" and contareceber.situacao = 'AR' and contareceber.valor > 0 and contareceber.tipopessoa in('AL', 'RF') and contareceber.convenio is null ");
		sb.append(" and unidadeensino.codigo = ").append(codigoUnidadeEnsino);
		sb.append(" order by matricula.matricula");
		
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (rs.next()) {
			contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
			contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
			contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
			contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
		}
		return contaReceberCobrancaRelVOs;
	}

	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	@Override
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAlunosInadimentesQuartaMensagem(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		Map<Integer, GrupoDestinatariosVO> grupoDestinatario = new HashMap<Integer, GrupoDestinatariosVO>(0);
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<ContaReceberCobrancaRelVO>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		ContaReceberVO contaReceberVO = null;
		String matriculaAtual = "";
		StringBuilder sb = new StringBuilder();
		sb.append(" select contareceber.codigo, contareceber.updated, contaReceber.valor, contaReceber.parcela, contareceber.dataVencimento, (current_date - contareceber.dataVencimento::DATE) as diasAtraso,");
		sb.append(" matricula.matricula, unidadeensino.nome as unidadeEnsino, unidadeensino.codigo as codigoUnidadeEnsino,  case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.codigo else pessoa.codigo end as codigoAluno,");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.nome else pessoa.nome end as nomeAluno, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.email else pessoa.email end as email,");
		sb.append(" configuracaoFinanceiro.grupoDestinatarioMensagemCobrancaInadimplente as grupoDestinatarioMensagemCobrancaInadimplente, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then 'RF' else 'AL' end as tipoPessoa, ");
		sb.append(" responsavelcobranca.email as emailresponsavelcobranca ");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" left join pessoa as responsavelcobranca on unidadeensino.responsavelcobrancaunidade = responsavelcobranca.codigo ");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where matricula.naoEnviarMensagemCobranca =  false  and configuracaoFinanceiro.quantidadeDiasEnviarQuartaMensagemCobrancaInadimplente > 0 and configuracaoFinanceiro.tipoEnvioInadimplencia = 'periodicidade'   ");
		sb.append(" and (");
		sb.append("   (configuracaoFinanceiro.tipoOrigemMatriculaRotinaInadimplencia         and contareceber.tipoorigem = 'MAT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemBibliotecaRotinaInadimplencia        and contareceber.tipoorigem = 'BIB') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMensalidadeRotinaInadimplencia       and contareceber.tipoorigem = 'MEN') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemDevolucaoChequeRotinaInadimplencia   and contareceber.tipoorigem = 'DCH') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemNegociacaoRotinaInadimplencia        and contareceber.tipoorigem = 'NCR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemContratoReceitaRotinaInadimplencia   and contareceber.tipoorigem = 'CTR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemOutrosRotinaInadimplencia            and contareceber.tipoorigem = 'OUT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMaterialDidaticoRotinaInadimplencia  and contareceber.tipoorigem = 'MDI') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemInclusaoReposicaoRotinaInadimplencia and contareceber.tipoorigem = 'IRE') ");
		sb.append(") ");
		sb.append(" and contareceber.situacao = 'AR' and contareceber.valor > 0 and contareceber.tipopessoa in('AL', 'RF') and contareceber.convenio is null ");
		sb.append(" AND contareceber.datavencimento < current_date ");
		sb.append(" AND matricula.matricula = '").append(matricula).append("'");
		sb.append(" order by matricula.matricula, contareceber.datavencimento ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (rs.next()) {
			if (matriculaAtual.equals("") || !matriculaAtual.equals(rs.getString("matricula"))) {
				matriculaAtual = rs.getString("matricula");
				contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
				contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
				contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setCodigo(rs.getInt("codigoAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setEmail(rs.getString("email"));
				contaReceberCobrancaRelVO.setUnidadeEnsino(rs.getString("unidadeEnsino"));
				contaReceberCobrancaRelVO.setEmailResponsavelCobranca(rs.getString("emailresponsavelcobranca"));
				contaReceberCobrancaRelVO.setCodigoUnidadeEnsino(rs.getInt("codigoUnidadeEnsino"));
				contaReceberCobrancaRelVO.setTipoDestinatario(rs.getString("tipoPessoa"));
				if (rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente") != 0) {
					if (!grupoDestinatario.containsKey(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"))) {
						grupoDestinatario.put(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"), getFacadeFactory().getGrupoDestinatariosFacade().consultarPorChavePrimaria(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"), false, Uteis.NIVELMONTARDADOS_TODOS, null));
					}
					contaReceberCobrancaRelVO.setGrupoDestinatariosVO(grupoDestinatario.get(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente")));
				}
				contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
			}
			contaReceberVO = consultarPorChavePrimaria(rs.getInt("codigo"), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiroVO, new UsuarioVO());
			/*contaReceberVO = new ContaReceberVO();
			contaReceberVO.setCodigo(rs.getInt("codigo"));
			contaReceberVO.setUpdated(rs.getDate("updated"));
			contaReceberVO.setValor(rs.getDouble("valor"));
			contaReceberVO.setParcela(rs.getString("parcela"));
			contaReceberVO.setDataVencimento(rs.getDate("dataVencimento"));*/
			contaReceberCobrancaRelVO.setValorTotalParcela(contaReceberCobrancaRelVO.getValorTotalParcela() + (contaReceberVO.getValorBaseContaReceber() - contaReceberVO.getListaDescontosAplicavesContaReceber().get(0).getValorDescontoSemValidade()));
			contaReceberCobrancaRelVO.getContaReceberVOs().add(contaReceberVO);
		}
		return contaReceberCobrancaRelVOs;
	}

	@Override
	public ContaReceberVO criarContaReceberSemInclusao(MatriculaVO matricula, ParceiroVO parceiro, PessoaVO pessoaVO, UnidadeEnsinoVO unidadeEnsinoVO, UnidadeEnsinoVO unidadeEnsinoVOAluno, ContaCorrenteVO contaCorrenteVO, int codigoOrigem, String tipoOrigem, Date dataVencimento, Date dataCompetencia, double valor, int centroReceita, int numParcela, int totalParcelas, String tipoBoleto, String partePrefixoParcela, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, FornecedorVO fornecedorVO) throws Exception {
		ContaReceberVO contaReceber = new ContaReceberVO();
		if (fornecedorVO != null && fornecedorVO.getCodigo() != 0) {
			contaReceber.setFornecedor(fornecedorVO);
			contaReceber.setTipoPessoa("FO");
		} else if (parceiro != null && parceiro.getCodigo() != 0) {
			contaReceber.setParceiroVO(parceiro);
			contaReceber.setTipoPessoa("PA");
		} else {
			contaReceber.setPessoa(pessoaVO);
			TipoPessoa tipoPessoa = TipoPessoa.getEnum(pessoaVO.getTipoPessoa());
			FuncionarioVO funcionario;
			if (tipoPessoa == null) {
				throw new ConsistirException("Usuário, a pessoa em questão não está com (TIPO PESSOA) em memória.");
			}
			switch (tipoPessoa) {
			case ALUNO:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				if (matricula == null || matricula.getMatricula().equals("")) {
					contaReceber.setMatriculaAluno(getFacadeFactory().getMatriculaFacade().getUtimaMatricula(getFacadeFactory().getMatriculaFacade().consultarMatriculaPorCodigoPessoa(pessoaVO.getCodigo(), unidadeEnsinoVOAluno.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuario)));
				} else if (!matricula.getMatricula().equalsIgnoreCase("")) {
					getFacadeFactory().getMatriculaFacade().carregarDados(matricula, NivelMontarDados.BASICO, usuario);
					contaReceber.setMatriculaAluno(matricula);
				}
				contaReceber.setTipoPessoa(TipoPessoa.ALUNO.getValor());

				break;
			case RESPONSAVEL_LEGAL:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				if (matricula == null || matricula.getMatricula().equals("")) {
					contaReceber.setMatriculaAluno(getFacadeFactory().getMatriculaFacade().getUtimaMatricula(getFacadeFactory().getMatriculaFacade().consultarMatriculaPorCodigoPessoa(pessoaVO.getCodigo(), unidadeEnsinoVOAluno.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiro, usuario)));
				} else if (!matricula.getMatricula().equalsIgnoreCase("")) {
					getFacadeFactory().getMatriculaFacade().carregarDados(matricula, NivelMontarDados.BASICO, usuario);
					contaReceber.setMatriculaAluno(matricula);
				}
				contaReceber.setTipoPessoa(TipoPessoa.RESPONSAVEL_LEGAL.getValor());
				break;
			case CANDIDATO:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				contaReceber.setCandidato(pessoaVO);
				contaReceber.setTipoPessoa(TipoPessoa.CANDIDATO.getValor());
				break;
			case FUNCIONARIO:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				funcionario = getFacadeFactory().getFuncionarioFacade().consultarPorCodigoPessoa(pessoaVO.getCodigo(), unidadeEnsinoVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				contaReceber.setFuncionario(funcionario);
				contaReceber.setTipoPessoa(TipoPessoa.FUNCIONARIO.getValor());
				break;
			case MEMBRO_COMUNIDADE:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				contaReceber.setTipoPessoa(TipoPessoa.MEMBRO_COMUNIDADE.getValor());
				break;
			case PROFESSOR:
				getFacadeFactory().getPessoaFacade().carregarDados(pessoaVO, usuario);
				funcionario = getFacadeFactory().getFuncionarioFacade().consultarPorCodigoPessoa(pessoaVO.getCodigo(), unidadeEnsinoVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				contaReceber.setFuncionario(funcionario);
				contaReceber.setTipoPessoa(TipoPessoa.PROFESSOR.getValor());
				break;

			}
		}
		if (contaReceber.getMatriculaAluno().getUnidadeEnsino().getCodigo() != null && !contaReceber.getMatriculaAluno().getUnidadeEnsino().getCodigo().equals(0)) {
			unidadeEnsinoVO = contaReceber.getMatriculaAluno().getUnidadeEnsino();
		}
		contaReceber.setJuroPorcentagem(configuracaoFinanceiro.getPercentualJuroPadrao());
		contaReceber.setMultaPorcentagem(configuracaoFinanceiro.getPercentualMultaPadrao());
		contaReceber.setUnidadeEnsino(unidadeEnsinoVO);
		contaReceber.setContaCorrente(contaCorrenteVO.getCodigo());
		contaReceber.setCodOrigem(String.valueOf(codigoOrigem));
		contaReceber.setTipoOrigem(tipoOrigem);
		if (!tipoOrigem.equals("MAT") && !tipoOrigem.equals("MEN")) {
			contaReceber.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceber.getValor());
			contaReceber.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceber.getValor());
			contaReceber.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceber.getValor());
			contaReceber.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceber.getValor());
		}
		if (dataVencimento == null) {
			throw new Exception("Para geração da(s) parcela(s) é necessário informar a nova data de vencimento.");
		} else {
			contaReceber.setDataVencimento(dataVencimento);// devolucaoChequeVO.getCheque().getDataPrevisao()
			contaReceber.setDataCompetencia(dataCompetencia);// devolucaoChequeVO.getCheque().getDataPrevisao()
		}
		if (partePrefixoParcela == null || partePrefixoParcela.equals("")) {
			ContaReceberVO c = this.consultarNomeUltimaParcela(contaReceber.getPessoa().getCodigo());
			contaReceber.setParcela(String.valueOf(numParcela) + "/" + String.valueOf(totalParcelas));
			if (c.getParcela().equals(contaReceber.getParcela())) {
				contaReceber.setParcela(String.valueOf(numParcela + 1) + "/" + String.valueOf(totalParcelas));
			}
		} else {
			ContaReceberVO c = this.consultarNomeUltimaParcela(contaReceber.getPessoa().getCodigo());
			contaReceber.setParcela(String.valueOf(numParcela) + "/" + String.valueOf(totalParcelas) + partePrefixoParcela);
			if (c.getParcela().equals(contaReceber.getParcela())) {
				contaReceber.setParcela(contaReceber.getParcela() + contaReceber.getPessoa().getCodigo());
			}
			if (tipoOrigem.equals("MAT") || tipoOrigem.equals("MEN")) {
				contaReceber.setMatriculaPeriodo(codigoOrigem);
			}
		}
		contaReceber.setValor(valor);
		contaReceber.setValorRecebido(0.0);
		contaReceber.getCentroReceita().setCodigo(centroReceita);
		contaReceber.setTipoBoleto(tipoBoleto);
		contaReceber.setNrDocumento(gerarNumeroDocumentoPorPessoaConvenio(contaReceber.getPessoa().getCodigo(), contaReceber.getParceiroVO().getCodigo(), contaReceber.getTipoPessoa(), usuario));
		if (valor <= 0) {
			contaReceber.setSituacao(SituacaoContaReceber.RECEBIDO.getValor());
		}
		if (valor <= 0) {
			ContaReceberNegociacaoRecebimentoVO contaReceberNegociacaoRecebimentoVO = new ContaReceberNegociacaoRecebimentoVO();
			contaReceberNegociacaoRecebimentoVO.setContaReceber(contaReceber);
			NegociacaoRecebimentoVO negociacaoRecebimentoVO = new NegociacaoRecebimentoVO();
			negociacaoRecebimentoVO.setResponsavel(usuario);
			negociacaoRecebimentoVO.setUnidadeEnsino(contaReceber.getUnidadeEnsino());
			negociacaoRecebimentoVO.setContaCorrenteCaixa(contaCorrenteVO);
			negociacaoRecebimentoVO.setPessoa(contaReceber.getPessoa());
			negociacaoRecebimentoVO.getContaReceberNegociacaoRecebimentoVOs().add(contaReceberNegociacaoRecebimentoVO);
			getFacadeFactory().getNegociacaoRecebimentoFacade().incluir(negociacaoRecebimentoVO, configuracaoFinanceiro, false, usuario);
		}

		return contaReceber;
	}

	@Override
	public List<ContaReceberVO> consultarContaReceberInscricaoCandidatoInadimplente(Integer qtdeDiasAposDataProvaRemoverContaReceberCandidato) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select contareceber.codigo as contaReceber, contareceber.updated, contaReceber.candidato as candidato , contaReceber.codOrigem as codOrigem from Inscricao ");
		sqlStr.append("inner join contareceber on contareceber.codigo = inscricao.contareceber ");
		sqlStr.append("inner join itemprocseletivodataprova on itemprocseletivodataprova.codigo = inscricao.itemprocessoseletivodataprova ");
		sqlStr.append("where (itemprocseletivodataprova.dataprova::Date + ").append(qtdeDiasAposDataProvaRemoverContaReceberCandidato).append(") <= current_date ");
		sqlStr.append("and contareceber.situacao = 'AR' ");
		sqlStr.append("and inscricao.situacaoinscricao = 'ATIVO'");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<ContaReceberVO> contaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (rs.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(rs.getInt("contaReceber"));
			obj.setUpdated(rs.getDate("updated"));
			obj.getCandidato().setCodigo(rs.getInt("candidato"));
			obj.setCodOrigem(rs.getString("codOrigem"));
			contaReceberVOs.add(obj);
		}
		return contaReceberVOs;
	}

	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	@Override
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAlunosInadimentes(Integer codigoUnidade) throws Exception {
		Map<Integer, GrupoDestinatariosVO> grupoDestinatario = new HashMap<Integer, GrupoDestinatariosVO>(0);
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<ContaReceberCobrancaRelVO>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		ContaReceberVO contaReceberVO = null;
		String matriculaAtual = "";
		StringBuilder sb = new StringBuilder();
		sb.append(" select distinct matricula.matricula, pessoa.nome as nomealuno");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where matricula.naoEnviarMensagemCobranca =  false and configuracaoFinanceiro.quantidadeDiasEnviarMensagemCobrancaInadimplente > 0 and configuracaoFinanceiro.tipoEnvioInadimplencia != 'periodicidade' ");
		sb.append(" and contareceber.datavencimento < (current_date - configuracaoFinanceiro.quantidadeDiasEnviarMensagemCobrancaInadimplente)");
		sb.append(" and (matricula.dataNotifcAlunoInadimplente is null or current_date > (matricula.dataNotifcAlunoInadimplente + configuracaoFinanceiro.quantidadeDiasEnviarMensagemCobrancaInadimplente))");
		sb.append(" and (");
		sb.append("   (configuracaoFinanceiro.tipoOrigemMatriculaRotinaInadimplencia         and contareceber.tipoorigem = 'MAT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemBibliotecaRotinaInadimplencia        and contareceber.tipoorigem = 'BIB') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMensalidadeRotinaInadimplencia       and contareceber.tipoorigem = 'MEN') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemDevolucaoChequeRotinaInadimplencia   and contareceber.tipoorigem = 'DCH') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemNegociacaoRotinaInadimplencia        and contareceber.tipoorigem = 'NCR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemContratoReceitaRotinaInadimplencia   and contareceber.tipoorigem = 'CTR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemOutrosRotinaInadimplencia            and contareceber.tipoorigem = 'OUT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMaterialDidaticoRotinaInadimplencia  and contareceber.tipoorigem = 'MDI') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemInclusaoReposicaoRotinaInadimplencia and contareceber.tipoorigem = 'IRE') ");
		sb.append(") ");		
		sb.append(" and contareceber.situacao = 'AR' and contareceber.valor > 0 and contareceber.tipopessoa in('AL', 'RF') and contareceber.convenio is null  ");
		sb.append(" and unidadeensino.codigo = ").append(codigoUnidade);	
		sb.append(" order by matricula.matricula");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (rs.next()) {
			contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
			contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
			contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
			contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
		}
		return contaReceberCobrancaRelVOs;
	}

	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	@Override
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAlunosInadimentesTerceiraMsg(Integer codigoUnidade) throws Exception {
		Map<Integer, GrupoDestinatariosVO> grupoDestinatario = new HashMap<Integer, GrupoDestinatariosVO>(0);
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<ContaReceberCobrancaRelVO>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		ContaReceberVO contaReceberVO = null;
		String matriculaAtual = "";
		StringBuilder sb = new StringBuilder();
		sb.append(" select distinct matricula.matricula, pessoa.nome as nomealuno");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" left join pessoa as responsavelcobranca on unidadeensino.responsavelcobrancaunidade = responsavelcobranca.codigo ");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where matricula.naoEnviarMensagemCobranca =  false  and configuracaoFinanceiro.quantidadeDiasEnviarTerceiraMensagemCobrancaInadimplente > 0 and configuracaoFinanceiro.tipoEnvioInadimplencia = 'periodicidade' ");
		sb.append(" and contareceber.datavencimento < (current_date - configuracaoFinanceiro.quantidadeDiasEnviarTerceiraMensagemCobrancaInadimplente) ");
		sb.append(" and (current_date > matricula.dataSegundaNotInadimplencia) ");
		sb.append(" and matricula.dataPrimeiraNotInadimplencia is not null and matricula.dataSegundaNotInadimplencia is not null and matricula.dataTerceiraNotInadimplencia is null ");
//		sb.append(" AND contareceber.tipoorigem not in ('REQ','BCC', 'IPS')  ");
		sb.append(" and (");
		sb.append("   (configuracaoFinanceiro.tipoOrigemMatriculaRotinaInadimplencia         and contareceber.tipoorigem = 'MAT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemBibliotecaRotinaInadimplencia        and contareceber.tipoorigem = 'BIB') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMensalidadeRotinaInadimplencia       and contareceber.tipoorigem = 'MEN') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemDevolucaoChequeRotinaInadimplencia   and contareceber.tipoorigem = 'DCH') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemNegociacaoRotinaInadimplencia        and contareceber.tipoorigem = 'NCR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemContratoReceitaRotinaInadimplencia   and contareceber.tipoorigem = 'CTR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemOutrosRotinaInadimplencia            and contareceber.tipoorigem = 'OUT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMaterialDidaticoRotinaInadimplencia  and contareceber.tipoorigem = 'MDI') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemInclusaoReposicaoRotinaInadimplencia and contareceber.tipoorigem = 'IRE') ");
		sb.append(") ");
		sb.append(" and contareceber.situacao = 'AR' and contareceber.valor > 0 and contareceber.tipopessoa in('AL', 'RF') and contareceber.convenio is null ");
		sb.append(" and unidadeensino.codigo = ").append(codigoUnidade);		
		sb.append(" order by matricula.matricula");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (rs.next()) {
			contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
			contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
			contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
			contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
		}
		return contaReceberCobrancaRelVOs;
	}

	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	@Override
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAlunosInadimentesSegundaMsg(Integer codigoUnidadeEnsino) throws Exception {
		Map<Integer, GrupoDestinatariosVO> grupoDestinatario = new HashMap<Integer, GrupoDestinatariosVO>(0);
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<ContaReceberCobrancaRelVO>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		ContaReceberVO contaReceberVO = null;
		String matriculaAtual = "";
		StringBuilder sb = new StringBuilder();
		sb.append(" select distinct matricula.matricula, pessoa.nome as nomealuno");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" left join pessoa as responsavelcobranca on unidadeensino.responsavelcobrancaunidade = responsavelcobranca.codigo ");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where matricula.naoEnviarMensagemCobranca =  false and configuracaoFinanceiro.quantidadeDiasEnviarSegundaMensagemCobrancaInadimplente > 0 and configuracaoFinanceiro.tipoEnvioInadimplencia = 'periodicidade' ");
		sb.append(" and contareceber.datavencimento < (current_date - configuracaoFinanceiro.quantidadeDiasEnviarSegundaMensagemCobrancaInadimplente) ");
		sb.append(" and (current_date > matricula.dataPrimeiraNotInadimplencia) ");
		sb.append(" and matricula.dataPrimeiraNotInadimplencia is not null and matricula.dataSegundaNotInadimplencia is null and matricula.dataTerceiraNotInadimplencia is null ");
//		sb.append(" AND  contareceber.tipoorigem not in ('REQ','BCC', 'IPS') ");
		sb.append(" and (");
		sb.append("   (configuracaoFinanceiro.tipoOrigemMatriculaRotinaInadimplencia         and contareceber.tipoorigem = 'MAT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemBibliotecaRotinaInadimplencia        and contareceber.tipoorigem = 'BIB') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMensalidadeRotinaInadimplencia       and contareceber.tipoorigem = 'MEN') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemDevolucaoChequeRotinaInadimplencia   and contareceber.tipoorigem = 'DCH') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemNegociacaoRotinaInadimplencia        and contareceber.tipoorigem = 'NCR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemContratoReceitaRotinaInadimplencia   and contareceber.tipoorigem = 'CTR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemOutrosRotinaInadimplencia            and contareceber.tipoorigem = 'OUT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMaterialDidaticoRotinaInadimplencia  and contareceber.tipoorigem = 'MDI') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemInclusaoReposicaoRotinaInadimplencia and contareceber.tipoorigem = 'IRE') ");
		sb.append(") ");
		sb.append(" and contareceber.situacao = 'AR' and contareceber.valor > 0 and contareceber.tipopessoa in('AL', 'RF') and contareceber.convenio is null ");
		sb.append(" and unidadeensino.codigo = ").append(codigoUnidadeEnsino);		
		sb.append(" order by matricula.matricula");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (rs.next()) {
			contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
			contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
			contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
			contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
		}
		return contaReceberCobrancaRelVOs;

	}

	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	@Override
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAlunosInadimentesPrimeiraMsg(Integer codigoUnidade) throws Exception {
		Map<Integer, GrupoDestinatariosVO> grupoDestinatario = new HashMap<Integer, GrupoDestinatariosVO>(0);
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<ContaReceberCobrancaRelVO>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		ContaReceberVO contaReceberVO = null;
		String matriculaAtual = "";
		StringBuilder sb = new StringBuilder();
		sb.append(" select distinct matricula.matricula, pessoa.nome as nomealuno");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" left join pessoa as responsavelcobranca on unidadeensino.responsavelcobrancaunidade = responsavelcobranca.codigo ");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where matricula.naoEnviarMensagemCobranca =  false and configuracaoFinanceiro.quantidadeDiasEnviarPrimeiraMensagemCobrancaInadimplente > 0 and configuracaoFinanceiro.tipoEnvioInadimplencia = 'periodicidade' ");
		sb.append(" and contareceber.datavencimento < (current_date - configuracaoFinanceiro.quantidadeDiasEnviarPrimeiraMensagemCobrancaInadimplente) ");
		sb.append(" and matricula.dataPrimeiraNotInadimplencia is null and matricula.dataSegundaNotInadimplencia is null and matricula.dataTerceiraNotInadimplencia is null ");
//		sb.append(" AND contareceber.tipoorigem not in ('REQ','BCC', 'IPS') ");
		sb.append(" and (");
		sb.append("   (configuracaoFinanceiro.tipoOrigemMatriculaRotinaInadimplencia         and contareceber.tipoorigem = 'MAT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemBibliotecaRotinaInadimplencia        and contareceber.tipoorigem = 'BIB') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMensalidadeRotinaInadimplencia       and contareceber.tipoorigem = 'MEN') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemDevolucaoChequeRotinaInadimplencia   and contareceber.tipoorigem = 'DCH') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemNegociacaoRotinaInadimplencia        and contareceber.tipoorigem = 'NCR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemContratoReceitaRotinaInadimplencia   and contareceber.tipoorigem = 'CTR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemOutrosRotinaInadimplencia            and contareceber.tipoorigem = 'OUT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMaterialDidaticoRotinaInadimplencia  and contareceber.tipoorigem = 'MDI') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemInclusaoReposicaoRotinaInadimplencia and contareceber.tipoorigem = 'IRE') ");
		sb.append(") ");
		sb.append(" and contareceber.situacao = 'AR' and contareceber.valor > 0 and contareceber.tipopessoa in('AL', 'RF') and contareceber.convenio is null ");
		sb.append(" and unidadeensino.codigo = ").append(codigoUnidade);	
		sb.append(" order by matricula.matricula");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (rs.next()) {
			contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
			contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
			contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
			contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
		}
		return contaReceberCobrancaRelVOs;
	}

	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	@Override
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAlunosInadimentes(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		Map<Integer, GrupoDestinatariosVO> grupoDestinatario = new HashMap<Integer, GrupoDestinatariosVO>(0);
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<ContaReceberCobrancaRelVO>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		ContaReceberVO contaReceberVO = null;
		String matriculaAtual = "";
		StringBuilder sb = new StringBuilder();
		sb.append(" select contareceber.codigo, contareceber.updated, contaReceber.valor, contaReceber.parcela, contareceber.dataVencimento, (current_date - contareceber.dataVencimento::DATE) as diasAtraso,");
		sb.append(" matricula.matricula, unidadeensino.nome as unidadeEnsino, unidadeensino.codigo as codigoUnidadeEnsino,  case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.codigo else pessoa.codigo end as codigoAluno,");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.nome else pessoa.nome end as nomeAluno, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.email else pessoa.email end as email,");
		sb.append(" configuracaoFinanceiro.grupoDestinatarioMensagemCobrancaInadimplente as grupoDestinatarioMensagemCobrancaInadimplente, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then 'RF' else 'AL' end as tipoPessoa, ");
		sb.append(" responsavelcobranca.email as emailresponsavelcobranca ");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join pessoa as responsavelcobranca on unidadeensino.responsavelcobrancaunidade = responsavelcobranca.codigo ");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where matricula.naoEnviarMensagemCobranca =  false and configuracaoFinanceiro.quantidadeDiasEnviarMensagemCobrancaInadimplente > 0 and configuracaoFinanceiro.tipoEnvioInadimplencia != 'periodicidade' ");
		sb.append(" AND contareceber.datavencimento < current_date ");
		sb.append(" and contareceber.situacao = 'AR' ");
		sb.append(" and (");
		sb.append("   (configuracaoFinanceiro.tipoOrigemMatriculaRotinaInadimplencia         and contareceber.tipoorigem = 'MAT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemBibliotecaRotinaInadimplencia        and contareceber.tipoorigem = 'BIB') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMensalidadeRotinaInadimplencia       and contareceber.tipoorigem = 'MEN') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemDevolucaoChequeRotinaInadimplencia   and contareceber.tipoorigem = 'DCH') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemNegociacaoRotinaInadimplencia        and contareceber.tipoorigem = 'NCR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemContratoReceitaRotinaInadimplencia   and contareceber.tipoorigem = 'CTR') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemOutrosRotinaInadimplencia            and contareceber.tipoorigem = 'OUT') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemMaterialDidaticoRotinaInadimplencia  and contareceber.tipoorigem = 'MDI') ");
		sb.append(" or(configuracaoFinanceiro.tipoOrigemInclusaoReposicaoRotinaInadimplencia and contareceber.tipoorigem = 'IRE') ");
		sb.append(") ");
		sb.append(" AND matricula.matricula = '").append(matricula).append("'");
		sb.append(" order by matricula.matricula, contareceber.datavencimento ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (rs.next()) {
			if (matriculaAtual.equals("") || !matriculaAtual.equals(rs.getString("matricula"))) {
				matriculaAtual = rs.getString("matricula");
				contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
				contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
				contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
				contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setCodigo(rs.getInt("codigoAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setEmail(rs.getString("email"));
				contaReceberCobrancaRelVO.setUnidadeEnsino(rs.getString("unidadeEnsino"));
				contaReceberCobrancaRelVO.setEmailResponsavelCobranca(rs.getString("emailresponsavelcobranca"));
				contaReceberCobrancaRelVO.setCodigoUnidadeEnsino(rs.getInt("codigoUnidadeEnsino"));
				contaReceberCobrancaRelVO.setTipoDestinatario(rs.getString("tipoPessoa"));
				if (rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente") != 0) {
					if (!grupoDestinatario.containsKey(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"))) {
						grupoDestinatario.put(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"), getFacadeFactory().getGrupoDestinatariosFacade().consultarPorChavePrimaria(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente"), false, Uteis.NIVELMONTARDADOS_TODOS, null));
					}
					contaReceberCobrancaRelVO.setGrupoDestinatariosVO(grupoDestinatario.get(rs.getInt("grupoDestinatarioMensagemCobrancaInadimplente")));
				}
				contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
			}
			contaReceberVO = consultarPorChavePrimaria(rs.getInt("codigo"), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiroVO, new UsuarioVO());
			/*contaReceberVO = new ContaReceberVO();
			contaReceberVO.setCodigo(rs.getInt("codigo"));
			contaReceberVO.setUpdated(rs.getDate("updated"));
			contaReceberVO.setValor(rs.getDouble("valor"));
			contaReceberVO.setParcela(rs.getString("parcela"));
			contaReceberVO.setDataVencimento(rs.getDate("dataVencimento"));*/
			contaReceberCobrancaRelVO.setValorTotalParcela(contaReceberCobrancaRelVO.getValorTotalParcela() + (contaReceberVO.getValorBaseContaReceber()- contaReceberVO.getListaDescontosAplicavesContaReceber().get(0).getValorDescontoSemValidade()));
			contaReceberCobrancaRelVO.getContaReceberVOs().add(contaReceberVO);
		}
		return contaReceberCobrancaRelVOs;
	}

	@Override
	@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, propagation = Propagation.SUPPORTS)
	public List<ContaReceberCobrancaRelVO> consultarContaReceberAvisoDesconto(Integer codigoUnidade, ConfiguracaoFinanceiroVO configFinaneiro, UsuarioVO usuario) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append(" select contareceber.codigo, contareceber.updated, contaReceber.valor, contaReceber.parcela, contareceber.dataVencimento, ");
		sb.append(" matricula.matricula, ");
		sb.append(" unidadeensino.codigo as codigoUnidadeEnsino, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.codigo else pessoa.codigo end as codigoAluno,");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.nome else pessoa.nome end as nomeAluno, ");
		sb.append(" case when responsavelFinanceiro.codigo is not null then responsavelFinanceiro.email else pessoa.email end as email,");
		sb.append(" case when responsavelFinanceiro.codigo is not null then 'RF' else 'AL' end as tipoPessoa ");
		sb.append(" from contareceber");
		sb.append(" inner join matricula on matricula.matricula = contareceber.matriculaAluno");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sb.append(" inner join configuracaoFinanceiro on configuracaoFinanceiro.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select c.codigo from configuracoes c where c.padrao = true ) end)");
		sb.append(" inner join pessoa on matricula.aluno = pessoa.codigo");
		sb.append(" left join filiacao on filiacao.aluno = pessoa.codigo and filiacao.responsavelfinanceiro = true");
		sb.append(" left join pessoa as responsavelFinanceiro on responsavelFinanceiro.codigo = filiacao.pais");
		sb.append(" where quantidadeDiasEnviarAvisoDesconto  > 0 ");
		sb.append(" and contareceber.situacao = 'AR' AND contareceber.tipoorigem not in ('REQ','BCC', 'IPS') ");
		sb.append(" and contareceber.dataLimitePrimeiraFaixaDescontos is not null and contareceber.dataLimitePrimeiraFaixaDescontos <= contareceber.datavencimento ");
		sb.append(" and contareceber.valor > contareceber.valorrecebercalculado ");
		sb.append(" and contareceber.dataLimitePrimeiraFaixaDescontos = ((current_date + quantidadeDiasEnviarAvisoDesconto)::date) ");
		
		
		if (Uteis.isAtributoPreenchido(codigoUnidade)) {
			sb.append(" and unidadeensino.codigo =  ").append(codigoUnidade);
		}

		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<ContaReceberCobrancaRelVO> contaReceberCobrancaRelVOs = new ArrayList<>(0);
		ContaReceberCobrancaRelVO contaReceberCobrancaRelVO = null;
		while (rs.next()) {
			Optional<ContaReceberCobrancaRelVO> findFirst = contaReceberCobrancaRelVOs.stream().filter(p -> p.getMatricula().equals(rs.getString("matricula"))).findFirst();
			if (findFirst.isPresent() && Uteis.isAtributoPreenchido(findFirst.get().getMatricula())) {
				contaReceberCobrancaRelVO = findFirst.get();
			} else {
				contaReceberCobrancaRelVO = new ContaReceberCobrancaRelVO();
				contaReceberCobrancaRelVO.setMatricula(rs.getString("matricula"));
				contaReceberCobrancaRelVO.getPessoaVO().setNome(rs.getString("nomeAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setCodigo(rs.getInt("codigoAluno"));
				contaReceberCobrancaRelVO.getPessoaVO().setEmail(rs.getString("email"));
				contaReceberCobrancaRelVO.setTipoDestinatario(rs.getString("tipoPessoa"));
				contaReceberCobrancaRelVO.setUnidadeEnsino(rs.getString("codigoUnidadeEnsino"));
				contaReceberCobrancaRelVO.setCodigoUnidadeEnsino(rs.getInt("codigoUnidadeEnsino"));
				contaReceberCobrancaRelVOs.add(contaReceberCobrancaRelVO);
			}
			contaReceberCobrancaRelVO.getContaReceberVOs().add(consultarPorChavePrimaria(rs.getInt("codigo"), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configFinaneiro, usuario));
		}
		return contaReceberCobrancaRelVOs;
	}

	public Integer consultarListaNomeUltimaParcela(Integer pessoa) throws Exception {
		String sqlStr = "SELECT count(codigo) FROM ContaReceber WHERE pessoa = " + pessoa + " AND tipoOrigem = 'OUT'";
		return getConexao().getJdbcTemplate().queryForInt(sqlStr);
	}

	/**
	 * Método responsável por regerar boleto de inscrição do candidato validando se o boleto está vencido, caso esteja vencido verifica se a data da prova está após a data atual mais 1, que no caso seria um dia antes da prova devido ao processamento de arquivo de retorno. Caso passe pelas duas validações a data de vencimento será a data atual somando a quantidade de dias vencimento do boleto configurado no cadastro de processo seletivo. Feito isso a atualização do boleto é executada.
	 */
	@Override
	public void executarRegerarBoletoVencidoInscricaoCandidato(InscricaoVO inscricaoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		ContaReceberVO contaReceberVO = new ContaReceberVO();
		if (Uteis.isAtributoPreenchido(inscricaoVO.getContaReceber())) {
			contaReceberVO.setCodigo(inscricaoVO.getContaReceber());
			this.carregarDados(contaReceberVO, configuracaoFinanceiroVO, usuarioVO);
			// this.consultarPorChavePrimaria(inscricaoVO.getContaReceber(), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiroVO, usuarioVO);
			Date hoje = Uteis.getDateSemHora(new Date());

			if (contaReceberVO.getDataVencimento().before(hoje) && (inscricaoVO.getItemProcessoSeletivoDataProva().getDataLimiteAdiarVencimentoInscricao().after(hoje) || inscricaoVO.getItemProcessoSeletivoDataProva().getDataLimiteAdiarVencimentoInscricao().compareTo(hoje) >= 0)) {
				contaReceberVO.setDataVencimento(new Date());
				contaReceberVO.setData(new Date());
				this.gerarDadosBoleto(contaReceberVO, configuracaoFinanceiroVO, false,true ,usuarioVO);
			}
		}
		inscricaoVO.setContaReceberVO(contaReceberVO);
	}

	@Override
	public Boolean executarVerificarContaReceberGerada(String codOrigem, String tipoOrigem, String parcela, Integer pessoa, UsuarioVO usuarioVO) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuarioVO);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT codigo from ContaReceber ");
		sqlStr.append("where codOrigem = '").append(codOrigem).append("' ");
		sqlStr.append("AND tipoOrigem = '").append(tipoOrigem).append("' ");
		sqlStr.append("AND parcela = '").append(parcela).append("' ");
		sqlStr.append("AND pessoa = ").append(pessoa);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			Integer inte = tabelaResultado.getInt("codigo");
			return true;
		}
		return false;
	}

	public List<ContaReceberVO> consultarPorMatriculaContasReceberMensalidadeEMatriculaEmAberto(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" select contareceber.codigo, contareceber.updated, contareceber.nossonumero, contareceber.tipoOrigem, contareceber.situacao, contareceber.dataVencimento, contareceber.valor, contareceber.parcela from contareceber ");
		sqlStr.append(" inner join matricula on matricula.matricula = contareceber.matriculaaluno ");
		sqlStr.append(" where matricula.situacao = 'AT' and matricula.matricula = '");
		sqlStr.append(matricula.toString());
		sqlStr.append("' and tipoOrigem in ('MAT', 'MEN') and contareceber.situacao = 'AR' and datavencimento < current_date ");
		sqlStr.append(" order by contareceber.dataVencimento ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsultaLiberacaoFinanceiro(tabelaResultado, configuracaoFinanceiroVO, usuario));
	}

	/**
	 * O controle de quem cancelou um determinado título e quando será realizado por meio do log do sistema. Pois o mesmo título, pode ser cancelado vários vezes.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void cancelarContaReceber(ContaReceberVO contaReceber, UsuarioVO usuario) throws Exception {
		validarContaReceberEmMemoriaAntesAlteracao(contaReceber);
		validarDadosMotivoCancelamento(contaReceber, usuario);
		validarRegistroCobrancaAntesCancelamento(contaReceber);
		verificarCompetenciaBloqueadaParaRegistrosEntidade(contaReceber, "CANCELAR", contaReceber.getDataVencimento(), contaReceber.getDataCompetencia(), contaReceber.getUnidadeEnsino().getCodigo(), TipoOrigemHistoricoBloqueioEnum.ARECEBER, usuario);
		alterarSituacao(contaReceber.getCodigo(), SituacaoContaReceber.CANCELADO_FINANCEIRO.getValor(), usuario);
		alterarDadosCancelamento(contaReceber.getCodigo(), contaReceber.getMotivoCancelamento(), contaReceber.getDataCancelamento(), contaReceber.getResponsavelCancelamentoVO().getCodigo(), usuario);
	}

	/**
	 * O controle de quem cancelou um determinado título e quando será realizado por meio do log do sistema. Pois o mesmo título, pode ser cancelado vários vezes.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void reativarContaReceberCancelada(ContaReceberVO contaReceber, UsuarioVO usuario) throws Exception {
		validarContaReceberEmMemoriaAntesAlteracao(contaReceber);
		alterarSituacao(contaReceber.getCodigo(), SituacaoContaReceber.A_RECEBER.getValor(), usuario);
		alterarDadosCancelamento(contaReceber.getCodigo(), null, null, null, usuario);
		contaReceber.setMotivoCancelamento("");
		contaReceber.setDataCancelamento(null);
		contaReceber.setResponsavelCancelamentoVO(null);
	}

	@Override
	public void realizarExecucaoJobCalculoValorTemporarioContaReceber(List<ContaReceberVO> contaReceberVOs, UsuarioVO usuarioVO) {
		if (contaReceberVOs != null && !contaReceberVOs.isEmpty()) {
			JobCalculoValorTemporarioContaReceber job = new JobCalculoValorTemporarioContaReceber();
			job.setContaReceberVOs(contaReceberVOs);
			Thread thread = new Thread(job, "JobCalculoValorTemporarioContaReceberUser_" + usuarioVO.getCodigo());
			thread.start();
		}
	}

	@Override
	public Boolean consultarExistenciaContasReceberVencidasAluno(Integer pessoa, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sql = new StringBuilder();
		sql.append("select count(codigo) as qtde from (");
		StringBuilder sql2 = getSQLPadraoConsultaBasica();
		sql2.append(" WHERE contareceber.tipoorigem not in ('REQ', 'IPS')  and (contareceber.pessoa = ").append(pessoa.toString()).append(") ");
		sql2.append(" AND (contareceber.situacao = 'AR') AND (contareceber.dataVencimento < '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("') ");
		sql.append(sql2.toString());
		sql.append(" union ");
		StringBuilder sql3 = getSQLPadraoConsultaBasica();
		sql3.append(" WHERE contareceber.tipoorigem not in ('REQ', 'IPS')  and (contareceber.matriculaaluno IN (select matricula from matricula where aluno =  ").append(pessoa.toString()).append(")) ");
		sql3.append(" AND convenio.convenioInadimplenteBloqueaMatricula = true AND (contareceber.situacao = 'AR') AND (contareceber.dataVencimento < '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("') limit 1 ");
		sql.append(sql3.toString());
		sql.append(") as t ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return resultado.next() && resultado.getInt("qtde") > 0;
	}

	public List<ContaReceberVO> consultarContaReceberAlterarResponsavelFinanceiro(String valorConsulta, Boolean consDataCompetencia, Date dataIni, Date dataFim, String ano, String semestre, String situacao, Integer unidadeEnsino, Integer unidadeEnsinoFinanceira, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, boolean controlarAcesso, Integer limite, Integer offset, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLConsultaAlterarResponsavelFinanceiro();
		sql.append(" WHERE UPPER(matricula.matricula) = ? ");
		if (Uteis.isAtributoPreenchido(unidadeEnsino)) {
			sql.append(" AND (unidadeensino.codigo = ").append(unidadeEnsino).append(") ");
		}
		if (Uteis.isAtributoPreenchido(unidadeEnsinoFinanceira)) {
			sql.append(" AND (unidadeEnsinoFinanceira.codigo = ").append(unidadeEnsinoFinanceira).append(") ");
		}
		if ((!situacao.equals("")) && (!situacao.equals("TO"))) {
			sql.append(" AND (UPPER(contareceber.situacao) LIKE '").append(situacao).append("%') ");
		}
		if (!Uteis.isAtributoPreenchido(ano) && !Uteis.isAtributoPreenchido(semestre)) {
			if (consDataCompetencia) {
				if (dataIni != null) {
					sql.append(" AND (contareceber.datacompetencia > '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("') ");
				}
				if (dataFim != null) {
					sql.append(" AND (contareceber.datacompetencia < '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
				}
			} else {
				if (dataIni != null) {
					sql.append(" AND (contareceber.datavencimento > '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("') ");
				}
				if (dataFim != null) {
					sql.append(" AND (contareceber.datavencimento < '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
				}
			}
		}
		if (Uteis.isAtributoPreenchido(ano)) {
			sql.append(" AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (Uteis.isAtributoPreenchido(semestre)) {
			sql.append(" AND matriculaperiodo.semestre = '").append(semestre).append("'  ");
		}
		if (!filtroRelatorioFinanceiroVO.getNenhumFiltroTipoOrigemSelecionado()) {
			adicionarFiltroTipoOrigem(filtroRelatorioFinanceiroVO, sql);
		}
		sql.append("ORDER BY contareceber.matriculaaluno, contareceber.datavencimento, contareceber.datacompetencia ");
		if (limite != null) {
			sql.append(" LIMIT ").append(limite);
			if (offset != null) {
				sql.append(" OFFSET ").append(offset);
			}
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), valorConsulta.toUpperCase());
		return montarDadosConsultaAlterarResponsavelFinanceiro(resultado);
	}

	public void adicionarFiltroTipoOrigem(FiltroRelatorioFinanceiroVO obj, StringBuilder sqlStr) {
		sqlStr.append(" AND contareceber.tipoorigem in (''");
		if (obj.getTipoOrigemBiblioteca()) {
			sqlStr.append(", 'BIB'");
		}
		if (obj.getTipoOrigemBolsaCusteadaConvenio()) {
			sqlStr.append(", 'BCC'");
		}
		if (obj.getTipoOrigemContratoReceita()) {
			sqlStr.append(", 'CTR'");
		}
		if (obj.getTipoOrigemDevolucaoCheque()) {
			sqlStr.append(", 'DCH'");
		}
		if (obj.getTipoOrigemInclusaoReposicao()) {
			sqlStr.append(", 'IRE'");
		}
		if (obj.getTipoOrigemInscricaoProcessoSeletivo()) {
			sqlStr.append(", 'IPS'");
		}
		if (obj.getTipoOrigemMatricula()) {
			sqlStr.append(", 'MAT'");
		}
		if (obj.getTipoOrigemMensalidade()) {
			sqlStr.append(", 'MEN'");
		}
		if (obj.getTipoOrigemNegociacao()) {
			sqlStr.append(", 'NCR'");
		}
		if (obj.getTipoOrigemOutros()) {
			sqlStr.append(", 'OUT'");
		}
		if (obj.getTipoOrigemRequerimento()) {
			sqlStr.append(", 'REQ'");
		}
		if (obj.getTipoOrigemMaterialDidatico()) {
			sqlStr.append(", 'MDI'");
		}
		sqlStr.append(" ) ");
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarPessoaContaReceberSituacaoAReceber(final ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		final String sql = " UPDATE contareceber set responsavelfinanceiro=?, tipopessoa=? WHERE (codigo = ?) " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				if (!obj.getResponsavelFinanceiro().getCodigo().equals(0)) {
					sqlAlterar.setInt(1, obj.getResponsavelFinanceiro().getCodigo());
				} else {
					sqlAlterar.setNull(1, 0);
				}
				sqlAlterar.setString(2, obj.getTipoPessoa());
				sqlAlterar.setInt(3, obj.getCodigo());
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarPessoaContaReceberSituacaoRecebido(final ContaReceberVO obj, UsuarioVO usuario) throws Exception {
		final String sql = " UPDATE contareceber set responsavelfinanceiro=?, tipopessoa=? WHERE (codigo = ?) " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				if (!obj.getResponsavelFinanceiro().getCodigo().equals(0)) {
					sqlAlterar.setInt(1, obj.getResponsavelFinanceiro().getCodigo());
				} else {
					sqlAlterar.setNull(1, 0);
				}
				sqlAlterar.setString(2, obj.getTipoPessoa());
				sqlAlterar.setInt(3, obj.getCodigo());
				return sqlAlterar;
			}
		});
		getFacadeFactory().getNegociacaoRecebimentoFacade().alterarPessoaTipoPessoaContaReceberNegociacaoRecebimento(obj, usuario);
		getFacadeFactory().getMovimentacaoCaixaFacade().alterarPessoaMovimentacaoCaixa(obj, usuario);
		getFacadeFactory().getExtratoContaCorrenteFacade().alterarPessoaExtratoContaCorrente(obj, usuario);
		getFacadeFactory().getChequeFacade().alterarPessoaCheque(obj, usuario);
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarPessoaContaReceberUnificacaoFuncionario(Integer pessoaAntigo, Integer pessoaNova) throws Exception {
		String sqlStr = "UPDATE ContaReceber set pessoa=? WHERE ((pessoa = ?))";
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { pessoaNova, pessoaAntigo });
	}

	@Override
	public List<ContaReceberVO> consultaCompletaPorMatriculaPeriodoValindadoOrigemPorConfiguracaoRecebimentoCartaoOnline(Integer matriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, ConfiguracaoRecebimentoCartaoOnlineVO configuracaoRecebimentoCartaoOnlineVO, UsuarioVO usuarioVO) throws Exception {
		if (matriculaPeriodo == null || matriculaPeriodo == 0) {
			return new ArrayList<>(0);
		}
		StringBuilder sqlStr = getSQLPadraoConsultaCompletaSemContaReceberRecebimento();
		sqlStr.append("WHERE contareceber.matriculaPeriodo = ? ");
		sqlStr.append(" and  contareceber.situacao = ? ");
		StringBuilder sbIn = new StringBuilder();
		if (configuracaoRecebimentoCartaoOnlineVO.getHabilitarRecebimentoMatriculaOnline()) {
			UteisTexto.addCampoParaClausaIn(sbIn, "'MAT'");
		}
		if (configuracaoRecebimentoCartaoOnlineVO.getHabilitarRecebimentoMensalidadeMatriculaOnline()) {
			UteisTexto.addCampoParaClausaIn(sbIn, "'MEN'");
		}
		if (Uteis.isAtributoPreenchido(sbIn)) {
			sqlStr.append(" and  contareceber.tipoOrigem in (").append(sbIn.toString()).append(")");
		}
		sqlStr.append(" ORDER BY contareceber.dataVencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), matriculaPeriodo, "AR");
		return montarDadosConsultaCompleta(resultado, configuracaoFinanceiroVO, Uteis.NIVELMONTARDADOS_TODOS, usuarioVO);
	}

	@Override
	public List<ContaReceberVO> consultaCompletaPorMatriculaPeriodoTipoMatriculaEMensalidadeAReceber(Integer matriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		if (matriculaPeriodo == null || matriculaPeriodo == 0) {
			return new ArrayList<ContaReceberVO>(0);

		}
		StringBuilder sqlStr = getSQLPadraoConsultaCompletaSemContaReceberRecebimento();
		sqlStr.append("WHERE contareceber.matriculaPeriodo = ");
		sqlStr.append(matriculaPeriodo);
		sqlStr.append(" and  contareceber.tipoOrigem in ('MEN', 'MAT') ");
		sqlStr.append(" and  contareceber.situacao = 'AR' ");
		sqlStr.append(" ORDER BY contareceber.dataVencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaCompleta(resultado, configuracaoFinanceiroVO, Uteis.NIVELMONTARDADOS_TODOS, usuarioVO);
	}

	@Override
	public Map<Integer, ConfiguracaoRecebimentoCartaoOnlineVO> realizarVerificacaoPermiteRecebimentoOnlineUsarMinhasContasVisaoAluno(String matriculaAluno, List<ContaReceberVO> contaReceberVOs, UsuarioVO usuarioVO) throws Exception {
		
		//MatriculaPeriodoVO matriculaPeriodoVO = getFacadeFactory().getMatriculaPeriodoFacade().consultarUltimaMatriculaPeriodoAtivaPorMatricula(matriculaAluno, false, Uteis.NIVELMONTARDADOS_TODOS, getAplicacaoControle().getConfiguracaoFinanceiroVO(0), usuarioVO);
		Map<Integer, ConfiguracaoRecebimentoCartaoOnlineVO> mapConfPorUnidadeFinanceiro =  new HashMap<Integer, ConfiguracaoRecebimentoCartaoOnlineVO>(0);
		for (ContaReceberVO obj : contaReceberVOs) {
			if(!obj.getBloquearPagamentoCartaoPorOutrosDebitos() && obj.isHabilitarBotaoRecebimento() && verificarBloqueioEmissaoBoletoContratoRejeitado(obj, usuarioVO, matriculaAluno)) {
			Boolean permiteRecebimentoCartaoOnline = false;
			Boolean permiteContaReceberNegociadaRecebimentoCartaoOnline = true;
			ConfiguracaoRecebimentoCartaoOnlineVO configuracaoRecebimentoCartaoOnlineVO = null;
			ConfiguracaoFinanceiroVO configuracaoFinanceiroVO = getAplicacaoControle().getConfiguracaoFinanceiroVO(obj.getUnidadeEnsinoFinanceira().getCodigo());
			if (!mapConfPorUnidadeFinanceiro.containsKey(obj.getUnidadeEnsinoFinanceira().getCodigo())) {
				if(configuracaoFinanceiroVO.getListaConfiguracaoFinanceiroCartaoVO().isEmpty()) {
				permiteRecebimentoCartaoOnline = getFacadeFactory().getConfiguracaoFinanceiroCartaoFacade().verificarExistenciaConfiguracaoFinanceiroCartaoPorCodigoConfiguracaoFinanceiro(configuracaoFinanceiroVO.getCodigo());
				}else {
					
					permiteRecebimentoCartaoOnline = configuracaoFinanceiroVO.getListaConfiguracaoFinanceiroCartaoVO().stream().anyMatch(t -> t.getPermitiRecebimentoCartaoOnline() && t.getOperadoraCartaoVO().getTipo().equals("CARTAO_CREDITO"));
				}				
				if (permiteRecebimentoCartaoOnline) {
					configuracaoRecebimentoCartaoOnlineVO = getFacadeFactory().getConfiguracaoRecebimentoCartaoOnlineFacade().consultarConfiguracaoRecebimentoCartaoOnlineDisponivel(matriculaAluno, obj.getUnidadeEnsinoFinanceira().getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, usuarioVO);
					mapConfPorUnidadeFinanceiro.put(obj.getUnidadeEnsinoFinanceira().getCodigo(), configuracaoRecebimentoCartaoOnlineVO);
				} else {
					mapConfPorUnidadeFinanceiro.put(obj.getUnidadeEnsinoFinanceira().getCodigo(), null);
				}
			} else {
				configuracaoRecebimentoCartaoOnlineVO = mapConfPorUnidadeFinanceiro.get(obj.getUnidadeEnsinoFinanceira().getCodigo());
				permiteRecebimentoCartaoOnline = Uteis.isAtributoPreenchido(configuracaoRecebimentoCartaoOnlineVO);
			}						
			obj.setConfiguracaoFinanceiro(configuracaoFinanceiroVO);// importante para rotina de apresentar nome origem na visao do aluno//pedro andrade.
			if (Uteis.isAtributoPreenchido(configuracaoRecebimentoCartaoOnlineVO)) {
				if(obj.getTipoOrigem().equals("NCR")) {
					permiteContaReceberNegociadaRecebimentoCartaoOnline = getFacadeFactory().getNegociacaoContaReceberFacade().permiteReceberCartaoCreditoVisaoAluno(obj.getCodOrigem(),usuarioVO);
				}
				if (permiteRecebimentoCartaoOnline && (obj.getTipoOrigem().equals(TipoOrigemContaReceber.MENSALIDADE.getValor()) || obj.getTipoOrigem().equals(TipoOrigemContaReceber.BOLSA_CUSTEADA_CONVENIO.getValor()) || obj.getTipoOrigem().equals(TipoOrigemContaReceber.MATRICULA.getValor()) || obj.getTipoOrigem().equals(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor()))) {
					permiteRecebimentoCartaoOnline = permiteEmitirBoletoAlunoVinculadoParceiro(obj.getCodigo());
				}
				if (permiteRecebimentoCartaoOnline &&
						getFacadeFactory().getConfiguracaoRecebimentoCartaoOnlineFacade().verificarContasRecebimentoOnlineContaReceberVO(obj, configuracaoRecebimentoCartaoOnlineVO, null, false, false, false, false, false, false, usuarioVO) && permiteContaReceberNegociadaRecebimentoCartaoOnline) {
					obj.setPermiteRecebimentoCartaoCreditoOnline(permiteRecebimentoCartaoOnline);
				}
			}
			}
		}
		return mapConfPorUnidadeFinanceiro;
	}

	public Boolean verificaSituacaoContaReceberPorCodigoSituacao(Integer codigoPrm, String situacao, UsuarioVO usuario) throws Exception {
		String sql = "SELECT codigo FROM ContaReceber WHERE codigo = ? and situacao = ?";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql, new Object[] { codigoPrm, situacao });
		if (!tabelaResultado.next()) {
			return false;
		}
		return true;
	}

	@Override
	public Double consultarValorParcelasInclusaoPorMatriculaPeriodo(Integer matriculaPeriodo, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("SELECT sum(valor) as valorTotal FROM contaReceber ");
		sqlStr.append("WHERE  matriculaPeriodo = ").append(matriculaPeriodo);
		sqlStr.append(" AND UPPER(parcela) like ('%IN%') ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getDouble("valorTotal");
		}
		return 0.0;
	}

	public Boolean consultarSituacaoRecebidaContaReceberTipoOrigemRequerimento(String codOrigem, Double valor, Integer codigo) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("SELECT situacao FROM contareceber ");
		sqlStr.append(" WHERE  contareceber.codorigem = '").append(codOrigem).append("'");
		sqlStr.append(" AND  contareceber.valor = ").append(valor);
		sqlStr.append(" AND  contareceber.codigo = ").append(codigo);
		sqlStr.append(" AND tipoorigem = 'REQ' AND contareceber.situacao = 'RE'; ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return true;
		}
		return false;
	}

	@Override
	public Boolean consultarMatriculaComPendenciaFinanceiraExterna(String matriculaAluno) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("select max(codigo) as codigo from contaReceber where matriculaAluno = ");
		sqlStr.append("'").append(matriculaAluno).append("'");
		sqlStr.append(" and possuiPendenciasFinanceirasExternas = true ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			Integer codigo = tabelaResultado.getInt("codigo");
			if ((codigo != null) && (!codigo.equals(0))) {
				return true;
			}
		}
		return false;
	}

	public void realizarVerificacaoPermiteRecebimentoOnlineVisaoAlunoBoletoMatriculaCalouro(
			MatriculaVO matricula, List<ContaReceberVO> contaReceberVOs, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		if (configuracaoFinanceiroVO.getBloquearCalouroPagarMatriculaVisaoAluno() && contaReceberVOs.stream().anyMatch(obj -> obj.getContaReceberReferenteMatricula())) {
			// Caso o aluno seja calouro a instituição pode desejar obrigá-lo a fazer o pagamento da taxa de
			// matrícula na própria tesouraria da instituição. Para garantir que esta situação aconteça esta
			// opção estará marcada e os calouros não poderão ver ou imprimir o boleto de matrícula.
			Boolean veterano = getFacadeFactory().getMatriculaPeriodoFacade().verificarMatriculaDeVeterano(matricula.getMatricula(), false, usuarioVO);
			if (!veterano) {
				// bloquear todas as taxas de matricula
				for (ContaReceberVO obj : contaReceberVOs) {
					if (obj.getContaReceberReferenteMatricula()) {
						obj.setBloquearPagamentoVisaoAluno(Boolean.TRUE);
						obj.setBloquearPagamentoCartaoPorOutrosDebitos(true);
					}
				}
			}
		}
	}

	public void realizarVerificacaoPermiteRecebimentoOnlineVisaoAlunoBoletoMatriculaInadimplente(MatriculaVO matricula, List<ContaReceberVO> contaReceberVOs,ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Integer codigoCurso,  UsuarioVO usuarioVOCorrente,  int nivelMontarDados, UsuarioVO usuarioVO, Boolean origemAplicativo) throws Exception {
		if (configuracaoFinanceiroVO.getBloquearPagarMatriculaRenovacaoVisaoAlunoInadimplente() && contaReceberVOs.stream().anyMatch(obj -> obj.getContaReceberReferenteMatricula())) {
			if (matricula.getCurso().getIntegral()) {
				return;
			}
			// Caso o aluno esteja renovando sua matrícula, mas está com alguma inadimplência e/ou algum boleto ainda
			// em aberto (mesmo que nao vencido) no
			// seu passado a instituição pode desejar obrigá-lo a fazer a renegociação de sua divida
			// antes de liberar o pagamento da matrícula de renovação. Para garantir que esta situação
			// aconteça esta opção estará marcada e os calouros não poderão ver ou imprimir o boleto de matrícula.
			// Iremos verificar abaixo dois tipos de situações. A primeira é se o aluno tem alguma conta a receber
			// que já está vencida (o que coloca o aluno como inadimplenete. A segunda é se alguma das contas a receber
			// está com a opcção possuiPendenciasFinanceirasExternas marcada - o que também significa que o aluno
			// tem dividas externas (controladas fora do SEI) mas que precisam gerar um bloqueio também ao seu
			// acesso ao pagamento de matrícula
			boolean alunoEstaInadimplente = false;
			List<ContaReceberVO> contaReceberEmAbertoVisaoAluno = new ArrayList<ContaReceberVO>(0);
			boolean permiteVisualizarParcelasPeriodoContratosEletronico = verificarPermissaoOperacao(usuarioVO.getPerfilAcesso().getCodigo(), "PermiteVisualizarParcelasPeriodoContratosEletronico", 1);
			boolean permitePagamentoParcelasPeriodoContratosEletronico = verificarPermissaoOperacao(usuarioVO.getPerfilAcesso().getCodigo(), "PermitePagamentoParcelasPeriodoContratosEletronico", 1);
			List<Integer> matriculaPeriodosContratosPendenteRejeitado = getFacadeFactory().getDocumentoAssinadoFacade().consultarDocumentosPendenteRejeitadoMatricula(matricula.getMatricula(), "");

			if(configuracaoFinanceiroVO.getUtilizarIntegracaoFinanceira()) {
				contaReceberEmAbertoVisaoAluno = consultarContasPagarVisaoAluno(configuracaoGeralSistemaVO, configuracaoFinanceiroVO, codigoCurso,  matricula.getMatricula(),  "EM",  usuarioVOCorrente,  nivelMontarDados,  usuarioVO,  origemAplicativo, null, null, new DataModelo(), permiteVisualizarParcelasPeriodoContratosEletronico , permitePagamentoParcelasPeriodoContratosEletronico , matriculaPeriodosContratosPendenteRejeitado);
			}
			else {
				contaReceberEmAbertoVisaoAluno = consultarContasPagarVisaoAluno(configuracaoGeralSistemaVO, configuracaoFinanceiroVO, codigoCurso,  matricula.getMatricula(),  "VE",  usuarioVOCorrente,  nivelMontarDados,  usuarioVO,  origemAplicativo, null, null, new DataModelo(), permiteVisualizarParcelasPeriodoContratosEletronico , permitePagamentoParcelasPeriodoContratosEletronico , matriculaPeriodosContratosPendenteRejeitado);
			}		
						
			for (ContaReceberVO obj : contaReceberEmAbertoVisaoAluno) {
				if (obj.getPossuiPendenciasFinanceirasExternas()) {
					alunoEstaInadimplente = true;
					break;
				}
				if (obj.getSituacaoAReceber() && !obj.getContaReceberReferenteMatricula()) {
					// se tem uma conta a receber em aberto (esteja atrasada ou não)
					// o usuário nao poderá imprimir a parcela de matrícula
					// && (obj.getNrDiasAtraso().compareTo(0l) > 0)) {
					alunoEstaInadimplente = true;
					break;
				}
			}
			if (alunoEstaInadimplente) {
				// Se o aluno está inadimplente entao vamos marcar as contas de
				// matricula como não acessíveis para pagamento online.
				for (ContaReceberVO obj : contaReceberVOs) {
					if (obj.getContaReceberReferenteMatricula()) {
						obj.setBloquearPagamentoVisaoAluno(Boolean.TRUE);		
						obj.setBloquearPagamentoCartaoPorOutrosDebitos(true);
					}
				}
			}
		}
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaDataVencimentoEDiaSemenaESituacaoAReceberCompleto(String matricula, Date dataVencimentoInicio, Date dataVencimentoFinal, DiaSemana diaSemana, Boolean consultaContaVencida, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Optional<FiltroRelatorioFinanceiroVO> filtroRelatorioFinanceiroVO, String parcela, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT contareceber.codigo, contareceber.updated, pessoa.codigo AS \"pessoa.codigo\", pessoa.nome AS \"pessoa.nome\", contaReceber.matriculaAluno, contareceber.nossonumero, contareceber.parcela, contareceber.valor, contareceber.situacao, contareceber.datavencimento, contareceber.tipoorigem ");
		sqlStr.append(" FROM contareceber");
		sqlStr.append(" LEFT JOIN pessoa ON pessoa.codigo = contaReceber.pessoa ");
		sqlStr.append(" WHERE 1=1 ");
		if (Uteis.isAtributoPreenchido(matricula)) {
			sqlStr.append(" AND contaReceber.matriculaAluno = '").append(matricula).append("' ");
		}		
		if (!diaSemana.getValor().equals(DiaSemana.NENHUM.getValor())) {
			sqlStr.append(" AND TO_CHAR(contaReceber.dataVencimento, 'D') = '").append(diaSemana.getValor().replace("0", "")).append("' ");
		}
		sqlStr.append(" AND contareceber.situacao = 'AR' ");
		
		if (Uteis.isAtributoPreenchido(parcela)) {
			sqlStr.append("AND contaReceber.parcela = '").append(parcela).append("' ");
		}
		
		if (consultaContaVencida && dataVencimentoInicio != null && dataVencimentoFinal != null) {
			sqlStr.append(" AND ( contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataVencimentoInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataVencimentoFinal)).append("' ) ");
		}else if (!consultaContaVencida && dataVencimentoInicio != null) {
			if(UteisData.getCompareData(new Date(), dataVencimentoInicio) > 0){
				dataVencimentoInicio = new Date();
			}
			sqlStr.append(" AND ( contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataVencimentoInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataVencimentoFinal)).append("' ) ");			
		}else if (!consultaContaVencida) {
			sqlStr.append(" AND contareceber.dataVencimento >= current_date ");
		}
		filtroRelatorioFinanceiroVO.ifPresent(filtro -> sqlStr.append(" AND ").append(adicionarFiltroTipoOrigemContaReceber(filtro, "contaReceber")));
		sqlStr.append(" AND contareceber.pagocomdcc = 'f'");
		sqlStr.append(" ORDER BY contareceber.datavencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<ContaReceberVO> listaContaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (resultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(resultado.getInt("codigo"));
			obj.setUpdated(resultado.getDate("updated"));
			obj.setNossoNumero(resultado.getString("nossoNumero"));
			obj.setParcela(resultado.getString("parcela"));
			obj.setValor(resultado.getDouble("valor"));
			obj.setSituacao(resultado.getString("situacao"));
			obj.setDataVencimento(resultado.getDate("dataVencimento"));
			obj.getMatriculaAluno().setMatricula(resultado.getString("matriculaAluno"));
			obj.getMatriculaAluno().getAluno().setCodigo(resultado.getInt("pessoa.codigo"));
			obj.getMatriculaAluno().getAluno().setNome(resultado.getString("pessoa.nome"));
			obj.setTipoOrigem(resultado.getString("tipoorigem"));
			listaContaReceberVOs.add(obj);
		}
		return listaContaReceberVOs;
	}

	private void realizarVerificacaoPermiteRecebimentoOnlineVisaoAlunoBoletoSemRegistroRemessa(MatriculaVO matricula, List<ContaReceberVO> contaReceberVOs) throws Exception {
		// Caso o cliente utilize integração financeira, o sistema deverá possuir essa validação para emissão de boletos na visão do aluno
		// Deverá emitir apenas boletos que possuam registro de remessa na tabela controleremessacontareceber.
		for (ContaReceberVO obj : contaReceberVOs) {
			obj.setBloquearPagamentoVisaoAluno(obj.getSituacao().equals(SituacaoContaReceber.A_RECEBER.getValor()) 
					&& obj.getContaCorrenteVO().getBloquearEmitirBoletoSemRegistroRemessa()
					&& getFacadeFactory().getControleRemessaContaReceberFacade().verificaContaReceberRegistrada(obj));
		}
	}

	public void realizarSimulacaoDataVencimentoAtualizar(Date novaDataVencimento, List<ContaReceberVO> listaContaReceberVOs, UsuarioVO usuarioVO) throws Exception {
		int qtdeMesesAvancarContaReceber = 0;
		for (ContaReceberVO contaReceberVO : listaContaReceberVOs) {
			contaReceberVO.setDataVencimentoAtualizar(Uteis.getDataFutura(novaDataVencimento, GregorianCalendar.MONTH, qtdeMesesAvancarContaReceber));
			qtdeMesesAvancarContaReceber++;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarAtualizacaoVencimentoPorPeriodo(List<MatriculaVO> listaMatriculaVOs, Date novaDataVencimento, ProgressBarVO progressBarVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		for (MatriculaVO matriculaVO : listaMatriculaVOs) {
			if (matriculaVO.getAlunoSelecionado()) {				
				progressBarVO.setStatus("Processando dados da Matrícula n° " + matriculaVO.getMatricula() + " ( " + progressBarVO.getProgresso() + " de " + progressBarVO.getMaxValue() + " ) ");
				for (ContaReceberVO contaReceberVO : matriculaVO.getListaContaReceberVOs()) {
					if (contaReceberVO.getSelecionado() && contaReceberVO.getSituacao().equals("AR")) {
						contaReceberVO.setNivelMontarDados(NivelMontarDados.NAO_INICIALIZADO);
						getFacadeFactory().getContaReceberFacade().carregarDados(contaReceberVO, NivelMontarDados.TODOS, configuracaoFinanceiro, usuario);
						contaReceberVO.setDataVencimento(contaReceberVO.getDataVencimentoAtualizar());
						contaReceberVO.setAtualizandoVencimento(Boolean.TRUE);
						ControleRemessaContaReceberVO crcr = getFacadeFactory().getControleRemessaContaReceberFacade().consultaRapidaContaArquivoRemessaPorCodigoContaReceber(contaReceberVO.getCodigo());
						verificarAlteracoesContaRemessa(crcr, contaReceberVO, configuracaoFinanceiro, contaReceberVO);
						if (contaReceberVO.getContaRemetidaComAlteracao()) {
							alterarContaReceberRemetidaComAlteracao(contaReceberVO.getCodigo(), contaReceberVO);
						}
						atualizarDataVencimentoParaRegerarBoleto(contaReceberVO, configuracaoFinanceiro, true, usuario, crcr);
					}
				}
				progressBarVO.setProgresso(progressBarVO.getProgresso() + 1);
			}
		}
	}
	

	public void validarDadosAtualizacaoVencimentoPorPeriodo(Date dataVencimentoInicio, Date dataVencimentoFinal) throws Exception {
		if (dataVencimentoInicio == null) {
			throw new Exception("A DATA INÍCIO deve ser informada!");
		}
		if (dataVencimentoFinal == null) {
			throw new Exception("A DATA FINAL deve ser informada!");
		}
	}

	@Override
	public boolean executarVerificacaoContaReceberRecebidaOuNegociada(Integer codigoOrigem, String tipoOrigem, UsuarioVO usuario) throws Exception {
		String sql = "SELECT 1 FROM ContaReceber WHERE tipoorigem = '" + tipoOrigem + "' AND codorigem = '" + codigoOrigem + "' AND situacao in ('RE', 'NE')";
		return getConexao().getJdbcTemplate().queryForRowSet(sql).next();
	}

	@Override
	public boolean consultarExistenciaContaReceberRecebidaNegociadaPorCodigo(Integer contaReceber) throws Exception {
		StringBuilder sql = new StringBuilder("select count(codigo) as qtd from contareceber where ");
		sql.append(" codigo = ").append(contaReceber);
		sql.append(" and situacao in ('RE', 'NE', 'CF') ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return Uteis.isAtributoPreenchido(rs, "qtd", TipoCampoEnum.INTEIRO);
	}
	
	@Override
	public Boolean consultarExistenciaContaReceberConvenioRecebidaNegociadaPorMatriculaPeriodoEConvenio(String matricula, Integer matriculaPeriodo, Integer convenio) throws Exception {
		StringBuilder sql = new StringBuilder("select codigo from contareceber where ");
		sql.append(" matriculaperiodo = ").append(matriculaPeriodo);
		sql.append(" and matriculaaluno = '").append(matricula).append("' ");
		if (Uteis.isAtributoPreenchido(convenio)) {
			sql.append(" and convenio = ").append(convenio).append(" ");
		}
		sql.append(" and tipoorigem = 'BCC'");
		sql.append(" and situacao in ('RE', 'NE') limit 1");
		return getConexao().getJdbcTemplate().queryForRowSet(sql.toString()).next();
	}

	@Override
	public Boolean consultarExistenciaContaReceberAlunoVinculadoContaConvenio(String matricula, Integer matriculaPeriodo, Integer convenio, String parcela) throws Exception {
		StringBuilder sql = new StringBuilder("select codigo from contareceber where ");
		sql.append(" matriculaperiodo = ").append(matriculaPeriodo);
		sql.append(" and matriculaaluno = '").append(matricula).append("' ");
		sql.append(" and tipoorigem in ('MAT', 'MEN')");
		sql.append(" and parcela = '").append(parcela).append("' ");
		sql.append(" and exists (select pdcc.codigo from planodescontocontareceber pdcc where pdcc.contareceber = contareceber.codigo and pdcc.convenio= ").append(convenio).append(" ) ");
		return getConexao().getJdbcTemplate().queryForRowSet(sql.toString()).next();
	}

	public Boolean consultarExistenciaContaReceberAlunoVinculadoRegistroNegativacao(Integer codigoContaReceber) throws Exception {
		StringBuilder sql = new StringBuilder("select re.codigo from registronegativacaocobrancacontareceberitem  re ");
		sql.append(" inner join contareceber on contareceber.codigo = re.contareceber ");
		sql.append(" where contareceber.codigo = ").append(codigoContaReceber).append(" and dataexclusao is null limit 1");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		while (rs.next()) {
			return true;
		}
		return false;
	}

	@Override
	public List<ContaReceberVO> consultar(ControleConsulta consulta, Boolean consDataCompetencia, int codigoUnidadeEnsino, String ano, String semestre, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, ContaReceberVO contaReceberVO, String tipoOrigem, int limite, int offset, int nivelMontarDados, List<String> valorConsultaReceberRecebidoNegociado, UsuarioVO usuarioVO, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, List<String> listaDeStringFiltroSelecionado) throws Exception {
		List<ContaReceberVO> objs = new ArrayList<ContaReceberVO>();
		Date dataInicio = consulta.getDataIni();
		Date dataFinal = consulta.getDataFim();
		if (consulta.getBuscarPeriodoCompleto()) {
			dataInicio = Uteis.getDate("01/01/1980");
			dataFinal = Uteis.getDate("01/01/2100");
		}
		if (consDataCompetencia) {
			dataInicio = Uteis.getDataPrimeiroDiaMes(dataInicio);
			dataFinal = Uteis.getDataUltimoDiaMes(dataFinal);
		}
		if (dataInicio != null && dataFinal == null) {
			dataFinal = new Date();
		}
		if (dataFinal != null && dataInicio == null) {
			dataInicio = new Date();
		}
		if (dataInicio == null && dataFinal == null) {
			dataInicio = Uteis.getDate("01/01/1980");
			dataFinal = Uteis.getDate("01/01/2100");
		}
		if (consulta.getCampoConsulta().equals("codigo") || consulta.getCampoConsulta().equals("codigobarra") || consulta.getCampoConsulta().equals("nossoNumero")
				|| consulta.getCampoConsulta().equals("nrDocumento")) {
			filtroRelatorioFinanceiroVO = null;
			valorConsultaReceberRecebidoNegociado = new ArrayList<>();
		}
		if (consulta.getCampoConsulta().equals("codigo")) {
			int valorInt = 0;
			try {
				valorInt = Integer.parseInt(consulta.getValorConsulta());
			} catch (NumberFormatException e) {
				throw new Exception("Formato inválido. Apenas valores numéricos.");
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorCodigo(new Integer(valorInt), true, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO);
		}
		if (consulta.getCampoConsulta().equals("nomeSacado")) {
			if ((consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().replaceAll("%", "").length() < 3) || (!consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().length() < 3)) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorNomeSacado(consulta.getValorConsulta(), valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, consDataCompetencia, dataInicio, dataFinal, limite, offset, true, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO, listaDeStringFiltroSelecionado);
		}
		if (consulta.getCampoConsulta().equals("nrDocumento")) {
			if (consulta.getValorConsulta().length() < 3) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorNrDocumento(consulta.getValorConsulta(), consulta.getDataIni(), consulta.getDataFim(), valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("codigobarra")) {
			if (consulta.getValorConsulta().length() < 3) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorCodigoBarra(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("nossoNumero")) {
			if (consulta.getValorConsulta().length() < 3) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorNossoNumero(consulta.getValorConsulta(), valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("cpf")) {
			if (consulta.getValorConsulta().length() < 3) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorCPF(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("aluno")) {
			if ((consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().replaceAll("%", "").length() < 3) || (!consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().length() < 3)) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorAlunoLimiteOffset(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO, listaDeStringFiltroSelecionado);
		}

		if (consulta.getCampoConsulta().equals("alunoNome")) {
			if ((consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().replaceAll("%", "").length() < 3) || (!consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().length() < 3)) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorNomeAlunoLimiteOffset(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO, listaDeStringFiltroSelecionado);
		}

		if (consulta.getCampoConsulta().equals("responsavelFinanceiro")) {
			if ((consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().replaceAll("%", "").length() < 3) || (!consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().length() < 3)) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorResponsavelFinanceiroLimiteOffset(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO, listaDeStringFiltroSelecionado);
		}

		if (consulta.getCampoConsulta().equals("funcionario")) {
			if ((consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().replaceAll("%", "").length() < 3) || (!consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().length() < 3)) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorFuncionario(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO, listaDeStringFiltroSelecionado);
		}
		if (consulta.getCampoConsulta().equals("convenio")) {
			if ((consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().replaceAll("%", "").length() < 3) || (!consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().length() < 3)) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorConvenio(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_TODOS, usuarioVO, filtroRelatorioFinanceiroVO, listaDeStringFiltroSelecionado);
		}
		if (consulta.getCampoConsulta().equals("fornecedor")) {
			if ((consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().replaceAll("%", "").length() < 3) || (!consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().length() < 3)) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorFornecedorLimiteOffset(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_TODOS, usuarioVO, filtroRelatorioFinanceiroVO, listaDeStringFiltroSelecionado);
		}
		if (consulta.getCampoConsulta().equals("identificadorCentroReceitaCentroReceita")) {
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorIdentificadorCentroReceita(consulta.getValorConsulta(), contaReceberVO.getCentroReceita().getIdentificadorCentroReceita(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, limite, offset, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO, listaDeStringFiltroSelecionado);
		}
		if (consulta.getCampoConsulta().equals("anoSemestre")) {
			if ((consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().replaceAll("%", "").length() < 3) || (!consulta.getBuscarPeriodoCompleto() && consulta.getValorConsulta().length() < 3)) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_vazio3"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorNomeSacadoAnoSemestre(consulta.getValorConsulta(), ano, semestre, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, limite, offset, true, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("codigoFinanceiroMatricula")) {
			if (consulta.getValorConsulta().length() < 1) {
				throw new Exception(UteisJSF.internacionalizar("msg_ParametroConsulta_informeUmParametro"));
			}
			objs = getFacadeFactory().getContaReceberFacade().consultaRapidaPorCodigoFinanceiroMatricula(consulta.getValorConsulta(), valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, limite, offset, true, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		return objs;
	}

	@Override
	public Integer consultarTotalRegistros(ControleConsulta consulta, Boolean consDataCompetencia, int codigoUnidadeEnsino, String ano, String semestre, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, ContaReceberVO contaReceberVO, String tipoOrigem, int limite, int offset, int nivelMontarDados, List<String> valorConsultaReceberRecebidoNegociado, UsuarioVO usuarioVO, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO, List<String> listaDeStringFiltroSelecionado) throws Exception {
		Date dataInicio = consulta.getDataIni();
		Date dataFinal = consulta.getDataFim();
		if (consulta.getBuscarPeriodoCompleto()) {
			dataInicio = Uteis.getDate("01/01/1980");
			dataFinal = Uteis.getDate("01/01/2100");
		}
		if (consDataCompetencia) {
			dataInicio = Uteis.getDataPrimeiroDiaMes(dataInicio);
			dataFinal = Uteis.getDataUltimoDiaMes(dataFinal);
		}
		if (consulta.getCampoConsulta().equals("codigo")) {
			int valorInt = Integer.parseInt(consulta.getValorConsulta());
			return getFacadeFactory().getContaReceberFacade().consultarPorCodigoTotalRegistros(new Integer(valorInt), codigoUnidadeEnsino, tipoOrigem, true, usuarioVO);
		}
		if (consulta.getCampoConsulta().equals("nomeSacado")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorNomeSacadoTotalRegistros(consulta.getValorConsulta(), valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, consDataCompetencia, dataInicio, dataFinal, true, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("nrDocumento")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorNrDocumentoTotalRegistros(consulta.getValorConsulta(), consulta.getDataIni(), consulta.getDataFim(), valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("codigobarra")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorCodigoBarraTotalRegistros(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("nossoNumero")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorNossoNumeroTotalRegistros(consulta.getValorConsulta(), valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("cpf")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorCPFTotalRegistros(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("aluno")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorAlunoTotalRegistros(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("alunoNome")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorNomeAlunoTotalRegistros(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("responsavelFinanceiro")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorResponsavelFinanceiroTotalRegistros(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, "", true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("funcionario")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorFuncionarioToalRegistros(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, "", true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("convenio")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorConvenioTotalRegistros(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("fornecedor")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorFornecedorTotalRegistros(consulta.getValorConsulta(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("identificadorCentroReceitaCentroReceita")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorIdentificadorCentroReceitaTotalRegistros(consulta.getValorConsulta(), contaReceberVO.getCentroReceita().getIdentificadorCentroReceita(), consDataCompetencia, dataInicio, dataFinal, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("anoSemestre")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorNomeSacadoAnoSemestreTotalRegistros(consulta.getValorConsulta(), ano, semestre, valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		if (consulta.getCampoConsulta().equals("codigoFinanceiroMatricula")) {
			return getFacadeFactory().getContaReceberFacade().consultaRapidaPorCodigoFinanceiroMatriculaTotalRegistros(consulta.getValorConsulta(), valorConsultaReceberRecebidoNegociado, codigoUnidadeEnsino, tipoOrigem, true, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO, filtroRelatorioFinanceiroVO);
		}
		return 0;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoPagoDCCFalso(Integer codigoContaReceber) throws Exception {
		String sqlStr = "UPDATE ContaReceber set pagoComDCC= 'f' WHERE ((codigo = ?))";
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { codigoContaReceber });
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoPagoDCCTrue(Integer codigoContaReceber) throws Exception {
		String sqlStr = "UPDATE ContaReceber set pagoComDCC= 't' WHERE ((codigo = ?))";
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { codigoContaReceber });
	}

	public void validarDadosMotivoCancelamento(ContaReceberVO obj, UsuarioVO usuarioVO) throws Exception {
		if (obj.getMotivoCancelamento().equals("")) {
			throw new Exception("O campo MOTIVO CANCELAMENTO deve ser informado!");
		}
		obj.getResponsavelCancelamentoVO().setCodigo(usuarioVO.getCodigo());
		obj.getResponsavelCancelamentoVO().setNome(usuarioVO.getNome());
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarDadosCancelamento(final Integer codigo, final String motivoCancelamento, final Date dataCancelamento, final Integer responsavelCancelamento, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set motivoCancelamento=?, dataCancelamento=?, responsavelCancelamento=?, updated = ? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setString(1, motivoCancelamento);
				sqlAlterar.setTimestamp(2, Uteis.getDataJDBCTimestamp(dataCancelamento));
				if (Uteis.isAtributoPreenchido(responsavelCancelamento)) {
					sqlAlterar.setInt(3, responsavelCancelamento);
				} else {
					sqlAlterar.setNull(3, 0);
				}
				sqlAlterar.setTimestamp(4, Uteis.getDataJDBCTimestamp(new Date()));
				sqlAlterar.setInt(5, codigo);
				return sqlAlterar;
			}
		});

	}

	@Override
	public List<ContaReceberVO> consultarContasAPagarVisaoAluno(ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Integer codigoCurso, String matricula, String tipoContasAPagar, UsuarioVO usuarioVOCorrente, Map<Integer, ConfiguracaoRecebimentoCartaoOnlineVO> configuracaoRecebimentoCartaoOnlineVOs, int nivelMontarDados, UsuarioVO usuarioVO, Boolean origemAplicativo, Integer limite, Integer offset, DataModelo dataModelo) throws Exception {
		validarUsuarioConsultarMinhasContasReceber(usuarioVO);
		boolean permiteVisualizarParcelasPeriodoContratosEletronico = verificarPermissaoOperacao(usuarioVO.getPerfilAcesso().getCodigo(), "PermiteVisualizarParcelasPeriodoContratosEletronico", 1);
		boolean permitePagamentoParcelasPeriodoContratosEletronico = verificarPermissaoOperacao(usuarioVO.getPerfilAcesso().getCodigo(), "PermitePagamentoParcelasPeriodoContratosEletronico", 1);
		List<Integer> matriculaPeriodosContratosPendenteRejeitado = getFacadeFactory().getDocumentoAssinadoFacade().consultarDocumentosPendenteRejeitadoMatricula(matricula, "ALUNO");
		List<ContaReceberVO> contaReceberVOs = consultarContasPagarVisaoAluno(configuracaoGeralSistemaVO, configuracaoFinanceiroVO, codigoCurso,  matricula,  tipoContasAPagar,  usuarioVOCorrente,  nivelMontarDados,  usuarioVO,  origemAplicativo, limite, offset, dataModelo , permiteVisualizarParcelasPeriodoContratosEletronico , permitePagamentoParcelasPeriodoContratosEletronico , matriculaPeriodosContratosPendenteRejeitado);
		MatriculaVO matriculaVO = new MatriculaVO();
		matriculaVO.setMatricula(matricula);
		getFacadeFactory().getMatriculaFacade().carregarDados(matriculaVO, usuarioVO);
		
		realizarVerificacaoPermiteRecebimentoOnlineVisaoAlunoBoletoSemRegistroRemessa(null, contaReceberVOs);
		realizarVerificacaoPermiteRecebimentoOnlineVisaoAlunoBoletoMatriculaCalouro(matriculaVO, contaReceberVOs, configuracaoFinanceiroVO, usuarioVO);
		realizarVerificacaoPermiteRecebimentoOnlineVisaoAlunoBoletoMatriculaInadimplente(matriculaVO,contaReceberVOs, configuracaoGeralSistemaVO, configuracaoFinanceiroVO, codigoCurso,usuarioVOCorrente,  nivelMontarDados,  usuarioVO,  origemAplicativo);
		// Regra para verificar se conta pode ser impressa, utilizando as regras de controle para emissão.
		 contaReceberVOs.stream().forEach(obj ->{
		    if (!obj.getContaCorrenteVO().getControlarBloqueioEmissaoBoleto() && permiteVisualizarParcelasPeriodoContratosEletronico && !permitePagamentoParcelasPeriodoContratosEletronico){
		    	obj.setEmissaoBloqueada(matriculaPeriodosContratosPendenteRejeitado.stream().anyMatch(obj.getMatriculaPeriodo()::equals));	
		    } else if (permiteVisualizarParcelasPeriodoContratosEletronico && !permitePagamentoParcelasPeriodoContratosEletronico) {
		    	obj.setEmissaoBloqueada(matriculaPeriodosContratosPendenteRejeitado.stream().anyMatch(obj.getMatriculaPeriodo()::equals) || this.verificaBloqueioEmissaoBoleto(obj, usuarioVO));
			} else {
				obj.setEmissaoBloqueada(this.verificaBloqueioEmissaoBoleto(obj, usuarioVO));
			}
		});

		validarTipoImpressao(contaReceberVOs, usuarioVO);
		configuracaoRecebimentoCartaoOnlineVOs.putAll(realizarVerificacaoPermiteRecebimentoOnlineUsarMinhasContasVisaoAluno(matricula, contaReceberVOs, usuarioVO));
		realizarVerificacaoRegraImpressaoBoleto(contaReceberVOs, configuracaoFinanceiroVO, usuarioVO);
		return contaReceberVOs;
	}
	
	@Override
	public List<ContaReceberVO> consultarConvenioFinanciamentoProprioVisaoAluno(ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, String matricula, UsuarioVO usuarioVOCorrente, Integer unidadeEnsino, int nivelMontarDados, UsuarioVO usuarioVO) throws Exception {
		validarUsuarioConsultarMinhasContasReceber(usuarioVO);
		String matriculaAluno = matricula;	
		Integer pais = usuarioVOCorrente.getPessoa().getCodigo();
		Integer filho = 0;
		if (usuarioVO.getIsApresentarVisaoPais()) {
			pais = usuarioVO.getPessoa().getCodigo();
			filho = usuarioVOCorrente.getPessoa().getCodigo();
			VisaoAlunoControle visaoAlunoControle = (VisaoAlunoControle) context().getExternalContext().getSessionMap().get("VisaoAlunoControle");
			if (visaoAlunoControle != null) {
				matriculaAluno = visaoAlunoControle.getMatricula().getMatricula();
			}
				
		} 
		return consultarConvenioFinanciamentoProprioVisaoAluno(pais, filho, matriculaAluno, unidadeEnsino, false, nivelMontarDados, configuracaoFinanceiroVO, usuarioVO);
	}
	
	
	
	public List consultarConvenioFinanciamentoProprioVisaoAluno(Integer pais, Integer filho, String matriculaAluno, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		String sqlStr = getSQLPadraoConsultaBasica().toString().replace("SELECT", "SELECT distinct ");
		sqlStr += " WHERE ";
		sqlStr += " parceiro.financiamentoProprio = true and contareceber.tipoorigem = 'BCC' ";
		if (pais != null && Uteis.isAtributoPreenchido(matriculaAluno)) {
			sqlStr += " and ( contareceber.responsavelFinanceiro = " + pais + " or ( matricula.matricula ) = ('" + matriculaAluno + "') )";
		} else if (pais != null && Uteis.isAtributoPreenchido(filho)) {
			sqlStr += " and ( contareceber.responsavelFinanceiro = " + pais + " or (contareceber.pessoa ) = (" + filho + ") )";
		} else {
			sqlStr += " and contareceber.responsavelFinanceiro = " + pais;
		}
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " and ContaReceber.unidadeensinofinanceira  = (" + unidadeEnsino + ") ";
		}
		
		sqlStr += "ORDER BY ContaReceber.dataVencimento";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List<ContaReceberVO> listaConsulta = (montarDadosConsultaBasica(tabelaResultado));
		for (ContaReceberVO obj : listaConsulta) {
			obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
			if (!obj.getSituacaoEQuitada()) {
				obj.getCalcularValorFinal(new Date(), configuracaoFinanceiroVO, false, new Date(), usuario);
			}
		}
		return listaConsulta;
	}

	public void alterarNotaFiscalSaidaServico(final ContaReceberVO contaReceberVO, final Integer codigoNotaFiscalServicoSaida, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE ContaReceber set notaFiscalSaidaServico=?  WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setInt(1, codigoNotaFiscalServicoSaida);
				sqlAlterar.setInt(2, contaReceberVO.getCodigo());
				return sqlAlterar;
			}
		});

		final String sql2 = "UPDATE ContaReceberRecebimento set notaFiscalSaidaServico=?  WHERE ((contareceber = ?) and negociacaorecebimento is not null and formapagamentonegociacaorecebimento is not null)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql2);
				sqlAlterar.setInt(1, codigoNotaFiscalServicoSaida);
				sqlAlterar.setInt(2, contaReceberVO.getCodigo());
				return sqlAlterar;
			}
		});

	}

	@Override
	public Integer consultarNumeroNotaFiscalSaidaServicoPorContaReceber(Integer contaReceber) throws Exception {
		Integer nNota = 0;
		String sql = "select notafiscalsaidaservico from contareceber WHERE ((codigo = " + contaReceber + ")) ";
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql);
		while (rs.next()) {
			nNota = rs.getInt("notafiscalsaidaservico");
		}
		return nNota;
	}

	@Override
	public void realizarVinculoNotaFiscalSaidaContaReceberPorNossoNumero(final List<ContaReceberVO> mapNossoNumeroNotaFiscal, final UsuarioVO usuario) throws Exception {
		if (mapNossoNumeroNotaFiscal != null && mapNossoNumeroNotaFiscal.size() > 0) {
			for (final ContaReceberVO contaReceberVO : mapNossoNumeroNotaFiscal) {
				final String sql = "UPDATE ContaReceber set notaFiscalSaidaServico=?  WHERE tipoorigem = ? and codorigem = ? and parcela = ? " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
				getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
					public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
						PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
						sqlAlterar.setInt(1, contaReceberVO.getNotaFiscalSaidaServicoVO().getCodigo());
						sqlAlterar.setString(2, contaReceberVO.getTipoOrigem());
						sqlAlterar.setString(3, contaReceberVO.getCodOrigem());
						sqlAlterar.setString(4, contaReceberVO.getParcela());
						return sqlAlterar;
					}
				});

			}
		}
	}

	@Override
	public void consultarContasReceberTipoOrigemCodigoOrigemSituacaoParcela(String parcela, MatriculaPeriodoVO matPeriodoVO, UsuarioVO usuario) throws Exception {
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE ((tipoOrigem = 'BCC') and (codOrigem = '").append(matPeriodoVO.getCodigo()).append("') and notafiscalsaidaservico is not null )"); // tipoOrigem = BC
		sql.append(" and (contareceber.situacao = 'AR') ");
		if (!parcela.equals("")) {
			sql.append(" and (parcela = '").append(parcela).append("') ");
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		while (resultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			montarDadosBasico(obj, resultado);
			matPeriodoVO.getContaReceberNotaFiscalEmitidaVOs().add(obj);
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void removerVinculoNotaFiscalSaidaServicoContaReceber(final Integer notaFiscalSaidaServico, UsuarioVO usuarioVO) throws Exception {
		final String sql = "UPDATE ContaReceber SET notaFiscalSaidaServico = null WHERE ((notaFiscalSaidaServico = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
				sqlAlterar.setInt(1, notaFiscalSaidaServico);
				return sqlAlterar;
			}
		});
	}

	@Override
	public void adicionarDescontoRateioEmPlanoFinanceiroAlunoDescricaoDescontosVO(List<PlanoFinanceiroAlunoDescricaoDescontosVO> planoFinanceiroAlunoDescricaoDescontosVOs, Double valorBase, Double valorCusteadoContaReceber, Double valorDescontoRateio, Date dataVencimento, Date dataReferenciaConsiderarBaixaTitulo) throws Exception {
		if (Uteis.isAtributoPreenchido(valorDescontoRateio)) {
			boolean existeDescontoApos = false;
			for (PlanoFinanceiroAlunoDescricaoDescontosVO plano : planoFinanceiroAlunoDescricaoDescontosVOs) {
				if (plano.getReferentePlanoFinanceiroAposVcto() || (!plano.getReferentePlanoFinanceiroAteVencimento() && plano.getDiaNrAntesVencimento().equals(0))) {
					existeDescontoApos = true;
				}
				if (plano.getValorDescontoRateio().equals(0.0)) {
					plano.setValorDescontoRateio(valorDescontoRateio);
					plano.setValorDescontoSemValidade(plano.getValorDescontoSemValidade() + valorDescontoRateio);
				}
			}
			if (!existeDescontoApos) {
				PlanoFinanceiroAlunoDescricaoDescontosVO planoFinanceiroAlunoDescricaoDescontosVO = new PlanoFinanceiroAlunoDescricaoDescontosVO();
				planoFinanceiroAlunoDescricaoDescontosVO.setReferentePlanoFinanceiroAposVcto(true);
				planoFinanceiroAlunoDescricaoDescontosVO.setValorBase(valorBase);
				planoFinanceiroAlunoDescricaoDescontosVO.setValorCusteadoContaReceber(valorCusteadoContaReceber);
				planoFinanceiroAlunoDescricaoDescontosVO.setValorBaseComDescontosJaCalculadosAplicados(Uteis.arrendondarForcando2CadasDecimais(valorBase - valorDescontoRateio));
				planoFinanceiroAlunoDescricaoDescontosVO.setValorParaPagamentoDentroDataLimiteDesconto(Uteis.arrendondarForcando2CadasDecimais(valorBase - valorDescontoRateio));
				planoFinanceiroAlunoDescricaoDescontosVO.setDataInicioAplicacaoDesconto(Uteis.getDataPassada(dataVencimento, 100));
				if (Uteis.isAtributoPreenchido(dataReferenciaConsiderarBaixaTitulo) && dataReferenciaConsiderarBaixaTitulo.compareTo(dataVencimento) >= 0) {
					planoFinanceiroAlunoDescricaoDescontosVO.setDataLimiteAplicacaoDesconto(dataReferenciaConsiderarBaixaTitulo);
				} else {
					planoFinanceiroAlunoDescricaoDescontosVO.setDataLimiteAplicacaoDesconto(dataVencimento);
				}
				planoFinanceiroAlunoDescricaoDescontosVO.setDiaNrAntesVencimento(0);
				planoFinanceiroAlunoDescricaoDescontosVO.setValorDescontoSemValidade(valorDescontoRateio);
				planoFinanceiroAlunoDescricaoDescontosVO.setValorDescontoRateio(valorDescontoRateio);
				planoFinanceiroAlunoDescricaoDescontosVOs.add(planoFinanceiroAlunoDescricaoDescontosVO);
			}
		}
	}

	@Override
	public List<ContaReceberVO> consultarPorMatriculaPeriodoFichaAluno(Integer matriculaPeriodo, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("select codigo, contareceber.updated, matriculaAluno, dataVencimento, parcela, situacao, valor, valorDesconto, valorDescontoProgressivo, descontoInstituicao, valorDescontoRateio, ");
		sb.append(" valorDescontoLancadoRecebimento, descontoconvenio, multa, juro, acrescimo, valorrecebercalculado, nossonumero, matriculaPeriodo, contareceberagrupada, pagoComDCC ");
		sb.append(" from contareceber ");
		sb.append(" where matriculaperiodo = ").append(matriculaPeriodo);
		sb.append(" order by datavencimento, parcela ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<ContaReceberVO> listaContaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(tabelaResultado.getInt("registrocobrancacontareceber"));
			obj.setUpdated(tabelaResultado.getDate("updated"));
			obj.getMatriculaAluno().setMatricula(tabelaResultado.getString("matriculaAluno"));
			obj.setDataVencimento(tabelaResultado.getDate("dataVencimento"));
			obj.setParcela(tabelaResultado.getString("parcela"));
			obj.setSituacao(tabelaResultado.getString("situacao"));
			obj.setValor(tabelaResultado.getDouble("valor"));
			obj.setValorDesconto(tabelaResultado.getDouble("valorDesconto"));
			obj.setValorDescontoProgressivo(tabelaResultado.getDouble("valorDescontoProgressivo"));
			obj.setValorDescontoInstituicao(tabelaResultado.getDouble("descontoInstituicao"));
			obj.setValorDescontoRateio(tabelaResultado.getDouble("valorDescontoRateio"));
			obj.setValorDescontoLancadoRecebimento(tabelaResultado.getDouble("valorDescontoLancadoRecebimento"));
			obj.setValorDescontoConvenio(tabelaResultado.getDouble("descontoConvenio"));
			obj.setMulta(tabelaResultado.getDouble("multa"));
			obj.setJuro(tabelaResultado.getDouble("juro"));
			obj.setAcrescimo(tabelaResultado.getDouble("acrescimo"));
			obj.setValorReceberCalculado(tabelaResultado.getDouble("valorReceberCalculado"));
			obj.setNossoNumero(tabelaResultado.getString("nossoNumero"));
			obj.setMatriculaPeriodo(tabelaResultado.getInt("matriculaPeriodo"));
			obj.setContaReceberAgrupada(tabelaResultado.getInt("contareceberagrupada"));
			obj.setPagoComDCC(tabelaResultado.getBoolean("pagoComDCC"));
			listaContaReceberVOs.add(obj);
		}
		return listaContaReceberVOs;
	}

	public void verificarContasRemetidasQueTiveramAlteracao(Integer matriculaPeriodo, MatriculaVO matricula, List<ContaReceberVO> listaContaRemetida, List<MatriculaPeriodoVencimentoVO> listaMatriculaPeriodoVencimento, List<ControleRemessaContaReceberVO> listaControleRemessaContaReceber, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		try {
			Iterator i = listaContaRemetida.iterator();
			while (i.hasNext()) {
				ContaReceberVO c = (ContaReceberVO) i.next();
				Iterator u = listaControleRemessaContaReceber.iterator();
				while (u.hasNext()) {
					ControleRemessaContaReceberVO crcr = (ControleRemessaContaReceberVO) u.next();
					if (crcr.getNossoNumero().equals(c.getNossoNumero())) {
						Iterator o = listaMatriculaPeriodoVencimento.iterator();
						while (o.hasNext()) {
							MatriculaPeriodoVencimentoVO mpv = (MatriculaPeriodoVencimentoVO) o.next();
							verificarAlteracoesContaRemessa(crcr, mpv.getContaReceber(), configuracaoFinanceiroVO, c);
							if (c.getContaRemetidaComAlteracao()) {
								this.alterarContaReceberRemetidaComAlteracao(mpv.getContaReceber().getCodigo(), c);
								crcr.setMotivoEstorno("Estornado por alteração na tela de matricula!");
								crcr.setSituacaoControleRemessaContaReceber(SituacaoControleRemessaContaReceberEnum.ESTORNADO);
								getFacadeFactory().getControleRemessaContaReceberFacade().realizarEstorno(crcr, usuario);
								continue;
							}
						}
					}
				}
			}
		} catch (Exception e) {
			throw e;
		}
	}

	
	//Foi removido o paramero da MPV pela Conta Receber Existente nela pois o metodo verificarContasRemetidasQueTiveramAlteracao utiliza uma regra que nao entendi Pedro Andrade. 
	public void verificarAlteracoesContaRemessa(ControleRemessaContaReceberVO crcr, ContaReceberVO contaReceberMpv, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, ContaReceberVO c) throws Exception {
		if (crcr.getNossoNumero().equals(contaReceberMpv.getNossoNumero())) {
			// ACHOU A CONTA  
			// Compara Vencimento diferente
			if (UteisData.getCompareData(crcr.getDataVencimento(),contaReceberMpv.getDataVencimento()) != 0) {
				c.setContaRemetidaComAlteracao(Boolean.TRUE);
				c.setContaRemetidaComAlteracao_dataVencimento(Boolean.TRUE);
			}
			if (configuracaoFinanceiroVO.getVencimentoParcelaDiaUtil()) {
				Date dataVencimento = getFacadeFactory().getContaReceberFacade().obterDataVerificandoDiaUtil(contaReceberMpv.getDataVencimento(), c.getUnidadeEnsinoFinanceira().getCidade().getCodigo(), null);
				if (UteisData.getCompareData(crcr.getDataVencimento(),dataVencimento) != 0) {
					c.setContaRemetidaComAlteracao(Boolean.TRUE);
					c.setContaRemetidaComAlteracao_dataVencimento(Boolean.TRUE);
				}
			}
			// Compara Valor Base
			if (Uteis.arrendondarForcando2CasasDecimais(crcr.getValorBase()) != Uteis.arrendondarForcando2CasasDecimais(contaReceberMpv.getValorBaseContaReceber())) {
				c.setContaRemetidaComAlteracao(Boolean.TRUE);
				c.setContaRemetidaComAlteracao_valorBase(Boolean.TRUE);
			}
			
			executarCalculoValorDiferencaContaDescontos(contaReceberMpv, configuracaoFinanceiroVO);
			// Compara Valor representa o valor a pagar da conta.

			if (crcr.getValorComAcrescimo().compareTo(Uteis.arrendondarForcando2CasasDecimais(contaReceberMpv.getValor() + contaReceberMpv.getAcrescimo())) != 0) {
				
			    c.setContaRemetidaComAlteracao(Boolean.TRUE);
				if (crcr.getValorDescontoDataLimite().doubleValue() > 0 && contaReceberMpv.getValorDescontoSemValidade().doubleValue() == 0) {
					c.setContaRemetidaComAlteracao_valorComAbatimentoRemovido(Boolean.TRUE);
				} else {
					c.setContaRemetidaComAlteracao_valorComAbatimentoAdicionadoOuModificado(Boolean.TRUE);
				}
			}
				// Compara Descontos
			if (crcr.getValorDescontoDataLimite().compareTo(Uteis.arrendondarForcando2CasasDecimais(contaReceberMpv.getValor() - contaReceberMpv.getValorDescontoCalculadoPrimeiraFaixaDescontos())) != 0) {
				c.setContaRemetidaComAlteracao(Boolean.TRUE);
				c.setContaRemetidaComAlteracao_valorDescProgressivo(Boolean.TRUE);
			}
			if (crcr.getValorDescontoDataLimite2().compareTo(Uteis.arrendondarForcando2CasasDecimais(contaReceberMpv.getValor() - contaReceberMpv.getValorDescontoCalculadoSegundaFaixaDescontos())) != 0) {
				c.setContaRemetidaComAlteracao(Boolean.TRUE);
				c.setContaRemetidaComAlteracao_valorDescProgressivo(Boolean.TRUE);
			}
			if (crcr.getValorDescontoDataLimite3().compareTo(Uteis.arrendondarForcando2CasasDecimais(contaReceberMpv.getValor() - contaReceberMpv.getValorDescontoCalculadoTerceiraFaixaDescontos())) != 0) {
				c.setContaRemetidaComAlteracao(Boolean.TRUE);
				c.setContaRemetidaComAlteracao_valorDescProgressivo(Boolean.TRUE);
			}
			
			// compara data desc progressivo
			if (crcr.getDataLimiteConcessaoDesconto() != null && Uteis.isAtributoPreenchido(contaReceberMpv.getDataLimitePrimeiraFaixaDescontos()) &&  UteisData.getCompareData(crcr.getDataLimiteConcessaoDesconto(),contaReceberMpv.getDataLimitePrimeiraFaixaDescontos()) != 0) {
				c.setContaRemetidaComAlteracao(Boolean.TRUE);
				c.setContaRemetidaComAlteracao_dataVencimento(Boolean.TRUE);
			}
			
			if (crcr.getDataLimiteConcessaoDesconto2() != null && Uteis.isAtributoPreenchido(contaReceberMpv.getDataLimiteSegundaFaixaDescontos()) && UteisData.getCompareData(crcr.getDataLimiteConcessaoDesconto2() ,contaReceberMpv.getDataLimiteSegundaFaixaDescontos()) != 0) {
				c.setContaRemetidaComAlteracao(Boolean.TRUE);
				c.setContaRemetidaComAlteracao_dataVencimento(Boolean.TRUE);
			}
			
			if (crcr.getDataLimiteConcessaoDesconto3() != null && Uteis.isAtributoPreenchido(contaReceberMpv.getDataLimiteTerceiraFaixaDescontos()) && UteisData.getCompareData(crcr.getDataLimiteConcessaoDesconto3() ,contaReceberMpv.getDataLimiteTerceiraFaixaDescontos()) != 0) {
				c.setContaRemetidaComAlteracao(Boolean.TRUE);
				c.setContaRemetidaComAlteracao_dataVencimento(Boolean.TRUE);
			}
		}
	}

	public boolean verificarAlteracoesContaParaGeracaoNossoNumero(ContaReceberVO nncc, ContaReceberVO contareceberVO, MatriculaVO matricula) throws Exception {
		// nncc é o obtejo referente a NossoNumeroContaReceber
		// contareceberVO é o objeto recem criado que será salvo.
		// Compara Valor Base
		if (Uteis.arrendondarForcando2CasasDecimais(nncc.getValorBaseContaReceber()) != Uteis.arrendondarForcando2CasasDecimais(contareceberVO.getValorBaseContaReceber())) {
			return true;
		}
		executarCalculoValorDiferencaContaDescontos(contareceberVO,  contareceberVO.getConfiguracaoFinanceiro());
		// Compara Valor representa o valor a pagar da conta.
		Double j = Uteis.arrendondarForcando2CasasDecimais(nncc.getValor() - nncc.getValorDescontoSemValidade() + nncc.getAcrescimo());
		Double b = Uteis.arrendondarForcando2CasasDecimais(contareceberVO.getValor() - contareceberVO.getValorDescontoSemValidade() + contareceberVO.getAcrescimo());
		if (j.compareTo(b) != 0) {
			return true;
		}
		// Compara Descontos
		if (nncc.getValorDescontoCalculadoPrimeiraFaixaDescontos().compareTo(contareceberVO.getValorDescontoCalculadoPrimeiraFaixaDescontos()) != 0) {
			return true;
		}
		if (nncc.getValorDescontoCalculadoSegundaFaixaDescontos().compareTo(contareceberVO.getValorDescontoCalculadoSegundaFaixaDescontos()) != 0) {
			return true;
		}
		if (nncc.getValorDescontoCalculadoTerceiraFaixaDescontos().compareTo(contareceberVO.getValorDescontoCalculadoTerceiraFaixaDescontos()) != 0) {
			return true;
		}
		if (nncc.getValorDescontoCalculadoQuartaFaixaDescontos().compareTo(contareceberVO.getValorDescontoCalculadoQuartaFaixaDescontos()) != 0) {
			return true;
		}
		if (UteisData.getCompareData(nncc.getDataVencimento(), contareceberVO.getDataVencimento()) != 0) {
			return true;
		}
		if (contareceberVO.getDataLimitePrimeiraFaixaDescontos() != null && 
				nncc.getDataLimitePrimeiraFaixaDescontos() != null && 
						UteisData.getCompareData(nncc.getDataLimitePrimeiraFaixaDescontos(), contareceberVO.getDataLimitePrimeiraFaixaDescontos()) != 0) {
			return true;
		}
		if (contareceberVO.getDataLimiteSegundaFaixaDescontos() != null && 
				nncc.getDataLimiteSegundaFaixaDescontos() != null && 
				UteisData.getCompareData(nncc.getDataLimiteSegundaFaixaDescontos(), contareceberVO.getDataLimiteSegundaFaixaDescontos()) != 0) {				
			return true;
		}
		if (contareceberVO.getDataLimiteTerceiraFaixaDescontos() != null && 
				nncc.getDataLimiteTerceiraFaixaDescontos() != null && 
				UteisData.getCompareData(nncc.getDataLimiteTerceiraFaixaDescontos(), contareceberVO.getDataLimiteTerceiraFaixaDescontos()) != 0) {			
			return true;
		}
		if (contareceberVO.getDataLimiteQuartaFaixaDescontos() != null && 
				nncc.getDataLimiteQuartaFaixaDescontos() != null && 				
			UteisData.getCompareData(nncc.getDataLimiteQuartaFaixaDescontos(), contareceberVO.getDataLimiteQuartaFaixaDescontos()) != 0) {	
			return true;
		}
		
		if(contareceberVO.getContaCorrente().compareTo(nncc.getContaCorrenteVO().getCodigo())!=0) {
			return true ;
			
		}
		
		return false;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizaVinculoContaReceberComControleRemessaContaReceber(List<MatriculaPeriodoVencimentoVO> listaMatriculaPeriodoVencimento, UsuarioVO usuario) throws Exception {
		try {
			Iterator o = listaMatriculaPeriodoVencimento.iterator();
			while (o.hasNext()) {
				MatriculaPeriodoVencimentoVO mpv = (MatriculaPeriodoVencimentoVO) o.next();
				getFacadeFactory().getControleRemessaContaReceberFacade().realizaVinculoContaReceber(mpv.getContaReceber().getCodigo(), mpv.getContaReceber().getNossoNumero(), usuario);
			}
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void executarCalculoValorDiferencaContaDescontos(ContaReceberVO contaReceberVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		boolean eMatricula = realizarVerificacaoTipoOrigemContaReceber(contaReceberVO.getTipoOrigem());
		// GERA OS DESCONTOS SEPARANDO OS DESCONTOS COM VALIDADE E SEM VALIDADE
		Date dataVencimentoOriginal = contaReceberVO.getDataVencimento();
		Date dataVencimentoDiaUtil = contaReceberVO.getDataVencimento();
		if (configuracaoFinanceiroVO.getVencimentoParcelaDiaUtil()) {
			dataVencimentoDiaUtil = getFacadeFactory().getContaReceberFacade().obterDataVerificandoDiaUtil(dataVencimentoOriginal, contaReceberVO.getUnidadeEnsino().getCidade().getCodigo(), null);
		}
		Boolean aplicarCalculoComBaseDescontosCalculados = getFacadeFactory().getCondicaoPagamentoPlanoFinanceiroCursoFacade().consultarAplicarCalculoComBaseDescontosCalculadosPorContaReceber(contaReceberVO.getCodigo(), null);
		List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaPlanoFinanceiroAlunoDescricaoDescontos = executarGeracaoDescontosAplicaveisPlanoFinanceiroAluno(eMatricula,
				contaReceberVO.getValor(), contaReceberVO.getTipoDesconto(), contaReceberVO.getValorDesconto(), contaReceberVO.getValorDesconto(), contaReceberVO.getDescontoAlunoValidoAteVencimento(),
				dataVencimentoDiaUtil, dataVencimentoOriginal, contaReceberVO.obterOrdemAplicacaoDescontosPadraoAtual(), contaReceberVO.getDescontoProgressivo(), contaReceberVO.getListaPlanoDescontoInstitucionalVOs(), contaReceberVO.getListaConvenioVOs(), 0,
				contaReceberVO.getUsaDescontoCompostoPlanoDesconto(), configuracaoFinanceiroVO, false, null, "", aplicarCalculoComBaseDescontosCalculados, contaReceberVO.getUnidadeEnsino().getCidade().getCodigo());
		adicionarDescontoRateioEmPlanoFinanceiroAlunoDescricaoDescontosVO(listaPlanoFinanceiroAlunoDescricaoDescontos, contaReceberVO.getValorBaseContaReceber(), contaReceberVO.getValorCusteadoContaReceber(), contaReceberVO.getValorDescontoRateio(), contaReceberVO.getDataVencimento(), contaReceberVO.getDataVencimento());
		if (listaPlanoFinanceiroAlunoDescricaoDescontos.size() > 0) {
			PlanoFinanceiroAlunoDescricaoDescontosVO planoFinanceiroAlunoDescontoVO = null;
			planoFinanceiroAlunoDescontoVO = (PlanoFinanceiroAlunoDescricaoDescontosVO) listaPlanoFinanceiroAlunoDescricaoDescontos.get(0);
			contaReceberVO.setValorDescontoSemValidade(planoFinanceiroAlunoDescontoVO.getValorDescontoSemValidade());
			contaReceberVO.setValorDescontoDataLimite(planoFinanceiroAlunoDescontoVO.getValorDescontoComValidade());
		}

	}

	public List<ContaReceberVO> consultaContasAReceberQuePossuiRemessaGerada(Integer matriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaCompletaSemContaReceberRecebimentoDistinct();
		sqlStr.append("inner join controleremessacontareceber crcr on contareceber.codigo = crcr.contareceber ");
		sqlStr.append("WHERE contareceber.matriculaperiodo = ");
		sqlStr.append(matriculaPeriodo);
		sqlStr.append(" ");
		sqlStr.append(" AND contareceber.situacao = 'AR'  AND  contareceber.tipoorigem in ('MAT', 'MEN', 'MDI','BCC' ) ");
		sqlStr.append(" and crcr.situacao <> 'ESTORNADO_PELO_USUARIO' ");
		sqlStr.append(" ORDER BY contareceber.dataVencimento");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaCompletaSemRecebimento(resultado, configuracaoFinanceiroVO, nivelMontarDados, usuario);
	}

	@Override
	public List<ContaReceberVO> consultarPorMatriculaTipoOrigemSituacaoMesAnoFichaAluno(String matricula, TipoOrigemContaReceber tipoOrigemContaReceber, SituacaoContaReceber situacaoContaReceber, String mesAno, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("select codigo, contareceber.updated,  matriculaAluno, dataVencimento, parcela, situacao, valor, valorDesconto, valorDescontoProgressivo, descontoInstituicao, valorDescontoRateio, ");
		sb.append(" valorDescontoLancadoRecebimento, descontoconvenio, multa, juro, acrescimo, valorrecebercalculado, valorrecebido, nossonumero, matriculaPeriodo, contareceberagrupada, pagoComDCC, tipoOrigem, ");
		sb.append(" valorDescontoLancadoRecebimento, valorDescontoalunojacalculado, contacorrente, valorCalculadoDescontoLancadoRecebimento, agente.agenteNegativacao, agente.agenteCobranca ");
		sb.append(" from contareceber ");
		sb.append(" left join lateral (select r.contareceber, array_to_string(array_agg(case when r2.tipoAgente = 'NEGATIVACAO' then a.nome end), ', ') as agenteNegativacao,array_to_string(array_agg(case when r2.tipoAgente = 'COBRANCA' then a.nome end), ', ') as agenteCobranca ");
		sb.append(" from registronegativacaocobrancacontareceberitem r inner join registronegativacaocobrancacontareceber r2 on r2.codigo = r.registronegativacaocobrancacontareceber inner join agentenegativacaocobrancacontareceber a on a.codigo = r2.agente ");
		sb.append(" where r.contareceber = contareceber.codigo and r.dataexclusao is null group by r.contareceber) as agente on  agente.contareceber = contareceber.codigo ");
		sb.append(" where contaReceber.matriculaAluno = '").append(matricula).append("' ");
		if (tipoOrigemContaReceber != null) {
			sb.append(" and contaReceber.tipoOrigem = '").append(tipoOrigemContaReceber.getValor()).append("' ");
		}
		if (situacaoContaReceber != null) {
			sb.append(" and contaReceber.situacao = '").append(situacaoContaReceber.getValor()).append("' ");
		}
		if (mesAno != null && !mesAno.equals("")) {
			sb.append(" and extract(month from contaReceber.dataVencimento) = ").append(getMesDataVencimentoContaReceber(mesAno));
			sb.append(" and extract(year from contaReceber.dataVencimento) = ").append(getAnoDataVencimentoContaReceber(mesAno));
		}
		sb.append(" order by datavencimento desc, parcela desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		boolean possuiPermissaoEmitirBoletoVencido = ControleAcesso.verificarPermissaoFuncionalidadeUsuario("ImprimirBoletoVencidoVisaoAluno", usuarioVO);
		List<ContaReceberVO> listaContaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			// obj.getRegistroNegativacaoCobrancaContaReceber().setCodigo(tabelaResultado.getInt("registrocobrancacontareceber"));
			obj.setUpdated(tabelaResultado.getDate("updated"));
			obj.getMatriculaAluno().setMatricula(tabelaResultado.getString("matriculaAluno"));
			obj.setDataVencimento(tabelaResultado.getDate("dataVencimento"));
			obj.setParcela(tabelaResultado.getString("parcela"));
			obj.setSituacao(tabelaResultado.getString("situacao"));
			obj.setValor(tabelaResultado.getDouble("valor"));
			obj.setValorRecebido(tabelaResultado.getDouble("valorrecebido"));
			obj.setValorDesconto(tabelaResultado.getDouble("valorDesconto"));
			obj.setValorDescontoProgressivo(tabelaResultado.getDouble("valorDescontoProgressivo"));
			obj.setValorDescontoInstituicao(tabelaResultado.getDouble("descontoInstituicao"));
			obj.setValorDescontoRateio(tabelaResultado.getDouble("valorDescontoRateio"));
			obj.setValorDescontoLancadoRecebimento(tabelaResultado.getDouble("valorDescontoLancadoRecebimento"));
			obj.setValorDescontoConvenio(tabelaResultado.getDouble("descontoConvenio"));
			obj.setMulta(tabelaResultado.getDouble("multa"));
			obj.setJuro(tabelaResultado.getDouble("juro"));
			obj.setAcrescimo(tabelaResultado.getDouble("acrescimo"));
			obj.setValorReceberCalculado(tabelaResultado.getDouble("valorReceberCalculado"));
			obj.setNossoNumero(tabelaResultado.getString("nossoNumero"));
			obj.setMatriculaPeriodo(tabelaResultado.getInt("matriculaPeriodo"));
			obj.setContaReceberAgrupada(tabelaResultado.getInt("contareceberagrupada"));
			obj.setPagoComDCC(tabelaResultado.getBoolean("pagoComDCC"));
			obj.setTipoOrigem(tabelaResultado.getString("tipoOrigem"));
			obj.setValorDescontoLancadoRecebimento(tabelaResultado.getDouble("valorDescontoLancadoRecebimento"));
			obj.setValorDescontoAlunoJaCalculado(tabelaResultado.getDouble("valorDescontoalunojacalculado"));
			obj.setContaCorrente(tabelaResultado.getInt("contacorrente"));
			obj.setAgenteNegativacao(tabelaResultado.getString("agenteNegativacao"));
			obj.setAgenteCobranca(tabelaResultado.getString("agentecobranca"));
			obj.setDetalhamentoValorContaVOs(getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().consultaRapidaPorOrigemCodigoOrigemConta(OrigemDetalhamentoContaEnum.CONTA_RECEBER, obj.getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO));
			if (Uteis.isAtributoPreenchido(obj.getContaCorrente())) {
				obj.setContaCorrenteVO(getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(obj.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO));
			}
			obj.setEmissaoBloqueada(verificaBloqueioEmissaoBoleto(obj, usuarioVO));
			validarTipoImpressaoPorContaReceber(obj, possuiPermissaoEmitirBoletoVencido, usuarioVO);
			listaContaReceberVOs.add(obj);
		}
		return listaContaReceberVOs;
	}

	public Integer getMesDataVencimentoContaReceber(String mesAno) {
		if (mesAno != null && !mesAno.equals("")) {
			String mes = mesAno.substring(0, mesAno.indexOf("/"));
			return Uteis.getMesConcatenadoReferencia(mes);
		}
		return 0;
	}

	public Integer getAnoDataVencimentoContaReceber(String mesAno) {
		if (mesAno != null && !mesAno.equals("")) {
			String ano = mesAno.substring(mesAno.indexOf("/") + 1);
			return Integer.parseInt(ano);
		}
		return 0;
	}

	public List<ContaReceberVO> consultaRapidaPorPeriodo(int unidadeEnsino, Date dataInicio, Date dataFim, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" WHERE (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		if (unidadeEnsino != 0) {
			sql.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sql.append(" ORDER BY contareceber.datavencimento, contareceber.dataCompetencia, contareceber.matriculaaluno");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosConsultaBasica(resultado);
	}

	@Override
	public List<SelectItem> consultarMesAnoContaReceberPorAluno(Integer aluno, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("select mes ||'/'|| ano AS mesAno from (");
		sb.append(" select distinct case ");
		sb.append(" when extract(month from datavencimento) = 1 then 'JAN' ");
		sb.append(" when extract(month from datavencimento) = 2 then 'FEV' ");
		sb.append(" when extract(month from datavencimento) = 3 then 'MAR' ");
		sb.append(" when extract(month from datavencimento) = 4 then 'ABR' ");
		sb.append(" when extract(month from datavencimento) = 5 then 'MAI' ");
		sb.append(" when extract(month from datavencimento) = 6 then 'JUN' ");
		sb.append(" when extract(month from datavencimento) = 7 then 'JUL' ");
		sb.append(" when extract(month from datavencimento) = 8 then 'AGO' ");
		sb.append(" when extract(month from datavencimento) = 9 then 'SET' ");
		sb.append(" when extract(month from datavencimento) = 10 then 'OUT' ");
		sb.append(" when extract(month from datavencimento) = 11 then 'NOV' ");
		sb.append(" when extract(month from datavencimento) = 12 then 'DEZ' ");
		sb.append(" end AS mes, extract(year from datavencimento) AS ano, extract(month from datavencimento) AS numero_mes ");
		sb.append(" from contareceber ");
		sb.append(" inner join matricula on matricula.matricula = contaReceber.matriculaAluno ");
		sb.append(" where contaReceber.pessoa = ").append(aluno);
		sb.append(" ) as t order by ano desc, numero_mes desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<SelectItem> listaSelectItemMesAnoContaReceberVOs = new ArrayList<SelectItem>(0);
		listaSelectItemMesAnoContaReceberVOs.add(new SelectItem("", ""));
		while (tabelaResultado.next()) {
			listaSelectItemMesAnoContaReceberVOs.add(new SelectItem(tabelaResultado.getString("mesAno"), tabelaResultado.getString("mesAno")));
		}
		return listaSelectItemMesAnoContaReceberVOs;
	}

	@Override
	public Boolean verificarExistenciaDeContaParaResponsavelFinanceiroDiferenteDoAtual(PessoaVO pessoa) throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append(" select contareceber.codigo from contareceber ");
		sql.append("	left join notafiscalsaidaservico on notafiscalsaidaservico.codigo = contareceber.notafiscalsaidaservico ");
		sql.append("	left join notafiscalsaida on notafiscalsaida.codigo = notafiscalsaidaservico.notafiscalsaida ");
		sql.append("	inner join matricula on matricula.matricula = contareceber.matriculaaluno ");
		sql.append("	inner join filiacao on filiacao.aluno = contareceber.pessoa ");
		sql.append(" 	and filiacao.responsavelfinanceiro ");
		sql.append(" where contareceber.responsavelfinanceiro <> filiacao.pais ");
		sql.append(" and contareceber.pessoa = ").append(pessoa.getCodigo());
		sql.append(" and case when contareceber.notafiscalsaidaservico is not null then notafiscalsaida.situacao <> 'AU' else true end ");
		sql.append(" limit 1");

		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		while (rs.next()) {
			return true;
		}
		return false;
	}

	public void validarTipoImpressao(List<ContaReceberVO> contaReceberVOs, UsuarioVO usuarioVO) throws Exception {

		Boolean possuiPermissaoEmitirBoletoVencido = ControleAcesso.verificarPermissaoFuncionalidadeUsuario("ImprimirBoletoVencidoVisaoAluno", usuarioVO);
		for (ContaReceberVO contaReceberVO : contaReceberVOs) {
			validarTipoImpressaoPorContaReceber(contaReceberVO, possuiPermissaoEmitirBoletoVencido, usuarioVO);
		}
	}

	@Override
	public void validarTipoImpressaoPorContaReceber(ContaReceberVO contaReceberVO, Boolean possuiPermissaoEmitirBoletoVencido, UsuarioVO usuarioVO) throws Exception {
		Date dataConsiderar = contaReceberVO.getDataVencimento();
		if (Uteis.nrDiasEntreDatas(dataConsiderar, new Date()) < 0) {
			contaReceberVO.setContaVencida(true);
		}
		if (!Uteis.isAtributoPreenchido(contaReceberVO.getProcessamentoIntegracaoFinanceiraDetalheVO())) {
			ConfiguracaoFinanceiroVO configuracaoFinanceiroVO = getConfiguracaoFinanceiroPrevilegiandoUnidadeEnsino(contaReceberVO.getUnidadeEnsino().getCodigo(), usuarioVO);
			if (configuracaoFinanceiroVO.getVencimentoParcelaDiaUtil()) {
				Date dataDiaUtil = getFacadeFactory().getContaReceberFacade().obterDataVerificandoDiaUtil(dataConsiderar, contaReceberVO.getUnidadeEnsino().getCidade().getCodigo(), null);
				if (UteisData.getCompareData(dataDiaUtil, new Date()) >= 0) {
					contaReceberVO.setContaVencida(false);
				}
			}
		}
		contaReceberVO.setPermiteImprimirBoleto(false);
		contaReceberVO.setPermiteImprimirBoletoLinkBanco(false);
		
		if (!permiteEmitirBoletoAlunoVinculadoParceiro(contaReceberVO.getCodigo())) {
			return;
		}
		if (contaReceberVO.getContaCorrenteVO().getBloquearEmissaoBoleto() || contaReceberVO.getPagoComDCC() || contaReceberVO.getEmissaoBloqueada()) {
			return;

		} else if (contaReceberVO.getSituacaoAReceber() && (contaReceberVO.isHabilitarBotaoRecebimentoVisaoAluno() || contaReceberVO.isHabilitarBotaoRecebimento()) && !contaReceberVO.getHabilitarBotaoLinkBanco()
				&& (!usuarioVO.getIsApresentarVisaoAluno() || (usuarioVO.getIsApresentarVisaoAluno() && ((possuiPermissaoEmitirBoletoVencido && contaReceberVO.getContaVencida()) || !contaReceberVO.getContaVencida())))) {
			contaReceberVO.setPermiteImprimirBoleto(true);
			return;

		} else if (contaReceberVO.getSituacaoAReceber() && contaReceberVO.getHabilitarBotaoLinkBanco() && (!usuarioVO.getIsApresentarVisaoAluno() || (usuarioVO.getIsApresentarVisaoAluno() && ((possuiPermissaoEmitirBoletoVencido && contaReceberVO.getContaVencida()) || !contaReceberVO.getContaVencida())))) {
			contaReceberVO.setPermiteImprimirBoletoLinkBanco(true);
		}
	}

	@Override
	public ContaReceberVO consultarPorContaReceberRecebimento(Integer contaReceberRecebimento, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("select contareceber from contareceberrecebimento where codigo = ").append(contaReceberRecebimento);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		ContaReceberVO obj = new ContaReceberVO();
		if (tabelaResultado.next()) {
			obj.setCodigo(tabelaResultado.getInt("contaReceber"));
		}
		return obj;

	}
	@Override
	public ContaReceberVO consultarContaReceberPorFormaPagamentoRecebimentoCartaoCredito(Integer formaPagamentoRecebimentoCartaoCredito, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sql = getSQLPadraoConsultaBasica();
		sql.append(" inner join contareceberrecebimento on contareceber.codigo = contareceberrecebimento.contareceber ");
		sql.append(" inner join formapagamentonegociacaorecebimento on contareceberrecebimento.formapagamentonegociacaorecebimento = formapagamentonegociacaorecebimento.codigo");
		sql.append(" where formapagamentonegociacaorecebimento.formapagamentonegociacaorecebimentocartaocredito = ").append(formaPagamentoRecebimentoCartaoCredito).append("  ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		ContaReceberVO obj = new ContaReceberVO();
		montarDadosBasico(obj, tabelaResultado);
		return obj;
			
	}

	@Override
	@Transactional(readOnly = false, rollbackFor = { Throwable.class }, propagation = Propagation.SUPPORTS)
	public StringBuilder getSQLPadraoConsultaProcessamentoArquivoRetornoParceiro() {
		StringBuilder sb = new StringBuilder();
		sb.append(" SELECT contareceber.codigo, contareceber.impressaoBoletoRealizada, contareceber.tipopessoa, contareceber.nrdocumento, contareceber.nossonumero, contareceber.nossonumerobanco, contareceber.pessoa, contareceber.notafiscalsaidaservico, pessoamatricula.nome AS \"Aluno.nome\", pessoa.nome AS \"Pessoa.nome\", pessoamatricula.cpf AS \"Pessoa.cpf\", pessoamatricula.email AS \"Pessoa.email\", contareceber.parcela, contareceber.contacorrente, cc.carteiraregistrada AS \"contacorrente.carteiraregistrada\", contareceber.codorigem, ");
		sb.append(" contareceber.codigobarra, contareceber.linhadigitavelcodigobarras, contareceber.descontoProgressivo, contareceber.turma, contareceber.duplicidadeTratada, contareceber.descontoconvenio, contareceber.descontoinstituicao, contareceber.valordescontoprogressivo,  ");
		sb.append(" contareceber.valor, contareceber.valorBaseContaReceber, contareceber.valorRecebido, contareceber.juro, contareceber.multa, contareceber.acrescimo, contareceber.dataVencimento, contareceber.dataCompetencia, contareceber.dataProcessamentoValorReceber, contareceber.situacao, contareceber.multaporcentagem, contareceber.juroporcentagem, contareceber.tipoorigem, ");
		sb.append(" contareceber.valorDesconto, contareceber.tipoDesconto, contareceber.valordescontolancadorecebimento, contareceber.valorcalculadodescontolancadorecebimento, contareceber.tipodescontolancadorecebimento, contareceber.valorDescontoAlunoJaCalculado, contareceber.updated, contareceber.usaDescontoCompostoPlanoDesconto, ");
		sb.append(" contareceber.ordemConvenio, contareceber.OrdemConvenioValorCheio, contareceber.OrdemDescontoAluno, contareceber.matriculaperiodo, contaReceber.valorDescontoCalculado, contaReceber.valorReceberCalculado, contareceber.valorDescontoRateio,  ");
		sb.append(" contareceber.OrdemDescontoAlunoValorCheio, contareceber.OrdemDescontoProgressivo, contareceber.OrdemDescontoProgressivoValorCheio, ");
		sb.append(" contareceber.possuiPendenciasFinanceirasExternas, contareceber.possuiFiesIntegracaoFinanceiras, contareceber.OrdemPlanoDesconto, contareceber.OrdemPlanoDescontoValorCheio, contareceber.responsavelFinanceiro, contareceber.contareceberagrupada, ");
		sb.append(" contareceber.valorIndiceReajustePorAtraso, contareceber.liberadoDoIndiceReajustePorAtraso, contareceber.possuiFiesIntegracaoFinanceiras, contareceber.valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa, ");
		sb.append(" indicereajuste.codigo as \"indicereajuste.codigo\" , indicereajuste.descricao as \"indicereajuste.descricao\", ");
		
		sb.append(" matricula.matricula AS \"Matricula.matricula\", funcionario.codigo AS \"Funcionario.codigo\", funcionario.matricula AS \"Funcionario.matricula\", pessoafuncionario.nome AS \"Funcionario.nome\", pessoafuncionario.codigo AS \"Funcionario.codigo\", ");
		
		sb.append(" unidadeEnsino.codigo AS \"UnidadeEnsino.codigo\",  unidadeEnsino.nome AS \"UnidadeEnsino.nome\",  ");
		
		sb.append(" unidadeensinofinanceira.codigo AS \"unidadeensinofinanceira.codigo\", unidadeensinofinanceira.nome As \"unidadeensinofinanceira.nome\", ");
		
		sb.append(" pessoacandidato.nome AS \"Candidato.nome\", pessoacandidato.codigo AS \"Candidato.codigo\", pessoacandidato.cpf AS \"Candidato.cpf\", parceiro.nome AS \"Parceiro.nome\", parceiro.cnpj AS \"Parceiro.cnpj\", parceiro.cpf AS \"Parceiro.cpf\", parceiro.codigo AS \"Parceiro.codigo\", Parceiro.isentarJuro as \"Parceiro.isentarJuro\", Parceiro.isentarMulta as \"Parceiro.isentarMulta\", ");
		
		sb.append(" responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", responsavelFinanceiro.cpf as \"responsavelFinanceiro.cpf\", responsavelFinanceiro.email as \"responsavelFinanceiro.email\", ");
		
		sb.append(" turma.identificadorturma, fornecedor.codigo as \"fornecedor.codigo\", fornecedor.nome as \"fornecedor.nome\", fornecedor.rg as \"fornecedor.rg\", ");
		
		sb.append(" fornecedor.cpf as \"fornecedor.cpf\", fornecedor.cnpj as \"fornecedor.cnpj\", fornecedor.tipoEmpresa as \"fornecedor.tipoEmpresa\", pessoamatricula.codigo as \"pessoamatricula.codigo\", ");
		
		sb.append(" contareceber.pagocomdcc, contareceber.liberadoDoIndiceReajustePorAtraso, contareceber.contaEditadaManualmente, contareceber.utilizarDescontoProgressivoManual, ");
		sb.append(" case when contareceber.tipoorigem in ('MAT', 'MEN') then matricula.bloquearEmissaoBoletoMatMenVisaoAluno else false end as \"Matricula.bloquearEmissaoBoletoMatMenVisaoAluno\", ");
		
		sb.append(" CentroReceita.codigo as \"CentroReceita.codigo\", CentroReceita.descricao as \"CentroReceita.descricao\", contareceber.processamentointegracaofinanceiradetalhe ");
		sb.append(" FROM contareceber ");
		sb.append(" inner JOIN convenio ON (convenio.codigo = contareceber.convenio) ");
		sb.append(" inner JOIN parceiro on parceiro.codigo = convenio.parceiro ");
		sb.append(" LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) ");
		sb.append(" LEFT JOIN pessoa AS pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sb.append(" LEFT JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) ");
		sb.append(" LEFT JOIN pessoa AS pessoamatricula ON (matricula.aluno = pessoamatricula.codigo) ");
		sb.append(" LEFT JOIN pessoa AS pessoacandidato ON (contareceber.candidato = pessoacandidato.codigo) ");
		sb.append(" LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo) ");
		sb.append(" LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sb.append(" LEFT JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sb.append(" LEFT JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sb.append(" LEFT JOIN centroreceita ON (centroreceita.codigo = contareceber.centroreceita) ");
		sb.append(" LEFT JOIN turma ON (turma.codigo = contareceber.turma) ");
		sb.append(" LEFT JOIN fornecedor ON (fornecedor.codigo = contareceber.fornecedor) ");
		sb.append(" LEFT JOIN contacorrente cc ON (contareceber.contacorrente = cc.codigo) ");
		sb.append(" LEFT JOIN indicereajuste ON (contareceber.indiceReajustePadraoPorAtraso = indicereajuste.codigo) ");
		return sb;
	}

	@Override
	@Transactional(readOnly = false, rollbackFor = { Throwable.class }, propagation = Propagation.SUPPORTS)
	public ContaReceberVO consultarContaReceberProcessamentoArquivoParceiroExcel(ProcessamentoArquivoRetornoParceiroExcelVO processamentoExcelVO, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = getSQLPadraoConsultaProcessamentoArquivoRetornoParceiro();
		sb.append(" where contareceber.tipoorigem  = 'BCC' ");
		sb.append(" and parceiro.codigo = ").append(processamentoExcelVO.getProcessamentoArquivoRetornoParceiroAlunoVO().getProcessamentoArquivoRetornoParceiroVO().getParceiroVO().getCodigo());
		sb.append(" and unidadeensino.codigo = ").append(processamentoExcelVO.getProcessamentoArquivoRetornoParceiroAlunoVO().getProcessamentoArquivoRetornoParceiroVO().getUnidadeEnsinoVO().getCodigo());
		sb.append(" and pessoamatricula.cpf = '").append(processamentoExcelVO.getProcessamentoArquivoRetornoParceiroAlunoVO().getCpf()).append("' ");
		sb.append(" and extract(month from contareceber.datacompetencia) = ").append(UteisData.getMesData(processamentoExcelVO.getDataCompetencia()));
		sb.append(" and extract(year from contareceber.datacompetencia) = ").append(UteisData.getAnoData(processamentoExcelVO.getDataCompetencia()));
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		ContaReceberVO obj = new ContaReceberVO();
		if (tabelaResultado.next()) {
			montarDadosBasico(obj, tabelaResultado);
		}
		return obj;

	}

	public boolean verificaBloqueioEmissaoBoleto(ContaReceberVO obj, UsuarioVO usuario) {
		boolean habilitar = false;
		// verifica registro de cobrança
		if (Uteis.isAtributoPreenchido(obj.getPossuiRegistroNegativacao()) && obj.getPossuiRegistroNegativacao()) {
			return true;
		}
		if (obj.getContaCorrenteVO().getControlarBloqueioEmissaoBoleto().booleanValue()) {
			if (obj.getContaCorrenteVO().getBloquearEmissaoBoletoFeriado().booleanValue()) {
				UnidadeEnsinoVO unidade = obj.getUnidadeEnsino();
				// verifica feriado
				try {
					if (unidade.getCodigo().intValue() > 0) {
						unidade = (getAplicacaoControle().getUnidadeEnsinoVO(unidade.getCodigo(), usuario));						
					}
					List<FeriadoVO> lista = getFacadeFactory().getFeriadoFacade().consultaDiasFeriadoNoPeriodo(new Date(), new Date(), unidade.getCidade().getCodigo(), ConsiderarFeriadoEnum.FINANCEIRO, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
					habilitar = UteisData.isFeriadoFinanceiro(new Date(), lista);
					if (habilitar) {
						return true;
					} else {
						habilitar = false;
					}
				} catch (Exception e) {
					return false;
				}
			}
			if (obj.getContaCorrenteVO().getBloquearEmissaoBoletoFimDeSemana().booleanValue()) {
				// verificar final de semana
				habilitar = UteisData.isDiaDaSemana(new Date(), false, false);
				if (!habilitar) {
					return true;
				} else {
					habilitar = false;
				}
			}
			if (!obj.getContaCorrenteVO().getBloquearEmissaoBoletoHoraIni().equals("") && !obj.getContaCorrenteVO().getBloquearEmissaoBoletoHoraFim().equals("")) {
				try { 
					Date dataIni = Uteis.obterDataComHora(Uteis.getDateSemHora(new Date()), obj.getContaCorrenteVO().getBloquearEmissaoBoletoHoraIni());
					Date dataFim = Uteis.obterDataComHora(Uteis.getDateSemHora(new Date()), obj.getContaCorrenteVO().getBloquearEmissaoBoletoHoraFim());
					if (new Date().after(dataIni) && new Date().before(dataFim)) {
						habilitar = false;
					} else {
						habilitar = true;
					}
				} catch (Exception e) {
					return false;
				}
			}
		}
		return habilitar;
	}

	@Override
	@Transactional(readOnly = false, rollbackFor = { Throwable.class }, propagation = Propagation.SUPPORTS)
	public void atualizarDataCompetenciaDeAcordoDataVencimento(ContaReceberVO obj, UsuarioVO usuarioVO) throws Exception {		

		final String sql = "UPDATE ContaReceber set dataCompetencia=? WHERE (codigo = ?)";
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setDate(1, Uteis.getDataJDBC(obj.getDataCompetencia()));
				sqlAlterar.setInt(2, obj.getCodigo());
				return sqlAlterar;
			}
		});		
	}
	
	@Override
	@Transactional(readOnly = false, rollbackFor = { Throwable.class }, propagation = Propagation.REQUIRED)
	public void atualizarLiberacaoIndiceReajustePorAtraso(ContaReceberVO contaReceber,  UsuarioVO usuarioVerif, ConfiguracaoFinanceiroVO config, UsuarioVO usuarioVO) throws Exception {
		contaReceber.setValorReceberCalculado(Uteis.arredondar(contaReceber.getValorReceberCalculado() - contaReceber.getValorIndiceReajustePorAtraso().doubleValue() , 2, 0));
		contaReceber.setLiberadoDoIndiceReajustePorAtraso(true);
		contaReceber.setIndiceReajustePadraoPorAtraso(new IndiceReajusteVO());
		contaReceber.setValorIndiceReajustePorAtraso(BigDecimal.ZERO);
		contaReceber.getDetalhamentoValorContaVOs().removeIf(p-> p.getTipoCentroResultadoOrigemDetalheEnum().isReajustePorAtraso());
		getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().excluirPorTipoCentroResultadoOrigemDetalhePorOrigemDetalhamentoConta(contaReceber.getCodigo(), TipoCentroResultadoOrigemDetalheEnum.REAJUSTE_POR_ATRASO, OrigemDetalhamentoContaEnum.CONTA_RECEBER, usuarioVO);
		getFacadeFactory().getOperacaoFuncionalidadeFacade().incluir(getFacadeFactory().getOperacaoFuncionalidadeFacade().executarGeracaoOperacaoFuncionalidade(OrigemOperacaoFuncionalidadeEnum.CONTA_RECEBER, contaReceber.getCodigo().toString(), OperacaoFuncionalidadeEnum.CONTA_RECEBER_LIBERAR_INDICE_REAJUSTE_ATRASO_, usuarioVerif, ""));
		final String sql = "UPDATE ContaReceber set liberadoDoIndiceReajustePorAtraso = true, indiceReajustePadraoPorAtraso = null, valorIndiceReajustePorAtraso = 0.0 WHERE (codigo = ?) " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setInt(1, contaReceber.getCodigo());
				return sqlAlterar;
			}
		});
	}
	
	
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarCorrecaoLancamentoContabilPorSql(String sql, ConfiguracaoFinanceiroVO confFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("contareceber.codigo"));
			carregarDados(obj, NivelMontarDados.TODOS, confFinanceiroVO, usuarioVO);
			persistirLancamentoContabilPadrao(obj, false, usuarioVO);
		}
	}
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void persistirLancamentoContabilPadrao(ContaReceberVO conta, boolean verificarAcesso, UsuarioVO usuarioVO) throws Exception {
		ControleAcesso.incluir(PerfilAcessoPermissaoFinanceiroEnum.PERMITIR_ALTERAR_LANCAMENTO_CONTABIL_RECEBER.getValor(), usuarioVO);
		List<LancamentoContabilVO> listaTemp = new ArrayList<>();
		listaTemp.addAll(conta.getListaLancamentoContabeisCredito());
		listaTemp.addAll(conta.getListaLancamentoContabeisDebito());
		for (LancamentoContabilVO lc : listaTemp) {
			getFacadeFactory().getLancamentoContabilFacade().validarDados(lc);
		}
		listaTemp.clear();
		conta.getListaLancamentoContabeisCredito().clear();
		conta.getListaLancamentoContabeisDebito().clear();
		List<ContaReceberRecebimentoVO>lista = getFacadeFactory().getContaReceberRecebimentoFacade().consultarPorContaReceberParaGeracaoLancamentoContabil(conta.getCodigo(), false, usuarioVO);
		for (ContaReceberRecebimentoVO crr : lista) {
			getFacadeFactory().getLancamentoContabilFacade().gerarLancamentoContabilPorContaReceber(listaTemp, conta, crr.getFormaPagamentoNegociacaoRecebimentoVO(), crr.getValorRecebimento(), crr.getDataRecebimeto(), true, usuarioVO);	
		}
		if (Uteis.isAtributoPreenchido(listaTemp)) {
			for (LancamentoContabilVO objExistente : listaTemp) {
				getFacadeFactory().getLancamentoContabilFacade().persistir(objExistente, false, usuarioVO);
				if (objExistente.getTipoPlanoConta().isCredito()) {
					conta.getListaLancamentoContabeisCredito().add(objExistente);
				} else {
					conta.getListaLancamentoContabeisDebito().add(objExistente);
				}
			}
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void persistirLancamentoContabilVO(ContaReceberVO conta, boolean verificarAcesso, UsuarioVO usuarioVO) throws Exception {
		ControleAcesso.incluir(PerfilAcessoPermissaoFinanceiroEnum.PERMITIR_ALTERAR_LANCAMENTO_CONTABIL_RECEBER.getValor(), usuarioVO);
		if (!conta.getTotalLancamentoContabeisCreditoTipoValorContaReceber().equals(conta.getTotalLancamentoContabeisDebitoTipoValorContaReceber())) {
			throw new Exception("Os valores dos lançamentos contábeis do tipo valor Conta Receber não podem ser diferentes.");
		}
		if (conta.getTotalLancamentoContabeisCreditoTipoValorContaReceber() > conta.getValorRecebido()) {
			throw new Exception("O Total do Lançamento de Crédito " + Uteis.arrendondarForcando2CadasDecimaisStrComSepador(conta.getTotalLancamentoContabeisCreditoTipoValorContaReceber(), ",") + " do tipo valor Conta Receber não podem ser maior que o valor da conta receber " + Uteis.arrendondarForcando2CadasDecimaisStrComSepador(conta.getValorRecebido(), ",") + ".");
		}
		if (conta.getTotalLancamentoContabeisDebitoTipoValorContaReceber() > conta.getValorRecebido()) {
			throw new Exception("O Total do Lançamento de Dédito " + Uteis.arrendondarForcando2CadasDecimaisStrComSepador(conta.getTotalLancamentoContabeisDebitoTipoValorContaReceber(), ",") + " do tipo valor Conta Receber não podem ser maior que o valor da conta receber " + Uteis.arrendondarForcando2CadasDecimaisStrComSepador(conta.getValorRecebido(), ",") + ".");
		}
		List<LancamentoContabilVO> listaTemp = new ArrayList<>();
		listaTemp.addAll(conta.getListaLancamentoContabeisCredito());
		listaTemp.addAll(conta.getListaLancamentoContabeisDebito());
		EnumMap<TipoOrigemLancamentoContabilEnum, String> mapaDeletar = new EnumMap(TipoOrigemLancamentoContabilEnum.class);
		mapaDeletar.put(TipoOrigemLancamentoContabilEnum.RECEBER, "'" + conta.getCodigo().toString() + "'");
		getFacadeFactory().getLancamentoContabilFacade().validarSeLancamentoContabilFoiExcluido(listaTemp, mapaDeletar, usuarioVO);
		for (LancamentoContabilVO lc : listaTemp) {
			getFacadeFactory().getLancamentoContabilFacade().persistir(lc, verificarAcesso, usuarioVO);
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.SUPPORTS)
	public void addLancamentoContabilVO(ContaReceberVO conta, LancamentoContabilVO lancamento, UsuarioVO usuario) throws Exception {
		if (!Uteis.isAtributoPreenchido(lancamento)) {
			Uteis.checkState(!Uteis.isAtributoPreenchido(lancamento.getPlanoContaVO()), "O campo Plano de Conta deve ser informado");
			Uteis.checkState(!Uteis.isAtributoPreenchido(lancamento.getValor()), "O campo Valor deve ser informado");
			CursoVO curso = getFacadeFactory().getContaReceberFacade().obterCursoVerificandoTurmaOrMatricula(conta, usuario);
			Date dataNegocicaoRecebimento = getFacadeFactory().getNegociacaoRecebimentoFacade().consultaDataRecebimentoPorContaReceberUnica(conta.getCodigo(), usuario);
			ContaCorrenteVO contaCorrente = null;
			if (!Uteis.isAtributoPreenchido(lancamento.getContaCorrenteVO())) {
				contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarContaCorrenteUsadaNaNegociacaoRecebimentoPorContaReceber(conta.getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				Uteis.checkState(!Uteis.isAtributoPreenchido(contaCorrente), "Não foi encontrado uma conta corrente na Negociação Recebimento para essa Conta.");				
			} else {
				contaCorrente = lancamento.getContaCorrenteVO();
			}
			lancamento.setSituacaoLancamentoContabilEnum(SituacaoLancamentoContabilEnum.COMPENSADO);
			getFacadeFactory().getLancamentoContabilFacade().preencherLancamentoContabilPorContaReceber(lancamento, lancamento.getPlanoContaVO(),dataNegocicaoRecebimento, conta, TipoValorLancamentoContabilEnum.CONTA_RECEBER, null, lancamento.getValor(), curso, contaCorrente, false, lancamento.getTipoPlanoConta(), new Date(), usuario);
		}
		
		if (Uteis.isAtributoPreenchido(lancamento.getListaCentroNegocioAcademico()) && !lancamento.getTotalCentroNegocioAcademico().equals(lancamento.getValor())) {
			throw new Exception("O Total do Rateio Acadêmico " + Uteis.arrendondarForcando2CadasDecimaisStrComSepador(lancamento.getTotalCentroNegocioAcademico(), ",") + " não podem ser diferente do valor do lançamento contábil " + Uteis.arrendondarForcando2CadasDecimaisStrComSepador(lancamento.getValor(), ",") + ".");
		} else if (Uteis.isAtributoPreenchido(lancamento.getListaCentroNegocioAdministrativo()) && !lancamento.getTotalCentroNegocioAdministrativo().equals(lancamento.getValor())) {
			throw new Exception("O Total do Rateio Administrativo " + Uteis.arrendondarForcando2CadasDecimaisStrComSepador(lancamento.getTotalCentroNegocioAdministrativo(), ",") + " não podem ser diferente do valor do lançamento contábil " + Uteis.arrendondarForcando2CadasDecimaisStrComSepador(lancamento.getValor(), ",") + ".");
		}
		if (lancamento.getTipoPlanoConta().isCredito()) {
			getFacadeFactory().getLancamentoContabilFacade().preencherListaLancamentoContabilVO(conta.getListaLancamentoContabeisCredito(), lancamento);
		} else {
			getFacadeFactory().getLancamentoContabilFacade().preencherListaLancamentoContabilVO(conta.getListaLancamentoContabeisDebito(), lancamento);
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.SUPPORTS)
	public void removeLancamentoContabilVO(ContaReceberVO conta, LancamentoContabilVO lancamento, UsuarioVO usuario) throws Exception {
		if (lancamento.getTipoPlanoConta().isCredito()) {
			getFacadeFactory().getLancamentoContabilFacade().removeLancamentoContabilVO(conta.getListaLancamentoContabeisCredito(), lancamento, usuario);
		} else {
			getFacadeFactory().getLancamentoContabilFacade().removeLancamentoContabilVO(conta.getListaLancamentoContabeisDebito(), lancamento, usuario);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirNossoNumeroContaReceber(final ContaReceberVO obj, String numeroBanco, final boolean nossonumeroalterado, UsuarioVO usuario) throws Exception {
		final Date updated = new Date();
		try {
			final String sql = "INSERT INTO NossoNumeroContaReceber( matriculaPeriodo, parcela, nossonumero, datageracao, datavencimento, valor, valorbase, valortotaldesconto, datadescprogressivo, valordescprogressivo, motivogeracao, valordescontosemvalidade, valordescontodatalimite, acrescimo, nossonumeroalterado, valordescontocalculadoprimeirafaixadescontos, valordescontocalculadosegundafaixadescontos , valordescontocalculadoterceirafaixadescontos  , valordescontocalculadoquartafaixadescontos , tipoorigem, numerobanco, "
					+ " dataLimitePrimeiraFaixaDescontos, dataLimiteSegundaFaixaDescontos, dataLimiteTerceiraFaixaDescontos, dataLimiteQuartaFaixaDescontos , contacorrente, convenio ) "
					+ " VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,"
					+ " ?, ?, ?, ? , ?, ?) returning codigo" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario); // 41
			Integer codigo = ((Integer) getConexao().getJdbcTemplate().query(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
					PreparedStatement sqlInserir = cnctn.prepareStatement(sql);
					int i = 0;
					if (obj.getMatriculaPeriodo().intValue() != 0) {
						sqlInserir.setInt(++i, obj.getMatriculaPeriodo().intValue());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					sqlInserir.setString(++i, obj.getParcela());
					sqlInserir.setString(++i, obj.getNossoNumero());
					sqlInserir.setDate(++i, Uteis.getDataJDBC(new Date()));
					sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataVencimento()));
					sqlInserir.setDouble(++i, obj.getValor().doubleValue());
					sqlInserir.setDouble(++i, obj.getValorBaseContaReceber().doubleValue());
					/// valor total desconto
					sqlInserir.setDouble(++i, obj.getValorDesconto().doubleValue());
					sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteAplicacaoDesconto()));
					sqlInserir.setDouble(++i, obj.getValorDescontoDataLimite().doubleValue());
					sqlInserir.setString(++i, "");

					sqlInserir.setDouble(++i, obj.getValorDescontoSemValidade().doubleValue());
					sqlInserir.setDouble(++i, obj.getValorDescontoDataLimite().doubleValue());
					sqlInserir.setDouble(++i, obj.getAcrescimo().doubleValue());
					sqlInserir.setBoolean(++i, nossonumeroalterado);
					sqlInserir.setDouble(++i, obj.getValorDescontoCalculadoPrimeiraFaixaDescontos().doubleValue());
					sqlInserir.setDouble(++i, obj.getValorDescontoCalculadoSegundaFaixaDescontos().doubleValue());
					sqlInserir.setDouble(++i, obj.getValorDescontoCalculadoTerceiraFaixaDescontos().doubleValue());
					sqlInserir.setDouble(++i, obj.getValorDescontoCalculadoQuartaFaixaDescontos().doubleValue());
					sqlInserir.setString(++i, obj.getTipoOrigem());
					sqlInserir.setString(++i, numeroBanco);
					if (obj.getDataLimitePrimeiraFaixaDescontos() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataLimitePrimeiraFaixaDescontos()));
					}
					if (obj.getDataLimiteSegundaFaixaDescontos() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteSegundaFaixaDescontos()));
					}
					if (obj.getDataLimiteTerceiraFaixaDescontos() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteTerceiraFaixaDescontos()));
					}
					if (obj.getDataLimiteQuartaFaixaDescontos() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteQuartaFaixaDescontos()));
					}
					if (obj.getContaCorrenteVO().getCodigo() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setInt(++i, obj.getContaCorrenteVO().getCodigo());
					}					
					if (obj.getConvenio().getCodigo() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setInt(++i, obj.getConvenio().getCodigo());
					}					
					return sqlInserir;
				}
			}, new ResultSetExtractor<Integer>() {

				public Integer extractData(ResultSet rs) throws SQLException, DataAccessException {
					if (rs.next()) {
						obj.setNovoObj(Boolean.FALSE);
						return rs.getInt("codigo");
					}
					return null;
				}
			}));
		} catch (Exception e) {
			throw e;
		}
	}
	
	
	
	
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarNossoNumeroContaReceber(final ContaReceberVO obj, Integer codigoNossoNumeroContaReceber ,  String numeroBanco,  UsuarioVO usuario) throws Exception {	
		try {			
			final StringBuilder sql = new StringBuilder( "UPDATE NossoNumeroContaReceber set  "
					+ " datavencimento=? ,"
					+ " valor=? ,"
					+ " valorbase=? ,"
					+ " valortotaldesconto=? ,"
					+ " datadescprogressivo=? ,"
					+ " valordescprogressivo=? , "
					+ " valordescontosemvalidade=? , "
					+ " valordescontodatalimite=?, "
					+ " acrescimo=?,"
					+ " valordescontocalculadoprimeirafaixadescontos=?,"
					+ " valordescontocalculadosegundafaixadescontos=? ,"
					+ " valordescontocalculadoterceirafaixadescontos=?  ,"
					+ " valordescontocalculadoquartafaixadescontos=? ,"
					+ " numerobanco=? ,"
					+ " dataLimitePrimeiraFaixaDescontos=? ,"
					+ " dataLimiteSegundaFaixaDescontos=? ,"
					+ " dataLimiteTerceiraFaixaDescontos=? , "
					+ " dataLimiteQuartaFaixaDescontos=? , "
					+ " contacorrente=?  "); 
			        sql.append(" WHERE ((codigo = ?))").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
			        getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

						public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
							PreparedStatement sqlAlterar = cnctn.prepareStatement(sql.toString());
							int i = 0;
							sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataVencimento()));
							sqlAlterar.setDouble(++i, obj.getValor().doubleValue());
							sqlAlterar.setDouble(++i, obj.getValorBaseContaReceber().doubleValue());
							/// valor total desconto
							sqlAlterar.setDouble(++i, obj.getValorDesconto().doubleValue());
							sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteAplicacaoDesconto()));
							sqlAlterar.setDouble(++i, obj.getValorDescontoDataLimite().doubleValue());
							sqlAlterar.setDouble(++i, obj.getValorDescontoSemValidade().doubleValue());
							sqlAlterar.setDouble(++i, obj.getValorDescontoDataLimite().doubleValue());
							sqlAlterar.setDouble(++i, obj.getAcrescimo().doubleValue());							
							sqlAlterar.setDouble(++i, obj.getValorDescontoCalculadoPrimeiraFaixaDescontos().doubleValue());
							sqlAlterar.setDouble(++i, obj.getValorDescontoCalculadoSegundaFaixaDescontos().doubleValue());
							sqlAlterar.setDouble(++i, obj.getValorDescontoCalculadoTerceiraFaixaDescontos().doubleValue());
							sqlAlterar.setDouble(++i, obj.getValorDescontoCalculadoQuartaFaixaDescontos().doubleValue());						
							sqlAlterar.setString(++i, numeroBanco);
							if (obj.getDataLimitePrimeiraFaixaDescontos() == null) {
								sqlAlterar.setNull(++i, 0);
							} else {
								sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataLimitePrimeiraFaixaDescontos()));
							}
							if (obj.getDataLimiteSegundaFaixaDescontos() == null) {
								sqlAlterar.setNull(++i, 0);
							} else {
								sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteSegundaFaixaDescontos()));
							}
							if (obj.getDataLimiteTerceiraFaixaDescontos() == null) {
								sqlAlterar.setNull(++i, 0);
							} else {
								sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteTerceiraFaixaDescontos()));
							}
							if (obj.getDataLimiteQuartaFaixaDescontos() == null) {
								sqlAlterar.setNull(++i, 0);
							} else {
								sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataLimiteQuartaFaixaDescontos()));
							}
							if (obj.getContaCorrenteVO().getCodigo() == null) {
								sqlAlterar.setNull(++i, 0);
							} else {
								sqlAlterar.setInt(++i, obj.getContaCorrenteVO().getCodigo());
							}				
							sqlAlterar.setInt(++i, codigoNossoNumeroContaReceber.intValue());
							return sqlAlterar;
						}					
						
					});
			
		} catch (Exception e) {
			throw e;
		}
	}

	private void validarRegistroCobrancaAntesCancelamento(ContaReceberVO contaReceber) throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append("select coalesce(bool_or(registrocobrancacontareceber is not null), false) registrocobranca from contareceber where codigo = ?");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), contaReceber.getCodigo());
		if (resultado.next() && resultado.getBoolean("registrocobranca")) {
			throw new Exception("Conta Receber não pode ser cancelada, pois foi enviada para cobrança!");
		}
	}

	private static void validarRegistroCobrancaAntesExclusao(String where, Object[] args) throws Exception {
		String sql = "select coalesce(bool_or(registrocobrancacontareceber is not null), false) registrocobranca from contareceber " + where;
		SqlRowSet resultado = null;
		if (args != null) {
			resultado = getConexao().getJdbcTemplate().queryForRowSet(sql, args);
		} else {
			resultado = getConexao().getJdbcTemplate().queryForRowSet(sql);
		}
		if (resultado.next() && resultado.getBoolean("registrocobranca")) {
			throw new Exception("Conta Receber não pode ser excluida, pois foi enviada para cobrança!");
		}
	}




	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ContaReceberVO> consultarContaReceberRecebidasOuEnviadasParaRemessaParaAplicacaoReajustePosteriorEmOutraConta(Integer indiceReajuste, Integer mes, String ano, Integer parcelaInicialReajuste, Boolean considerarDescontoSemValidadeCalculoIndiceReajuste, UsuarioVO usuarioVO)  throws Exception{		
		Date dataInicioMes = Uteis.getDate("01/"+mes+"/"+ano);		

		StringBuilder sb = new StringBuilder();
		sb.append("select distinct cr.codigo, cr.matriculaaluno, cr.parcela, cr.matriculaPeriodo, ");
		sb.append(" cr.datavencimento, cr.valor, cr.valorbasecontareceber, cr.valorIndiceReajuste, cr.situacao,  ");
		sb.append(" m.permiteExecucaoReajustePreco ");
		if(considerarDescontoSemValidadeCalculoIndiceReajuste) {
			sb.append(", coalesce((select sum(valor) from detalhamentovalorconta where origemdetalhamentoconta = 'CONTA_RECEBER' and codigoorigem = cr.codigo ");
			sb.append(" and tipocentroresultadoorigemdetalhe in ('DESCONTO_ALUNO', 'DESCONTO_CONVENIO', 'DESCONTO_INSTITUICAO', 'DESCONTO_MANUAL', 'DESCONTO_RATEIO', 'DESCONTO_CUSTEADO_CONTA_RECEBER') ");
			sb.append(" and utilizado and datalimiteaplicacaodesconto is null), 0.0) as \"contareceber.valordescontosemvalidade\" ");
		}
		sb.append(" from contaReceber as cr ");
		sb.append(" inner join matricula as m on m.matricula = cr.matriculaAluno ");
		sb.append(" inner join matriculaPeriodo on m.matricula = matriculaPeriodo.matricula ");
		sb.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sb.append(" where cr.matriculaAluno in(");
		
		sb.append(" select distinct matricula.matricula ");
		sb.append(" from indiceReajuste ");
		sb.append(" inner join turma on turma.indiceReajuste = indiceReajuste.codigo ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.turma = turma.codigo ");
		sb.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sb.append(" inner join contareceber on contareceber.matriculaperiodo = matriculaperiodo.codigo ");
		sb.append(" inner join matricula on matricula.matricula = matriculaperiodo.matricula ");
		sb.append(" inner join curso on curso.codigo = matricula.curso ");
		sb.append(" where tipoorigem = 'MEN' and condicaopagamentoplanofinanceirocurso.nrparcelasperiodo > 12 ");
//		sb.append(" and matricula.matricula = m.matricula ");
		sb.append(" and turma.indiceReajuste = ").append(indiceReajuste);
		sb.append(" and curso.periodicidade = 'IN' ");
		sb.append(" and ( ( contaReceber.situacao = 'RE'");
		sb.append(" and exists(");
		sb.append(" select distinct contarecebernegociacaorecebimento.contareceber from negociacaorecebimento ");
		sb.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo ");
		sb.append(" where contarecebernegociacaorecebimento.contareceber = contareceber.codigo ");
		sb.append(" and negociacaorecebimento.data::date >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("') )");
		
		sb.append(" or  ");
		sb.append(" (contaReceber.situacao = 'NE' ");
		sb.append(" and exists ( select distinct contarecebernegociado.contareceber  from contarecebernegociado ");
		sb.append(" inner join negociacaocontareceber on  contarecebernegociado.negociacaocontareceber = negociacaocontareceber.codigo ");
		sb.append(" where contarecebernegociado.contareceber = contareceber.codigo ");
		sb.append(" and negociacaocontareceber.data::date >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("') )");
		
//		sb.append(" or (");
//		sb.append(" contareceber.situacao = 'AR' and contareceber.codigo in(select distinct controleremessacontareceber.contareceber from controleremessacontareceber  where controleremessacontareceber.contareceber = contareceber.codigo  and controleremessacontareceber.situacao != 'ESTORNADO' )) ");
		sb.append(" ) ");
//		sb.append(" or contareceber.situacao = 'NE' ) ");
		sb.append(" and contareceber.datavencimento >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("'");
//		sb.append(" and contareceber.datavencimento <= '").append(Uteis.getDataJDBC(dataFimMes)).append("'");
		sb.append(" and contareceber.parcela ilike ('%/%') ");            
		sb.append(" and (position('/' in contareceber.parcela) -1) > 0 ");
		sb.append(" and isnumeric(substring(contareceber.parcela, 1, position('/' in contareceber.parcela) - 1)) ");
		
		sb.append(" and ");
		sb.append(" case when condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and matricula.considerarParcelasMaterialDidaticoReajustePreco   ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then (cast(substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) as integer) >= ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" and (cast(substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) as integer) < ").append(parcelaInicialReajuste + 12).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" else ");
		sb.append(" (cast(substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) as integer) >= ").append(parcelaInicialReajuste).append(") ");
		sb.append(" and (cast(substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) as integer) < ").append(parcelaInicialReajuste + 12).append(") ");
		sb.append(" end ");

		sb.append(" and not exists(");
		sb.append(" select distinct indicePeriodo.codigo from indicereajusteperiodomatriculaperiodovencimento indicePeriodoVencimento ");
		sb.append(" inner join indicereajustePeriodo indicePeriodo on indicePeriodo.codigo = indicePeriodoVencimento.indiceReajustePeriodo ");
//		sb.append(" inner join matriculaperiodo on  indicePeriodoVencimento.matriculaperiodo = matriculaperiodo.codigo ");
		sb.append(" where indicePeriodoVencimento.matriculaperiodo = matriculaPeriodo.codigo ");
//		sb.append(" and matriculaperiodo.contareceber = contareceber.codigo ");
		sb.append(" and ");
		sb.append(" case when condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and matricula.considerarParcelasMaterialDidaticoReajustePreco ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then indicePeriodoVencimento.parcela::int = ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico ");
		sb.append(" else ");
		sb.append(" indicePeriodoVencimento.parcela = '").append(parcelaInicialReajuste).append("' ");
		sb.append(" end ");
		
		sb.append(" and contareceber.tipoorigem = 'MENSALIDADE' ");
		
		sb.append(" and indicePeriodoVencimento.situacao= 'PROCESSADO') ");

		sb.append(") ");

		sb.append(" and (  (cr.situacao = 'RE' ");
		sb.append(" and exists(");
		sb.append(" select distinct contarecebernegociacaorecebimento.contareceber from negociacaorecebimento ");
		sb.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo ");
		sb.append(" where contarecebernegociacaorecebimento.contareceber = cr.codigo ");
		sb.append(" and negociacaorecebimento.data::date >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("') ) ");
		
		sb.append(" or  ");
		sb.append(" (cr.situacao = 'NE' ");
		sb.append(" and exists ( select distinct contarecebernegociado.contareceber  from contarecebernegociado ");
		sb.append(" inner join negociacaocontareceber on  contarecebernegociado.negociacaocontareceber = negociacaocontareceber.codigo ");
		sb.append(" where contarecebernegociado.contareceber = cr.codigo ");
		sb.append(" and negociacaocontareceber.data::date >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("') )");
		
		
		sb.append(") ");
//		sb.append(" or (");
//		sb.append(" cr.situacao = 'AR' and exists(select distinct controleremessacontareceber.contareceber from controleremessacontareceber  where controleremessacontareceber.contareceber = cr.codigo and controleremessacontareceber.situacao != 'ESTORNADO')) ");
//		sb.append(" or cr.situacao = 'NE' )");
		sb.append(" and cr.parcela ilike ('%/%') ");            
		sb.append(" and (position('/' in cr.parcela) -1) > 0 ");
		sb.append(" and isnumeric(substring(cr.parcela, 1, position('/' in cr.parcela) - 1)) ");
		sb.append(" and length(substring(cr.parcela, 0, position('/' IN cr.parcela))) = 2");
		sb.append(" and ");
		sb.append(" case when condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and m.considerarParcelasMaterialDidaticoReajustePreco ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaPeriodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then (cast (substring(cr.parcela, 0, position('/' in cr.parcela)) as integer )  >= ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" and (cast (substring(cr.parcela, 0, position('/' in cr.parcela)) as integer ) < ").append(parcelaInicialReajuste + 12).append("- condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" else ");
		sb.append(" (substring(cr.parcela, 0, position('/' in cr.parcela)) >= '").append(parcelaInicialReajuste).append("') ");
		sb.append(" and (substring(cr.parcela, 0, position('/' in cr.parcela)) < '").append(parcelaInicialReajuste + 12).append("') ");
		sb.append(" end ");
		sb.append(" and tipoorigem = 'MEN' ");
		
		sb.append(" and not exists ( ");
		sb.append(" select distinct indicePeriodo.codigo from indicereajusteperiodomatriculaperiodovencimento indicePeriodoVencimento "); 
		sb.append(" inner join indicereajustePeriodo indicePeriodo on indicePeriodo.codigo = indicePeriodoVencimento.indiceReajustePeriodo ");
//		sb.append(" inner join matriculaperiodo on indicePeriodoVencimento.matriculaperiodo = matriculaperiodo.codigo "); 
		sb.append(" where indicePeriodoVencimento.matriculaperiodo = cr.matriculaperiodo  ");
//		sb.append(" and matriculaperiodo.contareceber = cr.codigo ");
		sb.append(" and indicePeriodoVencimento.parcela = substring(cr.parcela, 1, position('/' in cr.parcela) - 1) ");
		sb.append(" and indicePeriodoVencimento.tipoorigem = 'MENSALIDADE' ");
		sb.append(" and indicePeriodo.mes = '").append(MesAnoEnum.getMesData(dataInicioMes).name()).append("' ");
		sb.append(" and indicePeriodo.ano = '").append(ano).append("' ");
		sb.append(" and indicePeriodoVencimento.situacao = 'PROCESSADO') ");
		sb.append(" and  cr.datavencimento >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("' ");; 
		
		sb.append(" order by cr.matriculaaluno, cr.parcela ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<ContaReceberVO> listaContaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getMatriculaAluno().setMatricula(tabelaResultado.getString("matriculaAluno"));
			obj.getMatriculaAluno().setPermiteExecucaoReajustePreco(tabelaResultado.getBoolean("permiteExecucaoReajustePreco"));
			obj.setParcela(tabelaResultado.getString("parcela"));
			obj.setMatriculaPeriodo(tabelaResultado.getInt("matriculaPeriodo"));
			obj.setDataVencimento(tabelaResultado.getDate("dataVencimento"));
			obj.setValor(tabelaResultado.getDouble("valor"));
			obj.setValorBaseContaReceber(tabelaResultado.getDouble("valorBaseContaReceber"));
			obj.setValorIndiceReajuste(tabelaResultado.getBigDecimal("valorIndiceReajuste"));
			obj.setSituacao(tabelaResultado.getString("situacao"));
			if(considerarDescontoSemValidadeCalculoIndiceReajuste) {
				obj.setValorDescontoSemValidade(tabelaResultado.getDouble("contareceber.valordescontosemvalidade"));
			}
			listaContaReceberVOs.add(obj);
		}

		return listaContaReceberVOs;
	}
	
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ContaReceberVO> consultarContaReceberRecebidasOuEnviadasParaRemessaParaAplicacaoReajustePosteriorEmOutraContaBolsaCusteadaConvenio(Integer indiceReajuste, Integer mes, String ano, Integer parcelaInicialReajuste, UsuarioVO usuarioVO)  throws Exception{		
		Date dataInicioMes = Uteis.getDate("01/"+mes+"/"+ano);		
		Date dataFimMes = Uteis.getDataUltimoDiaMes(dataInicioMes);
		StringBuilder sb = new StringBuilder();
		sb.append("select distinct cr.codigo, cr.matriculaaluno, cr.parcela, cr.matriculaPeriodo, ");
		sb.append(" cr.datavencimento, cr.valor, cr.valorbasecontareceber, cr.valorIndiceReajuste, cr.situacao, ");
		sb.append(" m.permiteExecucaoReajustePreco, ");
		sb.append(" parceiro.codigo as \"parceiro.codigo\", parceiro.realizarReajustePrecoComBaseIndiceReajuste as \"parceiro.realizarReajustePrecoComBaseIndiceReajuste\" ");
		sb.append(" from contaReceber as cr ");
		sb.append(" inner join matricula as m on m.matricula = cr.matriculaAluno ");
		sb.append(" inner join matriculaPeriodo on m.matricula = matriculaPeriodo.matricula ");
		sb.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sb.append(" inner join parceiro on parceiro.codigo = cr.parceiro ");
		sb.append(" where cr.matriculaAluno in(");
		
		sb.append(" select distinct matricula.matricula ");
		sb.append(" from indiceReajuste ");
		sb.append(" inner join turma on turma.indiceReajuste = indiceReajuste.codigo ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.turma = turma.codigo ");
		sb.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sb.append(" inner join contareceber on contareceber.matriculaperiodo = matriculaperiodo.codigo ");
		sb.append(" inner join matricula on matricula.matricula = matriculaperiodo.matricula ");
		sb.append(" inner join curso on curso.codigo = matricula.curso ");
		sb.append(" inner join parceiro on parceiro.codigo = contareceber.parceiro ");
		sb.append(" where tipoorigem = 'BCC' and condicaopagamentoplanofinanceirocurso.nrparcelasperiodo > 12 ");
//		sb.append(" and matricula.matricula = m.matricula ");
		sb.append(" and turma.indiceReajuste = ").append(indiceReajuste);
		sb.append(" and curso.periodicidade = 'IN' ");
		sb.append(" and ((contaReceber.situacao = 'RE' ");
		sb.append(" and exists(");
		sb.append(" select distinct contarecebernegociacaorecebimento.contareceber from negociacaorecebimento ");
		sb.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo ");
		sb.append(" where contarecebernegociacaorecebimento.contareceber = contareceber.codigo ");
		sb.append(" and negociacaorecebimento.data::date >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("') ) ");

//		sb.append(" or (");
//		sb.append(" contareceber.situacao = 'AR' and contareceber.codigo in(select distinct controleremessacontareceber.contareceber from controleremessacontareceber  where controleremessacontareceber.contareceber = contareceber.codigo  and controleremessacontareceber.situacao != 'ESTORNADO' )) ");
		sb.append(" or (contareceber.situacao = 'NE' and exists( ");
		sb.append(" select distinct contarecebernegociado.contareceber  from contarecebernegociado  ");
		sb.append(" inner join negociacaocontareceber on  contarecebernegociado.negociacaocontareceber = negociacaocontareceber.codigo  ");
		sb.append(" where contarecebernegociado.contareceber = contareceber.codigo ");
		sb.append(" and negociacaocontareceber.data::date >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("') ) ");
		sb.append(" ) ");
		sb.append(" and contareceber.datavencimento >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("'");
//		sb.append(" and contareceber.datavencimento <= '").append(Uteis.getDataJDBC(dataFimMes)).append("'");
		sb.append(" and contareceber.parcela ilike ('%/%') ");            
		sb.append(" and (position('/' in contareceber.parcela) -1) > 0 ");
		sb.append(" and isnumeric(substring(contareceber.parcela, 1, position('/' in contareceber.parcela) - 1)) ");
		
		sb.append(" and ");
		sb.append(" case when parceiro.considerarParcelasMaterialDidaticoReajustePreco and parceiro.custeaParcelasMaterialDidatico and condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and matricula.considerarParcelasMaterialDidaticoReajustePreco ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then (cast(substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) as integer) >= ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" and (cast(substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) as integer) < ").append(parcelaInicialReajuste + 12).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" else ");
		sb.append(" (cast(substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) as integer) >= ").append(parcelaInicialReajuste).append(") ");
		sb.append(" and (cast(substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) as integer) < ").append(parcelaInicialReajuste + 12).append(") ");
		sb.append(" end ");

		sb.append(" and not exists(");
		sb.append(" select distinct indicePeriodo.codigo from indicereajusteperiodomatriculaperiodovencimento indicePeriodoVencimento ");
		sb.append(" inner join indicereajustePeriodo indicePeriodo on indicePeriodo.codigo = indicePeriodoVencimento.indiceReajustePeriodo ");
		sb.append(" where indicePeriodoVencimento.matriculaperiodo = matriculaPeriodo.codigo ");
		
		sb.append(" and ");
		sb.append(" case when parceiro.considerarParcelasMaterialDidaticoReajustePreco and parceiro.custeaParcelasMaterialDidatico and condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and matricula.considerarParcelasMaterialDidaticoReajustePreco ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then indicePeriodoVencimento.parcela::int = ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico ");
		sb.append(" else ");
		sb.append(" indicePeriodoVencimento.parcela = '").append(parcelaInicialReajuste).append("' ");
		sb.append(" end ");
		
		sb.append(" and indicePeriodo.mes = '").append(MesAnoEnum.getMesData(dataInicioMes).name()).append("' ");
		sb.append(" and indicePeriodo.ano = '").append(ano).append("' ");
		sb.append(" and indicePeriodoVencimento.situacao= 'PROCESSADO') ");

		sb.append(") ");

		sb.append(" and ( (cr.situacao = 'RE' ");
		sb.append(" and exists(");
		sb.append(" select distinct contarecebernegociacaorecebimento.contareceber from negociacaorecebimento ");
		sb.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo ");
		sb.append(" where contarecebernegociacaorecebimento.contareceber = cr.codigo ");
		sb.append(" and negociacaorecebimento.data::date >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("') ) ");

//		sb.append(" or (");
//		sb.append(" cr.situacao = 'AR' and exists(select distinct controleremessacontareceber.contareceber from controleremessacontareceber  where controleremessacontareceber.contareceber = cr.codigo and controleremessacontareceber.situacao != 'ESTORNADO')) ");
		sb.append(" or (cr.situacao = 'NE' and exists( ");
		sb.append(" select distinct contarecebernegociado.contareceber  from contarecebernegociado  ");
		sb.append(" inner join negociacaocontareceber on  contarecebernegociado.negociacaocontareceber = negociacaocontareceber.codigo  ");
		sb.append(" where contarecebernegociado.contareceber = cr.codigo ");
		sb.append(" and negociacaocontareceber.data::date >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("') ) ");
		sb.append(") ");
		
		sb.append(" and cr.parcela ilike ('%/%') ");            
		sb.append(" and (position('/' in cr.parcela) -1) > 0 ");
		sb.append(" and isnumeric(substring(cr.parcela, 1, position('/' in cr.parcela) - 1)) ");
		sb.append(" and length(substring(cr.parcela, 0, position('/' IN cr.parcela))) = 2");
		
		sb.append(" and ");
		sb.append(" case when parceiro.considerarParcelasMaterialDidaticoReajustePreco and parceiro.custeaParcelasMaterialDidatico and condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and m.considerarParcelasMaterialDidaticoReajustePreco ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then (cast (substring(cr.parcela, 0, position('/' in cr.parcela)) as integer )  >= ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" and (cast (substring(cr.parcela, 0, position('/' in cr.parcela)) as integer ) < ").append(parcelaInicialReajuste + 12).append("- condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" else ");
		sb.append(" (substring(cr.parcela, 0, position('/' in cr.parcela)) >= '").append(parcelaInicialReajuste).append("') ");
		sb.append(" and (substring(cr.parcela, 0, position('/' in cr.parcela)) < '").append(parcelaInicialReajuste + 12).append("') ");
		sb.append(" end ");
		
		sb.append(" and  tipoorigem = 'BCC'");
		
		sb.append(" and not exists ( ");
		sb.append(" select distinct indicePeriodo.codigo from indicereajusteperiodomatriculaperiodovencimento indicePeriodoVencimento "); 
		sb.append(" inner join indicereajustePeriodo indicePeriodo on indicePeriodo.codigo = indicePeriodoVencimento.indiceReajustePeriodo "); 
		sb.append(" where indicePeriodoVencimento.matriculaperiodo = cr.matriculaperiodo  ");
		sb.append(" and indicePeriodoVencimento.parcela = substring(cr.parcela, 1, position('/' in cr.parcela) - 1) ");	
		sb.append(" and indicePeriodoVencimento.tipoorigem = 'BCC' ");
		sb.append(" and indicePeriodo.mes = '").append(MesAnoEnum.getMesData(dataInicioMes).name()).append("' ");
		sb.append(" and indicePeriodo.ano = '").append(ano).append("' ");
		sb.append(" and indicePeriodoVencimento.situacao = 'PROCESSADO') "); 
		
		sb.append(" order by cr.matriculaaluno, cr.parcela ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<ContaReceberVO> listaContaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getMatriculaAluno().setMatricula(tabelaResultado.getString("matriculaAluno"));
			obj.getMatriculaAluno().setPermiteExecucaoReajustePreco(tabelaResultado.getBoolean("permiteExecucaoReajustePreco"));
			obj.setParcela(tabelaResultado.getString("parcela"));
			obj.setMatriculaPeriodo(tabelaResultado.getInt("matriculaPeriodo"));
			obj.setDataVencimento(tabelaResultado.getDate("dataVencimento"));
			obj.setValor(tabelaResultado.getDouble("valor"));
			obj.setValorBaseContaReceber(tabelaResultado.getDouble("valorBaseContaReceber"));
			obj.setValorIndiceReajuste(tabelaResultado.getBigDecimal("valorIndiceReajuste"));
			obj.setSituacao(tabelaResultado.getString("situacao"));
			listaContaReceberVOs.add(obj);
		}

		return listaContaReceberVOs;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ContaReceberVO> consultarContaReceberProcessadaParaCancelamentoPorIndiceReajustePeriodo(Integer indiceReajustePeriodo, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("select contareceber.codigo, contareceber.matriculaaluno, contareceber.parcela, contaReceber.matriculaPeriodo, contareceber.contacorrente, ");
		sb.append(" contareceber.datavencimento, contareceber.valor, contareceber.valorbasecontareceber, contaReceber.valorIndiceReajuste, contaReceber.tipoorigem  ");
		sb.append(" from contaReceber ");
		sb.append(" inner join indicereajusteperiodomatriculaperiodovencimento on indicereajusteperiodomatriculaperiodovencimento.matriculaperiodo = contareceber.matriculaperiodo ");
		sb.append(" and indicereajusteperiodomatriculaperiodovencimento.parcela = substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) ");
		sb.append(" inner join indicereajusteperiodo on indicereajusteperiodo.codigo = indicereajusteperiodomatriculaperiodovencimento.indicereajusteperiodo ");
		sb.append(" where indicereajusteperiodomatriculaperiodovencimento.situacao = 'PROCESSADO' ");
		sb.append(" and indicereajusteperiodo.codigo = ").append(indiceReajustePeriodo);
		sb.append(" and contareceber.situacao = 'AR' ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<ContaReceberVO> listaContaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getMatriculaAluno().setMatricula(tabelaResultado.getString("matriculaAluno"));
			obj.setParcela(tabelaResultado.getString("parcela"));
			obj.setMatriculaPeriodo(tabelaResultado.getInt("matriculaPeriodo"));
			obj.setDataVencimento(tabelaResultado.getDate("dataVencimento"));
			obj.setValor(tabelaResultado.getDouble("valor"));
			obj.setValorBaseContaReceber(tabelaResultado.getDouble("valorBaseContaReceber"));
			obj.setValorIndiceReajuste(tabelaResultado.getBigDecimal("valorIndiceReajuste"));
			obj.setTipoOrigem(tabelaResultado.getString("tipoorigem"));
			obj.getContaCorrenteVO().setCodigo(tabelaResultado.getInt("contacorrente"));
			listaContaReceberVOs.add(obj);
		}
		return listaContaReceberVOs;
	}

	public void realizarAtualizacaoIndiceReajustePrecoContaReceber(ContaReceberVO contaReceberVO, Integer matriculaPeriodo, UsuarioVO usuarioVO) throws Exception {
		if ((contaReceberVO.getTipoOrigem().equals(TipoOrigemContaReceber.MENSALIDADE.getValor()) || contaReceberVO.getTipoOrigem().equals(TipoOrigemContaReceber.BOLSA_CUSTEADA_CONVENIO.getValor())) && !contaReceberVO.getIndiceReajusteCalculado()) {
			BigDecimal valorBaseContaReceberBigDecimal = new BigDecimal(String.valueOf(Uteis.arrendondarForcando2CadasDecimais(contaReceberVO.getValorBaseContaReceber())));
			String tipoOrigemContaReceber = contaReceberVO.getTipoOrigem().equals("MEN") ? "MENSALIDADE" : "BCC";
			List<IndiceReajustePeriodoVO> indiceReajustePeriodoVOs = getFacadeFactory().getIndiceReajustePeriodoFacade().consultarIndiceReajustePeriodoPorMatriculaPeriodoSituacao(matriculaPeriodo, tipoOrigemContaReceber, SituacaoExecucaoEnum.PROCESSADO, contaReceberVO.getParcela(), usuarioVO);
			if (!isIgualValorBaseContaReceberAoValorBaseContaReceberIndiceReajusteAddValorReajuste(contaReceberVO.getParcela(),contaReceberVO.getCodigo(),tipoOrigemContaReceber, indiceReajustePeriodoVOs, matriculaPeriodo, valorBaseContaReceberBigDecimal, usuarioVO)) {
				indiceReajustePeriodoVOs.forEach(irpvo -> realizarAtualizacaoIndiceReajustePrecoContaReceber(contaReceberVO, irpvo, matriculaPeriodo, usuarioVO));
			}
			contaReceberVO.setIndiceReajusteCalculado(Boolean.TRUE);
		}
	}
	
	public ContaReceberVO criarContaReceberParcelaExtraReajustePreco(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, PessoaVO pessoaVO, BigDecimal valor, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
 
		ContaCorrenteVO contaCorrente = new ContaCorrenteVO();

		if (configuracaoFinanceiroVO.getUsarContaCorrenteTurmaIncluida()) {
			if (!matriculaPeriodoVO.getTurma().getContaCorrente().getCodigo().equals(0)) {
				contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(matriculaPeriodoVO.getTurma().getContaCorrente().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			}
		}
		if (contaCorrente.getCodigo().equals(0)) {
			if (!matriculaPeriodoVO.getTurma().getContaCorrente().getCodigo().equals(0)) {
				contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(matriculaPeriodoVO.getTurma().getContaCorrente().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			} else if (!matriculaVO.getUnidadeEnsino().getContaCorrentePadraoMensalidade().equals(0)) {
				contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(matriculaVO.getUnidadeEnsino().getContaCorrentePadraoMensalidade(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			} else {
				contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(configuracaoFinanceiroVO.getContaCorrentePadraoMensalidade(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			}
		}

		// return criarContaReceber(matriculaPeriodoVO.getMatriculaVO(), null, pessoaVO, null, matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino(), contaCorrente, matriculaPeriodoVO.getCodigo(), tipoOrigem, dataVencimento, dataCompetencia, valor.doubleValue(), configuracaoFinanceiroVO.getCentroReceitaMensalidadePadrao(), 1, 1, null, null, matriculaPeriodoVO.getTurma(), configuracaoFinanceiroVO, usuario, null, matriculaPeriodoVO.getCodigo(), null)
		return null;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public StringBuilder getSQLExistenciaContaReceberValidasParaAplicacaoReajuste(String parcela, Date dataInicio, Date dataFim, UsuarioVO usuarioVO) {

		StringBuilder sb = new StringBuilder();
		sb.append("(select distinct case when cr.codigo is not null then true else false end AS parcelaDeveReceberReajustePreco ");
		sb.append(" from contaReceber cr where cr.matriculaaluno in(");
		sb.append(" select distinct matriculaaluno ");
		sb.append(" from indiceReajuste ");
		sb.append(" inner join turma on turma.indiceReajuste = indiceReajuste.codigo ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.turma = turma.codigo ");
		sb.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sb.append(" inner join contareceber on contareceber.matriculaperiodo = matriculaperiodo.codigo ");
		sb.append(" inner join matricula on matricula.matricula = matriculaperiodo.matricula ");
		sb.append(" inner join curso on curso.codigo = matricula.curso ");
		sb.append(" where tipoorigem = 'MEN' and condicaopagamentoplanofinanceirocurso.nrparcelasperiodo > 12 ");
		sb.append(" and turma.indiceReajuste is not null and contareceber.codigo = cr.codigo ");
		sb.append(" and curso.periodicidade = 'IN' and matricula.situacao = 'AT' ");
		sb.append(" and contareceber.situacao = 'AR'  ");
		sb.append(" and case when contareceber.parcela ilike ('%/%') and isnumeric(substring(contareceber.parcela, 0, position('/' in contareceber.parcela))) then  (substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) in(").append(parcela).append(")) else false end ");
		sb.append(" AND contaReceber.dataVencimento >= '").append(Uteis.getDataJDBC(dataInicio)).append("' ");
		sb.append(" AND contaReceber.dataVencimento <= '").append(Uteis.getDataJDBC(dataFim)).append("' ");
		sb.append(" and contareceber.codigo not in(select distinct controleremessacontareceber.contareceber from controleremessacontareceber ");
		sb.append(" where controleremessacontareceber.contareceber = contareceber.codigo)) ");
		sb.append(" and case when cr.parcela ilike ('%/%') and isnumeric((substring(cr.parcela, 1, position('/' in cr.parcela) - 1)))  then (substring(cr.parcela, 1, position('/' in cr.parcela) - 1) in (").append(parcela).append(")) else false end ");
		sb.append(" and cr.tipoorigem = 'MEN' ");
		sb.append(" and cr.situacao = 'AR' ");
		sb.append(" and cr.codigo = contareceber.codigo ");
		sb.append(") ");
		return sb;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Integer consultarNumeroMaximoParcelaCondicaoPagamentoPlanoFinanceiroCurso(Date dataInicio, Date dataFim, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append(" SELECT ");
		sb.append(" DISTINCT MAX (DISTINCT condicaopagamentoplanofinanceirocurso.nrparcelasperiodo) AS qtde ");
		sb.append(" FROM contareceber  ");
		sb.append(" INNER JOIN matriculaperiodo 						ON contareceber.matriculaperiodo 				= matriculaperiodo.codigo ");
		sb.append(" INNER JOIN condicaopagamentoplanofinanceirocurso  ON condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sb.append(" INNER JOIN matricula 								ON matricula.matricula 							= matriculaperiodo.matricula ");
		sb.append(" INNER JOIN curso 									ON curso.codigo 								= matricula.curso  ");
		sb.append(" WHERE contareceber.tipoorigem = 'MEN' AND contareceber.situacao IN ('AR') AND contaReceber.dataVencimento >= '").append(Uteis.getDataJDBC(dataInicio)).append("' AND contaReceber.dataVencimento <= '").append(Uteis.getDataJDBC(dataFim)).append("' ");
		sb.append(" AND curso.periodicidade = 'IN' AND condicaopagamentoplanofinanceirocurso.nrparcelasperiodo > 12 ");
		sb.append(" AND EXISTS ( ");
		sb.append(" SELECT 1 FROM turma  ");
		sb.append(" INNER JOIN indiceReajuste				    		ON turma.indiceReajuste 						= indiceReajuste.codigo ");
		sb.append(" INNER JOIN indiceReajustePeriodo 					ON indiceReajustePeriodo.indiceReajuste 		= indiceReajuste.codigo ");
		sb.append(" AND indiceReajustePeriodo.codigo = (SELECT indice.codigo FROM indiceReajustePeriodo indice WHERE indice.indicereajuste = indiceReajuste.codigo ORDER BY indice.data DESC,indice.codigo DESC LIMIT 1 ) ");
		sb.append(" WHERE matriculaperiodo.turma = turma.codigo ");
		sb.append(" ) ");
		sb.append(" AND NOT EXISTS ( SELECT 1  FROM controleremessacontareceber WHERE controleremessacontareceber.contareceber = contareceber.codigo) ");
		
		
		
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("qtde");
		}
		return 0;
	}

	public String inicializarDadosParcelaVerificarReajustePreco(Date dataInicio, Date dataFim, UsuarioVO usuarioVO) throws Exception {
		StringBuilder parcela = new StringBuilder();
		Integer nrPacelasPeriodo = consultarNumeroMaximoParcelaCondicaoPagamentoPlanoFinanceiroCurso(dataInicio, dataFim, usuarioVO);
		if (nrPacelasPeriodo > 12) {
			Integer qtdeVezesReajustar = nrPacelasPeriodo / 12;
			Integer parcelaInicialReajuste = 13;
			for (int i = 0; i < qtdeVezesReajustar; i++) {
				parcela.append("'").append(parcelaInicialReajuste.toString()).append("', ");
				parcelaInicialReajuste = parcelaInicialReajuste + 12;
			}
		}
		parcela.append("'0'");
		return parcela.toString();
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public ContaReceberVO consultarContaReceberProcessadaParaCancelamentoPorIndiceReajustePeriodoMatriculaPeriodoVencimento(Integer indiceReajustePeriodoMatriculaPeriodoVencimento, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("select contareceber.codigo, contareceber.matriculaaluno, contareceber.parcela, contaReceber.matriculaPeriodo, contareceber.contacorrente,  ");
		sb.append(" contareceber.datavencimento, contareceber.valor, contareceber.valorbasecontareceber, contaReceber.valorIndiceReajuste, contaReceber.tipoorigem   ");
		sb.append(" from contaReceber ");
		sb.append(" inner join indicereajusteperiodomatriculaperiodovencimento on indicereajusteperiodomatriculaperiodovencimento.matriculaperiodo = contareceber.matriculaperiodo ");
		sb.append(" and indicereajusteperiodomatriculaperiodovencimento.parcela = substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) ");
		sb.append(" inner join indicereajusteperiodo on indicereajusteperiodo.codigo = indicereajusteperiodomatriculaperiodovencimento.indicereajusteperiodo ");
		sb.append(" where indicereajusteperiodomatriculaperiodovencimento.situacao = 'PROCESSADO' ");
		sb.append(" and indicereajusteperiodomatriculaperiodovencimento.codigo = ").append(indiceReajustePeriodoMatriculaPeriodoVencimento);
		sb.append(" and contareceber.situacao = 'AR' ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		ContaReceberVO obj = new ContaReceberVO();
		if (tabelaResultado.next()) {
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getMatriculaAluno().setMatricula(tabelaResultado.getString("matriculaAluno"));
			obj.setParcela(tabelaResultado.getString("parcela"));
			obj.setMatriculaPeriodo(tabelaResultado.getInt("matriculaPeriodo"));
			obj.setDataVencimento(tabelaResultado.getDate("dataVencimento"));
			obj.setValor(tabelaResultado.getDouble("valor"));
			obj.setValorBaseContaReceber(tabelaResultado.getDouble("valorBaseContaReceber"));
			obj.setValorIndiceReajuste(tabelaResultado.getBigDecimal("valorIndiceReajuste"));
			obj.setTipoOrigem(tabelaResultado.getString("tipoorigem"));
			obj.getContaCorrenteVO().setCodigo(tabelaResultado.getInt("contacorrente"));
		}
		return obj;
	}

	public List<ContaReceberVO> consultaRapidaPorMatriculaContaReceberMatriculaMensalidadeEditadaManualmente(String matricula, Integer codMatriculaPeriodo) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE matriculaAluno = '");
		sqlStr.append(matricula);
		sqlStr.append("' ");
		sqlStr.append("AND (contareceber.tipoorigem in ('MEN', 'MAT')) ");
		sqlStr.append("and contareceber.situacao = 'AR' ");
		sqlStr.append("and contareceber.contaEditadaManualmente = TRUE ");
		sqlStr.append("and contareceber.codorigem = '");
		sqlStr.append(codMatriculaPeriodo);
		sqlStr.append("' ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(resultado);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarContasReceberMatriculaPeriodoRemovendoEditadaManualmente(String matricula, Integer codMatriculaPeriodo) throws Exception {
		final String sql = "UPDATE contaReceber set contaEditadaManualmente=FALSE "
				+ "WHERE (contareceber.matriculaAluno = ?) and (contareceber.codorigem = ?) and (contareceber.contaEditadaManualmente = TRUE) and (contareceber.tipoorigem in ('MEN', 'MAT')) and (contareceber.situacao = 'AR') ";
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection cnctn) throws SQLException {
				PreparedStatement sqlAlterar = cnctn.prepareStatement(sql);
				sqlAlterar.setString(1, matricula);
				sqlAlterar.setString(2, codMatriculaPeriodo.toString());
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirNossoNumeroContaReceber(final String nossoNumero, UsuarioVO usuario) throws Exception {
		String sql = "DELETE FROM NossoNumeroContaReceber WHERE nossonumero = '" + nossoNumero + "' " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarContasReplicandoPlanoDescontoManual(List<ContaReceberVO> listaContasReceberReplicarDesconto, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		for (ContaReceberVO objReplicar : listaContasReceberReplicarDesconto) {
			alterar(objReplicar, configuracaoFinanceiro, true, usuario);
		}
	}

	/**
	 * Monta condições para o filtro de tipo de origem.
	 * 
	 * @param filtroRelatorioFinanceiroVO
	 * @return String com os valores para o filtro de tipo de origem.
	 */
	public String montarSqlTipoOrigem(FiltroRelatorioFinanceiroVO obj) {
		StringBuilder sql = new StringBuilder(" AND contareceber.tipoorigem in ( ");

		if (obj == null) {
			return "";
		}
		int x = 0;
		if (obj.getTipoOrigemInscricaoProcessoSeletivo()) {
			sql.append("'").append(TipoOrigemContaReceber.INSCRICAO_PROCESSO_SELETIVO.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemBiblioteca()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.BIBLIOTECA.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemMatricula()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.MATRICULA.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemRequerimento()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.REQUERIMENTO.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemMensalidade()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.MENSALIDADE.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemDevolucaoCheque()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.DEVOLUCAO_CHEQUE.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemNegociacao()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.NEGOCIACAO.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemBolsaCusteadaConvenio()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.BOLSA_CUSTEADA_CONVENIO.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemContratoReceita()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.CONTRATO_RECEITA.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemOutros()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.OUTROS.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemInclusaoReposicao()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.INCLUSAOREPOSICAO.getValor()).append("' ");
			x++;
		}

		if (obj.getTipoOrigemMaterialDidatico()) {
			if(x > 0) {
				sql.append(", ");
		}
			sql.append("'").append(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor()).append("' ");
			x++;
		}

		if (x == 0 || x == 12) {
			return "";
		}
		sql.append(") ");		
		return sql.toString();
		}

	/**
	 * Monta condições para o filtro de situação.
	 * 
	 * @param situacoes
	 * @return
	 */
	private String montarSqlSituacoes(List<String> situacoes) {
		StringBuilder sql = new StringBuilder("");
		if (Uteis.isAtributoPreenchido(situacoes) && situacoes.size() < 4) {
			sql.append(" AND contareceber.situacao ");
			if(situacoes.size() == 1) {
				sql.append(" = ( ");
			}else {
				sql.append(" IN ( ");
			}
			int x = 0;
			for (String situacao : situacoes) {
				if(x > 0) {
					sql.append(", ");	
				}
				sql.append("'").append(situacao).append("' ");
				x++;
			}
			sql.append(") ");
		}
		return sql.toString();
	}

	@Override
	public HashMap<String, Double> consultaTotalContaReceber(String campoConsulta, String valorConsulta, String ano, String semestre,
			Boolean consDataCompetencia, Date dataIni, Date dataFim, List<String> situacao, Integer unidadeEnsino,
			boolean controlarAcesso, UsuarioVO usuario, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {

		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);

		StringBuilder sql = new StringBuilder("");
		sql.append(getSQLPadraoConsultaTotalGeral());
		if (campoConsulta.equals("anoSemestre")) {			
			sql.append("inner JOIN matriculaperiodo ON matriculaperiodo.matricula = matricula.matricula AND matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		}

		if (campoConsulta.equals("codigo") || campoConsulta.equals("codigobarra") || campoConsulta.equals("nossoNumero")) {
			filtroRelatorioFinanceiroVO = null;
			situacao = new ArrayList<>();
		}

		sql.append(" WHERE 1 = 1 ");

		if (campoConsulta.equals("codigo")) {
			sql.append("AND contareceber.codigo = ").append(Integer.valueOf(valorConsulta));
		}
		
		List<String> parametrosConsulta = new ArrayList<String>(0);
		if (campoConsulta.equals("nomeSacado") || campoConsulta.equals("anoSemestre")) {			
			parametrosConsulta.add("%" + valorConsulta + "%");
			sql.append(" AND (contareceber.nomesacado) ilike sem_acentos(?)");
			sql.append(getSQLPadraoConsultaBasicaPorNomeSacadoTipoPessoa());
		}

		if (campoConsulta.equals("anoSemestre")) {
			if (!ano.equals("")) {
				sql.append(" AND matriculaperiodo.ano = '").append(ano).append("'  ");
			}
			if (!semestre.equals("")) {
				sql.append(" AND matriculaperiodo.semestre = '").append(semestre).append("'  ");
			}
		}

		if (campoConsulta.equals("codigoFinanceiroMatricula")) {
			parametrosConsulta.add(valorConsulta);
			sql.append(" AND matricula.codigoFinanceiroMatricula = ? ");
		}

		if (campoConsulta.equals("nrDocumento")) {
			parametrosConsulta.add(valorConsulta + "%");
			sql.append(" AND ((contareceber.nrdocumento) LIKE (?)) ");
		}

		if (campoConsulta.equals("codigobarra")) {
			parametrosConsulta.add(valorConsulta + "%");
			sql.append(" AND ((contareceber.codigobarra) LIKE (?))");
		}

		if (campoConsulta.equals("nossoNumero")) {
			parametrosConsulta.add(valorConsulta + "%");
			sql.append(" AND (contareceber.nossoNumero LIKE ?)");
		}

		if (campoConsulta.equals("cpf")) {
			parametrosConsulta.add(valorConsulta + "%");
			parametrosConsulta.add(valorConsulta + "%");
			sql.append(" AND (UPPER(replace(replace((pessoa.cpf),'.',''),'-','')) LIKE UPPER(replace(replace((?),'.',''),'-','')) OR UPPER(replace(replace((responsavelFinanceiro.cpf),'.',''),'-','')) LIKE UPPER(replace(replace((?),'.',''),'-',''))) ");
		}

		if (campoConsulta.equals("aluno")) {
			parametrosConsulta.add(valorConsulta + "%");
			sql.append(" AND ((matricula.matricula) iLIKE (?)) ");
		}

		if (campoConsulta.equals("alunoNome")) {
			parametrosConsulta.add(valorConsulta+"%");
			sql.append(" AND (sem_acentos(pessoamatricula.nome)) iLIKE (sem_acentos(?)) ");
		}

		if (campoConsulta.equals("responsavelFinanceiro")) {
			parametrosConsulta.add(valorConsulta + "%");
			sql.append(" AND (sem_acentos(responsavelFinanceiro.nome)) iLIKE (sem_acentos(?)) ");			
		}

		if (campoConsulta.equals("funcionario")) {
			parametrosConsulta.add(valorConsulta + "%");
			sql.append(" AND ((funcionario.matricula) iLIKE (?)) ");
		}

		if (campoConsulta.equals("convenio")) {
			parametrosConsulta.add(valorConsulta + "%");			
			sql.append(" AND (sem_acentos(convenio.descricao)) iLIKE (sem_acentos(?)) ");
		}

		if (campoConsulta.equals("fornecedor")) {
			parametrosConsulta.add(valorConsulta + "%");
			sql.append(" AND sem_acentos(fornecedor.nome) iLIKE sem_acentos(?) ");
		}

		if (campoConsulta.equals("identificadorCentroReceitaCentroReceita")) {
			parametrosConsulta.add(valorConsulta.toUpperCase() + "%");
			sql.append(" AND (UPPER(centroreceita.descricao) LIKE sem_acentos(?)) ");
		}

		if (unidadeEnsino.intValue() != 0) {
			sql.append(" AND (contareceber.unidadeensinofinanceira = ").append(unidadeEnsino).append(") ");
		}else if (usuario.getTipoUsuario().equals("FU")) {
			sql.append("and ContaReceber.unidadeensinofinanceira in (select unidadeensino from usuarioperfilacesso where usuario =").append(usuario.getCodigo()).append(")");
		}

		if (!campoConsulta.equals("codigo") && !campoConsulta.equals("codigobarra") && !campoConsulta.equals("nossoNumero") && !campoConsulta.equals("anoSemestre") && !campoConsulta.equals("nrDocumento")) {
			if (!consDataCompetencia) {
				sql.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
			} else {
				sql.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
			}
		}

		if (!campoConsulta.equals("codigo") && !campoConsulta.equals("codigobarra") && !campoConsulta.equals("nossoNumero")) {
			sql.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		}

		if (situacao != null) {
			if (!campoConsulta.equals("codigo") && !campoConsulta.equals("codigobarra") && !campoConsulta.equals("nossoNumero") && !campoConsulta.equals("nrDocumento")) {
				sql.append(montarSqlSituacoes(situacao));
			}
		}
		SqlRowSet resultado = null;
		if (campoConsulta.equals("codigo") && parametrosConsulta.isEmpty()) {
			resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		} else {
			resultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), parametrosConsulta.toArray());
		}
		HashMap<String, Double> totalReceberTotalRecebido = new HashMap<String, Double>(0);
		if (resultado.next()) {
			totalReceberTotalRecebido.put("valorAReceber", resultado.getDouble("valorAReceber"));
			totalReceberTotalRecebido.put("valorRecebido", resultado.getDouble("valorRecebido"));
			totalReceberTotalRecebido.put("valorCancelado", resultado.getDouble("valorCancelado"));
			totalReceberTotalRecebido.put("valorNegociado", resultado.getDouble("valorNegociado"));
			totalReceberTotalRecebido.put("qtde", resultado.getDouble("qtde"));
			return totalReceberTotalRecebido;
		} else {
			totalReceberTotalRecebido.put("valorAReceber", 0.0);
			totalReceberTotalRecebido.put("valorRecebido", 0.0);
			totalReceberTotalRecebido.put("valorCancelado", 0.0);
			totalReceberTotalRecebido.put("valorNegociado", 0.0);
			totalReceberTotalRecebido.put("qtde", 0.0);
			return totalReceberTotalRecebido;
		}
	}

	private StringBuilder getSQLPadraoConsultaTotalGeral() {
		StringBuilder sql = new StringBuilder();
		sql.append("SELECT sum(case when contareceber.situacao = 'AR' then contareceber.valor else 0.0 end ) as valorAReceber,");
		sql.append(" sum(case when contareceber.situacao = 'RE' then contareceber.valorRecebido else 0.0 end ) as valorRecebido,");
		sql.append(" sum(case when contareceber.situacao = 'CF' then contareceber.valor else 0.0 end ) as valorCancelado,");
		sql.append(" sum(case when contareceber.situacao = 'NE' then contareceber.valor else 0.0 end ) as valorNegociado,");
		sql.append(" count(contareceber.codigo) as qtde ");
		sql.append(getSQLPadraoConsultaBasicaFrom());
		return sql;
	}


	@Override
	public ContaReceberVO realizarCalculoValorOriginalContaReceberUtilizandoMetodoEspirita(Integer codigoContaReceber) throws Exception {
		if(codigoContaReceber.intValue() == 0){
			throw new Exception("Informe a conta receber!");
		}
		UsuarioVO usuario = new UsuarioVO();
		StringBuilder sql = new StringBuilder(getSQLPadraoConsultaCompletaSemContaReceberRecebimento());
		sql.append(" WHERE contareceber.codigo = ").append(codigoContaReceber);
		SqlRowSet dadosSQL = null;
		try {
			dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
			if (dadosSQL.next()) {
				ContaReceberVO obj = new ContaReceberVO();
				montarDadosBasico(obj, dadosSQL);
				obj.setData(dadosSQL.getDate("data"));
				obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
				obj.getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
				obj.setCodOrigem(dadosSQL.getString("codorigem"));
				obj.setTipoOrigem(dadosSQL.getString("tipoorigem"));
				obj.setDescricaoPagamento(dadosSQL.getString("descricaopagamento"));
				obj.setValorRecebido(dadosSQL.getDouble("valorrecebido"));
				obj.setJuroPorcentagem(dadosSQL.getDouble("juroporcentagem"));
				obj.setJuro(dadosSQL.getDouble("juro"));
				obj.setMultaPorcentagem(dadosSQL.getDouble("multaporcentagem"));
				obj.setMulta(dadosSQL.getDouble("multa"));
				obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
				obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhadigitavelcodigobarras"));
				obj.setContaCorrente(dadosSQL.getInt("contacorrente"));
				obj.getCentroReceita().setCodigo(dadosSQL.getInt("centroreceita"));
				obj.getCentroReceita().setDescricao(dadosSQL.getString("CentroReceita.descricao"));
				obj.setTipoBoleto(dadosSQL.getString("tipoboleto"));
				obj.getConvenio().setCodigo(dadosSQL.getInt("convenio"));
				obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaperiodo"));
				obj.setDataArquivoRemessa(dadosSQL.getDate("dataArquivoRemessa"));
				obj.setContaReceberAgrupada(dadosSQL.getInt("contaReceberAgrupada"));
				obj.getRenegociacaoContaReceberOrigem().setCodigo(dadosSQL.getInt("codigoRenegociacao"));

				obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor.codigo"));
				obj.getFornecedor().setNome(dadosSQL.getString("fornecedor.nome"));
				obj.getFornecedor().setRG(dadosSQL.getString("fornecedor.rg"));
				obj.getFornecedor().setCPF(dadosSQL.getString("fornecedor.cpf"));
				obj.getFornecedor().setCNPJ(dadosSQL.getString("fornecedor.cnpj"));
				obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("fornecedor.tipoEmpresa"));

				obj.setDuplicidadeTratada(dadosSQL.getBoolean("duplicidadeTratada"));
				obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
				obj.getTurma().setIdentificadorTurma(dadosSQL.getString("identificadorTurma"));

				// obj.setDescontoProgressivoUtilizado(dadosSQL.getString("descontoprogressivoutilizado"));

				obj.setOrigemNegociacaoReceber(dadosSQL.getInt("origemnegociacaoreceber"));
				obj.setCodigoBarra(dadosSQL.getString("codigobarra"));
				obj.setNossoNumero(dadosSQL.getString("nossonumero"));
				obj.setTituloImportadoSistemaLegado(dadosSQL.getBoolean("tituloImportadoSistemaLegado"));
				obj.setRecebimentoBancario((Boolean) dadosSQL.getObject("recebimentoBancario"));
				// Dados do Desconto Progressivo
				obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoprogressivo"));
				obj.setDescontoProgressivoUtilizado(FaixaDescontoProgressivo.getEnum(dadosSQL.getString("descontoprogressivoutilizado")));
				obj.getDescontoProgressivo().setNome(dadosSQL.getString("descontoprogressivo.nome"));
				obj.getDescontoProgressivo().setDiaLimite1(dadosSQL.getInt("descontoprogressivo.dialimite1"));
				obj.getDescontoProgressivo().setDiaLimite2(dadosSQL.getInt("descontoprogressivo.dialimite2"));
				obj.getDescontoProgressivo().setDiaLimite3(dadosSQL.getInt("descontoprogressivo.dialimite3"));
				obj.getDescontoProgressivo().setDiaLimite4(dadosSQL.getInt("descontoprogressivo.dialimite4"));
				obj.getDescontoProgressivo().setPercDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.percdescontolimite1"));
				obj.getDescontoProgressivo().setPercDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.percdescontolimite2"));
				obj.getDescontoProgressivo().setPercDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.percdescontolimite3"));
				obj.getDescontoProgressivo().setPercDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.percdescontolimite4"));			
				obj.getDescontoProgressivo().setValorDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.valordescontolimite1"));
				obj.getDescontoProgressivo().setValorDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.valordescontolimite2"));
				obj.getDescontoProgressivo().setValorDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.valordescontolimite3"));
				obj.getDescontoProgressivo().setValorDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.valordescontolimite4"));
				obj.getDescontoProgressivo().setUtilizarDiaFixo(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaFixo"));
				obj.getDescontoProgressivo().setUtilizarDiaUtil(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaUtil"));
				obj.setContaEditadaManualmente(dadosSQL.getBoolean("contaEditadaManualmente"));
				obj.setUtilizarDescontoProgressivoManual(dadosSQL.getBoolean("utilizarDescontoProgressivoManual"));
				if (obj.getUtilizarDescontoProgressivoManual()) {
					obj.setDiaLimite1(dadosSQL.getInt("diaLimite1"));
					obj.setDiaLimite2(dadosSQL.getInt("diaLimite2"));
					obj.setDiaLimite3(dadosSQL.getInt("diaLimite3"));
					obj.setDiaLimite4(dadosSQL.getInt("diaLimite4"));
				}
				if (obj.getUtilizarDescontoProgressivoManual()) {
					obj.getDescontoProgressivo().setDescontoProgressivoEditadoManualmenteContaReceber(Boolean.TRUE);
					obj.getDescontoProgressivo().setDiaLimite1(obj.getDiaLimite1());
					obj.getDescontoProgressivo().setDiaLimite2(obj.getDiaLimite2());
					obj.getDescontoProgressivo().setDiaLimite3(obj.getDiaLimite3());
					obj.getDescontoProgressivo().setDiaLimite4(obj.getDiaLimite4());
				}
				// TODO Alberto 08/12/10 acrescentado valor fixo
				// desconto
				// progressivo
				// Desconto Lançado Recebimento
				obj.setValorDescontoLancadoRecebimento(dadosSQL.getDouble("valorDescontoLancadoRecebimento"));
				obj.setValorCalculadoDescontoLancadoRecebimento(dadosSQL.getDouble("valorCalculadoDescontoLancadoRecebimento"));
				obj.setTipoDescontoLancadoRecebimento(dadosSQL.getString("tipoDescontoLancadoRecebimento"));
				// montar dados plano desconto
				obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
				obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
				obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
				obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
				obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
				obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
				obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
				obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
				obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
				obj.setTipoDesconto(dadosSQL.getString("tipodesconto"));
				obj.setValorDescontoRecebido(dadosSQL.getDouble("valordescontorecebido"));
				obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
				obj.setValorCusteadoContaReceber(dadosSQL.getDouble("valorCusteadoContaReceber"));
				obj.setValorBaseContaReceber(dadosSQL.getDouble("valorBaseContaReceber"));
				obj.setJustificativaDesconto(dadosSQL.getString("justificativaDesconto"));
				obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
				obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));
				obj.getMatriculaAluno().getPlanoFinanceiroAluno().setDescontoValidoAteDataParcela(dadosSQL.getBoolean("planofinanceiroaluno.descontoValidoAteDataParcela"));
				obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeEnsino"));
//				obj.getUnidadeEnsino().getCidade().setCodigo(dadosSQL.getInt("cidade"));
				ConfiguracaoFinanceiroVO conf = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarPorUnidadeEnsino(obj.getUnidadeEnsino().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				obj.setRealizandoRecebimento(Boolean.TRUE);
				obj.setTelaEdicaoContaReceber(Boolean.TRUE);
				if (conf.getVencimentoParcelaDiaUtil()) {
					obj.getDataOriginalVencimento();
					obj.setDataVencimentoDiaUtil(obj.getDataVencimento());
					obj.setDataVencimentoDiaUtil(obterDataVerificandoDiaUtil(obj.getDataVencimento(), obj.getUnidadeEnsino().getCidade().getCodigo(), null));
					obj.setDataVencimento(obj.getDataVencimentoDiaUtil());
				}
				Calendar cal = Calendar.getInstance();
				cal.setTime(obj.getDataVencimento());
				cal.add(Calendar.YEAR, -1);
				Date dataReceber = cal.getTime();
				obj.setSituacao("AR");
				obj.setValorRecebido(obj.getCalcularValorFinal(dataReceber, conf, false, dataReceber, usuario));
				return obj;
			} else {
				throw new Exception("Conta Receber não encontrada!");
			}
		} catch (Exception e) {
			throw e;
		} finally {
			usuario = null;
			dadosSQL = null;
			sql = null;
		}
	}

	@Override
	public void realizarAtualizacaoValorDescontoFaixaContaReceber(ContaReceberVO contaReceberVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, boolean forcarCalculoDescontos) throws Exception {
		if (forcarCalculoDescontos) {
			contaReceberVO.getCalcularValorFinal(null, configuracaoFinanceiroVO, false, null);
		}
		if (!contaReceberVO.getListaDescontosAplicavesContaReceber().isEmpty() && contaReceberVO.getListaDescontosAplicavesContaReceber().size() >= 1) {
			contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getListaDescontosAplicavesContaReceber().get(0).executarCalculoValorParaPagamentoDentroDataLimiteDesconto());
			if(!contaReceberVO.getListaDescontosAplicavesContaReceber().get(0).executarCalculoValorParaPagamentoDentroDataLimiteDesconto().equals(contaReceberVO.getValor())) {
				contaReceberVO.setDataLimitePrimeiraFaixaDescontos(contaReceberVO.getListaDescontosAplicavesContaReceber().get(0).getDataLimiteAplicacaoDesconto());
			}
		} else {
			contaReceberVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(contaReceberVO.getValor());
			contaReceberVO.setDataLimitePrimeiraFaixaDescontos(null);
		}
		if (!contaReceberVO.getListaDescontosAplicavesContaReceber().isEmpty() && contaReceberVO.getListaDescontosAplicavesContaReceber().size() >= 2) {
			contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getListaDescontosAplicavesContaReceber().get(1).executarCalculoValorParaPagamentoDentroDataLimiteDesconto());
			if(!contaReceberVO.getListaDescontosAplicavesContaReceber().get(1).executarCalculoValorParaPagamentoDentroDataLimiteDesconto().equals(contaReceberVO.getValor())) {
				contaReceberVO.setDataLimiteSegundaFaixaDescontos(contaReceberVO.getListaDescontosAplicavesContaReceber().get(1).getDataLimiteAplicacaoDesconto());
			}
		} else {
			contaReceberVO.setValorDescontoCalculadoSegundaFaixaDescontos(contaReceberVO.getValor());
			contaReceberVO.setDataLimiteSegundaFaixaDescontos(null);
		}
		if (!contaReceberVO.getListaDescontosAplicavesContaReceber().isEmpty() && contaReceberVO.getListaDescontosAplicavesContaReceber().size() >= 3) {
			contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getListaDescontosAplicavesContaReceber().get(2).executarCalculoValorParaPagamentoDentroDataLimiteDesconto());
			if(!contaReceberVO.getListaDescontosAplicavesContaReceber().get(2).executarCalculoValorParaPagamentoDentroDataLimiteDesconto().equals(contaReceberVO.getValor())) {
				contaReceberVO.setDataLimiteTerceiraFaixaDescontos(contaReceberVO.getListaDescontosAplicavesContaReceber().get(2).getDataLimiteAplicacaoDesconto());
			}
		} else {
			contaReceberVO.setValorDescontoCalculadoTerceiraFaixaDescontos(contaReceberVO.getValor());
			contaReceberVO.setDataLimiteTerceiraFaixaDescontos(null);
		}
		if (!contaReceberVO.getListaDescontosAplicavesContaReceber().isEmpty() && contaReceberVO.getListaDescontosAplicavesContaReceber().size() >= 4) {
			contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getListaDescontosAplicavesContaReceber().get(3).executarCalculoValorParaPagamentoDentroDataLimiteDesconto());
			if(!contaReceberVO.getListaDescontosAplicavesContaReceber().get(3).executarCalculoValorParaPagamentoDentroDataLimiteDesconto().equals(contaReceberVO.getValor())) {
				contaReceberVO.setDataLimiteQuartaFaixaDescontos(contaReceberVO.getListaDescontosAplicavesContaReceber().get(3).getDataLimiteAplicacaoDesconto());
			}
		} else {
			contaReceberVO.setValorDescontoCalculadoQuartaFaixaDescontos(contaReceberVO.getValor());
			contaReceberVO.setDataLimiteQuartaFaixaDescontos(null);
		}
	}

	@Override
	public Boolean realizarVerificacaoAlunoPossuiContaAReceberVinculadoUnidadeEnsinoFinanceira(String matricula, Integer unidadeEnsino) {		
		return getConexao().getJdbcTemplate().queryForRowSet("select codigo from contareceber where situacao = 'AR' and matriculaaluno = ? and unidadeensinofinanceira = ? limit 1", matricula, unidadeEnsino).next();
	}
	
	
	@Override
	public void realizarGeracaoDetalhamentoValorContaRecebidaNegociacadaCancelada(Integer nrAnosProcessar, List<ContaReceberVO> contaReceberProcessar, String competencia) throws Exception {		
		UsuarioVO usuario = new UsuarioVO();
		StringBuilder sql = new StringBuilder(getSQLPadraoConsultaCompletaSemContaReceberRecebimento());		
		sql.append(" WHERE contareceber.situacao in ('RE', 'CF', 'NE') ");
		sql.append(" and not exists (select detalhamentovalorconta.codigo from detalhamentovalorconta where detalhamentovalorconta.origemDetalhamentoConta = 'CONTA_RECEBER' and detalhamentovalorconta.codigoorigem  = contareceber.codigo limit 1) ");
		if (nrAnosProcessar != null && nrAnosProcessar > 0 && (contaReceberProcessar == null || contaReceberProcessar.isEmpty())) {
			sql.append(" and  contareceber.datavencimento::DATE >= (current_date - '").append(nrAnosProcessar).append(" year'::INTERVAL) ");
		}
		if (contaReceberProcessar != null && !contaReceberProcessar.isEmpty()) {
			sql.append(" and contareceber.codigo in (0 ");
			for (ContaReceberVO obj : contaReceberProcessar) {
				sql.append(", ").append(obj.getCodigo());
			}
			sql.append(") ");
		}
		if(Uteis.isAtributoPreenchido(competencia)){
			sql.append(" and (to_char(contareceber.datacompetencia, 'MM/YYYY') = '").append(competencia).append("' ");
			sql.append(" or (select negociacaorecebimento.data::DATE as data from contarecebernegociacaorecebimento	 "); 
			sql.append(" inner join negociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo	 "); 
			sql.append(" where contarecebernegociacaorecebimento.contareceber = contareceber.codigo and to_char(negociacaorecebimento.data::DATE, 'MM/YYYY') = '").append(competencia).append("'  and contareceber.situacao = 'RE') is not null ");
			sql.append(" or (select negociacaocontareceber.data::DATE as data from contarecebernegociado	 ");
			sql.append(" inner join negociacaocontareceber on contarecebernegociado.negociacaocontareceber = negociacaocontareceber.codigo"); 
			sql.append(" where contarecebernegociado.contareceber = contareceber.codigo and to_char(negociacaocontareceber.data::DATE, 'MM/YYYY') = '").append(competencia).append("' and contareceber.situacao = 'NE') is not null ");
			sql.append(" ) ");
		}
		sql.append(" order by contareceber.dataVencimento desc limit 1000");
		Map<Integer, ConfiguracaoFinanceiroVO> configuracaoFinanceiroMap = new HashMap<Integer, ConfiguracaoFinanceiroVO>(0);
		SqlRowSet dadosSQL = null;
		try {
			dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
			while (dadosSQL.next()) {
				do {
					ContaReceberVO obj = new ContaReceberVO();
					try {

						montarDadosBasico(obj, dadosSQL);
						obj.setData(dadosSQL.getDate("data"));
						obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
						obj.getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
						obj.setCodOrigem(dadosSQL.getString("codorigem"));
						obj.setTipoOrigem(dadosSQL.getString("tipoorigem"));
						obj.setDescricaoPagamento(dadosSQL.getString("descricaopagamento"));
						obj.setValorRecebido(dadosSQL.getDouble("valorrecebido"));
						obj.setJuroPorcentagem(dadosSQL.getDouble("juroporcentagem"));
						obj.setJuro(dadosSQL.getDouble("juro"));
						obj.setMultaPorcentagem(dadosSQL.getDouble("multaporcentagem"));
						obj.setMulta(dadosSQL.getDouble("multa"));
						obj.setAcrescimo(dadosSQL.getDouble("acrescimo"));
						obj.setLinhaDigitavelCodigoBarras(dadosSQL.getString("linhadigitavelcodigobarras"));
						obj.setContaCorrente(dadosSQL.getInt("contacorrente"));
						obj.getCentroReceita().setCodigo(dadosSQL.getInt("centroreceita"));
						obj.getCentroReceita().setDescricao(dadosSQL.getString("CentroReceita.descricao"));
						obj.setTipoBoleto(dadosSQL.getString("tipoboleto"));
						obj.getConvenio().setCodigo(dadosSQL.getInt("convenio"));
						obj.setMatriculaPeriodo(dadosSQL.getInt("matriculaperiodo"));
						obj.setDataArquivoRemessa(dadosSQL.getDate("dataArquivoRemessa"));
						obj.setContaReceberAgrupada(dadosSQL.getInt("contaReceberAgrupada"));
						obj.getRenegociacaoContaReceberOrigem().setCodigo(dadosSQL.getInt("codigoRenegociacao"));

						obj.getFornecedor().setCodigo(dadosSQL.getInt("fornecedor.codigo"));
						obj.getFornecedor().setNome(dadosSQL.getString("fornecedor.nome"));
						obj.getFornecedor().setRG(dadosSQL.getString("fornecedor.rg"));
						obj.getFornecedor().setCPF(dadosSQL.getString("fornecedor.cpf"));
						obj.getFornecedor().setCNPJ(dadosSQL.getString("fornecedor.cnpj"));
						obj.getFornecedor().setTipoEmpresa(dadosSQL.getString("fornecedor.tipoEmpresa"));

						obj.setDuplicidadeTratada(dadosSQL.getBoolean("duplicidadeTratada"));
						obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
						obj.getTurma().setIdentificadorTurma(dadosSQL.getString("identificadorTurma"));

						// obj.setDescontoProgressivoUtilizado(dadosSQL.getString("descontoprogressivoutilizado"));

						obj.setOrigemNegociacaoReceber(dadosSQL.getInt("origemnegociacaoreceber"));
						obj.setCodigoBarra(dadosSQL.getString("codigobarra"));
						obj.setNossoNumero(dadosSQL.getString("nossonumero"));
						obj.setTituloImportadoSistemaLegado(dadosSQL.getBoolean("tituloImportadoSistemaLegado"));
						obj.setRecebimentoBancario((Boolean) dadosSQL.getObject("recebimentoBancario"));
						// Dados do Desconto Progressivo
						obj.getDescontoProgressivo().setCodigo(dadosSQL.getInt("descontoprogressivo"));
						obj.setDescontoProgressivoUtilizado(FaixaDescontoProgressivo.getEnum(dadosSQL.getString("descontoprogressivoutilizado")));
						obj.getDescontoProgressivo().setNome(dadosSQL.getString("descontoprogressivo.nome"));
						obj.getDescontoProgressivo().setDiaLimite1(dadosSQL.getInt("descontoprogressivo.dialimite1"));
						obj.getDescontoProgressivo().setDiaLimite2(dadosSQL.getInt("descontoprogressivo.dialimite2"));
						obj.getDescontoProgressivo().setDiaLimite3(dadosSQL.getInt("descontoprogressivo.dialimite3"));
						obj.getDescontoProgressivo().setDiaLimite4(dadosSQL.getInt("descontoprogressivo.dialimite4"));						
						obj.getDescontoProgressivo().setPercDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.percdescontolimite1"));
						obj.getDescontoProgressivo().setPercDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.percdescontolimite2"));
						obj.getDescontoProgressivo().setPercDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.percdescontolimite3"));
						obj.getDescontoProgressivo().setPercDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.percdescontolimite4"));			
						obj.getDescontoProgressivo().setValorDescontoLimite1(dadosSQL.getDouble("descontoprogressivo.valordescontolimite1"));
						obj.getDescontoProgressivo().setValorDescontoLimite2(dadosSQL.getDouble("descontoprogressivo.valordescontolimite2"));
						obj.getDescontoProgressivo().setValorDescontoLimite3(dadosSQL.getDouble("descontoprogressivo.valordescontolimite3"));
						obj.getDescontoProgressivo().setValorDescontoLimite4(dadosSQL.getDouble("descontoprogressivo.valordescontolimite4"));
						obj.getDescontoProgressivo().setUtilizarDiaFixo(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaFixo"));
						obj.getDescontoProgressivo().setUtilizarDiaUtil(dadosSQL.getBoolean("descontoprogressivo.utilizarDiaUtil"));
						obj.setContaEditadaManualmente(dadosSQL.getBoolean("contaEditadaManualmente"));
						obj.setUtilizarDescontoProgressivoManual(dadosSQL.getBoolean("utilizarDescontoProgressivoManual"));
						if (obj.getUtilizarDescontoProgressivoManual()) {
							obj.setDiaLimite1(dadosSQL.getInt("diaLimite1"));
							obj.setDiaLimite2(dadosSQL.getInt("diaLimite2"));
							obj.setDiaLimite3(dadosSQL.getInt("diaLimite3"));
							obj.setDiaLimite4(dadosSQL.getInt("diaLimite4"));
						}
						if (obj.getUtilizarDescontoProgressivoManual()) {
							obj.getDescontoProgressivo().setDescontoProgressivoEditadoManualmenteContaReceber(Boolean.TRUE);
							obj.getDescontoProgressivo().setDiaLimite1(obj.getDiaLimite1());
							obj.getDescontoProgressivo().setDiaLimite2(obj.getDiaLimite2());
							obj.getDescontoProgressivo().setDiaLimite3(obj.getDiaLimite3());
							obj.getDescontoProgressivo().setDiaLimite4(obj.getDiaLimite4());
						}
						// TODO Alberto 08/12/10 acrescentado valor fixo
						// desconto
						// progressivo
						// Desconto Lançado Recebimento
						obj.setValorDescontoLancadoRecebimento(dadosSQL.getDouble("valorDescontoLancadoRecebimento"));
						obj.setValorCalculadoDescontoLancadoRecebimento(dadosSQL.getDouble("valorCalculadoDescontoLancadoRecebimento"));
						obj.setTipoDescontoLancadoRecebimento(dadosSQL.getString("tipoDescontoLancadoRecebimento"));
						// montar dados plano desconto
						obj.setPlanoDescontoContaReceberVOs(getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario));
						obj.setListaCentroResultadoOrigem(getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().consultaRapidaPorCodOrigemPorTipoCentroResultadoOrigemEnum(obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
						obj.setDetalhamentoValorContaVOs(getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().consultaRapidaPorOrigemCodigoOrigemConta(OrigemDetalhamentoContaEnum.CONTA_RECEBER, obj.getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
						obj.setOrdemConvenio(dadosSQL.getInt("ordemConvenio"));
						obj.setOrdemConvenioValorCheio(dadosSQL.getBoolean("OrdemConvenioValorCheio"));
						obj.setOrdemDescontoAluno(dadosSQL.getInt("OrdemDescontoAluno"));
						obj.setOrdemDescontoAlunoValorCheio(dadosSQL.getBoolean("OrdemDescontoAlunoValorCheio"));
						obj.setOrdemDescontoProgressivo(dadosSQL.getInt("OrdemDescontoProgressivo"));
						obj.setOrdemDescontoProgressivoValorCheio(dadosSQL.getBoolean("OrdemDescontoProgressivoValorCheio"));
						obj.setOrdemPlanoDesconto(dadosSQL.getInt("OrdemPlanoDesconto"));
						obj.setOrdemPlanoDescontoValorCheio(dadosSQL.getBoolean("OrdemPlanoDescontoValorCheio"));
						obj.setTipoDesconto(dadosSQL.getString("tipodesconto"));
						obj.setValorDescontoRecebido(dadosSQL.getDouble("valordescontorecebido"));
						obj.setValorDesconto(dadosSQL.getDouble("valorDesconto"));
						obj.setValorCusteadoContaReceber(dadosSQL.getDouble("valorCusteadoContaReceber"));
						obj.setValorBaseContaReceber(dadosSQL.getDouble("valorBaseContaReceber"));
						obj.setJustificativaDesconto(dadosSQL.getString("justificativaDesconto"));
						obj.setValorDescontoAlunoJaCalculado(dadosSQL.getDouble("valorDescontoAlunoJaCalculado"));
						obj.setImpressaoBoletoRealizada(dadosSQL.getBoolean("impressaoBoletoRealizada"));
						obj.getMatriculaAluno().getPlanoFinanceiroAluno().setDescontoValidoAteDataParcela(dadosSQL.getBoolean("planofinanceiroaluno.descontoValidoAteDataParcela"));

						obj.getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeEnsino"));
						obj.getUnidadeEnsino().getCidade().setCodigo(dadosSQL.getInt("cidade"));
						if (!configuracaoFinanceiroMap.containsKey(obj.getUnidadeEnsino().getCodigo())) {
							configuracaoFinanceiroMap.put(obj.getUnidadeEnsino().getCodigo(), getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarPorUnidadeEnsino(obj.getUnidadeEnsino().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
						}
						obj.setRealizandoRecebimento(false);
						obj.setTelaEdicaoContaReceber(true);
						if (configuracaoFinanceiroMap.get(obj.getUnidadeEnsino().getCodigo()).getVencimentoParcelaDiaUtil()) {
							obj.getDataOriginalVencimento();
							obj.setDataVencimentoDiaUtil(obj.getDataVencimento());
							obj.setDataVencimentoDiaUtil(getFacadeFactory().getContaReceberFacade().obterDataVerificandoDiaUtil(obj.getDataVencimento(), obj.getUnidadeEnsino().getCidade().getCodigo(), null));
							obj.setDataVencimento(obj.getDataVencimentoDiaUtil());
						}		
						
						StringBuilder sqlDataBase = new StringBuilder("");
						String situacaoAnterior = obj.getSituacao(); 
						if(obj.getSituacao().equals("RE")) {
							sqlDataBase.append("select negociacaorecebimento.data::DATE as data from contarecebernegociacaorecebimento	 ");							
							sqlDataBase.append("inner join negociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo	 ");
							sqlDataBase.append("where contarecebernegociacaorecebimento.contareceber = ").append(obj.getCodigo()).append(" ");
						}else if (obj.getSituacao().equals("NE")) {						
							sqlDataBase.append("select negociacaocontareceber.data::DATE as data from contarecebernegociado	 ");							
							sqlDataBase.append("inner join negociacaocontareceber on contarecebernegociado.negociacaocontareceber = negociacaocontareceber.codigo	 ");
							sqlDataBase.append("where contarecebernegociado.contareceber = ").append(obj.getCodigo()).append("	 ");
						}else {						
							sqlDataBase.append("select contareceber.datacancelamento::DATE as data from contareceber	 ");
							sqlDataBase.append("where contareceber.codigo = ").append(obj.getCodigo()).append(" ");
							sqlDataBase.append("and datacancelamento is not null	 ");
						}
						Date dataReceber =  obj.getDataVencimento();
						SqlRowSet rsData = getConexao().getJdbcTemplate().queryForRowSet(sqlDataBase.toString());
						if(rsData.next()) {
							dataReceber = rsData.getDate("data");
						}
						obj.setSituacao("AR");
						obj.setValorRecebido(obj.getCalcularValorFinal(dataReceber, configuracaoFinanceiroMap.get(obj.getUnidadeEnsino().getCodigo()), false, dataReceber, usuario));						
						obj.setSituacao(situacaoAnterior);
						getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().geracaoCentroResultadoOrigemPadraoPorContaReceber(obj, true, usuario);
						getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().realizarProcessamentoDeAtualizacaoDetalhamentoValorContaReceber(obj, dataReceber, configuracaoFinanceiroMap.get(obj.getUnidadeEnsino().getCodigo()), usuario);
						for (CentroResultadoOrigemVO cro : obj.getListaCentroResultadoOrigem()) {
							if(!Uteis.isAtributoPreenchido(cro)){
								cro.calcularValor(obj.getValorReceberCalculado());							
								getFacadeFactory().getCentroResultadoOrigemInterfaceFacade().persistir(cro, obj.getCodigo().toString(), TipoCentroResultadoOrigemEnum.CONTA_RECEBER, false, false, usuario, false);	
							}
						}
												
					} catch (Exception e) {
						//System.out.println("NAO FOI POSSIVEL ATUALIZAR PRIMERIA FAIXA DESCONTO CONTA A RECEBER" + obj.toString() + "(" + e.getMessage() + ")");						
					} finally {
						obj = null;
					}
				} while (dadosSQL.next());
				if (contaReceberProcessar != null && !contaReceberProcessar.isEmpty()) {
					break;
				}
				dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
			}
		} catch (Exception e) {
			throw e;
		} finally {
			usuario = null;			
			configuracaoFinanceiroMap = null;
			dadosSQL = null;
			
		}

	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void persistirDetalhamentoValorContaReceber(ContaReceberVO contaReceberVO, ConfiguracaoFinanceiroVO conf, UsuarioVO usuarioVO) throws Exception{
		getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().validarGeracaoCentroResultadoOrigemDetalhePadrao(contaReceberVO, conf, usuarioVO);
		StringBuilder sql  =  new StringBuilder("delete from detalhamentovalorconta where origemDetalhamentoConta = ? and codigoorigem = ? ");
		sql.append(" and codigo not in (0 ");	
		for(DetalhamentoValorContaVO detalhamentoValorContaVO: contaReceberVO.getDetalhamentoValorContaVOs()) {
			detalhamentoValorContaVO.setCodigoOrigem(contaReceberVO.getCodigo());
			detalhamentoValorContaVO.setOrigemDetalhamentoConta(OrigemDetalhamentoContaEnum.CONTA_RECEBER);
			if(Uteis.isAtributoPreenchido(detalhamentoValorContaVO)){
				sql.append(", ").append(detalhamentoValorContaVO.getCodigo());
			}
		}
		sql.append(") "); 
		sql.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
		getConexao().getJdbcTemplate().update(sql.toString(), OrigemDetalhamentoContaEnum.CONTA_RECEBER.name(), contaReceberVO.getCodigo());
		getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().persistir(contaReceberVO.getDetalhamentoValorContaVOs(), false, usuarioVO);
	}
	
	
	public Boolean realizarValidacaoContaReceberAptaRealizarNegociacaoAutomaticamente(Integer codigoContaReceber) throws Exception {
		StringBuilder sql  =  new StringBuilder("select contareceber.codigo from contareceber ");
		sql.append(" inner join contacorrente on contacorrente.codigo = contareceber.contacorrente ");
		sql.append(" where contacorrente.contacaixa = false and contacorrente.realizarNegociacaoContaReceberVencidaAutomaticamente ");
		sql.append(" and contareceber.situacao = 'AR' and contareceber.codigo = ").append(codigoContaReceber);
		sql.append(" and (contareceber.datavencimento + (contacorrente.numeroDiaVencidoNegociarContaReceberAutomaticamente||' day')::interval) <= current_date ");
		sql.append(" and contareceber.tipoorigem != '").append(TipoOrigemContaReceber.REQUERIMENTO.getValor()).append("' ");
		sql.append(" and contareceber.tipoorigem != '").append(TipoOrigemContaReceber.INSCRICAO_PROCESSO_SELETIVO.getValor()).append("' ");
		sql.append(" and ( (contareceber.tipoorigem = '").append(TipoOrigemContaReceber.BIBLIOTECA.getValor()).append("' and contacorrente.tipoOrigemBiblioteca ) ");
		sql.append(" or (contareceber.tipoorigem = '").append(TipoOrigemContaReceber.BOLSA_CUSTEADA_CONVENIO.getValor()).append("' and contacorrente.tipoOrigemBolsaCusteadaConvenio ) ");
		sql.append(" or (contareceber.tipoorigem = '").append(TipoOrigemContaReceber.CONTRATO_RECEITA.getValor()).append("' and contacorrente.tipoOrigemContratoReceita ) ");
		sql.append(" or (contareceber.tipoorigem = '").append(TipoOrigemContaReceber.DEVOLUCAO_CHEQUE.getValor()).append("' and contacorrente.tipoOrigemDevolucaoCheque ) ");
		sql.append(" or (contareceber.tipoorigem = '").append(TipoOrigemContaReceber.INCLUSAOREPOSICAO.getValor()).append("' and contacorrente.tipoOrigemInclusaoReposicao ) ");
		sql.append(" or (contareceber.tipoorigem = '").append(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor()).append("' and contacorrente.tipoOrigemMaterialDidatico ) ");
		sql.append(" or (contareceber.tipoorigem = '").append(TipoOrigemContaReceber.MATRICULA.getValor()).append("' and contacorrente.tipoOrigemMatricula ) ");
		sql.append(" or (contareceber.tipoorigem = '").append(TipoOrigemContaReceber.MENSALIDADE.getValor()).append("' and contacorrente.tipoOrigemMensalidade ) ");
		sql.append(" or (contareceber.tipoorigem = '").append(TipoOrigemContaReceber.NEGOCIACAO.getValor()).append("' and contacorrente.tipoOrigemNegociacao ) ");
		sql.append(" or (contareceber.tipoorigem = '").append(TipoOrigemContaReceber.OUTROS.getValor()).append("' and contacorrente.tipoOrigemOutros )) ");
		SqlRowSet rs  =  getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return rs.next();
}
	
	@Override
	public ContaReceberVO realizarRenegociacaoContaReceberAutomaticamente(Integer contaReceber, UsuarioVO usuarioVO) throws Exception {
		ContaReceberVO contaReceberVO = null;
		if(realizarValidacaoContaReceberAptaRealizarNegociacaoAutomaticamente(contaReceber)) {
			ConfiguracaoFinanceiroVO configuracaoFinanceiroVO =  getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoFinanceiraComBaseContaReceber(contaReceber);
			 contaReceberVO = new ContaReceberVO();
			 contaReceberVO.setCodigo(contaReceber);			
			 carregarDados(contaReceberVO, configuracaoFinanceiroVO, null);
			 ContaReceberVO contaReceberSimulada = (ContaReceberVO) contaReceberVO.clone();
			 contaReceberSimulada.setDataVencimento(Uteis.obterDataAvancada(new Date(), contaReceberVO.getContaCorrenteVO().getNumeroDiaAvancarVencimentoContaReceber()));
			 contaReceberSimulada.setAcrescimo(contaReceberSimulada.getAcrescimo()+
					 contaReceberVO.getValorJuroCalculado()+
					 contaReceberVO.getValorMultaCalculado()
					 //+					 contaReceberVO.getValorR
					 );
			 contaReceberVO = getFacadeFactory().getNegociacaoContaReceberFacade().incluirRenegociacaoApartirContaReceber(contaReceberSimulada, 
					 contaReceberVO, contaReceberSimulada.getDataVencimento(),
					 true, configuracaoFinanceiroVO, true, usuarioVO);
		}
		return contaReceberVO;
	}
	
	
	@Override
	public ContaReceberVO consultarPorPeriodoVencimentoPorUnidadeEnsinoPorValorPorSituacao( Date dataIni, Date dataFim, Integer unidadeEnsino, Double valor, String situacao, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO,  Boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sql =  getSQLPadraoConsultaCompleta();
		sql.append(" where contareceber.valor = ").append(valor).append(" ");	
		if(Uteis.isAtributoPreenchido(situacao)) {
			sql.append(" and contareceber.situacao = '").append(situacao).append("' ");
		}
		if(Uteis.isAtributoPreenchido(unidadeEnsino)) {
			sql.append(" and contareceber.unidadeensinofinanceira = ").append(unidadeEnsino).append(" ");	
		}
		if(Uteis.isAtributoPreenchido(dataIni) && Uteis.isAtributoPreenchido(dataFim)) {
			sql.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataIni)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");	
		}
		sql.append(" ORDER BY contareceber.codigo limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		ContaReceberVO obj = new ContaReceberVO(); 
		if (tabelaResultado.next()) {
			montarDadosCompleto(obj, tabelaResultado, configuracaoFinanceiroVO, usuario);
		}
		return obj;
	}
	
	

	public StringBuilder getSqlBaseConsultaControleCobrancaOpcao1(List<ContaCorrenteVO> listaContaCorrente, String nossoNumero, Integer carteira, String codigoBanco, String identificacaoTituloBanco, boolean bancoBrasil) {
		StringBuilder sqlStr = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
		sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
		sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append("LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
		sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append(" WHERE 1=1 ");
		//sqlStr.append(" and cr.situacao <> 'NE' ");
		if (Uteis.isAtributoPreenchido(listaContaCorrente)) {
			 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaContaCorrente)).append(" )");
		}
		if (bancoBrasil) {
			sqlStr.append(" AND ( nossonumero = '").append(nossoNumero).append("'");
			//sqlStr.append(" or nossonumero = substring('").append(nossoNumero).append("', 8, length('").append(nossoNumero).append("'))");
			//sqlStr.append(" or nossonumero = '0'||substring('").append(nossoNumero).append("', 9, length('").append(nossoNumero).append("')) ");
			sqlStr.append(" ) ");
		}else {			
			sqlStr.append(" AND ( nossonumero = '").append(nossoNumero).append("' ");
			if (carteira == 112 && codigoBanco == "341") {
				sqlStr.append(" or nossonumero = '").append(identificacaoTituloBanco).append("' ");
			} else {
				if(nossoNumero.startsWith("00000000")) {
					sqlStr.append(" or nossonumero= '").append(nossoNumero.substring(8, nossoNumero.length())).append("' ");
				}else if(nossoNumero.startsWith("0000000")) {
					sqlStr.append(" or nossonumero= '").append(nossoNumero.substring(7, nossoNumero.length())).append("' ");
				}else if(nossoNumero.startsWith("000000")) {
					sqlStr.append(" or nossonumero= '").append(nossoNumero.substring(6, nossoNumero.length())).append("' ");
				}else if(nossoNumero.startsWith("00000")) {
					sqlStr.append(" or nossonumero= '").append(nossoNumero.substring(5, nossoNumero.length())).append("' ");
				}else if(nossoNumero.startsWith("0000")) {
					sqlStr.append(" or nossonumero= '").append(nossoNumero.substring(4, nossoNumero.length())).append("' ");
				}else if(nossoNumero.startsWith("000")) {
					sqlStr.append(" or nossonumero= '").append(nossoNumero.substring(3, nossoNumero.length())).append("' ");
				}else if(nossoNumero.startsWith("00")) { 
					sqlStr.append(" or nossonumero= '").append(nossoNumero.substring(2, nossoNumero.length())).append("' ");
				}else if(nossoNumero.startsWith("0")) { 
					sqlStr.append(" or nossonumero= '").append(nossoNumero.substring(1, nossoNumero.length())).append("' ");
				}				
			}
			sqlStr.append(" ) ");			
		}
		return sqlStr;
	}
	
	public StringBuilder getSqlBaseConsultaControleCobrancaOpcao2(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, Integer carteira, String codigoBanco, String identificacaoTituloBanco) {
		StringBuilder sqlStr = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
		sqlStr.append(" matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\" ");
		sqlStr.append(" FROM ContaReceber cr ");
		sqlStr.append(" LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr.append(" LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append(" LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append(" LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append(" LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
		sqlStr.append(" WHERE 1=1 ");
		//sqlStr.append(" and cr.situacao <> 'NE' ");
		if (Uteis.isAtributoPreenchido(listaContaCorrente)) {
			 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaContaCorrente)).append(" )");
		}
		sqlStr.append(" AND nossonumero !~* '[a-zA-Z]'  ");
		if (nossoNumero.contains("P")) {
			sqlStr.append(" and nossonumero = '").append(new BigInteger(nossoNumero.replace("P", ""))).append("' ");
		}else {
			sqlStr.append("  and ( nossonumero = '").append(new BigInteger(nossoNumero)).append("' ");
			if (carteira == 112 && codigoBanco == "341") {
				sqlStr.append("  or nossonumero = '").append(identificacaoTituloBanco).append("' ");
			}
			sqlStr.append("  ) "); 
		}
		
		return sqlStr;
	}
	
	
	public StringBuilder getSqlBaseConsultaControleCobrancaOpcao3(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero) {
		StringBuilder sqlStr = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
		sqlStr.append(" matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\" ");
		sqlStr.append(" FROM ContaReceber cr ");
		sqlStr.append(" LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr.append(" LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append(" LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append(" LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append(" LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
		sqlStr.append(" WHERE 1=1 ");
		//sqlStr.append(" and cr.situacao <> 'NE' ");
		if (Uteis.isAtributoPreenchido(listaContaCorrente)) {
			 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaContaCorrente)).append(" )");
		}
		if (nossoNumero.contains("P")) {
			sqlStr.append(" and nossonumero = '").append(nossoNumero.replace("P", "").substring(1, 4)).append("0").append(nossoNumero.substring(4)).append("' ");
		}else {
			sqlStr.append("  and ( nossonumero = '").append(nossoNumero.substring(1, 4)).append("0").append(nossoNumero.substring(4)).append("') ");			
		}		
		return sqlStr;
	}
	
	public StringBuilder getSqlBaseConsultaControleCobrancaOpcao4(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, Integer carteira, String codigoBanco, String identificacaoTituloBanco) {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append(" SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, cr.situacao, current_timestamp as updated, p.nome, ");
		sqlStr.append(" matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
		sqlStr.append(" 0 as \"for.codigo\", '' as \"for.nome\" , '' as \"for.cnpj\" , '' as \"for.cpf\",  '' as \"for.tipoEmpresa\" ");
		sqlStr.append(" FROM ContaReceber2 cr ");
		sqlStr.append(" LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr.append(" LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append(" LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append(" LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append(" WHERE 1=1 ");
		//sqlStr.append(" and cr.situacao <> 'NE' ");
		if (Uteis.isAtributoPreenchido(listaContaCorrente)) {
			 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaContaCorrente)).append(" )");
		}
		sqlStr.append(" and ( nossonumero = '").append(nossoNumero.replace("P", "")).append("' ");			
		if (carteira == 112 && codigoBanco == "341") {
			sqlStr.append("  or nossonumero = '").append(identificacaoTituloBanco.replace("P", "")).append("' ");
		}
		sqlStr.append(" ) ");
				
		return sqlStr;
	}
	
	public StringBuilder getSqlBaseConsultaControleCobrancaOpcao5(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, Integer carteira, String codigoBanco, String identificacaoTituloBanco) {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr = new StringBuilder("SELECT nrdocumento, nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
		sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
		sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append("LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
		sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append(" WHERE 1=1 ");
		//sqlStr.append(" and cr.situacao <> 'NE' ");
		if (Uteis.isAtributoPreenchido(listaContaCorrente)) {
			 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaContaCorrente)).append(" )");
		}
		sqlStr.append(" and (nossonumero = '").append(nossoNumero.replace("P", "")).append("' ");
		if (carteira == 112 && codigoBanco == "341") {
			sqlStr.append(" or nossonumero = '").append(identificacaoTituloBanco.replace("P", "")).append("' ");
		}
		sqlStr.append(" or nossonumero = '1").append(nossoNumero.replace("P", "")).append("') ");				
		return sqlStr;
	}	
	
	
	public StringBuilder getSqlBaseConsultaControleCobrancaOpcao6(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero) {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr = new StringBuilder("SELECT nrdocumento, nossonumeroantigo AS nossonumero, valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
		sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
		sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append("LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
		sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append(" WHERE 1=1 ");
		//sqlStr.append(" and cr.situacao <> 'NE' ");
		if (Uteis.isAtributoPreenchido(listaContaCorrente)) {
			 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaContaCorrente)).append(" )");
		}
		if (nossoNumero.replace("P", "").length() >= 13) {			
			sqlStr.append(" and nossonumero = substring('").append(nossoNumero.replace("P", "")).append("', 1, 13) ");			
		}else {
			sqlStr.append(" and (nossonumero = '").append(nossoNumero.replace("P", "")).append("') ");
		}		
		return sqlStr;
	}	
	
	
	public StringBuilder getSqlBaseConsultaControleCobrancaOpcao7(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero) {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr = new StringBuilder("SELECT nrdocumento, ");
		sqlStr.append("'").append(nossoNumero.replace("P", "")).append("' as nossonumero, ");
		sqlStr.append(" valor, valorrecebido, datavencimento, taxaBoleto, cr.situacao, cr.updated, p.nome, ");
		sqlStr.append("matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\", ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"   FROM ContaReceber cr ");
		sqlStr.append("INNER JOIN contarecebernossonumero on (contarecebernossonumero.nossonumero1 = cr.nossonumeroantigo or contarecebernossonumero.nossonumero2 = cr.nossonumeroantigo or contarecebernossonumero.nossonumero3 = cr.nossonumeroantigo or contarecebernossonumero.nossonumero4 = cr.nossonumeroantigo or contarecebernossonumero.nossonumero5 = cr.nossonumeroantigo) ");
		sqlStr.append("LEFT JOIN matricula m ON cr.matriculaaluno = m.matricula ");
		sqlStr.append("LEFT JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append("LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro ");
		sqlStr.append("LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
		sqlStr.append("LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo ");
		sqlStr.append(" WHERE 1=1 ");
		//sqlStr.append(" and cr.situacao <> 'NE' ");
		if (Uteis.isAtributoPreenchido(listaContaCorrente)) {
			 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaContaCorrente)).append(" )");
		}
		sqlStr.append(" and cr.nossonumeroantigo  is not null and cr.nossonumeroantigo != '' ");
		sqlStr.append(" AND (contarecebernossonumero.nossonumero1 = '").append(nossoNumero.replace("P", "")).append("' ");
		sqlStr.append(" OR contarecebernossonumero.nossonumero2 = '").append(nossoNumero.replace("P", "")).append("' ");
		sqlStr.append(" OR contarecebernossonumero.nossonumero3 = '").append(nossoNumero.replace("P", "")).append("' ");
		sqlStr.append(" OR contarecebernossonumero.nossonumero4 = '").append(nossoNumero.replace("P", "")).append("' ");
		sqlStr.append(" OR contarecebernossonumero.nossonumero5 = '").append(nossoNumero.replace("P", "")).append("') ");
		return sqlStr;		
	}	
	
	public StringBuilder getSqlBaseConsultaControleCobrancaOpcao8(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero) {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append(" SELECT distinct nncc.nossonumero as nossonumeroantigo, cr.nrdocumento, cr.nossonumero, cr.valor, cr.valorrecebido, cr.datavencimento, cr.taxaBoleto, cr.situacao, cr.updated, p.nome,  ");
		sqlStr.append(" cr.matriculaaluno, cr.codigo, tipopessoa, cr.unidadeensino, cr.pessoa, cr.parceiro, parc.nome as \"parc.nome\", cr.responsavelFinanceiro, responsavelFinanceiro.nome as \"responsavelFinanceiro.nome\",  ");
		sqlStr.append(" fornecedor.codigo as \"for.codigo\", fornecedor.nome as \"for.nome\" , fornecedor.cnpj as \"for.cnpj\" , fornecedor.cpf as \"for.cpf\",  fornecedor.tipoEmpresa as \"for.tipoEmpresa\"  ");
		sqlStr.append(" FROM NossoNumeroContaReceber nncc ");
		sqlStr.append(" INNER JOIN matriculaPeriodo mp on mp.codigo = nncc.matriculaperiodo ");
		sqlStr.append(" INNER JOIN matricula m ON mp.matricula = m.matricula  ");
		sqlStr.append(" INNER JOIN pessoa p ON m.aluno = p.codigo ");
		sqlStr.append(" INNER join contareceber cr on cr.matriculaperiodo = mp.codigo and cr.parcela = nncc.parcela and extract(month from cr.dataVencimento) = extract(month from nncc.dataVencimento) and extract(year from cr.dataVencimento) = extract(year from nncc.dataVencimento) and nncc.tipoorigem = cr.tipoorigem ");
		if (Uteis.isAtributoPreenchido(listaContaCorrente)) {
			 sqlStr.append(" AND cr.contacorrente in( ").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaContaCorrente)).append(" )");
		}
		sqlStr.append(" LEFT JOIN parceiro parc ON parc.codigo = cr.parceiro  ");
		sqlStr.append(" LEFT JOIN pessoa responsavelFinanceiro ON cr.responsavelFinanceiro = responsavelFinanceiro.codigo  ");
		sqlStr.append(" LEFT JOIN fornecedor ON fornecedor.codigo = cr.fornecedor ");
		sqlStr.append(" WHERE (nncc.nossonumero = '").append(nossoNumero.replace("P", "")).append("' ");
		if(nossoNumero.startsWith("00000000")) {
			sqlStr.append(" or nncc.nossonumero= '").append(nossoNumero.substring(8, nossoNumero.length())).append("' ");
		}else if(nossoNumero.startsWith("0000000")) {
			sqlStr.append(" or nncc.nossonumero= '").append(nossoNumero.substring(7, nossoNumero.length())).append("' ");
		}else if(nossoNumero.startsWith("000000")) {
			sqlStr.append(" or nncc.nossonumero= '").append(nossoNumero.substring(6, nossoNumero.length())).append("' ");
		}else if(nossoNumero.startsWith("0000")) {
			sqlStr.append(" or nncc.nossonumero= '").append(nossoNumero.substring(4, nossoNumero.length())).append("' ");
		}else if(nossoNumero.startsWith("000")) {
			sqlStr.append(" or nncc.nossonumero= '").append(nossoNumero.substring(3, nossoNumero.length())).append("' ");
		}else if(nossoNumero.startsWith("00")) { 
			sqlStr.append(" or nncc.nossonumero= '").append(nossoNumero.substring(2, nossoNumero.length())).append("' ");
		}else if(nossoNumero.startsWith("0")) { 
			sqlStr.append(" or nncc.nossonumero= '").append(nossoNumero.substring(1, nossoNumero.length())).append("' ");
		}	
		sqlStr.append(") ");
		return sqlStr;		
	}
	
	
	public Boolean consultarContasControleCobrancaOpcao1(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, final boolean  contaReceberAgrupada,  final Integer carteira, final String codigoBanco, final String identificacaoTituloBanco, final boolean bancoBrasil, final Map<BigInteger, ContaReceberVO> resultado) throws Exception {		
		if (nossoNumero != null && !nossoNumero.trim().isEmpty() && !contaReceberAgrupada) {									
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(getSqlBaseConsultaControleCobrancaOpcao1(listaContaCorrente, nossoNumero, carteira, codigoBanco, identificacaoTituloBanco, bancoBrasil).toString());
			return montarDadosConsultaTelaControleCobranca(tabelaResultado, resultado);
		}			
		return false;
	}
	
	public Boolean consultarContasControleCobrancaOpcao2(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, final boolean  contaReceberAgrupada, final Integer carteira, final String codigoBanco, final String identificacaoTituloBanco, final  Map<BigInteger, ContaReceberVO> resultado) throws Exception {
			if (nossoNumero != null && !nossoNumero.trim().isEmpty() && 
					((nossoNumero.contains("P") && !resultado.containsKey(new BigInteger(nossoNumero.replace("P", ""))))
							|| (!nossoNumero.contains("P") && !resultado.containsKey(new BigInteger(nossoNumero)))
							) && contaReceberAgrupada) {										
				SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(getSqlBaseConsultaControleCobrancaOpcao2(listaContaCorrente, nossoNumero, carteira, codigoBanco, identificacaoTituloBanco).toString());
		
					return montarDadosConsultaTelaControleCobranca(tabelaResultado, resultado);
			}
			return false;
	}
	
	public Boolean consultarContasControleCobrancaOpcao3(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, final boolean  contaReceberAgrupada, final  Map<BigInteger, ContaReceberVO> resultado) throws Exception {
			if (nossoNumero != null && !nossoNumero.trim().isEmpty() && 
					((nossoNumero.contains("P") && nossoNumero.substring(0, 1).equals("0") 
							&& !resultado.containsKey(new BigInteger(nossoNumero.replace("P", ""))))
							|| (!nossoNumero.contains("P") 
									&& nossoNumero.substring(0, 1).equals("0") 
									&&  !resultado.containsKey(new BigInteger(nossoNumero)))
							) && !contaReceberAgrupada) {
				SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(getSqlBaseConsultaControleCobrancaOpcao3(listaContaCorrente, nossoNumero).toString());		
				return montarDadosConsultaTelaControleCobranca(tabelaResultado, resultado);
			}
			return false;
	}
	
	public Boolean consultarContasControleCobrancaOpcao4(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, final boolean  contaReceberAgrupada, final Integer carteira, final String codigoBanco, final String identificacaoTituloBanco, final  Map<BigInteger, ContaReceberVO> resultado) throws Exception {
			if (nossoNumero != null && !nossoNumero.trim().isEmpty() && 
					((nossoNumero.contains("P") && !resultado.containsKey(new BigInteger(nossoNumero.replace("P", ""))))
							|| (!nossoNumero.contains("P") &&  !resultado.containsKey(new BigInteger(nossoNumero)))
							) && !contaReceberAgrupada) {
			
				SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(getSqlBaseConsultaControleCobrancaOpcao4(listaContaCorrente, nossoNumero, carteira, codigoBanco, identificacaoTituloBanco).toString());
		
					return montarDadosConsultaTelaControleCobranca(tabelaResultado, resultado);
		}	
			return false;
	}
	
	public Boolean consultarContasControleCobrancaOpcao5(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, final boolean  contaReceberAgrupada, final Integer carteira, final String codigoBanco, final String identificacaoTituloBanco,  final  Map<BigInteger, ContaReceberVO> resultado) throws Exception {		
		if (nossoNumero != null && !nossoNumero.trim().isEmpty() && 
					((nossoNumero.contains("P") && !resultado.containsKey(new BigInteger(nossoNumero.replace("P", ""))))
							|| (!nossoNumero.contains("P") &&  !resultado.containsKey(new BigInteger(nossoNumero)))
							) && !contaReceberAgrupada) {
				SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(getSqlBaseConsultaControleCobrancaOpcao5(listaContaCorrente, nossoNumero, carteira, codigoBanco, identificacaoTituloBanco).toString());
				return montarDadosConsultaTelaControleCobranca(tabelaResultado, resultado);		
		}			
		return false;
	}
	
	public Boolean consultarContasControleCobrancaOpcao6(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, final boolean  contaReceberAgrupada, final  Map<BigInteger, ContaReceberVO> resultado) throws Exception {
			if (nossoNumero != null && !nossoNumero.trim().isEmpty() && 
					((nossoNumero.contains("P") && !resultado.containsKey(new BigInteger(nossoNumero.replace("P", ""))))
							|| (!nossoNumero.contains("P") &&  !resultado.containsKey(new BigInteger(nossoNumero)))
							) && !contaReceberAgrupada) {				
				SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(getSqlBaseConsultaControleCobrancaOpcao6(listaContaCorrente, nossoNumero).toString());
				return montarDadosConsultaTelaControleCobranca(tabelaResultado, resultado);
		}				
			return false;
	}
	
	public Boolean consultarContasControleCobrancaOpcao7(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, final boolean  contaReceberAgrupada,  final  Map<BigInteger, ContaReceberVO> resultado) throws Exception {
		if (nossoNumero != null && !nossoNumero.trim().isEmpty() && 
					((nossoNumero.contains("P") && !resultado.containsKey(new BigInteger(nossoNumero.replace("P", ""))))
							|| (!nossoNumero.contains("P") &&  !resultado.containsKey(new BigInteger(nossoNumero)))
							) && !contaReceberAgrupada) {
				SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(getSqlBaseConsultaControleCobrancaOpcao7(listaContaCorrente, nossoNumero).toString());
				return montarDadosConsultaTelaControleCobranca(tabelaResultado, resultado);
		}				
		return false;
	}
	
	public Boolean consultarContasControleCobrancaOpcao8(final List<ContaCorrenteVO> listaContaCorrente, final String nossoNumero, final boolean  contaReceberAgrupada,  final Map<BigInteger, ContaReceberVO> resultado) throws Exception {
		if (nossoNumero != null && !nossoNumero.trim().isEmpty() && 
			((nossoNumero.contains("P") && !resultado.containsKey(new BigInteger(nossoNumero.replace("P", ""))))
			|| (!nossoNumero.contains("P") &&  !resultado.containsKey(new BigInteger(nossoNumero)))) && !contaReceberAgrupada) {
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(getSqlBaseConsultaControleCobrancaOpcao8(listaContaCorrente, nossoNumero).toString());
			return montarDadosConsultaTelaControleCobrancaOpcao8(tabelaResultado, resultado);
		}			
		return false;
	}
	
	public synchronized Boolean montarDadosConsultaTelaControleCobranca(SqlRowSet tabelaResultado, Map<BigInteger, ContaReceberVO> resultado) throws Exception{		
		while (tabelaResultado.next()) {
			if (tabelaResultado.getString("nossonumero") == null) {
				return true;
			}
			ContaReceberVO contaReceber = montarDadosTelaControleCobranca(tabelaResultado);
			if (contaReceber.getNossoNumero().contains("P")) {
				resultado.put(new BigInteger(contaReceber.getNossoNumero().replace("P", "")), contaReceber);
			} else {
				resultado.put(new BigInteger(contaReceber.getNossoNumero()), contaReceber);
			}
			return true;
		}
		return false;
	}
	
	public synchronized Boolean montarDadosConsultaTelaControleCobrancaOpcao8(SqlRowSet tabelaResultado, Map<BigInteger, ContaReceberVO> resultado) throws Exception{		
		while (tabelaResultado.next()) {
			if (tabelaResultado.getString("nossonumeroantigo") == null) {
				return true;
			}
			ContaReceberVO contaReceber = montarDadosTelaControleCobrancaOpcao8(tabelaResultado);
			String nossonumeroantigo = tabelaResultado.getString("nossonumeroantigo");
			if (contaReceber.getNossoNumero().contains("P")) {
				resultado.put(new BigInteger(nossonumeroantigo.replace("P", "")), contaReceber);
			} else {
				resultado.put(new BigInteger(nossonumeroantigo), contaReceber);
			}
			return true;
		}
		return false;
	}
	
	public Map<BigInteger, ContaReceberVO> consultarContaBaixarArquivoRetorno(final RegistroArquivoVO registroArquivoVO, ProgressBarVO progressBarVO, boolean bancoBrasil) throws ConsistirException{
//		Stopwatch stopwatch =  new Stopwatch();
//				stopwatch.start();
		final Map<BigInteger, ContaReceberVO> resultado = new HashMap<BigInteger, ContaReceberVO>(0);
					
					ConsistirException consistirException = new ConsistirException();
					//ProcessarParalelismo.executar(0, registroArquivoVO.getRegistroDetalheVOs().size(), consistirException, new ProcessarParalelismo.Processo() {		
					ProcessarParalelismo.executarProgressBarVO(0, registroArquivoVO.getRegistroDetalheVOs().size(), 30, progressBarVO, "Carregando Contas Receber ", consistirException, new ProcessarParalelismo.Processo() {
						@Override
						public void run(int i) {
							RegistroDetalheVO detalhe = registroArquivoVO.getRegistroDetalheVOs().get(i);
							try {
								if(!consultarContasControleCobrancaOpcao1(registroArquivoVO.getListaContaCorrenteVOs(), detalhe.getIdentificacaoTituloEmpresa(), detalhe.getContaReceberAgrupada(), detalhe.getCarteira(), registroArquivoVO.getRegistroHeader().getCodigoBanco(), detalhe.getIdentificacaoTituloBanco(), bancoBrasil, resultado)) {
									if(!consultarContasControleCobrancaOpcao2(registroArquivoVO.getListaContaCorrenteVOs(), detalhe.getIdentificacaoTituloEmpresa(), detalhe.getContaReceberAgrupada(), detalhe.getCarteira(), registroArquivoVO.getRegistroHeader().getCodigoBanco(), detalhe.getIdentificacaoTituloBanco(), resultado)) {
										if(!consultarContasControleCobrancaOpcao3(registroArquivoVO.getListaContaCorrenteVOs(), detalhe.getIdentificacaoTituloEmpresa(), detalhe.getContaReceberAgrupada(),  resultado)) {
											if(!consultarContasControleCobrancaOpcao4(registroArquivoVO.getListaContaCorrenteVOs(), detalhe.getIdentificacaoTituloEmpresa(), detalhe.getContaReceberAgrupada(), detalhe.getCarteira(), registroArquivoVO.getRegistroHeader().getCodigoBanco(), detalhe.getIdentificacaoTituloBanco(), resultado)) {
												if(!consultarContasControleCobrancaOpcao5(registroArquivoVO.getListaContaCorrenteVOs(), detalhe.getIdentificacaoTituloEmpresa(), detalhe.getContaReceberAgrupada(), detalhe.getCarteira(), registroArquivoVO.getRegistroHeader().getCodigoBanco(), detalhe.getIdentificacaoTituloBanco(), resultado)) {
													if(!consultarContasControleCobrancaOpcao6(registroArquivoVO.getListaContaCorrenteVOs(), detalhe.getIdentificacaoTituloEmpresa(), detalhe.getContaReceberAgrupada(),  resultado)) {
														if(!consultarContasControleCobrancaOpcao7(registroArquivoVO.getListaContaCorrenteVOs(), detalhe.getIdentificacaoTituloEmpresa(), detalhe.getContaReceberAgrupada(),  resultado)) {
															if(!consultarContasControleCobrancaOpcao8(registroArquivoVO.getListaContaCorrenteVOs(), detalhe.getIdentificacaoTituloEmpresa(), detalhe.getContaReceberAgrupada(),  resultado)) {
																//System.out.println("Nosso Numero Nao Localizado: "+detalhe.getIdentificacaoTituloEmpresa());
																
															}
														}
													}
												}
											}
										}
									}
								}
							} catch (Exception e) {
								consistirException.adicionarListaMensagemErro(e.getMessage());						
							}
							
						}
					});
					if(!consistirException.getListaMensagemErro().isEmpty()) {
						throw consistirException;
					}
					//stopwatch.stop();
					//System.out.println("Tempo Execucao Pesquisa Conta Retorno Bancario: " + stopwatch.getElapsed());
					return resultado;
		}
	
		@Override
		public Map<BigInteger, ContaReceberVO> consultarContaBaixarPix(PixContaCorrenteVO pixoVO, boolean bancoBrasil) throws Exception{
			final Map<BigInteger, ContaReceberVO> resultado = new HashMap<BigInteger, ContaReceberVO>(0);
			List<ContaCorrenteVO> listaContaCorrente = new ArrayList<>();
			listaContaCorrente.add(pixoVO.getContaCorrenteVO());
			if (!consultarContasControleCobrancaOpcao1(listaContaCorrente, pixoVO.getNossoNumero(), false, 0, "", "", bancoBrasil, resultado)) {
				if (!consultarContasControleCobrancaOpcao2(listaContaCorrente, pixoVO.getNossoNumero(), false, 0, "", "", resultado)) {
					if (!consultarContasControleCobrancaOpcao3(listaContaCorrente, pixoVO.getNossoNumero(), false, resultado)) {
						if (!consultarContasControleCobrancaOpcao4(listaContaCorrente, pixoVO.getNossoNumero(), false, 0, "", "", resultado)) {
							if (!consultarContasControleCobrancaOpcao5(listaContaCorrente, pixoVO.getNossoNumero(), false, 0, "", "", resultado)) {
								if (!consultarContasControleCobrancaOpcao6(listaContaCorrente, pixoVO.getNossoNumero(), false, resultado)) {
									if (!consultarContasControleCobrancaOpcao7(listaContaCorrente, pixoVO.getNossoNumero(), false, resultado)) {
										if (!consultarContasControleCobrancaOpcao8(listaContaCorrente, pixoVO.getNossoNumero(), false, resultado)) {
											// System.out.println("Nosso Numero Nao Localizado: "+detalhe.getIdentificacaoTituloEmpresa());

										}
									}
								}
							}
						}
					}
				}
			}
			listaContaCorrente = null;
			return 	resultado;
		}
	
	/**
	 * Operação responsável por excluir registro de Conta Receber sem registro de recebimento, isto é,
	 * sem vínculo com registros da tabela contaReceberNegociacaoRecebimento
	 * @return Boolean validando resultado da operação.
	 */
	public Boolean excluirContaReceberRecebidaSemRegistroRecebimento(ContaReceberVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiro, Boolean verificarPermissao, UsuarioVO usuario) throws Exception {
		if (obj.getSituacao().equals(SituacaoContaReceber.RECEBIDO.getValor())) {
			if (getFacadeFactory().getContaReceberNegociacaoRecebimentoFacade().consultarExistenciaContaReceberNegociacaoRecebimentoPorContaReceber(obj.getCodigo())) {
				return Boolean.FALSE;
			} else {
				excluir(obj, new MatriculaPeriodoVencimentoVO(), configuracaoFinanceiro, verificarPermissao, usuario);
				return Boolean.TRUE;
			}
		}
		return Boolean.FALSE;
	}
	
	private String getSQLPadraoConsultaBasicaPorNomeSacadoTipoPessoa() {
		StringBuilder sql = new StringBuilder("");
		sql.append(" and ");
		sql.append(" 	((pessoamatricula.codigo is not null");
		sql.append(" 	and contareceber.matriculaaluno is not null");
		sql.append(" 	and contareceber.matriculaaluno = matricula.matricula)");
		sql.append(" 	or (pessoa.codigo is not null");
		sql.append(" 	and contareceber.pessoa is not null");
		sql.append(" 	and contareceber.pessoa = pessoa.codigo)");
		sql.append(" 	or (responsavelfinanceiro.codigo is not null");
		sql.append(" 	and contareceber.responsavelfinanceiro is not null");
		sql.append(" 	and contareceber.responsavelfinanceiro = responsavelfinanceiro.codigo)");
		sql.append(" 	or (pessoafuncionario.codigo is not null");
		sql.append(" 	and contareceber.funcionario is not null");
		sql.append(" 	and contareceber.funcionario = funcionario.codigo)");
		sql.append(" 	or (pessoacandidato.codigo is not null");
		sql.append(" 	and contareceber.candidato is not null");
		sql.append(" 	and pessoacandidato.codigo = contareceber.candidato)");
		sql.append(" 	or ( contareceber.parceiro is not null and parceiro.codigo = contareceber.parceiro)");
		sql.append(" 	or (fornecedor.codigo is not null");
		sql.append(" 	and contareceber.fornecedor is not null");
		sql.append(" 	and fornecedor.codigo = contareceber.fornecedor))");		
		return sql.toString();
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarValorIndiceReajusteContaReceber(Integer codigo, BigDecimal valorIndiceReajuste, BigDecimal valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa, UsuarioVO usuario) throws Exception {
		String sqlStr = "UPDATE ContaReceber set valorIndiceReajuste=?, valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa=? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { valorIndiceReajuste, valorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa, codigo });
	}	
	
	private void realizarAtualizacaoIndiceReajustePrecoContaReceber(ContaReceberVO contaReceberVO, IndiceReajustePeriodoVO irpvo, Integer matriculaPeriodo, UsuarioVO usuarioVO) throws StreamSeiException {
		try {
			String tipoOrigem = contaReceberVO.getTipoOrigem().equals("MEN") ? "MENSALIDADE" : "BCC";
			IndiceReajustePeriodoMatriculaPeriodoVencimentoVO indicePeriodoVencimentoVO = getFacadeFactory().getIndiceReajustePeriodoMatriculaPeriodoVencimentoFacade().consultarUltimoIndicePorMatriculaPeriodoSituacaoParcela(irpvo.getCodigo(), matriculaPeriodo, SituacaoExecucaoEnum.PROCESSADO, contaReceberVO.getParcela(),tipoOrigem, usuarioVO);
			if (Uteis.isAtributoPreenchido(indicePeriodoVencimentoVO) 
					&& !Uteis.compararBigDecimalIgualandoScaleRoundingMode(new BigDecimal(String.valueOf(Uteis.arrendondarForcando2CadasDecimais(contaReceberVO.getValorBaseContaReceber()))), indicePeriodoVencimentoVO.getValorBaseContaReceberReajuste().add(indicePeriodoVencimentoVO.getValorReajuste()), 2, RoundingMode.DOWN)) {
				BigDecimal valorReajusteAtualCalculado = new BigDecimal(0);
				contaReceberVO.setConsiderarDescontoSemValidadeCalculoIndiceReajuste(irpvo.getConsiderarDescontoSemValidadeCalculoIndiceReajuste());
				if(irpvo.getConsiderarDescontoSemValidadeCalculoIndiceReajuste()) {
					
					if(Uteis.isAtributoPreenchido(contaReceberVO.getListaDescontosAplicavesContaReceber())){
						Double soma = somarDescontoSemValidade(contaReceberVO.getListaDescontosAplicavesContaReceber());
						contaReceberVO.setValorDescontoSemValidade(soma);
					}
					valorReajusteAtualCalculado = new BigDecimal(String.valueOf(Uteis.arrendondarForcando2CadasDecimais(contaReceberVO.getValorBaseContaReceber() - contaReceberVO.getValorDescontoSemValidade()))).setScale(2, RoundingMode.DOWN)
							.multiply(irpvo.getPercentualReajuste())
							.divide(BigDecimal.valueOf(100L)).setScale(2, RoundingMode.DOWN);
				}else {
					valorReajusteAtualCalculado = new BigDecimal(String.valueOf(Uteis.arrendondarForcando2CadasDecimais(contaReceberVO.getValorBaseContaReceber()))).setScale(2, RoundingMode.DOWN)
							.multiply(irpvo.getPercentualReajuste())
							.divide(BigDecimal.valueOf(100L)).setScale(2, RoundingMode.DOWN);
				}
				String motivoCancelamento = "Cancelado por alteração no valor Base calculado da Conta a Receber, isso pode ocorrer por alteração do Plano Financeiro do Aluno.";
				getFacadeFactory().getIndiceReajustePeriodoMatriculaPeriodoVencimentoFacade().alterarIndiceReajustePeriodoMatriculaPeriodoVencimentoSituacaoCancelado(indicePeriodoVencimentoVO.getCodigo(), SituacaoExecucaoEnum.CANCELADO, motivoCancelamento, usuarioVO);
				
				IndiceReajustePeriodoMatriculaPeriodoVencimentoVO indicePeriodoVencimentoIncluirVO = getFacadeFactory().getIndiceReajustePeriodoMatriculaPeriodoVencimentoFacade().inicializarDadosIndiceReajustePeriodoMatriculaPeriodoVencimento(irpvo.getCodigo(), SituacaoExecucaoEnum.PROCESSADO, TipoOrigemContaReceber.MENSALIDADE.toString(), contaReceberVO, valorReajusteAtualCalculado, null, "", usuarioVO);
				contaReceberVO.setValor(contaReceberVO.getValor() + valorReajusteAtualCalculado.doubleValue());
				contaReceberVO.setValorBaseContaReceber(contaReceberVO.getValorBaseContaReceber() + valorReajusteAtualCalculado.doubleValue());
				contaReceberVO.setValorIndiceReajuste(valorReajusteAtualCalculado);			
				contaReceberVO.setValorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa(indicePeriodoVencimentoVO.getValorReferenteDiferencaParcelaRecebidaOuEnviadaRemessa());
				indicePeriodoVencimentoIncluirVO.setValorReferenteDiferencaParcelaRecebidaOuEnviadaRemessa(indicePeriodoVencimentoVO.getValorReferenteDiferencaParcelaRecebidaOuEnviadaRemessa());
				getFacadeFactory().getIndiceReajustePeriodoMatriculaPeriodoVencimentoFacade().incluir(indicePeriodoVencimentoIncluirVO, usuarioVO);					
			} else if(!contaReceberVO.getValorIndiceReajuste().equals(indicePeriodoVencimentoVO.getValorReajuste())) {
				contaReceberVO.setValorIndiceReajuste(indicePeriodoVencimentoVO.getValorReajuste());
				contaReceberVO.setValorReajusteDiferencaParcelaRecebidaOuEnviadaRemessa(indicePeriodoVencimentoVO.getValorReferenteDiferencaParcelaRecebidaOuEnviadaRemessa());
			}
		} catch (Exception e) {
			throw new StreamSeiException(e);
		}
	}
	
	private Double somarDescontoSemValidade(List<PlanoFinanceiroAlunoDescricaoDescontosVO> listaDescontosAplicavesContaReceber) {
		for(PlanoFinanceiroAlunoDescricaoDescontosVO obj : listaDescontosAplicavesContaReceber) {
			if(obj.getDiaNrAntesVencimento().equals(0)) {
				return obj.getValorDescontoSemValidade();
			}
		}
		return 0.0;
	}

	private boolean isIgualValorBaseContaReceberAoValorBaseContaReceberIndiceReajusteAddValorReajuste(String parcela,Integer codCOntaReceber, String tipoOrigem, List<IndiceReajustePeriodoVO> indiceReajustePeriodoVOs, Integer matriculaPeriodo, BigDecimal valorBaseContaReceberBigDecimal, UsuarioVO usuarioVO) throws Exception {
		Optional<IndiceReajustePeriodoVO> optUltimoIndiceReajustePeriodoVO = indiceReajustePeriodoVOs.stream().sorted(Comparator.comparing(IndiceReajustePeriodoVO::getData).reversed()).findFirst();
		IndiceReajustePeriodoVO ultimoIndiceReajustePeriodoVO = optUltimoIndiceReajustePeriodoVO.orElse(null);
		if (Uteis.isAtributoPreenchido(ultimoIndiceReajustePeriodoVO)) {
			
//			if(ultimoIndiceReajustePeriodoVO.getConsiderarDescontoSemValidadeCalculoIndiceReajuste() && Uteis.isAtributoPreenchido(codCOntaReceber)) {
//				BigDecimal valorDescontoIncondicional = new BigDecimal(String.valueOf(Uteis.arrendondarForcando2CadasDecimais(getFacadeFactory().getDetalhamentoValorContaInterfaceFacade().somarDescontoIncondicionalContaReceber(codCOntaReceber))));
//				if(Uteis.isAtributoPreenchido(valorDescontoIncondicional)) {
//					valorBaseContaReceberBigDecimal = valorBaseContaReceberBigDecimal.subtract(valorDescontoIncondicional);
//				}
//			}
			
			IndiceReajustePeriodoMatriculaPeriodoVencimentoVO irpmpvvo = getFacadeFactory().getIndiceReajustePeriodoMatriculaPeriodoVencimentoFacade()
					.consultarUltimoIndicePorMatriculaPeriodoSituacaoParcela(ultimoIndiceReajustePeriodoVO.getCodigo(), matriculaPeriodo, SituacaoExecucaoEnum.PROCESSADO, parcela, tipoOrigem, usuarioVO);
			return Uteis.compararBigDecimalIgualandoScaleRoundingMode(irpmpvvo.getValorBaseContaReceberReajuste().add(irpmpvvo.getValorReajuste()), valorBaseContaReceberBigDecimal, 2, RoundingMode.DOWN);
		}
		return Boolean.FALSE;
	}
	
	@Override
	public Boolean validarSeExisteContaParaUsuarioComCodigoContaReceber(Integer usuario, Integer contareceber) throws Exception{
		StringBuilder sqlStr = new StringBuilder(" select count(contareceber.codigo) as qtd from contareceber ");
		sqlStr.append(" where contareceber.codigo = ").append(contareceber);
		sqlStr.append(" and ( ");
		sqlStr.append(" (contareceber.matriculaaluno is not null and exists (select matricula.matricula from matricula inner join usuario on usuario.pessoa = matricula.aluno where usuario.codigo= ").append(usuario).append(" and contareceber.matriculaaluno = matricula.matricula))");
		sqlStr.append(" or ");
		sqlStr.append(" (contareceber.responsavelfinanceiro is not null and  exists (select usuario.pessoa from usuario where usuario.codigo =").append(usuario).append(" and  contareceber.responsavelfinanceiro = usuario.pessoa))");
		sqlStr.append(" or ");
		sqlStr.append(" exists (select filiacao.codigo from filiacao where exists (select usuario.pessoa from usuario where usuario.codigo = ").append(usuario).append(" and filiacao.pais = usuario.pessoa) and filiacao.aluno = contareceber.pessoa )"); 
		sqlStr.append(" or ");
		sqlStr.append(" exists (select funcionario.codigo from funcionario  where  exists (select usuario.pessoa from usuario where usuario.codigo = ").append(usuario).append(" and funcionario.pessoa  = usuario.pessoa))");
		sqlStr.append(" or ");
		sqlStr.append(" exists (select usuario.pessoa from usuario where usuario.codigo = ").append(usuario).append(" and usuario.pessoa is null and usuario.tipousuario = 'DM')");
		sqlStr.append("  )");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return Uteis.isAtributoPreenchido(rs, "qtd", TipoCampoEnum.INTEIRO);
	}

	@Override
	public Integer consultaRapidaPorSituacaoUnidadeEnsinoTotalRegistros(Integer unidadeEnsino, String situacao,
			Date dataBase, String tipoOrigem, boolean controlarAcesso, UsuarioVO usuario,
			List<String> listaStringFiltroSelecionado) throws Exception {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public List<ContaReceberVO> consultaRapidaPorSituacaoUnidadeEnsino(Integer unidadeEnsino, String situacao,
			Date dataBase, Integer limite, Integer offset, String tipoOrigem, boolean controlarAcesso,
			UsuarioVO usuario, List<String> listaDeStringFiltroSelecionado) throws Exception {
		// TODO Auto-generated method stub
		return null;
	}

	
	@Override
	public Map<String, Object> consultarPorSacado(ControleConsulta consulta, Boolean consDataCompetencia, int unidadeEnsino, String ano, String semestre, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, ContaReceberVO contaReceberVO, String tipoOrigem, int limite, int offset, int nivelMontarDados, List<String> situacoes, UsuarioVO usuarioVO, FiltroRelatorioFinanceiroVO filtroRelatorioFinanceiroVO) throws Exception {
	
		Date dataInicio = consulta.getDataIni();
		Date dataFim = consulta.getDataFim();
		if (consulta.getBuscarPeriodoCompleto()) {
			dataInicio = Uteis.getDate("01/01/1980");
			dataFim = Uteis.getDate("01/01/2100");
		}
		if (consDataCompetencia) {
			dataInicio = Uteis.getDataPrimeiroDiaMes(dataInicio);
			dataFim = Uteis.getDataUltimoDiaMes(dataFim);
		}
	
		StringBuilder sqlTotal = new StringBuilder("select count(contareceber.codigo) as qtde,  ");
		sqlTotal.append(" sum(case when contareceber.situacao = 'AR' then contareceber.valor else 0.0 end ) as valorAReceber,");
		sqlTotal.append(" sum(case when contareceber.situacao = 'RE' then contareceber.valor else 0.0 end ) as valorRecebido,");
		sqlTotal.append(" sum(case when contareceber.situacao = 'CF' then contareceber.valor else 0.0 end ) as valorCancelado,");
		sqlTotal.append(" sum(case when contareceber.situacao = 'NE' then contareceber.valor else 0.0 end ) as valorNegociado ");
		
		StringBuilder sqlBase = new StringBuilder(getSQLPadraoConsultaBasicaSelect());
		sqlBase.append(", cr.sacado ");
		
		StringBuilder sqlFrom = new StringBuilder("");
		sqlFrom.append(" from	(");
		sqlFrom.append(" select 	contareceber.codigo, 	contareceber.datavencimento,	contareceber.datacompetencia,	fornecedor.nome as sacado");
		sqlFrom.append(" from	fornecedor");
		sqlFrom.append(" inner join contareceber on fornecedor.codigo = contareceber.fornecedor");
		sqlFrom.append(" where sem_acentos(fornecedor.nome) ilike (sem_acentos(?)) and contareceber.tipopessoa = 'FO' ");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sqlFrom.append(" union all");
		sqlFrom.append(" (");
		sqlFrom.append(" 	select	contareceber.codigo,	contareceber.datavencimento,	contareceber.datacompetencia,	parceiro.nome as sacado");
		sqlFrom.append(" 	from parceiro");
		sqlFrom.append(" 	inner join contareceber on	(parceiro.codigo = contareceber.parceiro)	");
		sqlFrom.append(" 	where sem_acentos(parceiro.nome) ilike (sem_acentos(?)) and contareceber.matriculaaluno is not null and contareceber.tipopessoa = 'PA'");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sqlFrom.append(" 	union");
		sqlFrom.append(" 	select	contareceber.codigo,	contareceber.datavencimento,	contareceber.datacompetencia,	parceiro.nome as sacado");
		sqlFrom.append(" 	from parceiro");
		sqlFrom.append(" 	inner join contareceber on	(parceiro.codigo = contareceber.parceiro)");
		sqlFrom.append(" 	inner join matricula on (contareceber.matriculaaluno = matricula.matricula)");
		sqlFrom.append(" 	inner join pessoa on (pessoa.codigo = matricula.aluno)");
		sqlFrom.append(" 	where sem_acentos(pessoa.nome) ilike (sem_acentos(?)) and contareceber.tipopessoa = 'PA'");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sqlFrom.append(" )");
		sqlFrom.append(" union all");
		sqlFrom.append(" select	contareceber.codigo,	contareceber.datavencimento,	contareceber.datacompetencia,	parceiro.nome as sacado");
		sqlFrom.append(" from parceiro");
		sqlFrom.append(" inner join contareceber on	(parceiro.codigo = contareceber.parceiro)");
		sqlFrom.append(" where sem_acentos(parceiro.nome) ilike (sem_acentos(?)) and contareceber.tipopessoa = 'PA' and contareceber.matriculaaluno is null");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sqlFrom.append(" union all");
		sqlFrom.append(" (");
		sqlFrom.append(" select 	contareceber.codigo, 	contareceber.datavencimento,	contareceber.datacompetencia,	responsavelFinanceiro.nome as sacado");
		sqlFrom.append(" from pessoa as responsavelFinanceiro");
		sqlFrom.append(" inner join contareceber  on (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo)");
		sqlFrom.append(" where sem_acentos(responsavelFinanceiro.nome) ilike (sem_acentos(?)) and contareceber.tipopessoa = 'RF' and contareceber.matriculaaluno is not null");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sqlFrom.append(" union");
		sqlFrom.append(" select 	contareceber.codigo, 	contareceber.datavencimento,	contareceber.datacompetencia,	responsavelFinanceiro.nome as sacado");
		sqlFrom.append(" from pessoa as responsavelFinanceiro");
		sqlFrom.append(" inner join contareceber  on (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo)");
		sqlFrom.append(" inner join matricula on (contareceber.matriculaaluno = matricula.matricula)");
		sqlFrom.append(" inner join pessoa on (pessoa.codigo = matricula.aluno)");
		sqlFrom.append(" where  sem_acentos(pessoa.nome) ilike (sem_acentos(?)) and contareceber.tipopessoa = 'RF'");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sqlFrom.append(" )");
		sqlFrom.append(" union all");
		sqlFrom.append(" select 	contareceber.codigo, 	contareceber.datavencimento,	contareceber.datacompetencia,	responsavelFinanceiro.nome as sacado");
		sqlFrom.append(" from pessoa as responsavelFinanceiro");
		sqlFrom.append(" inner join contareceber  on (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo)");
		sqlFrom.append(" where (sem_acentos(responsavelFinanceiro.nome) ilike (sem_acentos(?)))   and contareceber.tipopessoa = 'RF' and contareceber.matriculaaluno is null");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sqlFrom.append(" union all");
		sqlFrom.append(" select 	contareceber.codigo,	contareceber.datavencimento,	contareceber.datacompetencia,	pessoacandidato.nome as sacado");
		sqlFrom.append(" from pessoa	as pessoacandidato");
		sqlFrom.append(" inner join contareceber  on 	(contareceber.candidato = pessoacandidato.codigo)");
		sqlFrom.append(" where sem_acentos(pessoacandidato.nome) ilike (sem_acentos(?)) and  contareceber.tipopessoa = 'CA'");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sqlFrom.append(" union all");
		sqlFrom.append(" select 	contareceber.codigo,	contareceber.datavencimento,	contareceber.datacompetencia,	pessoamatricula.nome as sacado");
		sqlFrom.append(" from matricula	");
		sqlFrom.append(" inner join pessoa as pessoamatricula on	(matricula.aluno = pessoamatricula.codigo)");
		sqlFrom.append(" inner join contareceber on	(matricula.matricula = contareceber.matriculaaluno)");
		sqlFrom.append(" where sem_acentos(pessoamatricula.nome) ilike (sem_acentos(?)) and   contareceber.tipopessoa = 'AL'");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sqlFrom.append(" union all");
		sqlFrom.append(" select	contareceber.codigo,	contareceber.datavencimento,	contareceber.datacompetencia,	pessoafuncionario.nome as sacado");
		sqlFrom.append(" from funcionario	");
		sqlFrom.append(" inner join pessoa as pessoafuncionario on (pessoafuncionario.codigo = funcionario.pessoa)");
		sqlFrom.append(" inner join contareceber on 	(funcionario.codigo = contareceber.funcionario)");
		sqlFrom.append(" where sem_acentos(pessoafuncionario.nome) ilike (sem_acentos(?)) and   contareceber.tipopessoa = 'FU'");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));
		sqlFrom.append(" union all");
		sqlFrom.append(" select	contareceber.codigo,	contareceber.datavencimento,	contareceber.datacompetencia,	pessoa.nome as sacado");
		sqlFrom.append(" from	pessoa");
		sqlFrom.append(" inner join contareceber on (pessoa.codigo = contareceber.pessoa)");
		sqlFrom.append(" where sem_acentos(pessoa.nome) ilike (sem_acentos(?)) and  contareceber.tipopessoa = 'RE' ");
		if (!consDataCompetencia) {
			sqlFrom.append(" AND (contareceber.datavencimento BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		} else {
			sqlFrom.append(" AND (contareceber.datacompetencia BETWEEN '").append(Uteis.getDataComHoraSetadaParaPrimeiroMinutoDia(dataInicio)).append("' AND '").append(Uteis.getDataComHoraSetadaParaUltimoMinutoDia(dataFim)).append("') ");
		}
		if (unidadeEnsino != 0) {
			sqlFrom.append("and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		sqlFrom.append(montarSqlSituacoes(situacoes));
		sqlFrom.append(montarSqlTipoOrigem(filtroRelatorioFinanceiroVO));	
		
		sqlFrom.append(" order by datavencimento ,	sacado, dataCompetencia");		
		sqlFrom.append(" limit ").append(limite).append(" offset ").append(offset);
		sqlFrom.append(" ) as cr ");
		sqlFrom.append(" inner join contareceber on contareceber.codigo = cr.codigo ");
		sqlFrom.append(" inner join unidadeensino on	(unidadeensino.codigo = contareceber.unidadeensino) ");
		sqlFrom.append(" inner join unidadeensino as unidadeEnsinoFinanceira on	(unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sqlFrom.append(" inner join contacorrente cc on	(contareceber.contacorrente = cc.codigo) ");
		sqlFrom.append(" left join pessoa on 	(contareceber.pessoa = pessoa.codigo) ");
		sqlFrom.append(" left join funcionario on 	(funcionario.codigo = contareceber.funcionario) ");
		sqlFrom.append(" left join pessoa as pessoafuncionario on	(pessoafuncionario.codigo = funcionario.pessoa) ");	
		sqlFrom.append(" left join parceiro on	(parceiro.codigo = contareceber.parceiro) ");
		sqlFrom.append(" left join matricula on	(matricula.matricula = contareceber.matriculaaluno) ");
		sqlFrom.append(" left join pessoa as pessoamatricula on	(matricula.aluno = pessoamatricula.codigo) ");
		sqlFrom.append(" left join pessoa as pessoacandidato on	(contareceber.candidato = pessoacandidato.codigo) ");
		sqlFrom.append(" left join pessoa as responsavelFinanceiro on	(contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sqlFrom.append(" left join centroreceita on	(centroreceita.codigo = contareceber.centroreceita) ");
		sqlFrom.append(" left join convenio on	(convenio.codigo = contareceber.convenio) ");
		sqlFrom.append(" left join turma on	(turma.codigo = contareceber.turma) ");
		sqlFrom.append(" left join fornecedor on	(fornecedor.codigo = contareceber.fornecedor) ");
		sqlFrom.append(" left join indicereajuste on	(contareceber.indiceReajustePadraoPorAtraso = indicereajuste.codigo) ");

		sqlTotal.append(sqlFrom.toString().replace("limit "+limite+" offset "+offset, ""));
		sqlBase.append(sqlFrom);
		sqlBase.append(" order by contareceber.datavencimento, sacado, contareceber.datacompetencia ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlBase.toString(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta());
		Map<String, Object> mapRetorno = new HashMap<String, Object>(0);
		mapRetorno.put("lista", montarDadosConsultaBasica(rs));
		if(!((List<ContaReceberVO>)mapRetorno.get("lista")).isEmpty()) {
			rs = getConexao().getJdbcTemplate().queryForRowSet(sqlTotal.toString(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta(), consulta.getValorConsulta());
			if(rs.next()) {
				mapRetorno.put("qtde", rs.getInt("qtde"));
				mapRetorno.put("valorAReceber", rs.getDouble("valorAReceber"));
				mapRetorno.put("valorRecebido", rs.getDouble("valorRecebido"));
				mapRetorno.put("valorCancelado", rs.getDouble("valorCancelado"));
				mapRetorno.put("valorNegociado", rs.getDouble("valorNegociado"));				
			}
		}else {
			mapRetorno.put("qtde", 0);
			mapRetorno.put("valorAReceber", 0.0);
			mapRetorno.put("valorRecebido", 0.0);
			mapRetorno.put("valorCancelado", 0.0);
			mapRetorno.put("valorNegociado", 0.0);		
		}
		return mapRetorno;
	}
	
	public String getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) {
		String dataFiltro = "CURRENT_DATE";
		StringBuilder sqlStr = new StringBuilder();
		if (configuracaoFinanceiroVO.getQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno() > 0) {
			sqlStr.append(" AND ((contareceber.tipoorigem not IN ('MAT', 'BCC') AND contareceber.dataVencimento::Date <= (");
			sqlStr.append(dataFiltro);
			sqlStr.append(" + ").append(configuracaoFinanceiroVO.getQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno()).append("))");
			sqlStr.append(" OR (contareceber.tipoorigem = 'BCC' AND parceiro.financiamentoProprio = false AND contareceber.dataVencimento::Date <= (");
			sqlStr.append(dataFiltro);
			sqlStr.append(" + ").append(configuracaoFinanceiroVO.getQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno()).append("))");
			sqlStr.append(" OR (contareceber.tipoorigem = 'MAT'");
			if (configuracaoFinanceiroVO.getQuantidadeDiasAntesVencimentoApresentarContaReceberMatVisaoAluno() > 0) {
				sqlStr.append(" AND contareceber.dataVencimento::Date <= (");
				sqlStr.append(dataFiltro);
				sqlStr.append(" + ").append(configuracaoFinanceiroVO.getQuantidadeDiasAntesVencimentoApresentarContaReceberMatVisaoAluno()).append(")");
			}
			sqlStr.append(" ))");
		} else if (!Uteis.isAtributoPreenchido(configuracaoFinanceiroVO.getQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno()) && configuracaoFinanceiroVO.getQuantidadeDiasAntesVencimentoApresentarContaReceberMatVisaoAluno() > 0) {
			sqlStr.append(" AND ((contareceber.tipoorigem != 'MAT') or (contareceber.tipoorigem = 'MAT'");
			sqlStr.append(" AND contareceber.dataVencimento::Date <= (");
			sqlStr.append(dataFiltro);
			 sqlStr.append(" + ").append(configuracaoFinanceiroVO.getQuantidadeDiasAntesVencimentoApresentarContaReceberMatVisaoAluno()).append(")))"); 
		}
		
		return sqlStr.toString();
	}
	
	@Override
	public List<ContaReceberVO> consultarBolsaCusteadaConveioParcelaReajusteAReceberAptasParaAplicacaoReajuste(Integer indiceReajuste, Integer mes, String ano, Integer parcelaInicialReajuste, Integer matriculaPeriodo, Boolean considerarDescontoSemValidadeCalculoIndiceReajuste,  Boolean limit1, UsuarioVO usuarioVO) throws Exception{
		Date dataInicioMes = Uteis.getDate("01/"+mes+"/"+ano);		
		Date dataFimMes = Uteis.getDataUltimoDiaMes(dataInicioMes);
		StringBuilder sb = new StringBuilder();
		sb.append(" select contareceber.codigo as \"contareceber.codigo\", contareceber.matriculaaluno as \"contareceber.matriculaaluno\", contareceber.parcela as \"contareceber.parcela\",   ");
		sb.append(" contaReceber.matriculaPeriodo as \"contaReceber.matriculaPeriodo\", contareceber.datavencimento as \"contareceber.datavencimento\", contareceber.valor as \"contareceber.valor\", ");
		sb.append(" contareceber.valorbasecontareceber as \"contareceber.valorbasecontareceber\", contaReceber.valorIndiceReajuste as \"contaReceber.valorIndiceReajuste\", contareceber.situacao as \"contareceber.situacao\",  ");
		sb.append(" matricula.permiteExecucaoReajustePreco, parceiro.codigo as \"parceiro.codigo\", parceiro.realizarReajustePrecoComBaseIndiceReajuste as \"parceiro.realizarReajustePrecoComBaseIndiceReajuste\", ");
		sb.append(" contareceber.contacorrente as \"contareceber.contacorrente\",  contareceber.tipoorigem,");
		
		
		sb.append(" (select case when count(controleRM.contareceber) > 0 then true else false end ");
		sb.append("  from controleremessacontareceber as controleRM where controleRM.contareceber = contaReceber.codigo ");
		sb.append(" ) as possuiRemessa ");
		
		if(considerarDescontoSemValidadeCalculoIndiceReajuste) {
			sb.append(", coalesce((select sum(valor) from detalhamentovalorconta where origemdetalhamentoconta = 'CONTA_RECEBER' and codigoorigem = contareceber.codigo ");
			sb.append(" and tipocentroresultadoorigemdetalhe in ('DESCONTO_ALUNO', 'DESCONTO_CONVENIO', 'DESCONTO_INSTITUICAO', 'DESCONTO_MANUAL', 'DESCONTO_RATEIO', 'DESCONTO_CUSTEADO_CONTA_RECEBER') ");
			sb.append(" and utilizado and datalimiteaplicacaodesconto is null), 0.0) as \"contareceber.valordescontosemvalidade\" ");
		}
		
		sb.append(" from contareceber ");
		
		sb.append(" inner join matriculaperiodo on matriculaperiodo.codigo = contareceber.matriculaperiodo  ");
		sb.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso  ");
		sb.append(" inner join matricula on matricula.matricula = matriculaPeriodo.matricula  ");
		sb.append(" inner join parceiro  on parceiro.codigo = contareceber.parceiro  ");
		
		sb.append(" where ");
		
		sb.append(" matricula.matricula in( ");
		sb.append(" select distinct mat.matricula ");
		sb.append(" from indiceReajuste ");
		sb.append(" inner join turma on turma.indiceReajuste = indiceReajuste.codigo ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.turma = turma.codigo ");
		sb.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sb.append(" inner join matricula as mat on mat.matricula = matriculaperiodo.matricula ");
		sb.append(" inner join curso on curso.codigo = mat.curso ");
		sb.append(" inner join contareceber cr on cr.matriculaperiodo = matriculaperiodo.codigo ");
		sb.append(" inner join parceiro on parceiro.codigo = cr.parceiro ");
		
		
		sb.append(" where cr.tipoorigem = 'BCC' and condicaopagamentoplanofinanceirocurso.nrparcelasperiodo > 12 ");
		sb.append(" and mat.matricula = matricula.matricula ");
		sb.append(" and turma.indiceReajuste = ").append(indiceReajuste);
		sb.append(" and curso.periodicidade = 'IN' ");	
		sb.append(" and (cr.situacao in ('AR') ");	
		sb.append(" or cr.codigo in(");
		sb.append(" select distinct contarecebernegociacaorecebimento.contareceber ");
		sb.append(" from negociacaorecebimento ");
		sb.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo ");
		
		sb.append(" where contarecebernegociacaorecebimento.contareceber = cr.codigo ");
		sb.append(" and negociacaorecebimento.data::date <  '").append(Uteis.getDataJDBC(dataInicioMes)).append("')) ");
		
		sb.append(" and ( ");
		sb.append(" (mat.situacao = 'CA' and exists (select contareceber.codigo from contareceber where contareceber.matriculaperiodo = matriculaperiodo.codigo and  contareceber.situacao = 'AR')) ");
		sb.append("  or mat.situacao <> 'CA' ) ");

		sb.append(" and cr.parcela ilike ('%/%') ");
		sb.append(" and (position('/' in cr.parcela) - 1) > 0 ");
		sb.append(" and isnumeric(substring(cr.parcela, 1, position('/' in cr.parcela) - 1)) ");
		sb.append(" and  ");
		sb.append(" case when parceiro.considerarParcelasMaterialDidaticoReajustePreco and  parceiro.custeaParcelasMaterialDidatico and  condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and mat.considerarParcelasMaterialDidaticoReajustePreco ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then ((substring(cr.parcela, 0, position('/' in cr.parcela))::int) = ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" else ");
		sb.append("(substring(cr.parcela, 0, position('/' in cr.parcela)) = '").append(parcelaInicialReajuste).append("') ");
		sb.append(" end ");
		sb.append(" and cr.datavencimento >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("'");
		sb.append(" and cr.datavencimento <= '").append(Uteis.getDataJDBC(dataFimMes)).append("'");
		
		
//		sb.append(" and contareceber.codigo in( ");
//		sb.append(" select distinct contareceber.codigo   "); 
//		sb.append(" from controleremessacontareceber  "); 
//		sb.append(" where controleremessacontareceber.contareceber = contareceber.codigo and controleremessacontareceber.situacao <> 'REMETIDA' ) "); 
		sb.append(" and not exists ( "); 
		
	
		sb.append(" select distinct indicePeriodo.codigo from indicereajusteperiodomatriculaperiodovencimento indicePeriodoVencimento ");            
		sb.append(" inner join indicereajustePeriodo indicePeriodo on indicePeriodo.codigo = indicePeriodoVencimento.indiceReajustePeriodo ");
		sb.append(" where indicePeriodoVencimento.matriculaperiodo = matriculaPeriodo.codigo ");
		
		sb.append(" and ");
		sb.append(" case when parceiro.considerarParcelasMaterialDidaticoReajustePreco and parceiro.custeaParcelasMaterialDidatico and  condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and mat.considerarParcelasMaterialDidaticoReajustePreco  ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then indicePeriodoVencimento.parcela::int = ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico ");
		sb.append(" else ");
		sb.append(" indicePeriodoVencimento.parcela = '").append(parcelaInicialReajuste).append("' ");
		sb.append(" end ");
		sb.append(" and indicePeriodo.mes = '").append(MesAnoEnum.getMesData(dataInicioMes).name()).append("' ");
		sb.append(" and indicePeriodo.ano = '").append(ano).append("' ");
		sb.append(" and indicePeriodoVencimento.situacao= 'PROCESSADO') ) ");
		
		
		sb.append(" and contareceber.parcela ilike ('%/%') ");
		sb.append(" and (position('/' in contareceber.parcela) - 1) > 0 ");
		sb.append(" and isnumeric(substring(contareceber.parcela, 1, position('/' in contareceber.parcela) - 1)) ");
		sb.append(" and ");
		sb.append(" case when parceiro.considerarParcelasMaterialDidaticoReajustePreco and parceiro.custeaParcelasMaterialDidatico and condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and matricula.considerarParcelasMaterialDidaticoReajustePreco ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then (cast(substring(contareceber.parcela, 1, position('/' in contareceber.parcela) - 1) as integer) >= ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" else ");
		sb.append(" (cast(substring(contareceber.parcela, 1, position('/' in contareceber.parcela) - 1) as integer) >= ").append(parcelaInicialReajuste).append(") ");
		sb.append(" end  ");
	
		
		sb.append(" and contareceber.tipoorigem = 'BCC' ");
		sb.append(" and contareceber.situacao in ('AR') ");
//		sb.append(" and ( not exists( ");
//		
//		
//		sb.append(" select distinct controleremessacontareceber.contareceber  ");
//		sb.append(" from controleremessacontareceber ");
//		sb.append(" where controleremessacontareceber.contareceber = contareceber.codigo and controleremessacontareceber.situacao = 'REMETIDA' )) ");
		
		sb.append(" and not exists ( ");

		sb.append(" select distinct indicePeriodo.codigo ");
		sb.append(" from indicereajusteperiodomatriculaperiodovencimento indicePeriodoVencimento ");
		sb.append(" inner join indicereajustePeriodo indicePeriodo on indicePeriodo.codigo = indicePeriodoVencimento.indiceReajustePeriodo ");
		sb.append(" where indicePeriodoVencimento.matriculaperiodo = matriculaPeriodo.codigo ");
		sb.append(" and indicePeriodoVencimento.parcela = substring(contareceber.parcela, 1, position('/' in contareceber.parcela) - 1) ");
		sb.append(" and indicePeriodoVencimento.tipoorigem = 'BCC' ");
		sb.append(" and indicePeriodo.mes = '").append(MesAnoEnum.getMesData(dataInicioMes).name()).append("' ");
		sb.append(" and indicePeriodo.ano = '").append(ano).append("' ");
		sb.append(" and indicePeriodoVencimento.situacao = 'PROCESSADO') ");
		
		sb.append(" order by matriculaperiodo.matricula, contareceber.parcela ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<ContaReceberVO> listaContaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("contareceber.codigo"));
			obj.getMatriculaAluno().setMatricula(tabelaResultado.getString("contareceber.matriculaaluno"));
			obj.getMatriculaAluno().setPermiteExecucaoReajustePreco(tabelaResultado.getBoolean("permiteExecucaoReajustePreco"));
			obj.setParcela(tabelaResultado.getString("contareceber.parcela"));
			obj.setTipoOrigem(tabelaResultado.getString("tipoorigem"));
			obj.setMatriculaPeriodo(tabelaResultado.getInt("contaReceber.matriculaPeriodo"));
			obj.setDataVencimento(tabelaResultado.getDate("contareceber.datavencimento"));
			obj.setValor(tabelaResultado.getDouble("contareceber.valor"));
			obj.setValorBaseContaReceber(tabelaResultado.getDouble("contareceber.valorbasecontareceber"));
			obj.setValorIndiceReajuste(tabelaResultado.getBigDecimal("contaReceber.valorIndiceReajuste"));
			obj.setSituacao(tabelaResultado.getString("contareceber.situacao"));
			obj.getContaCorrenteVO().setCodigo(tabelaResultado.getInt("contareceber.contacorrente"));
			obj.getParceiroVO().setCodigo(tabelaResultado.getInt("parceiro.codigo"));
			obj.getParceiroVO().setRealizarReajustePrecoComBaseIndiceReajuste(tabelaResultado.getBoolean("parceiro.realizarReajustePrecoComBaseIndiceReajuste"));
			obj.setPossuiRemessa(tabelaResultado.getBoolean("possuiRemessa"));
			if(considerarDescontoSemValidadeCalculoIndiceReajuste){
				obj.setValorDescontoSemValidade(tabelaResultado.getDouble("contareceber.valordescontosemvalidade"));
			}
			listaContaReceberVOs.add(obj);
		}

		return listaContaReceberVOs;
	}
		
	
	@Override
	public String consultarNomesParceiroPorContaReceber(List<NotaFiscalSaidaServicoVO> servicos) throws Exception {
		StringBuilder sql = new StringBuilder("");
		sql.append("select array_to_string(array_agg(distinct p.nome), ', ') convenios	from contareceber cr ");
		sql.append("inner join planodescontocontareceber pd on pd.contareceber = cr.codigo ");
		sql.append("inner join convenio c on c.codigo = pd.convenio ");
		sql.append("inner join parceiro p on p.codigo = c.parceiro ");
		sql.append("where cr.codigo in (");
		String aux = "";
		for (NotaFiscalSaidaServicoVO serv : servicos) {
			sql.append(aux + serv.getContaReceberVO().getCodigo());
			aux = ",";
		}
		sql.append(")");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getString("convenios");
		}
		return "";
	}
	
	@Override
	public List<Integer> validarExisteContaReceberRenegociadadaQueNaoCumpriuAcordo(Integer codigoPessoa) throws Exception {
		List<Integer> codigoNegociacao = new ArrayList<>();
		StringBuilder sql = new StringBuilder("");
		sql.append(" select negociacaocontareceber.codigo as codigoNegociacao, liberarrenovacaoapospagamentoprimeiraparcela, liberarrenovacaoapospagamentotodasparcelas,  ");
		sql.append(" (select count(codigo) from contareceber crr where crr.situacao in ('RE', 'NE') and crr.tipoOrigem = 'NCR' and  crr.codorigem::INT = negociacaocontareceber.codigo ) as recebido, ");
		sql.append(" (select count(codigo) from contareceber crr where crr.situacao in ('AR') and crr.tipoOrigem = 'NCR' and  crr.codorigem::INT = negociacaocontareceber.codigo ) as areceber, ");
		sql.append(" (select count(codigo) from contareceber crr where crr.situacao in ('RE') and crr.tipoOrigem in ('MEN') and  crr.pessoa = '" + codigoPessoa + "' ) as recebidoNaoNegociado ");
		sql.append(" from negociacaocontareceber   ");
		sql.append(" inner join contareceber on  contareceber.tipoOrigem = 'NCR' and contareceber.codorigem::INT = negociacaocontareceber.codigo ");
		sql.append(" where contareceber.pessoa =  ").append(codigoPessoa);
		sql.append(" and (select count(contarecebernegociado.codigo) from contarecebernegociado   ");
		sql.append(" inner join contareceber cr2 on cr2.codigo = contarecebernegociado.contareceber ");
		sql.append(" where contarecebernegociado.negociacaocontareceber = negociacaocontareceber.codigo ");
		sql.append(" and cr2.tipoorigem in ('MAT', 'MEN')) > 0 ");
		sql.append(" group by negociacaocontareceber.codigo, liberarrenovacaoapospagamentoprimeiraparcela, liberarrenovacaoapospagamentotodasparcelas ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		while (rs.next()) {
			if (rs.getBoolean("liberarrenovacaoapospagamentotodasparcelas") && rs.getInt("areceber") > 0) {
				codigoNegociacao.add(rs.getInt("codigoNegociacao"));
			}
			if (rs.getBoolean("liberarrenovacaoapospagamentoprimeiraparcela") && rs.getInt("recebido") == 0) {
				codigoNegociacao.add(rs.getInt("codigoNegociacao"));
			}
		}
		return codigoNegociacao;
	}
	
	
	@Override
	public List<ContaReceberVO> consultarMatriculaPeriodoVencimentoParcelaReajusteARecebidaAptasParaAplicacaoReajusteBolsaCusteadaConvenio(Integer indiceReajuste, Integer mes, String ano, Integer parcelaInicialReajuste, Integer matriculaPeriodo,Boolean considerarDescontoSemValidadeCalculoIndiceReajuste, Boolean limit1, UsuarioVO usuarioVO) throws Exception{
		Date dataInicioMes = Uteis.getDate("01/"+mes+"/"+ano);		
		Date dataFimMes = Uteis.getDataUltimoDiaMes(dataInicioMes);
		StringBuilder sb = new StringBuilder();
		sb.append(" select matriculaperiodo.matricula, contareceber.codigo as \"contareceber.codigo\",  contareceber.matriculaaluno as \"contareceber.matriculaaluno\", contareceber.parcela as \"contareceber.parcela\",  ");
		sb.append(" contaReceber.matriculaPeriodo as \"contaReceber.matriculaPeriodo\", contareceber.datavencimento as \"contareceber.datavencimento\", contareceber.valor as \"contareceber.valor\",  ");
		sb.append(" contareceber.valorbasecontareceber as \"contareceber.valorbasecontareceber\", contaReceber.valorIndiceReajuste as \"contaReceber.valorIndiceReajuste\", contareceber.situacao as \"contareceber.situacao\", ");
		sb.append(" contareceber.contacorrente as \"contareceber.contacorrente\" , parceiro.codigo  as \"parceiro.codigo\", parceiro.realizarReajustePrecoComBaseIndiceReajuste as \"parceiro.realizarReajustePrecoComBaseIndiceReajuste\",  ");
		sb.append(" matricula.permiteExecucaoReajustePreco, contareceber.tipoorigem as \"contareceber.tipoorigem\",  ");
		
		sb.append(" (select case when count(controleRM.contareceber) > 0 then true else false end ");
		sb.append("  from controleremessacontareceber as controleRM where controleRM.contareceber = contaReceber.codigo ");
		sb.append(" ) as possuiRemessa ");
		
		if(considerarDescontoSemValidadeCalculoIndiceReajuste) {
			sb.append(", coalesce((select sum(valor) from detalhamentovalorconta where origemdetalhamentoconta = 'CONTA_RECEBER' and codigoorigem = contareceber.codigo ");
			sb.append(" and tipocentroresultadoorigemdetalhe in ('DESCONTO_ALUNO', 'DESCONTO_CONVENIO', 'DESCONTO_INSTITUICAO', 'DESCONTO_MANUAL', 'DESCONTO_RATEIO', 'DESCONTO_CUSTEADO_CONTA_RECEBER') ");
			sb.append(" and utilizado and datalimiteaplicacaodesconto is null), 0.0) as \"contareceber.valordescontosemvalidade\" ");
		}
		
		sb.append(" from contareceber ");
		
		sb.append(" inner join matriculaperiodo on matriculaperiodo.codigo = contareceber.matriculaperiodo  ");
		sb.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso  ");
		sb.append(" inner join matricula on  matricula.matricula = contareceber.matriculaaluno  ");
		sb.append(" inner join parceiro on contareceber.parceiro = parceiro.codigo  ");
		sb.append(" left join controleremessacontareceber on controleremessacontareceber.contareceber = contareceber.codigo  ");
		
		sb.append(" where ");
		
		sb.append(" matriculaaluno in( ");
		sb.append(" select distinct mat.matricula ");
		sb.append(" from indiceReajuste ");
		sb.append(" inner join turma on turma.indiceReajuste = indiceReajuste.codigo ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.turma = turma.codigo ");
		sb.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sb.append(" inner join matricula as mat on mat.matricula = matriculaperiodo.matricula ");
		sb.append(" inner join curso on curso.codigo = mat.curso ");
		sb.append(" inner join contareceber as cr on cr.matriculaperiodo = matriculaperiodo.codigo ");
		sb.append(" inner join parceiro on parceiro.codigo = cr.parceiro ");
		sb.append(" where cr.tipoorigem = 'BCC' and condicaopagamentoplanofinanceirocurso.nrparcelasperiodo > 12");
		sb.append(" and mat.matricula = matricula.matricula ");
		sb.append(" and turma.indiceReajuste = ").append(indiceReajuste);
		if (matriculaPeriodo > 0) {
			sb.append(" and cr.matriculaPeriodo = ").append(matriculaPeriodo);
		}
		sb.append(" and curso.periodicidade = 'IN' ");
		sb.append(" and (cr.situacao in ('AR', 'NE') ");
		sb.append(" or (cr.codigo is not null ");
		sb.append(" and exists( ");
		sb.append(" select distinct contarecebernegociacaorecebimento.contareceber ");
		sb.append(" from negociacaorecebimento ");
		
		sb.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo ");
		sb.append(" where contarecebernegociacaorecebimento.contareceber = cr.codigo ");
		sb.append(" and negociacaorecebimento.data::date >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("')) ");

		sb.append(" or cr.situacao in('AR','NE') ");
//		sb.append(" and exists ( select distinct controleremessacontareceber.contareceber ");
//		sb.append(" from controleremessacontareceber ");
//		sb.append(" where controleremessacontareceber.contareceber = contareceber.codigo and controleremessacontareceber.situacao != 'REMETIDA')  ");
		sb.append("  ) ");
		
		sb.append(" and ( ");
		sb.append(" (mat.situacao = 'CA' and exists (select contareceber.codigo from contareceber where contareceber.matriculaperiodo = matriculaperiodo.codigo and contareceber.situacao = 'AR')) ");
		sb.append("  or mat.situacao <> 'CA' ) ");
		
		sb.append(" and cr.datavencimento >= '").append(Uteis.getDataJDBC(dataInicioMes)).append("'");
		sb.append(" and cr.datavencimento <= '").append(Uteis.getDataJDBC(dataFimMes)).append("'");
		sb.append(" and cr.parcela ilike ('%/%') ");
		sb.append(" and (position('/' in cr.parcela) -1) > 0 ");
		sb.append(" and isnumeric(substring(cr.parcela, 1, position('/' in cr.parcela) - 1))  ");
		sb.append(" and ");
	
		sb.append(" case when parceiro.considerarParcelasMaterialDidaticoReajustePreco and parceiro.custeaParcelasMaterialDidatico and condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and mat.considerarParcelasMaterialDidaticoReajustePreco ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then ((substring(cr.parcela, 0, position('/' in cr.parcela))::int) = ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico ").append(") ");
		sb.append(" else ");
		sb.append(" (substring(cr.parcela, 0, position('/' in cr.parcela)) = '").append(parcelaInicialReajuste).append("') ");
		sb.append(" end ");

		sb.append(" and ");
		sb.append(" not exists ( ");
		sb.append(" select distinct indicePeriodo.codigo from indicereajusteperiodomatriculaperiodovencimento indicePeriodoVencimento ");
		sb.append(" inner join indicereajustePeriodo indicePeriodo on indicePeriodo.codigo = indicePeriodoVencimento.indiceReajustePeriodo ");
		sb.append(" where indicePeriodoVencimento.matriculaperiodo = matriculaPeriodo.codigo ");
		
		sb.append(" and ");
		sb.append(" case when parceiro.considerarParcelasMaterialDidaticoReajustePreco and parceiro.custeaParcelasMaterialDidatico and condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and mat.considerarParcelasMaterialDidaticoReajustePreco ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then indicePeriodoVencimento.parcela::int = ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico ");
		sb.append(" else ");
		sb.append(" indicePeriodoVencimento.parcela = '").append(parcelaInicialReajuste).append("' ");
		sb.append(" end ");
		
		sb.append("  and indicePeriodo.mes = '").append(MesAnoEnum.getMesData(dataInicioMes).name()).append("' ");
		sb.append("  and indicePeriodo.ano = '").append(ano).append("' ");
		sb.append(" and indicePeriodoVencimento.situacao = 'PROCESSADO') ");
		sb.append(") ");
		sb.append(" and contareceber.parcela ilike ('%/%')             ");
		sb.append(" and (position('/' in contareceber.parcela) -1) > 0 ");
		sb.append(" and isnumeric(substring(contareceber.parcela, 1, position('/' in contareceber.parcela) - 1)) ");
		
		sb.append(" and ");
		sb.append(" case when parceiro.considerarParcelasMaterialDidaticoReajustePreco and parceiro.custeaParcelasMaterialDidatico and condicaopagamentoplanofinanceirocurso.considerarParcelasMaterialDidaticoReajustePreco and matricula.considerarParcelasMaterialDidaticoReajustePreco ");
		sb.append(" and exists (select contareceber.codigo from contareceber where contareceber.matriculaPeriodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MDI') ");
		sb.append(" then (cast(substring(contareceber.parcela, 1, position('/' in contareceber.parcela) - 1) as integer) > ").append(parcelaInicialReajuste).append(" - condicaopagamentoplanofinanceirocurso.quantidadeparcelasmaterialdidatico) ");
		sb.append(" else ");
		sb.append("  (cast(substring(contareceber.parcela, 1, position('/' in contareceber.parcela) - 1) as integer) > ").append(parcelaInicialReajuste).append(") ");
		sb.append(" end ");
		
		sb.append(" and contareceber.tipoorigem = 'BCC' ");
		
		sb.append(" and contareceber.situacao in('AR', 'NE') ");
		if (matriculaPeriodo > 0) {
			sb.append(" and contareceber.matriculaPeriodo = ").append(matriculaPeriodo);
		}
//		sb.append(" and (contareceber.codigo is null or (contareceber.codigo is not null and not exists(");
//		sb.append(" select distinct controleremessacontareceber.contareceber from controleremessacontareceber ");
//		sb.append(" where controleremessacontareceber.contareceber = contareceber.codigo ");
//		sb.append(" and controleremessacontareceber.situacao = 'REMETIDA' ))) ");
		
		sb.append("  and not exists ( ");
		sb.append("  select distinct indicePeriodo.codigo from indicereajusteperiodomatriculaperiodovencimento indicePeriodoVencimento "); 
		sb.append("  inner join indicereajustePeriodo indicePeriodo on indicePeriodo.codigo = indicePeriodoVencimento.indiceReajustePeriodo "); 
		sb.append("  where indicePeriodoVencimento.matriculaperiodo = matriculaPeriodo.codigo  ");
		sb.append("  and indicePeriodoVencimento.parcela = substring(contareceber.parcela, 1, position('/' in contareceber.parcela) - 1) ");
		sb.append("  and indicePeriodoVencimento.tipoorigem = 'BCC' ");
		sb.append("  and indicePeriodo.mes = '").append(MesAnoEnum.getMesData(dataInicioMes).name()).append("' ");
		sb.append("  and indicePeriodo.ano = '").append(ano).append("' ");
		sb.append("  and indicePeriodoVencimento.situacao = 'PROCESSADO' ) "); 
		
		sb.append(" order by matriculaperiodo.matricula, contareceber.parcela  ");
		if (limit1) {
			sb.append(" limit 1");
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<ContaReceberVO> listaContaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("contaReceber.codigo"));
			obj.getMatriculaAluno().setMatricula(tabelaResultado.getString("contaReceber.matriculaAluno"));
			obj.setParcela(tabelaResultado.getString("contaReceber.parcela"));
			obj.setMatriculaPeriodo(tabelaResultado.getInt("contaReceber.matriculaPeriodo"));
			obj.setDataVencimento(tabelaResultado.getDate("contaReceber.dataVencimento"));
			obj.setValor(tabelaResultado.getDouble("contaReceber.valor"));
			obj.setValorBaseContaReceber(tabelaResultado.getDouble("contaReceber.valorBaseContaReceber"));
			obj.setValorIndiceReajuste(tabelaResultado.getBigDecimal("contaReceber.valorIndiceReajuste"));
			obj.setSituacao(tabelaResultado.getString("contaReceber.situacao"));
			obj.setTipoOrigem(tabelaResultado.getString("contaReceber.tipoorigem"));
			obj.getContaCorrenteVO().setCodigo(tabelaResultado.getInt("contaReceber.contacorrente"));
			obj.setPossuiRemessa(tabelaResultado.getBoolean("possuiRemessa"));
			obj.getParceiroVO().setCodigo(tabelaResultado.getInt("parceiro.codigo"));
			obj.getParceiroVO().setRealizarReajustePrecoComBaseIndiceReajuste(tabelaResultado.getBoolean("parceiro.realizarReajustePrecoComBaseIndiceReajuste"));
			if(considerarDescontoSemValidadeCalculoIndiceReajuste) {
				obj.setValorDescontoSemValidade(tabelaResultado.getDouble("contareceber.valordescontosemvalidade"));
			}
			listaContaReceberVOs.add(obj);
		}

		return listaContaReceberVOs;
	}

	@Override
	public void realizaVinculoContaReceberConvenioComControleRemessaContaReceber(Integer codigo, UsuarioVO usuario) throws Exception {
		try {			
				getFacadeFactory().getControleRemessaContaReceberFacade().realizaVinculoContaReceberConvenio(codigo, usuario);
			
		} catch (Exception e) {
			throw e;
		}
		
	}
	
	public String consultarNossoNumeroCodigoContaReceber(Integer codigoContaReceber){
		
		StringBuilder sqlStr = new StringBuilder();
		
		sqlStr.append("select contaReceber.nossonumero from contaReceber where codigo = ").append(codigoContaReceber);
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (resultado.next()) {
			return resultado.getString("nossonumero");
		}
		return "";
		
	}
	
	private boolean verificarSituacaoQuitadaParcelaMatriculaPorCodigoContaReceber(Integer contaReceber) throws Exception {
		StringBuilder stringBuilder = new StringBuilder()
				.append(" SELECT contareceber.codigo contareceber ")
				.append(" FROM ")
				.append(" contareceber ")
				.append(" INNER JOIN contareceber contarecebermatricula ON (contareceber.matriculaaluno = contarecebermatricula.matriculaaluno ")
				.append(" AND contarecebermatricula.tipoorigem = '")
				.append(TipoOrigemContaReceber.MATRICULA.getValor())
				.append("' AND contareceber.matriculaperiodo = contarecebermatricula.matriculaperiodo) ")
				.append(" WHERE contareceber.codigo = ")
				.append(contaReceber)
				.append(" AND contareceber.tipoorigem = '")
				.append(TipoOrigemContaReceber.NEGOCIACAO.getValor())
				.append("' AND fn_verificarcontemparcelanegociadatipoorigem(contareceber.codorigem::integer, '")
				.append(TipoOrigemContaReceber.MATRICULA.getValor())
				.append("') AND fn_verificarcontemparcelanegociadarecebida(contarecebermatricula.codigo, true) ");
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(stringBuilder.toString());
		return resultado.next() && Uteis.isAtributoPreenchido(resultado.getInt("contareceber"));
	}
	
	public void realizarVerificacaoRegraImpressaoBoleto(List<ContaReceberVO> listaContasPagarVisaoAluno, ConfiguracaoFinanceiroVO configuracaoFinanceiroPrevilegiandoUnidadeEnsino, UsuarioVO usuarioLogado) throws Exception{
		if(Uteis.isAtributoPreenchido(listaContasPagarVisaoAluno)) {
			realizarVerificacaoBloquearPagamentoBoletoVencidoVisaoAluno(listaContasPagarVisaoAluno, configuracaoFinanceiroPrevilegiandoUnidadeEnsino, usuarioLogado);
			realizarVerificacaoBloquearPagamentoParcelaPendeteReajustePrecoVisaoAluno(listaContasPagarVisaoAluno, configuracaoFinanceiroPrevilegiandoUnidadeEnsino, usuarioLogado);
		}
	}

	private void realizarVerificacaoBloquearPagamentoParcelaPendeteReajustePrecoVisaoAluno(List<ContaReceberVO> listaContasPagarVisaoAluno,ConfiguracaoFinanceiroVO configuracaoFinanceiroPrevilegiandoUnidadeEnsino, UsuarioVO usuarioLogado) throws Exception {
		if(configuracaoFinanceiroPrevilegiandoUnidadeEnsino.getBloquearEmissaodeBoletoPagamentoParcelasPendenteReajustePreco()) {
			ContaReceberVO contaReceberMen = listaContasPagarVisaoAluno.stream().filter(cr -> cr.getTipoOrigem().equals("MEN")).findFirst().orElse(new ContaReceberVO());
			if(!Uteis.isAtributoPreenchido(contaReceberMen.getCodigo())) {
				return;
			}
			CondicaoPagamentoPlanoFinanceiroCursoVO condicaoPagamentoPlanoFinanceiroCursoVO = getFacadeFactory().getCondicaoPagamentoPlanoFinanceiroCursoFacade().consultarPorMatriculaPeriodo(contaReceberMen.getMatriculaPeriodo(), usuarioLogado);
			if(condicaoPagamentoPlanoFinanceiroCursoVO.getNrParcelasPeriodo() > 12) {
				Integer qtdVezesReajuster = condicaoPagamentoPlanoFinanceiroCursoVO.getNrParcelasPeriodo() / 12;
				for(ContaReceberVO contaReceber: listaContasPagarVisaoAluno) {
					if(Uteis.nrDiasEntreDatas(contaReceber.getDataVencimento(), new Date()) < 0 || !contaReceber.getTipoOrigem().equals("MEN")) {
						continue;
					}
					if(contaReceber.getMatriculaAluno().getPermiteExecucaoReajustePreco()) {
						realizarVerificacaoMatriculaComReajustePreco(usuarioLogado,condicaoPagamentoPlanoFinanceiroCursoVO, qtdVezesReajuster, contaReceber);	
					}
				}
			}
		}
	}

	private void realizarVerificacaoMatriculaComReajustePreco(UsuarioVO usuarioLogado,CondicaoPagamentoPlanoFinanceiroCursoVO condicaoPagamentoPlanoFinanceiroCursoVO, Integer qtdVezesReajuster, ContaReceberVO contaReceber) throws Exception {
		Integer parcelaInicialReajuste = 13;
		if(condicaoPagamentoPlanoFinanceiroCursoVO.isConsiderarParcelasMaterialDidaticoReajustePreco() && contaReceber.getMatriculaAluno().getConsiderarParcelasMaterialDidaticoReajustePreco()) {
			parcelaInicialReajuste = parcelaInicialReajuste -  condicaoPagamentoPlanoFinanceiroCursoVO.getQuantidadeParcelasMaterialDidatico().intValue();
		}
		for (int i = 1; i <= qtdVezesReajuster; i++) {
			String parcela = contaReceber.getParcela().contains("/") ? contaReceber.getParcela().substring(0, contaReceber.getParcela().indexOf("/")) : contaReceber.getParcela();
			if(Integer.valueOf(parcela) >= parcelaInicialReajuste) {
				List<IndiceReajustePeriodoMatriculaPeriodoVencimentoVO> listaPeriodoVencimentoVOs = getFacadeFactory().getIndiceReajustePeriodoMatriculaPeriodoVencimentoFacade().consultarPorMatriculaPeriodoSituacaoParcela(contaReceber.getMatriculaPeriodo(), SituacaoExecucaoEnum.PROCESSADO, parcela, "MENSALIDADE", usuarioLogado);
				if(Integer.valueOf(parcela) >= parcelaInicialReajuste && Integer.valueOf(parcela) < (parcelaInicialReajuste + 12)) {
					if(listaPeriodoVencimentoVOs.size() == i) {
						if(contaReceber.getHabilitarBotaoLinkBanco()) {	
							contaReceber.setPermiteImprimirBoletoLinkBanco(true);
						}else {
							contaReceber.setPermiteImprimirBoleto(true);
						}
					}else {
						contaReceber.setPermiteImprimirBoletoLinkBanco(false);
						contaReceber.setPermiteImprimirBoleto(false);
						contaReceber.setPermiteRecebimentoCartaoCreditoOnline(false);
						contaReceber.setEmissaoBloqueada(false);
					}
					break;
				}
				parcelaInicialReajuste = parcelaInicialReajuste + 12;	
			}else {
				break;
			}
		}
	}

	private void realizarVerificacaoBloquearPagamentoBoletoVencidoVisaoAluno(List<ContaReceberVO> listaContasPagarVisaoAluno,ConfiguracaoFinanceiroVO configuracaoFinanceiroPrevilegiandoUnidadeEnsino, UsuarioVO usuarioLogado) {
		if(configuracaoFinanceiroPrevilegiandoUnidadeEnsino.getBloquearEmissaoBoletoPagamentoVencidoVisaoAluno()) {
			Long quantidadeContasVencidas = listaContasPagarVisaoAluno.stream().filter(contaReceber -> Uteis.nrDiasEntreDatas(contaReceber.getDataVencimento(), new Date()) < 0 ).count();
			if(Uteis.isAtributoPreenchido(quantidadeContasVencidas)) {
				if(quantidadeContasVencidas.intValue() == 1) {
					realizarVerificacaoQtdDiasBoletoVencido(listaContasPagarVisaoAluno,configuracaoFinanceiroPrevilegiandoUnidadeEnsino.getQuantidadeDiasAtrasos(),Boolean.FALSE);
				}else {
					realizarVerificacaoQtdDiasBoletoVencido(listaContasPagarVisaoAluno,configuracaoFinanceiroPrevilegiandoUnidadeEnsino.getQuantidadeDiasAtrasos(),configuracaoFinanceiroPrevilegiandoUnidadeEnsino.getBloquearDemaisParcelasVencidas());
				}
			}
		}
		
	}

	private void realizarVerificacaoQtdDiasBoletoVencido(List<ContaReceberVO> listaContasPagarVisaoAluno,Integer quantidadeDiasAtraso, Boolean bloquearDemiasParcelasVencidas) {
		for(ContaReceberVO contaReceber: listaContasPagarVisaoAluno) {
			if(Uteis.nrDiasEntreDatas(contaReceber.getDataVencimento(), new Date()) < 0) {
				if(!bloquearDemiasParcelasVencidas) {
					if(Uteis.getObterDiferencaDiasEntreDuasData(new Date(), contaReceber.getDataVencimento()) <= quantidadeDiasAtraso) {
						if(contaReceber.getHabilitarBotaoLinkBanco()) {	
							contaReceber.setPermiteImprimirBoletoLinkBanco(true);
						}else {
							contaReceber.setPermiteImprimirBoleto(true);
						}
					}else {
						contaReceber.setPermiteImprimirBoletoLinkBanco(false);
						contaReceber.setPermiteImprimirBoleto(false);
						contaReceber.setPermiteRecebimentoCartaoCreditoOnline(false);
						contaReceber.setEmissaoBloqueada(false);
					}
				}else {
					contaReceber.setPermiteImprimirBoletoLinkBanco(false);
					contaReceber.setPermiteImprimirBoleto(false);
					contaReceber.setPermiteRecebimentoCartaoCreditoOnline(false);
					contaReceber.setEmissaoBloqueada(false);
				}
			}
		}
	}

	@Override
	public ContaReceberVO alterarVencimentoContaReceberWS(String paramObject) throws Exception {
		Type type = new TypeToken<ContaReceberVO>() {}.getType();
		Gson gson = new GsonBuilder().setDateFormat("MM-dd-yyyy HH:mm:ss").create();
		ContaReceberVO contaReceberVO = gson.fromJson(paramObject, type);
		if(!Uteis.isAtributoPreenchido(contaReceberVO.getCodigo())) {
			throw new Exception("O código da conta a receber deve ser diferente de zero!");
		}
		ContaReceberVO contaReceberEncontrata = getFacadeFactory().getContaReceberFacade().consultarPorChavePrimaria(contaReceberVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, new ConfiguracaoFinanceiroVO(), null);
		if(!Uteis.isAtributoPreenchido(contaReceberEncontrata.getCodigo())) {
			throw new Exception("Conta a Receber não encontrada!");
		}
		ConfiguracaoFinanceiroVO configuracaoFinanceiroVO = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_DADOSBASICOS, contaReceberEncontrata.getUnidadeEnsinoFinanceira().getCodigo(), null);
	
		
		getFacadeFactory().getAtualizacaoVencimentoFacade().executarAlteracaoDataVencimentoPorContaReceber(contaReceberEncontrata, false, true, true, contaReceberVO.getNovaDataVencimento(), 0, configuracaoFinanceiroVO, false, null);
		return contaReceberEncontrata;
	}

	
	@Override
	public List<ContaReceberVO> consultarContaReceberRecorrenciaAptasPagamentoPorMatriculaFormaPadraoPagamento(String matricula, FormaPadraoDataBaseCartaoRecorrenteEnum formaPadraoDataBaseCartaoRecorrente, HashMap<Integer, ContaReceberVO> mapContaReceberVOs) {
		StringBuilder sb = new StringBuilder();
		sb.append(" select contareceber.codigo from contareceber ");
		sb.append(" where contareceber.matriculaaluno = '").append(matricula).append("' ");
		if (formaPadraoDataBaseCartaoRecorrente.equals(FormaPadraoDataBaseCartaoRecorrenteEnum.DIA_FIXO)) {
			sb.append(" and contareceber.datavencimento >= '").append(Uteis.getDataJDBC(Uteis.getDataPrimeiroDiaMes(new Date()))).append("' ");
			sb.append(" and contareceber.datavencimento <= '").append(Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(new Date()))).append("' ");
		} else {
			sb.append(" and case when contareceber.datalimiteprimeirafaixadescontos is not null and contareceber.datalimiteprimeirafaixadescontos::date <= contareceber.datavencimento::date  ");
			sb.append(" then contareceber.datalimiteprimeirafaixadescontos::date = current_date ");
			sb.append(" else contareceber.datavencimento::date = current_date end ");
		}
		sb.append(" and (( contareceber.tipoorigem ='MDI') ");
		sb.append(" or  (contareceber.tipoorigem ='MEN' and  exists (select mp.codigo  from matriculaperiodo mp where mp.codigo = contareceber.matriculaperiodo  and mp.situacaomatriculaperiodo <> 'PR' and mp.situacaomatriculaperiodo <> 'PC' )) ");
		sb.append(" or (contareceber.tipoorigem ='NCR' and  exists (select ncr.codigo from negociacaocontareceber ncr  where ncr.codigo = contareceber.codigorenegociacao and ncr.permitirpagamentocartaocreditovisaoaluno ))) ");
		sb.append(" and contareceber.situacao  = 'AR' ");
		SqlRowSet dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<ContaReceberVO> listaContaReceberVOs = new ArrayList<ContaReceberVO>(0);
		while (dadosSQL.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(dadosSQL.getInt("codigo"));
			
			if (!mapContaReceberVOs.containsKey(obj.getCodigo())) {
				mapContaReceberVOs.put(obj.getCodigo(), obj);
				listaContaReceberVOs.add(obj);
			}
		}
		return listaContaReceberVOs;
	}
	
	@Override
	public Boolean consultarContaReceberRecebidaPorCodigo(Integer codigo) {
		StringBuilder sb = new StringBuilder();
		sb.append("select codigo from contaReceber where codigo = ").append(codigo);
		sb.append(" and situacao = 'RE' ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return true;
		}
		return false;
	}

	public List<ContaReceberVO> consultarContasPagarVisaoAluno(ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Integer codigoCurso, String matricula, String tipoContasAPagar, UsuarioVO usuarioVOCorrente,  int nivelMontarDados, UsuarioVO usuarioVO, Boolean origemAplicativo, Integer limite, Integer offset, DataModelo dataModelo, boolean permiteVisualizarParcelasPeriodoContratosEletronico , boolean permitePagamentoParcelasPeriodoContratosEletronico , List<Integer> matriculaPeriodosContratosPendenteRejeitado) throws Exception{
		List<ContaReceberVO> contaReceberVOs = new ArrayList<>();
		if (configuracaoGeralSistemaVO.getPermiteAlunoVerContasConvenio()) {
			if (usuarioVO.getIsApresentarVisaoPais()) {
				contaReceberVOs = consultaRapidaPorMatriculaEUnidadeEnsinoVisaoPais(usuarioVO.getPessoa().getCodigo(), usuarioVOCorrente.getPessoa().getCodigo(), matricula, tipoContasAPagar, 0, configuracaoFinanceiroVO, nivelMontarDados, usuarioVO, limite, offset, dataModelo);
			} else {
				contaReceberVOs = consultaRapidaPorMatriculaEUnidadeEnsinoVisaoAluno(matricula, tipoContasAPagar, 0, configuracaoFinanceiroVO, nivelMontarDados, usuarioVO, limite, offset, dataModelo);
			}
		} else {
			if (usuarioVO.getIsApresentarVisaoPais()) {
				String matriculaAluno = "";
				if (!origemAplicativo) {
					VisaoAlunoControle visaoAlunoControle = (VisaoAlunoControle) context().getExternalContext().getSessionMap().get("VisaoAlunoControle");
					if (visaoAlunoControle != null) {
						matriculaPeriodosContratosPendenteRejeitado.clear();
						matriculaAluno = visaoAlunoControle.getMatricula().getMatricula();
						matriculaPeriodosContratosPendenteRejeitado.addAll(getFacadeFactory().getDocumentoAssinadoFacade().consultarDocumentosPendenteRejeitadoMatricula(matriculaAluno, "ALUNO"));
					}
				} else {
					matriculaAluno = matricula;
				}
				contaReceberVOs = consultarPorResponsavelFinanceiroVisaoPais(tipoContasAPagar, usuarioVO.getPessoa().getCodigo(), usuarioVOCorrente.getPessoa().getCodigo(), matriculaAluno, 0, Arrays.asList("BCC"), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuarioVO, limite, offset, dataModelo, permiteVisualizarParcelasPeriodoContratosEletronico , matriculaPeriodosContratosPendenteRejeitado);
			} else {
				contaReceberVOs = consultarPorTipoCursoEUnidadeEnsino(tipoContasAPagar, usuarioVOCorrente.getPessoa().getCodigo(), codigoCurso, 0, Arrays.asList("BCC"), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuarioVO, limite, offset, dataModelo , permiteVisualizarParcelasPeriodoContratosEletronico ,  permitePagamentoParcelasPeriodoContratosEletronico , matriculaPeriodosContratosPendenteRejeitado);
			}
		}
		return contaReceberVOs;
	}
	
	@Override
	public Integer consultarQuantidadeContasAPagarVisaoAluno(ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Integer codigoCurso, String matricula, String tipoContasAPagar, UsuarioVO usuarioVOCorrente, Map<Integer, ConfiguracaoRecebimentoCartaoOnlineVO> configuracaoRecebimentoCartaoOnlineVOs, int nivelMontarDados, UsuarioVO usuarioVO, Boolean origemAplicativo, Integer limite, Integer offset) throws Exception {
		validarUsuarioConsultarMinhasContasReceber(usuarioVO);
		Integer quantidade = 0;
		if (configuracaoGeralSistemaVO.getPermiteAlunoVerContasConvenio()) {
			if (usuarioVO.getIsApresentarVisaoPais()) {
				quantidade = consultaQuantidadeRapidaPorMatriculaEUnidadeEnsinoVisaoPais(usuarioVO.getPessoa().getCodigo(), usuarioVOCorrente.getPessoa().getCodigo(), matricula, tipoContasAPagar, 0, configuracaoFinanceiroVO, nivelMontarDados, usuarioVO);
			} else {
				quantidade = consultaRapidaQuantidadePorMatriculaEUnidadeEnsinoVisaoAluno(matricula, tipoContasAPagar, 0, configuracaoFinanceiroVO, nivelMontarDados, usuarioVO, limite, offset);
			}
		} else {
			if (usuarioVO.getIsApresentarVisaoPais()) {
				quantidade = consultarQuantidadePorResponsavelFinanceiroVisaoPais(tipoContasAPagar, usuarioVO.getPessoa().getCodigo(), usuarioVOCorrente.getPessoa().getCodigo(), matricula, 0, Arrays.asList("BCC"), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuarioVO);
			} else {
				quantidade = consultarQuantidadePorTipoCursoEUnidadeEnsino(tipoContasAPagar, usuarioVOCorrente.getPessoa().getCodigo(), codigoCurso, 0, Arrays.asList("BCC"), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuarioVO, limite, offset);
			}
		}
		return quantidade;
	}
	
	public Integer consultaRapidaQuantidadePorMatriculaEUnidadeEnsinoVisaoAluno(String matricula, String situacao, Integer unidadeEnsino, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, int nivelMontarDados, UsuarioVO usuario, Integer limite, Integer offset) throws Exception {
		StringBuilder sqlStr = getSQLPadraoConsultaQuantidadeCompletaSemContaReceberRecebimento();
		sqlStr.append("WHERE matriculaAluno = '");
		sqlStr.append(matricula);
		sqlStr.append("' ");
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append(" AND unidadeEnsino.codigo = ");
			sqlStr.append(unidadeEnsino);
		}
		if (situacao.equals("EM")) {
			sqlStr.append(" AND contareceber.situacao = 'AR' ");
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		} else if (situacao.equals("MA")) {
			sqlStr.append(" AND contareceber.situacao = 'AR' ");
			sqlStr.append(" AND contareceber.datavencimento >= '").append(Uteis.getDataJDBC(Uteis.getDataPrimeiroDiaMes(new Date()))).append("' and contareceber.datavencimento <= '").append(Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(new Date()))).append("'");
		} else if (situacao.equals("PG")) {
			sqlStr.append(" AND contareceber.situacao = 'RE' ");
		} else if (situacao.equals("MB")) {
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if(resultado.next()) {
			return resultado.getInt("count");
		}
		return 0;
	}
	
	private StringBuilder getSQLPadraoConsultaQuantidadeCompletaSemContaReceberRecebimento() {
		StringBuilder sql = new StringBuilder();
		sql.append("select count(DISTINCT contareceber.codigo)" );
		sql.append("FROM contareceber ");
		sql.append("INNER JOIN unidadeensino ON (unidadeensino.codigo = contareceber.unidadeensino) ");
		sql.append("INNER JOIN unidadeensino as unidadeEnsinoFinanceira ON (unidadeEnsinoFinanceira.codigo = contareceber.unidadeEnsinoFinanceira) ");
		sql.append("INNER join contacorrente cc on contareceber.contacorrente = cc.codigo ");
		sql.append("LEFT JOIN pessoa ON (contareceber.pessoa = pessoa.codigo) ");		
		sql.append("LEFT JOIN funcionario ON (funcionario.codigo = contareceber.funcionario) ");
		sql.append("LEFT JOIN parceiro ON (parceiro.codigo = contareceber.parceiro) ");
		sql.append("LEFT JOIN pessoa as pessoafuncionario ON (pessoafuncionario.codigo = funcionario.pessoa) ");
		sql.append("LEFT JOIN matricula ON (matricula.matricula = contareceber.matriculaaluno) ");
		sql.append("LEFT JOIN pessoa as pessoamatricula ON (matricula.aluno = pessoamatricula.codigo) ");
		sql.append("LEFT JOIN pessoa as pessoacandidato ON (contareceber.candidato = pessoacandidato.codigo) ");
		sql.append("LEFT JOIN centroreceita ON (centroreceita.codigo = contareceber.centroreceita) ");
		sql.append("LEFT JOIN descontoprogressivo ON (contareceber.descontoprogressivo = descontoprogressivo.codigo) ");
		sql.append("LEFT JOIN pessoa as responsavelFinanceiro ON (contareceber.responsavelFinanceiro = responsavelFinanceiro.codigo) ");
		sql.append("LEFT JOIN turma as turma ON (contareceber.turma = turma.codigo) ");
		sql.append("LEFT JOIN planofinanceiroaluno on (planofinanceiroaluno.matriculaperiodo = contareceber.matriculaperiodo) ");
		sql.append("LEFT JOIN fornecedor ON (fornecedor.codigo = contareceber.fornecedor) ");
		sql.append(" LEFT JOIN indicereajuste ON (contareceber.indiceReajustePadraoPorAtraso = indicereajuste.codigo) ");
		return sql;
	}
	
	public Integer consultarQuantidadePorTipoCursoEUnidadeEnsino(String valorConsulta, Integer pessoa, Integer curso, Integer unidadeEnsino, List<String> listaTipoOrigemDesconsiderar, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario, Integer limite, Integer offset) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select count(DISTINCT ContaReceber.codigo) from ContaReceber ");
		sqlStr.append("LEFT JOIN matriculaPeriodo ON matriculaPeriodo.codigo = contareceber.matriculaperiodo ");
		sqlStr.append("LEFT JOIN matricula ON matricula.matricula = matriculaperiodo.matricula ");
		sqlStr.append("LEFT JOIN parceiro as parceiro on (parceiro.codigo = contareceber.parceiro)");
		sqlStr.append("WHERE pessoa = ").append(pessoa);
		if (Uteis.isAtributoPreenchido(curso)) {
			sqlStr.append(" AND CASE WHEN (matricula.matricula is not null AND matricula.matricula != '') THEN curso = ").append(curso).append(" ELSE true END");
		}
		if (Uteis.isAtributoPreenchido(unidadeEnsino)) {
			sqlStr.append(" and ContaReceber.unidadeensinofinanceira = ").append(unidadeEnsino);
		}
		if (valorConsulta.equalsIgnoreCase("EM")) {
			sqlStr.append(" AND ContaReceber.situacao = 'AR'");
			if (!configuracaoFinanceiroVO.getPermitiVisualizarContaReceberVisaoAlunoPreMatricula()) {
				sqlStr.append(" AND CASE WHEN matriculaperiodo.codigo is not null THEN MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ELSE true END");
			}
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		if (valorConsulta.equalsIgnoreCase("MA")) {
			sqlStr.append(" AND ContaReceber.situacao = 'AR'");
			sqlStr.append(" AND contareceber.datavencimento >= '").append(Uteis.getDataJDBC(Uteis.getDataPrimeiroDiaMes(new Date()))).append("' and contareceber.datavencimento <= '").append(Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(new Date()))).append("'");
		}
		if (valorConsulta.equalsIgnoreCase("VE")) {
			sqlStr.append(" AND ContaReceber.situacao = 'AR' AND dataVencimento <= '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("'");
		}
		if (valorConsulta.equalsIgnoreCase("AV")) {
			sqlStr.append(" AND ContaReceber.situacao = 'AR' AND dataVencimento > '").append(Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0))).append("'");
		}
		if (valorConsulta.equalsIgnoreCase("PG")) {
			sqlStr.append(" AND ContaReceber.situacao = 'RE'");
		}
		if (valorConsulta.equalsIgnoreCase("NE")) {
			sqlStr.append(" AND ContaReceber.situacao = 'NE'");
		}
		if (valorConsulta.equalsIgnoreCase("MB")) {
			sqlStr.append(" AND ((ContaReceber.situacao = 'AR'");
			if (!configuracaoFinanceiroVO.getPermitiVisualizarContaReceberVisaoAlunoPreMatricula()) {
				sqlStr.append(" AND CASE WHEN matriculaperiodo.codigo is not null THEN MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ELSE true END");
			}
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
			sqlStr.append(" ) ");
			sqlStr.append(" or (ContaReceber.situacao = 'RE'))");
		}
		if (Uteis.isAtributoPreenchido(listaTipoOrigemDesconsiderar)) {
			sqlStr.append(listaTipoOrigemDesconsiderar.stream().collect(Collectors.joining("', '", " AND contareceber.tipoorigem not in ('", "') ")));
		}
		sqlStr.append(" GROUP BY dataVencimento");
		sqlStr.append(" ORDER BY dataVencimento");
		if (limite != null && offset != null) {
			sqlStr.append(" limit ").append(limite.intValue());
			sqlStr.append(" offset ").append(offset.intValue());
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if(tabelaResultado.next()) {
			return tabelaResultado.getInt("count");
		}
		return 0;
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarUnidadeEnsino (TurmaVO turmaVO, boolean validarAcesso, UsuarioVO usuarioVO) throws Exception {
		 final StringBuilder sqlStr = new StringBuilder();
		 sqlStr.append("UPDATE contareceber SET unidadeensino  = turma.unidadeensino  FROM turma WHERE contareceber.turma = turma.codigo AND turma.codigo = ?");
		 sqlStr.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));

		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sqlStr.toString());
				int i = 0;
				Uteis.setValuePreparedStatement(turmaVO.getCodigo(), ++i, sqlAlterar);
				return sqlAlterar;
			}
		});
	}
	
	@Override
	public Integer consultarQuantidadePorResponsavelFinanceiroVisaoPais(String situacao, Integer pais, Integer filho, String matriculaAluno, Integer unidadeEnsino, List<String> listaTipoOrigemDesconsiderar, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		String sqlStr = "select count(DISTINCT ContaReceber.codigo) ";
		sqlStr += getSQLPadraoConsultaBasicaFrom();
		sqlStr += " left JOIN matriculaPeriodo ON matriculaPeriodo.codigo = contareceber.matriculaperiodo ";
		if (situacao.equalsIgnoreCase("EM")) {
			sqlStr += "AND MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ";
		}

		sqlStr += " WHERE ";
		if (pais != null && matriculaAluno != null) {
			sqlStr += " ( contareceber.responsavelFinanceiro = " + pais + " or ( matricula.matricula ) = ('" + matriculaAluno + "') )";
		} else if (pais != null && filho != null) {
			sqlStr += " ( contareceber.responsavelFinanceiro = " + pais + " or (contareceber.pessoa ) = (" + filho + ") )";
		} else {
			sqlStr += " contareceber.responsavelFinanceiro = " + pais;
		}
		if (unidadeEnsino.intValue() != 0) {
			sqlStr += " and ContaReceber.unidadeensinofinanceira  = (" + unidadeEnsino + ") ";
		}
		if (situacao.equalsIgnoreCase("EM")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' ";			
			if (!configuracaoFinanceiroVO.getPermitiVisualizarContaReceberVisaoAlunoPreMatricula()) {
				sqlStr += (" AND CASE WHEN matriculaperiodo.codigo is not null THEN MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ELSE true END");
			}
			if (!configuracaoFinanceiroVO.getPermitiVisualizarContaReceberVisaoAlunoPreMatricula()) {
				sqlStr += (" AND CASE WHEN matriculaperiodo.codigo is not null THEN MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ELSE true END");
			}
			sqlStr += getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO);
		}
		if (situacao.equalsIgnoreCase("VE")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' AND dataVencimento <= '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (situacao.equalsIgnoreCase("AV")) {
			sqlStr += "AND ContaReceber.situacao = 'AR' AND dataVencimento > '" + Uteis.getDataJDBC(Uteis.getDateTime(new Date(), 0, 0, 0)) + "' ";
		}
		if (situacao.equalsIgnoreCase("PG")) {
			sqlStr += "AND ContaReceber.situacao = 'RE' ";
		}
		if (situacao.equalsIgnoreCase("NE")) {
			sqlStr += "AND ContaReceber.situacao = 'NE' ";
		}
		if (situacao.equalsIgnoreCase("MB")) {
			sqlStr += (" AND ((ContaReceber.situacao = 'AR'");
			if (!configuracaoFinanceiroVO.getPermitiVisualizarContaReceberVisaoAlunoPreMatricula()) {
				sqlStr += (" AND CASE WHEN matriculaperiodo.codigo is not null THEN MatriculaPeriodo.situacaoMatriculaPeriodo <> 'PR' ELSE true END");
			}
			sqlStr += getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO);
			sqlStr += (" ) ");
			sqlStr += (" or (ContaReceber.situacao = 'RE'))");
		}
		if (situacao.equalsIgnoreCase("MA")) {
			sqlStr += " AND ContaReceber.situacao = 'AR'";
			sqlStr += " AND contareceber.datavencimento >= '";
			sqlStr += Uteis.getDataJDBC(Uteis.getDataPrimeiroDiaMes(new Date()));
			sqlStr += "' and contareceber.datavencimento <= '";
			sqlStr += Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(new Date()));
			sqlStr += "'";
			sqlStr += getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO);
		}
		if (Uteis.isAtributoPreenchido(listaTipoOrigemDesconsiderar)) {
			sqlStr += listaTipoOrigemDesconsiderar.stream().collect(Collectors.joining("', '", " AND contareceber.tipoorigem not in ('", "') "));
		}

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if(tabelaResultado.next()) {
			return tabelaResultado.getInt("count");
		}
		return 0;
	}
	
	@Override
	public Integer consultaQuantidadeRapidaPorMatriculaEUnidadeEnsinoVisaoPais(Integer pais, Integer filho, String matricula, String situacao, Integer unidadeEnsino, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		// StringBuilder sqlStr = getSQLPadraoConsultaCompleta();

		/*
		 * Regra alterada porque a consulta apresentava mais de um registro para uma conta recebida com mais de uma forma de pagamento, o resultado apresentava em duplicidade por conta da tabela contareceberrecebimento.
		 */
		StringBuilder sqlStr = getSQLPadraoConsultaQuantidadeCompletaSemContaReceberRecebimento();
		sqlStr.append(" WHERE ");
		if (pais != null && matricula != null) {
			sqlStr.append(" ( contareceber.responsavelFinanceiro = " + pais + " or ( matricula.matricula ) = ('" + matricula + "') )");
		} else if (pais != null && filho != null) {
			sqlStr.append(" ( contareceber.responsavelFinanceiro = " + pais + " or (contareceber.pessoa ) = (" + filho + ") )");
		} else {
			sqlStr.append(" contareceber.responsavelFinanceiro = " + pais);
		}
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append(" AND unidadeEnsino.codigo = ");
			sqlStr.append(unidadeEnsino);
		}
		if (situacao.equals("EM")) {
			sqlStr.append(" AND contareceber.situacao = 'AR' ");
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		if (situacao.equals("PG")) {
			sqlStr.append(" AND contareceber.situacao = 'RE' ");
		}
		
		if (situacao.equals("MB")) {
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		
		if (situacao.equalsIgnoreCase("MA")) {
			sqlStr.append(" AND ContaReceber.situacao = 'AR'");
			sqlStr.append(" AND contareceber.datavencimento >= '").append(Uteis.getDataJDBC(Uteis.getDataPrimeiroDiaMes(new Date()))).append("' and contareceber.datavencimento <= '").append(Uteis.getDataJDBC(Uteis.getDataUltimoDiaMes(new Date()))).append("'");
			sqlStr.append(getFiltroQuantidadeDiasAntesVencimentoApresentarContaReceberVisaoAluno(configuracaoFinanceiroVO));
		}
		
		SqlRowSet resultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if(resultado.next()) {
			return resultado.getInt("count");
		}
		return 0;
	}

	private boolean validarPermissaoNegociarContaReceberVinculadaParceiro(ContaReceberVO contaReceberVO) {
		return (contaReceberVO.getTipoOrigem().equals(TipoOrigemContaReceber.MENSALIDADE.getValor())
				|| contaReceberVO.getTipoOrigem().equals(TipoOrigemContaReceber.BOLSA_CUSTEADA_CONVENIO.getValor())
				|| contaReceberVO.getTipoOrigem().equals(TipoOrigemContaReceber.MATRICULA.getValor())
				|| contaReceberVO.getTipoOrigem().equals(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor())) ?
			!permiteEmitirBoletoAlunoVinculadoParceiro(contaReceberVO.getCodigo()) : false;
	}
		private void validarPreenchimentoTelefonePessoa(SqlRowSet tabelaResultado , ControleRemessaContaReceberVO obj) {
			
			if(tabelaResultado.getString("codigoInscricao").equals("01")) {
				if (tabelaResultado.getBoolean("possuiRespFin")) {
					if(Uteis.isAtributoPreenchido(tabelaResultado.getString("responsavelFinanceiro.telefoneres"))) {
						obj.setTelefoneSacado(tabelaResultado.getString("responsavelFinanceiro.telefoneres"));
					}else if(Uteis.isAtributoPreenchido(tabelaResultado.getString("responsavelFinanceiro.telefonerecado"))) {
						obj.setTelefoneSacado(tabelaResultado.getString("responsavelFinanceiro.telefonerecado"));
					}else if(Uteis.isAtributoPreenchido(tabelaResultado.getString("responsavelFinanceiro.telefonecomer"))) {
						obj.setTelefoneSacado(tabelaResultado.getString("responsavelFinanceiro.telefonecomer"));
					}else if(Uteis.isAtributoPreenchido(tabelaResultado.getString("responsavelFinanceiro.celular"))) {
						obj.setTelefoneSacado(tabelaResultado.getString("responsavelFinanceiro.celular"));
					}
					
				}else {
                    if(Uteis.isAtributoPreenchido(tabelaResultado.getString("telefoneres"))) {
                    	obj.setTelefoneSacado(tabelaResultado.getString("telefoneres"));
					}else if(Uteis.isAtributoPreenchido(tabelaResultado.getString("telefonerecado"))) {
						obj.setTelefoneSacado(tabelaResultado.getString("telefonerecado"));
					}else if(Uteis.isAtributoPreenchido(tabelaResultado.getString("telefonecomer"))) {
						obj.setTelefoneSacado(tabelaResultado.getString("telefonecomer"));
					}else if(Uteis.isAtributoPreenchido(tabelaResultado.getString("celular"))) {
						obj.setTelefoneSacado(tabelaResultado.getString("celular"));
					}
					
				}
			}else {
				if (tabelaResultado.getBoolean("isparceiro")) {
					   if(Uteis.isAtributoPreenchido(tabelaResultado.getString("parceiro.telcomercial1"))) {
						   obj.setTelefoneSacado(tabelaResultado.getString("parceiro.telcomercial1"));
						}else if(Uteis.isAtributoPreenchido(tabelaResultado.getString("parceiro.telcomercial2"))) {
							obj.setTelefoneSacado(tabelaResultado.getString("parceiro.telcomercial2"));
						}else if(Uteis.isAtributoPreenchido(tabelaResultado.getString("parceiro.telcomercial3"))) {
							obj.setTelefoneSacado(tabelaResultado.getString("parceiro.telcomercial3"));
						}
				}else {
					  if(Uteis.isAtributoPreenchido(tabelaResultado.getString("fornecedor.telcomercial1"))) {
						  obj.setTelefoneSacado(tabelaResultado.getString("fornecedor.telcomercial1"));
						}else if(Uteis.isAtributoPreenchido(tabelaResultado.getString("fornecedor.telcomercial2"))) {
							obj.setTelefoneSacado(tabelaResultado.getString("fornecedor.telcomercial2"));
						}else if(Uteis.isAtributoPreenchido(tabelaResultado.getString("fornecedor.telcomercial3"))) {
							obj.setTelefoneSacado(tabelaResultado.getString("fornecedor.telcomercial3"));
						}
				}
				
			}
			
		}

		@Override
		public boolean consultarExistenciaContaReceber(Integer contaReceber) {
			String sql = "SELECT codigo FROM ContaReceber WHERE codigo = ?";
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql, new Object[] { contaReceber });
			if (tabelaResultado.next()) {
				return true;
			}
			return false;
		}
	
	private void realizarAdicaoTotalizadoresContaReceber(StringBuilder stringBuilder) {
		stringBuilder.append(" count(*) over() as qtde_total_registros, sum(contareceber.valor) over() as valortotal_base_contareceber, ");
		stringBuilder.append(" sum(case when contareceber.processamentointegracaofinanceiradetalhe is not null then (contareceber.valor + coalesce(contareceber.juro, 0.00) + coalesce(contareceber.acrescimo, 0.00) + coalesce(contareceber.valorindicereajusteporatraso, 0.00) - coalesce(contareceber.valordescontoalunojacalculado, 0.00))"); 
		stringBuilder.append(" else case when contareceber.situacao = 'AR' then contareceber.valorrecebercalculado else case when contareceber.situacao = 'RE' then contareceber.valorrecebido end end end ) over () as valortotal_final_contareceber, ");
		stringBuilder.append(" sum(case when contareceber.situacao = 'CF' then contareceber.valor else 0 end) over() as valortotal_cancelado_contareceber, ");
		stringBuilder.append(" sum(case when contareceber.situacao = 'NE' then contareceber.valor else 0 end) over() as valortotal_negociado_contareceber, ");
		stringBuilder.append(" sum(case when contareceber.situacao = 'RE' and contareceber.processamentointegracaofinanceiradetalhe is not null then (contareceber.valor + coalesce(contareceber.juro, 0.00) + coalesce(contareceber.acrescimo, 0.00) + coalesce(contareceber.valorindicereajusteporatraso, 0.00) - coalesce(contareceber.valordescontoalunojacalculado, 0.00))");
		stringBuilder.append(" else case when contareceber.situacao = 'RE' and contareceber.processamentointegracaofinanceiradetalhe is null then contareceber.valorrecebido else 0 end end) over() as valortotal_pago_contareceber, ");
	}
	
	private void realizarMontagemTotalizadoresContaReceber(SqlRowSet sqlRowSet, DataModelo dataModelo) {
		inicializarTotalizadoresContaReceber(dataModelo);
		if (sqlRowSet.next()) {
			dataModelo.setTotalRegistrosEncontrados(sqlRowSet.getInt("qtde_total_registros"));
			dataModelo.getTotalizadores().put("valortotal_base_contareceber", sqlRowSet.getDouble("valortotal_base_contareceber"));
			dataModelo.getTotalizadores().put("valortotal_final_contareceber", sqlRowSet.getDouble("valortotal_final_contareceber"));
			dataModelo.getTotalizadores().put("valortotal_cancelado_contareceber", sqlRowSet.getDouble("valortotal_cancelado_contareceber"));
			dataModelo.getTotalizadores().put("valortotal_negociado_contareceber", sqlRowSet.getDouble("valortotal_negociado_contareceber"));
			dataModelo.getTotalizadores().put("valortotal_pago_contareceber", sqlRowSet.getDouble("valortotal_pago_contareceber"));
		}
		sqlRowSet.beforeFirst();
	}

	private void inicializarTotalizadoresContaReceber(DataModelo dataModelo) {
		dataModelo.setTotalRegistrosEncontrados(0);
		dataModelo.getTotalizadores().put("valortotal_base_contareceber", 0.0);
		dataModelo.getTotalizadores().put("valortotal_final_contareceber", 0.0);
		dataModelo.getTotalizadores().put("valortotal_cancelado_contareceber", 0.0);
		dataModelo.getTotalizadores().put("valortotal_negociado_contareceber", 0.0);
		dataModelo.getTotalizadores().put("valortotal_pago_contareceber", 0.0);
	}
    @Override
    public List<ContaReceberVO> consultarContaReceberMatriculaMensalidadeNegociacao(Integer negociacaoContaReceber, UsuarioVO usuario) throws Exception {
    	ControleAcesso.consultar(getIdEntidade(), false, usuario);
    	List<ContaReceberVO> contaReceberVOs = new ArrayList<ContaReceberVO>();
    	StringBuilder sb = new StringBuilder();
    	sb.append("with recursive arvore_contarecebermatricula_negociacao as ( ");
    	sb.append("select cr.codigo, cr.matriculaperiodo, cr.matriculaaluno, ncr.codigo as codigo_negociacao, cr.tipoorigem, cr.codorigem as codorigem ");
    	sb.append("from contarecebernegociado crn ");
    	sb.append("inner join contareceber cr on crn.contareceber = cr.codigo ");
    	sb.append("inner join negociacaocontareceber ncr on crn.negociacaocontareceber = ncr.codigo ");
    	sb.append("where ncr.codigo = ").append(negociacaoContaReceber);
    	sb.append("union all ");
    	sb.append("select distinct	cr.codigo,	cr.matriculaperiodo, cr.matriculaaluno, ncr.codigo as codigo_negociacao, cr.tipoorigem, cr.codorigem as codorigem ");
    	sb.append("from contarecebernegociado crn ");
    	sb.append("inner join contareceber cr on crn.contareceber = cr.codigo ");
    	sb.append("inner join negociacaocontareceber ncr on crn.negociacaocontareceber = ncr.codigo ");
    	sb.append("inner join arvore_contarecebermatricula_negociacao on arvore_contarecebermatricula_negociacao.tipoorigem = 'NCR' ");
    	sb.append("and arvore_contarecebermatricula_negociacao.codorigem = ncr.codigo::varchar) ");
    	sb.append("select * from arvore_contarecebermatricula_negociacao ");
    	sb.append("where arvore_contarecebermatricula_negociacao.tipoorigem in ('MAT','MEN')");
    	SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (tabelaResultado.next()) {
			ContaReceberVO obj = new ContaReceberVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setMatriculaPeriodo(tabelaResultado.getInt("matriculaperiodo"));
			obj.getMatriculaAluno().setMatricula(tabelaResultado.getString("matriculaaluno"));
			obj.setTipoOrigem(tabelaResultado.getString("tipoorigem"));
			contaReceberVOs.add(obj);
		}
		return contaReceberVOs;
    }
    
    public boolean verificarBloqueioEmissaoBoletoContratoRejeitado(ContaReceberVO obj, UsuarioVO usuario , String matricula) throws Exception {
		boolean permiteVisualizarParcelasPeriodoContratosEletronico = verificarPermissaoOperacao(usuario.getPerfilAcesso().getCodigo(), "PermiteVisualizarParcelasPeriodoContratosEletronico", 1);
		boolean permitePagamentoParcelasPeriodoContratosEletronico = verificarPermissaoOperacao(usuario.getPerfilAcesso().getCodigo(), "PermitePagamentoParcelasPeriodoContratosEletronico", 1);
		List<Integer> matriculaPeriodosContratosPendenteRejeitado = getFacadeFactory().getDocumentoAssinadoFacade().consultarDocumentosPendenteRejeitadoMatricula(matricula, "");
		boolean matriculaPeriodoBloqueadaPagamento = matriculaPeriodosContratosPendenteRejeitado.stream().anyMatch(obj.getMatriculaPeriodo()::equals);
		if (permiteVisualizarParcelasPeriodoContratosEletronico && !permitePagamentoParcelasPeriodoContratosEletronico && matriculaPeriodoBloqueadaPagamento) {
			return false;
		}
		return true;
}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	 public void removerVinculoPeriodoContasBibOut(Integer matriculaPeriodo, UsuarioVO usuarioVO) throws Exception {
	    	try {
	    		StringBuilder sqlStr = new StringBuilder();
	    		sqlStr.append("UPDATE contaReceber set matriculaperiodo = null where tipoorigem in ('BIB', 'OUT') and matriculaperiodo = '").append(matriculaPeriodo).append("' ");
	    		getConexao().getJdbcTemplate().update(sqlStr.toString());
	    	} catch (Exception e) {
	    		throw e;
	    	}
	    }
	
}
