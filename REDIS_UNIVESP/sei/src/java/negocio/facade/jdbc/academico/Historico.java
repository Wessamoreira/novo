package negocio.facade.jdbc.academico;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.NumberFormat;
import java.text.ParseException;
import java.util.*;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.faces.model.SelectItem;

import negocio.comuns.administrativo.UnidadeEnsinoVO;
import org.springframework.context.annotation.Lazy;
import org.springframework.context.annotation.Scope;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.PreparedStatementCreator;
import org.springframework.jdbc.core.ResultSetExtractor;
import org.springframework.jdbc.support.rowset.SqlRowSet;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import controle.arquitetura.DataModelo;
import negocio.comuns.academico.CalendarioLancamentoNotaVO;
import negocio.comuns.academico.ConfiguracaoAcademicaNotaVO;
import negocio.comuns.academico.ConfiguracaoAcademicoNotaConceitoVO;
import negocio.comuns.academico.ConfiguracaoAcademicoVO;
import negocio.comuns.academico.CursoVO;
import negocio.comuns.academico.DisciplinaAproveitadaAlteradaMatriculaVO;
import negocio.comuns.academico.DisciplinaPreRequisitoVO;
import negocio.comuns.academico.DisciplinaVO;
import negocio.comuns.academico.DisciplinasAproveitadasVO;
import negocio.comuns.academico.GradeCurricularGrupoOptativaDisciplinaVO;
import negocio.comuns.academico.GradeCurricularGrupoOptativaVO;
import negocio.comuns.academico.GradeCurricularVO;
import negocio.comuns.academico.GradeDisciplinaCompostaVO;
import negocio.comuns.academico.GradeDisciplinaVO;
import negocio.comuns.academico.HistoricoGradeAnteriorAlteradaVO;
import negocio.comuns.academico.HistoricoNotaParcialVO;
import negocio.comuns.academico.HistoricoNotaVO;
import negocio.comuns.academico.HistoricoVO;
import negocio.comuns.academico.MapaEquivalenciaDisciplinaCursadaVO;
import negocio.comuns.academico.MapaEquivalenciaDisciplinaMatrizCurricularVO;
import negocio.comuns.academico.MapaEquivalenciaDisciplinaVO;
import negocio.comuns.academico.MatriculaComHistoricoAlunoVO;
import negocio.comuns.academico.MatriculaPeriodoTurmaDisciplinaVO;
import negocio.comuns.academico.MatriculaPeriodoVO;
import negocio.comuns.academico.MatriculaVO;
import negocio.comuns.academico.PeriodoLetivoAtivoUnidadeEnsinoCursoVO;
import negocio.comuns.academico.PeriodoLetivoVO;
import negocio.comuns.academico.ProgramacaoFormaturaAlunoVO;
import negocio.comuns.academico.TransferenciaEntradaDisciplinasAproveitadasVO;
import negocio.comuns.academico.TurmaDisciplinaEstatisticaAlunoVO;
import negocio.comuns.academico.TurmaDisciplinaNotaParcialVO;
import negocio.comuns.academico.TurmaDisciplinaNotaTituloVO;
import negocio.comuns.academico.TurmaVO;
import negocio.comuns.academico.enumeradores.BimestreEnum;
import negocio.comuns.academico.enumeradores.ClassificacaoDisciplinaEnum;
import negocio.comuns.academico.enumeradores.DefinicoesTutoriaOnlineEnum;
import negocio.comuns.academico.enumeradores.FormulaCalculoNotaEnum;
import negocio.comuns.academico.enumeradores.ModalidadeDisciplinaEnum;
import negocio.comuns.academico.enumeradores.RegraCalculoDisciplinaCompostaEnum;
import negocio.comuns.academico.enumeradores.SituacaoMatriculaPeriodoEnum;
import negocio.comuns.academico.enumeradores.SituacaoRecuperacaoNotaEnum;
import negocio.comuns.academico.enumeradores.TipoCalculoCargaHorariaFrequencia;
import negocio.comuns.academico.enumeradores.TipoNotaConceitoEnum;
import negocio.comuns.academico.enumeradores.TipoSubTurmaEnum;
import negocio.comuns.academico.enumeradores.TipoUsoConfiguracaoAcademicoEnum;
import negocio.comuns.administrativo.ConfiguracaoGeralSistemaVO;
import negocio.comuns.administrativo.FuncionarioVO;
import negocio.comuns.administrativo.enumeradores.TipoCampoEnum;
import negocio.comuns.arquitetura.UsuarioVO;
import negocio.comuns.arquitetura.enumeradores.PerfilAcessoPermissaoVisaoAlunoEnum;
import negocio.comuns.blackboard.BlackboardFechamentoNotaOperacaoVO;
import negocio.comuns.blackboard.SalaAulaBlackboardNotaVO;
import negocio.comuns.ead.enumeradores.TipoCalendarioAtividadeMatriculaEnum;
import negocio.comuns.financeiro.ConfiguracaoFinanceiroVO;
import negocio.comuns.secretaria.enumeradores.FormaReplicarNotaOutraDisciplinaEnum;
import negocio.comuns.secretaria.enumeradores.TipoAlteracaoSituacaoHistoricoEnum;
import negocio.comuns.utilitarias.ConsistirException;
import negocio.comuns.utilitarias.FechamentoPeriodoLetivoException;
import negocio.comuns.utilitarias.Ordenacao;
import negocio.comuns.utilitarias.ProcessarParalelismo;
import negocio.comuns.utilitarias.StreamSeiException;
import negocio.comuns.utilitarias.Uteis;
import negocio.comuns.utilitarias.UteisJSF;
import negocio.comuns.utilitarias.UtilReflexao;
import negocio.comuns.utilitarias.dominios.NivelFormacaoAcademica;
import negocio.comuns.utilitarias.dominios.OrdemHistoricoDisciplina;
import negocio.comuns.utilitarias.dominios.SituacaoHistorico;
import negocio.comuns.utilitarias.dominios.TipoHistorico;
import negocio.comuns.utilitarias.dominios.TipoNivelEducacional;
import negocio.comuns.utilitarias.faturamento.nfe.UteisData;
import negocio.comuns.utilitarias.faturamento.nfe.UteisTexto;
import negocio.facade.jdbc.arquitetura.ControleAcesso;
import negocio.facade.jdbc.utilitarias.NivelMontarDados;
import negocio.interfaces.academico.HistoricoInterfaceFacade;
import relatorio.negocio.comuns.academico.HistoricoAlunoDisciplinaRelVO;
import relatorio.negocio.jdbc.academico.FiltroRelatorioAcademicoVO;
import webservice.moodle.NotasRSVO;

/**
 * Classe de persistência que encapsula todas as operações de manipulação dos
 * dados da classe <code>HistoricoVO</code>. Responsável por implementar
 * operações como incluir, alterar, excluir e consultar pertinentes a classe
 * <code>HistoricoVO</code>. Encapsula toda a interação com o banco de dados.
 *
 * @see HistoricoVO
 * @see ControleAcesso
 */
@Lazy
@Repository
@Scope("singleton")
@SuppressWarnings({"unchecked", "rawtypes"})
public class Historico extends ControleAcesso implements HistoricoInterfaceFacade {

	protected static String idEntidade;
	private final Lock bloqueio = new ReentrantLock();
	public static final long serialVersionUID = 1L;

	public Historico() throws Exception {
		super();
		setIdEntidade("Historico");
	}

	/**
	 * Operação responsável por retornar um novo objeto da classe
	 * <code>HistoricoVO</code>.
	 */
	public HistoricoVO novo() throws Exception {
		Historico.incluir(getIdEntidade());
		HistoricoVO obj = new HistoricoVO();
		return obj;
	}

	public void validarUsuarioConsultarMinhasNotas(UsuarioVO usuario) throws Exception {
		if (usuario.getIsApresentarVisaoAdministrativa()) {
			setIdEntidade("MinhasNotasAdminsitrativo");
		} else {
			setIdEntidade("MinhasNotas");
		}
		Historico.consultar(getIdEntidade(), true, usuario);
		setIdEntidade("Historico");
	}

	private Double calcularFrequenciaAluno(Integer codigoTurma, Integer codigoDisciplina, String semestre, String ano, String matricula, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuario, Double cargaHoraria, boolean considerarTurmaTeoricaEPratica, Integer turmaTeorica, Integer turmaPratica, Boolean considerarHoraAulaSessentaMinutosGeracaoDiario) throws Exception {
		Double frequencia = 0.0;
		Integer somaPresencaAluno = 0;
		if (considerarTurmaTeoricaEPratica) {
			somaPresencaAluno = getFacadeFactory().getFrequenciaAulaFacade().consultarSomaFrequenciaAlunoEspecificoConsiderantoTurmaTeoricaETurmaPratica(matricula, semestre, ano, codigoTurma, codigoDisciplina, false, usuario);
		} else {
			somaPresencaAluno = getFacadeFactory().getFrequenciaAulaFacade().consultarSomaFrequenciaAlunoEspecifico(matricula, semestre, ano, codigoTurma, codigoDisciplina, true, false, usuario);
		}
		if (configuracaoAcademicoVO.getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_REGISTRO_AULA)) {
			Integer somaCargaHorariaDisciplina = 0;
			if (considerarTurmaTeoricaEPratica) {
				somaCargaHorariaDisciplina = getFacadeFactory().getRegistroAulaFacade().consultarSomaCargaHorariaDisciplinaConsiderantoTurmaTeoricaETurmaPratica(turmaPratica, turmaTeorica,  semestre, ano, codigoDisciplina, false, usuario);
			} else {
				somaCargaHorariaDisciplina = getFacadeFactory().getRegistroAulaFacade().consultarSomaCargaHorarioDisciplina(codigoTurma, semestre, ano, codigoDisciplina, false, usuario, true);
			}
			if (somaCargaHorariaDisciplina == 0) {
				return 0.0;
			}
			frequencia = (somaPresencaAluno.doubleValue() * 100) / somaCargaHorariaDisciplina;
			if (frequencia > 100) {
				frequencia = 100.0;
			}
		} else if (configuracaoAcademicoVO.getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_DISCIPLINA)) {
			//Foi removido a regra de se somaPresencaAluno tiver 0 a frequência será 100% por gerar inconsistência no relatório de histórico da turma
			//pois os alunos nesse cenário possuem faltas e está havendo confusão.
			if (cargaHoraria == 0) {
				frequencia = 100.0;
			} else {
				frequencia = (Uteis.converterMinutosEmHoras(somaPresencaAluno.doubleValue()) * 100) / cargaHoraria;
				if (frequencia > 100) {
					frequencia = 100.0;
				}
			}
		} else if (configuracaoAcademicoVO.getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA)) {
			//Foi removido a regra de se somaPresencaAluno tiver 0 a frequência será 100% por gerar inconsistência no relatório de histórico da turma
			//pois os alunos nesse cenário possuem faltas e está havendo confusão.
			if (cargaHoraria == 0) {
				frequencia = 100.0;
			} else {
				if (considerarHoraAulaSessentaMinutosGeracaoDiario) {
					frequencia = (((somaPresencaAluno.doubleValue()/60)) * 100) / cargaHoraria;
				} else {
					frequencia = (((somaPresencaAluno.doubleValue()/50)) * 100) / cargaHoraria;
				}
//				frequencia = (Uteis.converterMinutosEmHoras(somaPresencaAluno.doubleValue()) * 100) / cargaHoraria;
				if (frequencia > 100) {
					frequencia = 100.0;
				}
			}
		}
		return frequencia;
	}

	public Double calcularFrequenciaAlunoDisciplinaComposta(Integer codigoTurma, Integer codigoDisciplina, String semestre, String ano, String matricula, UsuarioVO usuario) throws Exception {
		Double frequencia = 0.0;
		Integer soma = getFacadeFactory().getRegistroAulaFacade().consultarSomaCargaHorarioDisciplinaComposta(codigoTurma, semestre, ano, codigoDisciplina, false, usuario);
		if (soma.intValue() == 0) {
			// return new Double(100);
			return new Double(0.0);
			// throw new
			// Exception("Não existe um registro de aula para essa disciplina.");
		}
		Integer somaPresencaAluno = getFacadeFactory().getFrequenciaAulaFacade().consultarSomaFrequenciaAlunoEspecificoDisciplinaComposta(matricula, semestre, ano, codigoTurma, codigoDisciplina, true, false, usuario);
		frequencia = new Double((somaPresencaAluno.doubleValue() * 100) / soma.doubleValue());
		if (frequencia > 100) {
			frequencia = new Double(100);
		}
		return frequencia;
	}

	public Double calcularFrequenciaAluno(Integer codigoTurma, Integer codigoDisciplina, String semestre, String ano, String matricula, Integer cargaHorariaDisciplina, Double somaPresencaAluno, UsuarioVO usuario) throws Exception {
		Double frequencia = 0.0;
		Integer soma = null;
		soma = getFacadeFactory().getRegistroAulaFacade().consultarSomaCargaHorarioDisciplina(codigoTurma, semestre, ano, codigoDisciplina, false, usuario);
		if (soma == null || soma.equals(0)) {
			soma = cargaHorariaDisciplina;
		}
		if (soma.intValue() == 0) {
			return new Double(0.0);
		}
		frequencia = new Double((somaPresencaAluno.doubleValue() * 100) / soma.doubleValue());
		if (frequencia > 100) {
			frequencia = new Double(100);
		}
		return frequencia;
	}

	public Double calcularFrequenciaAlunoPosGraduacao(Integer codigoTurma, Integer codigoDisciplina, String semestre, String ano, String matricula, Integer cargaHorariaDisciplina, Double somaPresencaAluno, Integer qtdeRegistroAula, Integer cargaHorariaAula, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuario) throws Exception {
		Double frequencia = 0.0;
		Integer soma = null;
		if (configuracaoAcademicoVO.getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_REGISTRO_AULA)) {
			soma = getFacadeFactory().getRegistroAulaFacade().consultarSomaCargaHorarioDisciplina(codigoTurma, semestre, ano, codigoDisciplina, false, usuario);
		} else if (configuracaoAcademicoVO.getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_DISCIPLINA)) {
			soma = getFacadeFactory().getGradeDisciplinaFacade().consultarCargaHorariaDisciplinaPorDisciplinaETurma(codigoDisciplina, matricula, usuario);
		} else if (configuracaoAcademicoVO.getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA)) {
			soma = getFacadeFactory().getGradeDisciplinaFacade().consultarHoraAulaDisciplinaPorDisciplinaEMatricula(codigoDisciplina, matricula, usuario);
		}
		if (soma == null || soma.equals(0)) {
			if (cargaHorariaAula == null || cargaHorariaAula.equals(0)) {
				soma = qtdeRegistroAula * 5;
			} else {
				soma = qtdeRegistroAula * cargaHorariaAula;
			}
		}
		if (soma.intValue() == 0) {
			return new Double(0.0);
		}

		frequencia = new Double((somaPresencaAluno.doubleValue() * 100) / soma.doubleValue());
		if (frequencia > 100) {
			frequencia = new Double(100);
		}

		return frequencia;
	}

	public void verificaAlunoReprovadoFalta(HistoricoVO obj, ConfiguracaoAcademicoVO ca, UsuarioVO usuario) throws Exception, Exception, Exception, Exception, Exception {
		if (obj.getFreguencia() < ca.getPercentualFrequenciaAprovacao()) {
			obj.setSituacao("RF");
		} else {
			obj.setSituacao("AP");
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluir(final HistoricoVO obj, UsuarioVO usuario) throws Exception {
		incluir(obj, "", usuario);
	}

	/**
	 * Operação responsável por incluir no banco de dados um objeto da classe
	 * <code>HistoricoVO</code>. Primeiramente valida os dados (
	 * <code>validarDados</code>) do objeto. Verifica a conexão com o banco de
	 * dados e a permissão do usuário para realizar esta operacão na entidade.
	 * Isto, através da operação <code>incluir</code> da superclasse.
	 *
	 * @param obj
	 *            Objeto da classe <code>HistoricoVO</code> que será gravado no
	 *            banco de dados.
	 * @exception Exception
	 *                Caso haja problemas de conexão, restrição de acesso ou
	 *                validação de dados.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluir(final HistoricoVO obj, String idEntidade, UsuarioVO usuario) throws Exception {
		try {
			// //System.out.println("++++++++++++++++++++++ INCLUI HISTORICO +++++++++++++++++++++++++++");
			// HistoricoVO.validarDados(obj);
			if (idEntidade != null && !idEntidade.trim().isEmpty()) {
				Historico.incluir(idEntidade, usuario);
			}
			if((obj.getHistoricoEquivalente() || obj.getHistoricoPorEquivalencia()) && obj.getNumeroAgrupamentoEquivalenciaDisciplina().equals(0)){
				Integer numeroAgrupamentoEquivalenciaDisciplina =  consultarUltimoNumeroAgrupamentoEquivalenciaDisciplina(obj.getMatricula().getMatricula(), obj.getMapaEquivalenciaDisciplina().getCodigo());
				if(numeroAgrupamentoEquivalenciaDisciplina == 0){
					numeroAgrupamentoEquivalenciaDisciplina = 1;
				}
				obj.setNumeroAgrupamentoEquivalenciaDisciplina(numeroAgrupamentoEquivalenciaDisciplina);
			}
			realizarCalculoCargaHorariaCursada(obj);
			// this.verificaSeExisteHistoricoJaRegistrado(obj);
			final String sql = "INSERT INTO Historico( disciplina, matricula, tipoHistorico, situacao, freguencia, responsavel, dataRegistro, nota1, " // 1-8
					+ "nota2, nota3, nota4, nota5, nota6, nota7, nota8, nota9, nota10, nota11, nota12, nota13, matriculaPeriodo, matriculaPeriodoTurmaDisciplina, " // 9-22
					+ "mediaFinal, transferenciaEntradaDisciplinasAproveitadas, disciplinasAproveitadas, configuracaoAcademico, nota1Lancada, nota2Lancada, " // 23-28
					+ "nota3Lancada, nota4Lancada, nota5Lancada, nota6Lancada, nota7Lancada, nota8Lancada, nota9Lancada, nota10Lancada, " // 29-36
					+ " nota11Lancada, nota12Lancada, nota13Lancada, updated, historicoDisciplinaFazParteComposicao, instituicao, " // 37-42
					+ " nota1Conceito, nota2Conceito, nota3Conceito, nota4Conceito, nota5Conceito, nota6Conceito, " // 43-48
					+ " nota7Conceito, nota8Conceito, nota9Conceito, nota10Conceito, nota11Conceito, nota12Conceito, "
					+ "nota13Conceito, mediaFinalConceito, notificarSolicitacaoReposicao, anoHistorico, semestreHistorico, cargaHorariaAproveitamentoDisciplina, cidade, " // 49-61
					+ "nota14, nota14lancada, nota14conceito, nota15, nota15lancada, nota15conceito, " + "nota16, nota16lancada, nota16conceito, nota17, nota17lancada, nota17conceito,  " + "nota18, "  //74
					+ "nota18lancada, nota18conceito, nota19, nota19lancada, nota19conceito, " + "nota20, nota20lancada, nota20conceito, nota21, nota21lancada, nota21conceito,  " + "nota22, " //86
					+ "nota22lancada, nota22conceito, nota23, nota23lancada, nota23conceito, " + "nota24, nota24lancada, nota24conceito, nota25, nota25lancada, nota25conceito,  " + "nota26, nota26lancada, " //99
					+ "nota26conceito, nota27, nota27lancada, nota27conceito, " + "nota28, nota28lancada, nota28conceito, nota29, nota29lancada, nota29conceito,  " + "nota30, nota30lancada, nota30conceito, " //112
					+ "cargahorariacursada, isentarMediaFinal, utilizaNotaFinalConceito, notaFinalConceito, " //116
					+ "observacao, historicoDisciplinaAtividadeComplementar, cargaHorariaDisciplina, creditoDisciplina, historicoDisciplinaOptativa," //121
					+ "historicoDisciplinaForaGrade, nomeDisciplina, historicoDisciplinaAproveitada, historicoPorEquivalencia, historicoEquivalente," + "faltaPrimeiroBimestre, faltaSegundoBimestre, " //128
					+ "faltaTerceiroBimestre, faltaQuartoBimestre, totalFalta, " + "periodoLetivoMatrizCurricular, matrizCurricular, periodoLetivoCursada,  " + "gradeCurricularGrupoOptativaDisciplina, " //135
					+ "gradeDisciplinaComposta, " //136
					// novos campos sai codHistoricoEquivalente
					+ "historicoDisciplinaComposta, mapaEquivalenciaDisciplina, mapaEquivalenciaDisciplinaCursada, mapaEquivalenciaDisciplinaMatrizCurricular, " + "historicoCriterioAvaliacaoAluno, criterioAvaliacao, " //142
					+ "disciplinaReferenteAUmGrupoOptativa, gradeDisciplina, " + "transferenciaMatrizCurricularMatricula, historicoGeradoAPartirTransferenciaMatrizCurricular, observacaoTransferenciaMatrizCurricular, " //147
					+ "historicoCursandoPorCorrespondenciaAposTransferencia, frequenciaTeorica, frequenciaPratica, numeroAgrupamentoEquivalenciaDisciplina, " //151
					+ "nota31, nota31Lancada, nota31Conceito, "
					+ "nota32, nota32Lancada, nota32Conceito, "
					+ "nota33, nota33Lancada, nota33Conceito, "
					+ "nota34, nota34Lancada, nota34Conceito, "
					+ "nota35, nota35Lancada, nota35Conceito, "
					+ "nota36, nota36Lancada, nota36Conceito, "
					+ "nota37, nota37Lancada, nota37Conceito, "
					+ "nota38, nota38Lancada, nota38Conceito, "
					+ "nota39, nota39Lancada, nota39Conceito, "
					+ "nota40, nota40Lancada, nota40Conceito, apresentarAprovadoHistorico, dataInicioAula, dataFimAula "
					+ " ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, " + "?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,  ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, " + "?, ?, ?, ?, ?, ?, ?, ?, ?, ?, " + "?, ?, ?, ?, ?, ?, ?, ?, ?, ?, " + "?, ?, ?, ?, ?, ?, ?, ?, ?, ?, " + "?, ?, ?, ?, ?, ?, ?, ?, ?, ?, " + "?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?," + "?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,"
					+ "?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, "

					+ "?, ?, ?, "
					+ "?, ?, ?, "
					+ "?, ?, ?, "
					+ "?, ?, ?, "
					+ "?, ?, ?, "
					+ "?, ?, ?, "
					+ "?, ?, ?, "
					+ "?, ?, ?, "
					+ "?, ?, ?, "
					+ "?, ?, ?, ?, ?, ? "

					+ ") returning codigo"
					+ adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			obj.setCodigo((Integer) getConexao().getJdbcTemplate().query(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlInserir = arg0.prepareStatement(sql);
					int i = 0;
					sqlInserir.setInt(++i, obj.getDisciplina().getCodigo().intValue());
					sqlInserir.setString(++i, obj.getMatricula().getMatricula());
					sqlInserir.setString(++i, obj.getTipoHistorico());
					sqlInserir.setString(++i, obj.getSituacao());
					sqlInserir.setDouble(++i, obj.getFreguencia().doubleValue());
					if (obj.getResponsavel().getCodigo().intValue() != 0) {
						sqlInserir.setInt(++i, obj.getResponsavel().getCodigo().intValue());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataRegistro()));
					if (obj.getNota1() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota1().doubleValue());
					}
					if (obj.getNota2() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota2().doubleValue());
					}
					if (obj.getNota3() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota3().doubleValue());
					}
					if (obj.getNota4() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota4().doubleValue());
					}
					if (obj.getNota5() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota5().doubleValue());
					}
					if (obj.getNota6() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota6().doubleValue());
					}
					if (obj.getNota7() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota7().doubleValue());
					}
					if (obj.getNota8() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota8().doubleValue());
					}
					if (obj.getNota9() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota9().doubleValue());
					}
					if (obj.getNota10() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota10().doubleValue());
					}
					if (obj.getNota11() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota11().doubleValue());
					}
					if (obj.getNota12() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota12().doubleValue());
					}
					if (obj.getNota13() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota13().doubleValue());
					}
					sqlInserir.setInt(++i, obj.getMatriculaPeriodo().getCodigo().intValue());
					if (obj.getMatriculaPeriodoTurmaDisciplina().getCodigo().intValue() != 0) {
						sqlInserir.setInt(++i, obj.getMatriculaPeriodoTurmaDisciplina().getCodigo().intValue());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getMediaFinal() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getMediaFinal().doubleValue());
					}
					if (obj.getTransferenciaEntradaDisciplinasAproveitadas().intValue() != 0) {
						sqlInserir.setInt(++i, obj.getTransferenciaEntradaDisciplinasAproveitadas().intValue());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getDisciplinasAproveitadas().intValue() != 0) {
						sqlInserir.setInt(++i, obj.getDisciplinasAproveitadas().intValue());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getConfiguracaoAcademico().getCodigo().intValue() != 0) {
						sqlInserir.setInt(++i, obj.getConfiguracaoAcademico().getCodigo().intValue());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					sqlInserir.setBoolean(++i, obj.getNota1Lancada());
					sqlInserir.setBoolean(++i, obj.getNota2Lancada());
					sqlInserir.setBoolean(++i, obj.getNota3Lancada());
					sqlInserir.setBoolean(++i, obj.getNota4Lancada());
					sqlInserir.setBoolean(++i, obj.getNota5Lancada());
					sqlInserir.setBoolean(++i, obj.getNota6Lancada());
					sqlInserir.setBoolean(++i, obj.getNota7Lancada());
					sqlInserir.setBoolean(++i, obj.getNota8Lancada());
					sqlInserir.setBoolean(++i, obj.getNota9Lancada());
					sqlInserir.setBoolean(++i, obj.getNota10Lancada());
					sqlInserir.setBoolean(++i, obj.getNota11Lancada());
					sqlInserir.setBoolean(++i, obj.getNota12Lancada());
					sqlInserir.setBoolean(++i, obj.getNota13Lancada());
					sqlInserir.setTimestamp(++i, Uteis.getDataJDBCTimestamp(new Date()));
					sqlInserir.setBoolean(++i, obj.getHistoricoDisciplinaFazParteComposicao());
					sqlInserir.setString(++i, obj.getInstituicao());
					if (obj.getNota1Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota1Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota2Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota2Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota3Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota3Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota4Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota4Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota5Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota5Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota6Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota6Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota7Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota7Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota8Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota8Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota9Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota9Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota10Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota10Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota11Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota11Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota12Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota12Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getNota13Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota13Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getMediaFinalConceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getMediaFinalConceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					sqlInserir.setBoolean(++i, obj.getNotificarSolicitacaoReposicao());
					sqlInserir.setString(++i, obj.getAnoHistorico());
					sqlInserir.setString(++i, obj.getSemestreHistorico());
					sqlInserir.setInt(++i, obj.getCargaHorariaAproveitamentoDisciplina());
					if (obj.getCidadeVO().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getCidadeVO().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					// ******* NOTA 14 *****
					if (obj.getNota14() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota14().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota14Lancada());
					if (obj.getNota14Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota14Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 15 *****
					if (obj.getNota15() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota15().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota15Lancada());
					if (obj.getNota15Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota15Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 16 *****
					if (obj.getNota16() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota16().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota16Lancada());
					if (obj.getNota16Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota16Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 17 *****
					if (obj.getNota17() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota17().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota17Lancada());
					if (obj.getNota17Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota17Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 18 *****
					if (obj.getNota18() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota18().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota18Lancada());
					if (obj.getNota18Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota18Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 19 *****
					if (obj.getNota19() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota19().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota19Lancada());
					if (obj.getNota19Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota19Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 20 *****
					if (obj.getNota20() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota20().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota20Lancada());
					if (obj.getNota20Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota20Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 21 *****
					if (obj.getNota21() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota21().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota21Lancada());
					if (obj.getNota21Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota21Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 22 *****
					if (obj.getNota22() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota22().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota22Lancada());
					if (obj.getNota22Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota22Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 23 *****
					if (obj.getNota23() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota23().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota23Lancada());
					if (obj.getNota23Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota23Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 24 *****
					if (obj.getNota24() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota24().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota24Lancada());
					if (obj.getNota24Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota24Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 25 *****
					if (obj.getNota25() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota25().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota25Lancada());
					if (obj.getNota25Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota25Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 26 *****
					if (obj.getNota26() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota26().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota26Lancada());
					if (obj.getNota26Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota26Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 27 *****
					if (obj.getNota27() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota27().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota27Lancada());
					if (obj.getNota27Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota27Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 28 *****
					if (obj.getNota28() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota28().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota28Lancada());
					if (obj.getNota28Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota28Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 29 *****
					if (obj.getNota29() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota29().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota29Lancada());
					if (obj.getNota29Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota29Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// *********************
					// ******* NOTA 30 *****
					if (obj.getNota30() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota30().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota30Lancada());
					if (obj.getNota30Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota30Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					// *********************
					sqlInserir.setInt(++i, obj.getCargaHorariaCursada());
					sqlInserir.setBoolean(++i, obj.getIsentarMediaFinal());
					sqlInserir.setBoolean(++i, obj.getUtilizaNotaFinalConceito());
					sqlInserir.setString(++i, obj.getNotaFinalConceito());

					sqlInserir.setString(++i, obj.getObservacao());
					sqlInserir.setBoolean(++i, obj.getHistoricoDisciplinaAtividadeComplementar().booleanValue());
					sqlInserir.setInt(++i, obj.getCargaHorariaDisciplina());
					sqlInserir.setInt(++i, obj.getCreditoDisciplina());
					sqlInserir.setBoolean(++i, obj.getHistoricoDisciplinaOptativa().booleanValue());
					sqlInserir.setBoolean(++i, obj.getHistoricoDisciplinaForaGrade().booleanValue());
					sqlInserir.setString(++i, obj.getNomeDisciplina());
					sqlInserir.setBoolean(++i, obj.getHistoricoDisciplinaAproveitada().booleanValue());
					sqlInserir.setBoolean(++i, obj.getHistoricoPorEquivalencia().booleanValue());
					sqlInserir.setBoolean(++i, obj.getHistoricoEquivalente().booleanValue());
					sqlInserir.setInt(++i, obj.getFaltaPrimeiroBimestre());
					sqlInserir.setInt(++i, obj.getFaltaSegundoBimestre());
					sqlInserir.setInt(++i, obj.getFaltaTerceiroBimestre());
					sqlInserir.setInt(++i, obj.getFaltaQuartoBimestre());
					sqlInserir.setInt(++i, obj.getTotalFalta());

					if (obj.getPeriodoLetivoMatrizCurricular().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getPeriodoLetivoMatrizCurricular().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getMatrizCurricular().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getMatrizCurricular().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getPeriodoLetivoCursada().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getPeriodoLetivoCursada().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					// sqlInserir.setBoolean(++i,
					// obj.getUtilizaNotaFinalConceito().booleanValue());
					// sqlInserir.setString(++i, obj.getNotaFinalConceito());
					if (obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getGradeDisciplinaComposta().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getGradeDisciplinaComposta().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					sqlInserir.setBoolean(++i, obj.getHistoricoDisciplinaComposta());
					if (obj.getMapaEquivalenciaDisciplina().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getMapaEquivalenciaDisciplina().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getMapaEquivalenciaDisciplinaCursada().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getMapaEquivalenciaDisciplinaCursada().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					if (obj.getMapaEquivalenciaDisciplinaMatrizCurricular().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getMapaEquivalenciaDisciplinaMatrizCurricular().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					sqlInserir.setBoolean(++i, obj.getHistoricoCriterioAvaliacaoAluno());
					if (obj.getCriterioAvaliacao().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getCriterioAvaliacao().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					sqlInserir.setBoolean(++i, obj.getDisciplinaReferenteAUmGrupoOptativa());
					if (obj.getGradeDisciplinaVO().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getGradeDisciplinaVO().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					// INICIO: atributos de referencia a trasnferencia de matriz
					// curricular
					if (obj.getTransferenciaMatrizCurricularMatricula().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getTransferenciaMatrizCurricularMatricula().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					sqlInserir.setBoolean(++i, obj.getHistoricoGeradoAPartirTransferenciaMatrizCurricular());
					sqlInserir.setString(++i, obj.getObservacaoTransferenciaMatrizCurricular());
					sqlInserir.setBoolean(++i, obj.getHistoricoCursandoPorCorrespondenciaAposTransferencia());
					sqlInserir.setDouble(++i, obj.getFrequenciaTeorica());
					sqlInserir.setDouble(++i, obj.getFrequenciaPratica());
					sqlInserir.setInt(++i, obj.getNumeroAgrupamentoEquivalenciaDisciplina());
					// FIM: atributos de referencia a trasnferencia de matriz
					// curricular

//					A PARTIR NOTA 31
					if (obj.getNota31() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota31().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota31Lancada());
					if (obj.getNota31Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota31Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					if (obj.getNota32() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota32().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota32Lancada());
					if (obj.getNota32Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota32Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					if (obj.getNota33() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota33().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota33Lancada());
					if (obj.getNota33Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota33Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					if (obj.getNota34() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota34().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota34Lancada());
					if (obj.getNota34Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota34Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					if (obj.getNota35() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota35().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota35Lancada());
					if (obj.getNota35Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota35Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					if (obj.getNota36() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota36().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota36Lancada());
					if (obj.getNota36Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota36Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					if (obj.getNota37() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota37().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota37Lancada());
					if (obj.getNota37Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota37Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					if (obj.getNota38() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota38().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota38Lancada());
					if (obj.getNota38Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota38Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					if (obj.getNota39() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota39().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota39Lancada());
					if (obj.getNota39Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota39Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}

					if (obj.getNota40() == null) {
						sqlInserir.setNull(++i, 0);
					} else {
						sqlInserir.setDouble(++i, obj.getNota40().doubleValue());
					}
					sqlInserir.setBoolean(++i, obj.getNota40Lancada());
					if (obj.getNota40Conceito().getCodigo() > 0) {
						sqlInserir.setInt(++i, obj.getNota40Conceito().getCodigo());
					} else {
						sqlInserir.setNull(++i, 0);
					}
					sqlInserir.setBoolean(++i, obj.getApresentarAprovadoHistorico());
					sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataInicioAula()));
					sqlInserir.setDate(++i, Uteis.getDataJDBC(obj.getDataFimAula()));

					return sqlInserir;
				}
			}, new ResultSetExtractor<Integer>() {

				public Integer extractData(ResultSet arg0) throws SQLException, DataAccessException {
					if (arg0.next()) {
						obj.setNovoObj(Boolean.FALSE);
						return arg0.getInt("codigo");
					}
					return null;
				}
			}));
			// //System.out.println("++++++++++++++++++++++ INCLUI HISTORICO (FINAL) +++++++++++++++++++++++++++");
			veriricarHistoricoEnvolvidoMapaEquivalenciaDefinindoDadosHistoricoDisciplinasCursadasPorEquivalencia(obj, obj.getHistoricoEquivalente(), usuario);
			obj.setNovoObj(Boolean.FALSE);
		} catch (Exception e) {
			obj.setNovoObj(Boolean.TRUE);
			throw e;
		}
	}

	/**
	 * Método responsável por gerar os históricos das disciplinas que fazem
	 * parte de uma composicao - versão 5.0 Ou seja, por gerar os históricos
	 * para que o aluno estude uma disciplina composta por meio de suas
	 * disciplinas de composição. Versão 5.0
	 *
	 * @param historicoBaseVO
	 *            - deve já estar com todos os dados preenchidos.
	 * @param matriculaPeriodoVO
	 * @param matriculaVO
	 * @throws Exception
	 */
	// @Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED,
	// rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	// public void gerarHistoricosReferentesADisciplinaComposta(
	// HistoricoVO historicoBaseVO,
	// MatriculaPeriodoVO matriculaPeriodoVO,
	// MatriculaVO matriculaVO) throws Exception {
	// List<GradeDisciplinaCompostaVO> listaDisciplinasComposicao;
	// if (historicoBaseVO.getDisciplinaReferenteAUmGrupoOptativa()) {
	// listaDisciplinasComposicao =
	// historicoBaseVO.getGradeCurricularGrupoOptativaDisciplinaVO().getGradeDisciplinaCompostaVOs();
	// } else {
	// listaDisciplinasComposicao =
	// historicoBaseVO.getGradeDisciplinaVO().getGradeDisciplinaCompostaVOs();
	// }
	// for (GradeDisciplinaCompostaVO disciplinaComposicao :
	// listaDisciplinasComposicao) {
	// HistoricoVO histVO = (HistoricoVO)historicoBaseVO.clone();
	// histVO.setDisciplina(disciplinaComposicao.getDisciplina());
	// histVO.setHistoricoDisciplinaComposta(Boolean.FALSE);
	// histVO.setHistoricoDisciplinaFazParteComposicao(Boolean.TRUE);
	// histVO.setGradeDisciplinaComposta(disciplinaComposicao);
	// histVO.setSituacao(SituacaoHistorico.CURSANDO.getValor());
	// }
	// }
	/**
	 * Método responsável por gerar um novo objeto do HistoricoVO partindo de
	 * uma MatriculaPeriodoTurmaDisciplinaVO. Este objeto
	 * MatriculaPeriodoTurmaDisciplinaVO é criado a partir da
	 * matricula/renovacao de um aluno. Este método é responsável por gerar um
	 * novo objeto de histórico já validado. Considerando regras relativas as
	 * disciplinas normais, disciplinas de grupo de optativa, disciplinas
	 * compostas, disciplinas que referem-se a mapas de equivalencia
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public HistoricoVO gerarHistoricoVOComBaseMatriculaPeriodoTurmaDisciplina(MatriculaPeriodoTurmaDisciplinaVO obj, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, GradeCurricularVO gradeCurricular, UsuarioVO usuario) throws Exception {
		HistoricoVO histVO = new HistoricoVO();
		histVO.setMatricula(matriculaVO);
		histVO.setMatrizCurricular(gradeCurricular);
		histVO.setMatriculaPeriodo(matriculaPeriodoVO);
		histVO.setMatriculaPeriodoTurmaDisciplina(obj);
		histVO.setDataInicioAula(obj.getDataInicioAula());
		histVO.setDataFimAula(obj.getDataFimAula());

		// Periodo Letivo cursado é sempre o período letivo informado na
		// MatriculaPeriodo
		// Ou seja, mesmo que uma disciplinas do 8periodo seja incluída para o
		// aluno,
		// cujo período letivo da matriculaPeriodo seja o 5periodo, então esta
		// disciplina
		// terá o periodo letivo cursado definido como 5 período.
		histVO.setPeriodoLetivoCursada(matriculaPeriodoVO.getPeriodoLetivo());

		histVO.setAnoHistorico(matriculaPeriodoVO.getAno());
		histVO.setSemestreHistorico(matriculaPeriodoVO.getSemestre());
		histVO.setCargaHorariaDisciplina(obj.getCargaHorariaDisciplina());
		histVO.setCargaHorariaCursada(obj.getCargaHorariaDisciplina());
		histVO.setCreditoDisciplina(obj.getCreditosDisciplina());
		histVO.setDataRegistro(matriculaPeriodoVO.getData());
		histVO.setSituacao(SituacaoHistorico.CURSANDO.getValor()); // por padrão
																	// a
																	// situacao
																	// do
																	// histórico
																	// deve ser
																	// CURSANDO
		histVO.setTipoHistorico(realizarVerificacaoTipoHistoricoUtilizarDeAcordoPeriodoLetivo(matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo(), obj.getDisciplina().getCodigo(), matriculaVO.getGradeCurricularAtual().getCodigo(), obj.getDisciplinaEquivale() ? obj.getMapaEquivalenciaDisciplinaVOIncluir().getCodigo() : 0, usuario)); // historico
																	// por
																	// default é
																	// do tipo
																	// normal

		ConfiguracaoGeralSistemaVO conf = getFacadeFactory().getConfiguracaoGeralSistemaFacade().consultarPorCodigoUnidadeEnsino(matriculaVO.getUnidadeEnsino().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		if (conf.getMatricularAlunoReprovFaltaEmDisciplinaJaRealizadaPosGraduacaoExtensao()) {
			if (getFacadeFactory().getHorarioTurmaDiaFacade().consultarExistenciaProgramacaoAulaPorTurmaDisciplinaData(obj.getTurma().getCodigo(), obj.getDisciplina().getCodigo(), matriculaPeriodoVO.getData(), false, usuario)) {
				histVO.setSituacao("RF");
				histVO.setMediaFinal(0.0);
			}
		}
		// seja de um grupo de optativa ou uma disciplina da gradecurricular
		// marcada como optativa, o historico
		// ira registrar a mesma como optativa.
		histVO.setHistoricoDisciplinaOptativa((obj.getDisciplinaOptativa() || obj.getDisciplinaReferenteAUmGrupoOptativa()));

		// Para disciplinas vindas de uma MatriculaPeriodoTurmaDisciplina, nunca
		// teremos
		// a mesma sinalizada como fora da grade. Para registro de disciplina
		// fora da grade,
		// existe uma tela e um recurso apropriado para este fim.
		// Autor Edgar
		// Autor Carlos A tela criada(de acordo com o comentário acima) é a tela
		// de inclusão fora do prazo,
		// onde a partir da mesma pode-se adicionar a disciplina fora da grade
		if (obj.getDisciplinaForaGrade()) {
			histVO.setHistoricoDisciplinaForaGrade(Boolean.TRUE);
		} else {
			histVO.setHistoricoDisciplinaForaGrade(Boolean.FALSE);
		}
		if (obj.getConfiguracaoAcademicoVO().getCodigo() == 0) {
			histVO.setConfiguracaoAcademico(matriculaVO.getCurso().getConfiguracaoAcademico());
		} else {
			histVO.setConfiguracaoAcademico(obj.getConfiguracaoAcademicoVO());
			histVO.getConfiguracaoAcademico().setRegistrarComoFaltaAulasRealizadasAposDataMatricula(matriculaVO.getCurso().getConfiguracaoAcademico().getRegistrarComoFaltaAulasRealizadasAposDataMatricula());
		}
		histVO.setResponsavel(usuario);

		// disciplina que o aluno está estudando
		histVO.setDisciplina(obj.getDisciplina());
		// referencia a gradeDisciplina, caso seja uma disciplina regular da
		// matriz curricular
		histVO.setGradeDisciplinaVO(obj.getGradeDisciplinaVO());
		if (!obj.getDisciplinaReferenteAUmGrupoOptativa()) {
			if ((!obj.getGradeDisciplinaVO().getCodigo().equals(0)) && (obj.getGradeDisciplinaVO().getPeriodoLetivoVO().getCodigo().equals(0))) {
				// se estiver em branco o periodo, temos que inicializar os
				// dados da gradeDisciplina com o
				// periodo letivo.
				GradeDisciplinaVO gradeDisciplinaCarregado = getFacadeFactory().getGradeDisciplinaFacade().consultarPorChavePrimaria(obj.getGradeDisciplinaVO().getCodigo(), usuario);
				obj.setGradeDisciplinaVO(gradeDisciplinaCarregado);
			}
			histVO.setPeriodoLetivoMatrizCurricular(obj.getGradeDisciplinaVO().getPeriodoLetivoVO());
		}

		// referencia a gradeCurricularGrupoOptativaDisciplinaVO, caso a
		// disciplina
		// que o aluno irá estudar seja de um grupo de optativa - ou seja,
		// disciplina de um grupo de disciplinas
		// disponivel para o aluno estudar.
		if (obj.getDisciplinaReferenteAUmGrupoOptativa()) {
			histVO.setGradeCurricularGrupoOptativaDisciplinaVO(obj.getGradeCurricularGrupoOptativaDisciplinaVO());
			histVO.setDisciplinaReferenteAUmGrupoOptativa(obj.getDisciplinaReferenteAUmGrupoOptativa());
			matriculaPeriodoVO.getPeriodoLetivo().setGradeCurricularGrupoOptativa(getFacadeFactory().getGradeCurricularGrupoOptativaFacade().consultarPorPeriodoLetivo(matriculaPeriodoVO.getPeriodoLetivo().getCodigo(), usuario));
			// se trata-se de um grupo de optativa, entao assumimos que o
			// periodo do grupo de optativas (da matriz)
			// é o período da turma na qual a disciplina do grupo de optativa
			// irá ser estudada. Pois, mesmo o aluno
			// estando no 5o periodo o mesmo ainda pode incluir uma disciplina
			// do grupo de optativa do 2o periodo por exemplo.
			// Para isto, ele terá que selecionar uma turma do 2o período para
			// incluí-la, logo, o grupo tambem ser do 2o periodo.
			if(matriculaPeriodoVO.getGradeCurricular().getCodigo().equals(histVO.getMatrizCurricular().getCodigo())
					&& matriculaPeriodoVO.getPeriodoLetivo().getGradeCurricularGrupoOptativa().getCodigo().equals(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getGradeCurricularGrupoOptativa().getCodigo())) {
				histVO.setPeriodoLetivoMatrizCurricular((PeriodoLetivoVO)matriculaPeriodoVO.getPeriodoLetivo().clone());
			}else {
				for(PeriodoLetivoVO periodoLetivoVO : matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPeriodoLetivosVOs()) {
					if(periodoLetivoVO.getGradeCurricularGrupoOptativa().getCodigo().equals(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getGradeCurricularGrupoOptativa().getCodigo())) {
						histVO.setPeriodoLetivoMatrizCurricular((PeriodoLetivoVO)periodoLetivoVO.clone());
						break;
					}
				}
			}
			if(!Uteis.isAtributoPreenchido(histVO.getPeriodoLetivoMatrizCurricular().getCodigo())) {
				histVO.setPeriodoLetivoMatrizCurricular(getFacadeFactory().getPeriodoLetivoFacade().consultarPeriodoLetivoPorGradeCurricularGrupoOptativaDisciplina(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), usuario));
			}
			if(!Uteis.isAtributoPreenchido(histVO.getPeriodoLetivoMatrizCurricular().getCodigo())) {
				histVO.setPeriodoLetivoMatrizCurricular(obj.getTurma().getPeridoLetivo());
			}
		}

		// ********************************************
		// DISCIPLINA COMPOSTA
		// caso seja o histórico de uma disciplina composta, não temos que fazer
		// nada de especial,
		// basta registrar que a disciplina em questão é compsota, seja esta de
		// uma grade de disciplina
		// ou de uma grade grupo optativa disciplina. Como são gerados
		// MatriculaPeriodoTurmaDisciplinaVOs
		// para as disciplinas que fazer parte da composicao, este método será
		// chamado para cada um
		// destes objetos e os respectivos objetos da
		// discicplinaQueFazParteComposicao serão gerados naturalmente.
		if (obj.getDisciplinaComposta()) {
			// caso seja uma disciplina composta, entao temos que gerar os
			// históricos referentes as disciplinas
			// que participam da composição. Vale ressaltar que este conceito
			// independe de ser uma disciplina de um
			// grupo de optativa, ou disciplina regular. Podendo ser ainda uma
			// disciplina de um mapa de equivalencia ou nao.
			histVO.setHistoricoDisciplinaComposta(Boolean.TRUE);
			histVO.setHistoricoDisciplinaFazParteComposicao(Boolean.FALSE);
		} else {
			if (obj.getDisciplinaFazParteComposicao()) {
				// se o aluno está estudando uma disciplina que faz parte de uma
				// composicao
				// então atualizamos todos os dados da disciplina do histórico,
				// com base na
				// na disciplina da compostição (que de fato o aluno irá
				// estudar).
				histVO.setHistoricoDisciplinaComposta(Boolean.FALSE);
				histVO.setHistoricoDisciplinaFazParteComposicao(Boolean.TRUE);
				histVO.setGradeDisciplinaComposta(obj.getGradeDisciplinaCompostaVO());
				histVO.setDisciplina(obj.getGradeDisciplinaCompostaVO().getDisciplina());
				histVO.setCargaHorariaDisciplina(obj.getGradeDisciplinaCompostaVO().getCargaHoraria());
				histVO.setCargaHorariaCursada(obj.getGradeDisciplinaCompostaVO().getCargaHoraria());
				histVO.setCreditoDisciplina(obj.getGradeDisciplinaCompostaVO().getNrCreditos());
			}
		}

		// ********************************************
		// TRATANDO A QUESTÃO DA DISCIPLINA EQUIVALENTE
		// É importante ressaltar que tanto um disciplina normal
		// (GradeDisciplinaVO) quanto uma disciplina de um grupoOptativa
		// (GradeCurricularGrupoOptativaDisciplinaVO)
		// pode ser cursada por meio de um mapa de equivalencia.
		// Outro ponto importante é destacar que a disciplina pode estar sendo
		// cursada em um mapa de equivalencia N:M. Ou seja, um mapa onde o
		// aluno tenha que cursar várias disciplinas (M) e ao fazer isto será
		// aprovado em outro conjunto de disciplinas (N).
		// ********************************************
		if (obj.getDisciplinaEquivale()) {
			// DisciplinaEquivale é true quando esta disciplina for uma
			// disciplina de outra MatrizCurricular/curso
			// que o aluno tem que cursar (dentro de uma mapa de equivalencia -
			// MapaEquivalenciaDisciplinaCursada)
			// com intuito de ser aprovado em outras disciplinas de sua
			// matriz/curso.
			// Logo, a mesma deve estar com dentro de uma MapaEquivalencia
			// Este deve ser apresentado no boletim acadêmico. Quando esta for
			// true, significa que haverá
			// outras disciplinas da matriz, que estão com
			// disciplinaPorEquivalencia
			histVO.setHistoricoEquivalente(Boolean.TRUE);
			histVO.setMapaEquivalenciaDisciplina(obj.getMapaEquivalenciaDisciplinaVOIncluir());
			histVO.setMapaEquivalenciaDisciplinaCursada(obj.getMapaEquivalenciaDisciplinaCursada());
			histVO.setNumeroAgrupamentoEquivalenciaDisciplina(obj.getNumeroAgrupamentoEquivalenciaDisciplina());
		} else {
			// se nao é uma disciplina que equivale, temos que verificar se não
			// é uma disciplina
			// que está sendo cursada por equivalencia. Contudo, caso seja uma
			// disciplina que está
			// sendo cursada por equivalencia, a mesma não pode ser incluída por
			// este método (pois,
			// se a disciplina será cursada por um mapa de equivalencia, então
			// não teremos registro
			// para a mesma em MatriculaPeriodoTurmaDisciplina, somente no
			// histórico mesmo.
			if (obj.getDisciplinaPorEquivalencia()) {
				throw new Exception(UteisJSF.internacionalizar("msg_Historico_ErroNaoPodeAcionadarParaInclusaoDisciplinasPorEquivalencia"));
			}
		}
		HistoricoVO.validarDados(histVO);
		return histVO;
	}

	/**
	 * De acordo com regra dada pelo Rodrigo, caso a disciplina que está sendo incluída seja de um período letivo anterior ao período letivo que está na matrícula período o Tipo Histórico
	 * deve ser do tipo DEPENDÊNCIA, caso o período letivo da disciplina que está sendo incluída seja igual ao período letivo da matrícula período atual deverá ser o Tipo Histórico NORMAL,
	 * caso contrário ADAPTAÇÃO.
	 * @author Carlos Eugênio - 02/02/2016
	 * @param periodoletivo
	 * @param disciplina
	 * @param gradeCurricular
	 * @param usuarioVO
	 * @return
	 */
	public String realizarVerificacaoTipoHistoricoUtilizarDeAcordoPeriodoLetivo(Integer periodoletivo, Integer disciplina, Integer gradeCurricular, Integer mapaEquivalenciaDisciplina, UsuarioVO usuarioVO) {
		Integer periodoLetivoDisciplinaSendoIncluida = getFacadeFactory().getPeriodoLetivoFacade().consultarPeriodoLetivoPorGradeCurricularDisciplina(gradeCurricular, disciplina, mapaEquivalenciaDisciplina, usuarioVO);
		if (periodoLetivoDisciplinaSendoIncluida < periodoletivo) {
			return TipoHistorico.DEPENDENCIA.getValor();
		} else if (periodoLetivoDisciplinaSendoIncluida.equals(periodoletivo)) {
			return TipoHistorico.NORMAL.getValor();
		} else {
			return TipoHistorico.ADAPTACAO.getValor();
		}
	}

	@Override
	public void migrarNotasEDadosAcademicosEntreHistoricos(HistoricoVO histOrigem, HistoricoVO histVO) {
		// Migrando notas dos históricos....
		for (int y = 1; y <= 40; y++) {
			//"nota" + i + "MediaFinal");
			Double notaMigrar = (Double) UtilReflexao.invocarMetodoGet(histOrigem, "nota" + y);
			UtilReflexao.invocarMetodoSet1Parametro(histVO, "nota" + y, new Double(0.0).getClass(), notaMigrar);
		}

		histVO.setMediaFinal(histOrigem.getMediaFinal());

		histVO.setMediaFinalConceito(histOrigem.getMediaFinalConceito());

		histVO.setNota1Conceito(histOrigem.getNota1Conceito());
		histVO.setNota2Conceito(histOrigem.getNota2Conceito());
		histVO.setNota3Conceito(histOrigem.getNota3Conceito());
		histVO.setNota4Conceito(histOrigem.getNota4Conceito());
		histVO.setNota5Conceito(histOrigem.getNota5Conceito());
		histVO.setNota6Conceito(histOrigem.getNota6Conceito());
		histVO.setNota7Conceito(histOrigem.getNota7Conceito());
		histVO.setNota8Conceito(histOrigem.getNota8Conceito());
		histVO.setNota9Conceito(histOrigem.getNota9Conceito());
		histVO.setNota10Conceito(histOrigem.getNota10Conceito());

		histVO.setNota11Conceito(histOrigem.getNota11Conceito());
		histVO.setNota12Conceito(histOrigem.getNota12Conceito());
		histVO.setNota13Conceito(histOrigem.getNota13Conceito());
		histVO.setNota14Conceito(histOrigem.getNota14Conceito());
		histVO.setNota15Conceito(histOrigem.getNota15Conceito());
		histVO.setNota16Conceito(histOrigem.getNota16Conceito());
		histVO.setNota17Conceito(histOrigem.getNota17Conceito());
		histVO.setNota18Conceito(histOrigem.getNota18Conceito());
		histVO.setNota19Conceito(histOrigem.getNota19Conceito());
		histVO.setNota20Conceito(histOrigem.getNota20Conceito());

		histVO.setNota21Conceito(histOrigem.getNota21Conceito());
		histVO.setNota22Conceito(histOrigem.getNota22Conceito());
		histVO.setNota23Conceito(histOrigem.getNota23Conceito());
		histVO.setNota24Conceito(histOrigem.getNota24Conceito());
		histVO.setNota25Conceito(histOrigem.getNota25Conceito());
		histVO.setNota26Conceito(histOrigem.getNota26Conceito());
		histVO.setNota27Conceito(histOrigem.getNota27Conceito());
		histVO.setNota28Conceito(histOrigem.getNota28Conceito());
		histVO.setNota29Conceito(histOrigem.getNota29Conceito());
		histVO.setNota30Conceito(histOrigem.getNota30Conceito());

		histVO.setNota31Conceito(histOrigem.getNota31Conceito());
		histVO.setNota32Conceito(histOrigem.getNota32Conceito());
		histVO.setNota33Conceito(histOrigem.getNota33Conceito());
		histVO.setNota34Conceito(histOrigem.getNota34Conceito());
		histVO.setNota35Conceito(histOrigem.getNota35Conceito());
		histVO.setNota36Conceito(histOrigem.getNota36Conceito());
		histVO.setNota37Conceito(histOrigem.getNota37Conceito());
		histVO.setNota38Conceito(histOrigem.getNota38Conceito());
		histVO.setNota39Conceito(histOrigem.getNota39Conceito());
		histVO.setNota40Conceito(histOrigem.getNota40Conceito());

		histVO.setFreguencia(histOrigem.getFreguencia());
		histVO.setFrequenciaPratica(histOrigem.getFrequenciaPratica());
		histVO.setFrequenciaTeorica(histOrigem.getFrequenciaTeorica());
		histVO.setCargaHorariaCursada(histOrigem.getCargaHorariaCursada());

		histVO.setFaltaPrimeiroBimestre(histOrigem.getFaltaPrimeiroBimestre());
		histVO.setFaltaSegundoBimestre(histOrigem.getFaltaSegundoBimestre());
		histVO.setFaltaTerceiroBimestre(histOrigem.getFaltaTerceiroBimestre());
		histVO.setFaltaQuartoBimestre(histOrigem.getFaltaQuartoBimestre());

		histVO.setNrAdvertencias1Bimestre(histOrigem.getNrAdvertencias1Bimestre());
		histVO.setNrAdvertencias2Bimestre(histOrigem.getNrAdvertencias2Bimestre());
		histVO.setNrAdvertencias3Bimestre(histOrigem.getNrAdvertencias3Bimestre());
		histVO.setNrAdvertencias4Bimestre(histOrigem.getNrAdvertencias4Bimestre());
		histVO.setNrAdvertenciasPeriodoLetivo(histOrigem.getNrAdvertenciasPeriodoLetivo());

		histVO.setNrSuspensoes1Bimestre(histOrigem.getNrSuspensoes1Bimestre());
		histVO.setNrSuspensoes2Bimestre(histOrigem.getNrSuspensoes2Bimestre());
		histVO.setNrSuspensoes3Bimestre(histOrigem.getNrSuspensoes3Bimestre());
		histVO.setNrSuspensoes4Bimestre(histOrigem.getNrSuspensoes4Bimestre());
		histVO.setNrSuspensoesPeriodoLetivo(histOrigem.getNrSuspensoesPeriodoLetivo());
		histVO.setSituacao(histOrigem.getSituacao());
	}

	/**
	 * Método que só será executado quando o usuário estiver editando uma matriculaPeriodo a partir de uma transferencia de
	 * matriz (com o intuito de remover disciplinas que estavam sendo cursadas por correspodencia). Neste caso, temos que
	 * que algumas MatriculaPeriodoTurmaDisciplina estão sendo recriadas de forma a olharem para a nova Matriz Curricular do
	 * aluno (matriz definida após a tranferencia de matriz). Porém pode ocorrer do aluno já pode possuir notas e frequencia
	 * lançadas no historico da matriz antiga (anterior a transferencia). Assim, temos que migrar estas notas e frequencia para
	 * o novo historico já criado nos métodos anteriores para a matriz nova. Esta migração de notas e frequencia se dará somente
	 * se os históricos utilizarem a mesma configuracao academica. O historico anterior (da matriz antiga) já está registrado no
	 * objeto matriculaPeriodoTurmaDisciplinaVO (o que feito assim o que o mesmo é adicionado para a matriculaPeriodo do aluno)
	 *
	 * @author Otimize - 6 de out de 2016
	 * @param histVO
	 * @param obj
	 * @param matriculaPeriodoVO
	 * @param matriculaVO
	 * @param usuario
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void verificarEGerenciarHistoricoSendoCriadoParaSubstituirHistoricoDisciplinaQueEstavaSendoCursadaPorCorrespodencia(
			HistoricoVO histVO, MatriculaPeriodoTurmaDisciplinaVO obj,
			MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, UsuarioVO usuario) throws Exception {
		if ((matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO() != null) &&
		    (obj.getHistoricoAnteriorDisciplinaMigrarNotas() != null)) {
			// se estamos gravando um novo historico, pois a matriculaPeriodo foi alterada em funcao de uma transferencia de matriz
			// (eliminar disciplinas cursando por correspodencia) e existe um historico anterior que precisamos migrar notas, entao
			// realizar a migracao.

			if ((!obj.getHistoricoAnteriorDisciplinaMigrarNotas().getCodigo().equals(0)) &&
			    (obj.getHistoricoAnteriorDisciplinaMigrarNotas().getConfiguracaoAcademico().getCodigo().equals(histVO.getConfiguracaoAcademico().getCodigo()))) {
				// se os historicos utilizam a mesma configuracao, entao podemos iniciar o processo de migracao.

				migrarNotasEDadosAcademicosEntreHistoricos(obj.getHistoricoAnteriorDisciplinaMigrarNotas(), histVO);
			}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void verificarEGerenciarHistoricoSendoCriadoParaSubstituirHistoricoDisciplinaQueEstavaSendoCursadaPorEquivalencia(HistoricoVO histVO, MatriculaPeriodoTurmaDisciplinaVO obj,
			MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, UsuarioVO usuario) throws Exception {
		if ((matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO() != null)
				&& (matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().getEliminandoDisciplinasCursandoPorEquivalencia())) {
			// se estamos gravando um novo historico, pois a matriculaPeriodo foi alterada em funcao de uma transferencia de matriz
			// (eliminar disciplinas cursando por equilencia) e existe um historico anterior que precisamos migrar notas, entao
			// realizar a migracao.

			if (obj.getHistoricoAnteriorDisciplinaEquivalenteMigrarNotas().getDisciplina().getCodigo().equals(histVO.getDisciplina().getCodigo())
					&& obj.getHistoricoAnteriorDisciplinaEquivalenteMigrarNotas().getCargaHorariaDisciplina().equals(histVO.getCargaHorariaDisciplina())
					&& obj.getHistoricoAnteriorDisciplinaEquivalenteMigrarNotas().getConfiguracaoAcademico().getCodigo().equals(histVO.getConfiguracaoAcademico().getCodigo())) {
					migrarNotasEDadosAcademicosEntreHistoricos(obj.getHistoricoAnteriorDisciplinaEquivalenteMigrarNotas(), histVO);
			}

			for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaMigrarDadosHistorico : matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().getListaExcluirDeAcordoMatriculaPeriodoTurmaDisciplinaRemovidaDisciplinaEquivalenteUsuarioVOs()) {
				Integer disciplinaAtualizar = matriculaPeriodoTurmaDisciplinaMigrarDadosHistorico.getMapaEquivalenciaDisciplinaVOIncluir().getMapaEquivalenciaDisciplinaMatrizCurricularVOs().get(0).getDisciplinaVO().getCodigo();
				Integer cargaHorariaAtualizar = matriculaPeriodoTurmaDisciplinaMigrarDadosHistorico.getMapaEquivalenciaDisciplinaVOIncluir().getMapaEquivalenciaDisciplinaMatrizCurricularVOs().get(0).getCargaHoraria();
				if (disciplinaAtualizar.equals(obj.getDisciplina().getCodigo()) && cargaHorariaAtualizar.equals(histVO.getCargaHorariaDisciplina())) {

					if ((!matriculaPeriodoTurmaDisciplinaMigrarDadosHistorico.getHistoricoAnteriorDisciplinaEquivalenteMigrarNotas().getCodigo().equals(0)) &&
						    (matriculaPeriodoTurmaDisciplinaMigrarDadosHistorico.getHistoricoAnteriorDisciplinaEquivalenteMigrarNotas().getConfiguracaoAcademico().getCodigo().equals(histVO.getConfiguracaoAcademico().getCodigo()))) {
							// se os historicos utilizam a mesma configuracao, entao podemos iniciar o processo de migracao.

							migrarNotasEDadosAcademicosEntreHistoricos(matriculaPeriodoTurmaDisciplinaMigrarDadosHistorico.getHistoricoAnteriorDisciplinaEquivalenteMigrarNotas(), histVO);
						}
				}
			}
		}
	}

	/**
	 * Como está sendo gerado um novo historico para disciplina de forma a eliminar o Cursando por Correspodencia,
	 * signigica que temos que fazer duas operações de gestão sobre os historicos anteriores que foram criados
	 * no ato da transferencia de matriz. PRIMEIRO: Um historico que foi criado com a situacao 'CO' - cursando por correspodencia
	 * na nova matriz  precisa ser removido. SEGUNDO: O historico que existe na matriz origem, que o aluno estava cursando de forma normal,
	 * para pagar uma disciplina da nova matriz, tambem precisa ser removido, caso contrario, o aluno ficará ocupando uma vaga nesta turma
	 * da matriz antiga sem necessidade - alem do risco de notas serem lancadas neste historico antigo.
	 * @author Otimize - 6 de out de 2016
	 * @param histVO
	 * @param obj
	 * @param matriculaPeriodoVO
	 * @param matriculaVO
	 * @param usuario
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirHistoricosRelativosAoControleCursandoPorCorrespodenciaDaDisciplinaMatriculaPeriodoTurmaDisciplinaAtual(
			MatriculaPeriodoTurmaDisciplinaVO obj,
			MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO,
			ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		if (matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO() != null
				&& matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().getEliminandoDisciplinasCursandoPorCorrespodencia()) {
			getFacadeFactory().getHistoricoFacade().excluirComBaseNaMatriculaPeriodoCodDisciplinaSituacaoHistorico(matriculaPeriodoVO.getCodigo(), obj.getDisciplina().getCodigo(), "CS", matriculaVO.getGradeCurricularAtual().getCodigo(), configuracaoFinanceiroVO, usuario);
			getFacadeFactory().getHistoricoFacade().excluirComBaseNaMatriculaPeriodoCodDisciplinaSituacaoHistorico(matriculaPeriodoVO.getCodigo(), obj.getDisciplina().getCodigo(), "CO", matriculaVO.getGradeCurricularAtual().getCodigo(), configuracaoFinanceiroVO, usuario);
		}
	}


	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirHistorico(MatriculaPeriodoTurmaDisciplinaVO obj, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, GradeCurricularVO gradeCurricularVO, UsuarioVO usuario) throws Exception {
		if ((matriculaPeriodoVO == null) || (matriculaPeriodoVO.getMatricula().equals(""))) {
			matriculaPeriodoVO = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(obj.getMatriculaPeriodo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		}
		if ((matriculaVO == null) || (matriculaVO.getMatricula().equals(""))) {
			matriculaVO = getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(obj.getMatricula(), 0, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		}
		excluirHistoricosRelativosAoControleCursandoPorCorrespodenciaDaDisciplinaMatriculaPeriodoTurmaDisciplinaAtual(obj, matriculaPeriodoVO, matriculaVO, configuracaoFinanceiroVO, usuario);
		boolean historicoExistente = true;
		HistoricoVO histVO = getFacadeFactory().getHistoricoFacade().consultaRapidaPorMatricula_matriculaPeriodo_Disciplina_Turma(obj.getMatricula(), obj.getMatriculaPeriodo(), matriculaVO.getGradeCurricularAtual().getCodigo(), obj.getDisciplina().getCodigo(), obj.getTurma().getCodigo(), false,matriculaVO.getMatriculaOnlineExterna() ,usuario);
		if (histVO == null) {
			historicoExistente = false;
			histVO = gerarHistoricoVOComBaseMatriculaPeriodoTurmaDisciplina(obj, matriculaPeriodoVO, matriculaVO, configuracaoFinanceiroVO, gradeCurricularVO, usuario);
			verificarEGerenciarHistoricoSendoCriadoParaSubstituirHistoricoDisciplinaQueEstavaSendoCursadaPorCorrespodencia(histVO, obj, matriculaPeriodoVO, matriculaVO, usuario);
			verificarEGerenciarHistoricoSendoCriadoParaSubstituirHistoricoDisciplinaQueEstavaSendoCursadaPorEquivalencia(histVO, obj, matriculaPeriodoVO, matriculaVO, usuario);
			if (obj.getDataRegistroHistorico() != null) {
				histVO.setDataRegistro(obj.getDataRegistroHistorico());
			}
			if (obj.getDataInicioAula() != null) {
				histVO.setDataInicioAula(obj.getDataInicioAula());
			}
			if (obj.getDataFimAula() != null) {
				histVO.setDataFimAula(obj.getDataFimAula());
			}
			incluir(histVO, usuario);
			if (matriculaVO.getCurso().getConfiguracaoAcademico().getRegistrarComoFaltaAulasRealizadasAposDataMatricula()) {
				getFacadeFactory().getFrequenciaAulaFacade().incluirFrequenciaFaltaAulasRealizadasAposDataMatricula(obj, histVO.getDataRegistro(), usuario);
			}
		} else {
			histVO.setDataRegistro(matriculaPeriodoVO.getData());
			histVO.setDataInicioAula(matriculaPeriodoVO.getDataInicioAula());
			histVO.setDataFimAula(matriculaPeriodoVO.getDataFinalAula());
			histVO.setAnoHistorico(matriculaPeriodoVO.getAno());
			histVO.setSemestreHistorico(matriculaPeriodoVO.getSemestre());
			alterarAnoSemestreHistorico(histVO.getCodigo(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), matriculaPeriodoVO.getData(), matriculaPeriodoVO.getDataInicioAula(), matriculaPeriodoVO.getDataFinalAula(), usuario);
		}

		// incluir historiconotaparcial caso já tenha uma estrutura definida
	if (!historicoExistente) {

		if(Uteis.isAtributoPreenchido(obj.getTurmaPratica())) {
			List<TurmaDisciplinaNotaParcialVO> listTurmaDisciplinaNotaParcial = new ArrayList<TurmaDisciplinaNotaParcialVO>(0);
			listTurmaDisciplinaNotaParcial = getFacadeFactory().getTurmaDisciplinaNotaParcialInterfaceFacade().consultarPorTurmaDisciplina(obj.getTurmaPratica(), obj.getDisciplina(), obj.getAno(), obj.getSemestre(), histVO.getConfiguracaoAcademico().getCodigo(), usuario, Uteis.NIVELMONTARDADOS_TODOS);
			if(Uteis.isAtributoPreenchido(listTurmaDisciplinaNotaParcial)) {
				for(TurmaDisciplinaNotaParcialVO turmaDisciplinaNotaParcialVO : listTurmaDisciplinaNotaParcial) {
					HistoricoNotaParcialVO historicoNotaParcialVO = new HistoricoNotaParcialVO();
					historicoNotaParcialVO.setHistorico(histVO);
					historicoNotaParcialVO.setTurmaDisciplinaNotaParcial(turmaDisciplinaNotaParcialVO);
					historicoNotaParcialVO.setTipoNota(turmaDisciplinaNotaParcialVO.getTurmaDisciplinaNotaTituloVO().getNota());
					getFacadeFactory().getHistoricoNotaParcialInterfaceFacade().incluir(historicoNotaParcialVO, usuario);
	}
			}

		}
		if(Uteis.isAtributoPreenchido(obj.getTurmaTeorica())) {
			List<TurmaDisciplinaNotaParcialVO> listTurmaDisciplinaNotaParcial = new ArrayList<TurmaDisciplinaNotaParcialVO>(0);
			listTurmaDisciplinaNotaParcial = getFacadeFactory().getTurmaDisciplinaNotaParcialInterfaceFacade().consultarPorTurmaDisciplina(obj.getTurmaTeorica(), obj.getDisciplina(), obj.getAno(), obj.getSemestre(), histVO.getConfiguracaoAcademico().getCodigo(), usuario, Uteis.NIVELMONTARDADOS_TODOS);
			if(Uteis.isAtributoPreenchido(listTurmaDisciplinaNotaParcial)) {
				for(TurmaDisciplinaNotaParcialVO turmaDisciplinaNotaParcialVO : listTurmaDisciplinaNotaParcial) {
					HistoricoNotaParcialVO historicoNotaParcialVO = new HistoricoNotaParcialVO();
					historicoNotaParcialVO.setHistorico(histVO);
					historicoNotaParcialVO.setTurmaDisciplinaNotaParcial(turmaDisciplinaNotaParcialVO);
					historicoNotaParcialVO.setTipoNota(turmaDisciplinaNotaParcialVO.getTurmaDisciplinaNotaTituloVO().getNota());
					getFacadeFactory().getHistoricoNotaParcialInterfaceFacade().incluir(historicoNotaParcialVO, usuario);
				}
			}

		}

		if(!Uteis.isAtributoPreenchido(obj.getTurmaPratica()) && !Uteis.isAtributoPreenchido(obj.getTurmaTeorica())) {
			List<TurmaDisciplinaNotaParcialVO> listTurmaDisciplinaNotaParcial = new ArrayList<TurmaDisciplinaNotaParcialVO>(0);
			listTurmaDisciplinaNotaParcial = getFacadeFactory().getTurmaDisciplinaNotaParcialInterfaceFacade().consultarPorTurmaDisciplina(obj.getTurma(), obj.getDisciplina(), obj.getAno(), obj.getSemestre(), histVO.getConfiguracaoAcademico().getCodigo(), usuario, Uteis.NIVELMONTARDADOS_TODOS);
			if(Uteis.isAtributoPreenchido(listTurmaDisciplinaNotaParcial)) {
				for(TurmaDisciplinaNotaParcialVO turmaDisciplinaNotaParcialVO : listTurmaDisciplinaNotaParcial) {
					HistoricoNotaParcialVO historicoNotaParcialVO = new HistoricoNotaParcialVO();
					historicoNotaParcialVO.setHistorico(histVO);
					historicoNotaParcialVO.setTurmaDisciplinaNotaParcial(turmaDisciplinaNotaParcialVO);
					historicoNotaParcialVO.setTipoNota(turmaDisciplinaNotaParcialVO.getTurmaDisciplinaNotaTituloVO().getNota());
					getFacadeFactory().getHistoricoNotaParcialInterfaceFacade().incluir(historicoNotaParcialVO, usuario);
				}
			}
		}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarAnoSemestreHistorico(final Integer codigo, final String ano, final String semestre, final Date dataRegistro, final Date dataInicioAula, final Date dataFimAula, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set anoHistorico=?, semestreHistorico=?, dataRegistro = ?, datainicioaula = ?, datafimaula = ?  WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					sqlAlterar.setString(++i, ano);
					sqlAlterar.setString(++i, semestre);
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(dataRegistro));
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(dataInicioAula));
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(dataFimAula));
					sqlAlterar.setInt(++i, codigo);
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	/**
	 * @deprecated na versão 5.0
	 */
	public void incluirHistoricoTransferenciaGradeCurricular(MatriculaPeriodoTurmaDisciplinaVO obj, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, Double mediaFinal, Double frequencia, String situacao, Integer mediaFinalNotaConceito, String anoHistorico, String semestreHistorico, String instituicao, Integer cidade, Integer cargaHoraria, Integer cargaHorariaCursada, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		// if ((matriculaPeriodoVO == null) ||
		// (matriculaPeriodoVO.getMatricula().equals(""))) {
		// matriculaPeriodoVO =
		// getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(obj.getMatriculaPeriodo(),
		// Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO,
		// usuario);
		// }
		// if ((matriculaVO == null) || (matriculaVO.getMatricula().equals("")))
		// {
		// matriculaVO =
		// getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(obj.getMatricula(),
		// 0, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO,
		// usuario);
		// }
		// HistoricoVO histVO =
		// getFacadeFactory().getHistoricoFacade().consultaRapidaPorMatricula_matriculaPeriodo_Disciplina(obj.getMatricula(),
		// obj.getMatriculaPeriodo(),
		// matriculaVO.getGradeCurricularAtual().getCodigo(),
		// obj.getDisciplina().getCodigo(), false, usuario);
		// if (histVO == null) {
		// histVO = new HistoricoVO();
		// histVO.setDisciplina(getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(obj.getDisciplina().getCodigo(),
		// Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
		// histVO.setMatricula(matriculaVO);
		// histVO.setMatriculaPeriodo(matriculaPeriodoVO);
		// histVO.setMatriculaPeriodoTurmaDisciplina(obj);
		// histVO.setDataRegistro(new Date());
		// histVO.setSituacao(situacao);
		// histVO.setMediaFinal(mediaFinal);
		// histVO.setFreguencia(frequencia);
		// histVO.setAnoHistorico(anoHistorico);
		// histVO.setSemestreHistorico(semestreHistorico);
		// histVO.getMediaFinalConceito().setCodigo(mediaFinalNotaConceito);
		// histVO.getCidadeVO().setCodigo(cidade);
		// histVO.setInstituicao(instituicao);
		// histVO.setCargaHorariaAproveitamentoDisciplina(cargaHoraria);
		// histVO.setCargaHorariaCursada(cargaHorariaCursada);
		// histVO.setIsentarMediaFinal(obj.getIsentarMediaFinal());
		// incluir(histVO, usuario);
		// }
	}

	public void incluirHistoricoInclusaoDisciplina(HistoricoVO obj) {
	}

	public void incluirHistorico(MatriculaPeriodoTurmaDisciplinaVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, GradeCurricularVO gradeCurricularVO, UsuarioVO usuario) throws Exception {
		incluirHistorico(obj, null, null, configuracaoFinanceiroVO, gradeCurricularVO, usuario);
	}

	public void validarConsultaDoUsuario(UsuarioVO usuario) throws Exception {
		Historico.consultar(getIdEntidade(), true, usuario);
	}

	public void validarConsultaDoUsuarioVisaoCoordenador(String identidadeLancamentoNota, UsuarioVO usuario) throws Exception {
		Historico.consultar(identidadeLancamentoNota, true, usuario);
	}

	public void incluirListaHistorico(List<HistoricoVO> listaHistorico, UsuarioVO usuario, String visao, TipoAlteracaoSituacaoHistoricoEnum tipoAlteracaoSituacaoHistoricoEnum) throws Exception {
		incluirListaHistorico(listaHistorico, getIdEntidade(), usuario, visao, false, tipoAlteracaoSituacaoHistoricoEnum);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirListaHistorico(final List<HistoricoVO> listaHistorico, String idEntidade, final UsuarioVO usuario, final String visao, final Boolean incluirNotaRecuperacao, final TipoAlteracaoSituacaoHistoricoEnum tipoAlteracaoSituacaoHistorico) throws ConsistirException, Exception  {
		boolean executarParalelismo = true;
		try {
			if (idEntidade != null && !idEntidade.trim().isEmpty()) {
				Historico.alterar(idEntidade, usuario);
			}
			if(executarParalelismo){
				final ConsistirException ex = new ConsistirException();
				ProcessarParalelismo.executar(0, listaHistorico.size(), ex, new ProcessarParalelismo.Processo() {
					@Override
					public void run(int i) {
						final HistoricoVO historicoVO = listaHistorico.get(i);
						try {
							getFacadeFactory().getHistoricoFacade().gravarLancamentoNota(historicoVO, incluirNotaRecuperacao, visao, tipoAlteracaoSituacaoHistorico, usuario);
						} catch (ConsistirException e) {
							ex.adicionarListaMensagemErro("Erro ao processar matrícula "+historicoVO.getMatricula().getMatricula()+" - "+e.getMessage()+".");
						} catch (Exception e) {
							ex.adicionarListaMensagemErro("Erro ao processar matrícula "+historicoVO.getMatricula().getMatricula()+" - "+e.getMessage()+".");
						}
					}
				});
				if(!ex.getListaMensagemErro().isEmpty()){
					throw ex;
				}
			}else{
				for(HistoricoVO historicoVO: listaHistorico){
					getFacadeFactory().getHistoricoFacade().gravarLancamentoNota(historicoVO, incluirNotaRecuperacao, visao, tipoAlteracaoSituacaoHistorico, usuario);
				}
			}
			getFacadeFactory().getLogLancamentoNotaFacade().registrarLogLancamentoNota(listaHistorico, "ALTERAÇÃO HISTORICO", usuario);
		} catch(ConsistirException ex){
			throw ex;
		}catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirListaHistoricoVisaoProfessor(final List<HistoricoVO> listaHistorico, String idEntidade, final UsuarioVO usuario, final String visao, final Boolean incluirNotaRecuperacao, CalendarioLancamentoNotaVO calendarioLancamentoNotaVO, boolean calcularMediaAoGravar) throws ConsistirException, Exception  {
		boolean executarParalelismo = true;
		try {

			if (validarCalculoMediaAutomaticaAoGravar(usuario, calendarioLancamentoNotaVO, calcularMediaAoGravar)) {
				for (HistoricoVO historicoVO : listaHistorico) {
					getFacadeFactory().getHistoricoFacade().calcularMedia(historicoVO, null, historicoVO.getConfiguracaoAcademico(), calendarioLancamentoNotaVO.getTurma().getCodigo(), TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, true, usuario);
				}
			}

			validarProfessorExclusivoLancamentoNota(calendarioLancamentoNotaVO, usuario);

			if(executarParalelismo){
				final ConsistirException ex = new ConsistirException();
				ProcessarParalelismo.executar(0, listaHistorico.size(), ex, new ProcessarParalelismo.Processo() {
					@Override
					public void run(int i) {
						final HistoricoVO historicoVO = listaHistorico.get(i);
						if (historicoVO.getHistoricoAlterado()) {
							try {
								getFacadeFactory().getHistoricoFacade().gravarLancamentoNota(historicoVO, incluirNotaRecuperacao, visao, TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, usuario);
							} catch (ConsistirException e) {
								ex.adicionarListaMensagemErro("Erro ao processar matrícula "+historicoVO.getMatricula().getMatricula()+" - "+e.getMessage()+".");
							} catch (Exception e) {
								ex.adicionarListaMensagemErro("Erro ao processar matrícula "+historicoVO.getMatricula().getMatricula()+" - "+e.getMessage()+".");
							}
						}
					}
				});
				if(!ex.getListaMensagemErro().isEmpty()){
					throw ex;
				}
			} else{
				for(HistoricoVO historicoVO: listaHistorico) {
					if (historicoVO.getHistoricoAlterado()) {
						getFacadeFactory().getHistoricoFacade().gravarLancamentoNota(historicoVO, incluirNotaRecuperacao, visao, TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, usuario);
					}
				}
			}
			getFacadeFactory().getLogLancamentoNotaFacade().registrarLogLancamentoNota(listaHistorico, "ALTERAÇÃO HISTORICO", usuario);
		} catch(ConsistirException ex){
			throw ex;
		}catch (Exception e) {
			throw e;
		}
	}

	public boolean validarCalculoMediaAutomaticaAoGravar(UsuarioVO usuarioVO, CalendarioLancamentoNotaVO calendarioLancamentoNotaVO, boolean calcularMediaAoGravar ) {
		try {
			return (calendarioLancamentoNotaVO != null && !calendarioLancamentoNotaVO.getCodigo().equals(0) && calcularMediaAoGravar)
			|| (calendarioLancamentoNotaVO != null && usuarioVO.getIsApresentarVisaoProfessor() && Uteis.isAtributoPreenchido(calendarioLancamentoNotaVO.getCalcularMediaAutomaticamenteGravarLancamentoNotasProfessorPartirde()) &&
						UteisData.validarDataInicialMaiorFinal(new Date(), calendarioLancamentoNotaVO.getCalcularMediaAutomaticamenteGravarLancamentoNotasProfessorPartirde()));
		} catch (ParseException e) {
			return false;
		}
	}

	/**
	 * Versão 5.0 Método responsável, por a partir de um historico de uma
	 * disciplina que participa de uma composicao, calcular e atualizar a média
	 * da disciplina composta (mãe) que define a composicao. O mesmo precisa
	 * observar se a composicao veio de uma GradeDisciplinaVO ou
	 * GradeCurricularGrupoOptativaVO, pois ambas permitem o uso de disciplinas
	 * compostas.
	 *
	 * @param historicoVO
	 * @param usuarioVO
	 * @throws Exception
	 */
	public Boolean executarAtualizacaoDisciplinaComposta(HistoricoVO historicoVO, List<HistoricoVO> historicoVOs, TipoAlteracaoSituacaoHistoricoEnum tipoAlteracaoSituacaoHistorico, Boolean alterarHistorico, Boolean resultadoDisciplinaFilha, UsuarioVO usuarioVO) throws Exception {
//		MatriculaPeriodoVO matriculaPeriodoVO = getFacadeFactory().getMatriculaPeriodoFacade().consultaRapidaPorHistoricoDadosGradeCurricular(historicoVO.getCodigo(), false, usuarioVO);
//		MatriculaPeriodoVO matriculaPeriodoVO = getFacadeFactory().getMatriculaPeriodoFacade().consultaRapidaPorHistoricoDadosGradeCurricular(historicoVO.getCodigo(), false, usuarioVO);
		HistoricoVO historicoDisciplinaComposta = null;
		if(historicoVO.getHistoricoDisciplinaComposta() && Uteis.isAtributoPreenchido(historicoVOs)) {
			historicoDisciplinaComposta = historicoVO;
		}else {
			historicoDisciplinaComposta = getFacadeFactory().getHistoricoFacade().consultaHistoricoDisciplinaCompostaPorMatriculaGradeCurricularAnoSemestreGradeDisciplinaComposta(historicoVO.getMatricula().getMatricula(), historicoVO.getMatrizCurricular().getCodigo(), historicoVO.getAnoHistorico(), historicoVO.getSemestreHistorico(), historicoVO.getGradeDisciplinaComposta().getCodigo(), false, usuarioVO);
		}

		if (Uteis.isAtributoPreenchido(historicoDisciplinaComposta)) {
//			GradeDisciplinaCompostaVO gradeDisciplinaCompostaVO = getFacadeFactory().getGradeDisciplinaCompostaFacade().consultarPorChavePrimaria(historicoVO.getGradeDisciplinaComposta().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);

			if(!Uteis.isAtributoPreenchido(historicoVOs)) {
				historicoVOs = getFacadeFactory().getHistoricoFacade().consultaRapidaHistoricoFazParteComposicaoPorMatriculaPorGradeCurricularPorMatriculaPeriodo(historicoDisciplinaComposta.getMatricula().getMatricula(), historicoVO.getCodigo(), historicoDisciplinaComposta.getMatriculaPeriodo().getCodigo(), historicoDisciplinaComposta.getMatrizCurricular().getCodigo(), historicoDisciplinaComposta.getGradeDisciplinaVO().getCodigo(), historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), false, usuarioVO);
				historicoVOs.add(historicoVO);
			}
			Ordenacao.ordenarLista(historicoVOs, "ordemComposicao");

			Double frequencia = 0.0;
			Double frequenciaReprovadaPorFalta = 0.0;
			boolean possuiConfiguracaoAcademicoDiferente = false;
			Map<Integer, ConfiguracaoAcademicoVO> mapConf = new HashMap<Integer, ConfiguracaoAcademicoVO>(0);
			mapConf.put(historicoDisciplinaComposta.getConfiguracaoAcademico().getCodigo(), historicoDisciplinaComposta.getConfiguracaoAcademico());
			int qtdeDisciplinaControlaFrequencia = 0;
			for (HistoricoVO obj : historicoVOs) {
				if (!mapConf.containsKey(obj.getConfiguracaoAcademico().getCodigo())) {
					possuiConfiguracaoAcademicoDiferente = true;
					if (!obj.getConfiguracaoAcademico().getNivelMontarDados().equals(NivelMontarDados.TODOS)) {
						mapConf.put(obj.getConfiguracaoAcademico().getCodigo(), getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(obj.getConfiguracaoAcademico().getCodigo(), usuarioVO));
						obj.setConfiguracaoAcademico(mapConf.get(obj.getConfiguracaoAcademico().getCodigo()));
					} else {
						mapConf.put(obj.getConfiguracaoAcademico().getCodigo(), obj.getConfiguracaoAcademico());
						obj.setConfiguracaoAcademico(mapConf.get(obj.getConfiguracaoAcademico().getCodigo()));
					}
				} else if (!obj.getConfiguracaoAcademico().getNivelMontarDados().equals(NivelMontarDados.TODOS)) {
					obj.setConfiguracaoAcademico(mapConf.get(obj.getConfiguracaoAcademico().getCodigo()));
				}
				if(!obj.getConfiguracaoAcademico().getPercentualFrequenciaAprovacao().equals(0.0)){
					qtdeDisciplinaControlaFrequencia++;
					if(obj.getFreguencia().equals(0.0)){
						realizarVerificacaoEAtualizacaoFrequenciaHistoricoAluno(obj, usuarioVO);
					}
					frequencia += obj.getFreguencia();
					if(historicoDisciplinaComposta.getConfiguracaoAcademico().getReprovarFaltaDisciplinaCompostaCasoReprovadoFaltaDisciplinaFilha()
							&& obj.getFreguencia() < obj.getConfiguracaoAcademico().getPercentualFrequenciaAprovacao()){
						frequenciaReprovadaPorFalta =  obj.getFreguencia();
					}
				}
			}
			executarCalculoFaltasAlunoBimestreDisciplinaComposta(historicoVOs, historicoDisciplinaComposta);
			if(historicoDisciplinaComposta.getConfiguracaoAcademico().getReprovarFaltaDisciplinaCompostaCasoReprovadoFaltaDisciplinaFilha() && frequenciaReprovadaPorFalta > 0){
				historicoDisciplinaComposta.setFreguencia(frequenciaReprovadaPorFalta);
			}else if(qtdeDisciplinaControlaFrequencia > 0){
				historicoDisciplinaComposta.setFreguencia(Uteis.arrendondarForcando2CadasDecimais(frequencia / qtdeDisciplinaControlaFrequencia));
			}else{
				historicoDisciplinaComposta.setFreguencia(100.0);
			}
			if (possuiConfiguracaoAcademicoDiferente
				&& (!historicoDisciplinaComposta.getConfiguracaoAcademico().getTipoUsoConfiguracaoAcademico().equals(TipoUsoConfiguracaoAcademicoEnum.COMPOSTA) || historicoDisciplinaComposta.getConfiguracaoAcademico().getRegraCalculoDisciplinaComposta().equals(RegraCalculoDisciplinaCompostaEnum.MEDIA_FILHA_COMPOSICAO))) {
				for(int x = 1; x<= historicoVOs.size(); x++){
					UtilReflexao.invocarMetodoSetParametroNull(historicoDisciplinaComposta, "nota"+x);
				}
				historicoDisciplinaComposta.setMediaFinal(null);
				int x = 1;
				for (HistoricoVO obj : historicoVOs) {
					String nomeNota = "NOTA"+x;
					if (Uteis.isAtributoPreenchido(nomeNota)) {
						inicializarDadosNotaDisciplinaComposta(historicoDisciplinaComposta, obj.getMediaFinal(), nomeNota);
					}
					x++;
				}
			}
			FormulaCalculoNotaEnum formulaCalculoNota = null;
			if (Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO())) {
				formulaCalculoNota = historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getFormulaCalculoNota();
			} else {
				formulaCalculoNota = historicoDisciplinaComposta.getGradeDisciplinaVO().getFormulaCalculoNota();
			}
			if (!possuiConfiguracaoAcademicoDiferente) {
				if (formulaCalculoNota.equals(FormulaCalculoNotaEnum.MEDIA)) {
					executarCalculoMediaParcialDisciplinaComposta(historicoDisciplinaComposta, historicoVOs, usuarioVO);
				} else if (formulaCalculoNota.equals(FormulaCalculoNotaEnum.FORMULA_CALCULO)) {
					executarCalculoMediaParcialDisciplinaCompostaPorFormulaCalculo(historicoDisciplinaComposta,
							historicoVOs, usuarioVO);
				} else {
					executarSomatorioNotaDisciplinaComposta(historicoDisciplinaComposta, historicoVOs, usuarioVO);
				}
			}
			realizarCalculoMediaFinalDisciplinaComposta(historicoDisciplinaComposta, historicoVOs, formulaCalculoNota, usuarioVO);

			if (historicoDisciplinaComposta.getMediaFinal() != null || (historicoDisciplinaComposta.getMediaFinal() == null && !historicoDisciplinaComposta.getConfiguracaoAcademico().getCalcularMediaFinalDisciplinaCompostaAposCalculoTodasComposicoes())) {
				calcularMedia(historicoDisciplinaComposta, historicoVOs, historicoDisciplinaComposta.getConfiguracaoAcademico(), null, tipoAlteracaoSituacaoHistorico, possuiConfiguracaoAcademicoDiferente, usuarioVO);
			} else {
				historicoDisciplinaComposta.setSituacao(SituacaoHistorico.CURSANDO.getValor());
			}
			realizarControleRecuperacaoDisciplinaComposta(historicoDisciplinaComposta, historicoVOs, alterarHistorico, usuarioVO);
			if ((historicoDisciplinaComposta.getMediaFinal() != null || (historicoDisciplinaComposta.getMediaFinal() == null && !historicoDisciplinaComposta.getConfiguracaoAcademico().getCalcularMediaFinalDisciplinaCompostaAposCalculoTodasComposicoes())) && historicoDisciplinaComposta.getControlaRecuperacaoDisciplinaComposta()) {
				calcularMedia(historicoDisciplinaComposta, historicoVOs, historicoDisciplinaComposta.getConfiguracaoAcademico(), null, tipoAlteracaoSituacaoHistorico, true, usuarioVO);
			}
			if(!historicoVO.getHistoricoDisciplinaComposta()) {
				historicoVO.setSituacaoHistoricoDisciplinaComposta(historicoDisciplinaComposta.getSituacao());
				if(!historicoVO.getConfiguracaoAcademico().getSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal()  &&
						historicoDisciplinaComposta.getConfiguracaoAcademico().getSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal()) {
					historicoVO.getConfiguracaoAcademico().setSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal(true);
				}
			}
				boolean deveAtualizarDisciplinaFazParteComposicao = realizarAtualizacaoSituacaoRegraEstabelecidaComboBoxTipoAlteracaoSituacaoHistorico(historicoDisciplinaComposta, tipoAlteracaoSituacaoHistorico);
				if(historicoDisciplinaComposta.getConfiguracaoAcademico().getSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal()){
					if (deveAtualizarDisciplinaFazParteComposicao) {
						for(HistoricoVO historico : historicoVOs){
							historico.setSituacao(historicoDisciplinaComposta.getSituacao());
							if(!historico.getCodigo().equals(historicoVO.getCodigo())){
								if (alterarHistorico) {
									alterarSituacaoHistoricoPorCodigo(historico.getCodigo(), historicoDisciplinaComposta.getSituacao(), usuarioVO);
								}
							}
						}
						if(resultadoDisciplinaFilha && historicoVO.getSituacao().equals(SituacaoHistorico.REPROVADO.getValor())){
							resultadoDisciplinaFilha = false;
						}else if(!resultadoDisciplinaFilha && historicoVO.getSituacao().equals(SituacaoHistorico.APROVADO.getValor())){
							resultadoDisciplinaFilha = true;
						}
					}
				}


				if (alterarHistorico) {
				alterar(historicoDisciplinaComposta, usuarioVO);
				if(historicoDisciplinaComposta.getConfiguracaoAcademico().getSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal()){
					HistoricoNotaVO historicoNotaVO = null;
					if(!historicoDisciplinaComposta.getHistoricoNotaVOs().isEmpty()){
						historicoNotaVO = historicoDisciplinaComposta.getHistoricoNotaVOs().get(0);
					}
					realizarCriacaoHistoricoNotaVO(historicoDisciplinaComposta, historicoVOs);
					if(((Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getGradeDisciplinaVO().getCodigo())
							&& historicoDisciplinaComposta.getGradeDisciplinaVO().getControlarRecuperacaoPelaDisciplinaPrincipal())||
							(Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo())
									&& historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getControlarRecuperacaoPelaDisciplinaPrincipal()))
							&& historicoNotaVO != null){
						historicoDisciplinaComposta.getHistoricoNotaVOs().add(historicoNotaVO);
					}
				}
				getFacadeFactory().getHistoricoNotaFacade().incluirHistoricoNotaVOs(historicoDisciplinaComposta);

			}
		}
		return resultadoDisciplinaFilha;
	}

	public void executarSimulacaoAtualizacaoDisciplinaComposta(
			HistoricoVO historicoDisciplinaComposta,
			List<HistoricoVO> historicosDisciplinasFazemParteComposicaoVOs,
			Boolean simulandoDoAproveitamentoDisciplina,
			UsuarioVO usuarioVO) throws Exception {

		// atualizando a frequencia final do historico
		Double frequencia = 0.0;
		boolean possuiConfiguracaoAcademicoDiferente = false;
		for (HistoricoVO obj : historicosDisciplinasFazemParteComposicaoVOs) {
			if (!obj.getConfiguracaoAcademico().getCodigo().equals(historicoDisciplinaComposta.getConfiguracaoAcademico().getCodigo())) {
				possuiConfiguracaoAcademicoDiferente = true;
			}
			frequencia += obj.getFreguencia();
		}
		historicoDisciplinaComposta.setFreguencia(Uteis.arrendondarForcando2CadasDecimais(frequencia / historicosDisciplinasFazemParteComposicaoVOs.size()));

		// atualizando a media final do historico
		if (possuiConfiguracaoAcademicoDiferente) {
			for (HistoricoVO obj : historicosDisciplinasFazemParteComposicaoVOs) {
				GradeDisciplinaCompostaVO gradeDisciplinaCompostaVO = obj.getGradeDisciplinaComposta();
				String nomeNota = gradeDisciplinaCompostaVO.executarVerificacaoNotaAtualizarHistoricoDisciplinaComposta();
				if (Uteis.isAtributoPreenchido(nomeNota)) {
					inicializarDadosNotaDisciplinaComposta(historicoDisciplinaComposta, obj.getMediaFinal(), nomeNota);
					calcularMedia(historicoDisciplinaComposta, historicosDisciplinasFazemParteComposicaoVOs, historicoDisciplinaComposta.getConfiguracaoAcademico(), null, TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, true, usuarioVO);
				}
			}
		} else {
			FormulaCalculoNotaEnum formulaCalculoNota = null;
			if (Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO())) {
				formulaCalculoNota = historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getFormulaCalculoNota();
			} else {
				formulaCalculoNota = historicoDisciplinaComposta.getGradeDisciplinaVO().getFormulaCalculoNota();
			}
			if (formulaCalculoNota.equals(FormulaCalculoNotaEnum.MEDIA)) {
				executarCalculoMediaParcialDisciplinaComposta(historicoDisciplinaComposta, historicosDisciplinasFazemParteComposicaoVOs, usuarioVO);
				realizarCalculoMediaFinalDisciplinaComposta(historicoDisciplinaComposta, historicosDisciplinasFazemParteComposicaoVOs, formulaCalculoNota, usuarioVO);
				if (historicoDisciplinaComposta.getMediaFinal() != null) {
					if (simulandoDoAproveitamentoDisciplina) {
						// como é por média, já deduzimos que a mae vai estar aprovada, pois a media
						// é gerada pelas filhas que estao todas aprovadas (no aproveitamento só vem disciplinas aprovadas)
						// e a configuracao é mesma. Isto evita o problema de chamar o método calcularMedia quando historico
						// que esta sendo aproveitado da matricula origem só contem a mediafinal por exemplo (nao tem notas parciais).
						// Isto pode ocorrer de um historico importado e/ou mesmo de historico que foi aproveitado na matricula origem
						historicoDisciplinaComposta.setSituacao(SituacaoHistorico.APROVADO.getValor());
					} else {
						calcularMedia(historicoDisciplinaComposta, historicosDisciplinasFazemParteComposicaoVOs, historicoDisciplinaComposta.getConfiguracaoAcademico(), null, TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, false, usuarioVO);
					}
				} else {
					historicoDisciplinaComposta.setSituacao(SituacaoHistorico.CURSANDO.getValor());
				}
			} else if (formulaCalculoNota.equals(FormulaCalculoNotaEnum.FORMULA_CALCULO)) {
				executarCalculoMediaParcialDisciplinaCompostaPorFormulaCalculo(historicoDisciplinaComposta, historicosDisciplinasFazemParteComposicaoVOs, usuarioVO);
				realizarCalculoMediaFinalDisciplinaComposta(historicoDisciplinaComposta, historicosDisciplinasFazemParteComposicaoVOs, formulaCalculoNota, usuarioVO);
				if (historicoDisciplinaComposta.getMediaFinal() != null) {
					calcularMedia(historicoDisciplinaComposta, historicosDisciplinasFazemParteComposicaoVOs, historicoDisciplinaComposta.getConfiguracaoAcademico(), null, TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, false, usuarioVO);
				} else {
					historicoDisciplinaComposta.setSituacao(SituacaoHistorico.CURSANDO.getValor());
				}
			} else {
				executarSomatorioNotaDisciplinaComposta(historicoDisciplinaComposta, historicosDisciplinasFazemParteComposicaoVOs, usuarioVO);
				realizarCalculoMediaFinalDisciplinaComposta(historicoDisciplinaComposta, historicosDisciplinasFazemParteComposicaoVOs, formulaCalculoNota, usuarioVO);
				if (historicoDisciplinaComposta.getMediaFinal() != null) {
					calcularMedia(historicoDisciplinaComposta, historicosDisciplinasFazemParteComposicaoVOs, historicoDisciplinaComposta.getConfiguracaoAcademico(), null, TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, false, usuarioVO);
				} else {
					historicoDisciplinaComposta.setSituacao(SituacaoHistorico.CURSANDO.getValor());
				}
			}
		}
	}

	public Boolean realizarAtualizacaoSituacaoRegraEstabelecidaComboBoxTipoAlteracaoSituacaoHistorico(HistoricoVO historicoDisciplinaComposta, TipoAlteracaoSituacaoHistoricoEnum tipoAlteracaoSituacaoHistorico) {
		boolean deveAtualizarDisciplinaFazParteComposicao = true;
		if (tipoAlteracaoSituacaoHistorico.equals(TipoAlteracaoSituacaoHistoricoEnum.APENAS_APROVADOS)) {
			if (!historicoDisciplinaComposta.getSituacao().equals(SituacaoHistorico.APROVADO.getValor())) {
				deveAtualizarDisciplinaFazParteComposicao = false;
			}
		} else if (tipoAlteracaoSituacaoHistorico.equals(TipoAlteracaoSituacaoHistoricoEnum.APENAS_REPROVADOS)) {
			if (!historicoDisciplinaComposta.getSituacao().equals(SituacaoHistorico.REPROVADO.getValor())) {
				deveAtualizarDisciplinaFazParteComposicao = false;
			}
		} else if (tipoAlteracaoSituacaoHistorico.equals(TipoAlteracaoSituacaoHistoricoEnum.APENAS_REPROVADOS_POR_FALTA)) {
			if (!historicoDisciplinaComposta.getSituacao().equals(SituacaoHistorico.REPROVADO_FALTA.getValor())) {
				deveAtualizarDisciplinaFazParteComposicao = false;
			}
		} else if (tipoAlteracaoSituacaoHistorico.equals(TipoAlteracaoSituacaoHistoricoEnum.NENHUM)) {
			deveAtualizarDisciplinaFazParteComposicao = false;
		}
		return deveAtualizarDisciplinaFazParteComposicao;
	}

	public void calcularMedia(HistoricoVO histVO, List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Integer turma, TipoAlteracaoSituacaoHistoricoEnum tipoAlteracaoSituacaoHistorico,  Boolean realizarCalculoNotas, UsuarioVO usuarioVO) throws Exception {
		Boolean historicoProvenienteImportacao = false; //configuracaoAcademicoVO.verificarHistoricoProvenienteImportacao(histVO);
		Boolean resultado = null;
		Map<Integer, ConfiguracaoAcademicoVO> mapConf = null;
		String situacaoAtual = null;
		try {
			if (histVO.getHistoricoDisciplinaAproveitada()) {
				// caso seja historico de aproveitamento e a disciplina seja mae da composicao, entao temos
				// que atualizar a situacao final da mesma.
				historicoProvenienteImportacao = false;
			}
			if (!historicoProvenienteImportacao) {
				resultado = false;
				situacaoAtual = histVO.getSituacao();
				try {
					if(histVO.getHistoricoDisciplinaComposta() && !Uteis.isAtributoPreenchido(historicoDisciplinaFazParteComposicaoVOs)) {
						histVO.setHistoricoDisciplinaFilhaComposicaoVOs(getFacadeFactory().getHistoricoFacade().consultaRapidaHistoricoFazParteComposicaoPorMatriculaPorGradeCurricularPorMatriculaPeriodo(histVO.getMatricula().getMatricula(), 0, histVO.getMatriculaPeriodo().getCodigo(), histVO.getMatrizCurricular().getCodigo(), histVO.getGradeDisciplinaVO().getCodigo(), histVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), false, usuarioVO));
						historicoDisciplinaFazParteComposicaoVOs = histVO.getHistoricoDisciplinaFilhaComposicaoVOs();
						mapConf =  new HashMap<Integer, ConfiguracaoAcademicoVO>(0);
						if(!mapConf.containsKey(histVO.getConfiguracaoAcademico().getCodigo())){
							mapConf.put(histVO.getConfiguracaoAcademico().getCodigo(), histVO.getConfiguracaoAcademico());
						}
						mapConf.put(histVO.getConfiguracaoAcademico().getCodigo(), histVO.getConfiguracaoAcademico());
						for (HistoricoVO obj : histVO.getHistoricoDisciplinaFilhaComposicaoVOs()) {
							if(!obj.getConfiguracaoAcademico().getNivelMontarDados().equals(NivelMontarDados.TODOS)) {
								if (!mapConf.containsKey(obj.getConfiguracaoAcademico().getCodigo())) {
									mapConf.put(obj.getConfiguracaoAcademico().getCodigo(), getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(obj.getConfiguracaoAcademico().getCodigo(), usuarioVO));
								}
								obj.setConfiguracaoAcademico(mapConf.get(obj.getConfiguracaoAcademico().getCodigo()));
							}
						}
					}
					if(realizarCalculoNotas) {
						verificarNotasLancadas(histVO, usuarioVO);
					}
					resultado = configuracaoAcademicoVO.substituirVariaveisFormulaPorValores(histVO, historicoDisciplinaFazParteComposicaoVOs, realizarCalculoNotas);
					if(histVO.getHistoricoDisciplinaFazParteComposicao()){
						resultado = getFacadeFactory().getHistoricoFacade().executarAtualizacaoDisciplinaComposta(histVO, null, tipoAlteracaoSituacaoHistorico, false, resultado, usuarioVO);
					}else if(!histVO.getHistoricoDisciplinaComposta()) {
						histVO.setEmRecuperacao(false);
						histVO.getHistoricoNotaVOs().clear();
						getFacadeFactory().getHistoricoFacade().realizarCriacaoHistoricoNotaVO(histVO, historicoDisciplinaFazParteComposicaoVOs);
					}
					verificarMatriculaDohistoricoSituacaoTransferidoERealizarAproveitamentoDisciplinaParaCursoTransferido(histVO,usuarioVO);
					
				} catch (FechamentoPeriodoLetivoException e) {
					histVO.setMediaFinal(null);
					getFacadeFactory().getLogFechamentoFacade().realizarRegistroLogFechamento(histVO.getMatricula().getMatricula());
				}
				if (histVO.getMediaFinal() != null) {
					if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() || configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
						histVO.setMediaFinal(Math.round(2 * histVO.getMediaFinal()) / 2.0);
					}
					if(Uteis.isAtributoPreenchido(histVO.getMatricula().getMatricula())) {
						montarFreguenciaAluno(histVO, turma, configuracaoAcademicoVO, usuarioVO);
					}
					if (!histVO.getHistoricoDisciplinaFazParteComposicao() || (histVO.getHistoricoDisciplinaFazParteComposicao() && !configuracaoAcademicoVO.getSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal())) {
						verificaAlunoReprovadoFalta(histVO, configuracaoAcademicoVO, usuarioVO);
						if ((!histVO.getSituacao().equals(SituacaoHistorico.REPROVADO_FALTA.getValor())) && (!histVO.getSituacao().equals(SituacaoHistorico.ISENTO.getValor())) && !histVO.getSituacao().equals("")) {
							if (resultado) {
								histVO.setSituacao(SituacaoHistorico.APROVADO.getValor());
							} else {
								histVO.setSituacao(SituacaoHistorico.REPROVADO.getValor());
							}
						}
					}else if (histVO.getHistoricoDisciplinaFazParteComposicao() && configuracaoAcademicoVO.getSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal()) {
						histVO.setSituacao(histVO.getSituacaoHistoricoDisciplinaComposta());
					}
					if (situacaoAtual.equals(SituacaoHistorico.TRANCAMENTO.getValor()) || situacaoAtual.equals(SituacaoHistorico.ABANDONO_CURSO.getValor()) || situacaoAtual.equals(SituacaoHistorico.CANCELADO.getValor())) {
						histVO.setSituacao(situacaoAtual);
					}
					realizarAtualizacaoSituacaoRegraEstabelecidaComboBoxTipoAlteracaoSituacaoHistorico(histVO, tipoAlteracaoSituacaoHistorico, situacaoAtual);
				} else {
					histVO.setSituacao(SituacaoHistorico.CURSANDO.getValor());
				}
			}
		} finally {
			if (historicoProvenienteImportacao != null) {
				historicoProvenienteImportacao = null;
			}
			if (resultado != null) {
				resultado = null;
			}
			if (situacaoAtual != null) {
				situacaoAtual = null;
			}
			if (mapConf != null) {
				mapConf.clear();
				mapConf = null;
			}
		}
	}

	public void realizarAtualizacaoSituacaoRegraEstabelecidaComboBoxTipoAlteracaoSituacaoHistorico(HistoricoVO histVO, TipoAlteracaoSituacaoHistoricoEnum tipoAlteracaoSituacaoHistorico, String situacaoAtual) {
		if (tipoAlteracaoSituacaoHistorico.equals(TipoAlteracaoSituacaoHistoricoEnum.APENAS_APROVADOS)) {
			if (!histVO.getSituacao().equals(SituacaoHistorico.APROVADO.getValor())) {
				histVO.setSituacao(situacaoAtual);
			}
		} else if (tipoAlteracaoSituacaoHistorico.equals(TipoAlteracaoSituacaoHistoricoEnum.APENAS_REPROVADOS)) {
			if (!histVO.getSituacao().equals(SituacaoHistorico.REPROVADO.getValor())) {
				histVO.setSituacao(situacaoAtual);
			}
		} else if (tipoAlteracaoSituacaoHistorico.equals(TipoAlteracaoSituacaoHistoricoEnum.APENAS_REPROVADOS_POR_FALTA)) {
			if (!histVO.getSituacao().equals(SituacaoHistorico.REPROVADO_FALTA.getValor())) {
				histVO.setSituacao(situacaoAtual);
			}
		} else if (tipoAlteracaoSituacaoHistorico.equals(TipoAlteracaoSituacaoHistoricoEnum.NENHUM)) {
			histVO.setSituacao(situacaoAtual);
		}
	}

	public void montarFreguenciaAluno(HistoricoVO obj, Integer turma, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuarioVO) throws Exception {
		obj.setFreguencia(100.0);;
//		if (turma == null || turma == 0) {
//			turma = obj.getMatriculaPeriodoTurmaDisciplina().getTurma().getCodigo();
//		}
//		obj.setDisciplina(getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(obj.getDisciplina().getCodigo(), Uteis.NIVELMONTARDADOS_PROCESSAMENTO, usuarioVO));
//		if(configuracaoAcademicoVO.getUsarFormulaCalculoFrequencia() && !configuracaoAcademicoVO.getFormulaCalculoFrequencia().trim().isEmpty()) {
//			String formula = configuracaoAcademicoVO.substituirSimbolosFormulaCalculoMediaFinal(obj, configuracaoAcademicoVO.getFormulaCalculoFrequencia(), null);
//			obj.setFreguencia(Uteis.arrendondarForcando2CadasDecimais(Uteis.realizarCalculoFormula(formula)));
//		}else if (obj.getFreguencia().equals(0.0) && !obj.getDisciplina().getDisciplinaComposta()) {
//			executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFaltaFrequenciaHistorico(obj, configuracaoAcademicoVO, usuarioVO);
//		} else if (obj.getDisciplina().getDisciplinaComposta()) {
//			Double freguencia = calcularFrequenciaAlunoDisciplinaComposta(turma, obj.getDisciplina().getCodigo(), obj.getMatriculaPeriodoTurmaDisciplina().getSemestre(), obj.getMatriculaPeriodoTurmaDisciplina().getAno(), obj.getMatricula().getMatricula(), usuarioVO);
//			obj.setFreguencia(Uteis.arrendondarForcando2CadasDecimais(freguencia));
//		}
	}

	public void inicializarDadosNotaDisciplinaComposta(HistoricoVO obj, Double nota, String nomeNota) {
		if (nomeNota.equals("NOTA1")) {
			obj.setNota1(nota);
			if (nota != null) {
				obj.setNota1Lancada(Boolean.TRUE);
			} else {
				obj.setNota1Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota1(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA2")) {
			obj.setNota2(nota);
			if (nota != null) {
				obj.setNota2Lancada(Boolean.TRUE);
			} else {
				obj.setNota2Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota2(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA3")) {
			obj.setNota3(nota);
			if (nota != null) {
				obj.setNota3Lancada(Boolean.TRUE);
			} else {
				obj.setNota3Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota3(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA4")) {
			obj.setNota4(nota);
			if (nota != null) {
				obj.setNota4Lancada(Boolean.TRUE);
			} else {
				obj.setNota4Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota4(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA5")) {
			obj.setNota5(nota);
			if (nota != null) {
				obj.setNota5Lancada(Boolean.TRUE);
			} else {
				obj.setNota5Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota5(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA6")) {
			obj.setNota6(nota);
			if (nota != null) {
				obj.setNota6Lancada(Boolean.TRUE);
			} else {
				obj.setNota6Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota6(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA7")) {
			obj.setNota7(nota);
			if (nota != null) {
				obj.setNota7Lancada(Boolean.TRUE);
			} else {
				obj.setNota7Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota7(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA8")) {
			obj.setNota8(nota);
			if (nota != null) {
				obj.setNota8Lancada(Boolean.TRUE);
			} else {
				obj.setNota8Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota8(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA9")) {
			obj.setNota9(nota);
			if (nota != null) {
				obj.setNota9Lancada(Boolean.TRUE);
			} else {
				obj.setNota9Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota9(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA10")) {
			obj.setNota10(nota);
			if (nota != null) {
				obj.setNota10Lancada(Boolean.TRUE);
			} else {
				obj.setNota10Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota10(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA11")) {
			obj.setNota11(nota);
			if (nota != null) {
				obj.setNota11Lancada(Boolean.TRUE);
			} else {
				obj.setNota11Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota11(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA12")) {
			obj.setNota12(nota);
			if (nota != null) {
				obj.setNota12Lancada(Boolean.TRUE);
			} else {
				obj.setNota12Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota12(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA13")) {
			obj.setNota13(nota);
			if (nota != null) {
				obj.setNota13Lancada(Boolean.TRUE);
			} else {
				obj.setNota13Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota13(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA14")) {
			obj.setNota14(nota);
			if (nota != null) {
				obj.setNota14Lancada(Boolean.TRUE);
			} else {
				obj.setNota14Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota14(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA15")) {
			obj.setNota15(nota);
			if (nota != null) {
				obj.setNota15Lancada(Boolean.TRUE);
			} else {
				obj.setNota15Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota15(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA16")) {
			obj.setNota16(nota);
			if (nota != null) {
				obj.setNota16Lancada(Boolean.TRUE);
			} else {
				obj.setNota16Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota16(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA17")) {
			obj.setNota17(nota);
			if (nota != null) {
				obj.setNota17Lancada(Boolean.TRUE);
			} else {
				obj.setNota17Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota17(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA18")) {
			obj.setNota18(nota);
			if (nota != null) {
				obj.setNota18Lancada(Boolean.TRUE);
			} else {
				obj.setNota18Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota18(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA19")) {
			obj.setNota19(nota);
			if (nota != null) {
				obj.setNota19Lancada(Boolean.TRUE);
			} else {
				obj.setNota19Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota19(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA20")) {
			obj.setNota20(nota);
			if (nota != null) {
				obj.setNota20Lancada(Boolean.TRUE);
			} else {
				obj.setNota20Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota20(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA21")) {
			obj.setNota21(nota);
			if (nota != null) {
				obj.setNota21Lancada(Boolean.TRUE);
			} else {
				obj.setNota21Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota21(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA22")) {
			obj.setNota22(nota);
			if (nota != null) {
				obj.setNota22Lancada(Boolean.TRUE);
			} else {
				obj.setNota22Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota22(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA23")) {
			obj.setNota23(nota);
			if (nota != null) {
				obj.setNota23Lancada(Boolean.TRUE);
			} else {
				obj.setNota23Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota23(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA24")) {
			obj.setNota24(nota);
			if (nota != null) {
				obj.setNota24Lancada(Boolean.TRUE);
			} else {
				obj.setNota24Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota24(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA25")) {
			obj.setNota25(nota);
			if (nota != null) {
				obj.setNota25Lancada(Boolean.TRUE);
			} else {
				obj.setNota25Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota25(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA26")) {
			obj.setNota26(nota);
			if (nota != null) {
				obj.setNota26Lancada(Boolean.TRUE);
			} else {
				obj.setNota26Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota26(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA27")) {
			obj.setNota27(nota);
			if (nota != null) {
				obj.setNota27Lancada(Boolean.TRUE);
			} else {
				obj.setNota27Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota27(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA28")) {
			obj.setNota28(nota);
			if (nota != null) {
				obj.setNota28Lancada(Boolean.TRUE);
			} else {
				obj.setNota28Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota28(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA29")) {
			obj.setNota29(nota);
			if (nota != null) {
				obj.setNota29Lancada(Boolean.TRUE);
			} else {
				obj.setNota29Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota29(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA30")) {
			obj.setNota30(nota);
			if (nota != null) {
				obj.setNota30Lancada(Boolean.TRUE);
			} else {
				obj.setNota30Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota30(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA31")) {
			obj.setNota31(nota);
			if (nota != null) {
				obj.setNota31Lancada(Boolean.TRUE);
			} else {
				obj.setNota31Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota31(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA32")) {
			obj.setNota32(nota);
			if (nota != null) {
				obj.setNota32Lancada(Boolean.TRUE);
			} else {
				obj.setNota32Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota32(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA33")) {
			obj.setNota33(nota);
			if (nota != null) {
				obj.setNota33Lancada(Boolean.TRUE);
			} else {
				obj.setNota33Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota33(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA34")) {
			obj.setNota34(nota);
			if (nota != null) {
				obj.setNota34Lancada(Boolean.TRUE);
			} else {
				obj.setNota34Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota34(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA35")) {
			obj.setNota35(nota);
			if (nota != null) {
				obj.setNota35Lancada(Boolean.TRUE);
			} else {
				obj.setNota35Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota35(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA36")) {
			obj.setNota36(nota);
			if (nota != null) {
				obj.setNota36Lancada(Boolean.TRUE);
			} else {
				obj.setNota36Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota36(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA36")) {
			obj.setNota36(nota);
			if (nota != null) {
				obj.setNota36Lancada(Boolean.TRUE);
			} else {
				obj.setNota36Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota36(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA38")) {
			obj.setNota38(nota);
			if (nota != null) {
				obj.setNota38Lancada(Boolean.TRUE);
			} else {
				obj.setNota38Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota38(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA39")) {
			obj.setNota39(nota);
			if (nota != null) {
				obj.setNota39Lancada(Boolean.TRUE);
			} else {
				obj.setNota39Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota39(obj, obj.getConfiguracaoAcademico());
		}
		if (nomeNota.equals("NOTA40")) {
			obj.setNota40(nota);
			if (nota != null) {
				obj.setNota40Lancada(Boolean.TRUE);
			} else {
				obj.setNota40Lancada(Boolean.FALSE);
			}
			checarFormatarValoresNota40(obj, obj.getConfiguracaoAcademico());
		}
		String indice = nomeNota.replace("NOTA", "").trim();
		if(Uteis.getIsValorNumerico(indice)){
			Object configuracaoAcademicaNotaVO = UtilReflexao.invocarMetodoGet(obj.getConfiguracaoAcademico(), "configuracaoAcademicaNota"+indice+"VO");
			if(configuracaoAcademicaNotaVO != null && configuracaoAcademicaNotaVO instanceof ConfiguracaoAcademicaNotaVO) {
				Object notaObj = UtilReflexao.invocarMetodoGet(obj, "nota"+indice);
				if(notaObj != null) {
					((ConfiguracaoAcademicaNotaVO)configuracaoAcademicaNotaVO).setNotaDigitada((Double)notaObj);
				}else {
					((ConfiguracaoAcademicaNotaVO)configuracaoAcademicaNotaVO).setNotaDigitada(null);
				}
			}
		}
	}

	public void checarFormatarValoresNota1(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota1() != null) {
			if (historicoAux.getNota1() > configuracaoAcademicoVO.getFaixaNota1Maior()) {
				historicoAux.setNota1(configuracaoAcademicoVO.getFaixaNota1Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota1(Math.round(2 * historicoAux.getNota1()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota1MediaFinal()) {
				historicoAux.setNota1(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota1()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota1MediaFinal()) {
				historicoAux.setNota1(Math.round(2 * historicoAux.getNota1()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota2(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota2() != null) {
			if (historicoAux.getNota2() > configuracaoAcademicoVO.getFaixaNota2Maior()) {
				historicoAux.setNota2(configuracaoAcademicoVO.getFaixaNota2Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota2(Math.round(2 * historicoAux.getNota2()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota2MediaFinal()) {
				historicoAux.setNota2(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota2()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota2MediaFinal()) {
				historicoAux.setNota2(Math.round(2 * historicoAux.getNota2()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota3(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota3() != null) {
			if (historicoAux.getNota3() > configuracaoAcademicoVO.getFaixaNota3Maior()) {
				historicoAux.setNota3(configuracaoAcademicoVO.getFaixaNota3Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota3(Math.round(2 * historicoAux.getNota3()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota3MediaFinal()) {
				historicoAux.setNota3(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota3()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota3MediaFinal()) {
				historicoAux.setNota3(Math.round(2 * historicoAux.getNota3()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota4(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota4() != null) {
			if (historicoAux.getNota4() > configuracaoAcademicoVO.getFaixaNota4Maior()) {
				historicoAux.setNota4(configuracaoAcademicoVO.getFaixaNota4Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota4(Math.round(2 * historicoAux.getNota4()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota4MediaFinal()) {
				historicoAux.setNota4(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota4()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota4MediaFinal()) {
				historicoAux.setNota4(Math.round(2 * historicoAux.getNota4()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota5(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota5() != null) {
			if (historicoAux.getNota5() > configuracaoAcademicoVO.getFaixaNota5Maior()) {
				historicoAux.setNota5(configuracaoAcademicoVO.getFaixaNota5Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota5(Math.round(2 * historicoAux.getNota5()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota5MediaFinal()) {
				historicoAux.setNota5(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota5()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota5MediaFinal()) {
				historicoAux.setNota5(Math.round(2 * historicoAux.getNota5()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota6(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota6() != null) {
			if (historicoAux.getNota6() > configuracaoAcademicoVO.getFaixaNota6Maior()) {
				historicoAux.setNota6(configuracaoAcademicoVO.getFaixaNota6Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota6(Math.round(2 * historicoAux.getNota6()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota6MediaFinal()) {
				historicoAux.setNota6(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota6()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota6MediaFinal()) {
				historicoAux.setNota6(Math.round(2 * historicoAux.getNota6()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota7(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota7() != null) {
			if (historicoAux.getNota7() > configuracaoAcademicoVO.getFaixaNota7Maior()) {
				historicoAux.setNota7(configuracaoAcademicoVO.getFaixaNota7Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota7(Math.round(2 * historicoAux.getNota7()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota7MediaFinal()) {
				historicoAux.setNota7(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota7()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota7MediaFinal()) {
				historicoAux.setNota7(Math.round(2 * historicoAux.getNota7()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota8(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota8() != null) {
			if (historicoAux.getNota8() > configuracaoAcademicoVO.getFaixaNota8Maior()) {
				historicoAux.setNota8(configuracaoAcademicoVO.getFaixaNota8Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota8(Math.round(2 * historicoAux.getNota8()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota8MediaFinal()) {
				historicoAux.setNota8(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota8()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota8MediaFinal()) {
				historicoAux.setNota8(Math.round(2 * historicoAux.getNota8()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota9(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota9() != null) {
			if (historicoAux.getNota9() > configuracaoAcademicoVO.getFaixaNota9Maior()) {
				historicoAux.setNota9(configuracaoAcademicoVO.getFaixaNota9Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota9(Math.round(2 * historicoAux.getNota9()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota9MediaFinal()) {
				historicoAux.setNota9(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota9()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota9MediaFinal()) {
				historicoAux.setNota9(Math.round(2 * historicoAux.getNota9()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota10(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota10() != null) {
			if (historicoAux.getNota10() > configuracaoAcademicoVO.getFaixaNota10Maior()) {
				historicoAux.setNota10(configuracaoAcademicoVO.getFaixaNota10Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota10(Math.round(2 * historicoAux.getNota10()) / 2.0);

			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota10MediaFinal()) {
				historicoAux.setNota10(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota10()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota10MediaFinal()) {
				historicoAux.setNota10(Math.round(2 * historicoAux.getNota10()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota11(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota11() != null) {
			if (historicoAux.getNota11() > configuracaoAcademicoVO.getFaixaNota11Maior()) {
				historicoAux.setNota11(configuracaoAcademicoVO.getFaixaNota11Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota11(Math.round(2 * historicoAux.getNota11()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota11MediaFinal()) {
				historicoAux.setNota11(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota11()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota11MediaFinal()) {
				historicoAux.setNota11(Math.round(2 * historicoAux.getNota11()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota12(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota12() != null) {
			if (historicoAux.getNota12() > configuracaoAcademicoVO.getFaixaNota12Maior()) {
				historicoAux.setNota12(configuracaoAcademicoVO.getFaixaNota12Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota12(Math.round(2 * historicoAux.getNota12()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota12MediaFinal()) {
				historicoAux.setNota12(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota12()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota12MediaFinal()) {
				historicoAux.setNota12(Math.round(2 * historicoAux.getNota12()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota13(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota13() != null) {
			if (historicoAux.getNota13() > configuracaoAcademicoVO.getFaixaNota13Maior()) {
				historicoAux.setNota13(configuracaoAcademicoVO.getFaixaNota13Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota13(Math.round(2 * historicoAux.getNota13()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota13MediaFinal()) {
				historicoAux.setNota13(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota13()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota13MediaFinal()) {
				historicoAux.setNota13(Math.round(2 * historicoAux.getNota13()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota14(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota14() != null) {
			if (historicoAux.getNota14() > configuracaoAcademicoVO.getFaixaNota14Maior()) {
				historicoAux.setNota14(configuracaoAcademicoVO.getFaixaNota14Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota14(Math.round(2 * historicoAux.getNota14()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota14MediaFinal()) {
				historicoAux.setNota14(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota14()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota14MediaFinal()) {
				historicoAux.setNota14(Math.round(2 * historicoAux.getNota14()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota15(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota15() != null) {
			if (historicoAux.getNota15() > configuracaoAcademicoVO.getFaixaNota15Maior()) {
				historicoAux.setNota15(configuracaoAcademicoVO.getFaixaNota15Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota15(Math.round(2 * historicoAux.getNota15()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota15MediaFinal()) {
				historicoAux.setNota15(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota15()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota15MediaFinal()) {
				historicoAux.setNota15(Math.round(2 * historicoAux.getNota15()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota16(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota16() != null) {
			if (historicoAux.getNota16() > configuracaoAcademicoVO.getFaixaNota16Maior()) {
				historicoAux.setNota16(configuracaoAcademicoVO.getFaixaNota16Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota16(Math.round(2 * historicoAux.getNota16()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota16MediaFinal()) {
				historicoAux.setNota16(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota16()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota16MediaFinal()) {
				historicoAux.setNota16(Math.round(2 * historicoAux.getNota16()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota17(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota17() != null) {
			if (historicoAux.getNota17() > configuracaoAcademicoVO.getFaixaNota17Maior()) {
				historicoAux.setNota17(configuracaoAcademicoVO.getFaixaNota17Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota17(Math.round(2 * historicoAux.getNota17()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota17MediaFinal()) {
				historicoAux.setNota17(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota17()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota17MediaFinal()) {
				historicoAux.setNota17(Math.round(2 * historicoAux.getNota17()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota18(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota18() != null) {
			if (historicoAux.getNota18() > configuracaoAcademicoVO.getFaixaNota18Maior()) {
				historicoAux.setNota18(configuracaoAcademicoVO.getFaixaNota18Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota18(Math.round(2 * historicoAux.getNota18()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota18MediaFinal()) {
				historicoAux.setNota18(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota18()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota18MediaFinal()) {
				historicoAux.setNota18(Math.round(2 * historicoAux.getNota18()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota19(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota19() != null) {
			if (historicoAux.getNota19() > configuracaoAcademicoVO.getFaixaNota19Maior()) {
				historicoAux.setNota19(configuracaoAcademicoVO.getFaixaNota19Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota19(Math.round(2 * historicoAux.getNota19()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota19MediaFinal()) {
				historicoAux.setNota19(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota19()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota19MediaFinal()) {
				historicoAux.setNota19(Math.round(2 * historicoAux.getNota19()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota20(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota20() != null) {
			if (historicoAux.getNota20() > configuracaoAcademicoVO.getFaixaNota20Maior()) {
				historicoAux.setNota20(configuracaoAcademicoVO.getFaixaNota20Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota20(Math.round(2 * historicoAux.getNota20()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota20MediaFinal()) {
				historicoAux.setNota20(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota20()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota20MediaFinal()) {
				historicoAux.setNota20(Math.round(2 * historicoAux.getNota20()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota21(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota21() != null) {
			if (historicoAux.getNota21() > configuracaoAcademicoVO.getFaixaNota21Maior()) {
				historicoAux.setNota21(configuracaoAcademicoVO.getFaixaNota21Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota21(Math.round(2 * historicoAux.getNota21()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota21MediaFinal()) {
				historicoAux.setNota21(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota21()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota21MediaFinal()) {
				historicoAux.setNota21(Math.round(2 * historicoAux.getNota21()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota22(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota22() != null) {
			if (historicoAux.getNota22() > configuracaoAcademicoVO.getFaixaNota22Maior()) {
				historicoAux.setNota22(configuracaoAcademicoVO.getFaixaNota22Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota22(Math.round(2 * historicoAux.getNota22()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota22MediaFinal()) {
				historicoAux.setNota22(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota22()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota22MediaFinal()) {
				historicoAux.setNota22(Math.round(2 * historicoAux.getNota22()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota23(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota23() != null) {
			if (historicoAux.getNota23() > configuracaoAcademicoVO.getFaixaNota23Maior()) {
				historicoAux.setNota23(configuracaoAcademicoVO.getFaixaNota23Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota23(Math.round(2 * historicoAux.getNota23()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota23MediaFinal()) {
				historicoAux.setNota23(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota23()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota23MediaFinal()) {
				historicoAux.setNota23(Math.round(2 * historicoAux.getNota23()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota24(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota24() != null) {
			if (historicoAux.getNota24() > configuracaoAcademicoVO.getFaixaNota24Maior()) {
				historicoAux.setNota24(configuracaoAcademicoVO.getFaixaNota24Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota24(Math.round(2 * historicoAux.getNota24()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota24MediaFinal()) {
				historicoAux.setNota24(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota24()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota24MediaFinal()) {
				historicoAux.setNota24(Math.round(2 * historicoAux.getNota24()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota25(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota25() != null) {
			if (historicoAux.getNota25() > configuracaoAcademicoVO.getFaixaNota25Maior()) {
				historicoAux.setNota25(configuracaoAcademicoVO.getFaixaNota25Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota25(Math.round(2 * historicoAux.getNota25()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota25MediaFinal()) {
				historicoAux.setNota25(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota25()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota25MediaFinal()) {
				historicoAux.setNota25(Math.round(2 * historicoAux.getNota25()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota26(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota26() != null) {
			if (historicoAux.getNota26() > configuracaoAcademicoVO.getFaixaNota26Maior()) {
				historicoAux.setNota26(configuracaoAcademicoVO.getFaixaNota26Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota26(Math.round(2 * historicoAux.getNota26()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota26MediaFinal()) {
				historicoAux.setNota26(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota26()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota26MediaFinal()) {
				historicoAux.setNota26(Math.round(2 * historicoAux.getNota26()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota27(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota27() != null) {
			if (historicoAux.getNota27() > configuracaoAcademicoVO.getFaixaNota27Maior()) {
				historicoAux.setNota27(configuracaoAcademicoVO.getFaixaNota27Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota27(Math.round(2 * historicoAux.getNota27()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota27MediaFinal()) {
				historicoAux.setNota27(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota27()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota27MediaFinal()) {
				historicoAux.setNota27(Math.round(2 * historicoAux.getNota27()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota28(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota28() != null) {
			if (historicoAux.getNota28() > configuracaoAcademicoVO.getFaixaNota28Maior()) {
				historicoAux.setNota28(configuracaoAcademicoVO.getFaixaNota28Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota28(Math.round(2 * historicoAux.getNota28()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota28MediaFinal()) {
				historicoAux.setNota28(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota28()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota28MediaFinal()) {
				historicoAux.setNota28(Math.round(2 * historicoAux.getNota28()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota29(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota29() != null) {
			if (historicoAux.getNota29() > configuracaoAcademicoVO.getFaixaNota29Maior()) {
				historicoAux.setNota29(configuracaoAcademicoVO.getFaixaNota29Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota29(Math.round(2 * historicoAux.getNota29()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota29MediaFinal()) {
				historicoAux.setNota29(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota29()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota29MediaFinal()) {
				historicoAux.setNota29(Math.round(2 * historicoAux.getNota29()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota30(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota30() != null) {
			if (historicoAux.getNota30() > configuracaoAcademicoVO.getFaixaNota30Maior()) {
				historicoAux.setNota30(configuracaoAcademicoVO.getFaixaNota30Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota30(Math.round(2 * historicoAux.getNota30()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota30MediaFinal()) {
				historicoAux.setNota30(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota30()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota30MediaFinal()) {
				historicoAux.setNota30(Math.round(2 * historicoAux.getNota30()) / 2.0);
			}
		}
	}

	public void verificarNotasLancadas(HistoricoVO historicoVO, UsuarioVO usuario) {
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota1PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota1().trim().isEmpty()) {
			historicoVO.setNota1(null);
			if (historicoVO.getNota1Conceito().getCodigo() == 0) {
				historicoVO.setNota1Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota1ConceitoVOs()) {
				if (historicoVO.getNota1Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota1Conceito(canc.clone());
					historicoVO.setNota1(historicoVO.getNota1Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota1Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota2PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota2().trim().isEmpty()) {
			historicoVO.setNota2(null);
			if (historicoVO.getNota2Conceito().getCodigo() == 0) {
				historicoVO.setNota2Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota2ConceitoVOs()) {
				if (historicoVO.getNota2Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota2Conceito(canc.clone());
					historicoVO.setNota2(historicoVO.getNota2Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota2Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota3PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota3().trim().isEmpty()) {
			historicoVO.setNota3(null);
			if (historicoVO.getNota3Conceito().getCodigo() == 0) {
				historicoVO.setNota3Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota3ConceitoVOs()) {
				if (historicoVO.getNota3Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota3Conceito(canc.clone());
					historicoVO.setNota3(historicoVO.getNota3Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota3Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota4PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota4().trim().isEmpty()) {
			historicoVO.setNota4(null);
			if (historicoVO.getNota4Conceito().getCodigo() == 0) {
				historicoVO.setNota4Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota4ConceitoVOs()) {
				if (historicoVO.getNota4Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota4Conceito(canc.clone());
					historicoVO.setNota4(historicoVO.getNota4Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota4Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota5PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota5().trim().isEmpty()) {
			historicoVO.setNota5(null);
			if (historicoVO.getNota5Conceito().getCodigo() == 0) {
				historicoVO.setNota5Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota5ConceitoVOs()) {
				if (historicoVO.getNota5Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota5Conceito(canc.clone());
					historicoVO.setNota5(historicoVO.getNota5Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota5Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota6PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota6().trim().isEmpty()) {
			historicoVO.setNota6(null);
			if (historicoVO.getNota6Conceito().getCodigo() == 0) {
				historicoVO.setNota6Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota6ConceitoVOs()) {
				if (historicoVO.getNota6Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota6Conceito(canc.clone());
					historicoVO.setNota6(historicoVO.getNota6Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota6Conceito(null);
		}

		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota7PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota7().trim().isEmpty()) {
			historicoVO.setNota7(null);
			if (historicoVO.getNota7Conceito().getCodigo() == 0) {
				historicoVO.setNota7Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota7ConceitoVOs()) {
				if (historicoVO.getNota7Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota7Conceito(canc.clone());
					historicoVO.setNota7(historicoVO.getNota7Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota7Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota8PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota8().trim().isEmpty()) {
			historicoVO.setNota8(null);
			if (historicoVO.getNota8Conceito().getCodigo() == 0) {
				historicoVO.setNota8Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota8ConceitoVOs()) {
				if (historicoVO.getNota8Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota8Conceito(canc.clone());
					historicoVO.setNota8(historicoVO.getNota8Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota8Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota9PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota9().trim().isEmpty()) {
			historicoVO.setNota9(null);
			if (historicoVO.getNota9Conceito().getCodigo() == 0) {
				historicoVO.setNota9Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota9ConceitoVOs()) {
				if (historicoVO.getNota9Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota9Conceito(canc.clone());
					historicoVO.setNota9(historicoVO.getNota9Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota9Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota10PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota10().trim().isEmpty()) {
			historicoVO.setNota10(null);
			if (historicoVO.getNota10Conceito().getCodigo() == 0) {
				historicoVO.setNota10Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota10ConceitoVOs()) {
				if (historicoVO.getNota10Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota10Conceito(canc.clone());
					historicoVO.setNota10(historicoVO.getNota10Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota10Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota11PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota11().trim().isEmpty()) {
			historicoVO.setNota11(null);
			if (historicoVO.getNota11Conceito().getCodigo() == 0) {
				historicoVO.setNota11Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota11ConceitoVOs()) {
				if (historicoVO.getNota11Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota11Conceito(canc.clone());
					historicoVO.setNota11(historicoVO.getNota11Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota11Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota12PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota12().trim().isEmpty()) {
			historicoVO.setNota12(null);
			if (historicoVO.getNota12Conceito().getCodigo() == 0) {
				historicoVO.setNota12Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota12ConceitoVOs()) {
				if (historicoVO.getNota12Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota12Conceito(canc.clone());
					historicoVO.setNota12(historicoVO.getNota12Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota12Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota13PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota13().trim().isEmpty()) {
			historicoVO.setNota13(null);
			if (historicoVO.getNota13Conceito().getCodigo() == 0) {
				historicoVO.setNota13Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota13ConceitoVOs()) {
				if (historicoVO.getNota13Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota13Conceito(canc.clone());
					historicoVO.setNota13(historicoVO.getNota13Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota13Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota14PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota14().trim().isEmpty()) {
			historicoVO.setNota14(null);
			if (historicoVO.getNota14Conceito().getCodigo() == 0) {
				historicoVO.setNota14Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota14ConceitoVOs()) {
				if (historicoVO.getNota14Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota14Conceito(canc.clone());
					historicoVO.setNota14(historicoVO.getNota14Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota14Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota15PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota15().trim().isEmpty()) {
			historicoVO.setNota15(null);
			if (historicoVO.getNota15Conceito().getCodigo() == 0) {
				historicoVO.setNota15Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota15ConceitoVOs()) {
				if (historicoVO.getNota15Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota15Conceito(canc.clone());
					historicoVO.setNota15(historicoVO.getNota15Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota15Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota16PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota16().trim().isEmpty()) {
			historicoVO.setNota16(null);
			if (historicoVO.getNota16Conceito().getCodigo() == 0) {
				historicoVO.setNota16Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota16ConceitoVOs()) {
				if (historicoVO.getNota16Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota16Conceito(canc.clone());
					historicoVO.setNota16(historicoVO.getNota16Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota16Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota17PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota17().trim().isEmpty()) {
			historicoVO.setNota17(null);
			if (historicoVO.getNota17Conceito().getCodigo() == 0) {
				historicoVO.setNota17Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota17ConceitoVOs()) {
				if (historicoVO.getNota17Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota17Conceito(canc.clone());
					historicoVO.setNota17(historicoVO.getNota17Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota17Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota18PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota18().trim().isEmpty()) {
			historicoVO.setNota18(null);
			if (historicoVO.getNota18Conceito().getCodigo() == 0) {
				historicoVO.setNota18Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota18ConceitoVOs()) {
				if (historicoVO.getNota18Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota18Conceito(canc.clone());
					historicoVO.setNota18(historicoVO.getNota18Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota18Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota19PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota19().trim().isEmpty()) {
			historicoVO.setNota19(null);
			if (historicoVO.getNota19Conceito().getCodigo() == 0) {
				historicoVO.setNota19Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota19ConceitoVOs()) {
				if (historicoVO.getNota19Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota19Conceito(canc.clone());
					historicoVO.setNota19(historicoVO.getNota19Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota19Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota20PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota20().trim().isEmpty()) {
			historicoVO.setNota20(null);
			if (historicoVO.getNota20Conceito().getCodigo() == 0) {
				historicoVO.setNota20Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota20ConceitoVOs()) {
				if (historicoVO.getNota20Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota20Conceito(canc.clone());
					historicoVO.setNota20(historicoVO.getNota20Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota20Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota21PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota21().trim().isEmpty()) {
			historicoVO.setNota21(null);
			if (historicoVO.getNota21Conceito().getCodigo() == 0) {
				historicoVO.setNota21Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota21ConceitoVOs()) {
				if (historicoVO.getNota21Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota21Conceito(canc.clone());
					historicoVO.setNota21(historicoVO.getNota21Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota21Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota22PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota22().trim().isEmpty()) {
			historicoVO.setNota22(null);
			if (historicoVO.getNota22Conceito().getCodigo() == 0) {
				historicoVO.setNota22Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota22ConceitoVOs()) {
				if (historicoVO.getNota22Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota22Conceito(canc.clone());
					historicoVO.setNota22(historicoVO.getNota22Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota22Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota23PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota23().trim().isEmpty()) {
			historicoVO.setNota23(null);
			if (historicoVO.getNota23Conceito().getCodigo() == 0) {
				historicoVO.setNota23Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota23ConceitoVOs()) {
				if (historicoVO.getNota23Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota23Conceito(canc.clone());
					historicoVO.setNota23(historicoVO.getNota23Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota23Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota24PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota24().trim().isEmpty()) {
			historicoVO.setNota24(null);
			if (historicoVO.getNota24Conceito().getCodigo() == 0) {
				historicoVO.setNota24Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota24ConceitoVOs()) {
				if (historicoVO.getNota24Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota24Conceito(canc.clone());
					historicoVO.setNota24(historicoVO.getNota24Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota24Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota25PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota25().trim().isEmpty()) {
			historicoVO.setNota25(null);
			if (historicoVO.getNota25Conceito().getCodigo() == 0) {
				historicoVO.setNota25Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota25ConceitoVOs()) {
				if (historicoVO.getNota25Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota25Conceito(canc.clone());
					historicoVO.setNota25(historicoVO.getNota25Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota25Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota26PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota26().trim().isEmpty()) {
			historicoVO.setNota26(null);
			if (historicoVO.getNota26Conceito().getCodigo() == 0) {
				historicoVO.setNota26Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota26ConceitoVOs()) {
				if (historicoVO.getNota26Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota26Conceito(canc.clone());
					historicoVO.setNota26(historicoVO.getNota26Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota26Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota27PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota27().trim().isEmpty()) {
			historicoVO.setNota27(null);
			if (historicoVO.getNota27Conceito().getCodigo() == 0) {
				historicoVO.setNota27Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota27ConceitoVOs()) {
				if (historicoVO.getNota27Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota27Conceito(canc.clone());
					historicoVO.setNota27(historicoVO.getNota27Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota27Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota28PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota28().trim().isEmpty()) {
			historicoVO.setNota28(null);
			if (historicoVO.getNota28Conceito().getCodigo() == 0) {
				historicoVO.setNota28Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota28ConceitoVOs()) {
				if (historicoVO.getNota28Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota28Conceito(canc.clone());
					historicoVO.setNota28(historicoVO.getNota28Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota28Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota29PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota29().trim().isEmpty()) {
			historicoVO.setNota29(null);
			if (historicoVO.getNota29Conceito().getCodigo() == 0) {
				historicoVO.setNota29Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota29ConceitoVOs()) {
				if (historicoVO.getNota29Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota29Conceito(canc.clone());
					historicoVO.setNota29(historicoVO.getNota29Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota29Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota30PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota30().trim().isEmpty()) {
			historicoVO.setNota30(null);
			if (historicoVO.getNota30Conceito().getCodigo() == 0) {
				historicoVO.setNota30Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota30ConceitoVOs()) {
				if (historicoVO.getNota30Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota30Conceito(canc.clone());
					historicoVO.setNota30(historicoVO.getNota30Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota30Conceito(null);
		}

		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota31PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota31().trim().isEmpty()) {
			historicoVO.setNota31(null);
			if (historicoVO.getNota31Conceito().getCodigo() == 0) {
				historicoVO.setNota31Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota31ConceitoVOs()) {
				if (historicoVO.getNota31Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota31Conceito(canc.clone());
					historicoVO.setNota31(historicoVO.getNota31Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota31Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota32PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota32().trim().isEmpty()) {
			historicoVO.setNota32(null);
			if (historicoVO.getNota32Conceito().getCodigo() == 0) {
				historicoVO.setNota32Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota32ConceitoVOs()) {
				if (historicoVO.getNota32Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota32Conceito(canc.clone());
					historicoVO.setNota32(historicoVO.getNota32Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota32Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota33PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota33().trim().isEmpty()) {
			historicoVO.setNota33(null);
			if (historicoVO.getNota33Conceito().getCodigo() == 0) {
				historicoVO.setNota33Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota33ConceitoVOs()) {
				if (historicoVO.getNota33Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota33Conceito(canc.clone());
					historicoVO.setNota33(historicoVO.getNota33Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota33Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota34PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota34().trim().isEmpty()) {
			historicoVO.setNota34(null);
			if (historicoVO.getNota34Conceito().getCodigo() == 0) {
				historicoVO.setNota34Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota34ConceitoVOs()) {
				if (historicoVO.getNota34Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota34Conceito(canc.clone());
					historicoVO.setNota34(historicoVO.getNota34Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota34Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota35PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota35().trim().isEmpty()) {
			historicoVO.setNota35(null);
			if (historicoVO.getNota35Conceito().getCodigo() == 0) {
				historicoVO.setNota35Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota35ConceitoVOs()) {
				if (historicoVO.getNota35Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota35Conceito(canc.clone());
					historicoVO.setNota35(historicoVO.getNota35Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota35Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota36PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota36().trim().isEmpty()) {
			historicoVO.setNota36(null);
			if (historicoVO.getNota36Conceito().getCodigo() == 0) {
				historicoVO.setNota36Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota36ConceitoVOs()) {
				if (historicoVO.getNota36Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota36Conceito(canc.clone());
					historicoVO.setNota36(historicoVO.getNota36Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota36Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota37PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota37().trim().isEmpty()) {
			historicoVO.setNota37(null);
			if (historicoVO.getNota37Conceito().getCodigo() == 0) {
				historicoVO.setNota37Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota37ConceitoVOs()) {
				if (historicoVO.getNota37Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota37Conceito(canc.clone());
					historicoVO.setNota37(historicoVO.getNota37Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota37Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota38PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota38().trim().isEmpty()) {
			historicoVO.setNota38(null);
			if (historicoVO.getNota38Conceito().getCodigo() == 0) {
				historicoVO.setNota38Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota38ConceitoVOs()) {
				if (historicoVO.getNota38Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota38Conceito(canc.clone());
					historicoVO.setNota38(historicoVO.getNota38Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota38Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota39PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota39().trim().isEmpty()) {
			historicoVO.setNota39(null);
			if (historicoVO.getNota39Conceito().getCodigo() == 0) {
				historicoVO.setNota39Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota39ConceitoVOs()) {
				if (historicoVO.getNota39Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota39Conceito(canc.clone());
					historicoVO.setNota39(historicoVO.getNota39Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota39Conceito(null);
		}
		if (historicoVO.getConfiguracaoAcademico().getUtilizarNota40PorConceito() && historicoVO.getConfiguracaoAcademico().getFormulaCalculoNota40().trim().isEmpty()) {
			historicoVO.setNota40(null);
			if (historicoVO.getNota40Conceito().getCodigo() == 0) {
				historicoVO.setNota40Conceito(null);
			}
			for (ConfiguracaoAcademicoNotaConceitoVO canc : historicoVO.getConfiguracaoAcademico().getConfiguracaoAcademicoNota40ConceitoVOs()) {
				if (historicoVO.getNota40Conceito().getCodigo().equals(canc.getCodigo())) {
					historicoVO.setNota40Conceito(canc.clone());
					historicoVO.setNota40(historicoVO.getNota40Conceito().getFaixaNota2());
					break;
				}
			}
		} else {
			historicoVO.setNota40Conceito(null);
		}

		if (historicoVO.getNota1() != null && historicoVO.getConfiguracaoAcademico().getNota1TipoLancamento()) {
			historicoVO.setNota1Lancada(true);
		} else {
			historicoVO.setNota1(null);
			historicoVO.setNota1Lancada(false);
		}
		if (historicoVO.getNota2() != null && historicoVO.getConfiguracaoAcademico().getNota2TipoLancamento()) {
			historicoVO.setNota2Lancada(true);
		} else {
			historicoVO.setNota2(null);
			historicoVO.setNota2Lancada(false);
		}
		if (historicoVO.getNota3() != null && historicoVO.getConfiguracaoAcademico().getNota3TipoLancamento()) {
			historicoVO.setNota3Lancada(true);
		} else {
			historicoVO.setNota3(null);
			historicoVO.setNota3Lancada(false);
		}
		if (historicoVO.getNota4() != null && historicoVO.getConfiguracaoAcademico().getNota4TipoLancamento()) {
			historicoVO.setNota4Lancada(true);
		} else {
			historicoVO.setNota4(null);
			historicoVO.setNota4Lancada(false);
		}
		if (historicoVO.getNota5() != null && historicoVO.getConfiguracaoAcademico().getNota5TipoLancamento()) {
			historicoVO.setNota5Lancada(true);
		} else {
			historicoVO.setNota5(null);
			historicoVO.setNota5Lancada(false);
		}
		if (historicoVO.getNota6() != null && historicoVO.getConfiguracaoAcademico().getNota6TipoLancamento()) {
			historicoVO.setNota6Lancada(true);
		} else {
			historicoVO.setNota6(null);
			historicoVO.setNota6Lancada(false);
		}
		if (historicoVO.getNota7() != null && historicoVO.getConfiguracaoAcademico().getNota7TipoLancamento()) {
			historicoVO.setNota7Lancada(true);
		} else {
			historicoVO.setNota7(null);
			historicoVO.setNota7Lancada(false);
		}
		if (historicoVO.getNota8() != null && historicoVO.getConfiguracaoAcademico().getNota8TipoLancamento()) {
			historicoVO.setNota8Lancada(true);
		} else {
			historicoVO.setNota8(null);
			historicoVO.setNota8Lancada(false);
		}
		if (historicoVO.getNota9() != null && historicoVO.getConfiguracaoAcademico().getNota9TipoLancamento()) {
			historicoVO.setNota9Lancada(true);
		} else {
			historicoVO.setNota9(null);
			historicoVO.setNota9Lancada(false);
		}
		if (historicoVO.getNota10() != null && historicoVO.getConfiguracaoAcademico().getNota10TipoLancamento()) {
			historicoVO.setNota10Lancada(true);
		} else {
			historicoVO.setNota10(null);
			historicoVO.setNota10Lancada(false);
		}
		if (historicoVO.getNota11() != null && historicoVO.getConfiguracaoAcademico().getNota11TipoLancamento()) {
			historicoVO.setNota11Lancada(true);
		} else {
			historicoVO.setNota11(null);
			historicoVO.setNota11Lancada(false);
		}
		if (historicoVO.getNota12() != null && historicoVO.getConfiguracaoAcademico().getNota12TipoLancamento()) {
			historicoVO.setNota12Lancada(true);
		} else {
			historicoVO.setNota12(null);
			historicoVO.setNota12Lancada(false);
		}
		if (historicoVO.getNota13() != null && historicoVO.getConfiguracaoAcademico().getNota13TipoLancamento()) {
			historicoVO.setNota13Lancada(true);
		} else {
			historicoVO.setNota13(null);
			historicoVO.setNota13Lancada(false);
		}

		if (historicoVO.getNota14() != null && historicoVO.getConfiguracaoAcademico().getNota14TipoLancamento()) {
			historicoVO.setNota14Lancada(true);
		} else {
			historicoVO.setNota14(null);
			historicoVO.setNota14Lancada(false);
		}

		if (historicoVO.getNota15() != null && historicoVO.getConfiguracaoAcademico().getNota15TipoLancamento()) {
			historicoVO.setNota15Lancada(true);
		} else {
			historicoVO.setNota15(null);
			historicoVO.setNota15Lancada(false);
		}

		if (historicoVO.getNota16() != null && historicoVO.getConfiguracaoAcademico().getNota16TipoLancamento()) {
			historicoVO.setNota16Lancada(true);
		} else {
			historicoVO.setNota16(null);
			historicoVO.setNota16Lancada(false);
		}

		if (historicoVO.getNota17() != null && historicoVO.getConfiguracaoAcademico().getNota17TipoLancamento()) {
			historicoVO.setNota17Lancada(true);
		} else {
			historicoVO.setNota17(null);
			historicoVO.setNota17Lancada(false);
		}

		if (historicoVO.getNota18() != null && historicoVO.getConfiguracaoAcademico().getNota18TipoLancamento()) {
			historicoVO.setNota18Lancada(true);
		} else {
			historicoVO.setNota18(null);
			historicoVO.setNota18Lancada(false);
		}

		if (historicoVO.getNota19() != null && historicoVO.getConfiguracaoAcademico().getNota19TipoLancamento()) {
			historicoVO.setNota19Lancada(true);
		} else {
			historicoVO.setNota19(null);
			historicoVO.setNota19Lancada(false);
		}

		if (historicoVO.getNota20() != null && historicoVO.getConfiguracaoAcademico().getNota20TipoLancamento()) {
			historicoVO.setNota20Lancada(true);
		} else {
			historicoVO.setNota20(null);
			historicoVO.setNota20Lancada(false);
		}

		if (historicoVO.getNota21() != null && historicoVO.getConfiguracaoAcademico().getNota21TipoLancamento()) {
			historicoVO.setNota21Lancada(true);
		} else {
			historicoVO.setNota21(null);
			historicoVO.setNota21Lancada(false);
		}

		if (historicoVO.getNota22() != null && historicoVO.getConfiguracaoAcademico().getNota22TipoLancamento()) {
			historicoVO.setNota22Lancada(true);
		} else {
			historicoVO.setNota22(null);
			historicoVO.setNota22Lancada(false);
		}

		if (historicoVO.getNota23() != null && historicoVO.getConfiguracaoAcademico().getNota23TipoLancamento()) {
			historicoVO.setNota23Lancada(true);
		} else {
			historicoVO.setNota23(null);
			historicoVO.setNota23Lancada(false);
		}

		if (historicoVO.getNota24() != null && historicoVO.getConfiguracaoAcademico().getNota24TipoLancamento()) {
			historicoVO.setNota24Lancada(true);
		} else {
			historicoVO.setNota24(null);
			historicoVO.setNota24Lancada(false);
		}

		if (historicoVO.getNota25() != null && historicoVO.getConfiguracaoAcademico().getNota25TipoLancamento()) {
			historicoVO.setNota25Lancada(true);
		} else {
			historicoVO.setNota25(null);
			historicoVO.setNota25Lancada(false);
		}

		if (historicoVO.getNota26() != null && historicoVO.getConfiguracaoAcademico().getNota26TipoLancamento()) {
			historicoVO.setNota26Lancada(true);
		} else {
			historicoVO.setNota26(null);
			historicoVO.setNota26Lancada(false);
		}

		if (historicoVO.getNota27() != null && historicoVO.getConfiguracaoAcademico().getNota27TipoLancamento()) {
			historicoVO.setNota27Lancada(true);
		} else {
			historicoVO.setNota27(null);
			historicoVO.setNota27Lancada(false);
		}

		if (historicoVO.getNota28() != null && historicoVO.getConfiguracaoAcademico().getNota28TipoLancamento()) {
			historicoVO.setNota28Lancada(true);
		} else {
			historicoVO.setNota28(null);
			historicoVO.setNota28Lancada(false);
		}

		if (historicoVO.getNota29() != null && historicoVO.getConfiguracaoAcademico().getNota29TipoLancamento()) {
			historicoVO.setNota29Lancada(true);
		} else {
			historicoVO.setNota29(null);
			historicoVO.setNota29Lancada(false);
		}

		if (historicoVO.getNota30() != null && historicoVO.getConfiguracaoAcademico().getNota30TipoLancamento()) {
			historicoVO.setNota30Lancada(true);
		} else {
			historicoVO.setNota30(null);
			historicoVO.setNota30Lancada(false);
		}

		if (historicoVO.getNota31() != null && historicoVO.getConfiguracaoAcademico().getNota31TipoLancamento()) {
			historicoVO.setNota31Lancada(true);
		} else {
			historicoVO.setNota31(null);
			historicoVO.setNota31Lancada(false);
		}

		if (historicoVO.getNota32() != null && historicoVO.getConfiguracaoAcademico().getNota32TipoLancamento()) {
			historicoVO.setNota32Lancada(true);
		} else {
			historicoVO.setNota32(null);
			historicoVO.setNota32Lancada(false);
		}
		if (historicoVO.getNota33() != null && historicoVO.getConfiguracaoAcademico().getNota33TipoLancamento()) {
			historicoVO.setNota33Lancada(true);
		} else {
			historicoVO.setNota33(null);
			historicoVO.setNota33Lancada(false);
		}
		if (historicoVO.getNota34() != null && historicoVO.getConfiguracaoAcademico().getNota34TipoLancamento()) {
			historicoVO.setNota34Lancada(true);
		} else {
			historicoVO.setNota34(null);
			historicoVO.setNota34Lancada(false);
		}
		if (historicoVO.getNota35() != null && historicoVO.getConfiguracaoAcademico().getNota35TipoLancamento()) {
			historicoVO.setNota35Lancada(true);
		} else {
			historicoVO.setNota35(null);
			historicoVO.setNota35Lancada(false);
		}
		if (historicoVO.getNota36() != null && historicoVO.getConfiguracaoAcademico().getNota36TipoLancamento()) {
			historicoVO.setNota36Lancada(true);
		} else {
			historicoVO.setNota36(null);
			historicoVO.setNota36Lancada(false);
		}
		if (historicoVO.getNota37() != null && historicoVO.getConfiguracaoAcademico().getNota37TipoLancamento()) {
			historicoVO.setNota37Lancada(true);
		} else {
			historicoVO.setNota37(null);
			historicoVO.setNota37Lancada(false);
		}
		if (historicoVO.getNota38() != null && historicoVO.getConfiguracaoAcademico().getNota38TipoLancamento()) {
			historicoVO.setNota38Lancada(true);
		} else {
			historicoVO.setNota38(null);
			historicoVO.setNota38Lancada(false);
		}
		if (historicoVO.getNota39() != null && historicoVO.getConfiguracaoAcademico().getNota39TipoLancamento()) {
			historicoVO.setNota39Lancada(true);
		} else {
			historicoVO.setNota39(null);
			historicoVO.setNota39Lancada(false);
		}
		if (historicoVO.getNota40() != null && historicoVO.getConfiguracaoAcademico().getNota40TipoLancamento()) {
			historicoVO.setNota40Lancada(true);
		} else {
			historicoVO.setNota40(null);
			historicoVO.setNota40Lancada(false);
		}

	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterar(final HistoricoVO obj, UsuarioVO usuario) throws Exception {
		alterar(obj, "", usuario);
	}

	/**
	 * Operação responsável por alterar no BD os dados de um objeto da classe
	 * <code>HistoricoVO</code>. Sempre utiliza a chave primária da classe como
	 * atributo para localização do registro a ser alterado. Primeiramente
	 * valida os dados (<code>validarDados</code>) do objeto. Verifica a conexão
	 * com o banco de dados e a permissão do usuário para realizar esta operacão
	 * na entidade. Isto, através da operação <code>alterar</code> da
	 * superclasse.
	 *
	 * @param obj
	 *            Objeto da classe <code>HistoricoVO</code> que será alterada no
	 *            banco de dados.
	 * @exception Execption
	 *                Caso haja problemas de conexão, restrição de acesso ou
	 *                validação de dados.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterar(final HistoricoVO obj, String idEntidade, UsuarioVO usuario) throws Exception {
		final Date updated = new Date();
		try {
			HistoricoVO.validarDados(obj);
			if (idEntidade != null && !idEntidade.trim().isEmpty()) {
				Historico.alterar(idEntidade, usuario);
			}
			realizarCalculoCargaHorariaCursada(obj);
			final String sql = "UPDATE Historico set disciplina=?, matricula=?, tipoHistorico=?, situacao=?, freguencia=?, " + "responsavel=?, dataRegistro=?, "  // 7
					+ "nota1=?, nota2=?, nota3=?, nota4=?, nota5=?, nota6=?, nota7=?, " + "nota8=?, nota9=?, nota10=?, nota11=?, nota12=?, nota13=?, matriculaPeriodo=?, "  // 21
					+ "matriculaPeriodoTurmaDisciplina=?, mediaFinal=?, transferenciaEntradaDisciplinasAproveitadas=?, disciplinasAproveitadas=?, configuracaoAcademico=?, nota1Lancada=?, " // 27
					+ "nota2Lancada=?, nota3Lancada=?, nota4Lancada=?, " // 30
					+ "nota5Lancada=?, nota6Lancada=?, nota7Lancada=?, nota8Lancada=?, nota9Lancada=?, nota10Lancada=?, nota11Lancada=?, nota12Lancada=?, " //38
					+ "nota13Lancada=?, updated=?, historicoDisciplinaFazParteComposicao=?, instituicao=?, " //42
					+ "nota1Conceito =?, nota2Conceito=?, nota3Conceito=?, nota4Conceito=?, nota5Conceito=?, nota6Conceito=?, " // 48
					+ "nota7Conceito=?, nota8Conceito=?, nota9Conceito=?, nota10Conceito=?, nota11Conceito=?, nota12Conceito=?, nota13Conceito=?, mediaFinalConceito=?, notificarSolicitacaoReposicao=?, " // 57
					+ "anoHistorico = ?, semestreHistorico = ?, cargaHorariaAproveitamentoDisciplina = ?, cidade = ?, " + "nota14=?, nota14lancada=?, nota14conceito=?, nota15=?, nota15lancada=?, " // 66
					+ "nota15conceito=?, nota16=?, nota16lancada=?, nota16conceito=?, nota17=?, nota17lancada=?, nota17conceito=?,  " + "nota18=?, nota18lancada=?, nota18conceito=?, nota19=?, " // 77
					+ "nota19lancada=?, nota19conceito=?, nota20=?, nota20lancada=?, nota20conceito=?, nota21=?, nota21lancada=?, nota21conceito=?,  nota22=?, nota22lancada=?, nota22conceito=?, " // 88
					+ "nota23=?, nota23lancada=?, nota23conceito=?, nota24=?, nota24lancada=?, nota24conceito=?, nota25=?, nota25lancada=?, nota25conceito=?,  nota26=?, nota26lancada=?, nota26conceito=?, " // 100
					+ "nota27=?, nota27lancada=?, nota27conceito=?, nota28=?, nota28lancada=?, nota28conceito=?, nota29=?, nota29lancada=?, nota29conceito=?,  nota30=?, nota30lancada=?, nota30conceito = ?, " // 112
					+ "cargahorariacursada = ?, isentarMediaFinal=?, utilizaNotaFinalConceito = ?, notaFinalConceito = ?, observacao=?, historicoDisciplinaAtividadeComplementar=?, cargaHorariaDisciplina=?, " // 119
					+ "creditoDisciplina=?, historicoDisciplinaOptativa=?, historicoDisciplinaForaGrade=?, nomeDisciplina=?, historicoDisciplinaAproveitada=?, historicoPorEquivalencia=?, " // 125
					+ "historicoEquivalente=?, faltaPrimeiroBimestre=?, faltaSegundoBimestre=?, faltaTerceiroBimestre=?, faltaQuartoBimestre=?, totalFalta=?, periodoLetivoMatrizCurricular=?, " // 132
					+ "matrizCurricular=?, periodoLetivoCursada=?, " + "gradeCurricularGrupoOptativaDisciplina=?, gradeDisciplinaComposta=?, historicoDisciplinaComposta=?, mapaEquivalenciaDisciplina=?, " // 138
					+ "mapaEquivalenciaDisciplinaCursada=?, mapaEquivalenciaDisciplinaMatrizCurricular=?, historicoCriterioAvaliacaoAluno=?, criterioAvaliacao=?, disciplinaReferenteAUmGrupoOptativa=?, " // 143
					+ "gradeDisciplina=?, transferenciaMatrizCurricularMatricula=?, historicoGeradoAPartirTransferenciaMatrizCurricular=?, observacaoTransferenciaMatrizCurricular=?, "  // 147
					+ "historicoCursandoPorCorrespondenciaAposTransferencia=?, frequenciaTeorica=?, frequenciaPratica=?, "	// 150
					+ "nota31=?, nota31Lancada=?, nota31Conceito=?, " // 153
					+ "nota32=?, nota32Lancada=?, nota32Conceito=?, " // 156
					+ "nota33=?, nota33Lancada=?, nota33Conceito=?, " // 159
					+ "nota34=?, nota34Lancada=?, nota34Conceito=?, " // 162
					+ "nota35=?, nota35Lancada=?, nota35Conceito=?, " // 165
					+ "nota36=?, nota36Lancada=?, nota36Conceito=?, " // 168
					+ "nota37=?, nota37Lancada=?, nota37Conceito=?, " // 171
					+ "nota38=?, nota38Lancada=?, nota38Conceito=?, " // 174
					+ "nota39=?, nota39Lancada=?, nota39Conceito=?, " // 177
					+ "nota40=?, nota40Lancada=?, nota40Conceito=?, apresentarAprovadoHistorico=?, dataInicioAula=?, dataFimAula=? "  // 180

					+ "WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);

				getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

					public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
						PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
						int i = 0;
						sqlAlterar.setInt(++i, obj.getDisciplina().getCodigo().intValue());
						sqlAlterar.setString(++i, obj.getMatricula().getMatricula());
						sqlAlterar.setString(++i, obj.getTipoHistorico());
						sqlAlterar.setString(++i, obj.getSituacao());
						sqlAlterar.setDouble(++i, obj.getFreguencia().doubleValue());
						if (obj.getResponsavel().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getResponsavel().getCodigo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataRegistro()));

						if (obj.getNota1() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota1().doubleValue());
						}
						if (obj.getNota2() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota2().doubleValue());
						}
						if (obj.getNota3() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota3().doubleValue());
						}
						// /////////// 10 //////////////
						if (obj.getNota4() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota4().doubleValue());

						}
						if (obj.getNota5() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota5().doubleValue());

						}
						if (obj.getNota6() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota6().doubleValue());
						}
						if (obj.getNota7() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {

							sqlAlterar.setDouble(++i, obj.getNota7().doubleValue());

						}
						if (obj.getNota8() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota8().doubleValue());

						}
						if (obj.getNota9() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota9().doubleValue());

						}
						if (obj.getNota10() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota10().doubleValue());

						}
						if (obj.getNota11() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota11().doubleValue());

						}
						if (obj.getNota12() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota12().doubleValue());

						}
						if (obj.getNota13() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota13().doubleValue());

						}
						// /////////// 20 //////////////
						sqlAlterar.setInt(++i, obj.getMatriculaPeriodo().getCodigo().intValue());
						if (obj.getMatriculaPeriodoTurmaDisciplina().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getMatriculaPeriodoTurmaDisciplina().getCodigo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getMediaFinal() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getMediaFinal().doubleValue());

						}
						if (obj.getTransferenciaEntradaDisciplinasAproveitadas().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getTransferenciaEntradaDisciplinasAproveitadas().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getDisciplinasAproveitadas().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getDisciplinasAproveitadas().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getConfiguracaoAcademico().getCodigo().intValue() != 0) {
							sqlAlterar.setInt(++i, obj.getConfiguracaoAcademico().getCodigo().intValue());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setBoolean(++i, obj.getNota1Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota2Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota3Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota4Lancada());
						// ////////////// 30 /////////////////
						sqlAlterar.setBoolean(++i, obj.getNota5Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota6Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota7Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota8Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota9Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota10Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota11Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota12Lancada());
						sqlAlterar.setBoolean(++i, obj.getNota13Lancada());
						sqlAlterar.setTimestamp(++i, Uteis.getDataJDBCTimestamp(updated));
						// ///////////// 40 //////////////////
						sqlAlterar.setBoolean(++i, obj.getHistoricoDisciplinaFazParteComposicao());
						sqlAlterar.setString(++i, obj.getInstituicao());
						if (obj.getNota1Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota1Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota2Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota2Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota3Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota3Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota4Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota4Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota5Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota5Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota6Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota6Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota7Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota7Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota8Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota8Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// //////////// 50 /////////////////
						if (obj.getNota9Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota9Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota10Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota10Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota11Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota11Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota12Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota12Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getNota13Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota13Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getMediaFinalConceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getMediaFinalConceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setBoolean(++i, obj.getNotificarSolicitacaoReposicao());
						sqlAlterar.setString(++i, obj.getAnoHistorico());
						sqlAlterar.setString(++i, obj.getSemestreHistorico());
						sqlAlterar.setInt(++i, obj.getCargaHorariaAproveitamentoDisciplina().intValue());
						// ///////////// 60 /////////////
						if (obj.getCidadeVO().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getCidadeVO().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						// ******* NOTA 14 *****
						if (obj.getNota14() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota14().doubleValue());

						}
						sqlAlterar.setBoolean(++i, obj.getNota14Lancada());
						if (obj.getNota14Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota14Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 15 *****
						if (obj.getNota15() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota15().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota15Lancada());
						if (obj.getNota15Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota15Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 16 *****
						if (obj.getNota16() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota16().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota16Lancada());
						if (obj.getNota16Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota16Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// /////////////// 70 //////////////////
						// *********************
						// ******* NOTA 17 *****
						if (obj.getNota17() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota17().doubleValue());

						}
						sqlAlterar.setBoolean(++i, obj.getNota17Lancada());
						if (obj.getNota17Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota17Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 18 *****
						if (obj.getNota18() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {

							sqlAlterar.setDouble(++i, obj.getNota18().doubleValue());

						}
						sqlAlterar.setBoolean(++i, obj.getNota18Lancada());
						if (obj.getNota18Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota18Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 19 *****
						if (obj.getNota19() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {

							sqlAlterar.setDouble(++i, obj.getNota19().doubleValue());

						}
						sqlAlterar.setBoolean(++i, obj.getNota19Lancada());
						if (obj.getNota19Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota19Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 20 *****
						if (obj.getNota20() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {

							sqlAlterar.setDouble(++i, obj.getNota20().doubleValue());

						}
						// ///////////// 80 ////////////////
						sqlAlterar.setBoolean(++i, obj.getNota20Lancada());
						if (obj.getNota20Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota20Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 21 *****
						if (obj.getNota21() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota21().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota21Lancada());
						if (obj.getNota21Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota21Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 22 *****
						if (obj.getNota22() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota22().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota22Lancada());
						if (obj.getNota22Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota22Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 23 *****
						if (obj.getNota23() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota23().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota23Lancada());
						// ///////////// 90 //////////////
						if (obj.getNota23Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota23Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 24 *****
						if (obj.getNota24() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota24().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota24Lancada());
						if (obj.getNota24Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota24Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 25 *****
						if (obj.getNota25() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {

							sqlAlterar.setDouble(++i, obj.getNota25().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota25Lancada());
						if (obj.getNota25Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota25Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 26 *****
						if (obj.getNota26() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota26().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota26Lancada());
						if (obj.getNota26Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota26Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// /////////////// 100 ///////////////
						// *********************
						// ******* NOTA 27 *****
						if (obj.getNota27() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota27().doubleValue());

						}
						sqlAlterar.setBoolean(++i, obj.getNota27Lancada());
						if (obj.getNota27Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota27Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 28 *****
						if (obj.getNota28() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota28().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota28Lancada());
						if (obj.getNota28Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota28Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 29 *****
						if (obj.getNota29() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota29().doubleValue());

						}
						sqlAlterar.setBoolean(++i, obj.getNota29Lancada());
						if (obj.getNota29Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota29Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************
						// ******* NOTA 30 *****
						if (obj.getNota30() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota30().doubleValue());
						}
						// /////////////// 110 //////////////
						sqlAlterar.setBoolean(++i, obj.getNota30Lancada());
						if (obj.getNota30Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota30Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// *********************

						sqlAlterar.setInt(++i, obj.getCargaHorariaCursada().intValue());
						sqlAlterar.setBoolean(++i, obj.getIsentarMediaFinal());
						sqlAlterar.setBoolean(++i, obj.getUtilizaNotaFinalConceito());
						sqlAlterar.setString(++i, obj.getNotaFinalConceito());
						sqlAlterar.setString(++i, obj.getObservacao());
						sqlAlterar.setBoolean(++i, obj.getHistoricoDisciplinaAtividadeComplementar().booleanValue());
						sqlAlterar.setInt(++i, obj.getCargaHorariaDisciplina());
						sqlAlterar.setInt(++i, obj.getCreditoDisciplina());
						/////////////// 120 /////////////
						sqlAlterar.setBoolean(++i, obj.getHistoricoDisciplinaOptativa().booleanValue());
						sqlAlterar.setBoolean(++i, obj.getHistoricoDisciplinaForaGrade().booleanValue());
						sqlAlterar.setString(++i, obj.getNomeDisciplina());
						sqlAlterar.setBoolean(++i, obj.getHistoricoDisciplinaAproveitada().booleanValue());
						sqlAlterar.setBoolean(++i, obj.getHistoricoPorEquivalencia().booleanValue());
						sqlAlterar.setBoolean(++i, obj.getHistoricoEquivalente().booleanValue());
						sqlAlterar.setInt(++i, obj.getFaltaPrimeiroBimestre());
						sqlAlterar.setInt(++i, obj.getFaltaSegundoBimestre());
						sqlAlterar.setInt(++i, obj.getFaltaTerceiroBimestre());
						sqlAlterar.setInt(++i, obj.getFaltaQuartoBimestre());
						 /////////////// 130 ///////////
						sqlAlterar.setInt(++i, obj.getTotalFalta());

						if (obj.getPeriodoLetivoMatrizCurricular().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getPeriodoLetivoMatrizCurricular().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getMatrizCurricular().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getMatrizCurricular().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getPeriodoLetivoCursada().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getPeriodoLetivoCursada().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						// sqlAlterar.setBoolean(++i,
						// obj.getUtilizaNotaFinalConceito().booleanValue());
						// sqlAlterar.setString(++i,
						// obj.getNotaFinalConceito());
						if (obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getGradeDisciplinaComposta().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getGradeDisciplinaComposta().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						sqlAlterar.setBoolean(++i, obj.getHistoricoDisciplinaComposta());
						if (obj.getMapaEquivalenciaDisciplina().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getMapaEquivalenciaDisciplina().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getMapaEquivalenciaDisciplinaCursada().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getMapaEquivalenciaDisciplinaCursada().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						if (obj.getMapaEquivalenciaDisciplinaMatrizCurricular().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getMapaEquivalenciaDisciplinaMatrizCurricular().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						/////////////  140 ///////////
						sqlAlterar.setBoolean(++i, obj.getHistoricoCriterioAvaliacaoAluno());
						if (obj.getCriterioAvaliacao().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getCriterioAvaliacao().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						sqlAlterar.setBoolean(++i, obj.getDisciplinaReferenteAUmGrupoOptativa());
						if (obj.getGradeDisciplinaVO().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getGradeDisciplinaVO().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						// INICIO: atributos de referencia a trasnferencia de
						// matriz curricular
						if (obj.getTransferenciaMatrizCurricularMatricula().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getTransferenciaMatrizCurricularMatricula().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setBoolean(++i, obj.getHistoricoGeradoAPartirTransferenciaMatrizCurricular());
						sqlAlterar.setString(++i, obj.getObservacaoTransferenciaMatrizCurricular());
						sqlAlterar.setBoolean(++i, obj.getHistoricoCursandoPorCorrespondenciaAposTransferencia());
						// FIM: atributos de referencia a trasnferencia de
						// matriz curricular
						sqlAlterar.setDouble(++i, obj.getFrequenciaTeorica());
						sqlAlterar.setDouble(++i, obj.getFrequenciaPratica());
						///////// 150 /////////
//						A PARTIR NOTA 31
						if (obj.getNota31() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota31().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota31Lancada());
						if (obj.getNota31Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota31Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						if (obj.getNota32() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota32().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota32Lancada());
						if (obj.getNota32Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota32Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						if (obj.getNota33() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota33().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota33Lancada());
						if (obj.getNota33Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota33Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						if (obj.getNota34() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota34().doubleValue());
						}
						/////////// 160 //////////
						sqlAlterar.setBoolean(++i, obj.getNota34Lancada());
						if (obj.getNota34Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota34Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						if (obj.getNota35() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota35().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota35Lancada());
						if (obj.getNota35Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota35Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						if (obj.getNota36() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota36().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota36Lancada());
						if (obj.getNota36Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota36Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						if (obj.getNota37() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota37().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota37Lancada());
						/////////// 170 /////////
						if (obj.getNota37Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota37Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						if (obj.getNota38() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota38().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota38Lancada());
						if (obj.getNota38Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota38Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						if (obj.getNota39() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota39().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota39Lancada());
						if (obj.getNota39Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota39Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}

						if (obj.getNota40() == null) {
							sqlAlterar.setNull(++i, 0);
						} else {
							sqlAlterar.setDouble(++i, obj.getNota40().doubleValue());
						}
						sqlAlterar.setBoolean(++i, obj.getNota40Lancada());
						if (obj.getNota40Conceito().getCodigo() > 0) {
							sqlAlterar.setInt(++i, obj.getNota40Conceito().getCodigo());
						} else {
							sqlAlterar.setNull(++i, 0);
						}
						sqlAlterar.setBoolean(++i, obj.getApresentarAprovadoHistorico());
						sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataInicioAula()));
						sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataFimAula()));

						////////// 180 /////////
						sqlAlterar.setInt(++i, obj.getCodigo().intValue());

						return sqlAlterar;
					}
				});
				veriricarHistoricoEnvolvidoMapaEquivalenciaDefinindoDadosHistoricoDisciplinasCursadasPorEquivalencia(obj, false, usuario);
				verificarHistoricoEnvolvidoTransferenciaMatrizCurricularComoHistoricoCorrespondente(obj, false, usuario);


		} catch (Exception e) {
			obj.setNovoObj(Boolean.TRUE);
			throw e;
		}
	}

	public void atualizarDadosHistoricoMapaEquivalenciaConsiderandoSituacaoMapa(HistoricoVO historicoAtualizar, MapaEquivalenciaDisciplinaVO mapaEquivalencia, MapaEquivalenciaDisciplinaMatrizCurricularVO disciplinaMatriz, String anoResolucaoMapa, String semestreResolucaoMapa) throws Exception {
		historicoAtualizar.setHistoricoDisciplinaComposta(Boolean.FALSE);
		historicoAtualizar.setHistoricoDisciplinaFazParteComposicao(Boolean.FALSE);
		historicoAtualizar.setGradeDisciplinaComposta(null);
		historicoAtualizar.setHistoricoDisciplinaForaGrade(Boolean.FALSE);
		historicoAtualizar.setHistoricoPorEquivalencia(Boolean.TRUE);
		historicoAtualizar.setHistoricoEquivalente(Boolean.FALSE);
		historicoAtualizar.setMapaEquivalenciaDisciplinaCursada(null);
		historicoAtualizar.setMapaEquivalenciaDisciplina(mapaEquivalencia);
		historicoAtualizar.setMapaEquivalenciaDisciplinaMatrizCurricular(disciplinaMatriz);
		if (mapaEquivalencia.getMapaCumpridoPeloAluno()) {
			// dados de fechamento academico do historico
			if (mapaEquivalencia.getMapaEquivalenciaDisciplinaCursadaVOs().size() == 1) {
				// se neste mapa, temos somente uma disciplina que o aluno tem
				// cursar, para cumpri-lo
				// entao vamos adotar a situacao deste histórico para refletir a
				// situação dos
				// historicos da matriz. Isto é necessário, pois muitas vezes, a
				// equivalencia é 1:1 ou 1:N
				// e na disciplina cursada, foi definido a situação CC (credito
				// concedido) logo, na
				// disciplina da matriz, tambem temos que levar esta situacao
				// CC, caso contrario,
				// o sistema tentará enferir uma média final para estas
				// disciplinas, sendo que a disciplina
				// origem não media, pois foi Credito concedido, ou Isenta, ou
				// Carga horaria concedida
				MapaEquivalenciaDisciplinaCursadaVO disciplinaCursada = mapaEquivalencia.getMapaEquivalenciaDisciplinaCursadaVOs().get(0);
				historicoAtualizar.setSituacao(disciplinaCursada.getHistorico().getSituacao());
			} else {
				if (mapaEquivalencia.getVerificarExistenciaDiscilinaReprovada() && !mapaEquivalencia.getVerificarDiscilinaEquivalenteReprovada()) {
					historicoAtualizar.setSituacao(SituacaoHistorico.CURSANDO_POR_EQUIVALENCIA.getValor());
				}else if(mapaEquivalencia.getVerificarDiscilinaEquivalenteReprovada()) {
					historicoAtualizar.setSituacao(SituacaoHistorico.REPROVADO.getValor());
				}
				else {
					historicoAtualizar.setSituacao(SituacaoHistorico.APROVADO_POR_EQUIVALENCIA.getValor());
				}
			}
			historicoAtualizar.setMediaFinal(mapaEquivalencia.getMediaFinalMapaEquivalenciaCumpridoPeloAluno(disciplinaMatriz));
			historicoAtualizar.setFreguencia(mapaEquivalencia.getFrequenciaMapaEquivalenciaCumpridoPeloAluno(disciplinaMatriz));
			if(Uteis.isAtributoPreenchido(disciplinaMatriz.getHistorico().getCodigo())){
				historicoAtualizar.setCargaHorariaDisciplina(mapaEquivalencia.getCargaHorariaMapaEquivalenciaCumpridoPeloAluno(disciplinaMatriz));
				historicoAtualizar.setCargaHorariaCursada(historicoAtualizar.getCargaHorariaDisciplina());
				historicoAtualizar.setCreditoDisciplina(mapaEquivalencia.getCreditosMapaEquivalenciaCumpridoPeloAluno(disciplinaMatriz));
			}
			historicoAtualizar.setPeriodoLetivoCursada(mapaEquivalencia.getPeriodoLetivoCursadoMapaEquivalenciaCumpridoPeloAluno(disciplinaMatriz));

			historicoAtualizar.setAnoHistorico(mapaEquivalencia.getAnoMapaEquivalenciaCumpridoPeloAluno(disciplinaMatriz, anoResolucaoMapa));
			historicoAtualizar.setSemestreHistorico(mapaEquivalencia.getSemestreMapaEquivalenciaCumpridoPeloAluno(disciplinaMatriz, semestreResolucaoMapa));
			if (mapaEquivalencia.getEquivalenciaPorIsencao()) {
				historicoAtualizar.setIsentarMediaFinal(Boolean.TRUE);
			}
		} else {
			historicoAtualizar.setMediaFinal(null);
			historicoAtualizar.setFreguencia(null);
			historicoAtualizar.setSituacao(SituacaoHistorico.CURSANDO_POR_EQUIVALENCIA.getValor());
		}
	}

	/**
	 * Método responsável por verificar se o histórico em questão esta sendo
	 * cursado por correspondencia, em decorrencia de alguma transferencia de
	 * matriz curricular. Isto signigica que o histórico em questão está sendo
	 * cursado pelo aluno em uma gradeAntiga (anterior a transferencia) pois a
	 * disciplina deste histórico também existe de forma identica na novaGrade,
	 * contudo, no momento da trasnferencia o aluno ainda estava cursando a
	 * mesma. Assim, não era possível fazer o aproveitamente academico da mesma.
	 * Por isto, este método verifica se o histórico em questão, está sendo
	 * gravado como uma situação final, e reflete esta situação no histórico
	 * correspodnente na nova grade (grade aluno migrado). Este método não é
	 * chamado no incluir, pois o historico com a situacao
	 * CURSANDO_POR_CORRESPONDENCIA é gerado pela própria transferencia de
	 * matriz curricular
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void verificarHistoricoEnvolvidoTransferenciaMatrizCurricularComoHistoricoCorrespondente(final HistoricoVO obj, Boolean sendoExcluido, UsuarioVO usuario) throws Exception {
		// primeiro passo é verificar se a disciplina faz parte de alguma mapa
		// de equivalencia
		if ((!obj.getTransferenciaMatrizCurricularMatricula().getCodigo().equals(0)) && (obj.getHistoricoCursandoPorCorrespondenciaAposTransferencia())) {
			// Se entrarmos aqui é por que o histórico está sendo cursando por
			// correspondencia apos
			// a transferencia. E nos temos um vinculo do mesmo com a
			// trasnferencia. Assim, iremos
			// agora verificar se o histórico passado como parametro está com
			// uma situação final
			// definida (APROVADO OU REPROVADO OU ainda está sendo removido).
			if (sendoExcluido) {
				// obter histórico corresponde e excluir o mesmo para refletir a
				// exclusão do histórico correspondente
				// na grade origem
						///////// COMENTADO NO DIA 07/03/2017 A PEDIDO DO EDIGAR DINIZ ///////////
						///////// DEVIDO O FATO DO MÉTODO SÓ SER CHAMADO NO MÉTODIO ALTERAR DO HISTÓRICO E SEMPRE SER PASSADO FALSO COMO PARÂMETRO /////////

//						Integer codigoMatrizAtualAluno = obj.getMatricula().getGradeCurricularAtual().getCodigo();
//						HistoricoVO historicoAtualizar = consultaRapidaPorTransferenciaMatrizCurricularMatricula(obj.getMatricula().getMatricula(), codigoMatrizAtualAluno, obj.getTransferenciaMatrizCurricularMatricula().getCodigo(), obj.getDisciplina().getCodigo(), obj.getCargaHorariaDisciplina(), false, usuario);
//						if (Uteis.isAtributoPreenchido(historicoAtualizar) && historicoAtualizar.getSituacao().equals(SituacaoHistorico.CURSANDO_POR_CORRESPONDENCIA.getValor())) {
//							// so excluir na gradedestino se a situacao for cursando
//							// ainda. Caso alguma situacao de aprovacao
//							// ou similar tenha sido lancado para o aluno na grade
//							// destino nao fazemos nada.
//							excluir(historicoAtualizar, false, usuario);
//						}
			} else {
				if (obj.getAprovado() || obj.getReprovado()) {
					// obter historico correspondente e refletir situacao
					// historcio atual
					// no mesmo.
					MatriculaVO matricula = getFacadeFactory().getMatriculaFacade().consultaRapidaPorMatriculaUnica(obj.getMatricula().getMatricula(), 0, false, "", usuario);
					Integer codigoMatrizAtualAluno = matricula.getGradeCurricularAtual().getCodigo();
					if(!obj.getMatrizCurricular().getCodigo().equals(codigoMatrizAtualAluno)) {
					HistoricoVO historicoAtualizar = consultaRapidaPorTransferenciaMatrizCurricularMatricula(obj.getMatricula().getMatricula(), codigoMatrizAtualAluno, obj.getTransferenciaMatrizCurricularMatricula().getCodigo(), obj.getDisciplina().getCodigo(), obj.getCargaHorariaDisciplina(), false, usuario);
					if (historicoAtualizar == null) {
						throw new Exception("O histórico da matrícula " + obj.getMatricula().getMatricula() + " disciplina " + obj.getDisciplina().getCodigo() + " - " + obj.getDisciplina().getNome() + " está sendo cursado por correspondência, em função de uma transferência de Matriz curricular." + "Contudo, não foi possível obter o histórico correspodente na nova matriz curricular do aluno de código " + codigoMatrizAtualAluno + ".");
					}

					// iremos migrar as notas parciais do aluno na disciplina origem, pois isto é muito importante no
					// caso de disciplinas filhas de composicao. Pois as notas parciais tambem podem ser utilizadas para
					// definir a nota final da mae
					migrarNotasEDadosAcademicosEntreHistoricos(obj, historicoAtualizar);

					historicoAtualizar.setSituacao(obj.getSituacao());
					historicoAtualizar.setMediaFinal(obj.getMediaFinal());
					historicoAtualizar.setMediaFinalConceito(obj.getMediaFinalConceito());
					historicoAtualizar.setMediaFinalTexto(obj.getMediaFinalTexto());
					historicoAtualizar.setFreguencia(obj.getFreguencia());

					alterar(historicoAtualizar, usuario);

					// Se este historico que foi atualizado acima (pois estava sendo cursado por equivalencia) trata-se de uma filha de uma composicao.
					// Entao temos uma tarefa adicional que é propagar esta atualização para a disciplina mãe da composicao. Pois, ao gravar uma disciplina
					// filha, isto poderá ter impactos diretos na disciplina mae.
					if (historicoAtualizar.getHistoricoDisciplinaFazParteComposicao()) {
						executarAtualizacaoDisciplinaComposta(historicoAtualizar, null, TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, true, false, usuario);
					}
					}
				}
			}
		}
	}

	public HistoricoVO consultaRapidaPorTransferenciaMatrizCurricularMatricula(String matricula, Integer codigoMatriz, Integer codigoTrasnferenciaMatriz, Integer disciplina, Integer cargaHoraria, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (matricula.matricula = '").append(matricula).append("') ");
		sqlStr.append(" AND (historico.matrizCurricular = ").append(codigoMatriz).append(") ");
		sqlStr.append(" AND (historico.transferenciaMatrizCurricularMatricula = ").append(codigoTrasnferenciaMatriz).append(") ");
		sqlStr.append(" AND (historico.disciplina = ").append(disciplina).append(") ");
		sqlStr.append(" AND (historico.cargaHorariaDisciplina = ").append(cargaHoraria).append(") ");
		sqlStr.append(" ORDER BY historico.codigo desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO historicoVO = new HistoricoVO();
		montarDadosCompleto(historicoVO, tabelaResultado, usuario);
		return historicoVO;
	}

	/**
	 * Método responsável por avaliar se um histórico está envolvido em
	 * MapaEquivalenciaDisciplia. SE ESTIVER então o mesmo precisa fazer as
	 * seguintes avaliações / inferências. a) Se o histórico em questão estiver
	 * aprovado, então temos que avaliar se o fato do mesmo estar sendo gravado
	 * como alterado, não irá implicar na resolução de seu mapa de equivalencia.
	 * Ou seja, ele era o último histórico que estava pendente das disciplinas a
	 * serem cursadas pelo aluno. Desta maneira, é necessário fazer com que os
	 * históricos das disciplinas cursadas por equivalencia sejam todos
	 * registrados como aprovado por equivalencia. Aplicando as regras definidas
	 * no mapa de equivalencia. b) Se o histórico em questão estiver como NÃO
	 * aprovado (seja qual for a situação) temos que verificar se o Mapa de
	 * Equivalencia ao qual o mesmo pertence está gravado como um Mapa
	 * Finalizado (ou seja o aluno está com as disciplinas cursadas por
	 * equivalencia definidas como APROVADAS POR EQUIVALENCIA). Neste caso,
	 * temos que voltar estas disciplinas para a situação CURSANDO POR
	 * EQUIVALENCIA, pois um dos históricos do mapa que estava como aprovado,
	 * acaba de ser alterado para uma situação diferente desta.
	 *
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void veriricarHistoricoEnvolvidoMapaEquivalenciaDefinindoDadosHistoricoDisciplinasCursadasPorEquivalencia(final HistoricoVO obj, boolean incluindoHistoricoEquivalente, UsuarioVO usuario) throws Exception {
		// primeiro passo é verificar se a disciplina faz parte de alguma mapa
		// de equivalencia
		if ((!obj.getHistoricoEquivalente()) || (obj.getMapaEquivalenciaDisciplina().getCodigo().equals(0))) {
			return;
		}

		MapaEquivalenciaDisciplinaVO mapaEquivalencia = getFacadeFactory().getMapaEquivalenciaDisciplinaFacade().consultarPorChavePrimaria(obj.getMapaEquivalenciaDisciplina().getCodigo(), NivelMontarDados.TODOS);
		getFacadeFactory().getMapaEquivalenciaDisciplinaFacade().carregarHistoricosMapaEquivalenciaParaAvaliacaoEResolucao(obj.getMatricula().getMatricula(), obj.getMatrizCurricular().getCodigo(), mapaEquivalencia, obj.getNumeroAgrupamentoEquivalenciaDisciplina(), incluindoHistoricoEquivalente ? obj.getCodigo() : 0, usuario);
		Integer numeroAgrupamentoEquivalenciaDisciplina = obj.getNumeroAgrupamentoEquivalenciaDisciplina();

		Boolean desistiuEquivalencia = verificarHistoricoDisciplinaMatrizCurrciularRealizouDesistenciaEquivalencia(mapaEquivalencia, usuario);
		if (desistiuEquivalencia) {
			for (MapaEquivalenciaDisciplinaMatrizCurricularVO mapaEquivalenciaMatrizCurricularVO : mapaEquivalencia.getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {
				alterarSituacaoHistoricoPorCodigo(mapaEquivalenciaMatrizCurricularVO.getHistorico().getCodigo(), SituacaoHistorico.REPROVADO.getValor(), usuario);
			}
		}
        if((incluindoHistoricoEquivalente && mapaEquivalencia.getMapaCumpridoPeloAluno()) || desistiuEquivalencia){
			numeroAgrupamentoEquivalenciaDisciplina++;
			obj.setNumeroAgrupamentoEquivalenciaDisciplina(numeroAgrupamentoEquivalenciaDisciplina);
			alterarNumeroAgrupamentoEquivalenciaDisciplina(obj);
			for (MapaEquivalenciaDisciplinaMatrizCurricularVO disciplinaMatriz : mapaEquivalencia.getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {
				disciplinaMatriz.setHistorico(null);
			}
			for (MapaEquivalenciaDisciplinaCursadaVO cursada : mapaEquivalencia.getMapaEquivalenciaDisciplinaCursadaVOs()) {
				cursada.setHistorico(null);
			}
		}
		// atualizar o mapa de acordo com o historico que acabou de ser gravado.
		for (MapaEquivalenciaDisciplinaCursadaVO cursada : mapaEquivalencia.getMapaEquivalenciaDisciplinaCursadaVOs()) {
			if ((cursada.getDisciplinaVO().getCodigo().equals(obj.getDisciplina().getCodigo()))
					&& ((cursada.getCargaHoraria().equals(obj.getCargaHorariaDisciplina())) || obj.getHistoricoAproveitamentoEquivalenciaMatriculaProcessoSeletivo())) {
				cursada.setHistorico(obj);
			}
		}

		// Temos que garantir que existam históricos (no BD)
		// para as disciplinas da matriz curricular referenciadas no mapa de
		// equivalencia
		// e que estes históricos sejam gravados como aprovados (finalizados,
		// conforme
		// regras definidas para este fim no próprio mapa de equivalencia, caso
		// o mapa esteja cumprido)
		// ou como cursando por aproveitamento caso o mapa ainda esteja pendente
		// de alguma disciplina
		// (disciplina a ser cursada)
		for (MapaEquivalenciaDisciplinaMatrizCurricularVO disciplinaMatriz : mapaEquivalencia.getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {
			HistoricoVO historico = disciplinaMatriz.getHistorico();
			if (historico.getCodigo().equals(0) || (historico.getReprovado() && (!historico.getHistoricoPorEquivalencia()) || (incluindoHistoricoEquivalente && mapaEquivalencia.getMapaCumpridoPeloAluno()))) {
				// significa que o mesmo nao existe ainda no BD ou está
				// reprovado e não seja por equivalência
				// , logo temos que gerar um
				// novo histórico e depois atualizá-lo conforme as regras
				// definidas no mapa de equivalencia
				// O histórico passado como parametro para este método é clonado
				// pois todos os dados do mesmo devem ser mantidos para o
				// histórico que está
				// sendo gerado, como ano, semestre, matricula,
				// matriculaperiodo, etc...
				// Somente os dados abaixo devem ser redefinidos.
				HistoricoVO novoHistorico = (HistoricoVO) obj.clone();
				novoHistorico.setCodigo(0);
				novoHistorico.setAnoHistorico(obj.getAnoHistorico());
				novoHistorico.setSemestreHistorico(obj.getSemestreHistorico());
				novoHistorico.setMatriculaPeriodo(obj.getMatriculaPeriodo());
				novoHistorico.setDataRegistro(obj.getDataRegistro());
				novoHistorico.setGradeDisciplinaVO(null);
				novoHistorico.setGradeCurricularGrupoOptativaDisciplinaVO(null);
				/**
				 * Caso histórico seja equivalente não existirá um vínculo com
				 * matriculaPeriodoTurmaDisciplina, pois o aluno irá cursar
				 * outra disciplina de acordo com o mapaEquivalenciaDisciplina.
				 */
				novoHistorico.setMatriculaPeriodoTurmaDisciplina(null);
				novoHistorico.setNumeroAgrupamentoEquivalenciaDisciplina(numeroAgrupamentoEquivalenciaDisciplina);
				GradeDisciplinaVO gradeDisciplinaVO = getFacadeFactory().getGradeDisciplinaFacade().consultarPorGradeCurricularEDisciplina(obj.getMatrizCurricular().getCodigo(), disciplinaMatriz.getDisciplinaVO().getCodigo(), usuario, historico.getMatricula().getCurso().getConfiguracaoAcademico());
				if ((gradeDisciplinaVO != null) && (!gradeDisciplinaVO.getCodigo().equals(0))) {
					novoHistorico.setDisciplina(gradeDisciplinaVO.getDisciplina());
					novoHistorico.setGradeDisciplinaVO(gradeDisciplinaVO);
					novoHistorico.setCargaHorariaDisciplina(gradeDisciplinaVO.getCargaHoraria());
					novoHistorico.setCargaHorariaCursada(gradeDisciplinaVO.getCargaHoraria());
					novoHistorico.setCreditoDisciplina(gradeDisciplinaVO.getNrCreditos());
					novoHistorico.setPeriodoLetivoMatrizCurricular(gradeDisciplinaVO.getPeriodoLetivoVO());
				} else {
					GradeCurricularGrupoOptativaDisciplinaVO gradeCurricularGrupo = getFacadeFactory().getGradeCurricularGrupoOptativaDisciplinaFacade().consultarPorDisciplinaMatrizCurricularPeriodoLetivo(disciplinaMatriz.getDisciplinaVO().getCodigo(), obj.getMatrizCurricular().getCodigo(), usuario);
					if (gradeCurricularGrupo == null) {
						throw new Exception(UteisJSF.internacionalizar("msg_Historico_ErroGerarHistoricoDisciplinaCursadaMapaEquivalencia"));
					}
					novoHistorico.setDisciplina(gradeCurricularGrupo.getDisciplina());
					novoHistorico.setGradeCurricularGrupoOptativaDisciplinaVO(gradeCurricularGrupo);
					novoHistorico.setCargaHorariaDisciplina(gradeCurricularGrupo.getCargaHoraria());
					novoHistorico.setCargaHorariaCursada(gradeCurricularGrupo.getCargaHoraria());
					novoHistorico.setCreditoDisciplina(gradeCurricularGrupo.getNrCreditos());
					novoHistorico.setGradeDisciplinaVO(null);
					// Como um grupo de Optativa pode estar referenciado em
					// diversos períodos letivos. Então iremos adotar como
					// o período letivo da matriz, o primeiro período letivo que
					// tenha esta disciplina em seu grupo de optativa.
					// Isto por ocasionar de todas as disciplinas optativas que
					// forem estudadas por equivalencia, e estiverem
					// presentes e mais de um périodo, serem descocadas pelo SEI
					// para o primeiro período. Mas é uma informação
					// que o SEI não tem como deduzir neste momento, pois a
					// disciplina pode constar em vários períodos da matriz
					// e o mapa de equivalência pode ser cursado também em
					// vários períodos (que nem são períodos da matriz
					// curricular do aluno
					// pois está estudando por equivalencia
					Integer codigoPeriodo = getFacadeFactory().getGradeCurricularGrupoOptativaDisciplinaFacade().consultarPrimeiroPeriodoLetivoComDisciplinaGrupoOptativaMatrizCurricular(disciplinaMatriz.getDisciplinaVO().getCodigo(), obj.getMatrizCurricular().getCodigo(), obj.getPeriodoLetivoCursada().getCodigo(), usuario);
					if ((codigoPeriodo == null) || (codigoPeriodo.equals(0))) {
						throw new Exception(UteisJSF.internacionalizar("msg_Historico_ErroDefinirPeriodoLetivoDisciplina").replace("{0}", gradeCurricularGrupo.getDisciplina().getCodigo().toString()).replace("{1}", gradeCurricularGrupo.getDisciplina().getNome().toUpperCase()));
					}
					PeriodoLetivoVO periodoMatriz = new PeriodoLetivoVO();
					periodoMatriz.setCodigo(codigoPeriodo);
					novoHistorico.setPeriodoLetivoMatrizCurricular(periodoMatriz);
				}
				novoHistorico.setDisciplinaReferenteAUmGrupoOptativa(!novoHistorico.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo().equals(0));
				novoHistorico.setHistoricoDisciplinaOptativa(novoHistorico.getDisciplinaReferenteAUmGrupoOptativa());
				atualizarDadosHistoricoMapaEquivalenciaConsiderandoSituacaoMapa(novoHistorico, mapaEquivalencia, disciplinaMatriz, obj.getAnoHistorico(), obj.getSemestreHistorico());
				getFacadeFactory().getHistoricoFacade().incluir(novoHistorico, usuario);

				// utilizado para validar existencia histórico afim de eliminar duplicidade caso haja muitas transferencias de ida e volta na mesma matriz
				if (obj.getVerificarExistenciaCorrespondeciaHistoricoPorEquivalenciaParaExclusaoEliminandoDuplicidade()) {
					HistoricoVO histExcluir = consultaRapidaPorMatricula_matriculaPeriodo_Disciplina_CargaHoraria_DisciplinaSemCorrespondeciaEEquivalencia(novoHistorico.getMatricula().getMatricula(), novoHistorico.getMatriculaPeriodo().getCodigo(), novoHistorico.getMatrizCurricular().getCodigo(), novoHistorico.getDisciplina().getCodigo(), novoHistorico.getCargaHorariaDisciplina(), false, usuario);
					if (histExcluir != null && !histExcluir.getCodigo().equals(0)) {
						excluir(histExcluir, false, usuario);
					}
				}
			} else {
				atualizarDadosHistoricoMapaEquivalenciaConsiderandoSituacaoMapa(historico, mapaEquivalencia, disciplinaMatriz, obj.getAnoHistorico(), obj.getSemestreHistorico());
				getFacadeFactory().getHistoricoFacade().alterar(historico, usuario);
			}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoHistoricoPelaMatriculaPeriodo(final Integer matriculaPeriodo, final String situacao, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set situacao=? WHERE matriculaPeriodo = ? and situacao in ('CS')" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					sqlAlterar.setString(++i, situacao);
					sqlAlterar.setInt(++i, matriculaPeriodo.intValue());
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarVinculoHistoricoTransferenciaMatrizCurricularMatricula(final Integer codigoHistorico, final Integer codigoTransferenciaMatrizCurricularMatricula, final Boolean historicoCursandoPorCorrespondenciaAposTransferencia, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set transferenciaMatrizCurricularMatricula=?, historicoCursandoPorCorrespondenciaAposTransferencia=? " + "WHERE codigo = ? " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					if (codigoTransferenciaMatrizCurricularMatricula != null) {
						sqlAlterar.setInt(++i, codigoTransferenciaMatrizCurricularMatricula);
					} else {
						sqlAlterar.setNull(++i, 0);
					}
					sqlAlterar.setBoolean(++i, historicoCursandoPorCorrespondenciaAposTransferencia);
					sqlAlterar.setInt(++i, codigoHistorico);
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarNotificarSolicitacaoReposicao(final Integer codigo, final Boolean notificar) throws Exception {
		try {
			final String sql = "UPDATE Historico set notificarSolicitacaoReposicao=? WHERE codigo= ?";
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					sqlAlterar.setBoolean(++i, notificar);
					sqlAlterar.setInt(++i, codigo.intValue());
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoHistoricoPorCodigo(final Integer historico, final String situacao, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set situacao=? WHERE codigo = ?" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					sqlAlterar.setString(++i, situacao);
					sqlAlterar.setInt(++i, historico.intValue());
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarNotasHistoricoPorForum(final Integer historico, final String variavelTipoNota, final Double nota, final Integer notaConceito, UsuarioVO usuario) throws Exception {
		try {
			final StringBuilder sb = new StringBuilder(" UPDATE Historico set ");
			sb.append(" nota").append(variavelTipoNota).append(" = ?, ");
			sb.append(" nota").append(variavelTipoNota).append("Lancada = ?, ");
			sb.append(" nota").append(variavelTipoNota).append("Conceito = ? ");
			sb.append(" WHERE codigo = ? ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sb.toString());
					int i = 0;
					// nao pode utilizar isAtributoPreenchido do uteis pois a nota zero e valida.
					if(nota != null){
						sqlAlterar.setDouble(++i, nota);
					}else{
						sqlAlterar.setNull(++i, 0);
					}
 					sqlAlterar.setBoolean(++i, true);
					if(Uteis.isAtributoPreenchido(notaConceito)){
						sqlAlterar.setInt(++i, notaConceito);
					}else{
						sqlAlterar.setNull(++i, 0);
					}
					sqlAlterar.setInt(++i, historico.intValue());
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<HistoricoVO> listarNotasHistoricoPorForum(final String variavelTipoNota, final String listaCodHistoricos, final Boolean isNotaConceito,  UsuarioVO usuario) throws Exception {
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>();
		try {
			final StringBuilder sb = new StringBuilder(" Select ");
			sb.append(" codigo,");
			sb.append(" nota").append(variavelTipoNota).append("Lancada, ");
			sb.append(" nota").append(variavelTipoNota).append("Conceito, ");
			sb.append(" nota").append(variavelTipoNota).append(" ");
			sb.append(" From historico WHERE codigo in (").append(listaCodHistoricos).append(") ");
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
			while (tabelaResultado.next()) {
				HistoricoVO obj = new HistoricoVO();
				obj.setCodigo(new Integer(tabelaResultado.getInt("codigo")));
				if(Uteis.isAtributoPreenchido(((Integer) tabelaResultado.getObject("nota" + variavelTipoNota + "Conceito")))){
					ConfiguracaoAcademicoNotaConceitoVO conf = new ConfiguracaoAcademicoNotaConceitoVO();
					conf.setCodigo(((Integer) tabelaResultado.getObject("nota" + variavelTipoNota + "Conceito")));
					UtilReflexao.invocarMetodo(obj, "setNota" + variavelTipoNota+ "Conceito", conf);
				}
				Object obje= tabelaResultado.getObject("nota" + variavelTipoNota);
				if(obje == null){
					UtilReflexao.invocarMetodoSetParametroNull(obj, "setNota" + variavelTipoNota);
				}else{
					UtilReflexao.invocarMetodo(obj, "setNota" + variavelTipoNota, tabelaResultado.getDouble("nota" + variavelTipoNota));
				}

				UtilReflexao.invocarMetodo(obj, "setNota" + variavelTipoNota+"Lancada", (Boolean) tabelaResultado.getObject("nota" + variavelTipoNota + "Lancada"));
				vetResultado.add(obj);
			}

		} catch (Exception e) {
			throw e;
		}
		return vetResultado;
	}

	public void registrarLogExclusaoHistorico(HistoricoVO obj, UsuarioVO usuario) {
		try {
			// //System.out.println("==================== EXCLUSÃO HISTÓRICO =====================");
			// //System.out.println("Código = " + obj.getCodigo());
			// //System.out.println("Situação = " +
			// obj.getSituacao_Apresentar());
			// //System.out.println("Data Registro Histórico = " +
			// obj.getDataRegistro_Apresentar());
			// //System.out.println("Código Disciplina = " +
			// obj.getDisciplina().getCodigo());
			// //System.out.println("Freguência = " +
			// obj.getFrequencia_Apresentar());
			// //System.out.println("Média Final = " +
			// obj.getMediaFinal_Apresentar());
			// //System.out.println("Nota 1 = " + obj.getNota1());
			// //System.out.println("Nota 2 = " + obj.getNota2());
			// //System.out.println("Nota 3 = " + obj.getNota3());
			// //System.out.println("Nota 4 = " + obj.getNota4());
			// //System.out.println("Nota 5 = " + obj.getNota5());
			// //System.out.println("Nota 6 = " + obj.getNota6());
			// //System.out.println("Nota 7 = " + obj.getNota7());
			// //System.out.println("Nota 8 = " + obj.getNota8());
			// //System.out.println("Nota 9 = " + obj.getNota9());
			// //System.out.println("Nota 10 = " + obj.getNota10());
			// //System.out.println("Nota 11 = " + obj.getNota11());
			// //System.out.println("Nota 12 = " + obj.getNota12());
			// //System.out.println("Nota 13 = " + obj.getNota13());
			// //System.out.println("Nota 14 = " + obj.getNota14());
			// //System.out.println("Nota 15 = " + obj.getNota15());
			// //System.out.println("Nota 16 = " + obj.getNota16());
			// //System.out.println("Nota 17 = " + obj.getNota17());
			// //System.out.println("Nota 18 = " + obj.getNota18());
			// //System.out.println("Nota 19 = " + obj.getNota19());
			// //System.out.println("Nota 20 = " + obj.getNota20());
			// //System.out.println("Nota 21 = " + obj.getNota21());
			// //System.out.println("Nota 22 = " + obj.getNota22());
			// //System.out.println("Nota 23 = " + obj.getNota23());
			// //System.out.println("Nota 24 = " + obj.getNota24());
			// //System.out.println("Nota 25 = " + obj.getNota25());
			// //System.out.println("Nota 26 = " + obj.getNota26());
			// //System.out.println("Nota 27 = " + obj.getNota27());
			// //System.out.println("Nota 28 = " + obj.getNota28());
			// //System.out.println("Nota 29 = " + obj.getNota29());
			// //System.out.println("Nota 30 = " + obj.getNota30());
			//
			// //System.out.println("Usuário registrou exclusão = " +
			// usuario.getNome());
			// //System.out.println("Data registro Exclusão = " +
			// Uteis.getDataAtual());
			// //System.out.println("IP Maquina logada = " +
			// usuario.getIpMaquinaLogada());
			// //System.out.println("=============================================================");
		} catch (Exception e) {
			// //System.out.println("Historico Erro:" + e.getMessage());
		}
	}

	public void registrarLogExclusaoHistoricoResumido(UsuarioVO usuario) throws Exception {

		// //System.out.println("==================== EXCLUSÃO HISTÓRICO RESUMIDO =====================");
		// //System.out.println("Usuário registrou exclusão = " +
		// usuario.getNome());
		// //System.out.println("Data registro Exclusão = " +
		// Uteis.getDataAtual());
		// //System.out.println("IP Maquina logada = " +
		// usuario.getIpMaquinaLogada());
		// //System.out.println("=============================================================");

	}

	public void alunarRegistroLogExclusaoHistoricoAnterior(HistoricoVO obj) {
		// //System.out.println("==================== EXCLUSÃO HISTÓRICO ANULADO =====================");
		// //System.out.println("OCORREU UM ERRO NO MOMENTO DA EXCLUSÃO DO HISTÓRICO, SENDO ASSIM DESCONSIDERE O LOG REGISTRADO ACIMA.");
		// //System.out.println("=============================================================");
	}

	/**
	 * HOMOLOGADO NA VERSAO 5.0 Ao excluir o histórico, já é gerenciado se o
	 * mesmo é referenciado em alguma mapa de equivalencia e trata esta
	 * situação.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluir(HistoricoVO obj, boolean validarAcesso, UsuarioVO usuario) throws Exception {
		try {
			Historico.excluir(getIdEntidade(), validarAcesso, usuario);
			String sql = "DELETE FROM Historico WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(sql, new Object[] { obj.getCodigo() });
			if(Uteis.isAtributoPreenchido(obj.getMatriculaPeriodoTurmaDisciplina())){
				ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO = getFacadeFactory().getConfiguracaoGeralSistemaFacade().consultarConfiguracaoPadraoSistema();
				getFacadeFactory().getIntegracaoMestreGRInterfaceFacade().verificarAlunoDisciplinaDelete(obj.getMatriculaPeriodoTurmaDisciplina(), usuario, configuracaoGeralSistemaVO);
				sql = "DELETE FROM MatriculaPeriodoTurmaDisciplina WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
				getConexao().getJdbcTemplate().update(sql, new Object[] { obj.getMatriculaPeriodoTurmaDisciplina().getCodigo() });
			}
			// como o obj foi excluido, vamos definir a situacao do mesmo para
			// NC - nao cursada. Assim, a atualização
			// do mapa abaixo (caso seja um histórico de uma disciplina de uma
			// mapa de equivalencia, irá funcionar adequadamente
			//obj.setSituacao(SituacaoHistorico.NAO_CURSADA.getValor());
			//veriricarHistoricoEnvolvidoMapaEquivalenciaDefinindoDadosHistoricoDisciplinasCursadasPorEquivalencia(obj, false, usuario);
			//verificarHistoricoEnvolvidoTransferenciaMatrizCurricularComoHistoricoCorrespondente(obj, true, usuario);
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	@Override
	public void excluirHistoricoPorMatriculaESituacoes(String matricula, String situacoes) throws Exception {
		try {
			if (situacoes == null || situacoes.trim().isEmpty() || matricula == null || matricula.trim().isEmpty()) {
				return;
			}
			StringBuilder sb = new StringBuilder("SELECT matriculaperiodoturmadisciplina, codigo from Historico WHERE ((matricula = " + matricula + " ) and situacao in (" + situacoes + ")  ");
			SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
			String sqlExcluirHistorico = "DELETE FROM Historico WHERE (codigo = ? )";
			String sqlExcluirMPTD = "DELETE FROM matriculaperiodoturmadisciplina WHERE (codigo = ? )";
			while (rs.next()) {
				getConexao().getJdbcTemplate().update(sqlExcluirHistorico, new Object[] { rs.getInt("codigo") });
				if (rs.getInt("matriculaperiodoturmadisciplina") > 0) {
					getConexao().getJdbcTemplate().update(sqlExcluirMPTD, new Object[] { rs.getInt("matriculaperiodoturmadisciplina") });
				}
			}
		} catch (Exception e) {
			throw e;
		}
	}

	public void validarDadosMatriculaPeriodoAtivaExclusaoDisciplina(String situacaoMatriculaPeriodo) throws Exception {
		if (situacaoMatriculaPeriodo.equals("AT")) {
			throw new Exception(UteisJSF.internacionalizar("msg_Historico_ErroExclusaoDisciplinaMatriculaPeriodoAtiva"));
		}
	}

	@Override
	public void excluirHistoricoForaPrazo(List<HistoricoVO> historicoVOs, HistoricoVO historicoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		try {
			List<HistoricoVO> historicoVOs2 = new ArrayList<HistoricoVO>(0);
			if (historicoVO.getHistoricoPorEquivalencia() || historicoVO.getHistoricoEquivalente()) {
				historicoVOs2 = consultaRapidaPorMatriculaPeriodoTurmaDisciplina(historicoVO.getMatriculaPeriodoTurmaDisciplina().getCodigo(), false, NivelMontarDados.BASICO, configuracaoFinanceiroVO, usuario);
			}
			this.excluirHistoricoForaPrazo(historicoVO, configuracaoFinanceiroVO, usuario);
			if (historicoVOs2.isEmpty()) {
				for (Iterator<HistoricoVO> iterator = historicoVOs.iterator(); iterator.hasNext();) {
					HistoricoVO obj = (HistoricoVO) iterator.next();
					if (obj.getCodigo().equals(historicoVO.getCodigo())) {
						iterator.remove();
						break;
					}
				}
			} else {
				for (HistoricoVO historivoVO : historicoVOs2) {
					for (Iterator<HistoricoVO> iterator = historicoVOs.iterator(); iterator.hasNext();) {
						HistoricoVO obj = (HistoricoVO) iterator.next();
						if (obj.getCodigo().equals(historivoVO.getCodigo())) {
							iterator.remove();
							break;
						}
					}
				}
			}
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<HistoricoVO> excluirHistoricoForaPrazo(HistoricoVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {

		try {
			if (!obj.getMatricula().getCurso().getNivelEducacionalPosGraduacao()) {
				validarDadosMatriculaPeriodoAtivaExclusaoDisciplina(obj.getMatriculaPeriodo().getSituacaoMatriculaPeriodo());
			}
			return excluirHistoricoForaPrazoVerificandoHistoricoPorEquivalencia(obj, configuracaoFinanceiroVO, usuario);
			/**
			 * Comentado por Wendel Rodrigues 24/02/2015. A regra abaixo foi
			 * comentada com autorização do Rodrigo Jayme, pois a mesma não
			 * verifica o ano, semestre e grade curricular do histórico passado
			 * como parâmetro para exclusão.
			 */
			// List<HistoricoVO> historicoVOs =
			// consultaRapidaPorMatriculaEDisciplina(obj.getMatricula().getMatricula(),
			// obj.getDisciplina().getCodigo(), false, NivelMontarDados.BASICO,
			// configuracaoFinanceiroVO, usuario);
			// List<HistoricoVO> historicoVOs2 =
			// consultaRapidaPorMatriculaEDisciplinaEMatriculaPeriodoTurmaDisciplina(obj.getMatricula().getMatricula(),
			// obj.getDisciplina().getCodigo(),
			// obj.getMatriculaPeriodoTurmaDisciplina().getCodigo(), false,
			// NivelMontarDados.BASICO, configuracaoFinanceiroVO, usuario);
			// if (!historicoVOs.isEmpty()) {
			// if (historicoVOs.size() == 1) {
			// excluirHistoricoForaPrazoVerificandoHistoricoPorEquivalencia(obj,
			// configuracaoFinanceiroVO, usuario);
			// getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().excluirMatriculaPeriodoTurmaDisciplinasPorDisciplinaEMatricula(obj.getMatricula().getMatricula(),
			// obj.getDisciplina().getCodigo());
			// } else if (historicoVOs.size() > 1) {
			// if
			// (Uteis.isAtributoPreenchido(obj.getMatriculaPeriodoTurmaDisciplina()))
			// {
			// excluirHistoricoForaPrazoVerificandoHistoricoPorEquivalencia(obj,
			// configuracaoFinanceiroVO, usuario);
			// if (historicoVOs2.size() == 1) {
			// getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().excluir(obj.getMatriculaPeriodoTurmaDisciplina(),
			// false, usuario);
			// }
			// } else {
			// List<MatriculaPeriodoTurmaDisciplinaVO>
			// matriculaPeriodoTurmaDisciplinaVOs =
			// getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarPorMatriculaEDisciplina(obj.getMatricula().getMatricula(),
			// obj.getDisciplina().getCodigo(), false,
			// Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
			// if (matriculaPeriodoTurmaDisciplinaVOs.isEmpty() ||
			// matriculaPeriodoTurmaDisciplinaVOs.size() == 1) {
			// excluirHistoricoForaPrazoVerificandoHistoricoPorEquivalencia(obj,
			// configuracaoFinanceiroVO, usuario);
			// } else if (matriculaPeriodoTurmaDisciplinaVOs.size() == 2) {
			// throw new
			// Exception(UteisJSF.internacionalizar("msg_Historico_ErroRemoverDisciplina"));
			// /**
			// * Caso encontre MatriculaPeriodoTurmaDisciplina sem
			// * vinculo com historico nenhuma ação é executado
			// */
			// }
			// }
			// }
			// }
		} catch (Exception e) {
			throw e;
		}

	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<HistoricoVO> excluirHistoricoForaPrazoVerificandoHistoricoPorEquivalencia(HistoricoVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<HistoricoVO> historicoExcluidosVOs = new ArrayList<HistoricoVO>(0);
		try {
			Historico.excluir(getIdEntidade());
			registrarLogExclusaoHistorico(obj, usuario);
			HistoricoVO ultimaSituacaoHistorico = null;
			List<HistoricoVO> historicoEquivalenteVOs = consultarHistoricoEquivalentePorMatriculaMapaEquivalenciaDisciplina(obj.getMatricula().getMatricula(), obj.getMapaEquivalenciaDisciplina().getCodigo(), obj.getNumeroAgrupamentoEquivalenciaDisciplina(), false, usuario);
			if (obj.getHistoricoPorEquivalencia()) {
				/**
				 * Caso encontre as disciplinas que fazem parte dessa
				 * equivalência é realizada a exclusão das mesmas, caso
				 * contrário é realizado a exclusão do histórico em questão.
				 */
				for (HistoricoVO historicoEquivalenteVO : historicoEquivalenteVOs) {
					excluir(historicoEquivalenteVO, false, usuario);
					historicoExcluidosVOs.add(historicoEquivalenteVO);
					if (Uteis.isAtributoPreenchido(historicoEquivalenteVO.getMatriculaPeriodoTurmaDisciplina())) {
						getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().excluir(historicoEquivalenteVO.getMatriculaPeriodoTurmaDisciplina(), false, usuario);
					}
				}
			} else if (obj.getHistoricoEquivalente()) {
				if (historicoEquivalenteVOs.size() > 1) {
					List<HistoricoVO> historicoVOs = historicoEquivalenteVOs.stream().filter(h -> !h.getCodigo().equals(obj.getCodigo())).collect(Collectors.toList());
					ultimaSituacaoHistorico = Uteis.isAtributoPreenchido(historicoVOs) ? historicoVOs.get(historicoVOs.size() - 1) : null;
					carregarDados(ultimaSituacaoHistorico, usuario);
				} else {
					List<HistoricoVO> historicoPorEquivalenciaVOs = consultarHistoricoPorEquivalenciaPorMatriculaMapaEquivalenciaDisciplina(obj.getMatricula().getMatricula(), obj.getMapaEquivalenciaDisciplina().getCodigo(), obj.getNumeroAgrupamentoEquivalenciaDisciplina(), false, usuario);
					for (HistoricoVO historicoPorEquivalenciaVO : historicoPorEquivalenciaVOs) {
						historicoExcluidosVOs.add(historicoPorEquivalenciaVO);
						excluir(historicoPorEquivalenciaVO, false, usuario);
						if (Uteis.isAtributoPreenchido(historicoPorEquivalenciaVO.getMatriculaPeriodoTurmaDisciplina())) {
							getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().excluir(historicoPorEquivalenciaVO.getMatriculaPeriodoTurmaDisciplina(), false, usuario);
						}
					}
					obj.setHistoricoEquivalente(false);
				}
			}
			excluir(obj, false, usuario);
			historicoExcluidosVOs.add(obj);
			/**
			 * Caso atributo ultimaSituacaoHistorico esteja preenchido significa
			 * que este é um histórico equivalente e que existe mais de um
			 * histórico equivalente, então será necessário atualizar a situação
			 * do histórico por equivalência de acordo com a situação do último
			 * histórico.
			 */
			if (Uteis.isAtributoPreenchido(ultimaSituacaoHistorico)) {
				veriricarHistoricoEnvolvidoMapaEquivalenciaDefinindoDadosHistoricoDisciplinasCursadasPorEquivalencia(ultimaSituacaoHistorico, false, usuario);
			}
		} catch (Exception e) {
			throw e;
		}
		return historicoExcluidosVOs;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirPorTransferenciaMatrizCurricularMatricula(Integer codigoTransferenciaMatrizCurricularMatricula, Integer codigoMatrizCurricular, UsuarioVO usuario) throws Exception {
		Historico.excluir(getIdEntidade());
		String sql = "DELETE FROM Historico WHERE (transferenciaMatrizCurricularMatricula = ?) and (matrizCurricular = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql, new Object[] { codigoTransferenciaMatrizCurricularMatricula, codigoMatrizCurricular });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirPorMatriculaPeriodoTurmaDisciplina(String matricula, Integer codigoDisciplina, UsuarioVO usuario) throws Exception {
		// MatriculaPeriodoTurmaDisciplinaVO mptd =
		// getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarPorMatriculaDisciplina(matricula,
		// codigoDisciplina,
		// false, Uteis.NIVELMONTARDADOS_DADOSBASICOS);
		// if (mptd.getCodigo() != 0) {
		registrarLogExclusaoHistoricoResumido(usuario);
		String sql = "DELETE FROM Historico WHERE ((matricula = ? and disciplina = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql, new Object[] { matricula, codigoDisciplina });
		getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().excluir(matricula, codigoDisciplina);
		// }
	}

	/**
	 * HOMOLOGADO NA VERSÃO 5.0
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirHistoricoPorMatriculaCodigoDisciplinaAproveitamento(String matricula, Integer codigoDisciplina, UsuarioVO usuario) throws Exception {
		String sqlStr = " SELECT Historico.codigo FROM Historico " + "   INNER JOIN Matricula ON (Matricula.Matricula = Historico.Matricula) " + "   WHERE (Historico.matricula = '" + matricula + "') " + "     AND (matricula.gradecurricularatual = historico.matrizCurricular)  " + "     AND (Historico.disciplina = " + codigoDisciplina + ") " + "     AND (Historico.situacao in ('AE','CE','AA','CC','CH','IS')) " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr, new Object[] {});
		if (!tabelaResultado.next()) {
			return;
		}
		Integer codigoHistorico = tabelaResultado.getInt("codigo");
		if ((codigoHistorico == null) || (codigoHistorico.equals(0))) {
			return;
		}
		HistoricoVO historicoRemover = new HistoricoVO();
		historicoRemover.setCodigo(codigoHistorico);
		carregarDados(historicoRemover, NivelMontarDados.TODOS, usuario);
		excluir(historicoRemover, false, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirHistoricoPorMatriculaCodigoDisciplinaAproveitamentoEquivalencia(String matricula, Integer codigoDisciplina, UsuarioVO usuario) throws Exception {
		try {
			Historico.excluir(getIdEntidade(), false, usuario);
			String sql = "DELETE FROM Historico WHERE codigo IN (SELECT codigo from HISTORICO INNER JOIN Matricula ON (Matricula.Matricula = Historico.Matricula) WHERE (Historico.matricula = '" + matricula + "') " + "     AND (matricula.gradecurricularatual = historico.matrizCurricular)  " + "     AND (Historico.disciplina = " + codigoDisciplina + ") " + "     AND (Historico.situacao in ('AE','CE','AA','CC','CH'))) " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(sql, new Object[] {});
		} catch (Exception e) {
			throw e;
		}
	}

	/**
	 * Responsável por realizar uma consulta de <code>Historico</code> através
	 * do valor do atributo <code>nome</code> da classe <code>Pessoa</code> Faz
	 * uso da operação <code>montarDadosConsulta</code> que realiza o trabalho
	 * de prerarar o List resultante.
	 *
	 * @return List Contendo vários objetos da classe <code>HistoricoVO</code>
	 *         resultantes da consulta.
	 * @exception Execption
	 *                Caso haja problemas de conexão ou restrição de acesso.
	 */
	public List consultarPorNomePessoa(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT Historico.* FROM Historico, Pessoa WHERE Historico.responsavel = Pessoa.codigo and Pessoa.nome like('" + valorConsulta + "%') ORDER BY Pessoa.nome";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public Integer consultarCargaHorariaCumpridaNoHistorico(String matricula, Integer gradeCurricular, UsuarioVO usuario) throws Exception {
		String sqlStr = "select sum(coalesce(gradedisciplina.cargahoraria, gradedisciplina.cargahoraria, 0)) from historico " + "inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo " + "inner join gradecurricular on matriculaperiodo.gradecurricular = gradecurricular.codigo " + "inner join disciplina on historico.disciplina = disciplina.codigo " + "inner join periodoletivo on periodoletivo.codigo = matriculaperiodo.periodoletivomatricula " + "inner join gradedisciplina on gradedisciplina.disciplina = disciplina.codigo and gradedisciplina.periodoletivo = periodoletivo.codigo ";

		if (Uteis.isAtributoPreenchido(gradeCurricular)) {
			sqlStr += "and gradecurricular.codigo = " + gradeCurricular;
		}

		sqlStr += "where historico.matricula = '" + matricula + "' and " + "(historico.situacao = '" + SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor() + "' or historico.situacao = '" + SituacaoHistorico.APROVADO.getValor() + "')";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return (int) tabelaResultado.getDouble(1);
		}
		return null;
	}

	public Integer consultarCargaHorariaHistPorMatriculaPeriodoTurmaDisciplina(Integer codMatPerTurDisc) throws Exception {
		String sqlStr = "select cargahorariadisciplina from historico where matriculaperiodoturmadisciplina = " + codMatPerTurDisc;
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("cargahorariadisciplina");
		}
		return 0;
	}

	public Integer consultarPeriodoLetivoPorCodigoHistorico(Integer codigoHistorico) throws Exception {
		String sqlStr = "select historico.codigo, historico.disciplina, matriculaperiodo.periodoletivomatricula from historico inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo";
		sqlStr += "  where historico.codigo = " + codigoHistorico;
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return (int) tabelaResultado.getInt("periodoletivomatricula");
		}
		return 0;
	}

	public List<HistoricoVO> consultarHistoricoParaAproveitamentoNaTransferenciaInterna(String matriculaAntiga, Integer cursoNovo, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder(" select historico.* from historico, disciplina where historico.disciplina = disciplina.codigo and matricula  = '" + matriculaAntiga + "' and ((situacao = 'AP') or (situacao = 'AA')) ");
		sqlStr.append(" and disciplina.codigo in ( select disciplinaequivalente.equivalente from disciplinaequivalente where disciplina in ( ");
		sqlStr.append(" select gradedisciplina.disciplina from Curso inner join GradeCurricular on GradeCurricular.curso = curso.codigo ");
		sqlStr.append(" inner join periodoLetivo on PeriodoLetivo.codigo = historico.periodoLetivoMatrizCurricular ");
		sqlStr.append(" inner join gradedisciplina on periodoLetivo.codigo = gradedisciplina.periodoLetivo ");
		sqlStr.append(" where gradeCurricular.situacao = 'AT' and curso.codigo = ").append(cursoNovo).append(" group by gradedisciplina.disciplina ");
		sqlStr.append(" ) ");
		sqlStr.append(" union all ");
		sqlStr.append(" select gradedisciplina.disciplina from Curso inner join GradeCurricular on GradeCurricular.curso = curso.codigo ");
		sqlStr.append(" inner join periodoLetivo on PeriodoLetivo.GradeCurricular = GradeCurricular.codigo ");
		sqlStr.append(" inner join gradedisciplina on periodoLetivo.codigo = gradedisciplina.periodoLetivo ");
		sqlStr.append(" where gradeCurricular.situacao = 'AT' and curso.codigo = ").append(cursoNovo).append(" group by gradedisciplina.disciplina) order by disciplina.nome ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List<HistoricoVO> consultarHistoricoParaAproveitamentoNaTransferenciaInternaPorCursoGrade(Integer aluno, Integer cursoNovo, Integer gradeCurricular, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario, ConfiguracaoAcademicoVO configuracaoAcademicoVO) throws Exception {
		StringBuilder sqlStr = new StringBuilder("SELECT t.* FROM (SELECT historico.*, disciplina.nome disciplina_nome, ");
		sqlStr.append(" ROW_NUMBER() OVER(PARTITION BY historico.disciplina ORDER BY historico.mediafinal DESC NULLS LAST, historico.codigo DESC) indice ");
		sqlStr.append(" FROM historico ");
		sqlStr.append(" INNER JOIN matricula ON historico.matricula = matricula.matricula ");
		sqlStr.append(" INNER JOIN disciplina ON historico.disciplina = disciplina.codigo ");
		sqlStr.append(" WHERE matricula.aluno = ").append(aluno);
		sqlStr.append(" AND historico.situacao = ANY('{AP,AA,CC,IS}'::TEXT[]) ");
		sqlStr.append(" AND disciplina.codigo IN ( select disciplinaequivalente.equivalente from disciplinaequivalente where disciplina in ( ");
		sqlStr.append(" select gradedisciplina.disciplina from Curso inner join GradeCurricular on GradeCurricular.curso = curso.codigo ");
		sqlStr.append(" inner join periodoLetivo on PeriodoLetivo.GradeCurricular = GradeCurricular.codigo ");
		sqlStr.append(" inner join gradedisciplina on periodoLetivo.codigo = gradedisciplina.periodoLetivo ");
		sqlStr.append(" where 1=1 and curso.codigo = ").append(cursoNovo).append(" and gradecurricular.codigo = ").append(gradeCurricular);
		sqlStr.append(" group by gradedisciplina.disciplina ) ");
		sqlStr.append(" union all ");
		sqlStr.append(" select gradedisciplina.disciplina from Curso inner join GradeCurricular on GradeCurricular.curso = curso.codigo ");
		sqlStr.append(" inner join periodoLetivo on PeriodoLetivo.GradeCurricular = GradeCurricular.codigo ");
		sqlStr.append(" inner join gradedisciplina on periodoLetivo.codigo = gradedisciplina.periodoLetivo ");
		sqlStr.append(" where 1=1 and curso.codigo = ").append(cursoNovo).append(" and gradecurricular.codigo = ").append(gradeCurricular);
		if(Uteis.isAtributoPreenchido(configuracaoAcademicoVO) && !configuracaoAcademicoVO.getPermitirAproveitamentoDisciplinasOptativas()) {
			sqlStr.append(" and gradedisciplina.tipodisciplina <> 'OP' ");
		}
		sqlStr.append(" group by gradedisciplina.disciplina ");
		sqlStr.append(" union all ");
		sqlStr.append(" select gradecurriculargrupooptativadisciplina.disciplina from Curso inner join GradeCurricular on GradeCurricular.curso = curso.codigo ");
		sqlStr.append(" inner join gradecurriculargrupooptativa on gradecurriculargrupooptativa.gradecurricular = gradecurricular.codigo ");
		sqlStr.append(" inner join gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.gradecurriculargrupooptativa = gradecurriculargrupooptativa.codigo ");
		sqlStr.append(" inner join periodoLetivo on	PeriodoLetivo.gradecurriculargrupooptativa = gradecurriculargrupooptativa.codigo ");
		sqlStr.append(" where 1=1 and curso.codigo = ").append(cursoNovo).append(" and gradecurricular.codigo = ").append(gradeCurricular);
		sqlStr.append(" group by gradecurriculargrupooptativadisciplina.disciplina ");
		sqlStr.append(") ) t WHERE t.indice = 1 ORDER BY T.disciplina_nome ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	/**
	 * Responsável por realizar uma consulta de <code>Historico</code> através
	 * do valor do atributo <code>matricula</code> da classe
	 * <code>Matricula</code> Faz uso da operação
	 * <code>montarDadosConsulta</code> que realiza o trabalho de prerarar o
	 * List resultante.
	 *
	 * @return List Contendo vários objetos da classe <code>HistoricoVO</code>
	 *         resultantes da consulta.
	 * @exception Execption
	 *                Caso haja problemas de conexão ou restrição de acesso.
	 */
	public List<HistoricoVO> consultarPorMatricula(String valorConsulta, int ordemHistoricoDisciplina, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT DISTINCT  historico.*, matriculaperiodo.ano, matriculaperiodo.semestre, disciplina.nome, periodoletivo.periodoletivo FROM historico " + "inner join disciplina on disciplina.codigo = historico.disciplina " + "left join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo " + "left join gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina " + "left join periodoletivo on periodoletivo.codigo = gradedisciplina.periodoletivo " + "WHERE historico.matricula = '" + valorConsulta + "' ";
		switch (OrdemHistoricoDisciplina.getEnum(ordemHistoricoDisciplina)) {
		case ANO_SEMESTRE:
			sqlStr += "ORDER BY matriculaperiodo.ano, matriculaperiodo.semestre, disciplina.nome, periodoletivo.periodoletivo";
			break;
		case PERIODO_LETIVO:
			sqlStr += "ORDER BY periodoletivo.periodoletivo, disciplina.nome, matriculaperiodo.ano, matriculaperiodo.semestre";
			break;
		default:
			break;
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List<HistoricoVO> consultaRapidaPorMatricula(String matricula, Integer gradeCurricular, int ordemHistoricoDisciplina, boolean apresentarDisciplinaForaGrade, Integer disciplina, boolean controlarAcesso, NivelMontarDados nivelMontarDados, boolean apresentarApenasUltimoHistoricoDisciplina, Boolean xmlDiploma, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append(" SELECT codigo, historicodisciplinaforagrade, matricula, mediafinal, situacao, freguencia, frequenciaTeorica, frequenciaPratica, instituicao, cidade, codigocidade, estado, anohistorico, semestrehistorico, historicoDisciplinaComposta, historicoDisciplinaFazParteComposicao, numeroAgrupamentoEquivalenciaDisciplina, ");
		sqlStr.append(" utilizaNotaFinalConceito, notaFinalConceito, historicoDisciplinaAtividadeComplementar, observacao, totaldialetivoano, ");
		sqlStr.append(" mfc_codigo, mfc_conceitoNota, mfc_abreviaturaconceitonota, mfc_situacao, mfc_tiponotaconceito, mfc_faixanota1, mfc_faixanota2, mfc_configuracaoacademico, ano, semestre, ");
		sqlStr.append(" disciplina_codigo, disciplina_nome, disciplina_abreviatura, gradedisciplina_nrcreditos, gradedisciplina_nomeChancela, gradedisciplina_tipodisciplina, gradedisciplina_cargahoraria, gradedisciplina_codigo, gradedisciplina_ordem, gradedisciplina_diversificada, apresentarSiglaConcessaoCredito, intervaloNotasDiferente, dataregistro, gradedisciplina_disciplinaestagio, gradedisciplina_disciplinaTcc, gradedisciplina_cargahorariatotal, gradedisciplina_cargahorariapratica, ");
		// Busca a cargahoraria cursada de acordo com o registro de aula
		// Caso haja registro de aula o sistema calcula do registro de aula
		// Caso não haja registro de aula o sistema pegará do historico
		sqlStr.append(" case when cargahorariacursada = 0 then ");
		sqlStr.append(" case when situacao in ('CC', 'CH') then gradedisciplina_cargahoraria else ");
		sqlStr.append(" case when (cargaHorariaCursadaCalculada is not null and cargaHorariaCursadaCalculada > 0) then cargaHorariaCursadaCalculada else ");
		sqlStr.append(" ((gradedisciplina_cargahoraria * freguencia)/100)::INT end end else cargahorariacursada end AS cargahorariacursada , ");

		sqlStr.append(" apresentarperiodoletivomatriculaperiodoatualhistorico, periodoletivo_codigo, periodoletivo1, periodoletivo2_codigo, periodoletivo2, unidadeensino_codigo, data, ");
		sqlStr.append(" mptd_disciplinaequivale, mptd_disciplina, mptd_codigo, matriculaperiodo_codigo, matriculaperiodo_situacaomatriculaperiodo, totalfalta, tipoHistorico, ");
		sqlStr.append(" codigo_configuracaoacademico, ocultarMediaFinalDisciplinaCasoReprovado, quantidadeCasasDecimaisPermitirAposVirgula, apresentarTotalAulaRegistradaComoCargaHorariaCursadaNoHistorico, apresentarAprovadoHistorico, dataprimeiraaula, transferenciamatrizcurricularmatricula,historicoporequivalencia, mapaequivalenciadisciplina, matrizcurricular, disciplinareferenteaumgrupooptativa, historicodisciplinaoptativa, dataInicioAula, dataFimAula, bimestre, ");
		sqlStr.append(" gcgo_bimestre, mptd_bimestre, ofertaDisciplina_periodo ");
		sqlStr.append(" FROM (");
		sqlStr.append(" SELECT DISTINCT  historico.codigo, tipoHistorico, historico.totalfalta, historico.matricula, historico.mediaFinal, gradedisciplina.cargahoraria as gradedisciplina_cargahorariatotal, gradedisciplina.cargahorariapratica as gradedisciplina_cargahorariapratica, case when (matriculaperiodo.situacaomatriculaperiodo = 'PR' and historico.disciplinasaproveitadas is null) then 'PR' else historico.situacao end AS situacao, historico.freguencia, historico.frequenciaTeorica, historico.frequenciaPratica, historico.dataregistro, ");
		sqlStr.append(" historico.utilizaNotaFinalConceito, historico.notaFinalConceito,  historicodisciplinaforagrade, historicoDisciplinaAtividadeComplementar, historico.observacao, numeroAgrupamentoEquivalenciaDisciplina, ");
		// Busca a instituicaoEnsino de acordo com a origem do historico
		// (Aproveitamento de Disciplina, Transferencia de Entrada ou a Unidade
		// de Ensino da Matrícula)
		sqlStr.append(" case when (transferenciaentrada.codigo is not null and transferenciaentrada.instituicaoOrigem is not null and transferenciaentrada.instituicaoOrigem != '' ) then transferenciaentrada.instituicaoOrigem else ");
		sqlStr.append(" case when (disciplinasaproveitadas.codigo is not null and disciplinasaproveitadas.instituicao is not null and disciplinasaproveitadas.instituicao != '' ) then disciplinasaproveitadas.instituicao else ");
		sqlStr.append(" case when (historico.instituicao = '' or historico.instituicao is null) then  unidadeEnsino.nomeExpedicaoDiploma else historico.instituicao end end end as instituicao, ");
		// Busca a cidade de acordo com a origem do historico (Aproveitamento de
		// Disciplina, Transferencia de Entrada ou a Unidade de Ensino da
		// Matrícula)
		sqlStr.append(" case when (transferenciaentrada.codigo is not null and transferenciaentrada.instituicaoOrigem is not null and transferenciaentrada.instituicaoOrigem != '' ) then cidadeTrans.nome else ");
		sqlStr.append(" case when (disciplinasaproveitadas.codigo is not null and disciplinasaproveitadas.instituicao is not null and disciplinasaproveitadas.instituicao != '' ) then cidadeAp.nome else ");
		sqlStr.append(" case when (historico.situacao in ('AA', 'CC', 'IS') and historico.cidade is not null) then cidadeHistorico.nome else cidade.nome end end end as cidade, ");
		// Busca a cidade de acordo com a origem do historico (Aproveitamento de
		// Disciplina, Transferencia de Entrada ou a Unidade de Ensino da
		// Matrícula)
		sqlStr.append(" case when (transferenciaentrada.codigo is not null and transferenciaentrada.instituicaoOrigem is not null and transferenciaentrada.instituicaoOrigem != '' ) then cidadeTrans.codigo else ");
		sqlStr.append(" case when (disciplinasaproveitadas.codigo is not null and disciplinasaproveitadas.instituicao is not null and disciplinasaproveitadas.instituicao != '' ) then cidadeAp.codigo else ");
		sqlStr.append(" case when (historico.situacao in ('AA', 'CC', 'IS') and historico.cidade is not null) then cidadeHistorico.codigo else cidade.codigo end end end as codigoCidade, ");
		// Busca a estado de acordo com a origem do historico (Aproveitamento de
		// Disciplina, Transferencia de Entrada ou a Unidade de Ensino da
		// Matrícula)
		sqlStr.append(" case when (transferenciaentrada.codigo is not null and transferenciaentrada.instituicaoOrigem is not null and transferenciaentrada.instituicaoOrigem != '' ) then estadoTrans.sigla else ");
		sqlStr.append(" case when (disciplinasaproveitadas.codigo is not null and disciplinasaproveitadas.instituicao is not null and disciplinasaproveitadas.instituicao != '' ) then estadoAp.sigla else ");
		sqlStr.append(" case when (historico.situacao in ('AA', 'CC', 'IS') and historico.cidade is not null) then estadoHistorico.sigla else estado.sigla end end end as estado, ");

		// Define o ano a ser apresentado conforme a origem do historico
		// (Aproveitamento de Disciplina, Transferencia de Entrada ou a Ano da
		// MatrículaPeriodo)
		sqlStr.append(" historico.anohistorico as anohistorico, ");
		// Define o semestre a ser apresentado conforme a origem do historico
		// (Aproveitamento de Disciplina, Transferencia de Entrada ou a semestre
		// da MatrículaPeriodo)
		sqlStr.append(" historico.semestrehistorico as semestrehistorico, ");
		sqlStr.append(" historico.historicoDisciplinaComposta AS historicoDisciplinaComposta, ");
		sqlStr.append(" historico.historicoDisciplinaFazParteComposicao AS historicoDisciplinaFazParteComposicao, ");
		sqlStr.append(" mfc.codigo as mfc_codigo, mfc.conceitoNota as mfc_conceitoNota, mfc.abreviaturaConceitoNota as mfc_abreviaturaConceitoNota, mfc.situacao as mfc_situacao, ");
		sqlStr.append(" mfc.tipoNotaConceito as mfc_tipoNotaConceito, mfc.faixaNota1 as mfc_faixaNota1, mfc.faixaNota2 as mfc_faixaNota2, mfc.configuracaoAcademico as mfc_configuracaoAcademico,  ");
		sqlStr.append(" matriculaperiodo.ano, matriculaperiodo.semestre, ");
		sqlStr.append(" disciplina.codigo AS disciplina_codigo, ");
		sqlStr.append(" disciplina.abreviatura AS disciplina_abreviatura, ");
		sqlStr.append(" case when disciplinaEixoTematico.codigo is null then disciplina.nome else disciplinaEixoTematico.nome end AS disciplina_nome, ");
		sqlStr.append(" case when historico.creditodisciplina is not null and historico.creditodisciplina > 0 then historico.creditodisciplina else case when gradedisciplina.codigo is not null then gradedisciplina.nrcreditos else gradecurriculargrupooptativadisciplina.nrCreditos end end as gradedisciplina_nrcreditos, gradedisciplina.nomeChancela as gradedisciplina_nomeChancela, gradedisciplina.tipoDisciplina AS gradedisciplina_tipoDisciplina, ");
		sqlStr.append(" case when gradedisciplina.codigo is not null then gradedisciplina.diversificada else gradecurriculargrupooptativadisciplina.diversificada end AS gradedisciplina_diversificada, ");
		sqlStr.append(" gradedisciplina.codigo AS gradedisciplina_codigo, gradedisciplina.ordem AS gradedisciplina_ordem, gradedisciplina.disciplinaestagio as gradedisciplina_disciplinaestagio, gradedisciplina.disciplinaTcc as gradedisciplina_disciplinaTcc, ");
		/**
		 * Define a origem da carga horaria (Disciplinas Aproveitadas,
		 * Transferencia de Entrada ou Historico ou Disciplina)
		 */
		sqlStr.append(" case when (transferenciaentradadisciplinasaproveitadas.codigo is not null ) then transferenciaentradadisciplinasaproveitadas.cargahoraria::INT else ");
		sqlStr.append(" case when (disciplinasaproveitadas.codigo is not null) then disciplinasaproveitadas.cargahoraria else ");
		sqlStr.append(" case when historico.cargahorariadisciplina is not null and historico.cargahorariadisciplina > 0 then historico.cargahorariadisciplina else case when gradedisciplina.codigo is not null then gradedisciplina.cargahoraria else gradecurriculargrupooptativadisciplina.cargahoraria end end end end as gradedisciplina_cargaHoraria, ");

		/**
		 * Define a origem da carga horaria cursada (Disciplinas Aproveitadas,
		 * Transferencia de Entrada ou Historico ou Disciplina)
		 */
		sqlStr.append(" case when (disciplinasaproveitadas.codigo is not null) then disciplinasaproveitadas.cargaHorariaCursada else historico.cargaHorariaCursada end as cargaHorariaCursada, ");
		// sqlStr.append(" case when (disciplinasaproveitadas.codigo is not null) then disciplinasaproveitadas.cargaHorariaCursada else ");
		// sqlStr.append(" case when (historico.situacao in ('AA', 'CC', 'IS') and (historico.cargaHorariaCursada is not null and historico.cargaHorariaCursada > 0)) then historico.cargaHorariaCursada else ");
		// sqlStr.append(" case when historico.situacao in ('AA', 'CC', 'IS') then ((disciplina.cargahoraria*historico.freguencia)/100)::INT else 0 end end end as cargaHorariaCursada, ");

		sqlStr.append("(select sum(cargahoraria) from (");
		sqlStr.append(" select case when (turno.considerarhoraaulasessentaminutosgeracaodiario = false or turno.considerarhoraaulasessentaminutosgeracaodiario is null) then ");
		sqlStr.append(" (sum(registroaula.cargahoraria) / 60) else sum(60 / 60) end AS cargahoraria  ");
		sqlStr.append(" from registroaula  ");
		sqlStr.append(" inner join frequenciaaula on frequenciaaula.registroaula = registroaula.codigo ");
		sqlStr.append(" where 1=1 ");
		sqlStr.append(" and case when historico.historicodisciplinacomposta then registroaula.disciplina in ( ");
		sqlStr.append(" select h.disciplina from historico h where h.matricula = historico.matricula and h.gradedisciplinacomposta in ( ");
		sqlStr.append(" select gdc.codigo from gradedisciplinacomposta gdc where gdc.gradedisciplina = historico.gradedisciplina) ");
		sqlStr.append(" and h.historicodisciplinafazpartecomposicao)  else registroaula.disciplina = disciplina.codigo end ");
		sqlStr.append(" and registroaula.ano = matriculaperiodo.ano ");
		sqlStr.append(" and registroaula.semestre = matriculaperiodo.semestre ");
		sqlStr.append(" and frequenciaaula.matricula = '").append(matricula).append("' ");
		sqlStr.append(" and registroaula.turma = mptd.turma ");
		sqlStr.append(" and atividadecomplementar = false ");
		sqlStr.append(" union ");
		sqlStr.append(" select case when (turno.considerarhoraaulasessentaminutosgeracaodiario = false or turno.considerarhoraaulasessentaminutosgeracaodiario is null) then ");
		sqlStr.append(" (sum(registroaula.cargahoraria) / 60) else sum(60 / 60) end AS cargahoraria  ");
		sqlStr.append(" from registroaula  ");
		sqlStr.append(" inner join frequenciaaula on frequenciaaula.registroaula = registroaula.codigo ");
		sqlStr.append(" where 1=1 ");
		sqlStr.append(" and case when historico.historicodisciplinacomposta then registroaula.disciplina in ( ");
		sqlStr.append(" select h.disciplina from historico h where h.matricula = historico.matricula and h.gradedisciplinacomposta in ( ");
		sqlStr.append(" select gdc.codigo from gradedisciplinacomposta gdc where gdc.gradedisciplina = historico.gradedisciplina) ");
		sqlStr.append(" and h.historicodisciplinafazpartecomposicao)  else registroaula.disciplina = disciplina.codigo end ");
		sqlStr.append(" and registroaula.ano = matriculaperiodo.ano ");
		sqlStr.append(" and registroaula.semestre = matriculaperiodo.semestre ");
		sqlStr.append(" and frequenciaaula.matricula = '").append(matricula).append("' ");
		sqlStr.append(" and registroaula.turma = mptd.turma ");
		sqlStr.append(" and atividadecomplementar = true ");
		sqlStr.append(" ) as t ");
		sqlStr.append(" ) as cargaHorariaCursadaCalculada, ");
		sqlStr.append(" historico.apresentarAprovadoHistorico, ");
		sqlStr.append(" case when cursoMatricula.niveleducacional in ('ME', 'IN', 'BA') then true else configuracaoacademico.apresentarPeriodoLetivoMatriculaPeriodoAtualHistorico end AS apresentarPeriodoLetivoMatriculaPeriodoAtualHistorico, ");
		// sqlStr.append(" configuracaoacademico.apresentarPeriodoLetivoMatriculaPeriodoAtualHistorico AS apresentarPeriodoLetivoMatriculaPeriodoAtualHistorico, ");
		sqlStr.append(" configuracaoacademico.apresentarSiglaConcessaoCredito  , ");
		sqlStr.append(" periodoletivo.codigo AS periodoletivo_codigo, periodoletivo.periodoletivo AS periodoLetivo1, plmp.codigo AS periodoLetivo2_codigo, plmp.periodoletivo AS periodoLetivo2, unidadeEnsino.codigo AS unidadeensino_codigo, ");
		sqlStr.append(" null as data, ");
		sqlStr.append(" mptd.disciplinaequivale AS mptd_disciplinaequivale, mptd.disciplina AS mptd_disciplina, mptd.codigo as mptd_codigo, matriculaPeriodo.codigo as matriculaPeriodo_codigo, matriculaperiodo.situacaomatriculaperiodo as matriculaperiodo_situacaomatriculaperiodo, intervaloNotasDiferente,  ");
		sqlStr.append(" (select totaldialetivoano from periodoletivoativounidadeensinocurso  ");
		sqlStr.append(" inner join processomatriculacalendario on matriculaperiodo.processomatricula = processomatriculacalendario.processomatricula ");
		sqlStr.append(" and processomatriculacalendario.curso =  unidadeensinocurso.curso ");
		sqlStr.append(" and processomatriculacalendario.turno =  unidadeensinocurso.turno ");
		sqlStr.append(" and processomatriculacalendario.periodoletivoativounidadeensinocurso = periodoletivoativounidadeensinocurso.codigo ) as totaldialetivoano, ");
		sqlStr.append("configuracaoacademico.codigo as codigo_configuracaoacademico, configuracaoacademico.ocultarMediaFinalDisciplinaCasoReprovado as ocultarMediaFinalDisciplinaCasoReprovado, configuracaoacademico.quantidadeCasasDecimaisPermitirAposVirgula as quantidadeCasasDecimaisPermitirAposVirgula, apresentarTotalAulaRegistradaComoCargaHorariaCursadaNoHistorico, ");
		sqlStr.append(" null as dataprimeiraaula, historico.transferenciamatrizcurricularmatricula,historico.historicoporequivalencia, historico.mapaequivalenciadisciplina, historico.matrizcurricular, historico.disciplinareferenteaumgrupooptativa, historico.historicodisciplinaoptativa, historico.dataInicioAula, historico.dataFimAula, gradedisciplina.bimestre, mptd.bimestre as mptd_bimestre, gradecurriculargrupooptativadisciplina.bimestre as gcgo_bimestre, ofertadisciplina.periodo as ofertaDisciplina_periodo ");
		sqlStr.append(" FROM historico ");
		sqlStr.append(" inner join matricula on historico.matricula = matricula.matricula ");
		// Incluir Disciplinas Equivalentes
		sqlStr.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina mptd on mptd.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		// sqlStr.append(" inner join disciplina on (disciplina.codigo = historico.disciplina or (case when (mptd.disciplinaequivale = true) then disciplina.codigo = mptd.disciplinaequivalente end)) ");
		//
		sqlStr.append(" inner join disciplina on disciplina.codigo = historico.disciplina ");
		sqlStr.append(" inner join matriculaperiodo on matriculaperiodo.matricula = matricula.matricula and matriculaperiodo.codigo = historico.matriculaperiodo ");
		sqlStr.append(" inner join unidadeensinocurso on matriculaperiodo.unidadeensinocurso = unidadeensinocurso.codigo ");

		sqlStr.append(" left join configuracaoAcademicoNotaConceito mfc on mfc.codigo = historico.mediaFinalConceito");
		// sqlStr.append(" inner join gradecurricular on matriculaperiodo.gradecurricular = gradecurricular.codigo");
		// sqlStr.append(" inner join periodoletivo on periodoletivo.gradecurricular = gradecurricular.codigo ");

		sqlStr.append(" inner join curso cursoMatricula on cursoMatricula.codigo = matricula.curso ");
		sqlStr.append(" inner join unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeensino ");
		sqlStr.append(" left join cidade on unidadeEnsino.cidade = cidade.codigo ");
		sqlStr.append(" left join estado on cidade.estado = estado.codigo ");
		sqlStr.append(" LEFT JOIN turma on turma.codigo = matriculaperiodo.turma ");
		sqlStr.append(" LEFT JOIN turno on turno.codigo = turma.turno ");
		sqlStr.append(" LEFT JOIN curso on turma.curso = curso.codigo ");
		sqlStr.append(" INNER JOIN gradecurricular on historico.matrizcurricular = gradecurricular.codigo  ");
		// sqlStr.append(" and case when cursoMatricula.niveleducacional in ('ME', 'IN', 'BA') then true else case when historico.matrizcurricular is null then true else historico.matrizcurricular = "+gradeCurricular+" end end ");
		// sqlStr.append(" and case when historico.matrizcurricular is null then true else historico.matrizcurricular = ").append(gradeCurricular).append(" end ");
		sqlStr.append(" left join gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		if (xmlDiploma) {
			sqlStr.append(" AND gradedisciplina.utilizaremissaoxmldiploma ");
		}
		/**
		 * Adicionada regra para caso grade disciplina seja nula utilize o periodo letivo da matriz curricular para resolver as disciplinas optativas.
		 */
//		sqlStr.append(" left JOIN periodoletivo on periodoletivo.codigo = gradedisciplina.periodoletivo ");
		sqlStr.append(" left JOIN periodoletivo on ((gradedisciplina.codigo is not null and periodoletivo.codigo = gradedisciplina.periodoletivo) or (gradedisciplina.codigo is null and periodoletivo.codigo = historico.periodoletivomatrizcurricular)) ");
		// sqlStr.append(" left JOIN gradecurriculargrupooptativa on gradecurriculargrupooptativa.gradecurricular = gradecurricular.codigo ");
		sqlStr.append(" left JOIN gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = historico.gradecurriculargrupooptativadisciplina ");
		if (xmlDiploma) {
			sqlStr.append(" AND gradecurriculargrupooptativadisciplina.utilizaremissaoxmldiploma ");
		}
		sqlStr.append(" LEFT JOIN configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico ");
		sqlStr.append(" LEFT join periodoletivo AS plmp on case when historico.periodoletivocursada is not null then  plmp.codigo = historico.periodoletivocursada else  plmp.codigo = matriculaPeriodo.periodoletivomatricula  end ");


		sqlStr.append(" left join disciplina as disciplinaEixoTematico on (gradedisciplina.disciplinaEixoTematico = disciplinaEixoTematico.codigo) ");
		sqlStr.append(" left join disciplinasaproveitadas on (disciplinasaproveitadas.codigo = historico.disciplinasaproveitadas) ");

		sqlStr.append(" left join transferenciaentradadisciplinasaproveitadas on (transferenciaentradadisciplinasaproveitadas.codigo = historico.transferenciaentradadisciplinasaproveitadas) ");
		sqlStr.append(" left join transferenciaentrada on (transferenciaentrada.codigo = transferenciaentradadisciplinasaproveitadas.transferenciaentrada) ");
		sqlStr.append(" left join cidade as cidadeAp on disciplinasaproveitadas.cidade = cidadeAp.codigo ");
		sqlStr.append(" left join estado as estadoAp on cidadeAp.estado = estadoAp.codigo ");
		sqlStr.append(" left join cidade as cidadeTrans on transferenciaentrada.cidade = cidadeTrans.codigo ");
		sqlStr.append(" left join estado as estadoTrans on cidadeTrans.estado = estadoTrans.codigo ");
		sqlStr.append(" left join cidade as cidadeHistorico on historico.cidade = cidadeHistorico.codigo ");
		sqlStr.append(" left join estado as estadoHistorico on cidadeHistorico.estado = estadoHistorico.codigo ");
		sqlStr.append(" left join ofertadisciplina on ofertadisciplina.disciplina = historico.disciplina and ofertadisciplina.ano = historico.anohistorico and ofertadisciplina.semestre = historico.semestrehistorico ");
		// }
		sqlStr.append(" WHERE historico.matricula = '").append(matricula).append("' ");
		if (!gradeCurricular.equals(0)) {
			sqlStr.append(" and gradeCurricular.codigo = ").append(gradeCurricular);
		}
		if (!apresentarDisciplinaForaGrade) {
			sqlStr.append(" and historico.historicodisciplinaforagrade is false ");
		}
		if (Uteis.isAtributoPreenchido(disciplina)) {
			sqlStr.append(" and historico.disciplina = ").append(disciplina);
		}
		sqlStr.append(" and (gradecurriculargrupooptativadisciplina.codigo is not null or gradedisciplina.codigo is not null or historicodisciplinaforagrade) ");
		sqlStr.append(" and (historicoequivalente = false or historicoequivalente is null) ");
		sqlStr.append(" and (historicodisciplinafazpartecomposicao = false or historicodisciplinafazpartecomposicao is null) ");
		sqlStr.append("and case when curso.periodicidade = 'IN' then historico.codigo = (select his.codigo from historico his ");
		sqlStr.append("where his.matricula = matricula.matricula and his.disciplina = disciplina.codigo ");
		sqlStr.append("and his.matrizcurricular = historico.matrizcurricular order by his.dataregistro desc, case when his.situacao in ('AP', 'AA', 'CC', 'CH', 'AE', 'AB', 'CS', 'CE') then 0 else 1 end, his.codigo desc limit 1) else true end ");
		// Traz no historico as disciplinas que não foram trancadas quando o
		// aluno estava com uma grade antiga
		// sqlStr.append(" and historico.disciplina not in ( ");
		// sqlStr.append(" select historicograde.disciplina from transferenciamatrizcurricular tr ");
		// sqlStr.append(" inner join historicograde on historicograde.transferenciamatrizcurricular = tr.codigo ");
		// sqlStr.append(" where tr.matricula = '").append(matricula).append("' and (historicograde.situacao in ('TR', 'RE','RF') ) and historico.situacao in ('TR', 'RE','RF') ");
		// sqlStr.append(" and historicograde.matriculaperiodo = historico.matriculaperiodo)");
		if(apresentarApenasUltimoHistoricoDisciplina){
			sqlStr.append(" and historico.codigo = (");
			sqlStr.append(" select his.codigo from historico his where his.matricula = historico.matricula ");
			sqlStr.append(" and his.disciplina = historico.disciplina");
			sqlStr.append(" and his.matrizcurricular = historico.matrizcurricular");
			sqlStr.append(" order by his.anohistorico desc, his.semestrehistorico desc, his.dataregistro desc, case when his.situacao in ('AP', 'AA', 'CC', 'CH', 'AE', 'AB', 'CS', 'CE') then 0 else 1 end, his.codigo desc limit 1");
			sqlStr.append(" ) ");
		}
		sqlStr.append(" GROUP BY  historicodisciplinaforagrade, tipoHistorico, totalfalta, historicoDisciplinaAtividadeComplementar, historico.observacao, cursoMatricula.niveleducacional, utilizaNotaFinalConceito, notaFinalConceito, mptd.turma, historico.cidade, matriculaPeriodo.codigo, matriculaperiodo.situacaomatriculaperiodo, historico.codigo, historico.matricula, historico.mediaFinal, historico.situacao, historico.freguencia, matriculaperiodo.ano, ");
		sqlStr.append(" mfc.codigo , mfc.conceitoNota , mfc.abreviaturaConceitoNota , mfc.situacao, historico.anohistorico, historico.semestrehistorico, historico.cargahorariadisciplina, historico.creditodisciplina,  ");
		sqlStr.append(" mfc.tipoNotaConceito , mfc.faixaNota1 , mfc.faixaNota2, mfc.configuracaoAcademico, plmp.codigo, disciplinaEixoTematico.nome, disciplinaEixoTematico.codigo, numeroAgrupamentoEquivalenciaDisciplina,  ");
		sqlStr.append(" matriculaperiodo.semestre, disciplina.cargahoraria, disciplina.codigo, disciplina.nome, gradedisciplina.cargaHoraria, gradedisciplina.nrcreditos, periodoletivo.codigo, periodoletivo.periodoletivo, unidadeEnsino.codigo, ");
		sqlStr.append(" mptd.disciplinaequivale, mptd.disciplina, plmp.periodoletivo,configuracaoacademico.apresentarPeriodoLetivoMatriculaPeriodoAtualHistorico, historico.instituicao, gradedisciplina.tipoDisciplina, cidade.nome, estado.sigla, unidadeensino.nome, ");
		sqlStr.append(" disciplinasaproveitadas.codigo, cidadeAp.nome, estadoAp.sigla, cidadeTrans.nome, estadoTrans.sigla, transferenciaentrada.codigo, transferenciaentrada.instituicaoOrigem,  ");
		sqlStr.append(" transferenciaentradadisciplinasaproveitadas.codigo,transferenciaentradadisciplinasaproveitadas.anoconclusaodisciplina, transferenciaentradadisciplinasaproveitadas.semestreconclusaodisciplina, ");
		sqlStr.append(" disciplinasaproveitadas.semestre, disciplinasaproveitadas.ano, mptd.codigo, cidadeTrans.codigo, cidadeAp.codigo, cidade.codigo, disciplinasaproveitadas.instituicao, cidadeHistorico.codigo, cidadeHistorico.nome, estadoHistorico.sigla, ");
		sqlStr.append(" transferenciaentradadisciplinasaproveitadas.cargahoraria, disciplinasaproveitadas.cargahoraria, historico.cargaHorariaAproveitamentoDisciplina, gradedisciplina.cargahoraria, historico.cidade, historico.cargaHorariaCursada, disciplinasaproveitadas.cargaHorariaCursada, historico.disciplinasaproveitadas, ");
		sqlStr.append(" gradedisciplina.diversificada, gradedisciplina.codigo, gradedisciplina.ordem, apresentarSiglaConcessaoCredito, gradecurriculargrupooptativadisciplina.cargahoraria, gradecurriculargrupooptativadisciplina.diversificada, gradecurriculargrupooptativadisciplina.nrCreditos, intervaloNotasDiferente, matricula.curso, matricula.turno, matricula.unidadeensino, matriculaperiodo.processomatricula, matriculaperiodo.unidadeensinocurso, turno.considerarhoraaulasessentaminutosgeracaodiario, ");
		sqlStr.append(" configuracaoacademico.codigo, configuracaoacademico.quantidadeCasasDecimaisPermitirAposVirgula, configuracaoacademico.apresentarTotalAulaRegistradaComoCargaHorariaCursadaNoHistorico, unidadeensino.nomeexpedicaodiploma, historico.transferenciamatrizcurricularmatricula,historico.historicoporequivalencia, historico.mapaequivalenciadisciplina, historico.matrizcurricular, gradedisciplina.cargahoraria, gradedisciplina.cargahorariapratica, historico.disciplinareferenteaumgrupooptativa, historico.historicodisciplinaoptativa,   ");
		sqlStr.append(" unidadeensinocurso.curso, unidadeensinocurso.turno, gradedisciplina.bimestre, mptd.bimestre, gradecurriculargrupooptativadisciplina.bimestre, ofertaDisciplina.periodo ");
		if (ordemHistoricoDisciplina > 0) {
			switch (OrdemHistoricoDisciplina.getEnum(ordemHistoricoDisciplina)) {
			case ANO_SEMESTRE:
				sqlStr.append(" ORDER BY anohistorico, semestrehistorico, disciplina_nome, periodoletivo.periodoletivo");
				break;
			case PERIODO_LETIVO:
				sqlStr.append(" ORDER BY periodoletivo.periodoletivo, disciplina_nome, anohistorico, semestrehistorico");
				break;
			case DATA_PROGRAMACAO:
				sqlStr.append(" ORDER BY data, periodoletivo.periodoletivo, disciplina_nome, anohistorico, semestrehistorico");
				break;
			default:
				break;
			}
		} else {
			sqlStr.append(" ORDER BY periodoletivo.periodoletivo, disciplina_nome, anohistorico, semestrehistorico");
		}
		sqlStr.append(") AS t ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		final List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			montarDadosDetalhadoConsultaPorMatriculaRel(obj, tabelaResultado, usuario);
			obj.getTransferenciaMatrizCurricularMatricula().setCodigo(tabelaResultado.getInt("transferenciamatrizcurricularmatricula"));
			obj.setNumeroAgrupamentoEquivalenciaDisciplina(tabelaResultado.getInt("numeroagrupamentoequivalenciadisciplina"));
			obj.getMapaEquivalenciaDisciplina().setCodigo(tabelaResultado.getInt("mapaequivalenciadisciplina"));
			obj.getMatrizCurricular().setCodigo(tabelaResultado.getInt("matrizcurricular"));
			obj.setHistoricoPorEquivalencia(tabelaResultado.getBoolean("historicoPorEquivalencia"));
			obj.setDataInicioAula(tabelaResultado.getDate("dataInicioAula"));
			obj.setDataFimAula(tabelaResultado.getDate("dataFimAula"));
			if(tabelaResultado.getObject("bimestre") != null) {
				obj.getGradeDisciplinaVO().setBimestre(tabelaResultado.getInt("bimestre"));
				obj.setBimestre(tabelaResultado.getInt("bimestre"));
			}
			if(tabelaResultado.getObject("gcgo_bimestre") != null) {
				obj.getGradeCurricularGrupoOptativaDisciplinaVO().setBimestre(tabelaResultado.getInt("gcgo_bimestre"));
				obj.setBimestre(tabelaResultado.getInt("gcgo_bimestre"));
			}
			if(obj.getBimestre() == null && tabelaResultado.getObject("ofertaDisciplina_periodo") != null) {
					BimestreEnum periodo = BimestreEnum.valueOf(tabelaResultado.getString("ofertaDisciplina_periodo"));
					switch (periodo) {
					case BIMESTRE_01:
						obj.setBimestre(1);
						break;
					case BIMESTRE_02:
						obj.setBimestre(2);
						break;
					case BIMESTRE_03:
						obj.setBimestre(1);
						break;
					case BIMESTRE_04:
						obj.setBimestre(2);
						break;					
					default:
						obj.setBimestre(0);
						break;
					}								
			}
			if(tabelaResultado.getObject("mptd_bimestre") != null) {
				obj.getMatriculaPeriodoTurmaDisciplina().setBimestre(tabelaResultado.getInt("mptd_bimestre"));
				obj.setBimestre(tabelaResultado.getInt("mptd_bimestre"));
			}
			vetResultado.add(obj);
		}
		final ConsistirException consistirException = new ConsistirException();
		ProcessarParalelismo.executar(0, vetResultado.size(), consistirException, new ProcessarParalelismo.Processo() {
			@Override
			public void run(int i) {
				HistoricoVO historicoVO = vetResultado.get(i);
				carregarDadosHorarioAulaAluno(historicoVO, true);
			}
		});
		return vetResultado;
	}

	public int consultaTotalCargaHorariaMatricula(String matricula, Integer gradeCurricular, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append(" SELECT sum(cargahorariadisciplina) as total ");
		sqlStr.append(" FROM (");
		sqlStr.append(" SELECT distinct historico.disciplina, case when (historico.situacao = 'AA' and (historico.cargahorariaaproveitamentodisciplina is not null and historico.cargahorariaaproveitamentodisciplina > 0)) then historico.cargahorariaaproveitamentodisciplina ");
		sqlStr.append(" when (historico.cargahorariadisciplina is not null and historico.cargahorariadisciplina > 0) then historico.cargahorariadisciplina");
		sqlStr.append(" else gradedisciplina.cargahoraria end as cargahorariadisciplina");
		sqlStr.append(" FROM historico ");
		sqlStr.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina mptd on mptd.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		sqlStr.append(" inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo ");
		sqlStr.append(" inner join matricula on historico.matricula = matricula.matricula ");
		sqlStr.append(" INNER JOIN gradecurricular on historico.matrizcurricular = gradecurricular.codigo  ");
		sqlStr.append(" left join gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		sqlStr.append(" left JOIN gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = historico.gradecurriculargrupooptativadisciplina ");
		sqlStr.append(" WHERE historico.matricula = '").append(matricula).append("' ");
		if (!gradeCurricular.equals(0)) {
			sqlStr.append(" and gradeCurricular.codigo = ").append(gradeCurricular);
		}
		sqlStr.append(" and (gradecurriculargrupooptativadisciplina.codigo is not null or gradedisciplina.codigo is not null or historicodisciplinaforagrade) ");
		sqlStr.append(" and (historicoequivalente = false or historicoequivalente is null) ");
		sqlStr.append(" and (historicodisciplinafazpartecomposicao = false or historicodisciplinafazpartecomposicao is null) ");
		sqlStr.append(" and historico.situacao not in ('RE', 'RF', 'CS')");
		sqlStr.append(") AS t ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		while (tabelaResultado.next()) {
			return tabelaResultado.getInt("total");
		}
		return 0;
	}

	public Boolean getAprovado(String situacao) {
		List<SituacaoHistorico> tagList = SituacaoHistorico.getSituacoesDeAprovacao();
		for (SituacaoHistorico sit : tagList) {
			if (sit.getValor().equals(situacao)) {
				return Boolean.TRUE;
			}
		}
		return Boolean.FALSE;

	}

	public void consultaRapidaPorMatriculaHistoricoDisciplinaACursar(String matricula, int ordemHistoricoDisciplina, List<HistoricoAlunoDisciplinaRelVO> lista, boolean utilizarNomeCertificacaoPeriodoLetivo, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append(" select periodoletivo.periodoletivo as periodoletivo_periodoletivo, gradedisciplina.codigo as gradedisciplina_codigo, gradedisciplina.cargahoraria as gradedisciplina_cargahoraria, gradedisciplina.tipodisciplina as gradedisciplina_tipodisciplina, ");
		sqlStr.append(" gradedisciplina.diversificada as gradedisciplina_diversificada, gradedisciplina.nrcreditos as gradedisciplina_nrcreditos,gradedisciplina.tipodisciplina as gradedisciplina_tipodisciplina, ");
		sqlStr.append(" matricula.matricula, unidadeensino.codigo as unidadeensino_codigo,disciplina.codigo as disciplina_codigo,disciplina.nome as disciplina_nome,  disciplina.abreviatura as disciplina_abreviatura , ");
		sqlStr.append(" periodoletivo.nomecertificacao as periodoletivo_nomecertificacao, periodoletivo.descricao as periodoletivo_descricao from matricula ");
		sqlStr.append(" inner join gradecurricular on gradecurricular.codigo = gradecurricularatual ");
		sqlStr.append(" inner join periodoletivo on periodoletivo.gradecurricular = gradecurricular.codigo ");
		sqlStr.append(" inner join gradedisciplina on gradedisciplina.periodoletivo = periodoletivo.codigo ");
		sqlStr.append(" inner join disciplina on disciplina.codigo = gradedisciplina.disciplina ");
		sqlStr.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino ");
		sqlStr.append(" where matricula.matricula = '").append(matricula).append("' ");
		sqlStr.append(" and not exists (select his.codigo from historico his where his.matricula = matricula.matricula and his.matrizcurricular = matricula.gradecurricularatual ");
		sqlStr.append("                 and his.gradedisciplina = gradedisciplina.codigo and his.situacao in ('AA','CC','IS','CH','AE','AB','CS','CE','CO','AP')) ");
		if (ordemHistoricoDisciplina > 0) {
			switch (OrdemHistoricoDisciplina.getEnum(ordemHistoricoDisciplina)) {
			case ANO_SEMESTRE:
				sqlStr.append(" ORDER BY periodoletivo.periodoletivo, disciplina.nome");
				break;
			case PERIODO_LETIVO:
				sqlStr.append(" ORDER BY periodoletivo.periodoletivo, disciplina.nome");
				break;
			case DATA_PROGRAMACAO:
				sqlStr.append(" ORDER BY periodoletivo.periodoletivo, disciplina.nome");
				break;
			default:
				break;
			}
		} else {
			sqlStr.append(" ORDER BY periodoletivo.periodoletivo, disciplina.nome");
		}
		sqlStr.append(" ");

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		while (tabelaResultado.next()) {
			HistoricoAlunoDisciplinaRelVO obj = new HistoricoAlunoDisciplinaRelVO();
			montarDadosDetalhadoConsultaPorMatriculaRelDisciplinaACursar(obj, tabelaResultado, utilizarNomeCertificacaoPeriodoLetivo, usuario);
			lista.add(obj);
		}
	}

	public List<HistoricoVO> consultaRapidaPorMatriculaHistoricoTransferenciaMatrizCurricular(String matricula, Integer gradeCurricular, Boolean xmlDiploma, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("select distinct tr.matricula, historicograde.mediafinal, historicograde.situacao, historicograde.frequencia, matriculaperiodo.ano, matriculaperiodo.semestre, disciplina.codigo AS \"disciplina.codigo\",");
		sb.append(" case when disciplinaEixoTematico.codigo is null then disciplina.nome else disciplinaEixoTematico.nome end AS \"disciplina.nome\", gradedisciplina.tipodisciplina,  matricula.unidadeensino, periodoletivo.periodoletivo, ");
		sb.append(" periodoletivo.codigo as \"periodoletivo.codigo\", gradedisciplina.cargahoraria as gradedisciplina_cargahorariaTotal, gradedisciplina.cargahorariapratica as gradedisciplina_cargahorariapratica,");
		// Busca a instituicaoEnsino de acordo com a origem do historico
		// (Aproveitamento de Disciplina, Transferencia de Entrada ou a Unidade
		// de Ensino da Matrícula)
		sb.append(" case when (transferenciaentrada.codigo is not null and transferenciaentrada.instituicaoOrigem is not null and transferenciaentrada.instituicaoOrigem != '' ) then transferenciaentrada.instituicaoOrigem else ");
		sb.append(" case when (disciplinasaproveitadas.codigo is not null and disciplinasaproveitadas.instituicao is not null and disciplinasaproveitadas.instituicao != '' ) then disciplinasaproveitadas.instituicao else ");
		sb.append(" case when (historicograde.instituicao = '' or historicograde.instituicao is null) then  unidadeEnsino.nomeExpedicaoDiploma else historicograde.instituicao end end end as instituicao, ");

		// Busca a cidade de acordo com a origem do historico (Aproveitamento de
		// Disciplina, Transferencia de Entrada ou a Unidade de Ensino da
		// Matrícula)
		sb.append(" case when (transferenciaentrada.codigo is not null and transferenciaentrada.instituicaoOrigem is not null and transferenciaentrada.instituicaoOrigem != '' ) then cidadeTrans.nome else ");
		sb.append(" case when (disciplinasaproveitadas.codigo is not null and disciplinasaproveitadas.instituicao is not null and disciplinasaproveitadas.instituicao != '' ) then cidadeAp.nome else ");
		sb.append(" case when (historicograde.situacao in ('AA', 'CC') and historicograde.cidade is not null) then cidadeHistorico.nome else cidade.nome end end end as cidade, ");
		// Busca a cidade de acordo com a origem do historico (Aproveitamento de
		// Disciplina, Transferencia de Entrada ou a Unidade de Ensino da
		// Matrícula)
		sb.append(" case when (transferenciaentrada.codigo is not null and transferenciaentrada.instituicaoOrigem is not null and transferenciaentrada.instituicaoOrigem != '' ) then cidadeTrans.codigo else ");
		sb.append(" case when (disciplinasaproveitadas.codigo is not null and disciplinasaproveitadas.instituicao is not null and disciplinasaproveitadas.instituicao != '' ) then cidadeAp.codigo else ");
		sb.append(" case when (historicograde.situacao in ('AA', 'CC') and historicograde.cidade is not null) then cidadeHistorico.codigo else cidade.codigo end end end as codigoCidade, ");
		// Busca a estado de acordo com a origem do historico (Aproveitamento de
		// Disciplina, Transferencia de Entrada ou a Unidade de Ensino da
		// Matrícula)
		sb.append(" case when (transferenciaentrada.codigo is not null and transferenciaentrada.instituicaoOrigem is not null and transferenciaentrada.instituicaoOrigem != '' ) then estadoTrans.sigla else ");
		sb.append(" case when (disciplinasaproveitadas.codigo is not null and disciplinasaproveitadas.instituicao is not null and disciplinasaproveitadas.instituicao != '' ) then estadoAp.sigla else ");
		sb.append(" case when (historicograde.situacao in ('AA', 'CC') and historicograde.cidade is not null) then estadoHistorico.sigla else estado.sigla end end end as estado, ");

		// Define o ano a ser apresentado conforme a origem do historico
		// (Aproveitamento de Disciplina, Transferencia de Entrada ou a Ano da
		// MatrículaPeriodo)
		sb.append(" case when (transferenciaentradadisciplinasaproveitadas.codigo is not null ) then transferenciaentradadisciplinasaproveitadas.anoconclusaodisciplina else ");
		sb.append(" case when (disciplinasaproveitadas.codigo is not null) then disciplinasaproveitadas.ano else ");
		sb.append(" case when historicograde.anohistorico is null or historicograde.anohistorico = '' then matriculaperiodo.ano else historicograde.anohistorico end end end as anohistorico, ");
		// Define o semestre a ser apresentado conforme a origem do historico
		// (Aproveitamento de Disciplina, Transferencia de Entrada ou a semestre
		// da MatrículaPeriodo)
		sb.append(" case when (transferenciaentradadisciplinasaproveitadas.codigo is not null ) then transferenciaentradadisciplinasaproveitadas.semestreconclusaodisciplina else ");
		sb.append(" case when (disciplinasaproveitadas.codigo is not null) then disciplinasaproveitadas.semestre else ");
		sb.append(" case when historicograde.semestrehistorico is null or historicograde.semestrehistorico = '' then matriculaperiodo.semestre else historicograde.semestrehistorico end end end as semestrehistorico, ");

		/**
		 * Define a origem da carga horaria (Disciplinas Aproveitadas,
		 * Transferencia de Entrada ou Historico ou Disciplina)
		 */
		sb.append(" case when (transferenciaentradadisciplinasaproveitadas.codigo is not null ) then transferenciaentradadisciplinasaproveitadas.cargahoraria::INT else ");
		sb.append(" case when (disciplinasaproveitadas.codigo is not null) then disciplinasaproveitadas.cargahoraria else ");
		sb.append(" case when (historicograde.situacao in ('AA', 'CC') and historicograde.cargaHorariaAproveitamentoDisciplina is not null and historicograde.cargaHorariaAproveitamentoDisciplina > 0) then historicograde.cargaHorariaAproveitamentoDisciplina else gradedisciplina.cargahoraria end end end as cargaHoraria, ");

		/**
		 * Define a origem da carga horaria cursada (Disciplinas Aproveitadas,
		 * Transferencia de Entrada ou Historico ou Disciplina)
		 */
		sb.append(" case when (disciplinasaproveitadas.codigo is not null) then disciplinasaproveitadas.cargaHorariaCursada else ");
		sb.append(" case when (historicograde.cargaHorariaCursada is not null and historicograde.cargaHorariaCursada > 0) then historicograde.cargaHorariaCursada else ((gradedisciplina.cargahoraria*historicograde.frequencia)/100)::INT end end as cargaHorariaCursada ");

		sb.append(" from historicograde ");
		sb.append(" inner join transferenciamatrizcurricular tr on tr.codigo = historicograde.transferenciamatrizcurricular ");
		sb.append(" inner join disciplina on (disciplina.codigo = historicograde.disciplina or disciplina.codigo = historicograde.disciplinaequivalente) ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.codigo = historicograde.matriculaperiodo ");
		sb.append(" inner join matricula on matricula.matricula = tr.matricula ");
		sb.append(" inner join unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeEnsino ");
		sb.append(" left join cidade on cidade.codigo = unidadeEnsino.cidade ");
		sb.append(" left join estado on estado.codigo = cidade.estado ");
		sb.append(" inner join gradecurricular on gradecurricular.codigo = tr.gradeorigem ");
		sb.append(" inner join periodoletivo on periodoletivo.gradecurricular = gradecurricular.codigo ");
		sb.append(" inner join gradedisciplina on gradedisciplina.disciplina = disciplina.codigo and gradedisciplina.periodoletivo = periodoletivo.codigo ");
		if (xmlDiploma) {
			sb.append(" AND gradedisciplina.utilizaremissaoxmldiploma ");
		}
		sb.append(" left join disciplina as disciplinaEixoTematico on (gradedisciplina.disciplinaEixoTematico = disciplinaEixoTematico.codigo) ");

		sb.append(" left join disciplinasaproveitadas on (disciplinasaproveitadas.codigo = historicograde.disciplinasaproveitadas) ");
		sb.append(" left join cidade as cidadeAp on disciplinasaproveitadas.cidade = cidadeAp.codigo ");
		sb.append(" left join estado as estadoAp on cidadeAp.estado = estadoAp.codigo ");
		sb.append(" left join transferenciaentradadisciplinasaproveitadas on (transferenciaentradadisciplinasaproveitadas.codigo = historicograde.transferenciaentradadisciplinaaproveitada) ");
		sb.append(" left join transferenciaentrada on (transferenciaentrada.codigo = transferenciaentradadisciplinasaproveitadas.transferenciaentrada) ");
		sb.append(" left join cidade as cidadeTrans on transferenciaentrada.cidade = cidadeTrans.codigo ");
		sb.append(" left join estado as estadoTrans on cidadeTrans.estado = estadoTrans.codigo ");
		sb.append(" left join cidade as cidadeHistorico on historicograde.cidade = cidadeHistorico.codigo ");
		sb.append(" left join estado as estadoHistorico on cidadeHistorico.estado = estadoHistorico.codigo ");

		sb.append(" where tr.gradeorigem = ").append(gradeCurricular);
		sb.append(" and tr.matricula = '").append(matricula).append("' ");
		// Ficou definido(Alex FASUG) que somente irá trazer historico com
		// situação trancada quando não for grade atual
		// sb.append(" and case when (select count(tra.codigo) from historicograde hg");
		// sb.append(" inner join transferenciamatrizcurricular tra on tra.codigo = hg.transferenciamatrizcurricular  ");
		// sb.append(" where tra.grademigrar = ").append(gradeCurricular).append(") > 0 then historicograde.situacao <> 'TR' and historicograde.situacao <> 'RE' ");
		// sb.append(" else historicograde.situacao <> 'CA' end ");
		sb.append(" ORDER BY anohistorico, semestrehistorico, \"disciplina.nome\", periodoletivo.periodoletivo");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			montarDadosDetalhadoConsultaPorMatriculaRelTransferenciaMatrizCurricular(obj, tabelaResultado, usuarioVO);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<HistoricoVO> consultaHistoricoDisciplinasForaGradeRapidaPorMatricula(MatriculaVO matriculaVO, int ordemHistoricoDisciplina, boolean controlarAcesso, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append(" SELECT DISTINCT   ");
		sqlStr.append(" disciplinasaproveitadas.ano AS ano, disciplinasaproveitadas.semestre AS semestre,");
		sqlStr.append(" disciplinasaproveitadas.disciplina AS disciplinaCodigo, ");
		sqlStr.append(" disciplinasaproveitadas.nota AS nota, ");
		sqlStr.append(" disciplinasaproveitadas.instituicao AS instituicao, ");
		sqlStr.append(" cidade.nome AS cidade, ");
		sqlStr.append(" estado.sigla AS estado, ");
		sqlStr.append(" disciplinasaproveitadas.frequencia AS frequencia, ");
		sqlStr.append(" disciplina.nome AS disciplinaNome, ");
		sqlStr.append(" case when disciplinasaproveitadas.cargaHoraria is not null and disciplinasaproveitadas.cargaHoraria > 0 then disciplinasaproveitadas.cargaHoraria else gradedisciplina.cargaHoraria end AS cargaHoraria, ");
		sqlStr.append(" aproveitamentodisciplina.unidadeensino AS unidadeensino, ");
		sqlStr.append(" periodoletivo.periodoletivo AS periodoletivo, ");
		sqlStr.append(" periodoletivo.codigo AS codigoPeriodoLetivo, ");
		sqlStr.append(" disciplinasaproveitadas.cargaHorariaCursada AS cargaHorariaCursada ");
		sqlStr.append(" FROM aproveitamentodisciplina ");

		sqlStr.append(" inner join disciplinasaproveitadas on disciplinasaproveitadas.aproveitamentodisciplina = aproveitamentodisciplina.codigo ");
		sqlStr.append(" left join cidade on disciplinasaproveitadas.cidade = cidade.codigo ");
		sqlStr.append(" left join estado on cidade.estado = estado.codigo ");
		sqlStr.append(" inner join disciplina on disciplinasaproveitadas.disciplina = disciplina.codigo ");
		sqlStr.append(" left join matriculaperiodo on aproveitamentodisciplina.matriculaperiodo = matriculaperiodo.codigo ");
		sqlStr.append(" left join gradecurricular on matriculaperiodo.gradecurricular = gradecurricular.codigo");
		sqlStr.append(" left join periodoletivo on periodoletivo.gradecurricular = gradecurricular.codigo ");
		sqlStr.append(" left join gradedisciplina on gradedisciplina.codigo = disciplina.codigo and gradedisciplina.periodoletivo = periodoletivo.codigo ");
		sqlStr.append(" WHERE aproveitamentodisciplina.matricula = '").append(matriculaVO.getMatricula()).append("' ");
		sqlStr.append(" AND disciplinasaproveitadas.disciplinaforagrade = true ");
		if (ordemHistoricoDisciplina > 0) {
			switch (OrdemHistoricoDisciplina.getEnum(ordemHistoricoDisciplina)) {
			case ANO_SEMESTRE:
				sqlStr.append(" ORDER BY disciplinasaproveitadas.ano, disciplinasaproveitadas.semestre, disciplina.nome ");
				break;
			case PERIODO_LETIVO:
				sqlStr.append(" ORDER BY periodoletivo.periodoletivo, disciplina.nome, disciplinasaproveitadas.ano, disciplinasaproveitadas.semestre");
				break;
			default:
				sqlStr.append(" ORDER BY disciplina.nome ");

			}
		} else {
			sqlStr.append(" ORDER BY periodoletivo.periodoletivo, disciplina.nome, disciplinasaproveitadas.ano, disciplinasaproveitadas.semestre");
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			obj.setMatricula(matriculaVO);
			montarDadosDetalhadoConsultaPorMatriculaRelDisciplinasForaGrade(obj, tabelaResultado, usuario);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<HistoricoVO> consultaRapidaPorMatriculaPeriodoTurmaDisciplina(Integer matriculaPeriodoTurmaDisciplina, boolean controlarAcesso, NivelMontarDados nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT DISTINCT  historico.* " + " FROM historico " + "WHERE matriculaPeriodoTurmaDisciplina = " + matriculaPeriodoTurmaDisciplina;
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			obj = montarDados(tabelaResultado, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiroVO, usuario);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public Boolean consultaNumeroDisciplinasReprovadasAlunoMaiorPermitido(Integer matriculaPeriodo, String valorConsulta, Integer periodoLetivo, Integer numeroDisciplinasReprovadasPermitido, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT count(historico.codigo) FROM historico ");
		sqlStr.append(" INNER JOIN  matricula        ON matricula.matricula              = historico.matricula ");
		sqlStr.append(" INNER JOIN matriculaperiodo  ON matriculaperiodo.codigo          = historico.matriculaperiodo ");
		sqlStr.append(" INNER JOIN gradecurricular   ON matriculaperiodo.gradecurricular = gradecurricular.codigo ");
		sqlStr.append(" INNER JOIN periodoletivo     ON periodoletivo.gradecurricular    = gradecurricular.codigo ");
		sqlStr.append("WHERE historico.matricula = '").append(valorConsulta).append("' AND periodoletivo.periodoletivo = ").append(periodoLetivo);
		sqlStr.append(" AND  matricula.gradecurricularatual = historico.matrizcurricular ");
		sqlStr.append(" AND matriculaperiodo.codigo = ").append(matriculaPeriodo);
		sqlStr.append(" AND (historico.situacao = 'RE' or historico.situacao = 'RF') ");
		sqlStr.append(" HAVING count(historico.codigo) >= ").append(numeroDisciplinasReprovadasPermitido);

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return Boolean.TRUE;
		}
		return Boolean.FALSE;
	}

	public List<HistoricoVO> consultaRapidaPorMatriculaGradeCurricularesEMatriculaPeriodosSomenteDisciplinasDaGradeParaExclusaoForaPrazo(String valorConsulta, List<MatriculaPeriodoVO> listaMatriculaPeriodoVO, int ordemHistoricoDisciplina, boolean controlarAcesso, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String and = " and (";
		StringBuilder sqlStr = new StringBuilder("select DISTINCT  historico.*, ");
		sqlStr.append(" mp2.ano, mp2.semestre, disciplina.codigo AS \"disciplina.codigo\",  disciplina.nome AS \"disciplina.nome\", ");
		sqlStr.append(" turma.identificadorTurma AS \"turma.identificadorTurma\", configuracaoacademico.intervaloNotasDiferente ");
		sqlStr.append(" from historico");
		sqlStr.append(" inner join disciplina on disciplina.codigo = historico.disciplina");
		sqlStr.append(" inner join matriculaperiodo mp2 on mp2.codigo = historico.matriculaperiodo");
		sqlStr.append(" inner join matricula on matricula.matricula = mp2.matricula");
		sqlStr.append(" left join matriculaperiodoturmadisciplina mptd on mptd.codigo = historico.matriculaperiodoturmadisciplina");
		sqlStr.append(" left join turma on turma.codigo = mptd.turma");
		sqlStr.append(" left join configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico");
		sqlStr.append(" where mp2.matricula = '").append(valorConsulta).append("' ");
		sqlStr.append(" and historico.matrizcurricular = matricula.gradecurricularatual");
		for (MatriculaPeriodoVO matriculaPeriodo : listaMatriculaPeriodoVO) {
			sqlStr.append(and).append(" mp2.codigo = ").append(matriculaPeriodo.getCodigo());
			and = " or ";
		}
		if (and.equals(" or ")) {
			sqlStr.append(") ");
		}
		sqlStr.append(" and (historico.historicodisciplinafazpartecomposicao is null or historico.historicodisciplinafazpartecomposicao = false) ");
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		sqlStr.append(" and historico.situacao not in ('AA', 'CC', 'CH', 'IS') ");
		switch (OrdemHistoricoDisciplina.getEnum(ordemHistoricoDisciplina)) {
		case ANO_SEMESTRE:
			sqlStr.append(" ORDER BY mp2.ano, mp2.semestre, disciplina.nome");
			break;
		case PERIODO_LETIVO:
			sqlStr.append(" ORDER BY disciplina.nome, mp2.ano, mp2.semestre");
			break;
		default:
			break;
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			montarDadosDetalhadoConsultaPorMatricula2(obj, tabelaResultado, usuario);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	/*
	 * Usado pelo montarDadosDetalhadoConsultaPorMatricula
	 */
	public void getSqlBaseConsultaDetalhadoPorMatricula(StringBuilder sqlStr, boolean joinCTE){
		sqlStr.append(" SELECT historico.*, historico.observacao AS \"historico.observacao\", historico.historicoDisciplinaAtividadeComplementar AS \"historico.historicoDisciplinaAtividadeComplementar\", ");
		sqlStr.append(" historico.cargaHorariaDisciplina AS \"historico.cargaHorariaDisciplina\", historico.creditoDisciplina AS \"historico.creditoDisciplina\", historico.historicoDisciplinaOptativa AS \"historico.historicoDisciplinaOptativa\", ");
		sqlStr.append(" historico.historicoDisciplinaForaGrade AS \"historico.historicoDisciplinaForaGrade\", historico.nomeDisciplina AS \"historico.nomeDisciplina\", historico.historicoDisciplinaAproveitada AS \"historico.historicoDisciplinaAproveitada\", ");
		sqlStr.append(" historico.faltaPrimeiroBimestre AS \"historico.faltaPrimeiroBimestre\", historico.faltaSegundoBimestre AS \"historico.faltaSegundoBimestre\", historico.faltaTerceiroBimestre AS \"historico.faltaTerceiroBimestre\", historico.faltaQuartoBimestre AS \"historico.faltaQuartoBimestre\", ");
		sqlStr.append(" historico.totalFalta AS \"historico.totalFalta\", historico.utilizaNotaFinalConceito AS \"historico.utilizaNotaFinalConceito\", historico.notaFinalConceito AS \"historico.notaFinalConceito\", historico.transferenciaMatrizCurricularMatricula AS \"historico.transferenciaMatrizCurricularMatricula\", ");
		sqlStr.append(" historico.historicoGeradoAPartirTransferenciaMatrizCurricular AS \"historico.historicoGeradoAPartirTransferenciaMatrizCurricular\", historico.observacaoTransferenciaMatrizCurricular AS \"historico.observacaoTransferenciaMatrizCurricular\", ");
		sqlStr.append(" historico.historicoCursandoPorCorrespondenciaAposTransferencia AS \"historico.historicoCursandoPorCorrespondenciaAposTransferencia\", ");
				// Dados do Periodo Letivo Matriz Curricular
		sqlStr.append(" periodoLetivoMatrizCurricular.codigo AS \"periodoLetivoMatrizCurricular.codigo\", " + "periodoLetivoMatrizCurricular.descricao AS \"periodoLetivoMatrizCurricular.descricao\", ");
		sqlStr.append(" periodoLetivoMatrizCurricular.periodoLetivo AS \"periodoLetivoMatrizCurricular.periodoLetivo\", ");
				// Dados da Matriz Curricular
		sqlStr.append(" matrizCurricular.codigo AS \"matrizCurricular.codigo\", matrizCurricular.nome AS \"matrizCurricular.nome\", matricula.gradecurricularatual, ");
				// Dados do Periodo Letivo Cursada
		sqlStr.append(" periodoLetivoCursada.codigo AS \"periodoLetivoCursada.codigo\", periodoLetivoCursada.descricao AS \"periodoLetivoCursada.descricao\", periodoLetivoCursada.periodoLetivo AS \"periodoLetivoCursada.periodoLetivo\", ");
		sqlStr.append(" periodoletivo.codigo AS \"periodoletivo.codigo\", periodoletivo.periodoletivo AS \"periodoletivo.periodoletivo\", ");
		sqlStr.append(" matriculaperiodo.ano, matriculaperiodo.semestre, ");
				// DADOS DA DISCIPLINA
		sqlStr.append(" disciplina.codigo AS \"disciplina.codigo\",  disciplina.nome AS \"disciplina.nome\",   disciplina.classificacaoDisciplina AS \"disciplina.classificacaoDisciplina\", disciplina.abreviatura \"disciplina.abreviatura\", ");
				// DISCIPLINA COMPOSTA E EQUIVALENCIA
		sqlStr.append(" historico.historicoPorEquivalencia AS \"historico.historicoPorEquivalencia\", historico.historicoEquivalente AS \"historico.historicoEquivalente\", ");
		sqlStr.append(" historico.gradeDisciplinaComposta AS \"historico.gradeDisciplinaComposta\", " + " historico.historicoDisciplinaComposta AS \"historico.historicoDisciplinaComposta\", ");
		sqlStr.append(" historico.mapaEquivalenciaDisciplina AS \"historico.mapaEquivalenciaDisciplina\", historico.mapaEquivalenciaDisciplinaCursada AS \"historico.mapaEquivalenciaDisciplinaCursada\", ");
		sqlStr.append(" historico.mapaEquivalenciaDisciplinaMatrizCurricular AS \"historico.mapaEquivalenciaDisciplinaMatrizCurricular\", ");
				// Dados da Grade Disciplina
		sqlStr.append(" gradedisciplina.codigo AS \"gradedisciplina.codigo\",  gradedisciplina.periodoLetivo AS \"gradedisciplina.periodoLetivo\", gradedisciplina.disciplina AS \"gradedisciplina.disciplina\", ");
		sqlStr.append(" gradedisciplina.cargaHoraria AS \"gradedisciplina.cargaHoraria\", gradedisciplina.nrCreditos AS \"gradedisciplina.nrCreditos\", ");
		sqlStr.append(" gradedisciplina.diversificada AS \"gradedisciplina.diversificada\", gradedisciplina.disciplinaComposta AS \"gradedisciplina.disciplinaComposta\", ");
		sqlStr.append(" gradedisciplina.disciplinaEixoTematico AS \"gradedisciplina.disciplinaEixoTematico\", ");
		sqlStr.append(" gradedisciplina.horaaula as \"gradedisciplina.horaAula\", ");
				// Dados da Grade Curricular Grupo Optativa Disciplina
				// (GradeCurricularGrupoOptativaDisciplina)
		sqlStr.append(" historico.gradeCurricularGrupoOptativaDisciplina AS \"historico.gradeCurricularGrupoOptativaDisciplina\",  historico.disciplinaReferenteAUmGrupoOptativa AS \"historico.disciplinaReferenteAUmGrupoOptativa\",  ");
		sqlStr.append(" gradeCurricularGrupoOptativaDisciplina.codigo AS \"gradeCurricularGrupoOptativaDisciplina.codigo\", gradeCurricularGrupoOptativaDisciplina.disciplina AS \"gradeCurricularGrupoOptativaDisciplina.disciplina\", ");
		sqlStr.append(" gradeCurricularGrupoOptativaDisciplina.cargaHoraria AS \"gradeCurricularGrupoOptativaDisciplina.cargaHoraria\",  gradeCurricularGrupoOptativaDisciplina.nrCreditos AS \"gradeCurricularGrupoOptativaDisciplina.nrCreditos\", ");
		sqlStr.append(" gradeCurricularGrupoOptativaDisciplina.diversificada AS \"gradeCurricularGrupoOptativaDisciplina.diversificada\", gradeCurricularGrupoOptativaDisciplina.disciplinaComposta AS \"gradeCurricularGrupoOptativaDisciplina.disciplinaComposta\", ");
		sqlStr.append(" gradeCurricularGrupoOptativaDisciplina.horaaula as \"gcgod.horaAula\", ");
		sqlStr.append(" configuracaoacademico.intervaloNotasDiferente, ");
		//Dados Matricula Periodo Turma Disciplina
		sqlStr.append(" mptd.codigo as \"mptd.codigo\", mptd.bimestre as \"mptd.bimestre\", mptd.matriculaPeriodo as \"mptd.matriculaPeriodo\", mptd.turma as \"mptd.turma\", ");
		sqlStr.append(" mptd.disciplina as \"mptd.disciplina\", mptd.conteudo as \"mptd.conteudo\", mptd.ano as \"mptd.ano\", ");
		sqlStr.append(" mptd.modalidadeDisciplina as \"mptd.modalidadeDisciplina\", mptd.semestre as \"mptd.semestre\", mptd.matricula as \"mptd.matricula\", ");
		sqlStr.append(" mptd.disciplinaIncluida as \"mptd.disciplinaIncluida\", mptd.disciplinaEquivale as \"mptd.disciplinaEquivale\", mptd.permiteEscolherModalidade as \"mptd.permiteEscolherModalidade\", ");
		sqlStr.append(" mptd.disciplinaFazParteComposicao as \"mptd.disciplinaFazParteComposicao\", mptd.reposicao as \"mptd.reposicao\", mptd.inclusaoForaPrazo as \"mptd.inclusaoForaPrazo\", ");
		sqlStr.append(" mptd.disciplinaPorEquivalencia as \"mptd.disciplinaPorEquivalencia\", mptd.gradeDisciplinaComposta as \"mptd.gradeDisciplinaComposta\", mptd.disciplinaEmRegimeEspecial as \"mptd.disciplinaEmRegimeEspecial\", ");
		sqlStr.append(" mptd.disciplinaOptativa as \"mptd.disciplinaOptativa\", mptd.disciplinaReferenteAUmGrupoOptativa as \"mptd.disciplinaReferenteAUmGrupoOptativa\", mptd.gradeCurricularGrupoOptativaDisciplina as \"mptd.gradeCurricularGrupoOptativaDisciplina\", ");
		sqlStr.append(" mptd.gradeDisciplina as \"mptd.gradeDisciplina\", mptd.mapaEquivalenciaDisciplina as \"mptd.mapaEquivalenciaDisciplina\", mptd.mapaEquivalenciaDisciplinaCursada as \"mptd.mapaEquivalenciaDisciplinaCursada\", ");
		sqlStr.append(" mptd.transferenciaMatrizCurricularMatricula as \"mptd.transferenciaMatrizCurricularMatricula\", mptd.disciplinaCursandoPorCorrespondenciaAposTransferencia as \"mptd.disciplinaCursandoPorCorrespondenciaAposTransferencia\", ");
		sqlStr.append(" mptd.professor as \"mptd.professor\", mptd.turmaTeorica as \"mptd.turmaTeorica\", mptd.turmaPratica as \"mptd.turmaPratica\", ");
		//dados turma
		sqlStr.append(" turma.identificadorturma as \"turma.identificadorturma\", ");
		//dados turma pratica
		sqlStr.append(" turmapratica.identificadorturma as \"turmapratica.identificadorturma\", ");
		//dados turma teorica
		sqlStr.append(" turmateorica.identificadorturma as \"turmateorica.identificadorturma\" ");
		if (joinCTE) {
			sqlStr.append(" FROM cte_historicos INNER JOIN historico ON cte_historicos.codigo = historico.codigo ");
			sqlStr.append(" inner join matricula on matricula.matricula = historico.matricula ");
		} else {
			sqlStr.append(" FROM historico inner join matricula on matricula.matricula = historico.matricula ");
		}
		sqlStr.append(" inner join disciplina on disciplina.codigo = historico.disciplina  inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo");
		sqlStr.append(" inner join gradecurricular on matriculaperiodo.gradecurricular = gradecurricular.codigo left join periodoletivo on periodoletivo.codigo = historico.periodoLetivoMatrizCurricular ");
		sqlStr.append(" left join configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico LEFT join gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		sqlStr.append(" LEFT JOIN periodoLetivo as periodoLetivoMatrizCurricular on historico.periodoLetivoMatrizCurricular = periodoLetivoMatrizCurricular.codigo ");
		sqlStr.append(" LEFT JOIN periodoLetivo as periodoLetivoCursada on historico.periodoLetivoCursada = periodoLetivoCursada.codigo ");
		sqlStr.append(" LEFT JOIN gradeCurricular as matrizCurricular on historico.matrizCurricular = matrizCurricular.codigo LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		sqlStr.append(" left join matriculaperiodoturmadisciplina mptd on mptd.codigo = historico.matriculaperiodoturmadisciplina ");
		sqlStr.append(" left join turma on mptd.turma = turma.codigo ");
		sqlStr.append(" left join turma as turmapratica on mptd.turmapratica = turmapratica.codigo ");
		sqlStr.append(" left join turma as turmateorica on mptd.turmateorica = turmateorica.codigo ");
	}

	/**
	 *
	 * @param matriculaAluno
	 * @param situacoesHistorico
	 * @param ordemHistoricoDisciplina
	 * @param controlarAcesso
	 * @param nivelMontarDados
	 * @param usuario
	 * @return HOMOLOGADO - NOVA GESTÃO DE HISTÓRICOS - VERSÃO 5.0 Deve ser
	 *         utilizado método com mesmo nome, mas que filtra por
	 *         gradeCurricular pois todos os históricos no SEI sempre serão
	 *         agrupados/gerenciados por gradeCurricular. Ao se fazer uma
	 *         transferência de matriz curricular, todos os históricos da matriz
	 *         antiga, ficarão inalterados, e serão geradas novos registros de
	 *         historico vinculados a nova gradeCurricular do aluno. todourgente
	 */
	public List<HistoricoVO> consultaRapidaPorMatriculaSituacaoHistorico(Integer aluno, String matriculaAluno, Integer gradeCurricular, String[] situacoesHistorico, int ordemHistoricoDisciplina, Boolean carregarDadosProfessor,  boolean controlarAcesso, NivelMontarDados nivelMontarDados, UsuarioVO usuario, ConfiguracaoAcademicoVO configuracaoAcademicoVO, boolean isAproveitamento) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		if (Uteis.isAtributoPreenchido(aluno)) {
			sqlStr.append(" WITH cte_historicos AS (SELECT t.codigo FROM (SELECT historico.codigo, ");
			sqlStr.append(" ROW_NUMBER() OVER(PARTITION BY historico.disciplina ORDER BY historico.mediafinal DESC NULLS LAST, historico.codigo DESC) indice ");
			sqlStr.append(" FROM historico ");
			sqlStr.append(" INNER JOIN matricula ON historico.matricula = matricula.matricula ");
			sqlStr.append(" WHERE matricula.aluno = ").append(aluno);
			sqlStr.append(" AND historico.matrizcurricular = matricula.gradecurricularatual ");
			montarFiltroSituacaoHistorico(situacoesHistorico, sqlStr);
			sqlStr.append(") t WHERE t.indice = 1) ");
			getSqlBaseConsultaDetalhadoPorMatricula(sqlStr, true);
		} else {
			getSqlBaseConsultaDetalhadoPorMatricula(sqlStr, false);
			sqlStr.append(" WHERE (matricula.matricula = '" + matriculaAluno + "') and (historico.matrizCurricular = " + gradeCurricular + ") ");
		}
		if(isAproveitamento && Uteis.isAtributoPreenchido(configuracaoAcademicoVO) && !configuracaoAcademicoVO.getPermitirAproveitamentoDisciplinasOptativas()){
			sqlStr.append(" AND (gradedisciplina.codigo IS NULL OR (gradedisciplina.codigo IS NOT NULL AND gradedisciplina.tipodisciplina <> 'OP')) ");
		}
		montarFiltroSituacaoHistorico(situacoesHistorico, sqlStr);
		switch (OrdemHistoricoDisciplina.getEnum(ordemHistoricoDisciplina)) {
		case ANO_SEMESTRE:
			sqlStr.append(" ORDER BY matriculaperiodo.ano, matriculaperiodo.semestre, disciplina.nome, periodoletivo.periodoletivo");
			break;
		case PERIODO_LETIVO:
			sqlStr.append(" ORDER BY periodoletivo.periodoletivo, disciplina.nome, matriculaperiodo.ano, matriculaperiodo.semestre");
			break;
		case MATRICULA_COM_HISTORICO_ALUNO:
			sqlStr.append(" ORDER BY disciplina.codigo, matriculaperiodo.ano, matriculaperiodo.semestre");
			break;
		default:
			break;
		}
//		System.out.println(sqlStr.toString());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		final List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			montarDadosDetalhadoConsultaPorMatricula(obj, tabelaResultado, usuario);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	private void montarFiltroSituacaoHistorico(String[] situacoesHistorico, StringBuilder sqlStr) {
		if (situacoesHistorico.length > 0) {
			sqlStr.append(" AND historico.situacao IN ('' ");
			for (String situacao : situacoesHistorico) {
				sqlStr.append(", ").append(situacao);
			}
			sqlStr.append(" )");
		}
	}

	public void realizaExclusaoHistoricoDuplicadoMigracaoMatrizCurricular(String matriculaAluno, Integer gradeCurricular, Integer codigoTransferencia, List<MapaEquivalenciaDisciplinaMatrizCurricularVO> mapaEquivalenciaDisciplinaMatrizCurricularVO, UsuarioVO usuario) throws Exception {
		try {
			StringBuilder disciplinas = new StringBuilder("");
			if (!mapaEquivalenciaDisciplinaMatrizCurricularVO.isEmpty()) {
				disciplinas.append(" and historico.disciplina in (0 ");
				Iterator i = mapaEquivalenciaDisciplinaMatrizCurricularVO.iterator();
				while (i.hasNext()) {
					MapaEquivalenciaDisciplinaMatrizCurricularVO obj = (MapaEquivalenciaDisciplinaMatrizCurricularVO)i.next();
					disciplinas.append(", " + obj.getDisciplinaVO().getCodigo());
				}
				disciplinas.append( ") ");
			}
			StringBuilder sqlStr = new StringBuilder(" delete from historico where codigo in ( ");
			sqlStr.append(" select historico.codigo from historico where 1=1 ");
			sqlStr.append(" and historico.matrizcurricular= " + gradeCurricular + " AND historico.matricula='" + matriculaAluno + "' and historico.transferenciamatrizcurricularmatricula = " + codigoTransferencia);
			sqlStr.append(disciplinas.toString());
			sqlStr.append(" and historico.situacao in ('CE') and historico.disciplina in (select disciplina from historico where 1=1  ");
			sqlStr.append(disciplinas.toString());
			sqlStr.append(" and historico.matrizcurricular= " + gradeCurricular + " AND historico.matricula='" + matriculaAluno + "' and historico.transferenciamatrizcurricularmatricula = " + codigoTransferencia + " and historico.situacao in ('AE'))");
			sqlStr.append(" ) ");
			getConexao().getJdbcTemplate().update(sqlStr + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
		} catch (Exception e) {
			throw e;
		}
	}

	private void montarDadosDetalhadoConsultaPorMatricula(HistoricoVO obj, SqlRowSet dadosSQL, UsuarioVO usuario) throws Exception {
		// Dados do Historico
		obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("configuracaoacademico"));
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.setTipoHistorico(dadosSQL.getString("tipoHistorico"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setAnoHistorico(dadosSQL.getString("anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestreHistorico"));
		obj.setFreguencia(new Double(dadosSQL.getDouble("freguencia")));
		obj.setDataRegistro(dadosSQL.getDate("dataRegistro"));
		obj.setDataInicioAula(dadosSQL.getDate("dataInicioAula"));
		obj.setDataFimAula(dadosSQL.getDate("dataFimAula"));
		obj.setInstituicao(dadosSQL.getString("instituicao"));
		obj.setCargaHorariaAproveitamentoDisciplina(dadosSQL.getInt("cargaHorariaAproveitamentoDisciplina"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaCursada"));
		obj.setCargaHorariaDisciplina(dadosSQL.getInt("historico.cargaHorariaDisciplina"));
		obj.setCreditoDisciplina(dadosSQL.getInt("historico.creditoDisciplina"));
		obj.setHistoricoCriterioAvaliacaoAluno(dadosSQL.getBoolean("historicoCriterioAvaliacaoAluno"));
		obj.getCriterioAvaliacao().setCodigo(dadosSQL.getInt("criterioAvaliacao"));
		obj.setNumeroAgrupamentoEquivalenciaDisciplina(dadosSQL.getInt("numeroAgrupamentoEquivalenciaDisciplina"));
		obj.getMatrizCurricular().setCodigo(dadosSQL.getInt("matrizCurricular.codigo"));

		obj.getCidadeVO().setCodigo(dadosSQL.getInt("cidade"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("utilizaNotaFinalConceito"));
		obj.setNotaFinalConceito(dadosSQL.getString("notaFinalConceito"));
		if (dadosSQL.getObject("mediaFinal") == null) {
			obj.setMediaFinal((Double) dadosSQL.getObject("mediaFinal"));
		} else {
			obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		}
		// obj.setMediaFinal(new Double(dadosSQL.getDouble("mediaFinal")));
		// obj.setCargaHoraria(new Double(dadosSQL.getDouble("cargaHoraria")));
		obj.setTransferenciaEntradaDisciplinasAproveitadas(new Integer(dadosSQL.getInt("transferenciaEntradaDisciplinasAproveitadas")));

		// DADOS TRASNFERENCIA MATRIZ CURRICULAR
		obj.getTransferenciaMatrizCurricularMatricula().setCodigo(dadosSQL.getInt("historico.transferenciaMatrizCurricularMatricula"));
		obj.setHistoricoGeradoAPartirTransferenciaMatrizCurricular(dadosSQL.getBoolean("historico.historicoGeradoAPartirTransferenciaMatrizCurricular"));
		obj.setObservacaoTransferenciaMatrizCurricular(dadosSQL.getString("historico.observacaoTransferenciaMatrizCurricular"));
		obj.setHistoricoCursandoPorCorrespondenciaAposTransferencia(dadosSQL.getBoolean("historico.historicoCursandoPorCorrespondenciaAposTransferencia"));

		// Dados do Matricula Periodo
		obj.getMatriculaPeriodo().setCodigo(dadosSQL.getInt("matriculaPeriodo"));
		obj.getMatriculaPeriodo().setAno(dadosSQL.getString("ano"));
		obj.getMatriculaPeriodo().setSemestre(dadosSQL.getString("semestre"));
		obj.getMatriculaPeriodo().getPeridoLetivo().setCodigo(dadosSQL.getInt("periodoletivo.codigo"));
		obj.getMatriculaPeriodo().getPeridoLetivo().setPeriodoLetivo(dadosSQL.getInt("periodoletivo.periodoLetivo"));
		obj.getPeriodoLetivoMatrizCurricular().setCodigo(dadosSQL.getInt("periodoletivo.codigo"));
		obj.getPeriodoLetivoMatrizCurricular().setPeriodoLetivo(dadosSQL.getInt("periodoletivo.periodoletivo"));
		obj.getPeriodoLetivoCursada().setCodigo(dadosSQL.getInt("periodoLetivoCursada.codigo"));
		obj.getPeriodoLetivoCursada().setPeriodoLetivo(dadosSQL.getInt("periodoLetivoCursada.periodoLetivo"));
		obj.getPeriodoLetivoCursada().setDescricao(dadosSQL.getString("periodoLetivoCursada.descricao"));
		// Dados da Disciplinas
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina.codigo")));
		if(Uteis.isAtributoPreenchido(dadosSQL.getInt("disciplina.codigo"))){
			obj.setDisciplina(getAplicacaoControle().getDisciplinaVO(dadosSQL.getInt("disciplina.codigo"), usuario));
		}
		obj.getDisciplina().setNome(dadosSQL.getString("disciplina.nome"));
		obj.getDisciplina().setAbreviatura(dadosSQL.getString("disciplina.abreviatura"));
		obj.getDisciplina().setClassificacaoDisciplina(ClassificacaoDisciplinaEnum.valueOf(dadosSQL.getString("disciplina.classificacaoDisciplina")));		
		// DADOS GRADE DISCIPLINA
		obj.getGradeDisciplinaVO().setCodigo(dadosSQL.getInt("gradedisciplina.codigo"));
		obj.getGradeDisciplinaVO().getDisciplina().setCodigo(dadosSQL.getInt("gradedisciplina.disciplina"));
		if(Uteis.isAtributoPreenchido(dadosSQL.getInt("gradedisciplina.disciplina"))){
			obj.getGradeDisciplinaVO().setDisciplina(getAplicacaoControle().getDisciplinaVO(dadosSQL.getInt("gradedisciplina.disciplina"), usuario));
		}
		obj.getGradeDisciplinaVO().setDiversificada(dadosSQL.getBoolean("gradedisciplina.diversificada"));
		obj.getGradeDisciplinaVO().setDisciplinaComposta(dadosSQL.getBoolean("gradedisciplina.disciplinaComposta"));
		obj.getGradeDisciplinaVO().setCargaHoraria(new Integer(dadosSQL.getInt("gradedisciplina.cargaHoraria")));
		obj.getGradeDisciplinaVO().setNrCreditos(new Integer(dadosSQL.getInt("gradedisciplina.nrCreditos")));
		obj.getGradeDisciplinaVO().setHoraAula(new Integer(dadosSQL.getInt("gradedisciplina.horaAula")));
		obj.getGradeDisciplinaVO().getDisciplinaEixoTematico().setCodigo(new Integer(dadosSQL.getInt("gradedisciplina.disciplinaEixoTematico")));
		obj.getGradeDisciplinaVO().setPeriodoLetivo(dadosSQL.getInt("gradedisciplina.periodoLetivo"));
		obj.getGradeDisciplinaVO().getPeriodoLetivoVO().setCodigo(dadosSQL.getInt("gradedisciplina.periodoLetivo"));

		// DADOS GRADE CURRICULAR GRUPO OPTATIVA DISCIPLINA
		obj.setDisciplinaReferenteAUmGrupoOptativa(dadosSQL.getBoolean("historico.disciplinaReferenteAUmGrupoOptativa"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setCodigo(dadosSQL.getInt("historico.gradeCurricularGrupoOptativaDisciplina"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setCargaHoraria(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.cargaHoraria"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setNrCreditos(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.nrCreditos"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setHoraAula(dadosSQL.getInt("gcgod.horaAula"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().getDisciplina().setCodigo(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.disciplina"));
		if(Uteis.isAtributoPreenchido(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.disciplina"))){
			obj.getGradeCurricularGrupoOptativaDisciplinaVO().setDisciplina(getAplicacaoControle().getDisciplinaVO(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.disciplina"), usuario));
		}
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setDiversificada(dadosSQL.getBoolean("gradeCurricularGrupoOptativaDisciplina.diversificada"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setDisciplinaComposta(dadosSQL.getBoolean("gradeCurricularGrupoOptativaDisciplina.disciplinaComposta"));

		// DADOS DISCIPLINA COMPOSTA
		obj.setHistoricoDisciplinaFazParteComposicao(dadosSQL.getBoolean("historicoDisciplinaFazParteComposicao"));
		obj.setHistoricoDisciplinaComposta(dadosSQL.getBoolean("historico.historicoDisciplinaComposta"));
		obj.getGradeDisciplinaComposta().setCodigo(dadosSQL.getInt("historico.gradeDisciplinaComposta"));

		// DADOS EQUIVALENCIA
		obj.setHistoricoPorEquivalencia(dadosSQL.getBoolean("historico.historicoPorEquivalencia"));
		obj.setHistoricoEquivalente(dadosSQL.getBoolean("historico.historicoEquivalente"));
		obj.getMapaEquivalenciaDisciplina().setCodigo(dadosSQL.getInt("historico.mapaEquivalenciaDisciplina"));
		obj.getMapaEquivalenciaDisciplinaCursada().setCodigo(dadosSQL.getInt("historico.mapaEquivalenciaDisciplinaCursada"));
		obj.getMapaEquivalenciaDisciplinaMatrizCurricular().setCodigo(dadosSQL.getInt("historico.mapaEquivalenciaDisciplinaMatrizCurricular"));

		// Dados da Matricula
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula"));
		obj.getMatricula().getGradeCurricularAtual().setCodigo(dadosSQL.getInt("gradecurricularatual"));
		// Dados da Periodo Letivo
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina")));

		if (dadosSQL.getObject("nota1") == null) {
			obj.setNota1((Double) dadosSQL.getObject("nota1"));
		} else {
			obj.setNota1(dadosSQL.getDouble("nota1"));
		}
		if (dadosSQL.getObject("nota2") == null) {
			obj.setNota2((Double) dadosSQL.getObject("nota2"));
		} else {
			obj.setNota2(dadosSQL.getDouble("nota2"));
		}
		if (dadosSQL.getObject("nota3") == null) {
			obj.setNota3((Double) dadosSQL.getObject("nota3"));
		} else {
			obj.setNota3(dadosSQL.getDouble("nota3"));
		}
		if (dadosSQL.getObject("nota4") == null) {
			obj.setNota4((Double) dadosSQL.getObject("nota4"));
		} else {
			obj.setNota4(dadosSQL.getDouble("nota4"));
		}
		if (dadosSQL.getObject("nota5") == null) {
			obj.setNota5((Double) dadosSQL.getObject("nota5"));
		} else {
			obj.setNota5(dadosSQL.getDouble("nota5"));
		}
		if (dadosSQL.getObject("nota6") == null) {
			obj.setNota6((Double) dadosSQL.getObject("nota6"));
		} else {
			obj.setNota6(dadosSQL.getDouble("nota6"));
		}
		if (dadosSQL.getObject("nota7") == null) {
			obj.setNota7((Double) dadosSQL.getObject("nota7"));
		} else {
			obj.setNota7(dadosSQL.getDouble("nota7"));
		}
		if (dadosSQL.getObject("nota8") == null) {
			obj.setNota8((Double) dadosSQL.getObject("nota8"));
		} else {
			obj.setNota8(dadosSQL.getDouble("nota8"));
		}
		if (dadosSQL.getObject("nota9") == null) {
			obj.setNota9((Double) dadosSQL.getObject("nota9"));
		} else {
			obj.setNota9(dadosSQL.getDouble("nota9"));
		}
		if (dadosSQL.getObject("nota10") == null) {
			obj.setNota10((Double) dadosSQL.getObject("nota10"));
		} else {
			obj.setNota10(dadosSQL.getDouble("nota10"));
		}
		if (dadosSQL.getObject("nota11") == null) {
			obj.setNota11((Double) dadosSQL.getObject("nota11"));
		} else {
			obj.setNota11(dadosSQL.getDouble("nota11"));
		}
		if (dadosSQL.getObject("nota12") == null) {
			obj.setNota12((Double) dadosSQL.getObject("nota12"));
		} else {
			obj.setNota12(dadosSQL.getDouble("nota12"));
		}
		if (dadosSQL.getObject("nota13") == null) {
			obj.setNota13((Double) dadosSQL.getObject("nota13"));
		} else {
			obj.setNota13(dadosSQL.getDouble("nota13"));
		}
		if (dadosSQL.getObject("nota14") == null) {
			obj.setNota14((Double) dadosSQL.getObject("nota14"));
		} else {
			obj.setNota14(dadosSQL.getDouble("nota14"));
		}
		if (dadosSQL.getObject("nota15") == null) {
			obj.setNota15((Double) dadosSQL.getObject("nota15"));
		} else {
			obj.setNota15(dadosSQL.getDouble("nota15"));
		}
		if (dadosSQL.getObject("nota16") == null) {
			obj.setNota16((Double) dadosSQL.getObject("nota16"));
		} else {
			obj.setNota16(dadosSQL.getDouble("nota16"));
		}
		if (dadosSQL.getObject("nota17") == null) {
			obj.setNota17((Double) dadosSQL.getObject("nota17"));
		} else {
			obj.setNota17(dadosSQL.getDouble("nota17"));
		}
		if (dadosSQL.getObject("nota18") == null) {
			obj.setNota18((Double) dadosSQL.getObject("nota18"));
		} else {
			obj.setNota18(dadosSQL.getDouble("nota18"));
		}
		if (dadosSQL.getObject("nota19") == null) {
			obj.setNota19((Double) dadosSQL.getObject("nota19"));
		} else {
			obj.setNota19(dadosSQL.getDouble("nota19"));
		}
		if (dadosSQL.getObject("nota20") == null) {
			obj.setNota20((Double) dadosSQL.getObject("nota20"));
		} else {
			obj.setNota20(dadosSQL.getDouble("nota20"));
		}
		if (dadosSQL.getObject("nota21") == null) {
			obj.setNota21((Double) dadosSQL.getObject("nota21"));
		} else {
			obj.setNota21(dadosSQL.getDouble("nota21"));
		}
		if (dadosSQL.getObject("nota22") == null) {
			obj.setNota22((Double) dadosSQL.getObject("nota22"));
		} else {
			obj.setNota22(dadosSQL.getDouble("nota22"));
		}
		if (dadosSQL.getObject("nota23") == null) {
			obj.setNota23((Double) dadosSQL.getObject("nota23"));
		} else {
			obj.setNota23(dadosSQL.getDouble("nota23"));
		}
		if (dadosSQL.getObject("nota24") == null) {
			obj.setNota24((Double) dadosSQL.getObject("nota24"));
		} else {
			obj.setNota24(dadosSQL.getDouble("nota24"));
		}
		if (dadosSQL.getObject("nota25") == null) {
			obj.setNota25((Double) dadosSQL.getObject("nota25"));
		} else {
			obj.setNota25(dadosSQL.getDouble("nota25"));
		}
		if (dadosSQL.getObject("nota26") == null) {
			obj.setNota26((Double) dadosSQL.getObject("nota26"));
		} else {
			obj.setNota26(dadosSQL.getDouble("nota26"));
		}
		if (dadosSQL.getObject("nota27") == null) {
			obj.setNota27((Double) dadosSQL.getObject("nota27"));
		} else {
			obj.setNota27(dadosSQL.getDouble("nota27"));
		}
		if (dadosSQL.getObject("nota28") == null) {
			obj.setNota28((Double) dadosSQL.getObject("nota28"));
		} else {
			obj.setNota28(dadosSQL.getDouble("nota28"));
		}
		if (dadosSQL.getObject("nota29") == null) {
			obj.setNota29((Double) dadosSQL.getObject("nota29"));
		} else {
			obj.setNota29(dadosSQL.getDouble("nota29"));
		}
		if (dadosSQL.getObject("nota30") == null) {
			obj.setNota30((Double) dadosSQL.getObject("nota30"));
		} else {
			obj.setNota30(dadosSQL.getDouble("nota30"));
		}
		if (dadosSQL.getObject("nota31") == null) {
			obj.setNota31((Double) dadosSQL.getObject("nota31"));
		} else {
			obj.setNota31(dadosSQL.getDouble("nota31"));
		}
		if (dadosSQL.getObject("nota32") == null) {
			obj.setNota32((Double) dadosSQL.getObject("nota32"));
		} else {
			obj.setNota32(dadosSQL.getDouble("nota32"));
		}
		if (dadosSQL.getObject("nota33") == null) {
			obj.setNota33((Double) dadosSQL.getObject("nota33"));
		} else {
			obj.setNota33(dadosSQL.getDouble("nota33"));
		}
		if (dadosSQL.getObject("nota34") == null) {
			obj.setNota34((Double) dadosSQL.getObject("nota34"));
		} else {
			obj.setNota34(dadosSQL.getDouble("nota34"));
		}
		if (dadosSQL.getObject("nota35") == null) {
			obj.setNota35((Double) dadosSQL.getObject("nota35"));
		} else {
			obj.setNota35(dadosSQL.getDouble("nota35"));
		}
		if (dadosSQL.getObject("nota36") == null) {
			obj.setNota36((Double) dadosSQL.getObject("nota36"));
		} else {
			obj.setNota36(dadosSQL.getDouble("nota36"));
		}
		if (dadosSQL.getObject("nota37") == null) {
			obj.setNota37((Double) dadosSQL.getObject("nota37"));
		} else {
			obj.setNota37(dadosSQL.getDouble("nota37"));
		}
		if (dadosSQL.getObject("nota38") == null) {
			obj.setNota38((Double) dadosSQL.getObject("nota38"));
		} else {
			obj.setNota38(dadosSQL.getDouble("nota38"));
		}
		if (dadosSQL.getObject("nota39") == null) {
			obj.setNota39((Double) dadosSQL.getObject("nota39"));
		} else {
			obj.setNota39(dadosSQL.getDouble("nota39"));
		}
		if (dadosSQL.getObject("nota40") == null) {
			obj.setNota40((Double) dadosSQL.getObject("nota40"));
		} else {
			obj.setNota40(dadosSQL.getDouble("nota40"));
		}

		obj.setNota1Lancada(dadosSQL.getBoolean("nota1Lancada"));
		obj.setNota2Lancada(dadosSQL.getBoolean("nota2Lancada"));
		obj.setNota3Lancada(dadosSQL.getBoolean("nota3Lancada"));
		obj.setNota4Lancada(dadosSQL.getBoolean("nota4Lancada"));
		obj.setNota5Lancada(dadosSQL.getBoolean("nota5Lancada"));
		obj.setNota6Lancada(dadosSQL.getBoolean("nota6Lancada"));
		obj.setNota7Lancada(dadosSQL.getBoolean("nota7Lancada"));
		obj.setNota8Lancada(dadosSQL.getBoolean("nota8Lancada"));
		obj.setNota9Lancada(dadosSQL.getBoolean("nota9Lancada"));
		obj.setNota10Lancada(dadosSQL.getBoolean("nota10Lancada"));
		obj.setNota11Lancada(dadosSQL.getBoolean("nota11Lancada"));
		obj.setNota12Lancada(dadosSQL.getBoolean("nota12Lancada"));
		obj.setNota13Lancada(dadosSQL.getBoolean("nota13Lancada"));
		obj.setNota14Lancada(dadosSQL.getBoolean("nota14Lancada"));
		obj.setNota15Lancada(dadosSQL.getBoolean("nota15Lancada"));
		obj.setNota16Lancada(dadosSQL.getBoolean("nota16Lancada"));
		obj.setNota17Lancada(dadosSQL.getBoolean("nota17Lancada"));
		obj.setNota18Lancada(dadosSQL.getBoolean("nota18Lancada"));
		obj.setNota19Lancada(dadosSQL.getBoolean("nota19Lancada"));
		obj.setNota20Lancada(dadosSQL.getBoolean("nota20Lancada"));
		obj.setNota21Lancada(dadosSQL.getBoolean("nota21Lancada"));
		obj.setNota22Lancada(dadosSQL.getBoolean("nota22Lancada"));
		obj.setNota23Lancada(dadosSQL.getBoolean("nota23Lancada"));
		obj.setNota24Lancada(dadosSQL.getBoolean("nota24Lancada"));
		obj.setNota25Lancada(dadosSQL.getBoolean("nota25Lancada"));
		obj.setNota26Lancada(dadosSQL.getBoolean("nota26Lancada"));
		obj.setNota27Lancada(dadosSQL.getBoolean("nota27Lancada"));
		obj.setNota28Lancada(dadosSQL.getBoolean("nota28Lancada"));
		obj.setNota29Lancada(dadosSQL.getBoolean("nota29Lancada"));
		obj.setNota30Lancada(dadosSQL.getBoolean("nota30Lancada"));

		obj.setNota31Lancada(dadosSQL.getBoolean("nota31Lancada"));
		obj.setNota32Lancada(dadosSQL.getBoolean("nota32Lancada"));
		obj.setNota33Lancada(dadosSQL.getBoolean("nota33Lancada"));
		obj.setNota34Lancada(dadosSQL.getBoolean("nota34Lancada"));
		obj.setNota35Lancada(dadosSQL.getBoolean("nota35Lancada"));
		obj.setNota36Lancada(dadosSQL.getBoolean("nota36Lancada"));
		obj.setNota37Lancada(dadosSQL.getBoolean("nota37Lancada"));
		obj.setNota38Lancada(dadosSQL.getBoolean("nota38Lancada"));
		obj.setNota39Lancada(dadosSQL.getBoolean("nota39Lancada"));
		obj.setNota40Lancada(dadosSQL.getBoolean("nota40Lancada"));
		obj.setApresentarAprovadoHistorico(dadosSQL.getBoolean("apresentarAprovadoHistorico"));

		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));

		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(new Integer(dadosSQL.getInt("mptd.codigo")));
		obj.getMatriculaPeriodoTurmaDisciplina().setMatriculaPeriodo(new Integer(dadosSQL.getInt("mptd.matriculaPeriodo")));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setCodigo(new Integer(dadosSQL.getInt("mptd.turma")));
		obj.getMatriculaPeriodoTurmaDisciplina().getDisciplina().setCodigo(new Integer(dadosSQL.getInt("mptd.disciplina")));
		if(Uteis.isAtributoPreenchido(dadosSQL.getInt("mptd.disciplina"))){
			obj.getMatriculaPeriodoTurmaDisciplina().setDisciplina(getAplicacaoControle().getDisciplinaVO(dadosSQL.getInt("mptd.disciplina"), usuario));
		}
		obj.getMatriculaPeriodoTurmaDisciplina().getConteudo().setCodigo(new Integer(dadosSQL.getInt("mptd.conteudo")));
		obj.getMatriculaPeriodoTurmaDisciplina().setAno(dadosSQL.getString("mptd.ano"));
		if(dadosSQL.getString("mptd.modalidadeDisciplina") != null && !dadosSQL.getString("mptd.modalidadeDisciplina").trim().isEmpty()){
			obj.getMatriculaPeriodoTurmaDisciplina().setModalidadeDisciplina(ModalidadeDisciplinaEnum.valueOf(dadosSQL.getString("mptd.modalidadeDisciplina")));
		}
		obj.getMatriculaPeriodoTurmaDisciplina().setSemestre(dadosSQL.getString("mptd.semestre"));
		obj.getMatriculaPeriodoTurmaDisciplina().setBimestre(dadosSQL.getInt("mptd.bimestre"));
		obj.getMatriculaPeriodoTurmaDisciplina().setMatricula(dadosSQL.getString("mptd.matricula"));
		obj.getMatriculaPeriodoTurmaDisciplina().setDisciplinaIncluida(dadosSQL.getBoolean("mptd.disciplinaIncluida"));
		obj.getMatriculaPeriodoTurmaDisciplina().setDisciplinaEquivale(dadosSQL.getBoolean("mptd.disciplinaEquivale"));
		obj.getMatriculaPeriodoTurmaDisciplina().setPermiteEscolherModalidade(dadosSQL.getBoolean("mptd.permiteEscolherModalidade"));
		// obj.getDisciplinaEquivalente().setCodigo(dadosSQL.getInt("disciplinaEquivalente"));
		obj.getMatriculaPeriodoTurmaDisciplina().setDisciplinaFazParteComposicao(dadosSQL.getBoolean("mptd.disciplinaFazParteComposicao"));
		obj.getMatriculaPeriodoTurmaDisciplina().setReposicao(dadosSQL.getBoolean("mptd.reposicao"));
		obj.getMatriculaPeriodoTurmaDisciplina().setInclusaoForaPrazo(dadosSQL.getBoolean("mptd.inclusaoForaPrazo"));

		// NOVOS CAMPOS
		obj.getMatriculaPeriodoTurmaDisciplina().setDisciplinaPorEquivalencia(dadosSQL.getBoolean("mptd.disciplinaPorEquivalencia"));
		obj.getMatriculaPeriodoTurmaDisciplina().getGradeDisciplinaCompostaVO().setCodigo(dadosSQL.getInt("mptd.gradeDisciplinaComposta"));
		obj.getMatriculaPeriodoTurmaDisciplina().setDisciplinaEmRegimeEspecial(dadosSQL.getBoolean("mptd.disciplinaEmRegimeEspecial"));
		obj.getMatriculaPeriodoTurmaDisciplina().setDisciplinaOptativa(dadosSQL.getBoolean("mptd.disciplinaOptativa"));
		obj.getMatriculaPeriodoTurmaDisciplina().setDisciplinaReferenteAUmGrupoOptativa(dadosSQL.getBoolean("mptd.disciplinaReferenteAUmGrupoOptativa"));
		obj.getMatriculaPeriodoTurmaDisciplina().getGradeCurricularGrupoOptativaDisciplinaVO().setCodigo(dadosSQL.getInt("mptd.gradeCurricularGrupoOptativaDisciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().getGradeDisciplinaVO().setCodigo(dadosSQL.getInt("mptd.gradeDisciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().getMapaEquivalenciaDisciplinaVOIncluir().setCodigo(dadosSQL.getInt("mptd.mapaEquivalenciaDisciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().getMapaEquivalenciaDisciplinaCursada().setCodigo(dadosSQL.getInt("mptd.mapaEquivalenciaDisciplinaCursada"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTransferenciaMatrizCurricularMatricula().setCodigo(dadosSQL.getInt("mptd.transferenciaMatrizCurricularMatricula"));
		obj.getMatriculaPeriodoTurmaDisciplina().setDisciplinaCursandoPorCorrespondenciaAposTransferencia(dadosSQL.getBoolean("mptd.disciplinaCursandoPorCorrespondenciaAposTransferencia"));
		if (Uteis.isAtributoPreenchido(dadosSQL.getInt("mptd.professor"))) {
			obj.getMatriculaPeriodoTurmaDisciplina().getProfessor().setCodigo(dadosSQL.getInt("mptd.professor"));
		}
		obj.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().setCodigo(dadosSQL.getInt("mptd.turmaTeorica"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().setCodigo(dadosSQL.getInt("mptd.turmaPratica"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setIdentificadorTurma(dadosSQL.getString("turma.identificadorturma"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().setIdentificadorTurma(dadosSQL.getString("turmaTeorica.identificadorturma"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().setIdentificadorTurma(dadosSQL.getString("turmaPratica.identificadorturma"));
	}

	private void montarDadosDetalhadoConsultaPorMatricula2(HistoricoVO obj, SqlRowSet dadosSQL, UsuarioVO usuario) throws Exception {
		// Dados do Historico
		obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("configuracaoacademico"));
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.setTipoHistorico(dadosSQL.getString("tipoHistorico"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setAnoHistorico(dadosSQL.getString("anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestreHistorico"));
		obj.setFreguencia(new Double(dadosSQL.getDouble("freguencia")));
		obj.setDataRegistro(dadosSQL.getDate("dataRegistro"));
		obj.setHistoricoCriterioAvaliacaoAluno(dadosSQL.getBoolean("historicoCriterioAvaliacaoAluno"));
		obj.getCriterioAvaliacao().setCodigo(dadosSQL.getInt("criterioAvaliacao"));
		obj.setNumeroAgrupamentoEquivalenciaDisciplina(dadosSQL.getInt("numeroAgrupamentoEquivalenciaDisciplina"));
		obj.setInstituicao(dadosSQL.getString("instituicao"));
		obj.setCargaHorariaAproveitamentoDisciplina(dadosSQL.getInt("cargaHorariaAproveitamentoDisciplina"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaCursada"));
		obj.getCidadeVO().setCodigo(dadosSQL.getInt("cidade"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("utilizaNotaFinalConceito"));
		obj.setNotaFinalConceito(dadosSQL.getString("notaFinalConceito"));

		if (dadosSQL.getObject("nota1") == null) {
			obj.setNota1((Double) dadosSQL.getObject("nota1"));
		} else {
			obj.setNota1(dadosSQL.getDouble("nota1"));
		}
		if (dadosSQL.getObject("nota2") == null) {
			obj.setNota2((Double) dadosSQL.getObject("nota2"));
		} else {
			obj.setNota2(dadosSQL.getDouble("nota2"));
		}
		if (dadosSQL.getObject("nota3") == null) {
			obj.setNota3((Double) dadosSQL.getObject("nota3"));
		} else {
			obj.setNota3(dadosSQL.getDouble("nota3"));
		}
		if (dadosSQL.getObject("nota4") == null) {
			obj.setNota4((Double) dadosSQL.getObject("nota4"));
		} else {
			obj.setNota4(dadosSQL.getDouble("nota4"));
		}
		if (dadosSQL.getObject("nota5") == null) {
			obj.setNota5((Double) dadosSQL.getObject("nota5"));
		} else {
			obj.setNota5(dadosSQL.getDouble("nota5"));
		}
		if (dadosSQL.getObject("nota6") == null) {
			obj.setNota6((Double) dadosSQL.getObject("nota6"));
		} else {
			obj.setNota6(dadosSQL.getDouble("nota6"));
		}
		if (dadosSQL.getObject("nota7") == null) {
			obj.setNota7((Double) dadosSQL.getObject("nota7"));
		} else {
			obj.setNota7(dadosSQL.getDouble("nota7"));
		}
		if (dadosSQL.getObject("nota8") == null) {
			obj.setNota8((Double) dadosSQL.getObject("nota8"));
		} else {
			obj.setNota8(dadosSQL.getDouble("nota8"));
		}
		if (dadosSQL.getObject("nota9") == null) {
			obj.setNota9((Double) dadosSQL.getObject("nota9"));
		} else {
			obj.setNota9(dadosSQL.getDouble("nota9"));
		}
		if (dadosSQL.getObject("nota10") == null) {
			obj.setNota10((Double) dadosSQL.getObject("nota10"));
		} else {
			obj.setNota10(dadosSQL.getDouble("nota10"));
		}
		if (dadosSQL.getObject("nota11") == null) {
			obj.setNota11((Double) dadosSQL.getObject("nota11"));
		} else {
			obj.setNota11(dadosSQL.getDouble("nota11"));
		}
		if (dadosSQL.getObject("nota12") == null) {
			obj.setNota12((Double) dadosSQL.getObject("nota12"));
		} else {
			obj.setNota12(dadosSQL.getDouble("nota12"));
		}
		if (dadosSQL.getObject("nota13") == null) {
			obj.setNota13((Double) dadosSQL.getObject("nota13"));
		} else {
			obj.setNota13(dadosSQL.getDouble("nota13"));
		}

		obj.setNota1Lancada(dadosSQL.getBoolean("nota1Lancada"));
		obj.setNota2Lancada(dadosSQL.getBoolean("nota2Lancada"));
		obj.setNota3Lancada(dadosSQL.getBoolean("nota3Lancada"));
		obj.setNota4Lancada(dadosSQL.getBoolean("nota4Lancada"));
		obj.setNota5Lancada(dadosSQL.getBoolean("nota5Lancada"));
		obj.setNota6Lancada(dadosSQL.getBoolean("nota6Lancada"));
		obj.setNota7Lancada(dadosSQL.getBoolean("nota7Lancada"));
		obj.setNota8Lancada(dadosSQL.getBoolean("nota8Lancada"));
		obj.setNota9Lancada(dadosSQL.getBoolean("nota9Lancada"));
		obj.setNota10Lancada(dadosSQL.getBoolean("nota10Lancada"));
		obj.setNota11Lancada(dadosSQL.getBoolean("nota11Lancada"));
		obj.setNota12Lancada(dadosSQL.getBoolean("nota12Lancada"));
		obj.setNota13Lancada(dadosSQL.getBoolean("nota13Lancada"));

		if (dadosSQL.getObject("nota14") == null) {
			obj.setNota14((Double) dadosSQL.getObject("nota14"));
		} else {
			obj.setNota14(dadosSQL.getDouble("nota14"));
		}
		obj.setNota14Lancada(dadosSQL.getBoolean("nota14Lancada"));

		if (dadosSQL.getObject("nota15") == null) {
			obj.setNota15((Double) dadosSQL.getObject("nota15"));
		} else {
			obj.setNota15(dadosSQL.getDouble("nota15"));
		}
		obj.setNota15Lancada(dadosSQL.getBoolean("nota15Lancada"));

		if (dadosSQL.getObject("nota16") == null) {
			obj.setNota16((Double) dadosSQL.getObject("nota16"));
		} else {
			obj.setNota16(dadosSQL.getDouble("nota16"));
		}
		obj.setNota16Lancada(dadosSQL.getBoolean("nota16Lancada"));

		if (dadosSQL.getObject("nota17") == null) {
			obj.setNota17((Double) dadosSQL.getObject("nota17"));
		} else {
			obj.setNota17(dadosSQL.getDouble("nota17"));
		}
		obj.setNota17Lancada(dadosSQL.getBoolean("nota17Lancada"));

		if (dadosSQL.getObject("nota18") == null) {
			obj.setNota18((Double) dadosSQL.getObject("nota18"));
		} else {
			obj.setNota18(dadosSQL.getDouble("nota18"));
		}
		obj.setNota18Lancada(dadosSQL.getBoolean("nota18Lancada"));

		if (dadosSQL.getObject("nota19") == null) {
			obj.setNota19((Double) dadosSQL.getObject("nota19"));
		} else {
			obj.setNota19(dadosSQL.getDouble("nota19"));
		}
		obj.setNota19Lancada(dadosSQL.getBoolean("nota19Lancada"));

		if (dadosSQL.getObject("nota20") == null) {
			obj.setNota20((Double) dadosSQL.getObject("nota20"));
		} else {
			obj.setNota20(dadosSQL.getDouble("nota20"));
		}
		obj.setNota20Lancada(dadosSQL.getBoolean("nota20Lancada"));

		if (dadosSQL.getObject("nota21") == null) {
			obj.setNota21((Double) dadosSQL.getObject("nota21"));
		} else {
			obj.setNota21(dadosSQL.getDouble("nota21"));
		}
		obj.setNota21Lancada(dadosSQL.getBoolean("nota21Lancada"));

		if (dadosSQL.getObject("nota22") == null) {
			obj.setNota22((Double) dadosSQL.getObject("nota22"));
		} else {
			obj.setNota22(dadosSQL.getDouble("nota22"));
		}
		obj.setNota22Lancada(dadosSQL.getBoolean("nota22Lancada"));

		if (dadosSQL.getObject("nota23") == null) {
			obj.setNota23((Double) dadosSQL.getObject("nota23"));
		} else {
			obj.setNota23(dadosSQL.getDouble("nota23"));
		}
		obj.setNota23Lancada(dadosSQL.getBoolean("nota23Lancada"));

		if (dadosSQL.getObject("nota24") == null) {
			obj.setNota24((Double) dadosSQL.getObject("nota24"));
		} else {
			obj.setNota24(dadosSQL.getDouble("nota24"));
		}
		obj.setNota24Lancada(dadosSQL.getBoolean("nota24Lancada"));

		if (dadosSQL.getObject("nota25") == null) {
			obj.setNota25((Double) dadosSQL.getObject("nota25"));
		} else {
			obj.setNota25(dadosSQL.getDouble("nota25"));
		}
		obj.setNota25Lancada(dadosSQL.getBoolean("nota25Lancada"));

		if (dadosSQL.getObject("nota26") == null) {
			obj.setNota26((Double) dadosSQL.getObject("nota26"));
		} else {
			obj.setNota26(dadosSQL.getDouble("nota26"));
		}
		obj.setNota26Lancada(dadosSQL.getBoolean("nota26Lancada"));

		if (dadosSQL.getObject("nota27") == null) {
			obj.setNota27((Double) dadosSQL.getObject("nota27"));
		} else {
			obj.setNota27(dadosSQL.getDouble("nota27"));
		}
		obj.setNota27Lancada(dadosSQL.getBoolean("nota27Lancada"));

		if (dadosSQL.getObject("nota28") == null) {
			obj.setNota28((Double) dadosSQL.getObject("nota28"));
		} else {
			obj.setNota28(dadosSQL.getDouble("nota28"));
		}
		obj.setNota28Lancada(dadosSQL.getBoolean("nota28Lancada"));

		if (dadosSQL.getObject("nota29") == null) {
			obj.setNota29((Double) dadosSQL.getObject("nota29"));
		} else {
			obj.setNota29(dadosSQL.getDouble("nota29"));
		}
		obj.setNota29Lancada(dadosSQL.getBoolean("nota29Lancada"));

		if (dadosSQL.getObject("nota30") == null) {
			obj.setNota30((Double) dadosSQL.getObject("nota30"));
		} else {
			obj.setNota30(dadosSQL.getDouble("nota30"));
		}
		obj.setNota30Lancada(dadosSQL.getBoolean("nota30Lancada"));

		if (dadosSQL.getObject("nota31") == null) {
			obj.setNota31((Double) dadosSQL.getObject("nota31"));
		} else {
			obj.setNota31(dadosSQL.getDouble("nota31"));
		}
		obj.setNota31Lancada(dadosSQL.getBoolean("nota31Lancada"));

		if (dadosSQL.getObject("nota32") == null) {
			obj.setNota32((Double) dadosSQL.getObject("nota32"));
		} else {
			obj.setNota32(dadosSQL.getDouble("nota32"));
		}
		obj.setNota32Lancada(dadosSQL.getBoolean("nota32Lancada"));

		if (dadosSQL.getObject("nota33") == null) {
			obj.setNota33((Double) dadosSQL.getObject("nota33"));
		} else {
			obj.setNota33(dadosSQL.getDouble("nota33"));
		}
		obj.setNota33Lancada(dadosSQL.getBoolean("nota33Lancada"));

		if (dadosSQL.getObject("nota34") == null) {
			obj.setNota34((Double) dadosSQL.getObject("nota34"));
		} else {
			obj.setNota34(dadosSQL.getDouble("nota34"));
		}
		obj.setNota34Lancada(dadosSQL.getBoolean("nota34Lancada"));

		if (dadosSQL.getObject("nota35") == null) {
			obj.setNota35((Double) dadosSQL.getObject("nota35"));
		} else {
			obj.setNota35(dadosSQL.getDouble("nota35"));
		}
		obj.setNota35Lancada(dadosSQL.getBoolean("nota35Lancada"));

		if (dadosSQL.getObject("nota36") == null) {
			obj.setNota36((Double) dadosSQL.getObject("nota36"));
		} else {
			obj.setNota36(dadosSQL.getDouble("nota36"));
		}
		obj.setNota36Lancada(dadosSQL.getBoolean("nota36Lancada"));

		if (dadosSQL.getObject("nota37") == null) {
			obj.setNota37((Double) dadosSQL.getObject("nota37"));
		} else {
			obj.setNota37(dadosSQL.getDouble("nota37"));
		}
		obj.setNota37Lancada(dadosSQL.getBoolean("nota37Lancada"));

		if (dadosSQL.getObject("nota38") == null) {
			obj.setNota38((Double) dadosSQL.getObject("nota38"));
		} else {
			obj.setNota38(dadosSQL.getDouble("nota38"));
		}
		obj.setNota38Lancada(dadosSQL.getBoolean("nota38Lancada"));

		if (dadosSQL.getObject("nota39") == null) {
			obj.setNota39((Double) dadosSQL.getObject("nota39"));
		} else {
			obj.setNota39(dadosSQL.getDouble("nota39"));
		}
		obj.setNota39Lancada(dadosSQL.getBoolean("nota39Lancada"));

		if (dadosSQL.getObject("nota40") == null) {
			obj.setNota40((Double) dadosSQL.getObject("nota40"));
		} else {
			obj.setNota40(dadosSQL.getDouble("nota40"));
		}
		obj.setNota40Lancada(dadosSQL.getBoolean("nota40Lancada"));

		if (dadosSQL.getObject("mediaFinal") == null) {
			obj.setMediaFinal((Double) dadosSQL.getObject("mediaFinal"));
		} else {
			obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		}

		obj.setObservacao(dadosSQL.getString("observacao"));
		obj.setHistoricoDisciplinaAtividadeComplementar(dadosSQL.getBoolean("historicoDisciplinaAtividadeComplementar"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaDisciplina"));
		obj.setCreditoDisciplina(dadosSQL.getInt("creditoDisciplina"));
		obj.setHistoricoDisciplinaOptativa(dadosSQL.getBoolean("historicoDisciplinaOptativa"));
		obj.setHistoricoDisciplinaForaGrade(dadosSQL.getBoolean("historicoDisciplinaForaGrade"));
		obj.setNomeDisciplina(dadosSQL.getString("nomeDisciplina"));
		obj.setHistoricoDisciplinaAproveitada(dadosSQL.getBoolean("historicoDisciplinaAproveitada"));
		obj.setHistoricoPorEquivalencia(dadosSQL.getBoolean("historicoPorEquivalencia"));
		obj.setHistoricoEquivalente(dadosSQL.getBoolean("historicoEquivalente"));
		obj.setFaltaPrimeiroBimestre(dadosSQL.getInt("faltaPrimeiroBimestre"));
		obj.setFaltaSegundoBimestre(dadosSQL.getInt("faltaSegundoBimestre"));
		obj.setFaltaTerceiroBimestre(dadosSQL.getInt("faltaTerceiroBimestre"));
		obj.setFaltaQuartoBimestre(dadosSQL.getInt("faltaQuartoBimestre"));
		obj.setTotalFalta(dadosSQL.getInt("totalFalta"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("utilizaNotaFinalConceito"));
		obj.setNotaFinalConceito(dadosSQL.getString("notaFinalConceito"));

		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setCodigo(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina"));
		obj.getGradeDisciplinaComposta().setCodigo(dadosSQL.getInt("gradeDisciplinaComposta"));

		// Dados do Historico Equivalente
		obj.setHistoricoEquivalente(dadosSQL.getBoolean("historicoEquivalente"));
		// obj.getHistoricoEquivalenteVO().getMapaEquivalenciaDisciplinaVO().setCodigo(dadosSQL.getInt("historicoEquivalente.mapaEquivalenciaDisciplina"));

		// Dados do Periodo Letivo Matriz Curricular
		obj.getPeriodoLetivoMatrizCurricular().setCodigo(dadosSQL.getInt("periodoLetivoMatrizCurricular"));
		// obj.getPeriodoLetivoMatrizCurricular().setDescricao(dadosSQL.getString("periodoLetivoMatrizCurricular.descricao"));
		// obj.getPeriodoLetivoMatrizCurricular().setPeriodoLetivo(dadosSQL.getInt("periodoLetivoMatrizCurricular.periodoLetivo"));

		// Dados da Matriz Curricular
		obj.getMatrizCurricular().setCodigo(dadosSQL.getInt("matrizCurricular"));
		// obj.getMatrizCurricular().setNome(dadosSQL.getString("matrizCurricular.nome"));

		// Dados do Periodo Letivo Cursada
		obj.getPeriodoLetivoCursada().setCodigo(dadosSQL.getInt("periodoLetivoCursada"));
		// obj.getPeriodoLetivoCursada().setDescricao(dadosSQL.getString("periodoLetivoCursada.descricao"));
		// obj.getPeriodoLetivoCursada().setPeriodoLetivo(dadosSQL.getInt("periodoLetivoCursada.periodoLetivo"));

		// obj.setMediaFinal(new Double(dadosSQL.getDouble("mediaFinal")));
		// obj.setCargaHoraria(new Double(dadosSQL.getDouble("cargaHoraria")));
		obj.setTransferenciaEntradaDisciplinasAproveitadas(new Integer(dadosSQL.getInt("transferenciaEntradaDisciplinasAproveitadas")));
		// Dados do Matricula Periodo
		obj.getMatriculaPeriodo().setCodigo(dadosSQL.getInt("matriculaPeriodo"));
		obj.getMatriculaPeriodo().setAno(dadosSQL.getString("ano"));
		obj.getMatriculaPeriodo().setSemestre(dadosSQL.getString("semestre"));
		// Dados da Disciplinas
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina.codigo")));
		obj.getDisciplina().setNome(dadosSQL.getString("disciplina.nome"));
		// obj.getGradeDisciplinaVO().setCargaHoraria(dadosSQL.getInt("gradedisciplina.cargaHoraria"));
		// Dados da Matricula
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula"));
		// Dados da Periodo Letivo
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina")));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setIdentificadorTurma(dadosSQL.getString("turma.identificadorTurma"));
		// obj.getPerioDisciplina().setCodigo(new
		// Integer(dadosSQL.getInt("periodoletivo")));
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));
	}

	private void montarDadosDetalhadoConsultaPorMatriculaRelDisciplinaACursar(HistoricoAlunoDisciplinaRelVO obj, SqlRowSet dadosSQL, boolean utilizarNomeCertificacaoPeriodoLetivo, UsuarioVO usuario) throws Exception {
		obj.setSituacaoFinal("NC");
		obj.setSituacaoPeriodo("NC");
		if (utilizarNomeCertificacaoPeriodoLetivo) {
			if (Uteis.isAtributoPreenchido(dadosSQL.getString("periodoletivo_nomecertificacao"))) {
				obj.setNomePeriodo(dadosSQL.getString("periodoletivo_nomecertificacao"));
			} else {
				obj.setNomePeriodo(dadosSQL.getString("periodoletivo_descricao"));
			}
		} else {
			obj.setNomePeriodo(dadosSQL.getInt("periodoLetivo_periodoLetivo") + "°");
		}
		obj.setNumeroPeriodoLetivo(dadosSQL.getInt("periodoLetivo_periodoLetivo"));
		obj.setCodigoDisciplina(new Integer(dadosSQL.getInt("disciplina_codigo")));
		obj.setNomeDisciplina(dadosSQL.getString("disciplina_nome"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("gradeDisciplina_cargaHoraria"));
		obj.setChDisciplina(String.valueOf(dadosSQL.getInt("gradeDisciplina_cargaHoraria")));
		obj.setAbreviaturaDisciplina(dadosSQL.getString("disciplina_abreviatura"));
		obj.setSituacaoHistorico("A CURSAR");
	}

	private void montarDadosDetalhadoConsultaPorMatriculaRel(HistoricoVO obj, SqlRowSet dadosSQL, UsuarioVO usuario) throws Exception {
		// Dados do Historico
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setInstituicao(dadosSQL.getString("instituicao"));
		obj.setCidade(dadosSQL.getString("cidade"));
		obj.getCidadeVO().setCodigo(dadosSQL.getInt("codigoCidade"));
		obj.getCidadeVO().setNome(dadosSQL.getString("cidade"));
		obj.getCidadeVO().getEstado().setSigla(dadosSQL.getString("estado"));
		obj.setEstado(dadosSQL.getString("estado"));
		obj.setAnoHistorico(dadosSQL.getString("anohistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestrehistorico"));
		obj.setHistoricoDisciplinaComposta(dadosSQL.getBoolean("historicoDisciplinaComposta"));
		obj.setHistoricoDisciplinaFazParteComposicao(dadosSQL.getBoolean("historicoDisciplinaFazParteComposicao"));
		obj.setObservacao(dadosSQL.getString("observacao"));
		obj.setFreguencia(dadosSQL.getDouble("freguencia"));
		obj.setCargaHorariaAproveitamentoDisciplina(dadosSQL.getInt("gradedisciplina_cargaHoraria"));
		obj.setHistoricoDisciplinaAtividadeComplementar(dadosSQL.getBoolean("historicoDisciplinaAtividadeComplementar"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaCursada"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("utilizaNotaFinalConceito"));
		obj.setHistoricoDisciplinaForaGrade(dadosSQL.getBoolean("historicodisciplinaforagrade"));
		obj.setNotaFinalConceito(dadosSQL.getString("notaFinalConceito"));
		obj.setTotalDiaLetivoAno(dadosSQL.getInt("totaldialetivoano"));
		obj.setTotalFalta(dadosSQL.getInt("totalfalta"));
		obj.setTipoHistorico(dadosSQL.getString("tipoHistorico"));
		obj.setNumeroAgrupamentoEquivalenciaDisciplina(dadosSQL.getInt("numeroAgrupamentoEquivalenciaDisciplina"));
		obj.setCargaHorariaDisciplina(dadosSQL.getInt("gradedisciplina_cargaHoraria"));
		obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("codigo_configuracaoacademico"));
		obj.getConfiguracaoAcademico().setQuantidadeCasasDecimaisPermitirAposVirgula(dadosSQL.getInt("quantidadeCasasDecimaisPermitirAposVirgula"));
		obj.getConfiguracaoAcademico().setApresentarPeriodoLetivoMatriculaPeriodoAtualHistorico(dadosSQL.getBoolean("apresentarPeriodoLetivoMatriculaPeriodoAtualHistorico"));
		obj.getConfiguracaoAcademico().setApresentarSiglaConcessaoCredito(dadosSQL.getBoolean("apresentarSiglaConcessaoCredito"));
		obj.getConfiguracaoAcademico().setApresentarTotalAulaRegistradaComoCargaHorariaCursadaNoHistorico(dadosSQL.getBoolean("apresentarTotalAulaRegistradaComoCargaHorariaCursadaNoHistorico"));
		obj.getConfiguracaoAcademico().setOcultarMediaFinalDisciplinaCasoReprovado(dadosSQL.getBoolean("ocultarMediaFinalDisciplinaCasoReprovado"));
		if (dadosSQL.getObject("mediaFinal") == null) {
			obj.setMediaFinal((Double) dadosSQL.getObject("mediaFinal"));
		} else {
			obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		}
		obj.setApresentarAprovadoHistorico(dadosSQL.getBoolean("apresentarAprovadoHistorico"));
		obj.setHistoricoDisciplinaOptativa(dadosSQL.getBoolean("historicodisciplinaoptativa"));
		// Dados do Matricula Periodo
		obj.getMatriculaPeriodo().setAno(dadosSQL.getString("ano"));
		obj.getMatriculaPeriodo().setCodigo(dadosSQL.getInt("matriculaPeriodo_codigo"));
		obj.getMatriculaPeriodo().setSemestre(dadosSQL.getString("semestre"));
		obj.getMatriculaPeriodo().setSituacaoMatriculaPeriodo(dadosSQL.getString("matriculaperiodo_situacaomatriculaperiodo"));
		obj.getPeriodoLetivoCursada().setPeriodoLetivo(dadosSQL.getInt("periodoletivo2"));
		obj.getPeriodoLetivoCursada().setCodigo(dadosSQL.getInt("periodoLetivo2_codigo"));
		obj.getPeriodoLetivoMatrizCurricular().setPeriodoLetivo(dadosSQL.getInt("periodoletivo1"));
		obj.getPeriodoLetivoMatrizCurricular().setCodigo(dadosSQL.getInt("periodoletivo_codigo"));
		if (obj.getConfiguracaoAcademico().getApresentarPeriodoLetivoMatriculaPeriodoAtualHistorico()) {
			obj.getMatriculaPeriodo().getPeridoLetivo().setPeriodoLetivo(dadosSQL.getInt("periodoletivo2"));
			obj.getMatriculaPeriodo().getPeridoLetivo().setCodigo(dadosSQL.getInt("periodoLetivo2_codigo"));
		} else if (obj.getHistoricoDisciplinaForaGrade().booleanValue()) {
			obj.getMatriculaPeriodo().getPeridoLetivo().setPeriodoLetivo(dadosSQL.getInt("periodoletivo1"));
			obj.getMatriculaPeriodo().getPeridoLetivo().setCodigo(dadosSQL.getInt("periodoletivo_codigo"));
			if (obj.getMatriculaPeriodo().getPeridoLetivo().getCodigo().intValue() == 0) {
				obj.getMatriculaPeriodo().getPeridoLetivo().setPeriodoLetivo(dadosSQL.getInt("periodoletivo2"));
				obj.getMatriculaPeriodo().getPeridoLetivo().setCodigo(dadosSQL.getInt("periodoletivo2_codigo"));
			}
		} else {
			obj.getMatriculaPeriodo().getPeridoLetivo().setPeriodoLetivo(dadosSQL.getInt("periodoletivo1"));
			obj.getMatriculaPeriodo().getPeridoLetivo().setCodigo(dadosSQL.getInt("periodoletivo_codigo"));
		}
		// Dados da Disciplinas
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina_codigo")));
		obj.getDisciplina().setNome(dadosSQL.getString("disciplina_nome"));
		obj.getDisciplina().setAbreviatura(dadosSQL.getString("disciplina_abreviatura"));
		obj.getGradeDisciplinaVO().setCargaHoraria(dadosSQL.getInt("gradeDisciplina_cargaHoraria"));
		obj.getGradeDisciplinaVO().setNrCreditos(dadosSQL.getInt("gradedisciplina_nrcreditos"));
		obj.getGradeDisciplinaVO().setNomeChancela(dadosSQL.getString("gradedisciplina_nomeChancela"));
		obj.getGradeDisciplinaVO().setTipoDisciplina(dadosSQL.getString("gradeDisciplina_tipoDisciplina"));
		obj.setDisciplinaReferenteAUmGrupoOptativa(dadosSQL.getBoolean("disciplinareferenteaumgrupooptativa"));

		// dados UnidadeEnsino
		obj.getMatricula().getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino_codigo"));
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula"));
		// dados MatriculaPeriodoTurmaDisciplina
		obj.getMatriculaPeriodoTurmaDisciplina().setDisciplinaEquivale(dadosSQL.getBoolean("mptd_disciplinaequivale"));
		obj.getMatriculaPeriodoTurmaDisciplina().getDisciplina().setCodigo(dadosSQL.getInt("mptd_disciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(dadosSQL.getInt("mptd_codigo"));
		if (dadosSQL.getInt("mfc_codigo") > 0) {
			obj.getMediaFinalConceito().setCodigo(dadosSQL.getInt("mfc_codigo"));
			obj.getMediaFinalConceito().setNovoObj(false);
			obj.getMediaFinalConceito().setTipoNotaConceito(TipoNotaConceitoEnum.valueOf(dadosSQL.getString("mfc_tipoNotaConceito")));
			obj.getMediaFinalConceito().setAbreviaturaConceitoNota(dadosSQL.getString("mfc_abreviaturaConceitoNota"));
			obj.getMediaFinalConceito().setConceitoNota(dadosSQL.getString("mfc_conceitoNota"));
			obj.getMediaFinalConceito().setSituacao(dadosSQL.getString("mfc_situacao"));
			obj.getMediaFinalConceito().setFaixaNota1(dadosSQL.getDouble("mfc_faixaNota1"));
			obj.getMediaFinalConceito().setFaixaNota2(dadosSQL.getDouble("mfc_faixaNota2"));
		}
		// Dados da GradeDisciplina
		if (dadosSQL.getInt("gradedisciplina_codigo") > 0) {
			obj.getGradeDisciplinaVO().setCodigo(dadosSQL.getInt("gradedisciplina_codigo"));
			obj.getGradeDisciplinaVO().setOrdem(dadosSQL.getInt("gradedisciplina_ordem"));
			obj.getGradeDisciplinaVO().setCargaHoraria(dadosSQL.getInt("gradedisciplina_cargaHoraria"));
			obj.getGradeDisciplinaVO().setDiversificada(dadosSQL.getBoolean("gradedisciplina_diversificada"));
			obj.getGradeDisciplinaVO().setDisciplinaEstagio(dadosSQL.getBoolean("gradedisciplina_disciplinaestagio"));
			obj.getGradeDisciplinaVO().setDisciplinaTCC(dadosSQL.getBoolean("gradedisciplina_disciplinaTcc"));
			obj.getGradeDisciplinaVO().setCargaHorariaTotalPraticaTeorica(dadosSQL.getInt("gradedisciplina_cargahorariatotal"));
			obj.getGradeDisciplinaVO().setCargaHorariaPratica(dadosSQL.getInt("gradedisciplina_cargahorariapratica"));
		}
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));
		obj.setDataPrimeiraAula(dadosSQL.getDate("dataprimeiraaula"));
		obj.setData(dadosSQL.getDate("data"));
		obj.setDataRegistro(dadosSQL.getDate("dataregistro"));
	}

	private void montarDadosDetalhadoConsultaPorMatriculaRelTransferenciaMatrizCurricular(HistoricoVO obj, SqlRowSet dadosSQL, UsuarioVO usuario) throws Exception {
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula"));
		obj.getMatricula().getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeEnsino"));
		obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		obj.setFreguencia(dadosSQL.getDouble("frequencia"));
		obj.setCargaHorariaAproveitamentoDisciplina(dadosSQL.getInt("cargaHoraria"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaCursada"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setInstituicao(dadosSQL.getString("instituicao"));
		obj.setCidade(dadosSQL.getString("cidade"));
		obj.setEstado(dadosSQL.getString("estado"));
		obj.getCidadeVO().setCodigo(dadosSQL.getInt("codigoCidade"));
		obj.getCidadeVO().setNome(dadosSQL.getString("cidade"));
		obj.getCidadeVO().getEstado().setSigla(dadosSQL.getString("estado"));

		obj.setAnoHistorico(dadosSQL.getString("anohistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestrehistorico"));

		obj.getMatriculaPeriodo().setAno(dadosSQL.getString("ano"));
		obj.getMatriculaPeriodo().setSemestre(dadosSQL.getString("semestre"));

		obj.getDisciplina().setCodigo(dadosSQL.getInt("disciplina.codigo"));
		obj.getDisciplina().setNome(dadosSQL.getString("disciplina.nome"));

		obj.getGradeDisciplinaVO().setTipoDisciplina(dadosSQL.getString("tipoDisciplina"));
		obj.getGradeDisciplinaVO().setCargaHoraria(dadosSQL.getInt("cargaHoraria"));
		obj.getMatriculaPeriodo().getPeriodoLetivo().setCodigo(dadosSQL.getInt("periodoletivo.codigo"));
		obj.getMatriculaPeriodo().getPeridoLetivo().setPeriodoLetivo(dadosSQL.getInt("periodoLetivo"));
		obj.getGradeDisciplinaVO().setCargaHoraria(dadosSQL.getInt("gradedisciplina_cargahoraria"));
		obj.getGradeDisciplinaVO().setCargaHorariaPratica(dadosSQL.getInt("gradedisciplina_cargahorariapratica"));

	}

	private void montarDadosDetalhadoConsultaPorMatriculaRelDisciplinasForaGrade(HistoricoVO obj, SqlRowSet dadosSQL, UsuarioVO usuario) throws Exception {
		// Dados do Historico
		obj.setSituacao(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor());
		obj.setFreguencia(dadosSQL.getDouble("frequencia"));
		obj.setMediaFinal(dadosSQL.getDouble("nota"));
		obj.setInstituicao(dadosSQL.getString("instituicao"));
		obj.setCidade(dadosSQL.getString("cidade"));
		obj.setEstado(dadosSQL.getString("estado"));
		// Dados do Matricula Periodo
		obj.getMatriculaPeriodo().setAno(dadosSQL.getString("ano"));
		obj.getMatriculaPeriodo().setSemestre(dadosSQL.getString("semestre"));
		obj.getMatriculaPeriodo().getPeridoLetivo().setCodigo(dadosSQL.getInt("codigoPeriodoLetivo"));
		obj.getMatriculaPeriodo().getPeridoLetivo().setPeriodoLetivo(dadosSQL.getInt("periodoletivo"));
		// Dados da Disciplinas
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplinaCodigo")));
		obj.getDisciplina().setNome(dadosSQL.getString("disciplinaNome"));
		obj.getGradeDisciplinaVO().setCargaHoraria(dadosSQL.getInt("cargaHoraria"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaCursada"));
		// dados UnidadeEnsino
		obj.getMatricula().getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeensino"));
		// dados MatriculaPeriodoTurmaDisciplina
		obj.getMatriculaPeriodoTurmaDisciplina().getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplinaCodigo")));

		obj.setHistoricoDisciplinaForaGrade(true);

	}

	public List consultarPorMatriculaDisciplinaSituacao(String valorConsulta, Integer disciplina, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT Historico.* FROM historico " + " INNER JOIN matricula ON (Matricula.matricula = historico.matricula) " + "WHERE historico.matricula =  '" + valorConsulta + "' " + " and matricula.gradeCurricularAtual = historico.matrizCurricular " // trazer
																																																																		// somente
																																																																		// historicos
																																																																		// da
																																																																		// matriz
																																																																		// curricular
																																																																		// atual
																																																																		// do
																																																																		// aluno
				+ " and disciplina= " + disciplina.intValue() + " ";
		sqlStr += " ORDER BY Matricula";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List consultarPorMatriculaDisciplinasAprovadas(String valorConsulta, Integer disciplina, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" SELECT Historico.* FROM historico");
		sqlStr.append(" WHERE Historico.matricula = ? AND Historico.disciplina= ?");
		sqlStr.append(" AND ((Historico.situacao = ? )  OR (Historico.situacao = ? )) ");
		sqlStr.append(" ORDER BY historico.disciplina ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { valorConsulta, disciplina, SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor(), SituacaoHistorico.APROVADO.getValor() });
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List consultarPorMatriculaDisciplinaAproveitamento(String matricula, Integer disciplina, String situacao, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT Historico.* FROM historico WHERE Historico.matricula = '" + matricula + "' and Historico.disciplina = " + disciplina + " ";
		if (!situacao.equals("")) {
			sqlStr += "and ((Historico.situacao = '" + situacao + "') ";
			if (situacao.equals("AP")) {
				sqlStr += " or (Historico.situacao = 'AA' )";
			}
			sqlStr += " ) ";
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List consultarPorMatriculaDisciplinaAprovado_Cursando(String matricula, Integer disciplina, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT Historico.* FROM historico WHERE Historico.matricula = '" + matricula + "' and Historico.disciplina = " + disciplina + " ";
		sqlStr += "and ((Historico.situacao = 'CS') ";
		sqlStr += " or (Historico.situacao = 'AA' )";
		sqlStr += " or (Historico.situacao = 'IS' )";
		sqlStr += " or (Historico.situacao = 'AP' ))";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List consultarDisciplinasDoHistoricoPorMatriculaTipoDisciplinaSituacao(String matricula, String situacao, String tipoDisciplina1, String tipoDisciplina2, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" SELECT DISTINCT historico.* ");
		sqlStr.append(" FROM matricula ");
		sqlStr.append(" INNER JOIN gradecurricular ON gradecurricular.codigo = matricula.gradecurricularatual ");
		sqlStr.append(" INNER JOIN periodoletivo ON periodoletivo.gradecurricular = gradecurricular.codigo ");
		sqlStr.append(" INNER JOIN gradedisciplina ON gradedisciplina.periodoletivo = periodoletivo.codigo");
		sqlStr.append(" INNER JOIN disciplina ON gradedisciplina.disciplina = disciplina.codigo");
		sqlStr.append(" LEFT JOIN historico ON historico.matricula = matricula.matricula AND historico.gradedisciplina = gradedisciplina.codigo ");
		sqlStr.append(" WHERE matricula.matricula = '").append(matricula).append("' AND historico.situacao in (").append(situacao);
		sqlStr.append(") AND (gradedisciplina.tipodisciplina = '").append(tipoDisciplina1).append("' OR gradedisciplina.tipodisciplina = '").append(tipoDisciplina2).append("')");
		sqlStr.append(" ORDER BY historico.disciplina");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List<HistoricoVO> consultarPorCodigoDisciplinaExcluirDisciplinaPermanecerUnificacaoDisciplina(Integer disciplinaExcluir, Integer disciplinaPermanecer, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select h1.* from historico h1, historico h2 ");
		sqlStr.append(" where h1.matriculaperiodo = h2.matriculaPeriodo and h1.disciplina = ");
		sqlStr.append(disciplinaExcluir);
		sqlStr.append(" and h2.disciplina = ");
		sqlStr.append(disciplinaPermanecer);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public Boolean consultarExistenciaHistoricoPorCodigoDisciplina(Integer disciplina, Integer matriculaPeriodo) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT * FROM historico WHERE disciplina = ");
		sqlStr.append(disciplina);
		sqlStr.append(" and matriculaperiodo = ");
		sqlStr.append(matriculaPeriodo);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return true;
		}
		return false;
	}

	public HistoricoVO consultarPorMatriculaPeriodoTurmaDisciplina(Integer matriculaPeriodoTurmaDisciplina, boolean filtroVisaoProfessor, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append("WHERE matriculaPeriodoTurmaDisciplina.codigo = ").append(matriculaPeriodoTurmaDisciplina);
		sqlStr.append(" order by case when historico.matrizcurricular =  matricula.gradecurricularatual then 0 else 1 end limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		HistoricoVO obj = new HistoricoVO();
		if (tabelaResultado.next()) {
			montarDadosCompleto(obj, tabelaResultado, filtroVisaoProfessor, true, true, usuario);
		}
		return obj;
	}

	public List consultarPorMatricula_matriculaPeriodoTodos(String matricula, Integer matriculaPeriodo, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM Historico WHERE matricula = '" + matricula + "' and matriculaPeriodo = " + matriculaPeriodo.intValue() + " ORDER BY matricula";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public HistoricoVO consultaRapidaPorMatriula_Disciplina_Semestre_Ano(String matricula, Integer disciplina, String semestre, String ano, boolean controlarAcesso, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (ano == null) {
			ano = "";
		}
		if (semestre == null) {
			semestre = "";
		}
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select distinct Historico.codigo from Historico, matricula, matriculaPeriodo where Historico.matricula = matricula.matricula ");
		sqlStr.append(" and matriculaPeriodo.codigo = Historico.matriculaPeriodo ");
		if (!semestre.equals("")) {
			sqlStr.append(" and matriculaPeriodo.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			sqlStr.append(" and matriculaPeriodo.ano = '").append(ano).append("' ");
		}
		sqlStr.append(" and disciplina = ").append(disciplina).append(" and matricula.matricula = '").append(matricula).append("' order by (case when historico.matrizcurricular =  matricula.gradecurricularatual then 0 else 1 end)  limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());

		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO obj = new HistoricoVO();
		obj.setCodigo(tabelaResultado.getInt("codigo"));
		carregarDados(obj, nivelMontarDados, usuario);
		return obj;
	}

	public HistoricoVO consultaRapidaPorMatriula_Disciplina_Semestre_Ano_Turma(String matricula, Integer disciplina, String semestre, String ano, Integer turma, boolean controlarAcesso, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (ano == null) {
			ano = "";
		}
		if (semestre == null) {
			semestre = "";
		}
		if (matricula.equals("15-2012-1-0028")) {
			semestre = "";
		}
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select distinct Historico.codigo from Historico");
		sqlStr.append(" inner join matricula on (Historico.matricula = matricula.matricula) ");
		sqlStr.append(" inner join matriculaPeriodo on (matriculaPeriodo.codigo = Historico.matriculaPeriodo) ");
		sqlStr.append(" inner join matriculaPeriodoTurmaDisciplina on (Historico.matriculaPeriodoTurmaDisciplina = matriculaPeriodoTurmaDisciplina.codigo) ");
		sqlStr.append(" WHERE matriculaPeriodoTurmaDisciplina.turma = ").append(turma);
		if (!semestre.equals("")) {
			sqlStr.append(" and matriculaPeriodo.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			sqlStr.append(" and matriculaPeriodo.ano = '").append(ano).append("' ");
		}
		sqlStr.append(" and matriculaPeriodoTurmaDisciplina.disciplina = ").append(disciplina).append(" and matricula.matricula = '").append(matricula).append("' limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());

		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO obj = new HistoricoVO();
		obj.setCodigo(tabelaResultado.getInt("codigo"));
		carregarDados(obj, nivelMontarDados, usuario);
		return obj;
	}

	public HistoricoVO consultaRapidaAlunoAprovadoDisciplinaPorMatriula_Disciplina(String matricula, Integer disciplina, String semestre, String ano, boolean controlarAcesso, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (ano == null) {
			ano = "";
		}
		if (semestre == null) {
			semestre = "";
		}
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select distinct Historico.codigo from Historico, matricula, matriculaPeriodo where Historico.matricula = matricula.matricula ");
		sqlStr.append(" and matriculaPeriodo.codigo = Historico.matriculaPeriodo ");
		sqlStr.append(" and disciplina = ").append(disciplina);
		sqlStr.append(" and matricula.matricula = '").append(matricula).append("'");
		sqlStr.append(" and (historico.situacao = 'AP' or historico.situacao = 'AA' or historico.situacao = 'CS')limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO obj = new HistoricoVO();
		obj.setCodigo(tabelaResultado.getInt("codigo"));
		carregarDados(obj, nivelMontarDados, usuario);
		return obj;
	}

	public HistoricoVO consultarPorMatriula_Disciplina_Semestre_Ano(String matricula, Integer disciplina, String semestre, String ano, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		if (ano == null) {
			ano = "";
		}
		if (semestre == null) {
			semestre = "";
		}
		StringBuilder sqlStr = new StringBuilder("select distinct Historico.* from Historico, matricula, matriculaPeriodo where Historico.matricula = matricula.matricula ");
		sqlStr.append(" and matriculaPeriodo.codigo = Historico.matriculaPeriodo ");
		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		if (!semestre.equals("")) {
			sqlStr.append(" and matriculaPeriodo.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			sqlStr.append(" and matriculaPeriodo.ano = '").append(ano).append("' ");
		}
		sqlStr.append(" and disciplina = ").append(disciplina).append(" and matricula.matricula = '").append(matricula).append("' ");
		sqlStr.append(" and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
        sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
        sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		return montarDados(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public HistoricoVO consultarPorMatricula_matriculaPeriodo_Disciplina(String matricula, Integer matriculaPeriodo, Integer disciplina, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM Historico WHERE matricula = '" + matricula + "' and matriculaPeriodo = " + matriculaPeriodo.intValue() + " and disciplina = " + disciplina.intValue() + " ORDER BY matricula";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (!tabelaResultado.next()) {
			return null;
		}
		return montarDados(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	/**
	 * Versão 5.0 Método alterado para incluir no seu filtro o codigo da Matriz
	 * curricular. Isto por que a partir da versão 5.0, todo histórico deverá
	 * estar vinculado a uma matriz Curricular. De forma que, quando o aluno
	 * fizer uma transferencia de matriz, por exemplo, toda vida do mesmo na
	 * matriz antiga, seja totalmente preservada. Ficando a vida academica (do
	 * ponto de vista de historico) na nova matriz curricular totalmente isolada
	 * e independente da outra.
	 *
	 * @param matricula
	 * @param matriculaPeriodo
	 * @param gradeCurricular
	 * @param disciplina
	 * @param controlarAcesso
	 * @param usuario
	 * @return
	 * @throws Exception
	 */
	public HistoricoVO consultaRapidaPorMatricula_matriculaPeriodo_Disciplina(String matricula, Integer matriculaPeriodo, Integer gradeCurricular, Integer disciplina, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (matricula.matricula = '").append(matricula).append("') ");
		sqlStr.append(" AND (historico.matrizCurricular = ").append(gradeCurricular).append(") ");
		if (matriculaPeriodo != 0) {
			sqlStr.append(" AND (matriculaPeriodo.codigo = ").append(matriculaPeriodo).append(") ");
		}
		if (disciplina.intValue() != 0) {
			sqlStr.append(" AND (disciplina.codigo = ").append(disciplina).append(") ");
		}

		sqlStr.append(" ORDER BY historico.codigo desc");

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO historicoVO = new HistoricoVO();
		montarDadosCompleto(historicoVO, tabelaResultado, usuario);
		return historicoVO;
	}

	public List<HistoricoVO> consultaRapidaHistoricoFazParteComposicaoPorMatriculaPorGradeCurricularPorMatriculaPeriodo(String matricula, Integer historicoFazParteComposicao, Integer matriculaPeriodo, Integer gradeCurricular, Integer gradeDisciplina, Integer gradeCurricularGrupoOptativaDisciplina, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
//		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select distinct historico.codigo, historico.configuracaoAcademico, historico.freguencia, gradeDisciplinaComposta.variavelNota, historico.mediafinal, historico.creditodisciplina,  ");
		sqlStr.append(" historico.nota1, historico.nota2, historico.nota3, historico.nota4, historico.nota5, historico.nota6, historico.nota7, historico.nota8, historico.nota9, historico.nota10, ");
		sqlStr.append(" historico.nota11, historico.nota12, historico.nota13, historico.nota14, historico.nota15, historico.nota16, historico.nota17, historico.nota18, historico.nota19, historico.nota20, ");
		sqlStr.append(" historico.nota21, historico.nota22, historico.nota23, historico.nota24, historico.nota25, historico.nota26, historico.nota27, historico.nota28, historico.nota29, historico.nota30, ");
		sqlStr.append(" historico.nota31, historico.nota32, historico.nota33, historico.nota34, historico.nota35, historico.nota36, historico.nota37, historico.nota38, historico.nota39, historico.nota40, historico.apresentarAprovadoHistorico, ");
		sqlStr.append(" historico.nota1lancada, historico.nota2lancada, historico.nota3lancada, historico.nota4lancada, historico.nota5lancada, historico.nota6lancada, historico.nota7lancada, historico.nota8lancada, historico.nota9lancada, historico.nota10lancada, ");
		sqlStr.append(" historico.nota11lancada, historico.nota12lancada, historico.nota13lancada, historico.nota14lancada, historico.nota15lancada, historico.nota16lancada, historico.nota17lancada, historico.nota18lancada, historico.nota19lancada, historico.nota20lancada, ");
		sqlStr.append(" historico.nota21lancada, historico.nota22lancada, historico.nota23lancada, historico.nota24lancada, historico.nota25lancada, historico.nota26lancada, historico.nota27lancada, historico.nota28lancada, historico.nota29lancada, historico.nota30lancada, ");
		sqlStr.append(" historico.nota31lancada, historico.nota32lancada, historico.nota33lancada, historico.nota34lancada, historico.nota35lancada, historico.nota36lancada, historico.nota37lancada, historico.nota38lancada, historico.nota39lancada, historico.nota40lancada, ");

		sqlStr.append(" historico.FaltaPrimeiroBimestre, historico.FaltaSegundoBimestre, historico.FaltaTerceiroBimestre, historico.FaltaQuartoBimestre, historico.totalFalta, ");
		sqlStr.append(" historico.frequenciaTeorica, historico.frequenciaPratica, historico.situacao, gradedisciplinacomposta.ordem  as \"gradedisciplinacomposta.ordem\",  ");
		sqlStr.append(" historico.disciplina, historico.matriculaperiodoturmadisciplina, matriculaperiodoturmadisciplina.turma, matriculaperiodoturmadisciplina.turmapratica, matriculaperiodoturmadisciplina.turmateorica, ");
		sqlStr.append(" gradedisciplinacomposta.codigo as gradedisciplinacomposta, gradedisciplinacomposta.cargahoraria  as \"gradedisciplinacomposta.cargahoraria\",  gradedisciplinacomposta.nrcreditos  as \"gradedisciplinacomposta.nrcreditos\",  ");
		sqlStr.append(" gradedisciplinacomposta.cargahorariapratica  as \"gradedisciplinacomposta.cargahorariapratica\", gradedisciplinacomposta.cargahorariateorica  as \"gradedisciplinacomposta.cargahorariateorica\",  ");
		sqlStr.append(" gradedisciplinacomposta.horaaula  as \"gradedisciplinacomposta.horaaula\", ");
		sqlStr.append(" historico.anohistorico, ");
		sqlStr.append(" historico.semestrehistorico, ");
		sqlStr.append(" historico.matricula, ");
		sqlStr.append(" historico.matriculaperiodo, ");
		sqlStr.append(" matriculaperiodoturmadisciplina.ano  as \"mptd.ano\", ");
		sqlStr.append(" matriculaperiodoturmadisciplina.semestre  as \"mptd.semestre\" ");
		sqlStr.append(" FROM historico AS historico LEFT JOIN matricula on matricula.matricula = historico.matricula ");
		sqlStr.append(" LEFT JOIN matriculaPeriodo on matriculaPeriodo.matricula = matricula.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		sqlStr.append(" LEFT JOIN matriculaperiodoturmadisciplina on matriculaperiodoturmadisciplina.codigo = historico.matriculaperiodoturmadisciplina ");
		sqlStr.append(" LEFT JOIN gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		sqlStr.append(" WHERE (matricula.matricula = '").append(matricula).append("') ");
		sqlStr.append(" AND (historico.matrizCurricular = ").append(gradeCurricular).append(") ");
		if (matriculaPeriodo != 0) {
			sqlStr.append(" AND (matriculaPeriodo.codigo = ").append(matriculaPeriodo).append(") ");
		}
		if (historicoFazParteComposicao.intValue() != 0) {
			sqlStr.append(" AND historico.codigo != ").append(historicoFazParteComposicao);
		}
		if (gradeDisciplina.intValue() != 0) {
			sqlStr.append(" and historico.gradedisciplinacomposta in( ");
			sqlStr.append(" select gradedisciplinacomposta.codigo from gradedisciplinacomposta where gradedisciplina = ").append(gradeDisciplina);
			sqlStr.append(") ");
		} else {
			sqlStr.append(" and historico.gradedisciplinacomposta in( ");
			sqlStr.append(" select gradedisciplinacomposta.codigo from gradedisciplinacomposta where gradecurriculargrupooptativadisciplina = ").append(gradeCurricularGrupoOptativaDisciplina);
			sqlStr.append(") ");
		}
		sqlStr.append(" ORDER BY gradedisciplinacomposta.ordem, historico.codigo");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> listaHistoricoVO = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO historicoVO = new HistoricoVO();
			montarDadosNotaLancada(historicoVO, tabelaResultado, false, usuario);
			listaHistoricoVO.add(historicoVO);
		}
		return listaHistoricoVO;
	}

	public void montarDadosNotaLancada(HistoricoVO obj, SqlRowSet dadosSQL, boolean filtroVisaoProfessor, UsuarioVO usuario) {
		obj.setCodigo(dadosSQL.getInt("codigo"));
		obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("configuracaoAcademico"));
		obj.setFreguencia(dadosSQL.getDouble("freguencia"));
		obj.getGradeDisciplinaComposta().setCodigo(dadosSQL.getInt("gradedisciplinacomposta"));
		obj.getGradeDisciplinaComposta().setVariavelNota(dadosSQL.getString("variavelNota"));
		obj.getGradeDisciplinaComposta().setOrdem(dadosSQL.getInt("gradedisciplinacomposta.ordem"));
		obj.getGradeDisciplinaComposta().setCargaHoraria(dadosSQL.getInt("gradedisciplinacomposta.cargahoraria"));
		obj.getGradeDisciplinaComposta().setCargaHorariaPratica(dadosSQL.getInt("gradedisciplinacomposta.cargahorariapratica"));
		obj.getGradeDisciplinaComposta().setCargaHorariaTeorica(dadosSQL.getInt("gradedisciplinacomposta.cargahorariateorica"));
		obj.getGradeDisciplinaComposta().setHoraAula(dadosSQL.getInt("gradedisciplinacomposta.horaaula"));
		obj.getGradeDisciplinaComposta().setNrCreditos(dadosSQL.getInt("gradedisciplinacomposta.nrcreditos"));
		obj.setCreditoDisciplina(dadosSQL.getInt("gradedisciplinacomposta.nrcreditos"));
		obj.setCargaHorariaDisciplina(dadosSQL.getInt("gradedisciplinacomposta.cargahoraria"));
		obj.getDisciplina().setCodigo(dadosSQL.getInt("disciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(dadosSQL.getInt("matriculaperiodoturmadisciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setCodigo(dadosSQL.getInt("turma"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().setCodigo(dadosSQL.getInt("turmapratica"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().setCodigo(dadosSQL.getInt("turmateorica"));
		obj.getMatriculaPeriodoTurmaDisciplina().setAno(dadosSQL.getString("mptd.ano"));
		obj.getMatriculaPeriodoTurmaDisciplina().setSemestre(dadosSQL.getString("mptd.semestre"));
		obj.setAnoHistorico(dadosSQL.getString("anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestreHistorico"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula"));
		obj.getMatriculaPeriodoTurmaDisciplina().setMatricula(dadosSQL.getString("matricula"));
		obj.getMatriculaPeriodoTurmaDisciplina().getMatriculaObjetoVO().setMatricula(dadosSQL.getString("matricula"));
		obj.getMatriculaPeriodo().setCodigo(dadosSQL.getInt("matriculaperiodo"));
		obj.getMatriculaPeriodoTurmaDisciplina().setMatriculaPeriodo(dadosSQL.getInt("matriculaperiodo"));
		obj.getMatriculaPeriodoTurmaDisciplina().getMatriculaPeriodoObjetoVO().setCodigo(dadosSQL.getInt("matriculaperiodo"));
		if (dadosSQL.getObject("mediaFinal") == null) {
			obj.setMediaFinal((Double) dadosSQL.getObject("mediaFinal"));
		} else {
			obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		}
		if (dadosSQL.getObject("nota1") == null) {
			obj.setNota1((Double) dadosSQL.getObject("nota1"));
		} else {
			obj.setNota1(dadosSQL.getDouble("nota1"));
		}
		if (dadosSQL.getObject("nota2") == null) {
			obj.setNota2((Double) dadosSQL.getObject("nota2"));
		} else {
			obj.setNota2(dadosSQL.getDouble("nota2"));
		}
		if (dadosSQL.getObject("nota3") == null) {
			obj.setNota3((Double) dadosSQL.getObject("nota3"));
		} else {
			obj.setNota3(dadosSQL.getDouble("nota3"));
		}
		if (dadosSQL.getObject("nota4") == null) {
			obj.setNota4((Double) dadosSQL.getObject("nota4"));
		} else {
			obj.setNota4(dadosSQL.getDouble("nota4"));
		}
		if (dadosSQL.getObject("nota5") == null) {
			obj.setNota5((Double) dadosSQL.getObject("nota5"));
		} else {
			obj.setNota5(dadosSQL.getDouble("nota5"));
		}
		if (dadosSQL.getObject("nota6") == null) {
			obj.setNota6((Double) dadosSQL.getObject("nota6"));
		} else {
			obj.setNota6(dadosSQL.getDouble("nota6"));
		}
		if (dadosSQL.getObject("nota7") == null) {
			obj.setNota7((Double) dadosSQL.getObject("nota7"));
		} else {
			obj.setNota7(dadosSQL.getDouble("nota7"));
		}
		if (dadosSQL.getObject("nota8") == null) {
			obj.setNota8((Double) dadosSQL.getObject("nota8"));
		} else {
			obj.setNota8(dadosSQL.getDouble("nota8"));
		}
		if (dadosSQL.getObject("nota9") == null) {
			obj.setNota9((Double) dadosSQL.getObject("nota9"));
		} else {
			obj.setNota9(dadosSQL.getDouble("nota9"));
		}
		if (dadosSQL.getObject("nota10") == null) {
			obj.setNota10((Double) dadosSQL.getObject("nota10"));
		} else {
			obj.setNota10(dadosSQL.getDouble("nota10"));
		}
		if (dadosSQL.getObject("nota11") == null) {
			obj.setNota11((Double) dadosSQL.getObject("nota11"));
		} else {
			obj.setNota11(dadosSQL.getDouble("nota11"));
		}
		if (dadosSQL.getObject("nota12") == null) {
			obj.setNota12((Double) dadosSQL.getObject("nota12"));
		} else {
			obj.setNota12(dadosSQL.getDouble("nota12"));
		}
		if (dadosSQL.getObject("nota13") == null) {
			obj.setNota13((Double) dadosSQL.getObject("nota13"));
		} else {
			obj.setNota13(dadosSQL.getDouble("nota13"));
		}
		if (dadosSQL.getObject("nota14") == null) {
			obj.setNota14((Double) dadosSQL.getObject("nota14"));
		} else {
			obj.setNota14(dadosSQL.getDouble("nota14"));
		}
		if (dadosSQL.getObject("nota15") == null) {
			obj.setNota15((Double) dadosSQL.getObject("nota15"));
		} else {
			obj.setNota15(dadosSQL.getDouble("nota15"));
		}
		if (dadosSQL.getObject("nota16") == null) {
			obj.setNota16((Double) dadosSQL.getObject("nota16"));
		} else {
			obj.setNota16(dadosSQL.getDouble("nota16"));
		}
		if (dadosSQL.getObject("nota17") == null) {
			obj.setNota17((Double) dadosSQL.getObject("nota17"));
		} else {
			obj.setNota17(dadosSQL.getDouble("nota17"));
		}
		if (dadosSQL.getObject("nota18") == null) {
			obj.setNota18((Double) dadosSQL.getObject("nota18"));
		} else {
			obj.setNota18(dadosSQL.getDouble("nota18"));
		}
		if (dadosSQL.getObject("nota19") == null) {
			obj.setNota19((Double) dadosSQL.getObject("nota19"));
		} else {
			obj.setNota19(dadosSQL.getDouble("nota19"));
		}
		if (dadosSQL.getObject("nota20") == null) {
			obj.setNota20((Double) dadosSQL.getObject("nota20"));
		} else {
			obj.setNota20(dadosSQL.getDouble("nota20"));
		}
		if (dadosSQL.getObject("nota21") == null) {
			obj.setNota21((Double) dadosSQL.getObject("nota21"));
		} else {
			obj.setNota21(dadosSQL.getDouble("nota21"));
		}
		if (dadosSQL.getObject("nota22") == null) {
			obj.setNota22((Double) dadosSQL.getObject("nota22"));
		} else {
			obj.setNota22(dadosSQL.getDouble("nota22"));
		}
		if (dadosSQL.getObject("nota23") == null) {
			obj.setNota23((Double) dadosSQL.getObject("nota23"));
		} else {
			obj.setNota23(dadosSQL.getDouble("nota23"));
		}
		if (dadosSQL.getObject("nota24") == null) {
			obj.setNota24((Double) dadosSQL.getObject("nota24"));
		} else {
			obj.setNota24(dadosSQL.getDouble("nota24"));
		}
		if (dadosSQL.getObject("nota25") == null) {
			obj.setNota25((Double) dadosSQL.getObject("nota25"));
		} else {
			obj.setNota25(dadosSQL.getDouble("nota25"));
		}
		if (dadosSQL.getObject("nota26") == null) {
			obj.setNota26((Double) dadosSQL.getObject("nota26"));
		} else {
			obj.setNota26(dadosSQL.getDouble("nota26"));
		}
		if (dadosSQL.getObject("nota27") == null) {
			obj.setNota27((Double) dadosSQL.getObject("nota27"));
		} else {
			obj.setNota27(dadosSQL.getDouble("nota27"));
		}
		if (dadosSQL.getObject("nota28") == null) {
			obj.setNota28((Double) dadosSQL.getObject("nota28"));
		} else {
			obj.setNota28(dadosSQL.getDouble("nota28"));
		}
		if (dadosSQL.getObject("nota29") == null) {
			obj.setNota29((Double) dadosSQL.getObject("nota29"));
		} else {
			obj.setNota29(dadosSQL.getDouble("nota29"));
		}
		if (dadosSQL.getObject("nota30") == null) {
			obj.setNota30((Double) dadosSQL.getObject("nota30"));
		} else {
			obj.setNota30(dadosSQL.getDouble("nota30"));
		}
		if (dadosSQL.getObject("nota31") == null) {
			obj.setNota31((Double) dadosSQL.getObject("nota31"));
		} else {
			obj.setNota31(dadosSQL.getDouble("nota31"));
		}
		if (dadosSQL.getObject("nota32") == null) {
			obj.setNota32((Double) dadosSQL.getObject("nota32"));
		} else {
			obj.setNota32(dadosSQL.getDouble("nota32"));
		}
		if (dadosSQL.getObject("nota33") == null) {
			obj.setNota33((Double) dadosSQL.getObject("nota33"));
		} else {
			obj.setNota33(dadosSQL.getDouble("nota33"));
		}
		if (dadosSQL.getObject("nota34") == null) {
			obj.setNota34((Double) dadosSQL.getObject("nota34"));
		} else {
			obj.setNota34(dadosSQL.getDouble("nota34"));
		}
		if (dadosSQL.getObject("nota35") == null) {
			obj.setNota35((Double) dadosSQL.getObject("nota35"));
		} else {
			obj.setNota35(dadosSQL.getDouble("nota35"));
		}
		if (dadosSQL.getObject("nota36") == null) {
			obj.setNota36((Double) dadosSQL.getObject("nota36"));
		} else {
			obj.setNota36(dadosSQL.getDouble("nota36"));
		}
		if (dadosSQL.getObject("nota37") == null) {
			obj.setNota37((Double) dadosSQL.getObject("nota37"));
		} else {
			obj.setNota37(dadosSQL.getDouble("nota37"));
		}
		if (dadosSQL.getObject("nota38") == null) {
			obj.setNota38((Double) dadosSQL.getObject("nota38"));
		} else {
			obj.setNota38(dadosSQL.getDouble("nota38"));
		}
		if (dadosSQL.getObject("nota39") == null) {
			obj.setNota39((Double) dadosSQL.getObject("nota39"));
		} else {
			obj.setNota39(dadosSQL.getDouble("nota39"));
		}
		if (dadosSQL.getObject("nota40") == null) {
			obj.setNota40((Double) dadosSQL.getObject("nota40"));
		} else {
			obj.setNota40(dadosSQL.getDouble("nota40"));
		}

		obj.setNota1Lancada(dadosSQL.getBoolean("nota1Lancada"));
		obj.setNota2Lancada(dadosSQL.getBoolean("nota2Lancada"));
		obj.setNota3Lancada(dadosSQL.getBoolean("nota3Lancada"));
		obj.setNota4Lancada(dadosSQL.getBoolean("nota4Lancada"));
		obj.setNota5Lancada(dadosSQL.getBoolean("nota5Lancada"));
		obj.setNota6Lancada(dadosSQL.getBoolean("nota6Lancada"));
		obj.setNota7Lancada(dadosSQL.getBoolean("nota7Lancada"));
		obj.setNota8Lancada(dadosSQL.getBoolean("nota8Lancada"));
		obj.setNota9Lancada(dadosSQL.getBoolean("nota9Lancada"));
		obj.setNota10Lancada(dadosSQL.getBoolean("nota10Lancada"));
		obj.setNota11Lancada(dadosSQL.getBoolean("nota11Lancada"));
		obj.setNota12Lancada(dadosSQL.getBoolean("nota12Lancada"));
		obj.setNota13Lancada(dadosSQL.getBoolean("nota13Lancada"));
		obj.setNota14Lancada(dadosSQL.getBoolean("nota14Lancada"));
		obj.setNota15Lancada(dadosSQL.getBoolean("nota15Lancada"));
		obj.setNota16Lancada(dadosSQL.getBoolean("nota16Lancada"));
		obj.setNota17Lancada(dadosSQL.getBoolean("nota17Lancada"));
		obj.setNota18Lancada(dadosSQL.getBoolean("nota18Lancada"));
		obj.setNota19Lancada(dadosSQL.getBoolean("nota19Lancada"));
		obj.setNota20Lancada(dadosSQL.getBoolean("nota20Lancada"));
		obj.setNota21Lancada(dadosSQL.getBoolean("nota21Lancada"));
		obj.setNota22Lancada(dadosSQL.getBoolean("nota22Lancada"));
		obj.setNota23Lancada(dadosSQL.getBoolean("nota23Lancada"));
		obj.setNota24Lancada(dadosSQL.getBoolean("nota24Lancada"));
		obj.setNota25Lancada(dadosSQL.getBoolean("nota25Lancada"));
		obj.setNota26Lancada(dadosSQL.getBoolean("nota26Lancada"));
		obj.setNota27Lancada(dadosSQL.getBoolean("nota27Lancada"));
		obj.setNota28Lancada(dadosSQL.getBoolean("nota28Lancada"));
		obj.setNota29Lancada(dadosSQL.getBoolean("nota29Lancada"));
		obj.setNota30Lancada(dadosSQL.getBoolean("nota30Lancada"));
		obj.setNota31Lancada(dadosSQL.getBoolean("nota31Lancada"));
		obj.setNota32Lancada(dadosSQL.getBoolean("nota32Lancada"));
		obj.setNota33Lancada(dadosSQL.getBoolean("nota33Lancada"));
		obj.setNota34Lancada(dadosSQL.getBoolean("nota34Lancada"));
		obj.setNota35Lancada(dadosSQL.getBoolean("nota35Lancada"));
		obj.setNota36Lancada(dadosSQL.getBoolean("nota36Lancada"));
		obj.setNota37Lancada(dadosSQL.getBoolean("nota37Lancada"));
		obj.setNota38Lancada(dadosSQL.getBoolean("nota38Lancada"));
		obj.setNota39Lancada(dadosSQL.getBoolean("nota39Lancada"));
		obj.setNota40Lancada(dadosSQL.getBoolean("nota40Lancada"));
		obj.setApresentarAprovadoHistorico(dadosSQL.getBoolean("apresentarAprovadoHistorico"));
		obj.setFaltaPrimeiroBimestre(dadosSQL.getInt("faltaPrimeiroBimestre"));
		obj.setFaltaSegundoBimestre(dadosSQL.getInt("faltaSegundoBimestre"));
		obj.setFaltaTerceiroBimestre(dadosSQL.getInt("faltaTerceiroBimestre"));
		obj.setFaltaQuartoBimestre(dadosSQL.getInt("faltaQuartoBimestre"));
		obj.setTotalFalta(dadosSQL.getInt("totalFalta"));
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));
	}

	public HistoricoVO consultaRapidaPorMatricula_Ano_Semestre_Disciplina(String matricula, String ano, String semestre, Integer disciplina, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		return consultaRapidaPorMatricula_Ano_Semestre_Disciplina(matricula, ano, semestre, disciplina, 0, controlarAcesso, usuario);
	}

	public HistoricoVO consultaRapidaPorMatricula_Ano_Semestre_Disciplina(String matricula, String ano, String semestre, Integer disciplina, Integer turma, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (matricula.matricula = '").append(matricula).append("') ");
		if (!ano.equals("")) {
			sqlStr.append(" AND (matriculaPeriodo.ano = '").append(ano).append("') ");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" AND (matriculaPeriodo.semestre = '").append(semestre).append("') ");
		}
		if (disciplina.intValue() != 0) {
			sqlStr.append(" AND (disciplina.codigo = ").append(disciplina).append(") ");
		}
		if (turma.intValue() != 0) {
			sqlStr.append(" AND (turma.codigo = ").append(turma).append(") ");
		}

		sqlStr.append(" ORDER BY historico.codigo desc");
		// //System.out.print(sqlStr.toString());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO historicoVO = new HistoricoVO();
		montarDadosCompleto(historicoVO, tabelaResultado, usuario);
		return historicoVO;
	}


	public HistoricoVO consultaRapidaPorCodigoMatriculaPeriodoTurmaDisciplina(Integer codigoMatriculaPeriodoTurmaDisciplina, Integer codigoMatrizCurricular, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (historico.matriculaPeriodoTurmaDisciplina = ").append(codigoMatriculaPeriodoTurmaDisciplina).append(") ");
		if (codigoMatrizCurricular != null) {
			sqlStr.append("   AND (historico.matrizCurricular = ").append(codigoMatrizCurricular).append(") ");
		}
		sqlStr.append(" ORDER BY historico.codigo desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO historicoVO = new HistoricoVO();
		montarDadosCompleto(historicoVO, tabelaResultado, usuario);
		return historicoVO;
	}

	public HistoricoVO consultaRapidaPorMatricula_matriculaPeriodo_Disciplina_Turma(String matricula, Integer matriculaPeriodo, Integer gradeCurricular, Integer disciplina, Integer turma, boolean controlarAcesso, Boolean matriculaExterna, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (matricula.matricula = '").append(matricula).append("') ");
		sqlStr.append(" AND (historico.matrizCurricular = ").append(gradeCurricular).append(") ");
		if (matriculaPeriodo != 0) {
			sqlStr.append(" AND (matriculaPeriodo.codigo = ").append(matriculaPeriodo).append(") ");
		}
		if (disciplina.intValue() != 0) {
			sqlStr.append("   AND (disciplina.codigo = ").append(disciplina).append(") ");
		}
		if (turma.intValue() != 0) {
			sqlStr.append("   AND (turma.codigo = ").append(turma).append(") ");
			if(!matriculaExterna) {
				sqlStr.append(" and historico.matriculaperiodoturmadisciplina is not null " );
			}
		}

		sqlStr.append(" ORDER BY historico.codigo desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO historicoVO = new HistoricoVO();
		montarDadosCompleto(historicoVO, tabelaResultado, usuario);
		return historicoVO;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public HistoricoVO consultaRapidaPorMatricula_Disciplina_Turma(String matricula, Integer disciplina, TurmaVO turma, String ano, String semestre, Boolean trazerBimestreAnoConclusaoDiscplina, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" SELECT DISTINCT historico.codigo, historico.gradedisciplina, historico.gradedisciplinacomposta, historico.gradecurriculargrupooptativadisciplina, cargahorariadisciplina, creditodisciplina, mptd.modalidadedisciplina, historico.disciplina, mptd.codigo as matriculaperiodoturmadisciplina ");
		if (trazerBimestreAnoConclusaoDiscplina) {
			sqlStr.append(", (case when periodoletivoativounidadeensinocurso.datafimperiodoletivoprimeirobimestre is not null then ");
			sqlStr.append(" case when coalesce(historico.datafimaula, case when gradedisciplina.bimestre = 1 then periodoletivoativounidadeensinocurso.datafimperiodoletivoprimeirobimestre ");
			sqlStr.append(" else periodoletivoativounidadeensinocurso.datafimperiodoletivosegundobimestre end) <= periodoletivoativounidadeensinocurso.datafimperiodoletivoprimeirobimestre then ( ( ");
			sqlStr.append(" case when historico.semestrehistorico = '2' then '3/' else '1/'	end) || extract(year from coalesce(historico.datafimaula, case when gradedisciplina.bimestre = 1  ");
			sqlStr.append(" then periodoletivoativounidadeensinocurso.datafimperiodoletivoprimeirobimestre else periodoletivoativounidadeensinocurso.datafimperiodoletivosegundobimestre end))::varchar) ");
			sqlStr.append(" else ( (case when historico.semestrehistorico = '2' then '4/' else '2/' end) || extract(year from coalesce(historico.datafimaula, case when gradedisciplina.bimestre = 1 ");
			sqlStr.append(" then periodoletivoativounidadeensinocurso.datafimperiodoletivoprimeirobimestre else periodoletivoativounidadeensinocurso.datafimperiodoletivosegundobimestre end))::varchar) ");
			sqlStr.append(" end else ");
			sqlStr.append(" ((case when extract(month from coalesce(historico.datafimaula, case when gradedisciplina.bimestre = 1 then periodoletivoativounidadeensinocurso.datafimperiodoletivoprimeirobimestre  ");
			sqlStr.append(" else periodoletivoativounidadeensinocurso.datafimperiodoletivosegundobimestre end) ) in (1,2,3) then '1/' ");
			sqlStr.append(" when extract(month from	coalesce(historico.datafimaula, case when gradedisciplina.bimestre = 1 then periodoletivoativounidadeensinocurso.datafimperiodoletivoprimeirobimestre ");
			sqlStr.append(" else periodoletivoativounidadeensinocurso.datafimperiodoletivosegundobimestre end)) in (4,5,6,7) then '2/' ");
			sqlStr.append(" when extract(month from	coalesce(historico.datafimaula, case when gradedisciplina.bimestre = 1 then periodoletivoativounidadeensinocurso.datafimperiodoletivoprimeirobimestre ");
			sqlStr.append(" else periodoletivoativounidadeensinocurso.datafimperiodoletivosegundobimestre end)) in (8,9) then '3/' else '4/' end ) ");
			sqlStr.append(" || extract(year from coalesce(historico.datafimaula, case when gradedisciplina.bimestre = 1 then periodoletivoativounidadeensinocurso.datafimperiodoletivoprimeirobimestre  ");
			sqlStr.append(" else periodoletivoativounidadeensinocurso.datafimperiodoletivosegundobimestre end))::varchar) end) as bimestre ");
		}
		sqlStr.append(" FROM historico ");
		sqlStr.append(" INNER JOIN matricula ON historico.matricula = matricula.matricula ");
		sqlStr.append(" INNER JOIN matriculaperiodo ON historico.matriculaperiodo = matriculaperiodo.codigo ");
		sqlStr.append(" LEFT JOIN matriculaperiodoturmadisciplina mptd on mptd.codigo = historico.matriculaperiodoturmadisciplina ");
		if (trazerBimestreAnoConclusaoDiscplina) {
			sqlStr.append(" INNER JOIN gradedisciplina ON gradedisciplina.codigo = historico.gradedisciplina ");
			sqlStr.append(" INNER JOIN unidadeensinocurso ON unidadeensinocurso.codigo = matriculaperiodo.unidadeensinocurso ");
			sqlStr.append(" LEFT  JOIN processomatriculacalendario ON processomatriculacalendario.processomatricula = matriculaperiodo.processomatricula	AND processomatriculacalendario.curso = unidadeensinocurso.curso AND processomatriculacalendario.turno = unidadeensinocurso.turno ");
			sqlStr.append(" LEFT  JOIN periodoletivoativounidadeensinocurso ON periodoletivoativounidadeensinocurso.codigo = processomatriculacalendario.periodoletivoativounidadeensinocurso ");
			sqlStr.append(" AND periodoletivoativounidadeensinocurso.anoreferenciaperiodoletivo = historico.anohistorico ");
			sqlStr.append(" AND periodoletivoativounidadeensinocurso.semestrereferenciaperiodoletivo = historico.semestrehistorico ");
		}
		sqlStr.append(" WHERE (historico.matricula = '").append(matricula).append("') ");
		if (disciplina.intValue() != 0) {
			sqlStr.append("   AND (historico.disciplina = ").append(disciplina).append(") ");
		}
		if (Uteis.isAtributoPreenchido(turma)) {
			if(turma.getSubturma() && turma.getTipoSubTurma().equals(TipoSubTurmaEnum.PRATICA)) {
				sqlStr.append("  AND mptd.turmapratica = ").append(turma.getCodigo());
			}else if(turma.getSubturma() && turma.getTipoSubTurma().equals(TipoSubTurmaEnum.TEORICA)) {
				sqlStr.append("  AND mptd.turmateorica = ").append(turma.getCodigo());
			}else if(turma.getTurmaAgrupada()) {
				sqlStr.append("  AND mptd.turma in (select turma from turmaagrupada where turmaorigem = ").append(turma.getCodigo()).append(") ");
			}else {
				sqlStr.append("  AND mptd.turma = ").append(turma.getCodigo());
			}
		}
		if (!ano.equals("")) {
			sqlStr.append(" AND matriculaperiodo.ano = '").append(ano.toString()).append("' ");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" AND matriculaperiodo.semestre = '").append(semestre.toString()).append("' ");
		}
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		sqlStr.append(" order by  historico.codigo desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return new HistoricoVO();
		}
		HistoricoVO historicoVO = new HistoricoVO();
		historicoVO.setCodigo(tabelaResultado.getInt("codigo"));
		historicoVO.getDisciplina().setCodigo(tabelaResultado.getInt("disciplina"));
		historicoVO.getGradeDisciplinaVO().setCodigo(tabelaResultado.getInt("gradedisciplina"));
		historicoVO.getGradeDisciplinaComposta().setCodigo(tabelaResultado.getInt("gradedisciplinaComposta"));
		historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().setCodigo(tabelaResultado.getInt("gradecurriculargrupooptativadisciplina"));
		historicoVO.getMatriculaPeriodoTurmaDisciplina().setCodigo(tabelaResultado.getInt("matriculaperiodoturmadisciplina"));
		historicoVO.setCargaHorariaDisciplina(tabelaResultado.getInt("cargaHorariaDisciplina"));
		historicoVO.setCreditoDisciplina(tabelaResultado.getInt("creditoDisciplina"));
		if (trazerBimestreAnoConclusaoDiscplina) {
			historicoVO.setAnoBimestreConclusaoDisciplina(tabelaResultado.getString("bimestre"));
		}
		if(tabelaResultado.getString("modalidadeDisciplina") != null){
			historicoVO.getMatriculaPeriodoTurmaDisciplina().setModalidadeDisciplina(ModalidadeDisciplinaEnum.valueOf(tabelaResultado.getString("modalidadeDisciplina")));
		}
		return historicoVO;
	}

	public List consultarPorMatriculaDisciplinaTurmaSituacaoHistorico(String matricula, Integer disciplina, Integer turma, String situacaoHistorico, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		// StringBuilder sqlStr = new StringBuilder("");
		// sqlStr.append("SELECT historico.* ");
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		// sqlStr.append("FROM historico ");
		// sqlStr.append("inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo ");
		// sqlStr.append("inner join matricula on matriculaPeriodo.matricula = matricula.matricula ");
		// sqlStr.append("inner join matriculaperiodoturmadisciplina on matriculaperiodoturmadisciplina.matriculaperiodo = matriculaperiodo.codigo ");
		// sqlStr.append("and matriculaperiodoturmadisciplina.disciplina = historico.disciplina and matriculaperiodoturmadisciplina.codigo = historico.matriculaperiodoturmadisciplina ");
		sqlStr.append("WHERE historico.matricula = '").append(matricula).append("' ");
		sqlStr.append("and matriculaPeriodoTurmaDisciplina.turma = ").append(turma).append(" and matriculaPeriodoTurmaDisciplina.disciplina = ").append(disciplina).append(" ");
		if (!situacaoHistorico.equals("")) {
			sqlStr.append("and historico.situacao <> '").append(situacaoHistorico).append("' ");
		}
		// sqlStr.append(" and matricula.situacao <> 'CA' and matriculaperiodo.situacaomatriculaperiodo <> 'TR' ");


		sqlStr.append("ORDER BY disciplina.codigo ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaCompleta(tabelaResultado, usuario);
	}

	public List<HistoricoVO> consultarPorMatriculaDisciplinaTurmaSituacaoHistoricoAnoSemestre(String matricula, Integer gradeCurricular, Integer disciplina, TurmaVO turmaVO, String situacaoHistorico, String ano, String semestre,  boolean permiteLancarNotaDisciplinaComposta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Integer matriculaPeriodoTurmaDisciplina, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica(turmaVO, disciplina, permiteLancarNotaDisciplinaComposta);
		sqlStr.append("WHERE historico.matricula = '").append(matricula).append("' ");
		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		if(!Uteis.isAtributoPreenchido(gradeCurricular)){
			sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		}else{
			sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularEspecifico(" and ", gradeCurricular));
		}
		if (Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplina)) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.codigo = ").append(matriculaPeriodoTurmaDisciplina);
		}
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		if(!permiteLancarNotaDisciplinaComposta){
			sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		}
		sqlStr.append(" and (historico.disciplina = ").append(disciplina);
		sqlStr.append(" or (historico.disciplina is null and historico.disciplina in (select distinct equivalente from disciplinaequivalente where disciplina = ").append(disciplina).append(" )))");
		if (!ano.equals("")) {
			sqlStr.append(" and (historico.anohistorico = '' or historico.anohistorico = '").append(ano).append("') ");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" and (historico.semestrehistorico = '' or historico.semestrehistorico = '").append(semestre).append("') ");
		}
		if (!situacaoHistorico.equals("")) {
			sqlStr.append("and historico.situacao <> '").append(situacaoHistorico).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CURSANDO_POR_EQUIVALENCIA.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CONCESSAO_CREDITO.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor()).append("'  ");
		}
		sqlStr.append("ORDER BY aluno.nome, disciplina.codigo ");
//		System.out.println(sqlStr.toString());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaCompleta(tabelaResultado, usuario);
	}

	public HistoricoVO consultaCompletaPorMatriculaDisciplinaSituacaoHistoricoAnoSemestre(String matricula, Integer disciplina, String situacaoHistorico, String ano, String semestre,  boolean permiteLancarNotaDisciplinaComposta, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append("WHERE historico.matricula = '").append(matricula).append("' ");
				/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		// sqlStr.append(" and matriculaPeriodoTurmaDisciplina.turma = ").append(turma);
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		if(!permiteLancarNotaDisciplinaComposta){
			sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		}
		sqlStr.append(" and (historico.disciplina = ").append(disciplina);
		sqlStr.append(" or (historico.disciplina is null and historico.disciplina in (select distinct equivalente from disciplinaequivalente where disciplina = ").append(disciplina).append(" )))");
		if (!ano.equals("")) {
			sqlStr.append(" and (historico.anohistorico = '' or historico.anohistorico = '").append(ano).append("') ");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" and (historico.semestrehistorico = '' or historico.semestrehistorico = '").append(semestre).append("') ");
		}
		if (!situacaoHistorico.equals("")) {
			sqlStr.append("and historico.situacao <> '").append(situacaoHistorico).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CURSANDO_POR_EQUIVALENCIA.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CONCESSAO_CREDITO.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor()).append("'  ");
		}

		sqlStr.append("ORDER BY disciplina.codigo ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		HistoricoVO obj = null;
		if (tabelaResultado.next()) {
			obj = new HistoricoVO();
			montarDadosCompleto(obj, tabelaResultado, false, true, true, usuario);
		}
		return obj;
	}

	public HistoricoVO consultarPorMatriculaDisciplinaSituacaoHistoricoAnoSemestre(String matricula, Integer disciplina, String situacaoHistorico, String ano, String semestre, Integer configuracaoAcademico, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" select historico.codigo, historico.matricula, historico.disciplina AS \"historico.disciplina\", disciplina.nome AS \"disciplina.nome\" ");
		sqlStr.append(" from historico ");
		sqlStr.append(" inner join matricula on matricula.matricula = historico.matricula ");
		sqlStr.append(" inner join matriculaPeriodo on matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		sqlStr.append(" inner join disciplina on disciplina.codigo = historico.disciplina ");
		sqlStr.append("WHERE historico.matricula = '").append(matricula).append("' ");
				/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		// sqlStr.append(" and matriculaPeriodoTurmaDisciplina.turma = ").append(turma);
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		sqlStr.append(" and (historico.disciplina = ").append(disciplina);
		sqlStr.append(" or (historico.disciplina is null and historico.disciplina in (select distinct equivalente from disciplinaequivalente where disciplina = ").append(disciplina).append(" )))");
		if (!ano.equals("")) {
			sqlStr.append(" and (historico.anohistorico = '' or historico.anohistorico = '").append(ano).append("') ");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" and (historico.semestrehistorico = '' or historico.semestrehistorico = '").append(semestre).append("') ");
		}
		if (!situacaoHistorico.equals("")) {
			sqlStr.append("and historico.situacao <> '").append(situacaoHistorico).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CURSANDO_POR_EQUIVALENCIA.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CONCESSAO_CREDITO.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor()).append("'  ");
		}
		if (configuracaoAcademico != null && !configuracaoAcademico.equals(0)) {
			sqlStr.append(" and historico.configuracaoAcademico = ").append(configuracaoAcademico);
		}

		sqlStr.append("ORDER BY historico.disciplina ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		HistoricoVO obj = null;
		if (tabelaResultado.next()) {
			obj = new HistoricoVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getMatricula().setMatricula(tabelaResultado.getString("matricula"));
			obj.getDisciplina().setCodigo(tabelaResultado.getInt("historico.disciplina"));
			obj.getDisciplina().setNome(tabelaResultado.getString("disciplina.nome"));
		}
		return obj;
	}

	public List<HistoricoVO> consultarPorMatriculaDisciplinaSituacaoHistoricoAnoSemestrePorAreaConhecimento(String matricula, Integer areaConhecimento, String situacaoHistorico, String ano, String semestre, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" select historico.codigo, historico.matricula, historico.disciplina AS \"historico.disciplina\", disciplina.nome AS \"disciplina.nome\" ");
		sqlStr.append(" from historico ");
		sqlStr.append(" inner join matricula on matricula.matricula = historico.matricula ");
		sqlStr.append(" inner join disciplina on disciplina.codigo = historico.disciplina ");
		sqlStr.append(" inner join gradeDisciplina on gradeDisciplina.codigo = historico.gradeDisciplina ");
		sqlStr.append("WHERE historico.matricula = '").append(matricula).append("' ");
				/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		// sqlStr.append(" and matriculaPeriodoTurmaDisciplina.turma = ").append(turma);
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		sqlStr.append(" and gradeDisciplina.areaConhecimento = ").append(areaConhecimento);
		if (!ano.equals("")) {
			sqlStr.append(" and (historico.anohistorico = '' or historico.anohistorico = '").append(ano).append("') ");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" and (historico.semestrehistorico = '' or historico.semestrehistorico = '").append(semestre).append("') ");
		}
		if (!situacaoHistorico.equals("")) {
			sqlStr.append("and historico.situacao <> '").append(situacaoHistorico).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CURSANDO_POR_EQUIVALENCIA.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.CONCESSAO_CREDITO.getValor()).append("'  ");
			sqlStr.append("and historico.situacao <> '").append(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor()).append("'  ");
		}

		sqlStr.append("ORDER BY historico.disciplina ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> listaHistoricoVOs = new ArrayList<HistoricoVO>(0);
		HistoricoVO obj = null;
		while (tabelaResultado.next()) {
			obj = new HistoricoVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getMatricula().setMatricula(tabelaResultado.getString("matricula"));
			obj.getDisciplina().setCodigo(tabelaResultado.getInt("historico.disciplina"));
			obj.getDisciplina().setNome(tabelaResultado.getString("disciplina.nome"));
			listaHistoricoVOs.add(obj);
		}
		return listaHistoricoVOs;
	}

	public List<HistoricoVO> consultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHist(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, String situacaoMatricula, String situacaoHistorico, boolean verificarDisciplina, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, int nivelMontarDados, FiltroRelatorioAcademicoVO filtroRelatorioAcademicoVO, UsuarioVO usuario, boolean trazerAlunosTransferenciaMatriz, boolean permiteLancarNotaDisciplinaComposta) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica(turmaVO,disciplina, permiteLancarNotaDisciplinaComposta);
		Boolean permiteLancarNotaDisciplinaComposta2 = Boolean.FALSE;
		if (permiteLancarNotaDisciplinaComposta) {
			permiteLancarNotaDisciplinaComposta2 = permiteLancarNotaDisciplinaComposta && getFacadeFactory().getTurmaDisciplinaFacade().consultarDisciplinaCompostaTurmaDisciplina(turmaVO.getCodigo(), disciplina);
		}
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			sqlStr.append(" WHERE ");
			sqlStr.append(" ((MatriculaPeriodoTurmaDisciplina.turma in (select turma from turmaAgrupada where turmaOrigem =  ").append(turmaVO.getCodigo()).append(") and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null )");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaPratica is not null and MatriculaPeriodoTurmaDisciplina.turmaPratica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'PRATICA'))");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaTeorica is not null and MatriculaPeriodoTurmaDisciplina.turmaTeorica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'TEORICA'))");
			sqlStr.append(") ");
		} else {
			if(!permiteLancarNotaDisciplinaComposta2) {
				sqlStr.append(" WHERE (Turma.codigo = ").append(turmaVO.getCodigo()).append(") ");
			}else {
				sqlStr.append(" WHERE historico.historicodisciplinacomposta = true ");
			}
		}
		if (!turmaVO.getSubturma() && !turmaVO.getTurmaAgrupada() && !permiteLancarNotaDisciplinaComposta2) {
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
		}

		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		if(!trazerAlunosTransferenciaMatriz){
			sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		}else {
			sqlStr.append(" and (").append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" "));
			sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" or ")).append(" = false )");
			sqlStr.append(" and historico.codigo = (select his.codigo from historico his where his.matricula = matricula.matricula and his.matriculaperiodo = matriculaperiodo.codigo and his.MatriculaPeriodoTurmaDisciplina = MatriculaPeriodoTurmaDisciplina.codigo order by case when his.matrizcurricular = matricula.gradecurricularatual then 0 else 1 end limit 1 ) ");
		}

		if (!turmaVO.getTurmaAgrupada() && !curso.equals(0)) {
			sqlStr.append("and curso.codigo = ").append(curso);
		}
		if (unidadeEnsino != null && !unidadeEnsino.equals(0)) {
			sqlStr.append(" and unidadeensino.codigo = ").append(unidadeEnsino);
		}
		if (verificarDisciplina) {
			if (disciplina != null && !disciplina.equals(0)) {
				sqlStr.append(" and (( historico.disciplina = ").append(disciplina).append(") ");
				if(turmaVO.getTurmaAgrupada()){
					sqlStr.append(" or (historico.disciplina in (select equivalente from disciplinaequivalente where disciplina = ").append(disciplina).append("))");
					sqlStr.append(" or (historico.disciplina in (select disciplina from disciplinaequivalente where equivalente = ").append(disciplina).append("))");
					sqlStr.append(" or (historico.disciplina in (select disciplinaequivalenteturmaagrupada from turmadisciplina where disciplinaequivalenteturmaagrupada is not null and turmadisciplina.disciplina = ").append(disciplina).append(" and turmadisciplina.turma = ").append(turmaVO.getCodigo()).append("))");
				}
				sqlStr.append(") ");
			}
		} else {
			sqlStr.append(" and (( historico.disciplina = ").append(disciplina).append(") ");
			if(turmaVO.getTurmaAgrupada()){
				sqlStr.append(" or (historico.disciplina in (select equivalente from disciplinaequivalente where disciplina = ").append(disciplina).append("))");
				sqlStr.append(" or (historico.disciplina in (select disciplina from disciplinaequivalente where equivalente = ").append(disciplina).append("))");
				sqlStr.append(" or (historico.disciplina in (select disciplinaequivalenteturmaagrupada from turmadisciplina where disciplinaequivalenteturmaagrupada is not null and turmadisciplina.disciplina = ").append(disciplina).append(" and turmadisciplina.turma = ").append(turmaVO.getCodigo()).append("))");
			}
			sqlStr.append(") ");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.ano = '").append(ano).append("' ");
		}
		if (!situacaoMatricula.equals("")) {
			sqlStr.append(" and matricula.situacao = '").append(situacaoMatricula).append("' ");
		}
		sqlStr.append(" and ").append(adicionarFiltroSituacaoAcademicaMatriculaPeriodo(filtroRelatorioAcademicoVO, "matriculaperiodo"));
		if (!situacaoHistorico.equals("")) {
			sqlStr.append(" and historico.situacao <> '").append(situacaoHistorico).append("' ");
		}
		if (configuracaoAcademicoVO != null && !configuracaoAcademicoVO.getCodigo().equals(0)) {
			sqlStr.append(" and historico.configuracaoAcademico = ").append(configuracaoAcademicoVO.getCodigo());
		}
		// Garante que sempre estará lançando nota para as disciplina da grade
		// atual do aluno
		// sqlStr.append(" and (matricula.gradecurricularatual = historico.matrizcurricular) ");


		// Não permite que historicos que o aluno está estudando por
		// equivalencia apresente para lançamento de nota, pois a nota deve ser
		// lançada no histórico equivalente
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		// Não permite que historicos de disciplina composta apareça para
		// lançamento de nota, pois a nota deve ser lançada para as disciplinas
		// que fazem parte da composição
		if(!permiteLancarNotaDisciplinaComposta2){
			sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		}


		SqlRowSet tabelaResultado = null;
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			StringBuffer sql = new StringBuffer();
			sql.append("select t.* from ");
			sql.append("(").append(sqlStr).append(") as t ");
			sql.append(" where  (exists (").append(sqlStr).append(" and historico.disciplina = t.\"disciplina.codigo\" and historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1) ") ;
			sql.append(" or not exists (").append(sqlStr).append(" and historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1)) ") ;
			sql.append(" order by t.nomeSemAcento ");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		}else {
			sqlStr.append(" ORDER BY nomeSemAcento");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		}

		//System.out.println(sqlStr);
		// if(!tabelaResultado.next()){
		// throw new
		// Exception("Não foi encontrado nenhum resultado com os parâmetros passados.");
		// }
		List<HistoricoVO> historicoVOs = montarDadosConsultaCompleta(tabelaResultado, usuario);
		Ordenacao.ordenarLista(historicoVOs, "ordenacao");
		return historicoVOs;
	}

	public List<HistoricoVO> consultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaPadraoAnoSemestreSituacaoMatSituacaoHist(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, String situacaoMatricula, String situacaoHistorico, boolean verificarDisciplina, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, List<MatriculaPeriodoVO> matriculaPeriodoVOs, boolean trazerDisciplinaComposta,  int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompletaConsiderandoTurmaPadrao();
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			sqlStr.append(" WHERE MatriculaPeriodoTurmaDisciplina.turma in (select turma from turmaAgrupada where turmaOrigem =  ").append(turmaVO.getCodigo()).append(") ");
		} else {
			sqlStr.append(" WHERE Turma.codigo = ").append(turmaVO.getCodigo());
		}
		if(Uteis.isAtributoPreenchido(matriculaPeriodoVOs)){
			sqlStr.append(" and historico.matriculaperiodo IN (");
			int x = 0;
			for(MatriculaPeriodoVO matriculaPeriodoVO: matriculaPeriodoVOs){
				if(x> 0){
					sqlStr.append(", ");
				}
				sqlStr.append(matriculaPeriodoVO.getCodigo());
				x++;
			}
			sqlStr.append(" ) ");
		}
		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		if (!turmaVO.getTurmaAgrupada() && !curso.equals(0)) {
			sqlStr.append("and curso.codigo = ").append(curso);
		}
		if (unidadeEnsino != null && !unidadeEnsino.equals(0)) {
			sqlStr.append(" and unidadeensino.codigo = ").append(unidadeEnsino);
		}
		if (verificarDisciplina) {
			if (disciplina != null && !disciplina.equals(0)) {
				sqlStr.append(" and historico.disciplina = ").append(disciplina);
			}
		} else {
			sqlStr.append(" and historico.disciplina = ").append(disciplina);
		}
		if (!semestre.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.ano = '").append(ano).append("' ");
		}
		if (!situacaoMatricula.equals("")) {
			sqlStr.append(" and matricula.situacao = '").append(situacaoMatricula).append("' ");
		}
		if (!situacaoHistorico.equals("")) {
			sqlStr.append(" and historico.situacao <> '").append(situacaoHistorico).append("' ");
		}
		if (configuracaoAcademicoVO != null && !configuracaoAcademicoVO.getCodigo().equals(0)) {
			sqlStr.append(" and historico.configuracaoAcademico = ").append(configuracaoAcademicoVO.getCodigo());
		}
		// Garante que sempre estará lançando nota para as disciplina da grade
		// atual do aluno
		// sqlStr.append(" and (matricula.gradecurricularatual = historico.matrizcurricular) ");


		// Não permite que historicos que o aluno está estudando por
		// equivalencia apresente para lançamento de nota, pois a nota deve ser
		// lançada no histórico equivalente
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		// Não permite que historicos de disciplina composta apareça para
		// lançamento de nota, pois a nota deve ser lançada para as disciplinas
		// que fazem parte da composição
		if(!trazerDisciplinaComposta) {
			sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		}

		sqlStr.append(" ORDER BY disciplina.codigo, aluno.nome");
//		System.out.println(sqlStr.toString());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		// if(!tabelaResultado.next()){
		// throw new
		// Exception("Não foi encontrado nenhum resultado com os parâmetros passados.");
		// }
		return montarDadosConsultaCompleta(tabelaResultado, usuario);
	}

	public List<HistoricoVO> consultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessor(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, String situacaoMatricula, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, boolean trazerAlunoPendenteFinanceiramente, ConfiguracaoAcademicoVO configuracaoAcademicoVO, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica(turmaVO, disciplina, false);
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			sqlStr.append(" WHERE ");
			sqlStr.append(" ((MatriculaPeriodoTurmaDisciplina.turma in (select turma from turmaAgrupada where turmaOrigem =  ").append(turmaVO.getCodigo()).append(") )");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaPratica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'PRATICA'))");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaTeorica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'TEORICA'))");
			sqlStr.append(") ");
		} else {
			sqlStr.append(" WHERE Turma.codigo = ").append(turmaVO.getCodigo());
		}
		if (turmaVO.getIntegral()) {
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.matriculaperiodo = ( ");
			sqlStr.append("select mp.codigo from matriculaperiodo  mp  ");
			sqlStr.append("inner join MatriculaPeriodoTurmaDisciplina mptd on mptd.matriculaperiodo = mp.codigo  ");
			sqlStr.append("and mptd.turma = MatriculaPeriodoTurmaDisciplina.turma and mptd.disciplina = MatriculaPeriodoTurmaDisciplina.disciplina ");
			sqlStr.append("where mp.matricula = matricula.matricula ");
			sqlStr.append("order by (mp.ano || '/' || mp.semestre) desc, case when mp.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, mp.codigo desc limit 1 )");
		}
		if(Uteis.isAtributoPreenchido(configuracaoAcademicoVO)){
			sqlStr.append(" and configuracaoAcademico.codigo = ").append(configuracaoAcademicoVO.getCodigo());
		}
		if (!turmaVO.getSubturma() && !turmaVO.getTurmaAgrupada()) {
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
		}
		if (Uteis.isAtributoPreenchido(curso) && !Uteis.isAtributoPreenchido(turmaVO)) {
			sqlStr.append(" and curso.codigo = ").append(curso);
		}

		if (unidadeEnsino != null && !unidadeEnsino.equals(0)) {
			sqlStr.append(" and turma.unidadeensino = ");
			sqlStr.append(unidadeEnsino);
		}
		if (verificarDisciplina) {
			if (disciplina != null && !disciplina.equals(0)) {
				sqlStr.append(" and (historico.disciplina = ");
				sqlStr.append(disciplina);
				if(turmaVO.getTurmaAgrupada()){
					sqlStr.append(" or historico.disciplina in(select distinct disciplinaEquivalenteTurmaAgrupada from turmadisciplina where turmadisciplina.turma = ");
					sqlStr.append(turmaVO.getCodigo()).append(" and turmadisciplina.disciplina = ").append(disciplina).append(") ");
					sqlStr.append(" or historico.disciplina in (select distinct equivalente from disciplinaequivalente where disciplinaequivalente.disciplina = ").append(disciplina.intValue()).append(") ");
					sqlStr.append(" or historico.disciplina in (select distinct disciplina from disciplinaequivalente where disciplinaequivalente.equivalente = ").append(disciplina.intValue()).append(") ");
				}
				sqlStr.append(" )");
			}
		} else {
			sqlStr.append(" and (historico.disciplina = ");
			sqlStr.append(disciplina);
			if(turmaVO.getTurmaAgrupada()){
				sqlStr.append(" or historico.disciplina in(select distinct disciplinaEquivalenteTurmaAgrupada from turmadisciplina where turmadisciplina.turma = ");
				sqlStr.append(turmaVO.getCodigo()).append(" and turmadisciplina.disciplina = ").append(disciplina).append(") ");
				sqlStr.append(" or historico.disciplina in (select distinct equivalente from disciplinaequivalente where disciplinaequivalente.disciplina = ").append(disciplina.intValue()).append(") ");
				sqlStr.append(" or historico.disciplina in (select distinct disciplina from disciplinaequivalente where disciplinaequivalente.equivalente = ").append(disciplina.intValue()).append(") ");
			}
			sqlStr.append(" )");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" and matriculaPeriodo.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			sqlStr.append(" and matriculaPeriodo.ano = '").append(ano).append("' ");
		}
		if (!situacaoMatricula.equals("")) {
			sqlStr.append(" and matricula.situacao = '").append(situacaoMatricula).append("' ");
		}

		if (!situacaoHistorico.equals("")) {
			sqlStr.append(" and historico.situacao not in (").append(situacaoHistorico).append(") ");
		}
    	/*
    	 Condição  OR adicionada para filtrar os historicos cujo a situação = 'AP',situacaoMatriculaPeriodo = 'TR' e a periodicidade do curso = 'IN'.O aluno fez um trancamento,em seguida ativou a matricula.
		 A disciplina estava aprovada,sendo assim não foi gerado um novo historico e a matriculaPeriodo trancada ficou vinculada a este histórico.Se considerarmos apenas a regra
		 and ((curso.periodicidade in ('AN', 'SE','IN') and matriculaperiodo.situacaoMatriculaPeriodo not in ('PR', 'TR', 'PC')) ,o histórico não é filtrado.
		*/
		if (filtroVisaoProfessor) {
			if (!trazerAlunoPendenteFinanceiramente) {
				sqlStr.append(" and matriculaPeriodo.situacao <> 'PF' ");
			}
			if (!permitirRealizarLancamentoAlunosPreMatriculados) {
				sqlStr.append(" and ((curso.periodicidade in ('AN', 'SE') and matriculaperiodo.situacaoMatriculaPeriodo not in ('PR', 'TR', 'PC')) or (curso.periodicidade = 'IN' and matriculaperiodo.situacaoMatriculaPeriodo not in ('PR', 'PC'))) ");
			} else {
				sqlStr.append(" and ((curso.periodicidade in ('AN', 'SE') and matriculaperiodo.situacaoMatriculaPeriodo not in ('TR', 'PC')) or (curso.periodicidade = 'IN' and matriculaperiodo.situacaoMatriculaPeriodo not in ('PC'))) ");
			}
			sqlStr.append(Historico.getWhereAlunoCursaDisciplinaTurmaProfessor(usuario.getPessoa().getCodigo(), "historico", "matriculaPeriodoTurmaDisciplina", false));

		} else if (usuario.getIsApresentarVisaoCoordenador() && !permitirRealizarLancamentoAlunosPreMatriculados) {
			sqlStr.append(" and matriculaperiodo.situacaoMatriculaPeriodo <> 'PR' ");
		}
		sqlStr.append(" and (matricula.situacao <> 'TR' and matricula.situacao <> 'CA' and Matricula.situacao <> 'CF')");

		// Garante que só será alterado o histórico atual do aluno
		// sqlStr.append(" and matricula.gradecurricularatual = historico.matrizcurricular ");
		// Garante que o histórico cursado por equivalencia não seja alterado
		// diretamente, pois a nota deve ser lançado no histórico equivalente
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		// Garante que o histórico de disciplina composta não seja alterado
		// diretamente, pois a nota deve ser lançado no histórico de uma
		// disciplina que faz parte da composicao
		sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");

		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));



		SqlRowSet tabelaResultado = null;
		if(turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()){
			StringBuffer sql = new StringBuffer();
			sql.append("select t.* from ");
			sql.append("(").append(sqlStr).append(") as t ");
			sql.append(" where  (exists (").append(sqlStr).append(" and  historico.disciplina =t.\"disciplina.codigo\" and  historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1) ") ;
			sql.append(" or not exists (").append(sqlStr).append(" and  historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1)) ") ;
			sql.append(" ORDER BY t.nomeSemAcento ");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		}else {
			sqlStr.append(" ORDER BY nomeSemAcento ");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		}
		// if(!tabelaResultado.next()){
		// throw new
		// Exception("Não foi encontrado nenhum resultado com os parâmetros passados.");
		// }
		return montarDadosConsultaCompleta(tabelaResultado, filtroVisaoProfessor, usuario);
	}

	public List<HistoricoVO> consultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNota(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, int nivelMontarDados, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica(turmaVO, disciplina, trazerDisciplinaComposta);
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			sqlStr.append(" WHERE ");
			sqlStr.append(" ((MatriculaPeriodoTurmaDisciplina.turma in (select turma from turmaAgrupada where turmaOrigem =  ").append(turmaVO.getCodigo()).append(") )");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaPratica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'PRATICA'))");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaTeorica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'TEORICA'))");
			sqlStr.append(") ");
		} else {
			sqlStr.append(" WHERE Turma.codigo = ").append(turmaVO.getCodigo());
		}
		if (!turmaVO.getSubturma() && !turmaVO.getTurmaAgrupada()) {
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
		}

		if (turmaVO.getIntegral()) {
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.matriculaperiodo = ( ");
			sqlStr.append("select mp.codigo from matriculaperiodo  mp  ");
			sqlStr.append("inner join MatriculaPeriodoTurmaDisciplina mptd on mptd.matriculaperiodo = mp.codigo  ");
			sqlStr.append("and mptd.turma = MatriculaPeriodoTurmaDisciplina.turma and mptd.disciplina = MatriculaPeriodoTurmaDisciplina.disciplina ");
			sqlStr.append("where mp.matricula = matricula.matricula ");
			sqlStr.append("order by (mp.ano || '/' || mp.semestre) desc, case when mp.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, mp.codigo desc limit 1 )");
		}

		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		if (unidadeEnsino != null && !unidadeEnsino.equals(0)) {
			sqlStr.append(" and unidadeensino.codigo = ");
			sqlStr.append(unidadeEnsino);
		}
		if ((verificarDisciplina && Uteis.isAtributoPreenchido(disciplina)) || !verificarDisciplina) {
				sqlStr.append(" and (Disciplina.codigo = ").append(disciplina.intValue());
				if(turmaVO.getTurmaAgrupada()) {
					sqlStr.append(" or Disciplina.codigo in (select distinct disciplinaequivalenteTurmaagrupada from turmadisciplina where turma = ").append(turmaVO.getCodigo()).append(" and turmadisciplina.disciplina = ").append(disciplina.intValue()).append(") ");
					sqlStr.append(" or Disciplina.codigo in (select distinct equivalente from disciplinaequivalente where disciplinaequivalente.disciplina = ").append(disciplina.intValue()).append(") ");
					sqlStr.append(" or Disciplina.codigo in (select distinct disciplina from disciplinaequivalente where disciplinaequivalente.equivalente = ").append(disciplina.intValue()).append(") ");
			}
				sqlStr.append(" ) ");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.ano = '").append(ano).append("' ");
		}
		if (!trazerAlunoPendenteFinanceiramente) {
			sqlStr.append(" and matricula.situacao <> '").append("PF").append("' ");
			if (!permitiVisualizarAlunoTR_CA) {
				sqlStr.append(" and matricula.situacao <> '").append("CA").append("' ");
				sqlStr.append(" and matricula.situacao <> '").append("TR").append("' ");
			}
		} else {
			if (!permitiVisualizarAlunoTR_CA) {
				sqlStr.append(" and matricula.situacao <> '").append("CA").append("' ");
				sqlStr.append(" and matricula.situacao <> '").append("TR").append("' ");
			}

		}
		if (!situacaoHistorico.equals("")) {
			sqlStr.append(" and historico.situacao not in (").append(situacaoHistorico).append(") ");
		}
//		sqlStr.append(" and historico.situacao not in ('TR', 'AA', 'CH', 'CC', 'IS') ");
		if (filtroVisaoProfessor) {
			sqlStr.append(Historico.getWhereAlunoCursaDisciplinaTurmaProfessor(usuario.getPessoa().getCodigo(), "historico", "matriculaPeriodoTurmaDisciplina", trazerDisciplinaComposta));
		}

		if (usuario.getIsApresentarVisaoCoordenador() || usuario.getIsApresentarVisaoProfessor()) {
			sqlStr.append(" and matriculaperiodo.situacaoMatriculaPeriodo not in('PC' ");
			if (!permitirRealizarLancamentoAlunosPreMatriculados) {
				sqlStr.append(", 'PR'");
			}
			sqlStr.append(")");
		}
		if (configuracaoAcademicoVO != null && !configuracaoAcademicoVO.getCodigo().equals(0)) {
			sqlStr.append(" and historico.configuracaoAcademico = ").append(configuracaoAcademicoVO.getCodigo());
		}
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));



		// Garante que só será alterado o histórico atual do aluno
		// sqlStr.append(" and matricula.gradecurricularatual = historico.matrizcurricular ");
		// Garante que o histórico cursado por equivalencia não seja alterado
		// diretamente, pois a nota deve ser lançado no histórico equivalente
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		// Garante que o histórico de disciplina composta não seja alterado
		// diretamente, pois a nota deve ser lançado no histórico de uma
		// disciplina que faz parte da composicao
		if(!trazerDisciplinaComposta){
			sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		}
		SqlRowSet tabelaResultado = null;
		if(turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()){
			StringBuffer sql = new StringBuffer();
			sql.append("select t.* from ");
			sql.append("(").append(sqlStr).append(") as t ");
			sql.append(" where  (exists (").append(sqlStr).append(" and historico.disciplina = t.\"disciplina.codigo\" and historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1) ") ;
			sql.append(" or not exists (").append(sqlStr).append(" and historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1)) ") ;
			sql.append(" ORDER BY nomeSemAcento");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		}else {
			sqlStr.append(" ORDER BY nomeSemAcento ");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		}
		return montarDadosConsultaCompleta(tabelaResultado, usuario);
	}

	public List<HistoricoVO> consultarPorMatriculaDisciplina(String matricula, Integer disciplina, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM Historico WHERE matricula = '" + matricula + "' and disciplina = " + disciplina.intValue() + " ORDER BY matricula";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public HistoricoVO consultarPorMatriculaPeriodoDisciplina(Integer matriculaPeriodo, Integer disciplina, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM Historico WHERE matriculaPeriodo = " + matriculaPeriodo.intValue() + " and disciplina = " + disciplina.intValue() + " ORDER BY matriculaPeriodo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (!tabelaResultado.next()) {
			return null;
		}
		return montarDados(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	/**
	 * Responsável por realizar uma consulta de <code>Historico</code> através
	 * do valor do atributo <code>nome</code> da classe <code>Disciplina</code>
	 * Faz uso da operação <code>montarDadosConsulta</code> que realiza o
	 * trabalho de prerarar o List resultante.
	 *
	 * @return List Contendo vários objetos da classe <code>HistoricoVO</code>
	 *         resultantes da consulta.
	 * @exception Execption
	 *                Caso haja problemas de conexão ou restrição de acesso.
	 */
	public List consultarPorNomeDisciplina(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT Historico.* FROM Historico, Disciplina WHERE Historico.disciplina = Disciplina.codigo and Disciplina.nome like('" + valorConsulta + "%') ORDER BY Disciplina.nome";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	/**
	 * Responsável por realizar uma consulta de <code>Historico</code> através
	 * do valor do atributo <code>Integer codigo</code>. Retorna os objetos com
	 * valores iguais ou superiores ao parâmetro fornecido. Faz uso da operação
	 * <code>montarDadosConsulta</code> que realiza o trabalho de prerarar o
	 * List resultante.
	 *
	 * @param controlarAcesso
	 *            Indica se a aplicação deverá verificar se o usuário possui
	 *            permissão para esta consulta ou não.
	 * @return List Contendo vários objetos da classe <code>HistoricoVO</code>
	 *         resultantes da consulta.
	 * @exception Exception
	 *                Caso haja problemas de conexão ou restrição de acesso.
	 */
	public List consultarPorCodigo(Integer valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM Historico WHERE codigo >= " + valorConsulta.intValue() + " ORDER BY codigo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	/**
	 * Este método valida se o aluno foi reprovado em X disciplina limite para
	 * aprovação em seu último periodo letivo caso tenha sido retornará false
	 * senão true
	 *
	 * @param matriculaPeriodo
	 * @param numeroMaximoDiscipina
	 * @return
	 */
	public boolean executarValidarMatriculaPeriodoExcedeuLimiteMaximoDisciplinaReprovado(String matricula, Boolean considerarDisciplinasReprovadasPeriodosLetivosAnteriores, Integer numeroMaximoDiscipina, UsuarioVO usuario) throws Exception {
//		String sqlStr = "SELECT COUNT(codigo) AS qtde FROM historico WHERE (situacao = '" + SituacaoHistorico.REPROVADO.getValor() + "' OR situacao = '" + SituacaoHistorico.REPROVADO_FALTA.getValor() + "' OR situacao = '" + SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getValor() + "') AND  matriculaPeriodo =" + matriculaPeriodo;
		StringBuilder sb = new StringBuilder();
		sb.append("select distinct matricula.matricula from matricula ");
		sb.append(" inner join pessoa on pessoa.codigo = matricula.aluno ");
		sb.append(" inner join curso on curso.codigo = matricula.curso ");
		sb.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.matricula = matricula.matricula ");
		sb.append(" and matriculaperiodo.situacaomatriculaperiodo in ('AT', 'FI') ");
		sb.append(" and matriculaperiodo.codigo in(select mp.codigo from matriculaperiodo mp where mp.matricula = matricula.matricula order by (ano || semestre) desc, codigo desc limit 1) ");
		sb.append(" inner join periodoletivo  on periodoletivo.codigo = matriculaperiodo.periodoletivomatricula ");
		sb.append(" where (select count(distinct historico.disciplina) from historico ");
		sb.append(" inner join periodoletivo as periodoletivomatrizcurricular on periodoletivomatrizcurricular.periodoletivo <= periodoletivo.periodoletivo ");
		sb.append(" where historico.situacao in ('RE', 'RF') ");
		sb.append(" and historico.matricula = matricula.matricula ");
		sb.append(" and historico.matrizcurricular = matricula.gradecurricularatual ");
		if (!considerarDisciplinasReprovadasPeriodosLetivosAnteriores) {
			sb.append(" and historico.matriculaperiodo = matriculaperiodo.codigo ");
		}
		sb.append(" and gradedisciplina is not null ");
		sb.append(" and historico.historicodisciplinaforagrade = false ");
		sb.append(" and (historico.historicodisciplinafazpartecomposicao = false or historico.historicodisciplinafazpartecomposicao is null) ");
		sb.append(" and (historico.historicoequivalente = false or historico.historicoequivalente is null) ");
		sb.append(" and not exists ");
		sb.append(" (");
		sb.append(" select his.codigo from historico his where his.matricula = matricula.matricula and his.situacao in ('AP', 'AA', 'AE') ");
		sb.append(" and his.gradedisciplina = historico.gradedisciplina  ");
		sb.append(" limit 1 ");
		sb.append(" )  ");
		sb.append(" ) >= ").append(numeroMaximoDiscipina);
		sb.append(" and matricula.matricula = '").append(matricula).append("' ");

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		Boolean alunoAptoAvancarProximoPeriodo = true;
		if (tabelaResultado.next()) {
			alunoAptoAvancarProximoPeriodo = false;
		}
		return alunoAptoAvancarProximoPeriodo;

	}

	public List consultarHistoricoPorMatriculaPeriodo_Matricula(Integer codigo, String matricula, Integer codigoMatriculaPeriodo, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM Historico WHERE matricula = '" + matricula + "' and matriculaperiodo = " + codigoMatriculaPeriodo.intValue() + " and codigo <> " + codigo.intValue() + " ORDER BY matricula";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List consultarPorMatriculaPeriodoLetivo(String matricula, Integer periodoLetivo, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT historico.* FROM Historico " + "LEFT JOIN matriculaperiodo ON historico.matriculaperiodo = matriculaperiodo.codigo " + "LEFT JOIN periodoletivo ON matriculaperiodo.periodoletivomatricula = periodoletivo.codigo " + "WHERE historico.matricula = '" + matricula + "' AND periodoletivo.periodoletivo = " + periodoLetivo + " ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List<HistoricoVO> consultarPorMatriculaPeriodoLetivoBoletim(String matricula, Integer turma, String ano, String semestre, Boolean apresentarDisciplinaComposta, Integer configuracaoAcademico, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario, BimestreEnum bimestre, SituacaoRecuperacaoNotaEnum situacaoRecuperacaoNota, Integer gradeCurricular) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT historico.*, configuracaoAcademico.intervaloNotasDiferente as \"configuracaoAcademico.intervaloNotasDiferente\",  curso.configuracaoacademico AS curso_configuracaoacademico, matriculaperiodo.situacaomatriculaperiodo ");
		sqlStr.append("FROM Historico ");
		sqlStr.append("inner join matricula on matricula.matricula = historico.matricula  ");
		sqlStr.append("inner join curso on curso.codigo = matricula.curso ");
		sqlStr.append("inner join disciplina on disciplina.codigo = historico.disciplina ");
		sqlStr.append("inner join configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico ");
		sqlStr.append("left join matriculaperiodo ON historico.matriculaperiodo = matriculaperiodo.codigo ");
		sqlStr.append("left join periodoletivo ON case when matriculaperiodo.codigo is not null then matriculaperiodo.periodoletivomatricula else case when historico.periodoletivocursada is not null then historico.periodoletivocursada else historico.periodoletivomatrizcurricular end end  = periodoletivo.codigo ");
		sqlStr.append("left join matriculaperiodoturmadisciplina on matriculaperiodoturmadisciplina.codigo = historico.matriculaperiodoturmadisciplina ");
		sqlStr.append("left join turma on turma.codigo = matriculaperiodoturmadisciplina.turma ");
		sqlStr.append("WHERE historico.matricula = '").append(matricula).append("'");
		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		//sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		sqlStr.append(" and ");
		if (gradeCurricular != null) {
			sqlStr.append(" ((").append(gradeCurricular).append(" = historico.matrizcurricular");
		} else {
			sqlStr.append(" ((matricula.gradecurricularatual = historico.matrizcurricular");
		}
		sqlStr.append(" and (historico.historicocursandoporcorrespondenciaapostransferencia is null or");
		sqlStr.append(" historico.historicocursandoporcorrespondenciaapostransferencia = false)");
		sqlStr.append(" and (historico.transferenciamatrizcurricularmatricula IS NULL OR (historico.transferenciamatrizcurricularmatricula IS NOT NULL ");
		sqlStr.append(" and historico.disciplina not in (select disciplina from historico his");
		sqlStr.append(" where his.matricula = historico.matricula");
		sqlStr.append(" and his.anohistorico = historico.anohistorico");
		sqlStr.append(" and his.semestrehistorico = historico.semestrehistorico");
		sqlStr.append(" and his.disciplina = historico.disciplina");
		sqlStr.append(" and his.historicocursandoporcorrespondenciaapostransferencia");
		sqlStr.append(" and his.transferenciamatrizcurricularmatricula = historico.transferenciamatrizcurricularmatricula");
		if (gradeCurricular != null) {
			sqlStr.append(" and his.matrizcurricular != ").append(gradeCurricular).append(" limit 1");
		} else {
			sqlStr.append(" and his.matrizcurricular != matricula.gradecurricularatual limit 1");
		}
		sqlStr.append(" )))) ");

		if (gradeCurricular != null) {
			sqlStr.append(" or (").append(gradeCurricular).append(" != historico.matrizcurricular");
		} else {
			sqlStr.append(" or (matricula.gradecurricularatual != historico.matrizcurricular");
		}
		sqlStr.append(" and historico.historicocursandoporcorrespondenciaapostransferencia ");
		sqlStr.append(" and historico.transferenciamatrizcurricularmatricula IS NOT NULL ");
		sqlStr.append(" and historico.disciplina = (select disciplina from historico his");
		sqlStr.append(" where his.matricula = historico.matricula ");
		sqlStr.append(" and his.anohistorico = historico.anohistorico");
		sqlStr.append(" and his.semestrehistorico = historico.semestrehistorico");
		sqlStr.append(" and his.disciplina = historico.disciplina");
		sqlStr.append(" and his.transferenciamatrizcurricularmatricula = historico.transferenciamatrizcurricularmatricula");
		sqlStr.append(" and (his.historicocursandoporcorrespondenciaapostransferencia is null or ");
		sqlStr.append(" his.historicocursandoporcorrespondenciaapostransferencia = false)");
		if (gradeCurricular != null) {
			sqlStr.append(" and his.matrizcurricular = ").append(gradeCurricular).append(" limit 1");
		} else {
			sqlStr.append(" and his.matrizcurricular = matricula.gradecurricularatual limit 1");
		}
		sqlStr.append("  ) and historico.historicoporequivalencia = false) ");
		sqlStr.append(" OR ( ");
		if (gradeCurricular != null) {
			sqlStr.append(" ").append(gradeCurricular).append(" != historico.matrizcurricular ");
		} else {
			sqlStr.append(" matricula.gradecurricularatual != historico.matrizcurricular ");
		}

		sqlStr.append(" AND historico.historicoequivalente =  true                 ");
		sqlStr.append(" AND exists ( ");
		sqlStr.append(" select hist.codigo from historico as hist ");
		sqlStr.append(" WHERE historico.matricula = hist.matricula ");
		sqlStr.append(" and historico.mapaequivalenciadisciplina = hist.mapaequivalenciadisciplina ");
		sqlStr.append(" and hist.historicoporequivalencia = true ");
		sqlStr.append(" and hist.numeroagrupamentoequivalenciadisciplina = historico.numeroagrupamentoequivalenciadisciplina ");
		sqlStr.append(" and exists ( ");
		sqlStr.append(" SELECT his.disciplina FROM historico his ");
		sqlStr.append(" WHERE his.matricula = hist.matricula ");
		sqlStr.append(" AND his.anohistorico = hist.anohistorico ");
		sqlStr.append(" AND his.semestrehistorico = hist.semestrehistorico ");
		sqlStr.append(" AND his.disciplina = hist.disciplina ");
		sqlStr.append(" AND his.transferenciamatrizcurricularmatricula = hist.transferenciamatrizcurricularmatricula ");
		sqlStr.append(" AND (his.historicocursandoporcorrespondenciaapostransferencia IS NULL OR his.historicocursandoporcorrespondenciaapostransferencia = FALSE ) ");
		if (gradeCurricular != null) {
			sqlStr.append(" AND his.matrizcurricular = ").append(gradeCurricular).append(" ");
		} else {
			sqlStr.append(" AND his.matrizcurricular = matricula.gradecurricularatual ");
		}

		sqlStr.append(" LIMIT 1)) ");
		sqlStr.append(" ) ");
		// Essa condição OR é responsável por trazer as disciplinas que fazem parte da composição após realizar transferencia
		// de matriz curricular. Isso porque após a transferência o aluno irá cursar a disciplina na grade antiga mesmo estando
		// já realizada a transferência para nova grade. O sistema então irá trazer o histórico da matriz antiga caso não possua a mesma disciplina na nova grade.
		sqlStr.append(" or (historico.matrizcurricular = matriculaPeriodo.gradecurricular ");
		if (gradeCurricular != null) {
			sqlStr.append(" and ").append(gradeCurricular).append(" != historico.matrizcurricular ");
		} else {
			sqlStr.append(" and matricula.gradecurricularatual != historico.matrizcurricular ");
		}

		sqlStr.append(" and historico.historicodisciplinafazpartecomposicao ");
		sqlStr.append(" and historico.disciplina not in (");
		sqlStr.append(" select his.disciplina from historico his ");
		sqlStr.append(" where his.matriculaperiodo = historico.matriculaperiodo ");
		sqlStr.append(" and his.disciplina = historico.disciplina ");
		if (gradeCurricular != null) {
			sqlStr.append(" and ").append(gradeCurricular).append(" = his.matrizcurricular))	");
		} else {
			sqlStr.append(" and matricula.gradecurricularatual = his.matrizcurricular))	");
		}

		sqlStr.append(") ");

		if (Uteis.isAtributoPreenchido(ano)) {
			sqlStr.append(" and historico.anohistorico = '").append(ano).append("'");
		}
		if (Uteis.isAtributoPreenchido(semestre)) {
			sqlStr.append(" and historico.semestrehistorico = '").append(semestre).append("'");
		}
		if (Uteis.isAtributoPreenchido(turma)) {
			sqlStr.append(" AND matriculaperiodo.turma = ").append(turma);
		}
		if (Uteis.isAtributoPreenchido(configuracaoAcademico)) {
			sqlStr.append(" AND historico.configuracaoAcademico = ").append(configuracaoAcademico);
		} else {
			sqlStr.append(" AND historico.configuracaoacademico is not null");
		}
		if (apresentarDisciplinaComposta) {
			sqlStr.append(" and (historico.historicoDisciplinaComposta is null or historico.historicoDisciplinaComposta = false)");
		} else {
			sqlStr.append(" and (historico.historicoDisciplinaFazParteComposicao is null or historico.historicoDisciplinaFazParteComposicao = false)");
		}

		if (situacaoRecuperacaoNota != null && !situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.TODAS)) {
			if (situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.SEM_RECUPERACAO)) {
				sqlStr.append(" and historico.matricula not in ( ");
			} else {
				sqlStr.append(" and historico.matricula in ( ");
			}
			sqlStr.append(" select his.matricula from historiconota ");
			sqlStr.append(" inner join historico his on his.codigo = historiconota.historico ");
			sqlStr.append(" inner join configuracaoacademiconota on configuracaoacademiconota.configuracaoacademico = his.configuracaoacademico ");
			sqlStr.append(" and historiconota.tiponota = configuracaoacademiconota.nota ");
			sqlStr.append(" where configuracaoacademiconota.notaRecuperacao ");
			sqlStr.append(" and his.matricula = historico.matricula ");
			sqlStr.append(" and his.anohistorico = historico.anohistorico ");
			sqlStr.append(" and his.semestrehistorico = historico.semestrehistorico ");
			sqlStr.append(" and his.matrizcurricular = historico.matrizcurricular ");
			sqlStr.append(" and (his.gradedisciplina is not null or his.gradeCurricularGrupoOptativaDisciplina is not null or his.historicoDisciplinaForaGrade = true or his.gradedisciplinacomposta is not null)");
			sqlStr.append(" and (his.historicoporequivalencia is null or his.historicoporequivalencia = false)");
			if (situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.NOTA_NAO_RECUPERADA)) {
				sqlStr.append(" and historiconota.situacaorecuperacaonota = 'NOTA_NAO_RECUPERADA' ");
			} else if (situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.NOTA_RECUPERADA)) {
				sqlStr.append(" and historiconota.situacaorecuperacaonota = 'NOTA_RECUPERADA' ");
			} else {
				sqlStr.append(" and historiconota.situacaorecuperacaonota in ('NOTA_RECUPERADA', 'NOTA_NAO_RECUPERADA', 'EM_RECUPERACAO') ");
			}
			if (bimestre != null) {
				sqlStr.append(" and configuracaoacademiconota.agrupamentoNota = ('").append(bimestre.name()).append("') ");
			}
			sqlStr.append(" order by replace(tiponota, 'NOTA_', '')::INT desc limit 1 ");
			sqlStr.append(" ) ");
		}

		sqlStr.append(" and (historico.gradedisciplina is not null or historico.gradeCurricularGrupoOptativaDisciplina is not null or historico.historicoDisciplinaForaGrade = true or historico.gradedisciplinacomposta is not null)");
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false)");
		sqlStr.append("and case when curso.periodicidade = 'IN' then historico.codigo = (select his.codigo from historico his ");
		sqlStr.append("where his.matricula = matricula.matricula and his.disciplina = disciplina.codigo ");
		if (Uteis.isAtributoPreenchido(ano)) {
			sqlStr.append(" and his.anohistorico = '").append(ano).append("'");
		}
		if (Uteis.isAtributoPreenchido(semestre)) {
			sqlStr.append(" and his.semestrehistorico = '").append(semestre).append("'");
		}
		if (Uteis.isAtributoPreenchido(configuracaoAcademico)) {
			sqlStr.append(" AND his.configuracaoAcademico = ").append(configuracaoAcademico);
		} else {
			sqlStr.append(" AND his.configuracaoacademico is not null");
		}
		if (apresentarDisciplinaComposta) {
			sqlStr.append(" and (his.historicoDisciplinaComposta is null or his.historicoDisciplinaComposta = false)");
		} else {
			sqlStr.append(" and (his.historicoDisciplinaFazParteComposicao is null or his.historicoDisciplinaFazParteComposicao = false)");
		}
		sqlStr.append(" and (his.historicoporequivalencia is null or his.historicoporequivalencia = false)");
		sqlStr.append("and his.matrizcurricular = historico.matrizcurricular order by his.dataregistro desc, case when his.situacao in ('AP', 'AA', 'CC', 'CH', 'AE', 'AB', 'CS') then 0 else 1 end, his.codigo desc limit 1) else true end ");
		sqlStr.append("ORDER BY periodoletivo.periodoletivo, disciplina.nome");
//		System.out.println(sqlStr);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsultaBoletim(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	@Override
	public SqlRowSet consultarPorMatriculaPeriodoLetivoBoletimEnsinoMedio(String matricula, Integer turma, String ano, String semestre, Boolean apresentarDisciplinaComposta, Integer configuracaoAcademico, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario, BimestreEnum bimestre, SituacaoRecuperacaoNotaEnum situacaoRecuperacaoNota, Integer gradeCurricular, List<String> listaNotas, Boolean transferenciaGradeCurricular) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select gradedisciplina.ordem, historico.*, disciplina.nome as \"disciplina.nome\",  disciplina.codigo as \"disciplina.codigo\", matriculaperiodo.ano as \"matriculaperiodo.ano\", matriculaperiodo.semestre as \"matriculaperiodo.semestre\", turma.codigo as \"turma.codigo\", ");
		sqlStr.append("configuracaoacademico.codigo, configuracaoacademico.intervaloNotasDiferente, configuracaoacademico.quantidadeCasasDecimaisPermitirAposVirgula, ");
		sqlStr.append("turno.codigo as codigoturno_matriculaperiodo, turno.nome as nometurno_matriculaperiodo, historico.matriculaperiodoturmadisciplina as \"matriculaperiodoturmadisciplina\", ");
		sqlStr.append("configuracaoacademico.utilizarNota1, configuracaoacademico.utilizarNota1PorConceito, configuracaoacademico.apresentarNota1, configuracaoacademico.bimestreNota1, configuracaoacademico.tituloNota1, configuracaoacademico.tituloNotaApresentar1, configuracaoacademico.nota1mediafinal, notaConceito1.abreviaturaConceitoNota as notaConceito1, ");
		sqlStr.append("configuracaoacademico.utilizarNota2, configuracaoacademico.utilizarNota2PorConceito, configuracaoacademico.apresentarNota2, configuracaoacademico.bimestreNota2, configuracaoacademico.tituloNota2, configuracaoacademico.tituloNotaApresentar2, configuracaoacademico.nota2mediafinal, notaConceito2.abreviaturaConceitoNota as notaConceito2, ");
		sqlStr.append("configuracaoacademico.utilizarNota3, configuracaoacademico.utilizarNota3PorConceito, configuracaoacademico.apresentarNota3, configuracaoacademico.bimestreNota3, configuracaoacademico.tituloNota3, configuracaoacademico.tituloNotaApresentar3, configuracaoacademico.nota3mediafinal, notaConceito3.abreviaturaConceitoNota as notaConceito3, ");
		sqlStr.append("configuracaoacademico.utilizarNota4, configuracaoacademico.utilizarNota4PorConceito, configuracaoacademico.apresentarNota4, configuracaoacademico.bimestreNota4, configuracaoacademico.tituloNota4, configuracaoacademico.tituloNotaApresentar4, configuracaoacademico.nota4mediafinal, notaConceito4.abreviaturaConceitoNota as notaConceito4, ");
		sqlStr.append("configuracaoacademico.utilizarNota5, configuracaoacademico.utilizarNota5PorConceito, configuracaoacademico.apresentarNota5, configuracaoacademico.bimestreNota5, configuracaoacademico.tituloNota5, configuracaoacademico.tituloNotaApresentar5, configuracaoacademico.nota5mediafinal, notaConceito5.abreviaturaConceitoNota as notaConceito5, ");
		sqlStr.append("configuracaoacademico.utilizarNota6, configuracaoacademico.utilizarNota6PorConceito, configuracaoacademico.apresentarNota6, configuracaoacademico.bimestreNota6, configuracaoacademico.tituloNota6, configuracaoacademico.tituloNotaApresentar6, configuracaoacademico.nota6mediafinal, notaConceito6.abreviaturaConceitoNota as notaConceito6, ");
		sqlStr.append("configuracaoacademico.utilizarNota7, configuracaoacademico.utilizarNota7PorConceito, configuracaoacademico.apresentarNota7, configuracaoacademico.bimestreNota7, configuracaoacademico.tituloNota7, configuracaoacademico.tituloNotaApresentar7, configuracaoacademico.nota7mediafinal, notaConceito7.abreviaturaConceitoNota as notaConceito7, ");
		sqlStr.append("configuracaoacademico.utilizarNota8, configuracaoacademico.utilizarNota8PorConceito, configuracaoacademico.apresentarNota8, configuracaoacademico.bimestreNota8, configuracaoacademico.tituloNota8, configuracaoacademico.tituloNotaApresentar8, configuracaoacademico.nota8mediafinal, notaConceito8.abreviaturaConceitoNota as notaConceito8, ");
		sqlStr.append("configuracaoacademico.utilizarNota9, configuracaoacademico.utilizarNota9PorConceito, configuracaoacademico.apresentarNota9, configuracaoacademico.bimestreNota9, configuracaoacademico.tituloNota9, configuracaoacademico.tituloNotaApresentar9, configuracaoacademico.nota9mediafinal, notaConceito9.abreviaturaConceitoNota as notaConceito9, ");
		sqlStr.append("configuracaoacademico.utilizarNota10, configuracaoacademico.utilizarNota10PorConceito, configuracaoacademico.apresentarNota10, configuracaoacademico.bimestreNota10, configuracaoacademico.tituloNota10, configuracaoacademico.tituloNotaApresentar10, configuracaoacademico.nota10mediafinal, notaConceito10.abreviaturaConceitoNota as notaConceito10, ");
		sqlStr.append("configuracaoacademico.utilizarNota11, configuracaoacademico.utilizarNota11PorConceito, configuracaoacademico.apresentarNota11, configuracaoacademico.bimestreNota11, configuracaoacademico.tituloNota11, configuracaoacademico.tituloNotaApresentar11, configuracaoacademico.nota11mediafinal, notaConceito11.abreviaturaConceitoNota as notaConceito11, ");
		sqlStr.append("configuracaoacademico.utilizarNota12, configuracaoacademico.utilizarNota12PorConceito, configuracaoacademico.apresentarNota12, configuracaoacademico.bimestreNota12, configuracaoacademico.tituloNota12, configuracaoacademico.tituloNotaApresentar12, configuracaoacademico.nota12mediafinal, notaConceito12.abreviaturaConceitoNota as notaConceito12, ");
		sqlStr.append("configuracaoacademico.utilizarNota13, configuracaoacademico.utilizarNota13PorConceito, configuracaoacademico.apresentarNota13, configuracaoacademico.bimestreNota13, configuracaoacademico.tituloNota13, configuracaoacademico.tituloNotaApresentar13, configuracaoacademico.nota13mediafinal, notaConceito13.abreviaturaConceitoNota as notaConceito13, ");
		sqlStr.append("configuracaoacademico.utilizarNota14, configuracaoacademico.utilizarNota14PorConceito, configuracaoacademico.apresentarNota14, configuracaoacademico.bimestreNota14, configuracaoacademico.tituloNota14, configuracaoacademico.tituloNotaApresentar14, configuracaoacademico.nota14mediafinal, notaConceito14.abreviaturaConceitoNota as notaConceito14, ");
		sqlStr.append("configuracaoacademico.utilizarNota15, configuracaoacademico.utilizarNota15PorConceito, configuracaoacademico.apresentarNota15, configuracaoacademico.bimestreNota15, configuracaoacademico.tituloNota15, configuracaoacademico.tituloNotaApresentar15, configuracaoacademico.nota15mediafinal, notaConceito15.abreviaturaConceitoNota as notaConceito15, ");
		sqlStr.append("configuracaoacademico.utilizarNota16, configuracaoacademico.utilizarNota16PorConceito, configuracaoacademico.apresentarNota16, configuracaoacademico.bimestreNota16, configuracaoacademico.tituloNota16, configuracaoacademico.tituloNotaApresentar16, configuracaoacademico.nota16mediafinal, notaConceito16.abreviaturaConceitoNota as notaConceito16, ");
		sqlStr.append("configuracaoacademico.utilizarNota17, configuracaoacademico.utilizarNota17PorConceito, configuracaoacademico.apresentarNota17, configuracaoacademico.bimestreNota17, configuracaoacademico.tituloNota17, configuracaoacademico.tituloNotaApresentar17, configuracaoacademico.nota17mediafinal, notaConceito17.abreviaturaConceitoNota as notaConceito17, ");
		sqlStr.append("configuracaoacademico.utilizarNota18, configuracaoacademico.utilizarNota18PorConceito, configuracaoacademico.apresentarNota18, configuracaoacademico.bimestreNota18, configuracaoacademico.tituloNota18, configuracaoacademico.tituloNotaApresentar18, configuracaoacademico.nota18mediafinal, notaConceito18.abreviaturaConceitoNota as notaConceito18, ");
		sqlStr.append("configuracaoacademico.utilizarNota19, configuracaoacademico.utilizarNota19PorConceito, configuracaoacademico.apresentarNota19, configuracaoacademico.bimestreNota19, configuracaoacademico.tituloNota19, configuracaoacademico.tituloNotaApresentar19, configuracaoacademico.nota19mediafinal, notaConceito19.abreviaturaConceitoNota as notaConceito19, ");
		sqlStr.append("configuracaoacademico.utilizarNota20, configuracaoacademico.utilizarNota20PorConceito, configuracaoacademico.apresentarNota20, configuracaoacademico.bimestreNota20, configuracaoacademico.tituloNota20, configuracaoacademico.tituloNotaApresentar20, configuracaoacademico.nota20mediafinal, notaConceito20.abreviaturaConceitoNota as notaConceito20, ");
		sqlStr.append("configuracaoacademico.utilizarNota21, configuracaoacademico.utilizarNota21PorConceito, configuracaoacademico.apresentarNota21, configuracaoacademico.bimestreNota21, configuracaoacademico.tituloNota21, configuracaoacademico.tituloNotaApresentar21, configuracaoacademico.nota21mediafinal, notaConceito21.abreviaturaConceitoNota as notaConceito21, ");
		sqlStr.append("configuracaoacademico.utilizarNota22, configuracaoacademico.utilizarNota22PorConceito, configuracaoacademico.apresentarNota22, configuracaoacademico.bimestreNota22, configuracaoacademico.tituloNota22, configuracaoacademico.tituloNotaApresentar22, configuracaoacademico.nota22mediafinal, notaConceito22.abreviaturaConceitoNota as notaConceito22, ");
		sqlStr.append("configuracaoacademico.utilizarNota23, configuracaoacademico.utilizarNota23PorConceito, configuracaoacademico.apresentarNota23, configuracaoacademico.bimestreNota23, configuracaoacademico.tituloNota23, configuracaoacademico.tituloNotaApresentar23, configuracaoacademico.nota23mediafinal, notaConceito23.abreviaturaConceitoNota as notaConceito23, ");
		sqlStr.append("configuracaoacademico.utilizarNota24, configuracaoacademico.utilizarNota24PorConceito, configuracaoacademico.apresentarNota24, configuracaoacademico.bimestreNota24, configuracaoacademico.tituloNota24, configuracaoacademico.tituloNotaApresentar24, configuracaoacademico.nota24mediafinal, notaConceito24.abreviaturaConceitoNota as notaConceito24, ");
		sqlStr.append("configuracaoacademico.utilizarNota25, configuracaoacademico.utilizarNota25PorConceito, configuracaoacademico.apresentarNota25, configuracaoacademico.bimestreNota25, configuracaoacademico.tituloNota25, configuracaoacademico.tituloNotaApresentar25, configuracaoacademico.nota25mediafinal, notaConceito25.abreviaturaConceitoNota as notaConceito25, ");
		sqlStr.append("configuracaoacademico.utilizarNota26, configuracaoacademico.utilizarNota26PorConceito, configuracaoacademico.apresentarNota26, configuracaoacademico.bimestreNota26, configuracaoacademico.tituloNota26, configuracaoacademico.tituloNotaApresentar26, configuracaoacademico.nota26mediafinal, notaConceito26.abreviaturaConceitoNota as notaConceito26, ");
		sqlStr.append("configuracaoacademico.utilizarNota27, configuracaoacademico.utilizarNota27PorConceito, configuracaoacademico.apresentarNota27, configuracaoacademico.bimestreNota27, configuracaoacademico.tituloNota27, configuracaoacademico.tituloNotaApresentar27, configuracaoacademico.nota27mediafinal, notaConceito27.abreviaturaConceitoNota as notaConceito27, ");
		sqlStr.append("configuracaoacademico.utilizarNota28, configuracaoacademico.utilizarNota28PorConceito, configuracaoacademico.apresentarNota28, configuracaoacademico.bimestreNota28, configuracaoacademico.tituloNota28, configuracaoacademico.tituloNotaApresentar28, configuracaoacademico.nota28mediafinal, notaConceito28.abreviaturaConceitoNota as notaConceito28, ");
		sqlStr.append("configuracaoacademico.utilizarNota29, configuracaoacademico.utilizarNota29PorConceito, configuracaoacademico.apresentarNota29, configuracaoacademico.bimestreNota29, configuracaoacademico.tituloNota29, configuracaoacademico.tituloNotaApresentar29, configuracaoacademico.nota29mediafinal, notaConceito29.abreviaturaConceitoNota as notaConceito29, ");
		sqlStr.append("configuracaoacademico.utilizarNota30, configuracaoacademico.utilizarNota30PorConceito, configuracaoacademico.apresentarNota30, configuracaoacademico.bimestreNota30, configuracaoacademico.tituloNota30, configuracaoacademico.tituloNotaApresentar30, configuracaoacademico.nota30mediafinal, notaConceito30.abreviaturaConceitoNota as notaConceito30, ");

		sqlStr.append("configuracaoacademico.utilizarNota31, configuracaoacademico.utilizarNota31PorConceito, configuracaoacademico.apresentarNota31, configuracaoacademico.bimestreNota31, configuracaoacademico.tituloNota31, configuracaoacademico.tituloNotaApresentar31, configuracaoacademico.nota31mediafinal, notaConceito31.abreviaturaConceitoNota as notaConceito31, ");
		sqlStr.append("configuracaoacademico.utilizarNota32, configuracaoacademico.utilizarNota32PorConceito, configuracaoacademico.apresentarNota32, configuracaoacademico.bimestreNota32, configuracaoacademico.tituloNota32, configuracaoacademico.tituloNotaApresentar32, configuracaoacademico.nota32mediafinal, notaConceito32.abreviaturaConceitoNota as notaConceito32, ");
		sqlStr.append("configuracaoacademico.utilizarNota33, configuracaoacademico.utilizarNota33PorConceito, configuracaoacademico.apresentarNota33, configuracaoacademico.bimestreNota33, configuracaoacademico.tituloNota33, configuracaoacademico.tituloNotaApresentar33, configuracaoacademico.nota33mediafinal, notaConceito33.abreviaturaConceitoNota as notaConceito33, ");
		sqlStr.append("configuracaoacademico.utilizarNota34, configuracaoacademico.utilizarNota34PorConceito, configuracaoacademico.apresentarNota34, configuracaoacademico.bimestreNota34, configuracaoacademico.tituloNota34, configuracaoacademico.tituloNotaApresentar34, configuracaoacademico.nota34mediafinal, notaConceito34.abreviaturaConceitoNota as notaConceito34, ");
		sqlStr.append("configuracaoacademico.utilizarNota35, configuracaoacademico.utilizarNota35PorConceito, configuracaoacademico.apresentarNota35, configuracaoacademico.bimestreNota35, configuracaoacademico.tituloNota35, configuracaoacademico.tituloNotaApresentar35, configuracaoacademico.nota35mediafinal, notaConceito35.abreviaturaConceitoNota as notaConceito35, ");
		sqlStr.append("configuracaoacademico.utilizarNota36, configuracaoacademico.utilizarNota36PorConceito, configuracaoacademico.apresentarNota36, configuracaoacademico.bimestreNota36, configuracaoacademico.tituloNota36, configuracaoacademico.tituloNotaApresentar36, configuracaoacademico.nota36mediafinal, notaConceito36.abreviaturaConceitoNota as notaConceito36, ");
		sqlStr.append("configuracaoacademico.utilizarNota37, configuracaoacademico.utilizarNota37PorConceito, configuracaoacademico.apresentarNota37, configuracaoacademico.bimestreNota37, configuracaoacademico.tituloNota37, configuracaoacademico.tituloNotaApresentar37, configuracaoacademico.nota37mediafinal, notaConceito37.abreviaturaConceitoNota as notaConceito37, ");
		sqlStr.append("configuracaoacademico.utilizarNota38, configuracaoacademico.utilizarNota38PorConceito, configuracaoacademico.apresentarNota38, configuracaoacademico.bimestreNota38, configuracaoacademico.tituloNota38, configuracaoacademico.tituloNotaApresentar38, configuracaoacademico.nota38mediafinal, notaConceito38.abreviaturaConceitoNota as notaConceito38, ");
		sqlStr.append("configuracaoacademico.utilizarNota39, configuracaoacademico.utilizarNota39PorConceito, configuracaoacademico.apresentarNota39, configuracaoacademico.bimestreNota39, configuracaoacademico.tituloNota39, configuracaoacademico.tituloNotaApresentar39, configuracaoacademico.nota39mediafinal, notaConceito39.abreviaturaConceitoNota as notaConceito39, ");
		sqlStr.append("configuracaoacademico.utilizarNota40, configuracaoacademico.utilizarNota40PorConceito, configuracaoacademico.apresentarNota40, configuracaoacademico.bimestreNota40, configuracaoacademico.tituloNota40, configuracaoacademico.tituloNotaApresentar40, configuracaoacademico.nota40mediafinal, notaConceito40.abreviaturaConceitoNota as notaConceito40, ");

		sqlStr.append("mediaConceito.abreviaturaConceitoNota as mediaConceito, (case when curso.periodicidade = 'IN' then matricula.situacao else matriculaperiodo.situacaomatriculaperiodo end) as situacaomatriculaperiodo, disciplina.codigo as codigodisciplina, ");
		sqlStr.append("configuracaoacademiconota1.apresentarNotaBoletim as apresentarNota1Boletim, ");
		sqlStr.append("configuracaoacademiconota2.apresentarNotaBoletim as apresentarNota2Boletim, ");
		sqlStr.append("configuracaoacademiconota3.apresentarNotaBoletim as apresentarNota3Boletim, ");
		sqlStr.append("configuracaoacademiconota4.apresentarNotaBoletim as apresentarNota4Boletim, ");
		sqlStr.append("configuracaoacademiconota5.apresentarNotaBoletim as apresentarNota5Boletim, ");
		sqlStr.append("configuracaoacademiconota6.apresentarNotaBoletim as apresentarNota6Boletim, ");
		sqlStr.append("configuracaoacademiconota7.apresentarNotaBoletim as apresentarNota7Boletim, ");
		sqlStr.append("configuracaoacademiconota8.apresentarNotaBoletim as apresentarNota8Boletim, ");
		sqlStr.append("configuracaoacademiconota9.apresentarNotaBoletim as apresentarNota9Boletim, ");
		sqlStr.append("configuracaoacademiconota10.apresentarNotaBoletim as apresentarNota10Boletim, ");
		sqlStr.append("configuracaoacademiconota11.apresentarNotaBoletim as apresentarNota11Boletim, ");
		sqlStr.append("configuracaoacademiconota12.apresentarNotaBoletim as apresentarNota12Boletim, ");
		sqlStr.append("configuracaoacademiconota13.apresentarNotaBoletim as apresentarNota13Boletim, ");
		sqlStr.append("configuracaoacademiconota14.apresentarNotaBoletim as apresentarNota14Boletim, ");
		sqlStr.append("configuracaoacademiconota15.apresentarNotaBoletim as apresentarNota15Boletim, ");
		sqlStr.append("configuracaoacademiconota16.apresentarNotaBoletim as apresentarNota16Boletim, ");
		sqlStr.append("configuracaoacademiconota17.apresentarNotaBoletim as apresentarNota17Boletim, ");
		sqlStr.append("configuracaoacademiconota18.apresentarNotaBoletim as apresentarNota18Boletim, ");
		sqlStr.append("configuracaoacademiconota19.apresentarNotaBoletim as apresentarNota19Boletim, ");
		sqlStr.append("configuracaoacademiconota20.apresentarNotaBoletim as apresentarNota20Boletim, ");
		sqlStr.append("configuracaoacademiconota21.apresentarNotaBoletim as apresentarNota21Boletim, ");
		sqlStr.append("configuracaoacademiconota22.apresentarNotaBoletim as apresentarNota22Boletim, ");
		sqlStr.append("configuracaoacademiconota23.apresentarNotaBoletim as apresentarNota23Boletim, ");
		sqlStr.append("configuracaoacademiconota24.apresentarNotaBoletim as apresentarNota24Boletim, ");
		sqlStr.append("configuracaoacademiconota25.apresentarNotaBoletim as apresentarNota25Boletim, ");
		sqlStr.append("configuracaoacademiconota26.apresentarNotaBoletim as apresentarNota26Boletim, ");
		sqlStr.append("configuracaoacademiconota27.apresentarNotaBoletim as apresentarNota27Boletim, ");
		sqlStr.append("configuracaoacademiconota28.apresentarNotaBoletim as apresentarNota28Boletim, ");
		sqlStr.append("configuracaoacademiconota29.apresentarNotaBoletim as apresentarNota29Boletim, ");
		sqlStr.append("configuracaoacademiconota30.apresentarNotaBoletim as apresentarNota30Boletim, ");

		sqlStr.append("configuracaoacademiconota31.apresentarNotaBoletim as apresentarNota31Boletim, ");
		sqlStr.append("configuracaoacademiconota32.apresentarNotaBoletim as apresentarNota32Boletim, ");
		sqlStr.append("configuracaoacademiconota33.apresentarNotaBoletim as apresentarNota33Boletim, ");
		sqlStr.append("configuracaoacademiconota34.apresentarNotaBoletim as apresentarNota34Boletim, ");
		sqlStr.append("configuracaoacademiconota35.apresentarNotaBoletim as apresentarNota35Boletim, ");
		sqlStr.append("configuracaoacademiconota36.apresentarNotaBoletim as apresentarNota36Boletim, ");
		sqlStr.append("configuracaoacademiconota37.apresentarNotaBoletim as apresentarNota37Boletim, ");
		sqlStr.append("configuracaoacademiconota38.apresentarNotaBoletim as apresentarNota38Boletim, ");
		sqlStr.append("configuracaoacademiconota39.apresentarNotaBoletim as apresentarNota39Boletim, ");
		sqlStr.append("configuracaoacademiconota40.apresentarNotaBoletim as apresentarNota40Boletim, ");

		sqlStr.append("case when (gradedisciplina.codigo is not null and gradedisciplina.diversificada) or (gradecurriculargrupooptativadisciplina.codigo is not null and gradecurriculargrupooptativadisciplina.diversificada) then true else false end as parteDiversificada,  ");
		sqlStr.append(" case when periodoletivo.configuracaoAcademico is null then curso.configuracaoAcademico else periodoletivo.configuracaoAcademico end  as configuracaoAcademicoFechamentoPeriodoLetivo ");
		sqlStr.append("from historico ");
		sqlStr.append("inner join matricula on matricula.matricula = historico.matricula ");
		sqlStr.append("inner join disciplina on disciplina.codigo = historico.disciplina ");
		sqlStr.append("inner join curso on curso.codigo = matricula.curso ");
		sqlStr.append("left join gradedisciplina on gradedisciplina.codigo = historico.gradedisciplina ");
		sqlStr.append("left join gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = historico.gradecurriculargrupooptativadisciplina ");
		sqlStr.append("left join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo ");
		sqlStr.append("left join unidadeensinocurso on unidadeensinocurso.codigo = matriculaperiodo.unidadeensinocurso ");
		sqlStr.append("left join turno on turno.codigo = unidadeensinocurso.turno ");
		sqlStr.append("left JOIN periodoletivo ON case when matriculaperiodo.codigo is not null then matriculaperiodo.periodoletivomatricula else case when historico.periodoletivocursada is not null then historico.periodoletivocursada else historico.periodoletivomatrizcurricular end end  = periodoletivo.codigo ");
		sqlStr.append("left join matriculaperiodoturmadisciplina on matriculaperiodoturmadisciplina.codigo = historico.matriculaperiodoturmadisciplina ");
		sqlStr.append("left join turma on turma.codigo = matriculaperiodoturmadisciplina.turma ");
		sqlStr.append("left join configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito1 on notaConceito1.codigo = historico.nota1Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito2 on notaConceito2.codigo = historico.nota2Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito3 on notaConceito3.codigo = historico.nota3Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito4 on notaConceito4.codigo = historico.nota4Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito5 on notaConceito5.codigo = historico.nota5Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito6 on notaConceito6.codigo = historico.nota6Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito7 on notaConceito7.codigo = historico.nota7Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito8 on notaConceito8.codigo = historico.nota8Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito9 on notaConceito9.codigo = historico.nota9Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito10 on notaConceito10.codigo = historico.nota10Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito11 on notaConceito11.codigo = historico.nota11Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito12 on notaConceito12.codigo = historico.nota12Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito13 on notaConceito13.codigo = historico.nota13Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito14 on notaConceito14.codigo = historico.nota14Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito15 on notaConceito15.codigo = historico.nota15Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito16 on notaConceito16.codigo = historico.nota16Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito17 on notaConceito17.codigo = historico.nota17Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito18 on notaConceito18.codigo = historico.nota18Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito19 on notaConceito19.codigo = historico.nota19Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito20 on notaConceito20.codigo = historico.nota20Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito21 on notaConceito21.codigo = historico.nota21Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito22 on notaConceito22.codigo = historico.nota22Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito23 on notaConceito23.codigo = historico.nota23Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito24 on notaConceito24.codigo = historico.nota24Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito25 on notaConceito25.codigo = historico.nota25Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito26 on notaConceito26.codigo = historico.nota26Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito27 on notaConceito27.codigo = historico.nota27Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito28 on notaConceito28.codigo = historico.nota28Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito29 on notaConceito29.codigo = historico.nota29Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito30 on notaConceito30.codigo = historico.nota30Conceito ");

		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito31 on notaConceito31.codigo = historico.nota31Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito32 on notaConceito32.codigo = historico.nota32Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito33 on notaConceito33.codigo = historico.nota33Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito34 on notaConceito34.codigo = historico.nota34Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito35 on notaConceito35.codigo = historico.nota35Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito36 on notaConceito36.codigo = historico.nota36Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito37 on notaConceito37.codigo = historico.nota37Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito38 on notaConceito38.codigo = historico.nota38Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito39 on notaConceito39.codigo = historico.nota39Conceito ");
		sqlStr.append("left join configuracaoacademiconotaconceito as notaConceito40 on notaConceito40.codigo = historico.nota40Conceito ");

		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota1 on configuracaoacademiconota1.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota1.nota = '").append(TipoNotaConceitoEnum.NOTA_1).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota2 on configuracaoacademiconota2.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota2.nota = '").append(TipoNotaConceitoEnum.NOTA_2).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota3 on configuracaoacademiconota3.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota3.nota = '").append(TipoNotaConceitoEnum.NOTA_3).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota4 on configuracaoacademiconota4.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota4.nota = '").append(TipoNotaConceitoEnum.NOTA_4).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota5 on configuracaoacademiconota5.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota5.nota = '").append(TipoNotaConceitoEnum.NOTA_5).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota6 on configuracaoacademiconota6.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota6.nota = '").append(TipoNotaConceitoEnum.NOTA_6).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota7 on configuracaoacademiconota7.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota7.nota = '").append(TipoNotaConceitoEnum.NOTA_7).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota8 on configuracaoacademiconota8.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota8.nota = '").append(TipoNotaConceitoEnum.NOTA_8).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota9 on configuracaoacademiconota9.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota9.nota = '").append(TipoNotaConceitoEnum.NOTA_9).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota10 on configuracaoacademiconota10.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota10.nota = '").append(TipoNotaConceitoEnum.NOTA_10).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota11 on configuracaoacademiconota11.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota11.nota = '").append(TipoNotaConceitoEnum.NOTA_11).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota12 on configuracaoacademiconota12.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota12.nota = '").append(TipoNotaConceitoEnum.NOTA_12).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota13 on configuracaoacademiconota13.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota13.nota = '").append(TipoNotaConceitoEnum.NOTA_13).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota14 on configuracaoacademiconota14.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota14.nota = '").append(TipoNotaConceitoEnum.NOTA_14).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota15 on configuracaoacademiconota15.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota15.nota = '").append(TipoNotaConceitoEnum.NOTA_15).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota16 on configuracaoacademiconota16.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota16.nota = '").append(TipoNotaConceitoEnum.NOTA_16).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota17 on configuracaoacademiconota17.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota17.nota = '").append(TipoNotaConceitoEnum.NOTA_17).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota18 on configuracaoacademiconota18.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota18.nota = '").append(TipoNotaConceitoEnum.NOTA_18).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota19 on configuracaoacademiconota19.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota19.nota = '").append(TipoNotaConceitoEnum.NOTA_19).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota20 on configuracaoacademiconota20.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota20.nota = '").append(TipoNotaConceitoEnum.NOTA_20).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota21 on configuracaoacademiconota21.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota21.nota = '").append(TipoNotaConceitoEnum.NOTA_21).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota22 on configuracaoacademiconota22.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota22.nota = '").append(TipoNotaConceitoEnum.NOTA_22).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota23 on configuracaoacademiconota23.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota23.nota = '").append(TipoNotaConceitoEnum.NOTA_23).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota24 on configuracaoacademiconota24.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota24.nota = '").append(TipoNotaConceitoEnum.NOTA_24).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota25 on configuracaoacademiconota25.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota25.nota = '").append(TipoNotaConceitoEnum.NOTA_25).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota26 on configuracaoacademiconota26.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota26.nota = '").append(TipoNotaConceitoEnum.NOTA_26).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota27 on configuracaoacademiconota27.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota27.nota = '").append(TipoNotaConceitoEnum.NOTA_27).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota28 on configuracaoacademiconota28.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota28.nota = '").append(TipoNotaConceitoEnum.NOTA_28).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota29 on configuracaoacademiconota29.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota29.nota = '").append(TipoNotaConceitoEnum.NOTA_29).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota30 on configuracaoacademiconota30.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota30.nota = '").append(TipoNotaConceitoEnum.NOTA_30).append("' ");

		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota31 on configuracaoacademiconota31.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota31.nota = '").append(TipoNotaConceitoEnum.NOTA_31).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota32 on configuracaoacademiconota32.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota32.nota = '").append(TipoNotaConceitoEnum.NOTA_32).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota33 on configuracaoacademiconota33.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota33.nota = '").append(TipoNotaConceitoEnum.NOTA_33).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota34 on configuracaoacademiconota34.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota34.nota = '").append(TipoNotaConceitoEnum.NOTA_34).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota35 on configuracaoacademiconota35.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota35.nota = '").append(TipoNotaConceitoEnum.NOTA_35).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota36 on configuracaoacademiconota36.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota36.nota = '").append(TipoNotaConceitoEnum.NOTA_36).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota37 on configuracaoacademiconota37.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota37.nota = '").append(TipoNotaConceitoEnum.NOTA_37).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota38 on configuracaoacademiconota38.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota38.nota = '").append(TipoNotaConceitoEnum.NOTA_38).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota39 on configuracaoacademiconota39.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota39.nota = '").append(TipoNotaConceitoEnum.NOTA_39).append("' ");
		sqlStr.append("left join configuracaoacademiconota as configuracaoacademiconota40 on configuracaoacademiconota40.configuracaoacademico = configuracaoacademico.codigo and configuracaoacademiconota40.nota = '").append(TipoNotaConceitoEnum.NOTA_40).append("' ");

		sqlStr.append("left join configuracaoacademiconotaconceito as mediaConceito on mediaConceito.codigo = historico.mediaFinalConceito ");
		sqlStr.append("WHERE historico.matricula = '").append(matricula).append("'");
		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		//sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		if (Uteis.isAtributoPreenchido(transferenciaGradeCurricular) && transferenciaGradeCurricular) {
			if (Uteis.isAtributoPreenchido(gradeCurricular)) {
				sqlStr.append(" and historico.matrizcurricular = ").append(gradeCurricular).append(" ");
			} else {
				sqlStr.append(" historico.matrizcurricular = matricula.gradecurricularatual ");
			}
			sqlStr.append(" and (").append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" "));
			sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" or ")).append(" = false )");
		} else {
			sqlStr.append(" and ");
			if (gradeCurricular != null && gradeCurricular > 0) {
				sqlStr.append(" ((").append(gradeCurricular).append(" = historico.matrizcurricular");
			} else {
				sqlStr.append(" ((matricula.gradecurricularatual = historico.matrizcurricular");
			}
			sqlStr.append(" and (historico.historicocursandoporcorrespondenciaapostransferencia is null or");
			sqlStr.append(" historico.historicocursandoporcorrespondenciaapostransferencia = false)");
			sqlStr.append(" and (historico.transferenciamatrizcurricularmatricula IS NULL OR (historico.transferenciamatrizcurricularmatricula IS NOT NULL ");
			sqlStr.append(" and historico.disciplina not in (select disciplina from historico his");
			sqlStr.append(" where his.matricula = historico.matricula");
			sqlStr.append(" and his.anohistorico = historico.anohistorico");
			sqlStr.append(" and his.semestrehistorico = historico.semestrehistorico");
			sqlStr.append(" and his.disciplina = historico.disciplina");
			sqlStr.append(" and his.historicocursandoporcorrespondenciaapostransferencia");
			sqlStr.append(" and his.transferenciamatrizcurricularmatricula = historico.transferenciamatrizcurricularmatricula");
			if (gradeCurricular != null  && gradeCurricular > 0) {
				sqlStr.append(" and his.matrizcurricular != ").append(gradeCurricular).append(" limit 1");
			} else {
				sqlStr.append(" and his.matrizcurricular != matricula.gradecurricularatual limit 1");
			}
			sqlStr.append(" )))) ");
			if (gradeCurricular != null  && gradeCurricular > 0) {
				sqlStr.append(" or (").append(gradeCurricular).append(" != historico.matrizcurricular");
			} else {
				sqlStr.append(" or (matricula.gradecurricularatual != historico.matrizcurricular");
			}

			sqlStr.append(" and historico.historicocursandoporcorrespondenciaapostransferencia ");
			sqlStr.append(" and historico.transferenciamatrizcurricularmatricula IS NOT NULL ");
			sqlStr.append(" and historico.disciplina = (select disciplina from historico his");
			sqlStr.append(" where his.matricula = historico.matricula ");
			sqlStr.append(" and his.anohistorico = historico.anohistorico");
			sqlStr.append(" and his.semestrehistorico = historico.semestrehistorico");
			sqlStr.append(" and his.disciplina = historico.disciplina");
			sqlStr.append(" and his.transferenciamatrizcurricularmatricula = historico.transferenciamatrizcurricularmatricula");
			sqlStr.append(" and (his.historicocursandoporcorrespondenciaapostransferencia is null or ");
			sqlStr.append(" his.historicocursandoporcorrespondenciaapostransferencia = false)");
			if (gradeCurricular != null  && gradeCurricular > 0) {
				sqlStr.append(" and his.matrizcurricular = ").append(gradeCurricular).append(" limit 1");
			} else {
				sqlStr.append(" and his.matrizcurricular = matricula.gradecurricularatual limit 1");
			}

			sqlStr.append("  ) and historico.historicoporequivalencia = false) ");
			sqlStr.append(" OR ( ");
			if (gradeCurricular != null  && gradeCurricular > 0) {
				sqlStr.append(" ").append(gradeCurricular).append(" != historico.matrizcurricular ");
			} else {
				sqlStr.append(" matricula.gradecurricularatual != historico.matrizcurricular ");
			}

			sqlStr.append(" AND historico.historicoequivalente =  true                 ");
			sqlStr.append(" AND exists ( ");
			sqlStr.append(" select hist.codigo from historico as hist ");
			sqlStr.append(" WHERE historico.matricula = hist.matricula ");
			sqlStr.append(" and historico.mapaequivalenciadisciplina = hist.mapaequivalenciadisciplina ");
			sqlStr.append(" and hist.historicoporequivalencia = true ");
			sqlStr.append(" and hist.numeroagrupamentoequivalenciadisciplina = historico.numeroagrupamentoequivalenciadisciplina ");
			sqlStr.append(" and exists ( ");
			sqlStr.append(" SELECT his.disciplina FROM historico his ");
			sqlStr.append(" WHERE his.matricula = hist.matricula ");
			sqlStr.append(" AND his.anohistorico = hist.anohistorico ");
			sqlStr.append(" AND his.semestrehistorico = hist.semestrehistorico ");
			sqlStr.append(" AND his.disciplina = hist.disciplina ");
			sqlStr.append(" AND his.transferenciamatrizcurricularmatricula = hist.transferenciamatrizcurricularmatricula ");
			sqlStr.append(" AND (his.historicocursandoporcorrespondenciaapostransferencia IS NULL OR his.historicocursandoporcorrespondenciaapostransferencia = FALSE ) ");
			if (gradeCurricular != null  && gradeCurricular > 0) {
				sqlStr.append(" AND his.matrizcurricular = ").append(gradeCurricular).append(" ");
			} else {
				sqlStr.append(" AND his.matrizcurricular = matricula.gradecurricularatual ");
			}

			sqlStr.append(" LIMIT 1)) ");
			sqlStr.append(" ) ");
			// Essa condição OR é responsável por trazer as disciplinas que fazem parte da composição após realizar transferencia
			// de matriz curricular. Isso porque após a transferência o aluno irá cursar a disciplina na grade antiga mesmo estando
			// já realizada a transferência para nova grade. O sistema então irá trazer o histórico da matriz antiga caso não possua a mesma disciplina na nova grade.
			sqlStr.append(" or (historico.matrizcurricular = matriculaPeriodo.gradecurricular ");
			if (gradeCurricular != null  && gradeCurricular > 0) {
				sqlStr.append(" and ").append(gradeCurricular).append(" != historico.matrizcurricular ");
			} else {
				sqlStr.append(" and matricula.gradecurricularatual != historico.matrizcurricular ");
			}
			sqlStr.append(" and historico.historicodisciplinafazpartecomposicao ");
			sqlStr.append(" and historico.disciplina not in (");
			sqlStr.append(" select his.disciplina from historico his ");
			sqlStr.append(" where his.matriculaperiodo = historico.matriculaperiodo ");
			sqlStr.append(" and his.disciplina = historico.disciplina ");
			if (gradeCurricular != null  && gradeCurricular > 0) {
				sqlStr.append(" and ").append(gradeCurricular).append(" = his.matrizcurricular))	");
			} else {
				sqlStr.append(" and matricula.gradecurricularatual = his.matrizcurricular))	");
			}
			sqlStr.append(") ");
		}

		if (Uteis.isAtributoPreenchido(ano)) {
			sqlStr.append(" and historico.anohistorico = '").append(ano).append("'");
		}
		if (Uteis.isAtributoPreenchido(semestre)) {
			sqlStr.append(" and historico.semestrehistorico = '").append(semestre).append("'");
		}
		if (Uteis.isAtributoPreenchido(turma)) {
			sqlStr.append(" AND matriculaperiodo.turma = ").append(turma);
		}
		if (Uteis.isAtributoPreenchido(configuracaoAcademico)) {
			sqlStr.append(" AND historico.configuracaoAcademico = ").append(configuracaoAcademico);
		} else {
			sqlStr.append(" AND historico.configuracaoacademico is not null");
		}
		if (apresentarDisciplinaComposta) {
			sqlStr.append(" and (historico.historicoDisciplinaComposta is null or historico.historicoDisciplinaComposta = false)");
		} else {
			sqlStr.append(" and (historico.historicoDisciplinaFazParteComposicao is null or historico.historicoDisciplinaFazParteComposicao = false)");
		}
		if (situacaoRecuperacaoNota != null && !situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.TODAS)) {
			if (situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.SEM_RECUPERACAO)) {
				sqlStr.append(" and historico.matricula not in ( ");
			} else {
				sqlStr.append(" and historico.matricula in ( ");
			}
			sqlStr.append(" select his.matricula from historiconota ");
			sqlStr.append(" inner join historico his on his.codigo = historiconota.historico ");
			sqlStr.append(" inner join configuracaoacademiconota on configuracaoacademiconota.configuracaoacademico = his.configuracaoacademico ");
			sqlStr.append(" and historiconota.tiponota = configuracaoacademiconota.nota ");
			sqlStr.append(" where configuracaoacademiconota.notaRecuperacao ");
			sqlStr.append(" and his.matricula = historico.matricula ");
			sqlStr.append(" and his.anohistorico = historico.anohistorico ");
			sqlStr.append(" and his.semestrehistorico = historico.semestrehistorico ");
			sqlStr.append(" and his.matrizcurricular = historico.matrizcurricular ");
			sqlStr.append(" and (his.gradedisciplina is not null or his.gradeCurricularGrupoOptativaDisciplina is not null or his.historicoDisciplinaForaGrade = true or his.gradedisciplinacomposta is not null)");
			sqlStr.append(" and (his.historicoporequivalencia is null or his.historicoporequivalencia = false)");
			if (situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.NOTA_NAO_RECUPERADA)) {
				sqlStr.append(" and historiconota.situacaorecuperacaonota = 'NOTA_NAO_RECUPERADA' ");
			} else if (situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.NOTA_RECUPERADA)) {
				sqlStr.append(" and historiconota.situacaorecuperacaonota = 'NOTA_RECUPERADA' ");
			} else {
				sqlStr.append(" and historiconota.situacaorecuperacaonota in ('NOTA_RECUPERADA', 'NOTA_NAO_RECUPERADA', 'EM_RECUPERACAO') ");
			}
			if (bimestre != null) {
				sqlStr.append(" and configuracaoacademiconota.agrupamentoNota = ('").append(bimestre.name()).append("') ");
			}
			sqlStr.append(" order by replace(tiponota, 'NOTA_', '')::INT desc limit 1 ");
			sqlStr.append(" ) ");
		}
		sqlStr.append(" and (historico.gradedisciplina is not null or historico.gradeCurricularGrupoOptativaDisciplina is not null or historico.historicoDisciplinaForaGrade = true or historico.gradedisciplinacomposta is not null) ");
		sqlStr.append("and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		sqlStr.append("and matriculaperiodo.situacaomatriculaperiodo not in ('PC') ");
		sqlStr.append("and case when curso.periodicidade = 'IN' then historico.codigo = (select his.codigo from historico his ");
		sqlStr.append("where his.matricula = matricula.matricula and his.disciplina = disciplina.codigo ");
		sqlStr.append("and his.matrizcurricular = historico.matrizcurricular order by his.dataregistro desc, case when his.situacao in ('AP', 'AA', 'CC', 'CH', 'AE', 'AB', 'CS') then 0 else 1 end, his.codigo desc limit 1) else true end ");
		return getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
	}

	public List<Integer> consultarPorChavePrimariaDadosConfiguracaoAcademicaDadosMinimos(String matricula, List<HistoricoVO> listaAnoSemestreVOs, UsuarioVO usuarioVO) throws ConsistirException, Exception {
		List<Integer> listaConfiguracoes = new ArrayList<Integer>(0);
		StringBuilder sb = new StringBuilder();
		sb.append("SELECT DISTINCT historico.configuracaoAcademico AS \"configuracaoAcademico.codigo\" FROM historico ");
		sb.append(" WHERE historico.matricula = '").append(matricula).append("' AND historico.configuracaoAcademico IS NOT NULL");
		if (listaAnoSemestreVOs != null && !listaAnoSemestreVOs.isEmpty()) {
			sb.append(" AND historico.anoHistorico in(");
			for (HistoricoVO historicoVO : listaAnoSemestreVOs) {
				sb.append("'").append(historicoVO.getAnoHistorico()).append("', ");
			}
			sb.append("'0', '' ) ");
		}
		if (listaAnoSemestreVOs != null && !listaAnoSemestreVOs.isEmpty()) {
			sb.append(" AND historico.semestreHistorico in(");
			for (HistoricoVO historicoVO : listaAnoSemestreVOs) {
				if(!historicoVO.getSemestreHistorico().trim().isEmpty()){
					sb.append("'").append(historicoVO.getSemestreHistorico()).append("', ");
				}
			}
			sb.append("'0', '' ) ");
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (tabelaResultado.next()) {
			listaConfiguracoes.add(tabelaResultado.getInt("configuracaoAcademico.codigo"));
		}
		return listaConfiguracoes;
	}

	public List consultarPeriodoLetivoPorMatriculaPeriodoLetivoBoletim(String matricula, Integer turma, Integer periodoLetivo, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT DISTINCT periodoletivo.periodoletivo AS periodoletivo FROM Historico " + "LEFT JOIN matriculaperiodo ON historico.matriculaperiodo = matriculaperiodo.codigo " + "LEFT JOIN periodoletivo ON matriculaperiodo.periodoletivomatricula = periodoletivo.codigo " + "LEFT join matricula on matricula.matricula = historico.matricula  " + "LEFT join curso on curso.codigo = matricula.curso " + "WHERE historico.matricula = '" + matricula + "' ";
		if (periodoLetivo != null && periodoLetivo != 0) {
			sqlStr += " AND periodoletivo.periodoletivo = " + periodoLetivo;
		}
		if (turma != null && turma != 0) {
			sqlStr += " AND matriculaperiodo.turma = " + turma;
		}
		sqlStr += " ORDER BY periodoletivo.periodoletivo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List<Integer> listaInteiros = new ArrayList<Integer>(0);
		while (tabelaResultado.next()) {
			listaInteiros.add(tabelaResultado.getInt("periodoletivo"));
		}

		return listaInteiros;
	}

	public List<HistoricoVO> consultaRapidaPorMatriculaPeriodo(Integer matriculaPeriodo, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (matriculaPeriodo.codigo = ").append(matriculaPeriodo).append(") ");
		sqlStr.append(" ORDER BY matriculaperiodoturmadisciplina.codigo");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaCompleta(tabelaResultado, usuario);
	}

	public List<HistoricoVO> consultarPorMatriculaPeriodo(Integer matriculaPeriodo, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT historico.* FROM historico " + "WHERE historico.matriculaperiodo = '" + matriculaPeriodo + "' ORDER BY historico.matriculaperiodoturmadisciplina;";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List consultarPorMatriculaPeriodoSituacao(Integer matriculaPeriodo, String situacao, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" SELECT historico.* FROM historico ");
		sqlStr.append(" WHERE historico.matriculaperiodo = '").append(matriculaPeriodo).append("' AND");
		sqlStr.append(" historico.situacao like '").append(situacao.toUpperCase()).append("%'");
		sqlStr.append(" ORDER BY historico.matriculaperiodoturmadisciplina;");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	/**
	 * Responsável por montar os dados de vários objetos, resultantes de uma
	 * consulta ao banco de dados (<code>ResultSet</code>). Faz uso da operação
	 * <code>montarDados</code> que realiza o trabalho para um objeto por vez.
	 *
	 * @return List Contendo vários objetos da classe <code>HistoricoVO</code>
	 *         resultantes da consulta.
	 */
	public static List<HistoricoVO> montarDadosConsulta(SqlRowSet tabelaResultado, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			vetResultado.add(montarDados(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
		}
		return vetResultado;
	}

	public static List<HistoricoVO> montarDadosConsultaComGradeDisciplina(SqlRowSet tabelaResultado, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			vetResultado.add(montarDadosComGradeDisciplina(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
		}
		return vetResultado;
	}

	public static List<HistoricoVO> montarDadosConsultaBoletim(SqlRowSet tabelaResultado, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			vetResultado.add(montarDadosBoletim(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
		}
		return vetResultado;
	}

	public static HistoricoVO montarDadosComGradeDisciplina(SqlRowSet dadosSQL, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		HistoricoVO obj = new HistoricoVO();
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina")));
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula"));
		obj.setInstituicao(dadosSQL.getString("instituicao"));
		obj.setTipoHistorico(dadosSQL.getString("tipoHistorico"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setAnoHistorico(dadosSQL.getString("anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestreHistorico"));
		obj.setCargaHorariaAproveitamentoDisciplina(dadosSQL.getInt("cargaHorariaAproveitamentoDisciplina"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaCursada"));
		obj.getCidadeVO().setCodigo(dadosSQL.getInt("cidade"));
		obj.setFreguencia(new Double(dadosSQL.getDouble("freguencia")));
		obj.getResponsavel().setCodigo(new Integer(dadosSQL.getInt("responsavel")));
		obj.setDataRegistro(dadosSQL.getDate("dataRegistro"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("utilizaNotaFinalConceito"));
		obj.setNotaFinalConceito(dadosSQL.getString("notaFinalConceito"));
		obj.getPeriodoLetivoCursada().setCodigo(dadosSQL.getInt("periodoletivocursada"));
		obj.getGradeDisciplinaVO().setCodigo(dadosSQL.getInt("gradedisciplina"));
		obj.setNumeroAgrupamentoEquivalenciaDisciplina(dadosSQL.getInt("numeroAgrupamentoEquivalenciaDisciplina"));
		obj.setCargaHorariaDisciplina(dadosSQL.getInt("cargaHorariaDisciplinaFinal"));
		obj.getMapaEquivalenciaDisciplina().setCodigo(dadosSQL.getInt("mapaequivalenciadisciplina"));
		obj.setHistoricoPorEquivalencia(dadosSQL.getBoolean("historicoporequivalencia"));
		obj.getMatrizCurricular().setCodigo(dadosSQL.getInt("matrizcurricular"));
		if(Uteis.isAtributoPreenchido(dadosSQL.getInt("periodoletivo.periodoletivo"))) {
			obj.getPeriodoLetivoCursada().setPeriodoLetivo(dadosSQL.getInt("periodoletivo.periodoletivo"));
		}
		obj.setDataInicioAula(dadosSQL.getDate("historico.dataInicioAula"));
		obj.setDataFimAula(dadosSQL.getDate("historico.dataFimAula"));


		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_PROCESSAMENTO) {
			return obj;
		}
		obj.setHistoricoCriterioAvaliacaoAluno(dadosSQL.getBoolean("historicoCriterioAvaliacaoAluno"));
		obj.getCriterioAvaliacao().setCodigo(dadosSQL.getInt("criterioAvaliacao"));

		if (dadosSQL.getObject("nota1") == null) {
			obj.setNota1((Double) dadosSQL.getObject("nota1"));
		} else {
			obj.setNota1(dadosSQL.getDouble("nota1"));
		}
		if (dadosSQL.getObject("nota2") == null) {
			obj.setNota2((Double) dadosSQL.getObject("nota2"));
		} else {
			obj.setNota2(dadosSQL.getDouble("nota2"));
		}
		if (dadosSQL.getObject("nota3") == null) {
			obj.setNota3((Double) dadosSQL.getObject("nota3"));
		} else {
			obj.setNota3(dadosSQL.getDouble("nota3"));
		}
		if (dadosSQL.getObject("nota4") == null) {
			obj.setNota4((Double) dadosSQL.getObject("nota4"));
		} else {
			obj.setNota4(dadosSQL.getDouble("nota4"));
		}
		if (dadosSQL.getObject("nota5") == null) {
			obj.setNota5((Double) dadosSQL.getObject("nota5"));
		} else {
			obj.setNota5(dadosSQL.getDouble("nota5"));
		}
		if (dadosSQL.getObject("nota6") == null) {
			obj.setNota6((Double) dadosSQL.getObject("nota6"));
		} else {
			obj.setNota6(dadosSQL.getDouble("nota6"));
		}
		if (dadosSQL.getObject("nota7") == null) {
			obj.setNota7((Double) dadosSQL.getObject("nota7"));
		} else {
			obj.setNota7(dadosSQL.getDouble("nota7"));
		}
		if (dadosSQL.getObject("nota8") == null) {
			obj.setNota8((Double) dadosSQL.getObject("nota8"));
		} else {
			obj.setNota8(dadosSQL.getDouble("nota8"));
		}
		if (dadosSQL.getObject("nota9") == null) {
			obj.setNota9((Double) dadosSQL.getObject("nota9"));
		} else {
			obj.setNota9(dadosSQL.getDouble("nota9"));
		}
		if (dadosSQL.getObject("nota10") == null) {
			obj.setNota10((Double) dadosSQL.getObject("nota10"));
		} else {
			obj.setNota10(dadosSQL.getDouble("nota10"));
		}
		if (dadosSQL.getObject("nota11") == null) {
			obj.setNota11((Double) dadosSQL.getObject("nota11"));
		} else {
			obj.setNota11(dadosSQL.getDouble("nota11"));
		}
		if (dadosSQL.getObject("nota12") == null) {
			obj.setNota12((Double) dadosSQL.getObject("nota12"));
		} else {
			obj.setNota12(dadosSQL.getDouble("nota12"));
		}
		if (dadosSQL.getObject("nota13") == null) {
			obj.setNota13((Double) dadosSQL.getObject("nota13"));
		} else {
			obj.setNota13(dadosSQL.getDouble("nota13"));
		}
		obj.setNota1Lancada(dadosSQL.getBoolean("nota1Lancada"));
		obj.setNota2Lancada(dadosSQL.getBoolean("nota2Lancada"));
		obj.setNota3Lancada(dadosSQL.getBoolean("nota3Lancada"));
		obj.setNota4Lancada(dadosSQL.getBoolean("nota4Lancada"));
		obj.setNota5Lancada(dadosSQL.getBoolean("nota5Lancada"));
		obj.setNota6Lancada(dadosSQL.getBoolean("nota6Lancada"));
		obj.setNota7Lancada(dadosSQL.getBoolean("nota7Lancada"));
		obj.setNota8Lancada(dadosSQL.getBoolean("nota8Lancada"));
		obj.setNota9Lancada(dadosSQL.getBoolean("nota9Lancada"));
		obj.setNota10Lancada(dadosSQL.getBoolean("nota10Lancada"));
		obj.setNota11Lancada(dadosSQL.getBoolean("nota11Lancada"));
		obj.setNota12Lancada(dadosSQL.getBoolean("nota12Lancada"));
		obj.setNota13Lancada(dadosSQL.getBoolean("nota13Lancada"));
		obj.setNota13Lancada(dadosSQL.getBoolean("nota13Lancada"));
		obj.setUpdated(dadosSQL.getTimestamp("updated"));
		obj.getNota1Conceito().setCodigo(dadosSQL.getInt("nota1Conceito"));
		obj.getNota2Conceito().setCodigo(dadosSQL.getInt("nota2Conceito"));
		obj.getNota3Conceito().setCodigo(dadosSQL.getInt("nota3Conceito"));
		obj.getNota4Conceito().setCodigo(dadosSQL.getInt("nota4Conceito"));
		obj.getNota5Conceito().setCodigo(dadosSQL.getInt("nota5Conceito"));
		obj.getNota6Conceito().setCodigo(dadosSQL.getInt("nota6Conceito"));
		obj.getNota7Conceito().setCodigo(dadosSQL.getInt("nota7Conceito"));
		obj.getNota8Conceito().setCodigo(dadosSQL.getInt("nota8Conceito"));
		obj.getNota9Conceito().setCodigo(dadosSQL.getInt("nota9Conceito"));
		obj.getNota10Conceito().setCodigo(dadosSQL.getInt("nota10Conceito"));
		obj.getNota11Conceito().setCodigo(dadosSQL.getInt("nota11Conceito"));
		obj.getNota12Conceito().setCodigo(dadosSQL.getInt("nota12Conceito"));
		obj.getNota13Conceito().setCodigo(dadosSQL.getInt("nota13Conceito"));

		if (dadosSQL.getObject("nota14") == null) {
			obj.setNota14((Double) dadosSQL.getObject("nota14"));
		} else {
			obj.setNota14(dadosSQL.getDouble("nota14"));
		}
		obj.setNota14Lancada(dadosSQL.getBoolean("nota14Lancada"));
		obj.getNota14Conceito().setCodigo(dadosSQL.getInt("nota14Conceito"));

		if (dadosSQL.getObject("nota15") == null) {
			obj.setNota15((Double) dadosSQL.getObject("nota15"));
		} else {
			obj.setNota15(dadosSQL.getDouble("nota15"));
		}
		obj.setNota15Lancada(dadosSQL.getBoolean("nota15Lancada"));
		obj.getNota15Conceito().setCodigo(dadosSQL.getInt("nota15Conceito"));

		if (dadosSQL.getObject("nota16") == null) {
			obj.setNota16((Double) dadosSQL.getObject("nota16"));
		} else {
			obj.setNota16(dadosSQL.getDouble("nota16"));
		}
		obj.setNota16Lancada(dadosSQL.getBoolean("nota16Lancada"));
		obj.getNota16Conceito().setCodigo(dadosSQL.getInt("nota16Conceito"));

		if (dadosSQL.getObject("nota17") == null) {
			obj.setNota17((Double) dadosSQL.getObject("nota17"));
		} else {
			obj.setNota17(dadosSQL.getDouble("nota17"));
		}
		obj.setNota17Lancada(dadosSQL.getBoolean("nota17Lancada"));
		obj.getNota17Conceito().setCodigo(dadosSQL.getInt("nota17Conceito"));

		if (dadosSQL.getObject("nota18") == null) {
			obj.setNota18((Double) dadosSQL.getObject("nota18"));
		} else {
			obj.setNota18(dadosSQL.getDouble("nota18"));
		}
		obj.setNota18Lancada(dadosSQL.getBoolean("nota18Lancada"));
		obj.getNota18Conceito().setCodigo(dadosSQL.getInt("nota18Conceito"));

		if (dadosSQL.getObject("nota19") == null) {
			obj.setNota19((Double) dadosSQL.getObject("nota19"));
		} else {
			obj.setNota19(dadosSQL.getDouble("nota19"));
		}
		obj.setNota19Lancada(dadosSQL.getBoolean("nota19Lancada"));
		obj.getNota19Conceito().setCodigo(dadosSQL.getInt("nota19Conceito"));

		if (dadosSQL.getObject("nota20") == null) {
			obj.setNota20((Double) dadosSQL.getObject("nota20"));
		} else {
			obj.setNota20(dadosSQL.getDouble("nota20"));
		}
		obj.setNota20Lancada(dadosSQL.getBoolean("nota20Lancada"));
		obj.getNota20Conceito().setCodigo(dadosSQL.getInt("nota20Conceito"));

		if (dadosSQL.getObject("nota21") == null) {
			obj.setNota21((Double) dadosSQL.getObject("nota21"));
		} else {
			obj.setNota21(dadosSQL.getDouble("nota21"));
		}
		obj.setNota21Lancada(dadosSQL.getBoolean("nota21Lancada"));
		obj.getNota21Conceito().setCodigo(dadosSQL.getInt("nota21Conceito"));

		if (dadosSQL.getObject("nota22") == null) {
			obj.setNota22((Double) dadosSQL.getObject("nota22"));
		} else {
			obj.setNota22(dadosSQL.getDouble("nota22"));
		}
		obj.setNota22Lancada(dadosSQL.getBoolean("nota22Lancada"));
		obj.getNota22Conceito().setCodigo(dadosSQL.getInt("nota22Conceito"));

		if (dadosSQL.getObject("nota23") == null) {
			obj.setNota23((Double) dadosSQL.getObject("nota23"));
		} else {
			obj.setNota23(dadosSQL.getDouble("nota23"));
		}
		obj.setNota23Lancada(dadosSQL.getBoolean("nota23Lancada"));
		obj.getNota23Conceito().setCodigo(dadosSQL.getInt("nota23Conceito"));

		if (dadosSQL.getObject("nota24") == null) {
			obj.setNota24((Double) dadosSQL.getObject("nota24"));
		} else {
			obj.setNota24(dadosSQL.getDouble("nota24"));
		}
		obj.setNota24Lancada(dadosSQL.getBoolean("nota24Lancada"));
		obj.getNota24Conceito().setCodigo(dadosSQL.getInt("nota24Conceito"));

		if (dadosSQL.getObject("nota25") == null) {
			obj.setNota25((Double) dadosSQL.getObject("nota25"));
		} else {
			obj.setNota25(dadosSQL.getDouble("nota25"));
		}
		obj.setNota25Lancada(dadosSQL.getBoolean("nota25Lancada"));
		obj.getNota25Conceito().setCodigo(dadosSQL.getInt("nota25Conceito"));

		if (dadosSQL.getObject("nota26") == null) {
			obj.setNota26((Double) dadosSQL.getObject("nota26"));
		} else {
			obj.setNota26(dadosSQL.getDouble("nota26"));
		}
		obj.setNota26Lancada(dadosSQL.getBoolean("nota26Lancada"));
		obj.getNota26Conceito().setCodigo(dadosSQL.getInt("nota26Conceito"));

		if (dadosSQL.getObject("nota27") == null) {
			obj.setNota27((Double) dadosSQL.getObject("nota27"));
		} else {
			obj.setNota27(dadosSQL.getDouble("nota27"));
		}
		obj.setNota27Lancada(dadosSQL.getBoolean("nota27Lancada"));
		obj.getNota27Conceito().setCodigo(dadosSQL.getInt("nota27Conceito"));

		if (dadosSQL.getObject("nota28") == null) {
			obj.setNota28((Double) dadosSQL.getObject("nota28"));
		} else {
			obj.setNota28(dadosSQL.getDouble("nota28"));
		}
		obj.setNota28Lancada(dadosSQL.getBoolean("nota28Lancada"));
		obj.getNota28Conceito().setCodigo(dadosSQL.getInt("nota28Conceito"));

		if (dadosSQL.getObject("nota29") == null) {
			obj.setNota29((Double) dadosSQL.getObject("nota29"));
		} else {
			obj.setNota29(dadosSQL.getDouble("nota29"));
		}
		obj.setNota29Lancada(dadosSQL.getBoolean("nota29Lancada"));
		obj.getNota29Conceito().setCodigo(dadosSQL.getInt("nota29Conceito"));

		if (dadosSQL.getObject("nota30") == null) {
			obj.setNota30((Double) dadosSQL.getObject("nota30"));
		} else {
			obj.setNota30(dadosSQL.getDouble("nota30"));
		}
		obj.setNota30Lancada(dadosSQL.getBoolean("nota30Lancada"));
		obj.getNota30Conceito().setCodigo(dadosSQL.getInt("nota30Conceito"));

		if (dadosSQL.getObject("nota31") == null) {
			obj.setNota31((Double) dadosSQL.getObject("nota31"));
		} else {
			obj.setNota31(dadosSQL.getDouble("nota31"));
		}
		obj.setNota31Lancada(dadosSQL.getBoolean("nota31Lancada"));
		obj.getNota31Conceito().setCodigo(dadosSQL.getInt("nota31Conceito"));

		if (dadosSQL.getObject("nota32") == null) {
			obj.setNota32((Double) dadosSQL.getObject("nota32"));
		} else {
			obj.setNota32(dadosSQL.getDouble("nota32"));
		}
		obj.setNota32Lancada(dadosSQL.getBoolean("nota32Lancada"));
		obj.getNota32Conceito().setCodigo(dadosSQL.getInt("nota32Conceito"));

		if (dadosSQL.getObject("nota33") == null) {
			obj.setNota33((Double) dadosSQL.getObject("nota33"));
		} else {
			obj.setNota33(dadosSQL.getDouble("nota33"));
		}
		obj.setNota33Lancada(dadosSQL.getBoolean("nota33Lancada"));
		obj.getNota33Conceito().setCodigo(dadosSQL.getInt("nota33Conceito"));

		if (dadosSQL.getObject("nota34") == null) {
			obj.setNota34((Double) dadosSQL.getObject("nota34"));
		} else {
			obj.setNota34(dadosSQL.getDouble("nota34"));
		}
		obj.setNota34Lancada(dadosSQL.getBoolean("nota34Lancada"));
		obj.getNota34Conceito().setCodigo(dadosSQL.getInt("nota34Conceito"));

		if (dadosSQL.getObject("nota35") == null) {
			obj.setNota35((Double) dadosSQL.getObject("nota35"));
		} else {
			obj.setNota35(dadosSQL.getDouble("nota35"));
		}
		obj.setNota35Lancada(dadosSQL.getBoolean("nota35Lancada"));
		obj.getNota35Conceito().setCodigo(dadosSQL.getInt("nota35Conceito"));

		if (dadosSQL.getObject("nota36") == null) {
			obj.setNota36((Double) dadosSQL.getObject("nota36"));
		} else {
			obj.setNota36(dadosSQL.getDouble("nota36"));
		}
		obj.setNota36Lancada(dadosSQL.getBoolean("nota36Lancada"));
		obj.getNota36Conceito().setCodigo(dadosSQL.getInt("nota36Conceito"));

		if (dadosSQL.getObject("nota37") == null) {
			obj.setNota37((Double) dadosSQL.getObject("nota37"));
		} else {
			obj.setNota37(dadosSQL.getDouble("nota37"));
		}
		obj.setNota37Lancada(dadosSQL.getBoolean("nota37Lancada"));
		obj.getNota37Conceito().setCodigo(dadosSQL.getInt("nota37Conceito"));

		if (dadosSQL.getObject("nota38") == null) {
			obj.setNota38((Double) dadosSQL.getObject("nota38"));
		} else {
			obj.setNota38(dadosSQL.getDouble("nota38"));
		}
		obj.setNota38Lancada(dadosSQL.getBoolean("nota38Lancada"));
		obj.getNota38Conceito().setCodigo(dadosSQL.getInt("nota38Conceito"));

		if (dadosSQL.getObject("nota39") == null) {
			obj.setNota39((Double) dadosSQL.getObject("nota39"));
		} else {
			obj.setNota39(dadosSQL.getDouble("nota39"));
		}
		obj.setNota39Lancada(dadosSQL.getBoolean("nota39Lancada"));
		obj.getNota39Conceito().setCodigo(dadosSQL.getInt("nota39Conceito"));

		if (dadosSQL.getObject("nota40") == null) {
			obj.setNota40((Double) dadosSQL.getObject("nota40"));
		} else {
			obj.setNota40(dadosSQL.getDouble("nota40"));
		}
		obj.setNota40Lancada(dadosSQL.getBoolean("nota40Lancada"));
		obj.getNota40Conceito().setCodigo(dadosSQL.getInt("nota40Conceito"));
		obj.setApresentarAprovadoHistorico(dadosSQL.getBoolean("apresentarAprovadoHistorico"));
		obj.getMediaFinalConceito().setCodigo(dadosSQL.getInt("mediaFinalConceito"));

		obj.getMatriculaPeriodo().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodo")));
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina")));
		if (dadosSQL.getObject("mediaFinal") == null) {
			obj.setMediaFinal((Double) dadosSQL.getObject("mediaFinal"));
		} else {
			obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		}
		// obj.setMediaFinal(new Double(dadosSQL.getDouble("mediaFinal")));
		// obj.setCargaHoraria(new Double(dadosSQL.getDouble("cargaHoraria")));
		obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("configuracaoAcademico"));
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_DADOSMINIMOS) {
			montarDadosDisciplina(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			getFacadeFactory().getMatriculaFacade().carregarDados(obj.getMatricula(), usuario);
			return obj;
		}
		obj.setTransferenciaEntradaDisciplinasAproveitadas(new Integer(dadosSQL.getInt("transferenciaEntradaDisciplinasAproveitadas")));
		obj.setNovoObj(Boolean.FALSE);
		montarDadosMatriculaPeriodoTurmaDisciplina(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosDisciplina(obj, nivelMontarDados, usuario);
		// //////////////////////////
		montarDadosMatriculaPeriodo(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		// /////////////////////////
		montarDadosConfiguracaoAcademico(obj, usuario);
		obj.setNota1Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota1Conceito")));
		obj.setNota2Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota2Conceito")));
		obj.setNota3Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota3Conceito")));
		obj.setNota4Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota4Conceito")));
		obj.setNota5Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota5Conceito")));
		obj.setNota6Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota6Conceito")));
		obj.setNota7Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota7Conceito")));
		obj.setNota8Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota8Conceito")));
		obj.setNota9Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota9Conceito")));
		obj.setNota10Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota10Conceito")));
		obj.setNota11Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota11Conceito")));
		obj.setNota12Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota12Conceito")));
		obj.setNota13Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota13Conceito")));
		obj.setNota14Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota14Conceito")));
		obj.setNota15Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota15Conceito")));
		obj.setNota16Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota16Conceito")));
		obj.setNota17Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota17Conceito")));
		obj.setNota18Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota18Conceito")));
		obj.setNota19Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota19Conceito")));
		obj.setNota20Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota20Conceito")));
		obj.setNota21Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota21Conceito")));
		obj.setNota22Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota22Conceito")));
		obj.setNota23Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota23Conceito")));
		obj.setNota24Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota24Conceito")));
		obj.setNota25Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota25Conceito")));
		obj.setNota26Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota26Conceito")));
		obj.setNota27Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota27Conceito")));
		obj.setNota28Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota28Conceito")));
		obj.setNota29Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota29Conceito")));
		obj.setNota30Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota30Conceito")));

		obj.setNota31Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota31Conceito")));
		obj.setNota32Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota32Conceito")));
		obj.setNota33Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota33Conceito")));
		obj.setNota34Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota34Conceito")));
		obj.setNota35Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota35Conceito")));
		obj.setNota36Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota36Conceito")));
		obj.setNota37Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota37Conceito")));
		obj.setNota38Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota38Conceito")));
		obj.setNota39Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota39Conceito")));
		obj.setNota40Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota40Conceito")));


		obj.setMediaFinalConceito(montarDadosNotaConceito(dadosSQL.getInt("mediaFinalConceito")));
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_DADOSBASICOS) {
			return obj;
		}

		montarDadosDisciplina(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosGradeDisciplina(obj, usuario);
		montarDadosMatricula(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosResponsavel(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));
		return obj;
	}

	/**
	 * @deprecated Desde a versao 5.0 - utilizar o método carregarDados e seus
	 *             dois tipos de montar dados
	 */
	public static HistoricoVO montarDados(SqlRowSet dadosSQL, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		HistoricoVO obj = new HistoricoVO();
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina")));
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula"));
		obj.setInstituicao(dadosSQL.getString("instituicao"));
		obj.setTipoHistorico(dadosSQL.getString("tipoHistorico"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setAnoHistorico(dadosSQL.getString("anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestreHistorico"));
		obj.setCargaHorariaAproveitamentoDisciplina(dadosSQL.getInt("cargaHorariaAproveitamentoDisciplina"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaCursada"));
		obj.getCidadeVO().setCodigo(dadosSQL.getInt("cidade"));
		obj.setFreguencia(new Double(dadosSQL.getDouble("freguencia")));
		obj.getResponsavel().setCodigo(new Integer(dadosSQL.getInt("responsavel")));
		obj.setDataRegistro(dadosSQL.getDate("dataRegistro"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("utilizaNotaFinalConceito"));
		obj.setNotaFinalConceito(dadosSQL.getString("notaFinalConceito"));
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_PROCESSAMENTO) {
			return obj;
		}
		obj.setHistoricoCriterioAvaliacaoAluno(dadosSQL.getBoolean("historicoCriterioAvaliacaoAluno"));
		obj.getCriterioAvaliacao().setCodigo(dadosSQL.getInt("criterioAvaliacao"));
		if (dadosSQL.getObject("nota1") == null) {
			obj.setNota1((Double) dadosSQL.getObject("nota1"));
		} else {
			obj.setNota1(dadosSQL.getDouble("nota1"));
		}
		if (dadosSQL.getObject("nota2") == null) {
			obj.setNota2((Double) dadosSQL.getObject("nota2"));
		} else {
			obj.setNota2(dadosSQL.getDouble("nota2"));
		}
		if (dadosSQL.getObject("nota3") == null) {
			obj.setNota3((Double) dadosSQL.getObject("nota3"));
		} else {
			obj.setNota3(dadosSQL.getDouble("nota3"));
		}
		if (dadosSQL.getObject("nota4") == null) {
			obj.setNota4((Double) dadosSQL.getObject("nota4"));
		} else {
			obj.setNota4(dadosSQL.getDouble("nota4"));
		}
		if (dadosSQL.getObject("nota5") == null) {
			obj.setNota5((Double) dadosSQL.getObject("nota5"));
		} else {
			obj.setNota5(dadosSQL.getDouble("nota5"));
		}
		if (dadosSQL.getObject("nota6") == null) {
			obj.setNota6((Double) dadosSQL.getObject("nota6"));
		} else {
			obj.setNota6(dadosSQL.getDouble("nota6"));
		}
		if (dadosSQL.getObject("nota7") == null) {
			obj.setNota7((Double) dadosSQL.getObject("nota7"));
		} else {
			obj.setNota7(dadosSQL.getDouble("nota7"));
		}
		if (dadosSQL.getObject("nota8") == null) {
			obj.setNota8((Double) dadosSQL.getObject("nota8"));
		} else {
			obj.setNota8(dadosSQL.getDouble("nota8"));
		}
		if (dadosSQL.getObject("nota9") == null) {
			obj.setNota9((Double) dadosSQL.getObject("nota9"));
		} else {
			obj.setNota9(dadosSQL.getDouble("nota9"));
		}
		if (dadosSQL.getObject("nota10") == null) {
			obj.setNota10((Double) dadosSQL.getObject("nota10"));
		} else {
			obj.setNota10(dadosSQL.getDouble("nota10"));
		}
		if (dadosSQL.getObject("nota11") == null) {
			obj.setNota11((Double) dadosSQL.getObject("nota11"));
		} else {
			obj.setNota11(dadosSQL.getDouble("nota11"));
		}
		if (dadosSQL.getObject("nota12") == null) {
			obj.setNota12((Double) dadosSQL.getObject("nota12"));
		} else {
			obj.setNota12(dadosSQL.getDouble("nota12"));
		}
		if (dadosSQL.getObject("nota13") == null) {
			obj.setNota13((Double) dadosSQL.getObject("nota13"));
		} else {
			obj.setNota13(dadosSQL.getDouble("nota13"));
		}
		obj.setNota1Lancada(dadosSQL.getBoolean("nota1Lancada"));
		obj.setNota2Lancada(dadosSQL.getBoolean("nota2Lancada"));
		obj.setNota3Lancada(dadosSQL.getBoolean("nota3Lancada"));
		obj.setNota4Lancada(dadosSQL.getBoolean("nota4Lancada"));
		obj.setNota5Lancada(dadosSQL.getBoolean("nota5Lancada"));
		obj.setNota6Lancada(dadosSQL.getBoolean("nota6Lancada"));
		obj.setNota7Lancada(dadosSQL.getBoolean("nota7Lancada"));
		obj.setNota8Lancada(dadosSQL.getBoolean("nota8Lancada"));
		obj.setNota9Lancada(dadosSQL.getBoolean("nota9Lancada"));
		obj.setNota10Lancada(dadosSQL.getBoolean("nota10Lancada"));
		obj.setNota11Lancada(dadosSQL.getBoolean("nota11Lancada"));
		obj.setNota12Lancada(dadosSQL.getBoolean("nota12Lancada"));
		obj.setNota13Lancada(dadosSQL.getBoolean("nota13Lancada"));
		obj.setNota13Lancada(dadosSQL.getBoolean("nota13Lancada"));
		obj.setUpdated(dadosSQL.getTimestamp("updated"));
		obj.getNota1Conceito().setCodigo(dadosSQL.getInt("nota1Conceito"));
		obj.getNota2Conceito().setCodigo(dadosSQL.getInt("nota2Conceito"));
		obj.getNota3Conceito().setCodigo(dadosSQL.getInt("nota3Conceito"));
		obj.getNota4Conceito().setCodigo(dadosSQL.getInt("nota4Conceito"));
		obj.getNota5Conceito().setCodigo(dadosSQL.getInt("nota5Conceito"));
		obj.getNota6Conceito().setCodigo(dadosSQL.getInt("nota6Conceito"));
		obj.getNota7Conceito().setCodigo(dadosSQL.getInt("nota7Conceito"));
		obj.getNota8Conceito().setCodigo(dadosSQL.getInt("nota8Conceito"));
		obj.getNota9Conceito().setCodigo(dadosSQL.getInt("nota9Conceito"));
		obj.getNota10Conceito().setCodigo(dadosSQL.getInt("nota10Conceito"));
		obj.getNota11Conceito().setCodigo(dadosSQL.getInt("nota11Conceito"));
		obj.getNota12Conceito().setCodigo(dadosSQL.getInt("nota12Conceito"));
		obj.getNota13Conceito().setCodigo(dadosSQL.getInt("nota13Conceito"));

		if (dadosSQL.getObject("nota14") == null) {
			obj.setNota14((Double) dadosSQL.getObject("nota14"));
		} else {
			obj.setNota14(dadosSQL.getDouble("nota14"));
		}
		obj.setNota14Lancada(dadosSQL.getBoolean("nota14Lancada"));
		obj.getNota14Conceito().setCodigo(dadosSQL.getInt("nota14Conceito"));

		if (dadosSQL.getObject("nota15") == null) {
			obj.setNota15((Double) dadosSQL.getObject("nota15"));
		} else {
			obj.setNota15(dadosSQL.getDouble("nota15"));
		}
		obj.setNota15Lancada(dadosSQL.getBoolean("nota15Lancada"));
		obj.getNota15Conceito().setCodigo(dadosSQL.getInt("nota15Conceito"));

		if (dadosSQL.getObject("nota16") == null) {
			obj.setNota16((Double) dadosSQL.getObject("nota16"));
		} else {
			obj.setNota16(dadosSQL.getDouble("nota16"));
		}
		obj.setNota16Lancada(dadosSQL.getBoolean("nota16Lancada"));
		obj.getNota16Conceito().setCodigo(dadosSQL.getInt("nota16Conceito"));

		if (dadosSQL.getObject("nota17") == null) {
			obj.setNota17((Double) dadosSQL.getObject("nota17"));
		} else {
			obj.setNota17(dadosSQL.getDouble("nota17"));
		}
		obj.setNota17Lancada(dadosSQL.getBoolean("nota17Lancada"));
		obj.getNota17Conceito().setCodigo(dadosSQL.getInt("nota17Conceito"));

		if (dadosSQL.getObject("nota18") == null) {
			obj.setNota18((Double) dadosSQL.getObject("nota18"));
		} else {
			obj.setNota18(dadosSQL.getDouble("nota18"));
		}
		obj.setNota18Lancada(dadosSQL.getBoolean("nota18Lancada"));
		obj.getNota18Conceito().setCodigo(dadosSQL.getInt("nota18Conceito"));

		if (dadosSQL.getObject("nota19") == null) {
			obj.setNota19((Double) dadosSQL.getObject("nota19"));
		} else {
			obj.setNota19(dadosSQL.getDouble("nota19"));
		}
		obj.setNota19Lancada(dadosSQL.getBoolean("nota19Lancada"));
		obj.getNota19Conceito().setCodigo(dadosSQL.getInt("nota19Conceito"));

		if (dadosSQL.getObject("nota20") == null) {
			obj.setNota20((Double) dadosSQL.getObject("nota20"));
		} else {
			obj.setNota20(dadosSQL.getDouble("nota20"));
		}
		obj.setNota20Lancada(dadosSQL.getBoolean("nota20Lancada"));
		obj.getNota20Conceito().setCodigo(dadosSQL.getInt("nota20Conceito"));

		if (dadosSQL.getObject("nota21") == null) {
			obj.setNota21((Double) dadosSQL.getObject("nota21"));
		} else {
			obj.setNota21(dadosSQL.getDouble("nota21"));
		}
		obj.setNota21Lancada(dadosSQL.getBoolean("nota21Lancada"));
		obj.getNota21Conceito().setCodigo(dadosSQL.getInt("nota21Conceito"));

		if (dadosSQL.getObject("nota22") == null) {
			obj.setNota22((Double) dadosSQL.getObject("nota22"));
		} else {
			obj.setNota22(dadosSQL.getDouble("nota22"));
		}
		obj.setNota22Lancada(dadosSQL.getBoolean("nota22Lancada"));
		obj.getNota22Conceito().setCodigo(dadosSQL.getInt("nota22Conceito"));

		if (dadosSQL.getObject("nota23") == null) {
			obj.setNota23((Double) dadosSQL.getObject("nota23"));
		} else {
			obj.setNota23(dadosSQL.getDouble("nota23"));
		}
		obj.setNota23Lancada(dadosSQL.getBoolean("nota23Lancada"));
		obj.getNota23Conceito().setCodigo(dadosSQL.getInt("nota23Conceito"));

		if (dadosSQL.getObject("nota24") == null) {
			obj.setNota24((Double) dadosSQL.getObject("nota24"));
		} else {
			obj.setNota24(dadosSQL.getDouble("nota24"));
		}
		obj.setNota24Lancada(dadosSQL.getBoolean("nota24Lancada"));
		obj.getNota24Conceito().setCodigo(dadosSQL.getInt("nota24Conceito"));

		if (dadosSQL.getObject("nota25") == null) {
			obj.setNota25((Double) dadosSQL.getObject("nota25"));
		} else {
			obj.setNota25(dadosSQL.getDouble("nota25"));
		}
		obj.setNota25Lancada(dadosSQL.getBoolean("nota25Lancada"));
		obj.getNota25Conceito().setCodigo(dadosSQL.getInt("nota25Conceito"));

		if (dadosSQL.getObject("nota26") == null) {
			obj.setNota26((Double) dadosSQL.getObject("nota26"));
		} else {
			obj.setNota26(dadosSQL.getDouble("nota26"));
		}
		obj.setNota26Lancada(dadosSQL.getBoolean("nota26Lancada"));
		obj.getNota26Conceito().setCodigo(dadosSQL.getInt("nota26Conceito"));

		if (dadosSQL.getObject("nota27") == null) {
			obj.setNota27((Double) dadosSQL.getObject("nota27"));
		} else {
			obj.setNota27(dadosSQL.getDouble("nota27"));
		}
		obj.setNota27Lancada(dadosSQL.getBoolean("nota27Lancada"));
		obj.getNota27Conceito().setCodigo(dadosSQL.getInt("nota27Conceito"));

		if (dadosSQL.getObject("nota28") == null) {
			obj.setNota28((Double) dadosSQL.getObject("nota28"));
		} else {
			obj.setNota28(dadosSQL.getDouble("nota28"));
		}
		obj.setNota28Lancada(dadosSQL.getBoolean("nota28Lancada"));
		obj.getNota28Conceito().setCodigo(dadosSQL.getInt("nota28Conceito"));

		if (dadosSQL.getObject("nota29") == null) {
			obj.setNota29((Double) dadosSQL.getObject("nota29"));
		} else {
			obj.setNota29(dadosSQL.getDouble("nota29"));
		}
		obj.setNota29Lancada(dadosSQL.getBoolean("nota29Lancada"));
		obj.getNota29Conceito().setCodigo(dadosSQL.getInt("nota29Conceito"));

		if (dadosSQL.getObject("nota30") == null) {
			obj.setNota30((Double) dadosSQL.getObject("nota30"));
		} else {
			obj.setNota30(dadosSQL.getDouble("nota30"));
		}
		obj.setNota30Lancada(dadosSQL.getBoolean("nota30Lancada"));
		obj.getNota30Conceito().setCodigo(dadosSQL.getInt("nota30Conceito"));

		if (dadosSQL.getObject("nota31") == null) {
			obj.setNota31((Double) dadosSQL.getObject("nota31"));
		} else {
			obj.setNota31(dadosSQL.getDouble("nota31"));
		}
		obj.setNota31Lancada(dadosSQL.getBoolean("nota31Lancada"));
		obj.getNota31Conceito().setCodigo(dadosSQL.getInt("nota31Conceito"));

		if (dadosSQL.getObject("nota32") == null) {
			obj.setNota32((Double) dadosSQL.getObject("nota32"));
		} else {
			obj.setNota32(dadosSQL.getDouble("nota32"));
		}
		obj.setNota32Lancada(dadosSQL.getBoolean("nota32Lancada"));
		obj.getNota32Conceito().setCodigo(dadosSQL.getInt("nota32Conceito"));

		if (dadosSQL.getObject("nota33") == null) {
			obj.setNota33((Double) dadosSQL.getObject("nota33"));
		} else {
			obj.setNota33(dadosSQL.getDouble("nota33"));
		}
		obj.setNota33Lancada(dadosSQL.getBoolean("nota33Lancada"));
		obj.getNota33Conceito().setCodigo(dadosSQL.getInt("nota33Conceito"));

		if (dadosSQL.getObject("nota34") == null) {
			obj.setNota34((Double) dadosSQL.getObject("nota34"));
		} else {
			obj.setNota34(dadosSQL.getDouble("nota34"));
		}
		obj.setNota34Lancada(dadosSQL.getBoolean("nota34Lancada"));
		obj.getNota34Conceito().setCodigo(dadosSQL.getInt("nota34Conceito"));

		if (dadosSQL.getObject("nota35") == null) {
			obj.setNota35((Double) dadosSQL.getObject("nota35"));
		} else {
			obj.setNota35(dadosSQL.getDouble("nota35"));
		}
		obj.setNota35Lancada(dadosSQL.getBoolean("nota35Lancada"));
		obj.getNota35Conceito().setCodigo(dadosSQL.getInt("nota35Conceito"));

		if (dadosSQL.getObject("nota36") == null) {
			obj.setNota36((Double) dadosSQL.getObject("nota36"));
		} else {
			obj.setNota36(dadosSQL.getDouble("nota36"));
		}
		obj.setNota36Lancada(dadosSQL.getBoolean("nota36Lancada"));
		obj.getNota36Conceito().setCodigo(dadosSQL.getInt("nota36Conceito"));

		if (dadosSQL.getObject("nota37") == null) {
			obj.setNota37((Double) dadosSQL.getObject("nota37"));
		} else {
			obj.setNota37(dadosSQL.getDouble("nota37"));
		}
		obj.setNota37Lancada(dadosSQL.getBoolean("nota37Lancada"));
		obj.getNota37Conceito().setCodigo(dadosSQL.getInt("nota37Conceito"));

		if (dadosSQL.getObject("nota38") == null) {
			obj.setNota38((Double) dadosSQL.getObject("nota38"));
		} else {
			obj.setNota38(dadosSQL.getDouble("nota38"));
		}
		obj.setNota38Lancada(dadosSQL.getBoolean("nota38Lancada"));
		obj.getNota38Conceito().setCodigo(dadosSQL.getInt("nota38Conceito"));

		if (dadosSQL.getObject("nota39") == null) {
			obj.setNota39((Double) dadosSQL.getObject("nota39"));
		} else {
			obj.setNota39(dadosSQL.getDouble("nota39"));
		}
		obj.setNota39Lancada(dadosSQL.getBoolean("nota39Lancada"));
		obj.getNota39Conceito().setCodigo(dadosSQL.getInt("nota39Conceito"));

		if (dadosSQL.getObject("nota40") == null) {
			obj.setNota40((Double) dadosSQL.getObject("nota40"));
		} else {
			obj.setNota40(dadosSQL.getDouble("nota40"));
		}
		obj.setNota40Lancada(dadosSQL.getBoolean("nota40Lancada"));
		obj.getNota40Conceito().setCodigo(dadosSQL.getInt("nota40Conceito"));
		obj.setApresentarAprovadoHistorico(dadosSQL.getBoolean("apresentarAprovadoHistorico"));

		obj.getMediaFinalConceito().setCodigo(dadosSQL.getInt("mediaFinalConceito"));

		obj.getMatriculaPeriodo().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodo")));
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina")));
		obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("configuracaoAcademico"));
		obj.setNumeroAgrupamentoEquivalenciaDisciplina(dadosSQL.getInt("numeroAgrupamentoEquivalenciaDisciplina"));
		montarDadosConfiguracaoAcademico(obj, usuario);
		if (dadosSQL.getObject("mediaFinal") == null) {
			obj.setMediaFinal((Double) dadosSQL.getObject("mediaFinal"));
		} else {
			obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		}
		// obj.setMediaFinal(new Double(dadosSQL.getDouble("mediaFinal")));
		// obj.setCargaHoraria(new Double(dadosSQL.getDouble("cargaHoraria")));

		obj.setIsentarMediaFinal(dadosSQL.getBoolean("isentarMediaFinal"));
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_DADOSMINIMOS) {
			montarDadosDisciplina(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			montarDadosGradeDisciplina(obj, usuario);
			getFacadeFactory().getMatriculaFacade().carregarDados(obj.getMatricula(), usuario);
			return obj;
		}
		obj.getMatriculaPeriodo().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodo")));
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina")));
		// obj.setCargaHoraria(new Double(dadosSQL.getDouble("cargaHoraria")));
		obj.setTransferenciaEntradaDisciplinasAproveitadas(new Integer(dadosSQL.getInt("transferenciaEntradaDisciplinasAproveitadas")));
		obj.setNovoObj(Boolean.FALSE);
		montarDadosMatriculaPeriodoTurmaDisciplina(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosDisciplina(obj, nivelMontarDados, usuario);
		// //////////////////////////
		montarDadosMatriculaPeriodo(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		// /////////////////////////

		obj.setNota1Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota1Conceito")));
		obj.setNota2Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota2Conceito")));
		obj.setNota3Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota3Conceito")));
		obj.setNota4Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota4Conceito")));
		obj.setNota5Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota5Conceito")));
		obj.setNota6Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota6Conceito")));
		obj.setNota7Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota7Conceito")));
		obj.setNota8Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota8Conceito")));
		obj.setNota9Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota9Conceito")));
		obj.setNota10Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota10Conceito")));
		obj.setNota11Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota11Conceito")));
		obj.setNota12Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota12Conceito")));
		obj.setNota13Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota13Conceito")));
		obj.setNota14Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota14Conceito")));
		obj.setNota15Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota15Conceito")));
		obj.setNota16Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota16Conceito")));
		obj.setNota17Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota17Conceito")));
		obj.setNota18Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota18Conceito")));
		obj.setNota19Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota19Conceito")));
		obj.setNota20Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota20Conceito")));
		obj.setNota21Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota21Conceito")));
		obj.setNota22Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota22Conceito")));
		obj.setNota23Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota23Conceito")));
		obj.setNota24Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota24Conceito")));
		obj.setNota25Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota25Conceito")));
		obj.setNota26Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota26Conceito")));
		obj.setNota27Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota27Conceito")));
		obj.setNota28Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota28Conceito")));
		obj.setNota29Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota29Conceito")));
		obj.setNota30Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota30Conceito")));

		obj.setNota31Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota31Conceito")));
		obj.setNota32Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota32Conceito")));
		obj.setNota33Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota33Conceito")));
		obj.setNota34Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota34Conceito")));
		obj.setNota35Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota35Conceito")));
		obj.setNota36Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota36Conceito")));
		obj.setNota37Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota37Conceito")));
		obj.setNota38Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota38Conceito")));
		obj.setNota39Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota39Conceito")));
		obj.setNota40Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota40Conceito")));

		obj.setMediaFinalConceito(montarDadosNotaConceito(dadosSQL.getInt("mediaFinalConceito")));
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_DADOSBASICOS) {
			return obj;
		}

		montarDadosDisciplina(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosMatricula(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosResponsavel(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
		return obj;
	}

	public static HistoricoVO montarDadosBoletim(SqlRowSet dadosSQL, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		HistoricoVO obj = new HistoricoVO();
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina")));
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula"));
		obj.getMatriculaPeriodo().setCodigo(dadosSQL.getInt("matriculaperiodo"));
		obj.getMatriculaPeriodo().setSituacaoMatriculaPeriodo(dadosSQL.getString("situacaomatriculaperiodo"));
		obj.setTipoHistorico(dadosSQL.getString("tipoHistorico"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setAnoHistorico(dadosSQL.getString("anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestreHistorico"));
		obj.setFreguencia(new Double(dadosSQL.getDouble("freguencia")));
		obj.getResponsavel().setCodigo(new Integer(dadosSQL.getInt("responsavel")));
		obj.setCargaHorariaAproveitamentoDisciplina(dadosSQL.getInt("cargaHorariaAproveitamentoDisciplina"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaCursada"));
		obj.getCidadeVO().setCodigo(dadosSQL.getInt("cidade"));
		obj.setDataRegistro(dadosSQL.getDate("dataRegistro"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("utilizaNotaFinalConceito"));
		obj.setNotaFinalConceito(dadosSQL.getString("notaFinalConceito"));

		if (obj.getSituacao().equals("CS")) {
			obj.setMediaFinal(null);
		} else {
			obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		}

		if (dadosSQL.getObject("nota1") == null) {
			obj.setNota1((Double) dadosSQL.getObject("nota1"));
		} else {
			obj.setNota1(dadosSQL.getDouble("nota1"));
		}
		if (dadosSQL.getObject("nota2") == null) {
			obj.setNota2((Double) dadosSQL.getObject("nota2"));
		} else {
			obj.setNota2(dadosSQL.getDouble("nota2"));
		}
		if (dadosSQL.getObject("nota3") == null) {
			obj.setNota3((Double) dadosSQL.getObject("nota3"));
		} else {
			obj.setNota3(dadosSQL.getDouble("nota3"));
		}
		if (dadosSQL.getObject("nota4") == null) {
			obj.setNota4((Double) dadosSQL.getObject("nota4"));
		} else {
			obj.setNota4(dadosSQL.getDouble("nota4"));
		}
		if (dadosSQL.getObject("nota5") == null) {
			obj.setNota5((Double) dadosSQL.getObject("nota5"));
		} else {
			obj.setNota5(dadosSQL.getDouble("nota5"));
		}
		if (dadosSQL.getObject("nota6") == null) {
			obj.setNota6((Double) dadosSQL.getObject("nota6"));
		} else {
			obj.setNota6(dadosSQL.getDouble("nota6"));
		}
		if (dadosSQL.getObject("nota7") == null) {
			obj.setNota7((Double) dadosSQL.getObject("nota7"));
		} else {
			obj.setNota7(dadosSQL.getDouble("nota7"));
		}
		if (dadosSQL.getObject("nota8") == null) {
			obj.setNota8((Double) dadosSQL.getObject("nota8"));
		} else {
			obj.setNota8(dadosSQL.getDouble("nota8"));
		}
		if (dadosSQL.getObject("nota9") == null) {
			obj.setNota9((Double) dadosSQL.getObject("nota9"));
		} else {
			obj.setNota9(dadosSQL.getDouble("nota9"));
		}
		if (dadosSQL.getObject("nota10") == null) {
			obj.setNota10((Double) dadosSQL.getObject("nota10"));
		} else {
			obj.setNota10(dadosSQL.getDouble("nota10"));
		}
		if (dadosSQL.getObject("nota11") == null) {
			obj.setNota11((Double) dadosSQL.getObject("nota11"));
		} else {
			obj.setNota11(dadosSQL.getDouble("nota11"));
		}
		if (dadosSQL.getObject("nota12") == null) {
			obj.setNota12((Double) dadosSQL.getObject("nota12"));
		} else {
			obj.setNota12(dadosSQL.getDouble("nota12"));
		}
		if (dadosSQL.getObject("nota13") == null) {
			obj.setNota13((Double) dadosSQL.getObject("nota13"));
		} else {
			obj.setNota13(dadosSQL.getDouble("nota13"));
		}

		if (dadosSQL.getObject("nota14") == null) {
			obj.setNota14((Double) dadosSQL.getObject("nota14"));
		} else {
			obj.setNota14(dadosSQL.getDouble("nota14"));
		}
		if (dadosSQL.getObject("nota15") == null) {
			obj.setNota15((Double) dadosSQL.getObject("nota15"));
		} else {
			obj.setNota15(dadosSQL.getDouble("nota15"));
		}
		if (dadosSQL.getObject("nota16") == null) {
			obj.setNota16((Double) dadosSQL.getObject("nota16"));
		} else {
			obj.setNota16(dadosSQL.getDouble("nota16"));
		}
		if (dadosSQL.getObject("nota17") == null) {
			obj.setNota17((Double) dadosSQL.getObject("nota17"));
		} else {
			obj.setNota17(dadosSQL.getDouble("nota17"));
		}
		if (dadosSQL.getObject("nota18") == null) {
			obj.setNota18((Double) dadosSQL.getObject("nota18"));
		} else {
			obj.setNota18(dadosSQL.getDouble("nota18"));
		}
		if (dadosSQL.getObject("nota19") == null) {
			obj.setNota19((Double) dadosSQL.getObject("nota19"));
		} else {
			obj.setNota19(dadosSQL.getDouble("nota19"));
		}
		if (dadosSQL.getObject("nota20") == null) {
			obj.setNota20((Double) dadosSQL.getObject("nota20"));
		} else {
			obj.setNota20(dadosSQL.getDouble("nota20"));
		}
		if (dadosSQL.getObject("nota21") == null) {
			obj.setNota21((Double) dadosSQL.getObject("nota21"));
		} else {
			obj.setNota21(dadosSQL.getDouble("nota21"));
		}
		if (dadosSQL.getObject("nota22") == null) {
			obj.setNota22((Double) dadosSQL.getObject("nota22"));
		} else {
			obj.setNota22(dadosSQL.getDouble("nota22"));
		}
		if (dadosSQL.getObject("nota23") == null) {
			obj.setNota23((Double) dadosSQL.getObject("nota23"));
		} else {
			obj.setNota23(dadosSQL.getDouble("nota23"));
		}
		if (dadosSQL.getObject("nota24") == null) {
			obj.setNota24((Double) dadosSQL.getObject("nota24"));
		} else {
			obj.setNota24(dadosSQL.getDouble("nota24"));
		}
		if (dadosSQL.getObject("nota25") == null) {
			obj.setNota25((Double) dadosSQL.getObject("nota25"));
		} else {
			obj.setNota25(dadosSQL.getDouble("nota25"));
		}
		if (dadosSQL.getObject("nota26") == null) {
			obj.setNota26((Double) dadosSQL.getObject("nota26"));
		} else {
			obj.setNota26(dadosSQL.getDouble("nota26"));
		}
		if (dadosSQL.getObject("nota27") == null) {
			obj.setNota27((Double) dadosSQL.getObject("nota27"));
		} else {
			obj.setNota27(dadosSQL.getDouble("nota27"));
		}
		if (dadosSQL.getObject("nota28") == null) {
			obj.setNota28((Double) dadosSQL.getObject("nota28"));
		} else {
			obj.setNota28(dadosSQL.getDouble("nota28"));
		}
		if (dadosSQL.getObject("nota29") == null) {
			obj.setNota29((Double) dadosSQL.getObject("nota29"));
		} else {
			obj.setNota29(dadosSQL.getDouble("nota29"));
		}
		if (dadosSQL.getObject("nota30") == null) {
			obj.setNota30((Double) dadosSQL.getObject("nota30"));
		} else {
			obj.setNota30(dadosSQL.getDouble("nota30"));
		}
		if (dadosSQL.getObject("nota31") == null) {
			obj.setNota31((Double) dadosSQL.getObject("nota31"));
		} else {
			obj.setNota31(dadosSQL.getDouble("nota31"));
		}
		if (dadosSQL.getObject("nota32") == null) {
			obj.setNota32((Double) dadosSQL.getObject("nota32"));
		} else {
			obj.setNota32(dadosSQL.getDouble("nota32"));
		}
		if (dadosSQL.getObject("nota33") == null) {
			obj.setNota33((Double) dadosSQL.getObject("nota33"));
		} else {
			obj.setNota33(dadosSQL.getDouble("nota33"));
		}
		if (dadosSQL.getObject("nota34") == null) {
			obj.setNota34((Double) dadosSQL.getObject("nota34"));
		} else {
			obj.setNota34(dadosSQL.getDouble("nota34"));
		}
		if (dadosSQL.getObject("nota35") == null) {
			obj.setNota35((Double) dadosSQL.getObject("nota35"));
		} else {
			obj.setNota35(dadosSQL.getDouble("nota35"));
		}
		if (dadosSQL.getObject("nota36") == null) {
			obj.setNota36((Double) dadosSQL.getObject("nota36"));
		} else {
			obj.setNota36(dadosSQL.getDouble("nota36"));
		}
		if (dadosSQL.getObject("nota37") == null) {
			obj.setNota37((Double) dadosSQL.getObject("nota37"));
		} else {
			obj.setNota37(dadosSQL.getDouble("nota37"));
		}
		if (dadosSQL.getObject("nota38") == null) {
			obj.setNota38((Double) dadosSQL.getObject("nota38"));
		} else {
			obj.setNota38(dadosSQL.getDouble("nota38"));
		}
		if (dadosSQL.getObject("nota39") == null) {
			obj.setNota39((Double) dadosSQL.getObject("nota39"));
		} else {
			obj.setNota39(dadosSQL.getDouble("nota39"));
		}
		if (dadosSQL.getObject("nota40") == null) {
			obj.setNota40((Double) dadosSQL.getObject("nota40"));
		} else {
			obj.setNota40(dadosSQL.getDouble("nota40"));
		}
		obj.setApresentarAprovadoHistorico(dadosSQL.getBoolean("apresentarAprovadoHistorico"));


		obj.setHistoricoDisciplinaFazParteComposicao(dadosSQL.getBoolean("historicoDisciplinaFazParteComposicao"));
		obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("configuracaoAcademico"));
		montarDadosDisciplina(obj, nivelMontarDados, usuario);
		montarDadosGradeDisciplina(obj, usuario);
		if (obj.getConfiguracaoAcademico().getCodigo().equals(0)) {
			if (obj.getGradeDisciplinaVO().getConfiguracaoAcademico().getCodigo() != 0) {
				obj.getConfiguracaoAcademico().setCodigo(obj.getGradeDisciplinaVO().getConfiguracaoAcademico().getCodigo());
				obj.setConfiguracaoAcademico(getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(obj.getGradeDisciplinaVO().getConfiguracaoAcademico().getCodigo(), usuario));
			} else {
				obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("curso_configuracaoacademico"));
				montarDadosConfiguracaoAcademico(obj, usuario);
			}
		} else {
			obj.setConfiguracaoAcademico(getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(obj.getConfiguracaoAcademico().getCodigo(), usuario));
		}
		obj.setNota1Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota1Conceito")));
		obj.setNota2Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota2Conceito")));
		obj.setNota3Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota3Conceito")));
		obj.setNota4Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota4Conceito")));
		obj.setNota5Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota5Conceito")));
		obj.setNota6Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota6Conceito")));
		obj.setNota7Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota7Conceito")));
		obj.setNota8Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota8Conceito")));
		obj.setNota9Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota9Conceito")));
		obj.setNota10Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota10Conceito")));
		obj.setNota11Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota11Conceito")));
		obj.setNota12Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota12Conceito")));
		obj.setNota13Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota13Conceito")));
		obj.setNota14Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota14Conceito")));
		obj.setNota15Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota15Conceito")));
		obj.setNota16Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota16Conceito")));
		obj.setNota17Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota17Conceito")));
		obj.setNota18Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota18Conceito")));
		obj.setNota19Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota19Conceito")));
		obj.setNota20Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota20Conceito")));
		obj.setNota21Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota21Conceito")));
		obj.setNota22Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota22Conceito")));
		obj.setNota23Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota23Conceito")));
		obj.setNota24Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota24Conceito")));
		obj.setNota25Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota25Conceito")));
		obj.setNota26Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota26Conceito")));
		obj.setNota27Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota27Conceito")));
		obj.setNota28Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota28Conceito")));
		obj.setNota29Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota29Conceito")));
		obj.setNota30Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota30Conceito")));

		obj.setNota31Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota31Conceito")));
		obj.setNota32Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota32Conceito")));
		obj.setNota33Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota33Conceito")));
		obj.setNota34Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota34Conceito")));
		obj.setNota35Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota35Conceito")));
		obj.setNota36Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota36Conceito")));
		obj.setNota37Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota37Conceito")));
		obj.setNota38Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota38Conceito")));
		obj.setNota39Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota39Conceito")));
		obj.setNota40Conceito(montarDadosNotaConceito(dadosSQL.getInt("nota40Conceito")));

		obj.setMediaFinalConceito(montarDadosNotaConceito(dadosSQL.getInt("mediaFinalConceito")));
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));
		return obj;
	}

	public static ConfiguracaoAcademicoNotaConceitoVO montarDadosNotaConceito(Integer codigo) throws Exception {
		if (codigo == 0) {
			return new ConfiguracaoAcademicoNotaConceitoVO();
		}
		return getFacadeFactory().getConfiguracaoAcademicoNotaConceitoFacade().consultarPorChavePrimaria(codigo);
	}

	/**
	 * Operação responsável por montar os dados de um objeto da classe
	 * <code>PessoaVO</code> relacionado ao objeto <code>HistoricoVO</code>. Faz
	 * uso da chave primária da classe <code>PessoaVO</code> para realizar a
	 * consulta.
	 *
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 */
	public static void montarDadosResponsavel(HistoricoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getResponsavel().getCodigo().intValue() == 0) {
			obj.setResponsavel(new UsuarioVO());
			return;
		}
		obj.setResponsavel(getFacadeFactory().getUsuarioFacade().consultarPorChavePrimaria(obj.getResponsavel().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario));
	}

	/**
	 * Operação responsável por montar os dados de um objeto da classe
	 * <code>MatriculaVO</code> relacionado ao objeto <code>HistoricoVO</code>.
	 * Faz uso da chave primária da classe <code>MatriculaVO</code> para
	 * realizar a consulta.
	 *
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 */
	public static void montarDadosMatricula(HistoricoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if ((obj.getMatricula().getMatricula() == null) || (obj.getMatricula().getMatricula().equals(""))) {
			obj.setMatricula(new MatriculaVO());
			return;
		}
		obj.setMatricula(getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(obj.getMatricula().getMatricula(), 0, NivelMontarDados.TODOS, usuario));
	}

	public static void montarDadosMatriculaPeriodo(HistoricoVO obj, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		if (obj.getMatriculaPeriodo().getCodigo().intValue() == 0) {
			obj.setMatriculaPeriodo(new MatriculaPeriodoVO());
			return;
		}
		obj.setMatriculaPeriodo(getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(obj.getMatriculaPeriodo().getCodigo(), nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public static void montarDadosMatriculaPeriodoTurmaDisciplina(HistoricoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getMatriculaPeriodoTurmaDisciplina().getCodigo().intValue() == 0) {
			obj.setMatriculaPeriodoTurmaDisciplina(new MatriculaPeriodoTurmaDisciplinaVO());
			return;
		}
		obj.setMatriculaPeriodoTurmaDisciplina(getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarPorChavePrimaria(obj.getMatriculaPeriodoTurmaDisciplina().getCodigo(), nivelMontarDados, usuario));
	}

	/**
	 * Operação responsável por montar os dados de um objeto da classe
	 * <code>DisciplinaVO</code> relacionado ao objeto <code>HistoricoVO</code>.
	 * Faz uso da chave primária da classe <code>DisciplinaVO</code> para
	 * realizar a consulta.
	 *
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 */
	public static void montarDadosDisciplina(HistoricoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getDisciplina().getCodigo().intValue() == 0) {
			obj.setDisciplina(new DisciplinaVO());
			return;
		}
		obj.setDisciplina(getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(obj.getDisciplina().getCodigo(), nivelMontarDados, usuario));
	}

	public static void montarDadosGradeDisciplina(HistoricoVO obj, UsuarioVO usuario) throws Exception {
		if (Uteis.isAtributoPreenchido(obj.getGradeDisciplinaVO())) {
			obj.setGradeDisciplinaVO(getFacadeFactory().getGradeDisciplinaFacade().consultarPorChavePrimaria(obj.getGradeDisciplinaVO().getCodigo(), usuario));
		} else {
			obj.setGradeDisciplinaVO(getFacadeFactory().getGradeDisciplinaFacade().consultarPorMatriculaDisciplinaMatriculaPeriodo(obj.getMatricula().getMatricula(), obj.getMatriculaPeriodo().getCodigo(), obj.getDisciplina().getCodigo(), usuario));
		}
	}

	/**
	 * HOMOLOGADO VERSAO 5.0
	 */
	public HistoricoVO consultarPorChavePrimaria(Integer codigoPrm, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		HistoricoVO historico = new HistoricoVO();
		historico.setCodigo(codigoPrm);
		if (Uteis.NIVELMONTARDADOS_TODOS == nivelMontarDados) {
			carregarDados(historico, NivelMontarDados.TODOS, usuario);
		} else {
			carregarDados(historico, NivelMontarDados.BASICO, usuario);
		}
		return historico;
		// String sqlStr = "SELECT * FROM Historico WHERE codigo = ?";
		// SqlRowSet tabelaResultado =
		// getConexao().getJdbcTemplate().queryForRowSet(sqlStr, new
		// Object[]{codigoPrm});
		// if (!tabelaResultado.next()) {
		// throw new ConsistirException("Dados Não Encontrados.");
		// }
		// return (montarDados(tabelaResultado, nivelMontarDados,
		// configuracaoFinanceiroVO, usuario));
	}

	/**
	 * Operação responsável por obter o último valor gerado para uma chave
	 * primária. É utilizada para obter o valor gerado pela SGBD para uma chave
	 * primária, a apresentação do mesmo e a implementação de possíveis
	 * relacionamentos.
	 */
	public static Integer obterValorChavePrimariaCodigo(UsuarioVO usuario) throws Exception {
		// Historico.inicializar();
		String sqlStr = "SELECT MAX(codigo) FROM Historico";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		tabelaResultado.next();
		return (new Integer(tabelaResultado.getInt(1)));
	}

	/**
	 * Operação reponsável por retornar o identificador desta classe. Este
	 * identificar é utilizado para verificar as permissões de acesso as
	 * operações desta classe.
	 */
	public static String getIdEntidade() {
		return Historico.idEntidade;
	}

	/**
	 * Operação reponsável por definir um novo valor para o identificador desta
	 * classe. Esta alteração deve ser possível, pois, uma mesma classe de
	 * negócio pode ser utilizada com objetivos distintos. Assim ao se verificar
	 * que Como o controle de acesso é realizado com base neste identificador,
	 */
	public void setIdEntidade(String idEntidade) {
		Historico.idEntidade = idEntidade;
	}

	public static void montarDadosConfiguracaoAcademico(HistoricoVO obj, UsuarioVO usuario) throws Exception {
		if (obj.getConfiguracaoAcademico().getCodigo().intValue() == 0) {
			obj.setConfiguracaoAcademico(new ConfiguracaoAcademicoVO());
			return;
		}
		obj.setConfiguracaoAcademico(getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(obj.getConfiguracaoAcademico().getCodigo(), usuario));
	}

	/**
	 *
	 * @param codigoMatriculaPeriodo
	 * @param listaMatriculaPeriodoTurmaDisciplinaVo
	 * @param controlarAcesso
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirPorMatriculaPeriodo(Integer codigoMatriculaPeriodo, List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinaVo, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		// //System.out.println("===================:7a.1" + new Date() +
		// "===========================");
		List<HistoricoVO> listaMatriculaPeriodoTurmaDisciplinaVoBD = consultaRapidaPorMatriculaPeriodo(codigoMatriculaPeriodo, false, usuario);
		// //System.out.println("===================:7a.2" + new Date() +
		// "===========================");
		Historico.excluir(getIdEntidade(), controlarAcesso, usuario);
		registrarLogExclusaoHistoricoResumido(usuario);
		String sqlStr = "DELETE FROM Historico WHERE ((matriculaPeriodo = ?)) ";
		if (listaMatriculaPeriodoTurmaDisciplinaVo != null) {
			for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVo : listaMatriculaPeriodoTurmaDisciplinaVo) {
				for (HistoricoVO historicoVoBD : listaMatriculaPeriodoTurmaDisciplinaVoBD) {
					if (matriculaPeriodoTurmaDisciplinaVo.getCodigo().intValue() == historicoVoBD.getMatriculaPeriodoTurmaDisciplina().getCodigo().intValue()) {
						sqlStr += " AND matriculaPeriodoTurmaDisciplina != " + matriculaPeriodoTurmaDisciplinaVo.getCodigo().intValue();
						break;
					}
				}
			}
		}
		getConexao().getJdbcTemplate().update(sqlStr + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario), new Object[] { codigoMatriculaPeriodo });
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirHistoricoPorGradeCurricularPorListaMatriculaPeriodo(String listaMatriculaPeriodo, Integer gradeCurricular, UsuarioVO usuario) throws Exception {
		MatriculaPeriodo.excluir(getIdEntidade());
		StringBuilder sql = new StringBuilder("DELETE FROM Historico WHERE  matrizcurricular = ").append(gradeCurricular);
		sql.append(" and matriculaPeriodo in (").append(listaMatriculaPeriodo).append(")");
		sql.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
		getConexao().getJdbcTemplate().update(sql.toString());
	}

	/**
	 *
	 * @param codigoMatriculaPeriodo
	 * @param listaMatriculaPeriodoTurmaDisciplinaVo
	 * @param controlarAcesso
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirPorMatriculaPeriodoTurmaDisciplina(Integer codigoMatriculaPeriodoTurmaDisciplina, UsuarioVO usuario) throws Exception {
		Historico.excluir(getIdEntidade(), false, usuario);
		registrarLogExclusaoHistoricoResumido(usuario);
		String sqlStr = "DELETE FROM Historico WHERE " + "(matriculaPeriodoTurmaDisciplina = ?) AND " + "(situacao = 'CU')" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { codigoMatriculaPeriodoTurmaDisciplina });
	}

	/**
	 * Método responsavel por validar se o Nivel de Montar Dados é Básico ou
	 * Completo e faz a consulta de acordo com o nível especificado.
	 *
	 * @param obj
	 * @param nivelMontarDados
	 * @throws Exception
	 * @author Carlos
	 */
	public void carregarDados(HistoricoVO obj, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		SqlRowSet resultado = null;
		if ((nivelMontarDados.equals(NivelMontarDados.BASICO)) && (obj.getIsNivelMontarDadosNaoInicializado())) {
			resultado = consultaRapidaPorChavePrimariaDadosBasicos(obj.getCodigo(), usuario);
			montarDadosBasico((HistoricoVO) obj, resultado, usuario);
		}
		if ((nivelMontarDados.equals(NivelMontarDados.TODOS)) && (!obj.getIsNivelMontarDadosTodos())) {
			resultado = consultaRapidaPorChavePrimariaDadosCompletos(obj.getCodigo(), usuario);
			montarDadosCompleto((HistoricoVO) obj, resultado, usuario);
		}
	}

	private SqlRowSet consultaRapidaPorChavePrimariaDadosBasicos(Integer codHistorico, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (historico.codigo= ").append(codHistorico).append(")");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			throw new ConsistirException("Dados Não Encontrados (Histórico).");
		}
		return tabelaResultado;
	}

	private SqlRowSet consultaRapidaPorChavePrimariaDadosCompletos(Integer codHistorico, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sqlStr = new StringBuilder(getSQLPadraoConsultaCompleta());
		sqlStr.append(" WHERE (historico.codigo= ? )");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), codHistorico);
		if (!tabelaResultado.next()) {
			throw new ConsistirException("Dados Não Encontrados (Histórico).");
		}
		return tabelaResultado;
	}

	/**
	 * HOMOLOGADO VERSAO 5.0 Consulta por históricos de uma matrícula e de uma
	 * matriz curricular. Isto para uma ou mais disciplinas (lista de códigos) e
	 * uma lista de situações do historico. Podendo filtrar assim, somente
	 * históricos aprovados, reprovados e afins. Outros parametros importantes
	 * são filtros do tipo de disciplina. Por exemplo, se passado TRUE para o
	 * parametro somenteHistoricoDeDisciplinasEquivalentes, serao retornados
	 * somente historicos de disciplinas que foram estudadas por serem
	 * equivalentes. Caso seja FALSE, este parametro não será considerado para
	 * filtro - não terá nenhum referÊncia na CLAUSULA WHERE. O mesmo é valido
	 * para os parametros: somenteHistoricoDeDisciplinasDaMatriz e
	 * somenteHistoricoForaMatrizCurricular. passadas como parametro. Também
	 *
	 * @throws Exception
	 */
	public List<HistoricoVO> consultaRapidaPorDisciplinaGradeCurricular(String matricula, Integer gradeCurricular, List<Integer> disciplinas, List<SituacaoHistorico> situacoes, Boolean somenteHistoricoDeDisciplinasDaMatriz, Boolean somenteHistoricoDeDisciplinasEquivalentes, Boolean somenteHistoricoForaMatrizCurricular, Integer mapaEquivalenciaDisciplina, Integer numeroAgrupamentoEquivalenciaDisciplina, Integer historicoIgnorar, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuffer sqlStr = null;
		if (nivelMontarDados.equals(NivelMontarDados.BASICO)) {
			sqlStr = getSQLPadraoConsultaBasica();
		} else {
			sqlStr = getSQLPadraoConsultaCompleta();
		}
		sqlStr.append(" WHERE (historico.matrizcurricular=").append(gradeCurricular).append(")");
		sqlStr.append("   AND (historico.matricula='").append(matricula).append("')");
		
		if(Uteis.isAtributoPreenchido(mapaEquivalenciaDisciplina)){
		  sqlStr.append("   AND historico.mapaEquivalenciaDisciplina=").append(mapaEquivalenciaDisciplina);
		}
		if(Uteis.isAtributoPreenchido(numeroAgrupamentoEquivalenciaDisciplina)){
		   sqlStr.append(" AND historico.numeroAgrupamentoEquivalenciaDisciplina = ").append(numeroAgrupamentoEquivalenciaDisciplina);
		}
		if(Uteis.isAtributoPreenchido(historicoIgnorar)){
			sqlStr.append(" AND historico.codigo != ").append(historicoIgnorar);
		}
		if (somenteHistoricoDeDisciplinasDaMatriz) {
			sqlStr.append("   AND ((historico.historicoEquivalente IS NULL) OR (historico.historicoEquivalente=FALSE))");
			sqlStr.append("   AND ((historico.historicoDisciplinaForaGrade IS NULL) OR (historico.historicoDisciplinaForaGrade=FALSE))");
		}
		if (somenteHistoricoDeDisciplinasEquivalentes) {
			sqlStr.append("   AND (historico.historicoEquivalente=TRUE)");
		}
		if (somenteHistoricoForaMatrizCurricular) {
			sqlStr.append("   AND ((historico.historicoEquivalente=TRUE) OR (historico.historicoDisciplinaForaGrade=TRUE))");
		}
		if (disciplinas != null  && !disciplinas.isEmpty()) {
			sqlStr.append(" AND (historico.disciplina IN (");
			String virgula = "";
			for (Integer codigoDisciplina : disciplinas) {
				sqlStr.append(virgula).append(codigoDisciplina);
				virgula = ",";
			}
			sqlStr.append("))");
		}
		if (situacoes != null && !situacoes.isEmpty()) {
			sqlStr.append(" AND (historico.situacao IN (");
			String virgula = "";
			for (SituacaoHistorico situacao : situacoes) {
				sqlStr.append(virgula).append("'").append(situacao.getValor()).append("'");
				virgula = ",";
			}
			sqlStr.append("))");
		}
		sqlStr.append(" ORDER BY historico.anoHistorico, historico.semestreHistorico ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);

		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			if (nivelMontarDados.equals(NivelMontarDados.BASICO)) {
				montarDadosBasico(obj, tabelaResultado, usuario);
			} else {
				montarDadosCompleto(obj, tabelaResultado, usuario);
			}
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	private StringBuffer getSQLPadraoConsultaBasica() {
		StringBuffer str = new StringBuffer();
		str.append("SELECT distinct historico.codigo, historico.situacao, historico.tipoHistorico, historico.historicoDisciplinaFazParteComposicao, historico.matricula AS \"historico.matricula\", ");
		str.append("historico.cargahorariadisciplina as \"historico.cargahorariadisciplina\", historico.matrizcurricular as \"historico.matrizcurricular\", ");
		str.append("historico.freguencia as \"historico.freguencia\", historico.mediafinal as \"historico.mediafinal\", historico.frequenciaTeorica, historico.frequenciaPratica, ");
		str.append("historico.creditoDisciplina as \"historico.creditoDisciplina\", historico.periodoLetivoCursada as \"historico.periodoLetivoCursada\", ");
		str.append("historico.periodoLetivoMatrizCurricular as \"historico.periodoLetivoMatrizCurricular\",  ");
		str.append("historico.anoHistorico as \"historico.anoHistorico\", historico.semestreHistorico as \"historico.semestreHistorico\", ");
		str.append("disciplina.codigo AS \"disciplina.codigo\", disciplina.nome AS \"disciplina.nome\", matriculaPeriodo.codigo AS \"matriculaPeriodo.codigo\", historico.dataInicioAula as \"historico.dataInicioAula\", historico.dataFimAula as \"historico.dataFimAula\" FROM historico AS historico ");
		str.append("LEFT JOIN matriculaPeriodo on matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		str.append("LEFT JOIN disciplina on disciplina.codigo = historico.disciplina ");
		return str;
	}

	/**
	 * Método responsavel por fazer uma seleção completa da Entidade Funcionário
	 * e mais algumas outras entidades que possuem relacionamento com a mesma. É
	 * uma consulta que busca completa e padrão.
	 *
	 * @return List Contendo vários objetos da classe
	 * @author Carlos
	 */
	private StringBuffer getSQLPadraoConsultaCompleta() {
		StringBuffer str = new StringBuffer();
		// Dados do Historico
		str.append("SELECT historico.codigo, historico.anoHistorico, historico.semestreHistorico, historico.tipoHistorico, historico.instituicao, historico.situacao, historico.freguencia, historico.frequenciaTeorica, historico.frequenciaPratica, historico.dataRegistro, historico.cidade, historico.cargaHorariaAproveitamentoDisciplina, historico.cargahorariacursada, historico.cargaHorariaDisciplina, ");
		str.append("historico.utilizaNotaFinalConceito, historico.notaFinalConceito, historico.historicoCriterioAvaliacaoAluno, historico.criterioAvaliacao, historico.creditodisciplina,  ");
		str.append(" historico.numeroagrupamentoequivalenciadisciplina, ");
		str.append("historico.mediaFinal, historico.transferenciaEntradaDisciplinasAproveitadas, historico.disciplinasAproveitadas, ");
		str.append("historico.updated, historico.isentarMediaFinal, historico.notaFinalConceito as \"historico.notaFinalConceito\",  historico.mediaFinalConceito, ");
		for(int x = 1; x<=40;x++) {
			str.append(" historico.nota").append(x).append(", ");
			str.append(" historico.nota").append(x).append("lancada, ");
			str.append(" historico.nota").append(x).append("conceito, ");
		}
		str.append("historico.observacao AS \"historico.observacao\", historico.historicoDisciplinaAtividadeComplementar AS \"historico.historicoDisciplinaAtividadeComplementar\", ");
		str.append("historico.cargaHorariaDisciplina AS \"historico.cargaHorariaDisciplina\", historico.creditoDisciplina AS \"historico.creditoDisciplina\", ");
		str.append("historico.historicoDisciplinaOptativa AS \"historico.historicoDisciplinaOptativa\", historico.historicoDisciplinaForaGrade AS \"historico.historicoDisciplinaForaGrade\", ");
		str.append("historico.nomeDisciplina AS \"historico.nomeDisciplina\", historico.historicoDisciplinaAproveitada AS \"historico.historicoDisciplinaAproveitada\", ");
		str.append("historico.faltaPrimeiroBimestre AS \"historico.faltaPrimeiroBimestre\", historico.faltaSegundoBimestre AS \"historico.faltaSegundoBimestre\", ");
		str.append("historico.faltaTerceiroBimestre AS \"historico.faltaTerceiroBimestre\", historico.faltaQuartoBimestre AS \"historico.faltaQuartoBimestre\", ");
		str.append("historico.totalFalta AS \"historico.totalFalta\", ");
		str.append("historico.utilizaNotaFinalConceito AS \"historico.utilizaNotaFinalConceito\", ");

		str.append("historico.transferenciaMatrizCurricularMatricula AS \"historico.transferenciaMatrizCurricularMatricula\",  ");
		str.append("historico.historicoGeradoAPartirTransferenciaMatrizCurricular AS \"historico.historicoGeradoAPartirTransferenciaMatrizCurricular\",  ");
		str.append("historico.observacaoTransferenciaMatrizCurricular AS \"historico.observacaoTransferenciaMatrizCurricular\",  ");
		str.append("historico.historicoCursandoPorCorrespondenciaAposTransferencia AS \"historico.historicoCursandoPorCorrespondenciaAposTransferencia\",  ");
		// Dados da Matriz Curricular do Historico
		str.append("gradeCurricular.codigo AS \"gradeCurricular.codigo\", ");
		str.append("gradeCurricular.nome AS \"gradeCurricular.nome\", ");

		// Dados do Periodo Letivo Matriz Curricular
		str.append("periodoLetivoMatrizCurricular.codigo AS \"periodoLetivoMatrizCurricular.codigo\", ");
		str.append("periodoLetivoMatrizCurricular.descricao AS \"periodoLetivoMatrizCurricular.descricao\", ");
		str.append("periodoLetivoMatrizCurricular.periodoLetivo AS \"periodoLetivoMatrizCurricular.periodoLetivo\", ");

		// Dados da Matriz Curricular
		str.append("matrizCurricular.codigo AS \"matrizCurricular.codigo\", ");
		str.append("matrizCurricular.nome AS \"matrizCurricular.nome\", ");

		// Dados do Periodo Letivo Cursada
		str.append("periodoLetivoCursada.codigo AS \"periodoLetivoCursada.codigo\", ");
		str.append("periodoLetivoCursada.descricao AS \"periodoLetivoCursada.descricao\", ");
		str.append("periodoLetivoCursada.periodoLetivo AS \"periodoLetivoCursada.periodoLetivo\", ");

		// Dados do Configuracao Academico
		str.append(" configuracaoAcademico.codigo AS \"configuracaoAcademico.codigo\",  ");
		str.append(" configuracaoAcademico.nome AS \"configuracaoAcademico.nome\",  ");
		str.append(" configuracaoAcademico.intervaloNotasDiferente AS \"configuracaoAcademico.intervaloNotasDiferente\",  ");

		// Dados do Matricula Periodo Turma Disciplina
		str.append(" matriculaPeriodoTurmaDisciplina.codigo AS \"matriculaPeriodoTurmaDisciplina.codigo\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Semestre
		str.append(" matriculaPeriodoTurmaDisciplina.semestre AS \"matriculaPeriodoTurmaDisciplina.semestre\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Ano
		str.append(" matriculaPeriodoTurmaDisciplina.ano AS \"matriculaPeriodoTurmaDisciplina.ano\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turma AS \"matriculaPeriodoTurmaDisciplina.turma\", matriculaPeriodoTurmaDisciplina.turmaTeorica, matriculaPeriodoTurmaDisciplina.turmaPratica, ");
		// Dados do Turma
		str.append(" turma.codigo AS \"turma.codigo\",  ");
		str.append(" turma.identificadorTurma AS \"turma.identificadorTurma\",  ");
		// Dados do Turno
		str.append(" turno.nome AS \"turno.nome\",  ");
		// Dados da Grade Curricular
		str.append(" gradeCurricular.nome AS \"gradeCurricular.nome\", ");
		// Dados do Matricula Periodo
		str.append(" matriculaPeriodo.codigo AS \"matriculaPeriodo.codigo\", matriculaPeriodo.situacao AS \"matriculaPeriodo.situacao\", matriculaperiodo.situacaoMatriculaPeriodo as \"matriculaperiodo.situacaoMatriculaPeriodo\", matriculaPeriodo.datafechamentomatriculaperiodo AS \"matriculaPeriodo.datafechamentomatriculaperiodo\", matriculaPeriodo.data AS \"matriculaPeriodo.data\", ");
		// Dados do Periodo Letivo
		str.append(" periodoLetivo.descricao AS \"periodoLetivo.descricao\",  ");
		// Dados da Matricula
		str.append(" matricula.matricula AS \"matricula.matricula\",  ");
		str.append(" matricula.updated AS \"matricula.updated\",  ");
		str.append(" matricula.situacao AS \"matricula.situacao\",  ");
		str.append(" matricula.tipoMatricula AS \"matricula.tipoMatricula\",  ");
		str.append(" matricula.situacaoFinanceira AS \"matricula.situacaoFinanceira\", matricula.canceladoFinanceiro, ");
		str.append(" matricula.gradecurricularatual AS \"matricula.gradecurricularatual\",  ");
		// Dados do Curso
		str.append(" curso.codigo AS \"curso.codigo\", curso.nome AS \"curso.nome\", curso.periodicidade as \"curso.periodicidade\", ");
		// Dados da Unidade Ensino
		str.append(" unidadeEnsino.codigo AS \"unidadeEnsino.codigo\", unidadeEnsino.nome AS \"unidadeEnsino.nome\", ");
		// Dados do Aluno
		str.append(" aluno.codigo AS \"aluno.codigo\", aluno.nome AS \"aluno.nome\", ");
		// Dados do Usuario
		str.append(" usuario.nome AS \"responsavel.nome\", usuario.codigo AS \"responsavel.codigo\", ");
		// Dados da Disciplina
		str.append(" disciplina.codigo AS \"disciplina.codigo\", disciplina.nome AS \"disciplina.nome\", ");

		// DISCIPLINA COMPOSTA E EQUIVALENCIA
		str.append(" historico.historicoPorEquivalencia AS \"historico.historicoPorEquivalencia\", historico.historicoEquivalente AS \"historico.historicoEquivalente\", ");
		str.append(" historico.gradeDisciplinaComposta AS \"historico.gradeDisciplinaComposta\", ");
		str.append(" gradeDisciplinaComposta.variavelNota AS \"gradeDisciplinaComposta.variavelNota\", ");
		str.append(" gradeDisciplinaComposta.ordem AS \"gradeDisciplinaComposta.ordem\", ");
		str.append(" gradeDisciplinaComposta.nrcreditos AS \"gradeDisciplinaComposta.nrcreditos\", ");
		str.append(" gradeDisciplinaComposta.cargahoraria AS \"gradeDisciplinaComposta.cargahoraria\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaPratica AS \"gradeDisciplinaComposta.cargahorariaPratica\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaTeorica AS \"gradeDisciplinaComposta.cargahorariaTeorica\", ");
		str.append(" gradeDisciplinaComposta.gradedisciplina AS \"gradeDisciplinaComposta.gradedisciplina\", ");
		str.append(" gradeDisciplinaComposta.horaaula AS \"gradeDisciplinaComposta.horaaula\", ");
		str.append(" gradeDisciplinaComposta.gradeCurricularGrupoOptativaDisciplina AS \"gradeDisciplinaComposta.gradeCurricularGrupoOptativaDisciplina\", ");
		str.append(" historico.historicoDisciplinaComposta AS \"historico.historicoDisciplinaComposta\", historico.historicoDisciplinaFazParteComposicao, ");
		str.append(" historico.mapaEquivalenciaDisciplina AS \"historico.mapaEquivalenciaDisciplina\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaCursada AS \"historico.mapaEquivalenciaDisciplinaCursada\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaMatrizCurricular AS \"historico.mapaEquivalenciaDisciplinaMatrizCurricular\", ");

		// Dados da Grade Disciplina
		str.append(" gradedisciplina.codigo AS \"gradedisciplina.codigo\", ");
		str.append(" gradedisciplina.disciplina AS \"gradedisciplina.disciplina\", ");
		str.append(" gradedisciplina.cargaHoraria AS \"gradedisciplina.cargaHoraria\", ");
		str.append(" gradedisciplina.cargaHorariapratica AS \"gradedisciplina.cargaHorariapratica\", ");
		str.append(" gradedisciplina.nrCreditos AS \"gradedisciplina.nrCreditos\", ");
		str.append(" gradedisciplina.diversificada AS \"gradedisciplina.diversificada\", ");
		str.append(" gradedisciplina.disciplinaComposta AS \"gradedisciplina.disciplinaComposta\", ");
		str.append(" gradedisciplina.disciplinaEixoTematico AS \"gradedisciplina.disciplinaEixoTematico\", ");
		str.append(" gradedisciplina.formulaCalculoNota AS \"gradedisciplina.formulaCalculoNota\", ");
		str.append(" gradedisciplina.formulaCalculo AS \"gradedisciplina.formulaCalculo\", ");
		str.append(" gradedisciplina.horaaula AS \"gradedisciplina.horaaula\", ");

		str.append(" gradedisciplina.formulaCalculo AS \"gradedisciplina.formulaCalculo\", ");
		str.append(" gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradedisciplina.variavelNotaRecuperacao AS \"gradedisciplina.variavelNotaRecuperacao\", ");
		str.append(" gradedisciplina.condicaoUsoRecuperacao AS \"gradedisciplina.condicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gradedisciplina.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperada AS \"gradedisciplina.formulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperacao AS \"gradedisciplina.formulaCalculoNotaRecuperacao\", ");

		// Dados da Grade Curricular Grupo Optativa Disciplina
		// (GradeCurricularGrupoOptativaDisciplina)
		str.append(" historico.gradeCurricularGrupoOptativaDisciplina AS \"historico.gradeCurricularGrupoOptativaDisciplina\",  ");
		str.append(" historico.disciplinaReferenteAUmGrupoOptativa AS \"historico.disciplinaReferenteAUmGrupoOptativa\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.codigo AS \"gradeCurricularGrupoOptativaDisciplina.codigo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplina AS \"gradeCurricularGrupoOptativaDisciplina.disciplina\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHoraria AS \"gradeCurricularGrupoOptativaDisciplina.cargaHoraria\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica AS \"gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.nrCreditos AS \"gradeCurricularGrupoOptativaDisciplina.nrCreditos\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.diversificada AS \"gradeCurricularGrupoOptativaDisciplina.diversificada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplinaComposta AS \"gradeCurricularGrupoOptativaDisciplina.disciplinaComposta\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculo AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gcgod.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaRecuperacao AS \"gcgod.variavelNotaRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.condicaoUsoRecuperacao AS \"gcgod.condicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gcgod.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperada AS \"gcgod.formulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gcgod.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperacao AS \"gcgod.formulaCalculoNotaRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.horaaula AS \"gcgod.horaaula\", ");

		str.append(" historico.apresentarAprovadoHistorico, historico.dataInicioAula as \"historico.dataInicioAula\", historico.dataFimAula as \"historico.dataFimAula\", ");

		str.append(" exists (select historiconota.codigo from historiconota where historiconota.historico = historico.codigo and historiconota.notarecuperacao and situacaorecuperacaonota = '").append(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO.name()).append("' limit 1) as emrecuperacao" );

		str.append(" FROM historico AS historico ");

		str.append(" LEFT JOIN matricula on matricula.matricula = historico.matricula ");
		str.append(" LEFT JOIN matriculaPeriodo on matriculaPeriodo.matricula = matricula.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		str.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		str.append(" LEFT JOIN turma on turma.codigo = case when matriculaPeriodoTurmaDisciplina.turma  is not null then matriculaPeriodoTurmaDisciplina.turma else matriculaPeriodo.turma end  ");
		str.append(" LEFT JOIN gradeCurricular on historico.matrizCurricular = gradeCurricular.codigo ");
		str.append(" LEFT JOIN disciplina on disciplina.codigo = historico.disciplina ");
		str.append(" LEFT JOIN pessoa AS \"aluno\" on aluno.codigo = matricula.aluno ");
		str.append(" LEFT JOIN periodoLetivo on historico.periodoLetivoMatrizCurricular = periodoLetivo.codigo ");
		str.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		str.append(" LEFT JOIN gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		str.append(" LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		str.append(" LEFT JOIN usuario on usuario.codigo = historico.responsavel ");

		str.append(" LEFT JOIN turno on matricula.turno = turno.codigo ");
		str.append(" LEFT JOIN unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeEnsino ");
		str.append(" LEFT JOIN curso on curso.codigo = matricula.curso ");

		str.append(" LEFT JOIN periodoLetivo as periodoLetivoMatrizCurricular on historico.periodoLetivoMatrizCurricular = periodoLetivoMatrizCurricular.codigo ");
		str.append(" LEFT JOIN periodoLetivo as periodoLetivoCursada on historico.periodoLetivoCursada = periodoLetivoCursada.codigo ");
		str.append(" LEFT JOIN gradeCurricular as matrizCurricular on matricula.gradecurricularatual = matrizCurricular.codigo ");

		str.append(" LEFT JOIN configuracaoAcademico on configuracaoAcademico.codigo = historico.configuracaoAcademico ");

		return str;
	}


	public List<HistoricoVO> montarDadosConsultaRapida(SqlRowSet tabelaResultado, UsuarioVO usuario) throws Exception {
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			montarDadosBasico(obj, tabelaResultado, usuario);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<HistoricoVO> montarDadosConsultaCompleta(SqlRowSet tabelaResultado, UsuarioVO usuario) throws Exception {
		return montarDadosConsultaCompleta(tabelaResultado, false, usuario);
	}

	public List<HistoricoVO> montarDadosConsultaCompleta(SqlRowSet tabelaResultado, boolean filtroVisaoProfessor, UsuarioVO usuario) throws Exception {
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			montarDadosCompleto(obj, tabelaResultado, filtroVisaoProfessor, false, false, usuario);
			carregarDadosNotaConceitoHistorico(obj);
			vetResultado.add(obj);
		}
//		getFacadeFactory().getHistoricoNotaParcialInterfaceFacade().carregarHistoricoNotaParcialPorHistorico(vetResultado, Uteis.NIVELMONTARDADOS_DADOSBASICOS);
		return vetResultado;
	}

	public HistoricoVO consultarPorChavePrimaria(Integer codigoHistorico, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		HistoricoVO obj = new HistoricoVO();
		obj.setCodigo(codigoHistorico);
		carregarDados(obj, nivelMontarDados, usuario);
		return obj;
	}

	public void carregarDados(HistoricoVO obj, UsuarioVO usuario) throws Exception {
		carregarDados((HistoricoVO) obj, NivelMontarDados.TODOS, usuario);
	}

	/**
	 * Consulta que espera um ResultSet com os campos mínimos para uma consulta
	 * rápida e intelegente. Desta maneira, a mesma será sempre capaz de montar
	 * os atributos básicos do objeto e alguns atributos relacionados de
	 * relevância para o contexto da aplicação.
	 *
	 * @param obj
	 * @throws Exception
	 */
	private void montarDadosBasico(HistoricoVO obj, SqlRowSet dadosSQL, UsuarioVO usuario) throws Exception {
		// Dados do Historico
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setTipoHistorico(dadosSQL.getString("tipoHistorico"));
		obj.setHistoricoDisciplinaFazParteComposicao(dadosSQL.getBoolean("historicoDisciplinaFazParteComposicao"));
		obj.getMatrizCurricular().setCodigo(dadosSQL.getInt("historico.matrizcurricular"));
		obj.setCargaHorariaDisciplina(dadosSQL.getInt("historico.cargahorariadisciplina"));
		obj.setCreditoDisciplina(dadosSQL.getInt("historico.creditoDisciplina"));
		obj.setFreguencia(dadosSQL.getDouble("historico.freguencia"));
		if(dadosSQL.getObject("historico.mediafinal") != null){
			obj.setMediaFinal(dadosSQL.getDouble("historico.mediafinal"));
		}
		obj.setAnoHistorico(dadosSQL.getString("historico.anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("historico.semestreHistorico"));
		obj.setDataInicioAula(dadosSQL.getDate("historico.dataInicioAula"));
		obj.setDataFimAula(dadosSQL.getDate("historico.dataFimAula"));
		// Periodos letivos
		obj.getPeriodoLetivoCursada().setCodigo(dadosSQL.getInt("historico.periodoLetivoCursada"));
		obj.getPeriodoLetivoMatrizCurricular().setCodigo(dadosSQL.getInt("historico.periodoLetivoMatrizCurricular"));
		// Dados da Matricula
		obj.getMatricula().setMatricula(dadosSQL.getString("historico.matricula"));
		// Dados da Disciplina
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina.codigo")));
		obj.getDisciplina().setNome(dadosSQL.getString("disciplina.nome"));
		// Dados da Matricula Periodo
		obj.getMatriculaPeriodo().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodo.codigo")));
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));

	}

	/**
	 * Consulta que espera um ResultSet com todos os campos e dados de objetos
	 * relacionados, Para reconstituir o objeto por completo, de uma determinada
	 * entidade.
	 *
	 * @param obj
	 * @throws Exception
	 */
	private void montarDadosCompleto(HistoricoVO obj, SqlRowSet dadosSQL, UsuarioVO usuario) throws Exception {
		montarDadosCompleto(obj, dadosSQL, false, true, true,  usuario);
	}


	private void montarDadosCompleto(HistoricoVO obj, SqlRowSet dadosSQL, boolean filtroVisaoProfessor, boolean carregarDadosNotaConceito, boolean carregarDadosNotaParcial, UsuarioVO usuario) throws Exception {
		// AO ADICIONAR CAMPOS NESTE MONTAR DADOS VERIFICAR OS SQL DOS METODOS: 
				// getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica, 
				// consultaRapidaPorTurmaUnidadeEnsinoCursoDisciplinaAnoSemestreDataHistoricoOrdenarDisciplina
				// getSQLPadraoConsultaCompleta
		
		// Dados do Historico
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));

		obj.setTipoHistorico(dadosSQL.getString("tipoHistorico"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setAnoHistorico(dadosSQL.getString("anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestreHistorico"));
		obj.setFreguencia(new Double(dadosSQL.getDouble("freguencia")));
		obj.setDataRegistro(dadosSQL.getDate("dataRegistro"));
		obj.setInstituicao(dadosSQL.getString("instituicao"));
		obj.setCargaHorariaAproveitamentoDisciplina(dadosSQL.getInt("cargaHorariaAproveitamentoDisciplina"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaCursada"));
		obj.setCargaHorariaDisciplina(dadosSQL.getInt("cargaHorariaDisciplina"));
		obj.setCreditoDisciplina(dadosSQL.getInt("creditoDisciplina"));
		obj.getCidadeVO().setCodigo(dadosSQL.getInt("cidade"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("utilizaNotaFinalConceito"));
		obj.setNotaFinalConceito(dadosSQL.getString("notaFinalConceito"));
		obj.setHistoricoCriterioAvaliacaoAluno(dadosSQL.getBoolean("historicoCriterioAvaliacaoAluno"));
		obj.getCriterioAvaliacao().setCodigo(dadosSQL.getInt("criterioAvaliacao"));
		obj.setNumeroAgrupamentoEquivalenciaDisciplina(dadosSQL.getInt("numeroAgrupamentoEquivalenciaDisciplina"));
		obj.setEmRecuperacao(dadosSQL.getBoolean("emrecuperacao"));
		obj.setDataInicioAula(dadosSQL.getDate("historico.dataInicioAula"));
		obj.setDataFimAula(dadosSQL.getDate("historico.dataFimAula"));
		// DADOS GRADE DISCIPLINA
		obj.getGradeDisciplinaVO().setCodigo(dadosSQL.getInt("gradedisciplina.codigo"));
		obj.getGradeDisciplinaVO().getDisciplina().setCodigo(dadosSQL.getInt("gradedisciplina.disciplina"));
		obj.getGradeDisciplinaVO().setDiversificada(dadosSQL.getBoolean("gradedisciplina.diversificada"));
		obj.getGradeDisciplinaVO().setDisciplinaComposta(dadosSQL.getBoolean("gradedisciplina.disciplinaComposta"));
		obj.getGradeDisciplinaVO().setCargaHoraria(new Integer(dadosSQL.getInt("gradedisciplina.cargaHoraria")));
		obj.getGradeDisciplinaVO().setCargaHorariaPratica(dadosSQL.getInt("gradedisciplina.cargaHorariapratica"));
		obj.getGradeDisciplinaVO().setCargaHorariaTeorica(obj.getGradeDisciplinaVO().getCargaHoraria() - obj.getGradeDisciplinaVO().getCargaHorariaPratica());
		obj.getGradeDisciplinaVO().setNrCreditos(new Integer(dadosSQL.getInt("gradedisciplina.nrCreditos")));
		obj.getGradeDisciplinaVO().setHoraAula(new Integer(dadosSQL.getInt("gradedisciplina.horaAula")));
		obj.getGradeDisciplinaVO().getDisciplinaEixoTematico().setCodigo(new Integer(dadosSQL.getInt("gradedisciplina.disciplinaEixoTematico")));
		obj.getGradeDisciplinaVO().setControlarRecuperacaoPelaDisciplinaPrincipal(dadosSQL.getBoolean("gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal"));
		obj.getGradeDisciplinaVO().setVariavelNotaRecuperacao(dadosSQL.getString("gradedisciplina.variavelNotaRecuperacao"));
		obj.getGradeDisciplinaVO().setCondicaoUsoRecuperacao(dadosSQL.getString("gradedisciplina.condicaoUsoRecuperacao"));
		obj.getGradeDisciplinaVO().setVariavelNotaCondicaoUsoRecuperacao(dadosSQL.getString("gradedisciplina.variavelNotaCondicaoUsoRecuperacao"));
		obj.getGradeDisciplinaVO().setFormulaCalculoNotaRecuperada(dadosSQL.getString("gradedisciplina.formulaCalculoNotaRecuperada"));
		obj.getGradeDisciplinaVO().setVariavelNotaFormulaCalculoNotaRecuperada(dadosSQL.getString("gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada"));
		obj.getGradeDisciplinaVO().setFormulaCalculoNotaRecuperacao(dadosSQL.getString("gradedisciplina.formulaCalculoNotaRecuperacao"));

		if (Uteis.isAtributoPreenchido(dadosSQL.getString("gradedisciplina.formulaCalculoNota"))) {
			obj.getGradeDisciplinaVO().setFormulaCalculoNota(FormulaCalculoNotaEnum.getEnum(dadosSQL.getString("gradedisciplina.formulaCalculoNota")));
			obj.getGradeDisciplinaVO().setFormulaCalculo(dadosSQL.getString("gradedisciplina.formulaCalculo"));
		}
		// DADOS GRADE CURRICULAR GRUPO OPTATIVA DISCIPLINA
		obj.setDisciplinaReferenteAUmGrupoOptativa(dadosSQL.getBoolean("historico.disciplinaReferenteAUmGrupoOptativa"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setCodigo(dadosSQL.getInt("historico.gradeCurricularGrupoOptativaDisciplina"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setCargaHoraria(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.cargaHoraria"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setCargaHorariaPratica(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.cargaHorariaPratica"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setNrCreditos(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.nrCreditos"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setHoraAula(dadosSQL.getInt("gcgod.horaAula"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().getDisciplina().setCodigo(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.disciplina"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setDiversificada(dadosSQL.getBoolean("gradeCurricularGrupoOptativaDisciplina.diversificada"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setDisciplinaComposta(dadosSQL.getBoolean("gradeCurricularGrupoOptativaDisciplina.disciplinaComposta"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setControlarRecuperacaoPelaDisciplinaPrincipal(dadosSQL.getBoolean("gcgod.controlarRecuperacaoPelaDisciplinaPrincipal"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setVariavelNotaRecuperacao(dadosSQL.getString("gcgod.variavelNotaRecuperacao"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setCondicaoUsoRecuperacao(dadosSQL.getString("gcgod.condicaoUsoRecuperacao"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setVariavelNotaCondicaoUsoRecuperacao(dadosSQL.getString("gcgod.variavelNotaCondicaoUsoRecuperacao"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setFormulaCalculoNotaRecuperada(dadosSQL.getString("gcgod.formulaCalculoNotaRecuperada"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setVariavelNotaFormulaCalculoNotaRecuperada(dadosSQL.getString("gcgod.variavelNotaFormulaCalculoNotaRecuperada"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setFormulaCalculoNotaRecuperacao(dadosSQL.getString("gcgod.formulaCalculoNotaRecuperacao"));
		if (Uteis.isAtributoPreenchido(dadosSQL.getString("gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota"))) {
			obj.getGradeCurricularGrupoOptativaDisciplinaVO().setFormulaCalculoNota(FormulaCalculoNotaEnum.getEnum(dadosSQL.getString("gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota")));
			obj.getGradeCurricularGrupoOptativaDisciplinaVO().setFormulaCalculo(dadosSQL.getString("gradeCurricularGrupoOptativaDisciplina.formulaCalculo"));
		}
		if (obj.getDisciplinaReferenteAUmGrupoOptativa()) {
			// quando trata-se de um grupo de optativa, o vinculo com
			// gradeDisciplina nao é necessário/aconselhável
			obj.setGradeDisciplinaVO(null);
		}

		// DADOS DISCIPLINA COMPOSTA
		obj.setHistoricoDisciplinaFazParteComposicao(dadosSQL.getBoolean("historicoDisciplinaFazParteComposicao"));
		obj.setHistoricoDisciplinaComposta(dadosSQL.getBoolean("historico.historicoDisciplinaComposta"));
		obj.getGradeDisciplinaComposta().setCodigo(dadosSQL.getInt("historico.gradeDisciplinaComposta"));
		obj.getGradeDisciplinaComposta().setVariavelNota(dadosSQL.getString("gradeDisciplinaComposta.variavelNota"));
		obj.getGradeDisciplinaComposta().setOrdem(dadosSQL.getInt("gradeDisciplinaComposta.ordem"));
		obj.getGradeDisciplinaComposta().setHoraAula(dadosSQL.getInt("gradeDisciplinaComposta.horaAula"));
		obj.getGradeDisciplinaComposta().setCargaHoraria(dadosSQL.getInt("gradeDisciplinaComposta.cargahoraria"));
		obj.getGradeDisciplinaComposta().setNrCreditos(dadosSQL.getInt("gradeDisciplinaComposta.nrcreditos"));
		obj.getGradeDisciplinaComposta().setCargaHorariaPratica(dadosSQL.getInt("gradeDisciplinaComposta.cargahorariaPratica"));
		obj.getGradeDisciplinaComposta().setCargaHorariaTeorica(dadosSQL.getInt("gradeDisciplinaComposta.cargahorariaTeorica"));

		// DADOS EQUIVALENCIA
		obj.setHistoricoPorEquivalencia(dadosSQL.getBoolean("historico.historicoPorEquivalencia"));
		obj.setHistoricoEquivalente(dadosSQL.getBoolean("historico.historicoEquivalente"));
		obj.getMapaEquivalenciaDisciplina().setCodigo(dadosSQL.getInt("historico.mapaEquivalenciaDisciplina"));
		obj.getMapaEquivalenciaDisciplinaCursada().setCodigo(dadosSQL.getInt("historico.mapaEquivalenciaDisciplinaCursada"));
		obj.getMapaEquivalenciaDisciplinaMatrizCurricular().setCodigo(dadosSQL.getInt("historico.mapaEquivalenciaDisciplinaMatrizCurricular"));

		// DADOS TRASNFERENCIA MATRIZ CURRICULAR
		obj.getTransferenciaMatrizCurricularMatricula().setCodigo(dadosSQL.getInt("historico.transferenciaMatrizCurricularMatricula"));
		obj.setHistoricoGeradoAPartirTransferenciaMatrizCurricular(dadosSQL.getBoolean("historico.historicoGeradoAPartirTransferenciaMatrizCurricular"));
		obj.setObservacaoTransferenciaMatrizCurricular(dadosSQL.getString("historico.observacaoTransferenciaMatrizCurricular"));
		obj.setHistoricoCursandoPorCorrespondenciaAposTransferencia(dadosSQL.getBoolean("historico.historicoCursandoPorCorrespondenciaAposTransferencia"));

		if (dadosSQL.getObject("nota1") == null) {
			obj.setNota1((Double) dadosSQL.getObject("nota1"));
		} else {
			obj.setNota1(dadosSQL.getDouble("nota1"));
		}
		if (dadosSQL.getObject("nota2") == null) {
			obj.setNota2((Double) dadosSQL.getObject("nota2"));
		} else {
			obj.setNota2(dadosSQL.getDouble("nota2"));
		}
		if (dadosSQL.getObject("nota3") == null) {
			obj.setNota3((Double) dadosSQL.getObject("nota3"));
		} else {
			obj.setNota3(dadosSQL.getDouble("nota3"));
		}
		if (dadosSQL.getObject("nota4") == null) {
			obj.setNota4((Double) dadosSQL.getObject("nota4"));
		} else {
			obj.setNota4(dadosSQL.getDouble("nota4"));
		}
		if (dadosSQL.getObject("nota5") == null) {
			obj.setNota5((Double) dadosSQL.getObject("nota5"));
		} else {
			obj.setNota5(dadosSQL.getDouble("nota5"));
		}
		if (dadosSQL.getObject("nota6") == null) {
			obj.setNota6((Double) dadosSQL.getObject("nota6"));
		} else {
			obj.setNota6(dadosSQL.getDouble("nota6"));
		}
		if (dadosSQL.getObject("nota7") == null) {
			obj.setNota7((Double) dadosSQL.getObject("nota7"));
		} else {
			obj.setNota7(dadosSQL.getDouble("nota7"));
		}
		if (dadosSQL.getObject("nota8") == null) {
			obj.setNota8((Double) dadosSQL.getObject("nota8"));
		} else {
			obj.setNota8(dadosSQL.getDouble("nota8"));
		}
		if (dadosSQL.getObject("nota9") == null) {
			obj.setNota9((Double) dadosSQL.getObject("nota9"));
		} else {
			obj.setNota9(dadosSQL.getDouble("nota9"));
		}
		if (dadosSQL.getObject("nota10") == null) {
			obj.setNota10((Double) dadosSQL.getObject("nota10"));
		} else {
			obj.setNota10(dadosSQL.getDouble("nota10"));
		}
		if (dadosSQL.getObject("nota11") == null) {
			obj.setNota11((Double) dadosSQL.getObject("nota11"));
		} else {
			obj.setNota11(dadosSQL.getDouble("nota11"));
		}
		if (dadosSQL.getObject("nota12") == null) {
			obj.setNota12((Double) dadosSQL.getObject("nota12"));
		} else {
			obj.setNota12(dadosSQL.getDouble("nota12"));
		}
		if (dadosSQL.getObject("nota13") == null) {
			obj.setNota13((Double) dadosSQL.getObject("nota13"));
		} else {
			obj.setNota13(dadosSQL.getDouble("nota13"));
		}

		obj.setNota1Lancada(dadosSQL.getBoolean("nota1Lancada"));
		obj.setNota2Lancada(dadosSQL.getBoolean("nota2Lancada"));
		obj.setNota3Lancada(dadosSQL.getBoolean("nota3Lancada"));
		obj.setNota4Lancada(dadosSQL.getBoolean("nota4Lancada"));
		obj.setNota5Lancada(dadosSQL.getBoolean("nota5Lancada"));
		obj.setNota6Lancada(dadosSQL.getBoolean("nota6Lancada"));
		obj.setNota7Lancada(dadosSQL.getBoolean("nota7Lancada"));
		obj.setNota8Lancada(dadosSQL.getBoolean("nota8Lancada"));
		obj.setNota9Lancada(dadosSQL.getBoolean("nota9Lancada"));
		obj.setNota10Lancada(dadosSQL.getBoolean("nota10Lancada"));
		obj.setNota11Lancada(dadosSQL.getBoolean("nota11Lancada"));
		obj.setNota12Lancada(dadosSQL.getBoolean("nota12Lancada"));
		obj.setNota13Lancada(dadosSQL.getBoolean("nota13Lancada"));

		if (dadosSQL.getObject("nota14") == null) {
			obj.setNota14((Double) dadosSQL.getObject("nota14"));
		} else {
			obj.setNota14(dadosSQL.getDouble("nota14"));
		}
		obj.setNota14Lancada(dadosSQL.getBoolean("nota14Lancada"));

		if (dadosSQL.getObject("nota15") == null) {
			obj.setNota15((Double) dadosSQL.getObject("nota15"));
		} else {
			obj.setNota15(dadosSQL.getDouble("nota15"));
		}
		obj.setNota15Lancada(dadosSQL.getBoolean("nota15Lancada"));

		if (dadosSQL.getObject("nota16") == null) {
			obj.setNota16((Double) dadosSQL.getObject("nota16"));
		} else {
			obj.setNota16(dadosSQL.getDouble("nota16"));
		}
		obj.setNota16Lancada(dadosSQL.getBoolean("nota16Lancada"));

		if (dadosSQL.getObject("nota17") == null) {
			obj.setNota17((Double) dadosSQL.getObject("nota17"));
		} else {
			obj.setNota17(dadosSQL.getDouble("nota17"));
		}
		obj.setNota17Lancada(dadosSQL.getBoolean("nota17Lancada"));

		if (dadosSQL.getObject("nota18") == null) {
			obj.setNota18((Double) dadosSQL.getObject("nota18"));
		} else {
			obj.setNota18(dadosSQL.getDouble("nota18"));
		}
		obj.setNota18Lancada(dadosSQL.getBoolean("nota18Lancada"));

		if (dadosSQL.getObject("nota19") == null) {
			obj.setNota19((Double) dadosSQL.getObject("nota19"));
		} else {
			obj.setNota19(dadosSQL.getDouble("nota19"));
		}
		obj.setNota19Lancada(dadosSQL.getBoolean("nota19Lancada"));

		if (dadosSQL.getObject("nota20") == null) {
			obj.setNota20((Double) dadosSQL.getObject("nota20"));
		} else {
			obj.setNota20(dadosSQL.getDouble("nota20"));
		}
		obj.setNota20Lancada(dadosSQL.getBoolean("nota20Lancada"));

		if (dadosSQL.getObject("nota21") == null) {
			obj.setNota21((Double) dadosSQL.getObject("nota21"));
		} else {
			obj.setNota21(dadosSQL.getDouble("nota21"));
		}
		obj.setNota21Lancada(dadosSQL.getBoolean("nota21Lancada"));

		if (dadosSQL.getObject("nota22") == null) {
			obj.setNota22((Double) dadosSQL.getObject("nota22"));
		} else {
			obj.setNota22(dadosSQL.getDouble("nota22"));
		}
		obj.setNota22Lancada(dadosSQL.getBoolean("nota22Lancada"));

		if (dadosSQL.getObject("nota23") == null) {
			obj.setNota23((Double) dadosSQL.getObject("nota23"));
		} else {
			obj.setNota23(dadosSQL.getDouble("nota23"));
		}
		obj.setNota23Lancada(dadosSQL.getBoolean("nota23Lancada"));

		if (dadosSQL.getObject("nota24") == null) {
			obj.setNota24((Double) dadosSQL.getObject("nota24"));
		} else {
			obj.setNota24(dadosSQL.getDouble("nota24"));
		}
		obj.setNota24Lancada(dadosSQL.getBoolean("nota24Lancada"));

		if (dadosSQL.getObject("nota25") == null) {
			obj.setNota25((Double) dadosSQL.getObject("nota25"));
		} else {
			obj.setNota25(dadosSQL.getDouble("nota25"));
		}
		obj.setNota25Lancada(dadosSQL.getBoolean("nota25Lancada"));

		if (dadosSQL.getObject("nota26") == null) {
			obj.setNota26((Double) dadosSQL.getObject("nota26"));
		} else {
			obj.setNota26(dadosSQL.getDouble("nota26"));
		}
		obj.setNota26Lancada(dadosSQL.getBoolean("nota26Lancada"));

		if (dadosSQL.getObject("nota27") == null) {
			obj.setNota27((Double) dadosSQL.getObject("nota27"));
		} else {
			obj.setNota27(dadosSQL.getDouble("nota27"));
		}
		obj.setNota27Lancada(dadosSQL.getBoolean("nota27Lancada"));

		if (dadosSQL.getObject("nota28") == null) {
			obj.setNota28((Double) dadosSQL.getObject("nota28"));
		} else {
			obj.setNota28(dadosSQL.getDouble("nota28"));
		}
		obj.setNota28Lancada(dadosSQL.getBoolean("nota28Lancada"));

		if (dadosSQL.getObject("nota29") == null) {
			obj.setNota29((Double) dadosSQL.getObject("nota29"));
		} else {
			obj.setNota29(dadosSQL.getDouble("nota29"));
		}
		obj.setNota29Lancada(dadosSQL.getBoolean("nota29Lancada"));

		if (dadosSQL.getObject("nota30") == null) {
			obj.setNota30((Double) dadosSQL.getObject("nota30"));
		} else {
			obj.setNota30(dadosSQL.getDouble("nota30"));
		}
		obj.setNota30Lancada(dadosSQL.getBoolean("nota30Lancada"));

		if (dadosSQL.getObject("nota31") == null) {
			obj.setNota31((Double) dadosSQL.getObject("nota31"));
		} else {
			obj.setNota31(dadosSQL.getDouble("nota31"));
		}
		obj.setNota31Lancada(dadosSQL.getBoolean("nota31Lancada"));

		if (dadosSQL.getObject("nota32") == null) {
			obj.setNota32((Double) dadosSQL.getObject("nota32"));
		} else {
			obj.setNota32(dadosSQL.getDouble("nota32"));
		}
		obj.setNota32Lancada(dadosSQL.getBoolean("nota32Lancada"));

		if (dadosSQL.getObject("nota33") == null) {
			obj.setNota33((Double) dadosSQL.getObject("nota33"));
		} else {
			obj.setNota33(dadosSQL.getDouble("nota33"));
		}
		obj.setNota33Lancada(dadosSQL.getBoolean("nota33Lancada"));

		if (dadosSQL.getObject("nota34") == null) {
			obj.setNota34((Double) dadosSQL.getObject("nota34"));
		} else {
			obj.setNota34(dadosSQL.getDouble("nota34"));
		}
		obj.setNota34Lancada(dadosSQL.getBoolean("nota34Lancada"));

		if (dadosSQL.getObject("nota35") == null) {
			obj.setNota35((Double) dadosSQL.getObject("nota35"));
		} else {
			obj.setNota35(dadosSQL.getDouble("nota35"));
		}
		obj.setNota35Lancada(dadosSQL.getBoolean("nota35Lancada"));

		if (dadosSQL.getObject("nota36") == null) {
			obj.setNota36((Double) dadosSQL.getObject("nota36"));
		} else {
			obj.setNota36(dadosSQL.getDouble("nota36"));
		}
		obj.setNota36Lancada(dadosSQL.getBoolean("nota36Lancada"));

		if (dadosSQL.getObject("nota37") == null) {
			obj.setNota37((Double) dadosSQL.getObject("nota37"));
		} else {
			obj.setNota37(dadosSQL.getDouble("nota37"));
		}
		obj.setNota37Lancada(dadosSQL.getBoolean("nota37Lancada"));

		if (dadosSQL.getObject("nota38") == null) {
			obj.setNota38((Double) dadosSQL.getObject("nota38"));
		} else {
			obj.setNota38(dadosSQL.getDouble("nota38"));
		}
		obj.setNota38Lancada(dadosSQL.getBoolean("nota38Lancada"));

		if (dadosSQL.getObject("nota39") == null) {
			obj.setNota39((Double) dadosSQL.getObject("nota39"));
		} else {
			obj.setNota39(dadosSQL.getDouble("nota39"));
		}
		obj.setNota39Lancada(dadosSQL.getBoolean("nota39Lancada"));

		if (dadosSQL.getObject("nota40") == null) {
			obj.setNota40((Double) dadosSQL.getObject("nota40"));
		} else {
			obj.setNota40(dadosSQL.getDouble("nota40"));
		}
		obj.setNota40Lancada(dadosSQL.getBoolean("nota40Lancada"));
		obj.setApresentarAprovadoHistorico(dadosSQL.getBoolean("apresentarAprovadoHistorico"));
		obj.setUpdated(dadosSQL.getTimestamp("updated"));

		// manter este sempre antes de montar a mediaFinal
		// *****************************************************
		if (dadosSQL.getObject("mediaFinal") == null) {
			obj.setMediaFinal((Double) dadosSQL.getObject("mediaFinal"));
		} else {
			obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		}
		obj.getMediaFinalConceito().setCodigo(dadosSQL.getInt("mediaFinalConceito"));
		obj.getNota1Conceito().setCodigo(dadosSQL.getInt("nota1Conceito"));
		obj.getNota2Conceito().setCodigo(dadosSQL.getInt("nota2Conceito"));
		obj.getNota3Conceito().setCodigo(dadosSQL.getInt("nota3Conceito"));
		obj.getNota4Conceito().setCodigo(dadosSQL.getInt("nota4Conceito"));
		obj.getNota5Conceito().setCodigo(dadosSQL.getInt("nota5Conceito"));
		obj.getNota6Conceito().setCodigo(dadosSQL.getInt("nota6Conceito"));
		obj.getNota7Conceito().setCodigo(dadosSQL.getInt("nota7Conceito"));
		obj.getNota8Conceito().setCodigo(dadosSQL.getInt("nota8Conceito"));
		obj.getNota9Conceito().setCodigo(dadosSQL.getInt("nota9Conceito"));
		obj.getNota10Conceito().setCodigo(dadosSQL.getInt("nota10Conceito"));
		obj.getNota11Conceito().setCodigo(dadosSQL.getInt("nota11Conceito"));
		obj.getNota12Conceito().setCodigo(dadosSQL.getInt("nota12Conceito"));
		obj.getNota13Conceito().setCodigo(dadosSQL.getInt("nota13Conceito"));
		obj.getNota14Conceito().setCodigo(dadosSQL.getInt("nota14Conceito"));
		obj.getNota15Conceito().setCodigo(dadosSQL.getInt("nota15Conceito"));
		obj.getNota16Conceito().setCodigo(dadosSQL.getInt("nota16Conceito"));
		obj.getNota17Conceito().setCodigo(dadosSQL.getInt("nota17Conceito"));
		obj.getNota18Conceito().setCodigo(dadosSQL.getInt("nota18Conceito"));
		obj.getNota19Conceito().setCodigo(dadosSQL.getInt("nota19Conceito"));
		obj.getNota20Conceito().setCodigo(dadosSQL.getInt("nota20Conceito"));
		obj.getNota21Conceito().setCodigo(dadosSQL.getInt("nota21Conceito"));
		obj.getNota22Conceito().setCodigo(dadosSQL.getInt("nota22Conceito"));
		obj.getNota23Conceito().setCodigo(dadosSQL.getInt("nota23Conceito"));
		obj.getNota24Conceito().setCodigo(dadosSQL.getInt("nota24Conceito"));
		obj.getNota25Conceito().setCodigo(dadosSQL.getInt("nota25Conceito"));
		obj.getNota26Conceito().setCodigo(dadosSQL.getInt("nota26Conceito"));
		obj.getNota27Conceito().setCodigo(dadosSQL.getInt("nota27Conceito"));
		obj.getNota28Conceito().setCodigo(dadosSQL.getInt("nota28Conceito"));
		obj.getNota29Conceito().setCodigo(dadosSQL.getInt("nota29Conceito"));
		obj.getNota30Conceito().setCodigo(dadosSQL.getInt("nota30Conceito"));
		obj.getNota31Conceito().setCodigo(dadosSQL.getInt("nota31Conceito"));
		obj.getNota32Conceito().setCodigo(dadosSQL.getInt("nota32Conceito"));
		obj.getNota33Conceito().setCodigo(dadosSQL.getInt("nota33Conceito"));
		obj.getNota34Conceito().setCodigo(dadosSQL.getInt("nota34Conceito"));
		obj.getNota35Conceito().setCodigo(dadosSQL.getInt("nota35Conceito"));
		obj.getNota36Conceito().setCodigo(dadosSQL.getInt("nota36Conceito"));
		obj.getNota37Conceito().setCodigo(dadosSQL.getInt("nota37Conceito"));
		obj.getNota38Conceito().setCodigo(dadosSQL.getInt("nota38Conceito"));
		obj.getNota39Conceito().setCodigo(dadosSQL.getInt("nota39Conceito"));
		obj.getNota40Conceito().setCodigo(dadosSQL.getInt("nota40Conceito"));
		// ****************************************************************************************************
		obj.setIsentarMediaFinal(dadosSQL.getBoolean("isentarMediaFinal"));
		// obj.setMediaFinal(new Double(dadosSQL.getDouble("mediaFinal")));
		// obj.setCargaHoraria(new Double(dadosSQL.getDouble("cargaHoraria")));
		obj.setTransferenciaEntradaDisciplinasAproveitadas(new Integer(dadosSQL.getInt("transferenciaEntradaDisciplinasAproveitadas")));
		obj.setDisciplinasAproveitadas(dadosSQL.getInt("disciplinasAproveitadas"));

		// Dados do Configuracao Academico
		obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("configuracaoAcademico.codigo"));
		obj.getConfiguracaoAcademico().setNome(dadosSQL.getString("configuracaoAcademico.nome"));


		obj.setConfiguracaoAcademico(getAplicacaoControle().carregarDadosConfiguracaoAcademica(obj.getConfiguracaoAcademico().getCodigo()));

		obj.setObservacao(dadosSQL.getString("historico.observacao"));
		obj.setHistoricoDisciplinaAtividadeComplementar(dadosSQL.getBoolean("historico.historicoDisciplinaAtividadeComplementar"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("historico.cargaHorariaDisciplina"));
		obj.setCreditoDisciplina(dadosSQL.getInt("historico.creditoDisciplina"));
		obj.setHistoricoDisciplinaOptativa(dadosSQL.getBoolean("historico.historicoDisciplinaOptativa"));
		obj.setHistoricoDisciplinaForaGrade(dadosSQL.getBoolean("historico.historicoDisciplinaForaGrade"));
		obj.setNomeDisciplina(dadosSQL.getString("historico.nomeDisciplina"));
		obj.setHistoricoDisciplinaAproveitada(dadosSQL.getBoolean("historico.historicoDisciplinaAproveitada"));
		obj.setFaltaPrimeiroBimestre(dadosSQL.getInt("historico.faltaPrimeiroBimestre"));
		obj.setFaltaSegundoBimestre(dadosSQL.getInt("historico.faltaSegundoBimestre"));
		obj.setFaltaTerceiroBimestre(dadosSQL.getInt("historico.faltaTerceiroBimestre"));
		obj.setFaltaQuartoBimestre(dadosSQL.getInt("historico.faltaQuartoBimestre"));
		obj.setTotalFalta(dadosSQL.getInt("historico.totalFalta"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("historico.utilizaNotaFinalConceito"));
		obj.setNotaFinalConceito(dadosSQL.getString("historico.notaFinalConceito"));

		// Dados do Periodo Letivo Matriz Curricular
		obj.getPeriodoLetivoMatrizCurricular().setCodigo(dadosSQL.getInt("periodoLetivoMatrizCurricular.codigo"));
		obj.getPeriodoLetivoMatrizCurricular().setDescricao(dadosSQL.getString("periodoLetivoMatrizCurricular.descricao"));
		obj.getPeriodoLetivoMatrizCurricular().setPeriodoLetivo(dadosSQL.getInt("periodoLetivoMatrizCurricular.periodoLetivo"));

		// // Dados da Matriz Curricular
		// obj.getMatrizCurricular().setCodigo(dadosSQL.getInt("matrizCurricular.codigo"));
		// obj.getMatrizCurricular().setNome(dadosSQL.getString("matrizCurricular.nome"));

		// Dados da Matriz Curricular
		obj.getMatrizCurricular().setCodigo(dadosSQL.getInt("gradeCurricular.codigo"));
		obj.getMatrizCurricular().setNome(dadosSQL.getString("gradeCurricular.nome"));

		// Dados do Periodo Letivo Cursada
		obj.getPeriodoLetivoCursada().setCodigo(dadosSQL.getInt("periodoLetivoCursada.codigo"));
		obj.getPeriodoLetivoCursada().setDescricao(dadosSQL.getString("periodoLetivoCursada.descricao"));
		obj.getPeriodoLetivoCursada().setPeriodoLetivo(dadosSQL.getInt("periodoLetivoCursada.periodoLetivo"));

		// Dados do Matricula Periodo Turma Disciplina
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina.codigo")));
		obj.getMatriculaPeriodoTurmaDisciplina().setSemestre((dadosSQL.getString("matriculaPeriodoTurmaDisciplina.semestre")));
		obj.getMatriculaPeriodoTurmaDisciplina().setAno((dadosSQL.getString("matriculaPeriodoTurmaDisciplina.ano")));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setCodigo((dadosSQL.getInt("matriculaPeriodoTurmaDisciplina.turma")));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().setCodigo(dadosSQL.getInt("turmaTeorica"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().setCodigo(dadosSQL.getInt("turmaPratica"));
		// Dados do Matricula Periodo
		obj.getMatriculaPeriodo().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodo.codigo")));
		obj.getMatriculaPeriodo().setSituacao(dadosSQL.getString("matriculaPeriodo.situacao"));
		obj.getMatriculaPeriodo().setSituacaoMatriculaPeriodo(dadosSQL.getString("matriculaPeriodo.situacaoMatriculaPeriodo"));
		obj.getMatriculaPeriodo().setDataFechamentoMatriculaPeriodo(dadosSQL.getDate("matriculaPeriodo.datafechamentomatriculaperiodo"));
		obj.getMatriculaPeriodo().setData(dadosSQL.getDate("matriculaPeriodo.data"));
		// Dados da Grade Curricular
		obj.getMatriculaPeriodo().getGradeCurricular().setNome(dadosSQL.getString("gradeCurricular.nome"));
		// Dados do Periodo Letivo
		obj.getMatriculaPeriodo().getPeridoLetivo().setDescricao(dadosSQL.getString("periodoLetivo.descricao"));
		// Dados da Turma
		obj.getMatriculaPeriodo().getTurma().setIdentificadorTurma(dadosSQL.getString("turma.identificadorTurma"));
		// Dados da Matricula
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula.matricula"));
		obj.getMatricula().setUpdated(dadosSQL.getTimestamp("matricula.updated"));
		obj.getMatricula().setSituacao(dadosSQL.getString("matricula.situacao"));
		obj.getMatricula().setSituacaoFinanceira(dadosSQL.getString("matricula.situacaoFinanceira"));
		obj.getMatricula().setTipoMatricula(dadosSQL.getString("matricula.tipoMatricula"));
		obj.getMatricula().setCanceladoFinanceiro(dadosSQL.getBoolean("canceladoFinanceiro"));
		// Dados do Curso
		obj.getMatricula().getCurso().setNome(dadosSQL.getString("curso.nome"));
		// Dados do Turno
		obj.getMatricula().getTurno().setNome(dadosSQL.getString("turno.nome"));
		// Dados da Unidade Ensino
		obj.getMatricula().getUnidadeEnsino().setNome(dadosSQL.getString("unidadeEnsino.nome"));
		// Dados do Aluno
		obj.getMatricula().getAluno().setCodigo(new Integer(dadosSQL.getString("aluno.codigo")));
		obj.getMatricula().getAluno().setNome(dadosSQL.getString("aluno.nome"));
		// Dados do Usuario
		obj.getResponsavel().setCodigo(new Integer(dadosSQL.getInt("responsavel.codigo")));
		obj.getResponsavel().setNome(dadosSQL.getString("responsavel.nome"));
		// Dados da Disciplinas
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina.codigo")));
		obj.getDisciplina().setNome(dadosSQL.getString("disciplina.nome"));
		if (filtroVisaoProfessor) {
			obj.setNomeProfessor(usuario.getNome());
		}
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));

//		A PARTIR NOTA 31 MONTAR DADOS
		if (dadosSQL.getObject("nota31") == null) {
			obj.setNota31((Double) dadosSQL.getObject("nota31"));
		} else {
			obj.setNota31(dadosSQL.getDouble("nota31"));
		}
		obj.setNota31Lancada(dadosSQL.getBoolean("nota31Lancada"));

		if (dadosSQL.getObject("nota32") == null) {
			obj.setNota32((Double) dadosSQL.getObject("nota32"));
		} else {
			obj.setNota32(dadosSQL.getDouble("nota32"));
		}
		obj.setNota32Lancada(dadosSQL.getBoolean("nota32Lancada"));


		if (dadosSQL.getObject("nota33") == null) {
			obj.setNota33((Double) dadosSQL.getObject("nota33"));
		} else {
			obj.setNota33(dadosSQL.getDouble("nota33"));
		}
		obj.setNota33Lancada(dadosSQL.getBoolean("nota33Lancada"));


		if (dadosSQL.getObject("nota34") == null) {
			obj.setNota34((Double) dadosSQL.getObject("nota34"));
		} else {
			obj.setNota34(dadosSQL.getDouble("nota34"));
		}
		obj.setNota34Lancada(dadosSQL.getBoolean("nota34Lancada"));


		if (dadosSQL.getObject("nota35") == null) {
			obj.setNota35((Double) dadosSQL.getObject("nota35"));
		} else {
			obj.setNota35(dadosSQL.getDouble("nota35"));
		}
		obj.setNota35Lancada(dadosSQL.getBoolean("nota35Lancada"));


		if (dadosSQL.getObject("nota36") == null) {
			obj.setNota36((Double) dadosSQL.getObject("nota36"));
		} else {
			obj.setNota36(dadosSQL.getDouble("nota36"));
		}
		obj.setNota36Lancada(dadosSQL.getBoolean("nota36Lancada"));


		if (dadosSQL.getObject("nota37") == null) {
			obj.setNota37((Double) dadosSQL.getObject("nota37"));
		} else {
			obj.setNota37(dadosSQL.getDouble("nota37"));
		}
		obj.setNota37Lancada(dadosSQL.getBoolean("nota37Lancada"));


		if (dadosSQL.getObject("nota38") == null) {
			obj.setNota38((Double) dadosSQL.getObject("nota38"));
		} else {
			obj.setNota38(dadosSQL.getDouble("nota38"));
		}
		obj.setNota38Lancada(dadosSQL.getBoolean("nota38Lancada"));


		if (dadosSQL.getObject("nota39") == null) {
			obj.setNota39((Double) dadosSQL.getObject("nota39"));
		} else {
			obj.setNota39(dadosSQL.getDouble("nota39"));
		}
		obj.setNota39Lancada(dadosSQL.getBoolean("nota39Lancada"));


		if (dadosSQL.getObject("nota40") == null) {
			obj.setNota40((Double) dadosSQL.getObject("nota40"));
		} else {
			obj.setNota40(dadosSQL.getDouble("nota40"));
		}
		obj.setNota40Lancada(dadosSQL.getBoolean("nota40Lancada"));
		if(carregarDadosNotaConceito) {
			carregarDadosNotaConceitoHistorico(obj);
		}
		if(carregarDadosNotaParcial) {
			carregarDadosHistoricoNotaParcial(obj, usuario);
		}

	}

	private void montarDadosCompletoDataOrdenacaoDisciplina(HistoricoVO obj, SqlRowSet dadosSQL, boolean historicoTurmaRel, UsuarioVO usuario) throws Exception {
		// Dados do Historico
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.setCargaHorariaDisciplina(dadosSQL.getInt("cargaHorariaDisciplina"));
		obj.setTipoHistorico(dadosSQL.getString("tipoHistorico"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setEmRecuperacao(dadosSQL.getBoolean("emRecuperacao"));
		obj.setAnoHistorico(dadosSQL.getString("anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestreHistorico"));
		obj.setFreguencia(new Double(dadosSQL.getDouble("freguencia")));
		obj.setDataRegistro(dadosSQL.getDate("dataRegistro"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("utilizaNotaFinalConceito"));
		obj.setNotaFinalConceito(dadosSQL.getString("notaFinalConceito"));
		obj.setCargaHorariaAproveitamentoDisciplina(dadosSQL.getInt("cargaHorariaAproveitamentoDisciplina"));
		obj.setNumeroAgrupamentoEquivalenciaDisciplina(dadosSQL.getInt("numeroAgrupamentoEquivalenciaDisciplina"));
		obj.setTotalFalta(dadosSQL.getInt("totalfalta"));
		// DADOS DISCIPLINA
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina.codigo")));
		obj.getDisciplina().setNome(dadosSQL.getString("disciplina.nome"));
		obj.getDisciplina().setAbreviatura(dadosSQL.getString("disciplina.abreviatura"));
		if(obj.getDisciplina().getNome().contains(obj.getDisciplina().getAbreviatura())) {
		obj.getDisciplina().setNomeMinhasNotasAluno(dadosSQL.getString("disciplina.nome"));
		}else {			
			obj.getDisciplina().setNomeMinhasNotasAluno(dadosSQL.getString("disciplina.abreviatura") +" - "+ dadosSQL.getString("disciplina.nome"));
		}
		obj.setDataInicioModulo((Uteis.getData(dadosSQL.getDate("aula.datainicio"))));
		// DADOS GRADE DISCIPLINA
		obj.getGradeDisciplinaVO().setCodigo(dadosSQL.getInt("gradedisciplina.codigo"));
		obj.getGradeDisciplinaVO().getDisciplina().setCodigo(dadosSQL.getInt("gradedisciplina.disciplina"));
		obj.getGradeDisciplinaVO().setDiversificada(dadosSQL.getBoolean("gradedisciplina.diversificada"));
		obj.getGradeDisciplinaVO().setDisciplinaComposta(dadosSQL.getBoolean("gradedisciplina.disciplinaComposta"));
		obj.getGradeDisciplinaVO().setCargaHoraria(new Integer(dadosSQL.getInt("gradedisciplina.cargaHoraria")));
		obj.getGradeDisciplinaVO().setCargaHorariaPratica(new Integer(dadosSQL.getInt("gradedisciplina.cargaHorariaPratica")));
		obj.getGradeDisciplinaVO().setCargaHorariaTeorica(obj.getGradeDisciplinaVO().getCargaHoraria() - obj.getGradeDisciplinaVO().getCargaHorariaPratica());
		obj.getGradeDisciplinaVO().setNrCreditos(new Integer(dadosSQL.getInt("gradedisciplina.nrCreditos")));
		obj.getGradeDisciplinaVO().setHoraAula(new Integer(dadosSQL.getInt("gradedisciplina.horaaula")));
		obj.getGradeDisciplinaVO().getDisciplinaEixoTematico().setCodigo(new Integer(dadosSQL.getInt("gradedisciplina.disciplinaEixoTematico")));

		// DADOS GRADE CURRICULAR GRUPO OPTATIVA DISCIPLINA
		obj.setDisciplinaReferenteAUmGrupoOptativa(dadosSQL.getBoolean("historico.disciplinaReferenteAUmGrupoOptativa"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setCodigo(dadosSQL.getInt("historico.gradeCurricularGrupoOptativaDisciplina"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setCargaHoraria(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.cargaHoraria"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setNrCreditos(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.nrCreditos"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setHoraAula(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.horaAula"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().getDisciplina().setCodigo(dadosSQL.getInt("gradeCurricularGrupoOptativaDisciplina.disciplina"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setDiversificada(dadosSQL.getBoolean("gradeCurricularGrupoOptativaDisciplina.diversificada"));
		obj.getGradeCurricularGrupoOptativaDisciplinaVO().setDisciplinaComposta(dadosSQL.getBoolean("gradeCurricularGrupoOptativaDisciplina.disciplinaComposta"));

		// DADOS DISCIPLINA COMPOSTA
		obj.setHistoricoDisciplinaFazParteComposicao(dadosSQL.getBoolean("subDisciplina"));
		obj.setHistoricoDisciplinaComposta(dadosSQL.getBoolean("historico.historicoDisciplinaComposta"));
		obj.getGradeDisciplinaComposta().setCodigo(dadosSQL.getInt("historico.gradeDisciplinaComposta"));
		// Verifica se trata-se de uma subDisciplina, pois a disciplina composta
		// no historico é uma subDisciplina
		if (obj.getHistoricoDisciplinaFazParteComposicao()) {
			obj.getGradeDisciplinaComposta().setCodigo(dadosSQL.getInt("gradedisciplinacomposta.codigo"));
			obj.getGradeDisciplinaComposta().setDisciplina(obj.getDisciplina());
			obj.getGradeDisciplinaComposta().setHoraAula(dadosSQL.getInt("gradedisciplinacomposta.horaaula"));
			obj.getGradeDisciplinaComposta().setCargaHoraria(dadosSQL.getInt("gradedisciplinacomposta.cargaHoraria"));
			obj.getGradeDisciplinaComposta().setCargaHorariaPratica(dadosSQL.getInt("gradedisciplinacomposta.cargaHorariaPratica"));
			obj.getGradeDisciplinaComposta().setCargaHorariaTeorica(dadosSQL.getInt("gradedisciplinacomposta.cargaHorariaTeorica"));
			obj.getGradeDisciplinaComposta().setNrCreditos(dadosSQL.getInt("gradedisciplinacomposta.nrCreditos"));
			obj.getGradeDisciplinaComposta().setGrupoOptativa(dadosSQL.getBoolean("gradedisciplinacomposta.grupoOptativa"));
			obj.getGradeDisciplinaComposta().getGradeDisciplina().setCodigo(dadosSQL.getInt("gdc.codigo"));
			obj.getGradeDisciplinaComposta().getGradeDisciplina().getDisciplina().setCodigo(dadosSQL.getInt("gdc.disciplina"));
			obj.getGradeDisciplinaComposta().getGradeCurricularGrupoOptativaDisciplina().setCodigo(dadosSQL.getInt("gcgodc.codigo"));
			obj.getGradeDisciplinaComposta().getGradeCurricularGrupoOptativaDisciplina().getDisciplina().setCodigo(dadosSQL.getInt("gcgodc.disciplina"));
		}
		// Verifica se trata-se de uma disciplina composta, pois a disciplina
		// composta na tabela disciplina é a mãe.
		if (obj.getHistoricoDisciplinaComposta()) {
			// obj.getDisciplina().setNomeMinhasNotasAluno(obj.getDisciplina().getNome()
			// + " --> (DISCIPLINA COMPOSTA)");
			obj.getDisciplina().setNomeMinhasNotasAluno(obj.getDisciplina().getNome());
		}

		// DADOS EQUIVALENCIA
		obj.setHistoricoPorEquivalencia(dadosSQL.getBoolean("historico.historicoPorEquivalencia"));
		obj.setHistoricoEquivalente(dadosSQL.getBoolean("historico.historicoEquivalente"));
		obj.getMapaEquivalenciaDisciplina().setCodigo(dadosSQL.getInt("historico.mapaEquivalenciaDisciplina"));
		obj.getMapaEquivalenciaDisciplinaCursada().setCodigo(dadosSQL.getInt("historico.mapaEquivalenciaDisciplinaCursada"));
		obj.getMapaEquivalenciaDisciplinaMatrizCurricular().setCodigo(dadosSQL.getInt("historico.mapaEquivalenciaDisciplinaMatrizCurricular"));

		obj.getCidadeVO().setCodigo(dadosSQL.getInt("cidade"));

		if (dadosSQL.getObject("nota1") == null) {
			obj.setNota1((Double) dadosSQL.getObject("nota1"));
		} else {
			obj.setNota1(dadosSQL.getDouble("nota1"));
		}
		if (dadosSQL.getObject("nota2") == null) {
			obj.setNota2((Double) dadosSQL.getObject("nota2"));
		} else {
			obj.setNota2(dadosSQL.getDouble("nota2"));
		}
		if (dadosSQL.getObject("nota3") == null) {
			obj.setNota3((Double) dadosSQL.getObject("nota3"));
		} else {
			obj.setNota3(dadosSQL.getDouble("nota3"));
		}
		if (dadosSQL.getObject("nota4") == null) {
			obj.setNota4((Double) dadosSQL.getObject("nota4"));
		} else {
			obj.setNota4(dadosSQL.getDouble("nota4"));
		}
		if (dadosSQL.getObject("nota5") == null) {
			obj.setNota5((Double) dadosSQL.getObject("nota5"));
		} else {
			obj.setNota5(dadosSQL.getDouble("nota5"));
		}
		if (dadosSQL.getObject("nota6") == null) {
			obj.setNota6((Double) dadosSQL.getObject("nota6"));
		} else {
			obj.setNota6(dadosSQL.getDouble("nota6"));
		}
		if (dadosSQL.getObject("nota7") == null) {
			obj.setNota7((Double) dadosSQL.getObject("nota7"));
		} else {
			obj.setNota7(dadosSQL.getDouble("nota7"));
		}
		if (dadosSQL.getObject("nota8") == null) {
			obj.setNota8((Double) dadosSQL.getObject("nota8"));
		} else {
			obj.setNota8(dadosSQL.getDouble("nota8"));
		}
		if (dadosSQL.getObject("nota9") == null) {
			obj.setNota9((Double) dadosSQL.getObject("nota9"));
		} else {
			obj.setNota9(dadosSQL.getDouble("nota9"));
		}
		if (dadosSQL.getObject("nota10") == null) {
			obj.setNota10((Double) dadosSQL.getObject("nota10"));
		} else {
			obj.setNota10(dadosSQL.getDouble("nota10"));
		}
		if (dadosSQL.getObject("nota11") == null) {
			obj.setNota11((Double) dadosSQL.getObject("nota11"));
		} else {
			obj.setNota11(dadosSQL.getDouble("nota11"));
		}
		if (dadosSQL.getObject("nota12") == null) {
			obj.setNota12((Double) dadosSQL.getObject("nota12"));
		} else {
			obj.setNota12(dadosSQL.getDouble("nota12"));
		}
		if (dadosSQL.getObject("nota13") == null) {
			obj.setNota13((Double) dadosSQL.getObject("nota13"));
		} else {
			obj.setNota13(dadosSQL.getDouble("nota13"));
		}

		obj.setNota1Lancada(dadosSQL.getBoolean("nota1Lancada"));
		obj.setNota2Lancada(dadosSQL.getBoolean("nota2Lancada"));
		obj.setNota3Lancada(dadosSQL.getBoolean("nota3Lancada"));
		obj.setNota4Lancada(dadosSQL.getBoolean("nota4Lancada"));
		obj.setNota5Lancada(dadosSQL.getBoolean("nota5Lancada"));
		obj.setNota6Lancada(dadosSQL.getBoolean("nota6Lancada"));
		obj.setNota7Lancada(dadosSQL.getBoolean("nota7Lancada"));
		obj.setNota8Lancada(dadosSQL.getBoolean("nota8Lancada"));
		obj.setNota9Lancada(dadosSQL.getBoolean("nota9Lancada"));
		obj.setNota10Lancada(dadosSQL.getBoolean("nota10Lancada"));
		obj.setNota11Lancada(dadosSQL.getBoolean("nota11Lancada"));
		obj.setNota12Lancada(dadosSQL.getBoolean("nota12Lancada"));
		obj.setNota13Lancada(dadosSQL.getBoolean("nota13Lancada"));

		if (dadosSQL.getObject("nota14") == null) {
			obj.setNota14((Double) dadosSQL.getObject("nota14"));
		} else {
			obj.setNota14(dadosSQL.getDouble("nota14"));
		}
		obj.setNota14Lancada(dadosSQL.getBoolean("nota14Lancada"));

		if (dadosSQL.getObject("nota15") == null) {
			obj.setNota15((Double) dadosSQL.getObject("nota15"));
		} else {
			obj.setNota15(dadosSQL.getDouble("nota15"));
		}
		obj.setNota15Lancada(dadosSQL.getBoolean("nota15Lancada"));

		if (dadosSQL.getObject("nota16") == null) {
			obj.setNota16((Double) dadosSQL.getObject("nota16"));
		} else {
			obj.setNota16(dadosSQL.getDouble("nota16"));
		}
		obj.setNota16Lancada(dadosSQL.getBoolean("nota16Lancada"));

		if (dadosSQL.getObject("nota17") == null) {
			obj.setNota17((Double) dadosSQL.getObject("nota17"));
		} else {
			obj.setNota17(dadosSQL.getDouble("nota17"));
		}
		obj.setNota17Lancada(dadosSQL.getBoolean("nota17Lancada"));

		if (dadosSQL.getObject("nota18") == null) {
			obj.setNota18((Double) dadosSQL.getObject("nota18"));
		} else {
			obj.setNota18(dadosSQL.getDouble("nota18"));
		}
		obj.setNota18Lancada(dadosSQL.getBoolean("nota18Lancada"));

		if (dadosSQL.getObject("nota19") == null) {
			obj.setNota19((Double) dadosSQL.getObject("nota19"));
		} else {
			obj.setNota19(dadosSQL.getDouble("nota19"));
		}
		obj.setNota19Lancada(dadosSQL.getBoolean("nota19Lancada"));

		if (dadosSQL.getObject("nota20") == null) {
			obj.setNota20((Double) dadosSQL.getObject("nota20"));
		} else {
			obj.setNota20(dadosSQL.getDouble("nota20"));
		}
		obj.setNota20Lancada(dadosSQL.getBoolean("nota20Lancada"));

		if (dadosSQL.getObject("nota21") == null) {
			obj.setNota21((Double) dadosSQL.getObject("nota21"));
		} else {
			obj.setNota21(dadosSQL.getDouble("nota21"));
		}
		obj.setNota21Lancada(dadosSQL.getBoolean("nota21Lancada"));

		if (dadosSQL.getObject("nota22") == null) {
			obj.setNota22((Double) dadosSQL.getObject("nota22"));
		} else {
			obj.setNota22(dadosSQL.getDouble("nota22"));
		}
		obj.setNota22Lancada(dadosSQL.getBoolean("nota22Lancada"));

		if (dadosSQL.getObject("nota23") == null) {
			obj.setNota23((Double) dadosSQL.getObject("nota23"));
		} else {
			obj.setNota23(dadosSQL.getDouble("nota23"));
		}
		obj.setNota23Lancada(dadosSQL.getBoolean("nota23Lancada"));

		if (dadosSQL.getObject("nota24") == null) {
			obj.setNota24((Double) dadosSQL.getObject("nota24"));
		} else {
			obj.setNota24(dadosSQL.getDouble("nota24"));
		}
		obj.setNota24Lancada(dadosSQL.getBoolean("nota24Lancada"));

		if (dadosSQL.getObject("nota25") == null) {
			obj.setNota25((Double) dadosSQL.getObject("nota25"));
		} else {
			obj.setNota25(dadosSQL.getDouble("nota25"));
		}
		obj.setNota25Lancada(dadosSQL.getBoolean("nota25Lancada"));

		if (dadosSQL.getObject("nota26") == null) {
			obj.setNota26((Double) dadosSQL.getObject("nota26"));
		} else {
			obj.setNota26(dadosSQL.getDouble("nota26"));
		}
		obj.setNota26Lancada(dadosSQL.getBoolean("nota26Lancada"));

		if (dadosSQL.getObject("nota27") == null) {
			obj.setNota27((Double) dadosSQL.getObject("nota27"));
		} else {
			obj.setNota27(dadosSQL.getDouble("nota27"));
		}
		obj.setNota27Lancada(dadosSQL.getBoolean("nota27Lancada"));

		if (dadosSQL.getObject("nota28") == null) {
			obj.setNota28((Double) dadosSQL.getObject("nota28"));
		} else {
			obj.setNota28(dadosSQL.getDouble("nota28"));
		}
		obj.setNota28Lancada(dadosSQL.getBoolean("nota28Lancada"));

		if (dadosSQL.getObject("nota29") == null) {
			obj.setNota29((Double) dadosSQL.getObject("nota29"));
		} else {
			obj.setNota29(dadosSQL.getDouble("nota29"));
		}
		obj.setNota29Lancada(dadosSQL.getBoolean("nota29Lancada"));

		if (dadosSQL.getObject("nota30") == null) {
			obj.setNota30((Double) dadosSQL.getObject("nota30"));
		} else {
			obj.setNota30(dadosSQL.getDouble("nota30"));
		}
		obj.setNota30Lancada(dadosSQL.getBoolean("nota30Lancada"));

		if (dadosSQL.getObject("nota31") == null) {
			obj.setNota31((Double) dadosSQL.getObject("nota31"));
		} else {
			obj.setNota31(dadosSQL.getDouble("nota31"));
		}
		obj.setNota31Lancada(dadosSQL.getBoolean("nota31Lancada"));

		if (dadosSQL.getObject("nota32") == null) {
			obj.setNota32((Double) dadosSQL.getObject("nota32"));
		} else {
			obj.setNota32(dadosSQL.getDouble("nota32"));
		}
		obj.setNota32Lancada(dadosSQL.getBoolean("nota32Lancada"));

		if (dadosSQL.getObject("nota33") == null) {
			obj.setNota33((Double) dadosSQL.getObject("nota33"));
		} else {
			obj.setNota33(dadosSQL.getDouble("nota33"));
		}
		obj.setNota33Lancada(dadosSQL.getBoolean("nota33Lancada"));

		if (dadosSQL.getObject("nota34") == null) {
			obj.setNota34((Double) dadosSQL.getObject("nota34"));
		} else {
			obj.setNota34(dadosSQL.getDouble("nota34"));
		}
		obj.setNota34Lancada(dadosSQL.getBoolean("nota34Lancada"));

		if (dadosSQL.getObject("nota35") == null) {
			obj.setNota35((Double) dadosSQL.getObject("nota35"));
		} else {
			obj.setNota35(dadosSQL.getDouble("nota35"));
		}
		obj.setNota35Lancada(dadosSQL.getBoolean("nota35Lancada"));

		if (dadosSQL.getObject("nota36") == null) {
			obj.setNota36((Double) dadosSQL.getObject("nota36"));
		} else {
			obj.setNota36(dadosSQL.getDouble("nota36"));
		}
		obj.setNota36Lancada(dadosSQL.getBoolean("nota36Lancada"));

		if (dadosSQL.getObject("nota37") == null) {
			obj.setNota37((Double) dadosSQL.getObject("nota37"));
		} else {
			obj.setNota37(dadosSQL.getDouble("nota37"));
		}
		obj.setNota37Lancada(dadosSQL.getBoolean("nota37Lancada"));

		if (dadosSQL.getObject("nota38") == null) {
			obj.setNota38((Double) dadosSQL.getObject("nota38"));
		} else {
			obj.setNota38(dadosSQL.getDouble("nota38"));
		}
		obj.setNota38Lancada(dadosSQL.getBoolean("nota38Lancada"));

		if (dadosSQL.getObject("nota39") == null) {
			obj.setNota39((Double) dadosSQL.getObject("nota39"));
		} else {
			obj.setNota39(dadosSQL.getDouble("nota39"));
		}
		obj.setNota39Lancada(dadosSQL.getBoolean("nota39Lancada"));

		if (dadosSQL.getObject("nota40") == null) {
			obj.setNota40((Double) dadosSQL.getObject("nota40"));
		} else {
			obj.setNota40(dadosSQL.getDouble("nota40"));
		}
		obj.setNota40Lancada(dadosSQL.getBoolean("nota40Lancada"));
		obj.setApresentarAprovadoHistorico(dadosSQL.getBoolean("apresentarAprovadoHistorico"));

		obj.setUpdated(dadosSQL.getTimestamp("updated"));
		if (dadosSQL.getObject("mediaFinal") == null) {
			obj.setMediaFinal((Double) dadosSQL.getObject("mediaFinal"));
		} else {
			obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		}
		obj.getMediaFinalConceito().setCodigo(dadosSQL.getInt("mediaFinalConceito"));
		obj.getNota1Conceito().setCodigo(dadosSQL.getInt("nota1Conceito"));
		obj.getNota2Conceito().setCodigo(dadosSQL.getInt("nota2Conceito"));
		obj.getNota3Conceito().setCodigo(dadosSQL.getInt("nota3Conceito"));
		obj.getNota4Conceito().setCodigo(dadosSQL.getInt("nota4Conceito"));
		obj.getNota5Conceito().setCodigo(dadosSQL.getInt("nota5Conceito"));
		obj.getNota6Conceito().setCodigo(dadosSQL.getInt("nota6Conceito"));
		obj.getNota7Conceito().setCodigo(dadosSQL.getInt("nota7Conceito"));
		obj.getNota8Conceito().setCodigo(dadosSQL.getInt("nota8Conceito"));
		obj.getNota9Conceito().setCodigo(dadosSQL.getInt("nota9Conceito"));
		obj.getNota10Conceito().setCodigo(dadosSQL.getInt("nota10Conceito"));
		obj.getNota11Conceito().setCodigo(dadosSQL.getInt("nota11Conceito"));
		obj.getNota12Conceito().setCodigo(dadosSQL.getInt("nota12Conceito"));
		obj.getNota13Conceito().setCodigo(dadosSQL.getInt("nota13Conceito"));
		obj.getNota14Conceito().setCodigo(dadosSQL.getInt("nota14Conceito"));
		obj.getNota15Conceito().setCodigo(dadosSQL.getInt("nota15Conceito"));
		obj.getNota16Conceito().setCodigo(dadosSQL.getInt("nota16Conceito"));
		obj.getNota17Conceito().setCodigo(dadosSQL.getInt("nota17Conceito"));
		obj.getNota18Conceito().setCodigo(dadosSQL.getInt("nota18Conceito"));
		obj.getNota19Conceito().setCodigo(dadosSQL.getInt("nota19Conceito"));
		obj.getNota20Conceito().setCodigo(dadosSQL.getInt("nota20Conceito"));
		obj.getNota21Conceito().setCodigo(dadosSQL.getInt("nota21Conceito"));
		obj.getNota22Conceito().setCodigo(dadosSQL.getInt("nota22Conceito"));
		obj.getNota23Conceito().setCodigo(dadosSQL.getInt("nota23Conceito"));
		obj.getNota24Conceito().setCodigo(dadosSQL.getInt("nota24Conceito"));
		obj.getNota25Conceito().setCodigo(dadosSQL.getInt("nota25Conceito"));
		obj.getNota26Conceito().setCodigo(dadosSQL.getInt("nota26Conceito"));
		obj.getNota27Conceito().setCodigo(dadosSQL.getInt("nota27Conceito"));
		obj.getNota28Conceito().setCodigo(dadosSQL.getInt("nota28Conceito"));
		obj.getNota29Conceito().setCodigo(dadosSQL.getInt("nota29Conceito"));
		obj.getNota30Conceito().setCodigo(dadosSQL.getInt("nota30Conceito"));
		obj.getNota31Conceito().setCodigo(dadosSQL.getInt("nota31Conceito"));
		obj.getNota32Conceito().setCodigo(dadosSQL.getInt("nota32Conceito"));
		obj.getNota33Conceito().setCodigo(dadosSQL.getInt("nota33Conceito"));
		obj.getNota34Conceito().setCodigo(dadosSQL.getInt("nota34Conceito"));
		obj.getNota35Conceito().setCodigo(dadosSQL.getInt("nota35Conceito"));
		obj.getNota36Conceito().setCodigo(dadosSQL.getInt("nota36Conceito"));
		obj.getNota37Conceito().setCodigo(dadosSQL.getInt("nota37Conceito"));
		obj.getNota38Conceito().setCodigo(dadosSQL.getInt("nota38Conceito"));
		obj.getNota39Conceito().setCodigo(dadosSQL.getInt("nota39Conceito"));
		obj.getNota40Conceito().setCodigo(dadosSQL.getInt("nota40Conceito"));
		// obj.setMediaFinal(new Double(dadosSQL.getDouble("mediaFinal")));
		// obj.setCargaHoraria(new Double(dadosSQL.getDouble("cargaHoraria")));
		obj.setTransferenciaEntradaDisciplinasAproveitadas(new Integer(dadosSQL.getInt("transferenciaEntradaDisciplinasAproveitadas")));
		obj.setIsentarMediaFinal(dadosSQL.getBoolean("isentarMediaFinal"));

		// Dados do Configuracao Academico
		obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("configuracaoAcademico.codigo"));
		obj.setConfiguracaoAcademico(getAplicacaoControle().carregarDadosConfiguracaoAcademica(obj.getConfiguracaoAcademico().getCodigo()));
//		if(!mapConfAcademico.containsKey(obj.getConfiguracaoAcademico().getCodigo())){
//			mapConfAcademico.put(obj.getConfiguracaoAcademico().getCodigo(), getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(obj.getConfiguracaoAcademico().getCodigo(), null));
//		}
//		obj.setConfiguracaoAcademico(mapConfAcademico.get(obj.getConfiguracaoAcademico().getCodigo()));
//		carregarDadosNotaConceitoHistorico(obj);
		obj.setApresentarAprovadoHistorico(dadosSQL.getBoolean("apresentarAprovadoHistorico"));



		// Dados do Matricula Periodo Turma Disciplina
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina.codigo")));
		obj.getMatriculaPeriodoTurmaDisciplina().setSemestre((dadosSQL.getString("matriculaPeriodoTurmaDisciplina.semestre")));
		obj.getMatriculaPeriodoTurmaDisciplina().setAno((dadosSQL.getString("matriculaPeriodoTurmaDisciplina.ano")));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setCodigo(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina.turma"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().setCodigo(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina.turmaTeorica"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().setCodigo(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina.turmaPratica"));
		// Dados do Matricula Periodo
		obj.getMatriculaPeriodo().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodo.codigo")));
		obj.getMatriculaPeriodo().setSituacao(dadosSQL.getString("matriculaPeriodo.situacao"));
		obj.getMatriculaPeriodo().setSituacaoMatriculaPeriodo(dadosSQL.getString("matriculaPeriodo.situacaoMatriculaPeriodo"));
		// Dados da Grade Curricular
		obj.getMatriculaPeriodo().getGradeCurricular().setNome(dadosSQL.getString("gradeCurricular.nome"));
		// Dados do Periodo Letivo
		obj.getMatriculaPeriodo().getPeridoLetivo().setDescricao(dadosSQL.getString("periodoLetivo.descricao"));
		obj.getMatriculaPeriodo().getPeridoLetivo().setTotalCargaHoraria(dadosSQL.getInt("periodoLetivo.totalcargahoraria"));
		// Dados da Turma
		obj.getMatriculaPeriodo().getTurma().setIdentificadorTurma(dadosSQL.getString("turma.identificadorTurma"));
		// Dados da Matricula
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula.matricula"));
		obj.getMatricula().setUpdated(dadosSQL.getTimestamp("matricula.updated"));
		obj.getMatricula().setSituacao(dadosSQL.getString("matricula.situacao"));
		obj.getMatricula().setSituacaoFinanceira(dadosSQL.getString("matricula.situacaoFinanceira"));
		obj.getMatricula().getGradeCurricularAtual().setCodigo(dadosSQL.getInt("matricula.gradecurricularatual"));
		obj.getMatricula().setCanceladoFinanceiro(dadosSQL.getBoolean("canceladoFinanceiro"));
		// Dados do Curso
		obj.getMatricula().getCurso().setNome(dadosSQL.getString("curso.nome"));
		obj.getMatricula().getCurso().setNivelEducacional(dadosSQL.getString("curso.nivelEducacional"));
		// Dados do Turno
		obj.getMatricula().getTurno().setNome(dadosSQL.getString("turno.nome"));
		// Dados da Unidade Ensino
		obj.getMatricula().getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeEnsino.codigo"));
		obj.getMatricula().getUnidadeEnsino().setNome(dadosSQL.getString("unidadeEnsino.nome"));
		// Dados do Aluno
		obj.getMatricula().getAluno().setCodigo(new Integer(dadosSQL.getString("aluno.codigo")));
		obj.getMatricula().getAluno().setNome(dadosSQL.getString("aluno.nome"));
		// Dados do Usuario
		obj.getResponsavel().setCodigo(new Integer(dadosSQL.getInt("responsavel.codigo")));
		obj.getResponsavel().setNome(dadosSQL.getString("responsavel.nome"));

		List<String> campos = Arrays.asList(dadosSQL.getMetaData().getColumnNames());

		if(campos.contains("data")){
			obj.setData(dadosSQL.getDate("data"));
		}

		if(campos.contains("dataprimeiraaula")){
			obj.setDataPrimeiraAula(dadosSQL.getDate("dataprimeiraaula"));
		}

		if(campos.contains("ocultardataaula")){
			obj.setOcultarDataAula(dadosSQL.getBoolean("ocultardataaula"));
		}

		if (historicoTurmaRel) {
			if(campos.contains("professor.nome")){
				obj.setNomeProfessor(dadosSQL.getString("professor.nome"));
			}
		} else {
			if (obj.getMatricula().getCurso().getNivelEducacionalPosGraduacao()) {
				if(campos.contains("professor.nome")){
				obj.setNomeProfessor(dadosSQL.getString("professor.nome"));
				}
			}

		}
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));
	}

	public List<HistoricoVO> consultaRapidaHistoricoPorMatriculaPeriodo(Integer codMatriculaPeriodo, Integer gradeCurricularAtual, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select historico.codigo, historico.situacao, historico.freguencia, historico.mediaFinal, historico.frequenciateorica, historico.frequenciapratica, ");
		sqlStr.append("turma.identificadorTurma AS \"turma.identificadorTurma\", disciplina.nome AS \"disciplina.nome\", ");
		sqlStr.append("historico.cargaHorariaDisciplina AS \"historico.cargaHorariaDisciplina\", disciplina.codigo AS \"disciplina.codigo\", ");
		sqlStr.append("historico.historicoDisciplinaFazParteComposicao, mfc.codigo as mediaFinalConceito, mfc.conceitonota as conceitonota ");
		sqlStr.append("from historico ");
		sqlStr.append("INNER JOIN MatriculaPeriodo on MatriculaPeriodo.codigo = historico.MatriculaPeriodo ");
		sqlStr.append("INNER JOIN Disciplina on disciplina.codigo = historico.disciplina ");
		sqlStr.append("LEFT JOIN periodoletivo on periodoletivo.codigo = historico.periodoLetivoMatrizCurricular ");
		sqlStr.append("LEFT JOIN MatriculaPeriodoTurmaDisciplina mptd on mptd.codigo = historico.MatriculaPeriodoTurmaDisciplina ");
		sqlStr.append("LEFT JOIN Turma on turma.codigo = mptd.turma ");
		sqlStr.append("LEFT JOIN configuracaoAcademicoNotaConceito mfc on mfc.codigo = historico.mediaFinalConceito ");
		sqlStr.append("WHERE matriculaPeriodo.codigo = ").append(codMatriculaPeriodo);
		sqlStr.append(" and historico.matrizcurricular = ").append(gradeCurricularAtual);
		sqlStr.append(" and (historico.gradecurriculargrupooptativadisciplina is not null or historico.gradedisciplina is not null or historicodisciplinaforagrade)");
		sqlStr.append(" and (historicoequivalente = false or historicoequivalente is null)");
		sqlStr.append(" ORDER BY historico.configuracaoacademico, case when historico.historicodisciplinafazpartecomposicao then (");
		sqlStr.append(" select gdc.ordem::VARCHAR||dis.nome from gradedisciplinacomposta gdc");
		sqlStr.append(" inner join gradedisciplina on gradedisciplina.codigo = gdc.gradedisciplina");
		sqlStr.append(" inner join disciplina dis on dis.codigo = gradedisciplina.disciplina");
		sqlStr.append(" where gdc.codigo = historico.gradedisciplinacomposta");
		sqlStr.append(" ) else case when historico.historicodisciplinacomposta then '-1'||disciplina.nome else disciplina.nome end end");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			montarDadosConsultaPorMatriculaPeriodo(obj, tabelaResultado, usuario);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	private void montarDadosConsultaPorMatriculaPeriodo(HistoricoVO obj, SqlRowSet dadosSQL, UsuarioVO usuario) throws Exception {
		// Dados do Historico
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setFreguencia(new Double(dadosSQL.getDouble("freguencia")));
		obj.setMediaFinal(new Double(dadosSQL.getDouble("mediaFinal")));
		// Dados da Matricula Perido Turma Disciplina
		obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setIdentificadorTurma(dadosSQL.getString("turma.identificadorTurma"));
		// Dados da Disciplina
		obj.getDisciplina().setCodigo(dadosSQL.getInt("disciplina.codigo"));
		obj.getDisciplina().setNome(dadosSQL.getString("disciplina.nome"));
		obj.setCargaHorariaDisciplina(dadosSQL.getInt("historico.cargaHorariaDisciplina"));
		obj.setHistoricoDisciplinaFazParteComposicao(dadosSQL.getBoolean("historicoDisciplinaFazParteComposicao"));
		obj.getMediaFinalConceito().setCodigo(dadosSQL.getInt("mediaFinalConceito"));
		obj.getMediaFinalConceito().setConceitoNota(dadosSQL.getString("conceitoNota"));
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));
	}

	public void verificarAprovacaoAlunos(CursoVO cursoVO, List<HistoricoVO> historicoVOs, UsuarioVO usuario) throws Exception {
		for (HistoricoVO historicoVO : historicoVOs) {
			executarVerificarMontagemConfiguracaoAcademico(historicoVO, cursoVO, usuario);
			verificarAprovacaoAluno(historicoVO, usuario);
		}
	}

	private void executarVerificarMontagemConfiguracaoAcademico(HistoricoVO historicoVO, CursoVO cursoVO, UsuarioVO usuario) throws Exception {
		ConfiguracaoAcademicoVO configuracaoAcademicoVO = getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorDisciplinaMatriculaPeriodoAlunoVinculadoGradeDisciplina(historicoVO.getDisciplina().getCodigo(), historicoVO.getMatriculaPeriodo().getCodigo(), usuario);
		if (!configuracaoAcademicoVO.getCodigo().equals(0)) {
			historicoVO.setConfiguracaoAcademico(configuracaoAcademicoVO);
		} else {
			historicoVO.setConfiguracaoAcademico(cursoVO.getConfiguracaoAcademico());
		}
	}

	public void verificarAprovacaoAluno(HistoricoVO historicoVO, UsuarioVO usuario) throws Exception {
		try {
			calcularMedia(historicoVO.getConfiguracaoAcademico(), historicoVO, usuario);
		} catch (Exception e) {
			throw e;
		}
	}

	private void calcularMedia(ConfiguracaoAcademicoVO configuracaoAcademicoVO, HistoricoVO historicoVO, UsuarioVO usuario) throws Exception {
		if (!configuracaoAcademicoVO.verificarHistoricoProvenienteImportacao(historicoVO)) {
			boolean resultado = false;
			try {
				if(historicoVO.getHistoricoDisciplinaComposta()) {
					List<HistoricoVO> historicoFilhaComposicaoVOs = new ArrayList<HistoricoVO>(0);
					historicoFilhaComposicaoVOs = getFacadeFactory().getHistoricoFacade().consultaRapidaHistoricoFazParteComposicaoPorMatriculaPorGradeCurricularPorMatriculaPeriodo(historicoVO.getMatricula().getMatricula(), 0, historicoVO.getMatriculaPeriodo().getCodigo(), historicoVO.getMatrizCurricular().getCodigo(), historicoVO.getGradeDisciplinaVO().getCodigo(), historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), false, null);
					resultado = configuracaoAcademicoVO.substituirVariaveisFormulaPorValores(historicoVO, historicoFilhaComposicaoVOs, true);
				}else {
					resultado = configuracaoAcademicoVO.substituirVariaveisFormulaPorValores(historicoVO, null, true);
				}
				if(historicoVO.getHistoricoDisciplinaFazParteComposicao()){
					resultado = getFacadeFactory().getHistoricoFacade().executarAtualizacaoDisciplinaComposta(historicoVO, null, TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, false, resultado, usuario);
				}
			} catch (FechamentoPeriodoLetivoException e) {
				getFacadeFactory().getLogFechamentoFacade().realizarRegistroLogFechamento(historicoVO.getMatricula().getMatricula());
			}

			if (historicoVO.getMediaFinal() != null && !(historicoVO.getMediaFinal().equals(0.0))) {
				verificaAlunoReprovadoFalta(historicoVO, historicoVO.getConfiguracaoAcademico(), usuario);
				if ((!historicoVO.getSituacao().equals(SituacaoHistorico.REPROVADO_FALTA.getValor())) && (!historicoVO.getSituacao().equals(SituacaoHistorico.ISENTO.getValor())) && !historicoVO.getSituacao().equals("")) {
					if (resultado) {
						historicoVO.setSituacao(SituacaoHistorico.APROVADO.getValor());
					} else {
						historicoVO.setSituacao(SituacaoHistorico.REPROVADO.getValor());
					}
				}
			} else {
				historicoVO.setSituacao(SituacaoHistorico.CURSANDO.getValor());
			}
			verificarNotasLancadas(historicoVO, usuario);
		}
	}

	public Boolean consultarSeDisciplinaEstaSendoCursadaOuAprovada(String matricula, Integer codigoDisciplina, UsuarioVO usuario) throws Exception {
		String sqlStr = "SELECT codigo FROM historico WHERE matricula = ? AND disciplina = ? AND situacao <> 'RE' AND situacao <> 'RF' AND situacao <> 'RP'";
		try {
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr, new Object[] { matricula, codigoDisciplina });
			if (!tabelaResultado.next()) {
				return false;
			} else {
				return true;
			}
		} finally {
			sqlStr = null;
		}
	}

	public Boolean consultarPorMatriculaDisciplinaSituacao(String matricula, Integer codigoDisciplina, String situacao, UsuarioVO usuario) throws Exception {
		String sqlStr = "SELECT codigo FROM historico WHERE matricula = ? AND disciplina = ? AND situacao = '" + situacao.toString() + "' ";
		try {
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr, new Object[] { matricula, codigoDisciplina });
			if (!tabelaResultado.next()) {
				return false;
			} else {
				return true;
			}
		} finally {
			sqlStr = null;
		}
	}

	public void processarOrganizacaoHistoricosAlunos(String nomeCurso, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVO> matriculaPeriodoVOs = getFacadeFactory().getMatriculaPeriodoFacade().consultaRapidaPorNomeCursoAnoSemestre(nomeCurso, 0, Uteis.getAnoDataAtual(), Uteis.getSemestreAtual(), false, usuario);
		for (MatriculaPeriodoVO matriculaPeriodoVO : matriculaPeriodoVOs) {
			atualizarDisciplinasHistoricoComBaseNaGradeCurricularDoAluno(matriculaPeriodoVO.getMatricula(), matriculaPeriodoVO.getGradeCurricular().getCodigo(), usuario);
			atualizarDisciplinasMatriculaPeriodoTurmaDisciplinaComBaseNaGradeCurricularDoAluno(matriculaPeriodoVO.getMatricula(), matriculaPeriodoVO.getGradeCurricular().getCodigo(), usuario);
		}
	}

	private void atualizarDisciplinasHistoricoComBaseNaGradeCurricularDoAluno(String matricula, Integer codigoGrade, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("update historico h ");
		sqlStr.append("set disciplina = t.disciplina ");
		sqlStr.append("from (select disciplina, d.nome from gradedisciplina gd ");
		sqlStr.append("inner join disciplina d on d.codigo = gd.disciplina ");
		sqlStr.append("inner join periodoletivo pl on gd.periodoletivo = pl.codigo ");
		sqlStr.append("inner join gradecurricular gc on pl.gradecurricular = gc.codigo ");
		sqlStr.append("where gc.codigo = ? ) as t , disciplina d2 ");
		sqlStr.append("where h.matricula = ? and h.disciplina = d2.codigo ");
		sqlStr.append("and t.disciplina <> d2.codigo and t.nome = d2.nome and t.disciplina is not null ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
		getConexao().getJdbcTemplate().update(sqlStr.toString(), new Object[] { codigoGrade, matricula });
	}

	private void atualizarDisciplinasMatriculaPeriodoTurmaDisciplinaComBaseNaGradeCurricularDoAluno(String matricula, Integer codigoGrade, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("update matriculaperiodoturmadisciplina mptd ");
		sqlStr.append("set disciplina = t.disciplina ");
		sqlStr.append("from (select disciplina, d.nome from gradedisciplina gd ");
		sqlStr.append("inner join disciplina d on d.codigo = gd.disciplina ");
		sqlStr.append("inner join periodoletivo pl on gd.periodoletivo = pl.codigo ");
		sqlStr.append("inner join gradecurricular gc on pl.gradecurricular = gc.codigo ");
		sqlStr.append("where gc.codigo = ? ) as t , disciplina d2 ");
		sqlStr.append("where mptd.matricula = ? and mptd.disciplina = d2.codigo ");
		sqlStr.append("and t.disciplina <> d2.codigo and t.nome = d2.nome and t.disciplina is not null ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
		getConexao().getJdbcTemplate().update(sqlStr.toString(), new Object[] { codigoGrade, matricula });
	}

	public HistoricoVO consultaRapidaPorMatriculaDisciplinaPeriodoLetivo(String matricula, Integer PeriodoLetivo, Integer disciplina, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (matricula.matricula = '");
		sqlStr.append(matricula);
		sqlStr.append("') ");
		sqlStr.append(" and periodoLetivo.codigo  = ");
		sqlStr.append(PeriodoLetivo.intValue());
		sqlStr.append("   AND disciplina.codigo = ");
		sqlStr.append(disciplina);
		sqlStr.append(" ORDER BY disciplina.nome desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO historicoVO = new HistoricoVO();
		montarDadosCompleto(historicoVO, tabelaResultado, usuario);
		return historicoVO;

	}


	/**
	 *
	 * @param unidadeEnsino
	 * @param curso
	 * @param disciplina
	 * @param turma
	 * @param ano
	 * @param semestre
	 * @param situacaoMatricula
	 * @param situacaoHistorico
	 * @param verificarDisciplina
	 * @param filtroVisaoProfessor
	 * @param controlarAcesso
	 * @param nivelMontarDados
	 * @param usuario
	 * @return
	 * @throws Exception
	 */
	public List<HistoricoVO> consultaRapidaPorTurmaUnidadeEnsinoCursoDisciplinaAnoSemestreDataHistoricoOrdenarDisciplina(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, String situacaoMatricula, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, boolean controlarAcesso, int nivelMontarDados, FiltroRelatorioAcademicoVO filtroRelatorioAcademicoVO, String tipoAluno, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados) throws Exception {
		// AO ADICIONAR CAMPOS NESTE SQL ADICIONAR NOS METODOS: 
		// getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica, 
		// consultaRapidaPorTurmaUnidadeEnsinoCursoDisciplinaAnoSemestreDataHistoricoOrdenarDisciplina
		// getSQLPadraoConsultaCompleta
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder str = new StringBuilder();
		str.append("SELECT distinct  historico.codigo, historico.tipoHistorico, aula.datainicio as \"aula.datainicio\", historico.situacao, historico.freguencia, historico.frequenciateorica, historico.frequenciapratica, historico.dataRegistro,  historico.cidade, historico.cargaHorariaAproveitamentoDisciplina, historico.cargaHorariaCursada, historico.instituicao, ");
		str.append(" historico.utilizaNotaFinalConceito, historico.notaFinalConceito, historico.cargaHorariaDisciplina, historico.numeroAgrupamentoEquivalenciaDisciplina, ");
		str.append(" historico.apresentarAprovadoHistorico, historico.totalfalta, ");

		str.append("historico.mediaFinal, historico.transferenciaEntradaDisciplinasAproveitadas, historico.mediafinalconceito, ");
		for(int x = 1; x<=40;x++) {
			str.append(" historico.nota").append(x).append(", ");
			str.append(" historico.nota").append(x).append("lancada, ");
			str.append(" historico.nota").append(x).append("conceito, ");
		}
		str.append("historico.updated, historico.historicoDisciplinaFazParteComposicao AS subDisciplina, anohistorico, semestrehistorico, ");
		// Dados do Configuracao Academico
		str.append(" configuracaoAcademico.codigo AS \"configuracaoAcademico.codigo\", ");

		// Dados do Matricula Periodo Turma Disciplina
		str.append(" matriculaPeriodoTurmaDisciplina.codigo AS \"matriculaPeriodoTurmaDisciplina.codigo\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Semestre
		str.append(" matriculaPeriodoTurmaDisciplina.semestre AS \"matriculaPeriodoTurmaDisciplina.semestre\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Ano
		str.append(" matriculaPeriodoTurmaDisciplina.ano AS \"matriculaPeriodoTurmaDisciplina.ano\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turma AS \"matriculaPeriodoTurmaDisciplina.turma\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turmaTeorica AS \"matriculaPeriodoTurmaDisciplina.turmaTeorica\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turmaPratica AS \"matriculaPeriodoTurmaDisciplina.turmaPratica\",  ");
		// Dados do Turma
		str.append(" turma.codigo AS \"turma.codigo\",  ");
		str.append(" turma.identificadorTurma AS \"turma.identificadorTurma\",  ");
		// Dados do Turno
		str.append(" turno.nome AS \"turno.nome\",  ");
		// Dados da Grade Curricular
		str.append(" gradeCurricular.nome AS \"gradeCurricular.nome\", ");
		// Dados do Matricula Periodo
		str.append(" matriculaPeriodo.codigo AS \"matriculaPeriodo.codigo\", matriculaPeriodo.situacao AS \"matriculaPeriodo.situacao\", matriculaPeriodo.situacaoMatriculaPeriodo AS \"matriculaPeriodo.situacaoMatriculaPeriodo\", ");
		// Dados do Periodo Letivo
		str.append(" periodoLetivo.descricao AS \"periodoLetivo.descricao\",  ");
		str.append(" periodoLetivo.totalcargahoraria as \"periodoLetivo.totalcargahoraria\", ");
		// Dados da Matricula
		str.append(" matricula.matricula AS \"matricula.matricula\",  ");
		str.append(" matricula.updated AS \"matricula.updated\",  ");
		str.append(" matricula.situacao AS \"matricula.situacao\",  ");
		str.append(" matricula.situacaoFinanceira AS \"matricula.situacaoFinanceira\", matricula.canceladoFinanceiro, ");
		str.append(" matricula.gradecurricularatual AS \"matricula.gradecurricularatual\", ");
		// Dados do Curso
		str.append(" curso.codigo AS \"curso.codigo\", curso.nome AS \"curso.nome\", curso.nivelEducacional AS \"curso.nivelEducacional\", ");
		// Dados da Unidade Ensino
		str.append(" unidadeEnsino.codigo AS \"unidadeEnsino.codigo\", unidadeEnsino.nome AS \"unidadeEnsino.nome\", ");
		// Dados do Aluno
		str.append(" aluno.codigo AS \"aluno.codigo\", aluno.nome AS \"aluno.nome\", sem_acentos(aluno.nome) as nomeAlunoSemAcentos, ");
		// Dados do Usuario
		str.append(" usuario.nome AS \"responsavel.nome\", usuario.codigo AS \"responsavel.codigo\", ");
		// Dados da Disciplina
		str.append(" disciplina.codigo AS \"disciplina.codigo\", disciplina.nome AS \"disciplina.nome\", disciplina.abreviatura as \"disciplina.abreviatura\",  ");
		// str.append(" gradedisciplina.cargaHoraria AS \"gradedisciplina.cargaHoraria\",  ");

		// DISCIPLINA COMPOSTA E EQUIVALENCIA
		str.append(" historico.historicoPorEquivalencia AS \"historico.historicoPorEquivalencia\", historico.historicoEquivalente AS \"historico.historicoEquivalente\", ");
		str.append(" historico.gradeDisciplinaComposta AS \"historico.gradeDisciplinaComposta\", ");
		str.append(" historico.historicoDisciplinaComposta AS \"historico.historicoDisciplinaComposta\", ");
		str.append(" historico.mapaEquivalenciaDisciplina AS \"historico.mapaEquivalenciaDisciplina\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaCursada AS \"historico.mapaEquivalenciaDisciplinaCursada\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaMatrizCurricular AS \"historico.mapaEquivalenciaDisciplinaMatrizCurricular\", ");

		// Dados da Grade Disciplina
		str.append(" gradedisciplina.horaaula AS \"gradedisciplina.horaaula\", ");
		str.append(" gradedisciplina.codigo AS \"gradedisciplina.codigo\", ");
		str.append(" gradedisciplina.disciplina AS \"gradedisciplina.disciplina\", ");
		str.append(" gradedisciplina.cargaHoraria AS \"gradedisciplina.cargaHoraria\", ");
		str.append(" gradedisciplina.cargaHorariaPratica AS \"gradedisciplina.cargaHorariaPratica\", ");
		str.append(" gradedisciplina.nrCreditos AS \"gradedisciplina.nrCreditos\", ");
		str.append(" gradedisciplina.diversificada AS \"gradedisciplina.diversificada\", ");
		str.append(" gradedisciplina.disciplinaComposta AS \"gradedisciplina.disciplinaComposta\", ");
		str.append(" gradedisciplina.disciplinaEixoTematico AS \"gradedisciplina.disciplinaEixoTematico\", ");

		// Dados da Grade Curricular Grupo Optativa Disciplina
		// (GradeCurricularGrupoOptativaDisciplina)
		str.append(" historico.gradeCurricularGrupoOptativaDisciplina AS \"historico.gradeCurricularGrupoOptativaDisciplina\",  ");
		str.append(" historico.disciplinaReferenteAUmGrupoOptativa AS \"historico.disciplinaReferenteAUmGrupoOptativa\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.codigo AS \"gradeCurricularGrupoOptativaDisciplina.codigo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplina AS \"gradeCurricularGrupoOptativaDisciplina.disciplina\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHoraria AS \"gradeCurricularGrupoOptativaDisciplina.cargaHoraria\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.nrCreditos AS \"gradeCurricularGrupoOptativaDisciplina.nrCreditos\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.diversificada AS \"gradeCurricularGrupoOptativaDisciplina.diversificada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplinaComposta AS \"gradeCurricularGrupoOptativaDisciplina.disciplinaComposta\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.horaaula AS \"gradeCurricularGrupoOptativaDisciplina.horaaula\", ");
		// Dados da Grade Disciplina Composta
				str.append(" gdc.codigo as \"gdc.codigo\", gdc.disciplina  as \"gdc.disciplina\", ");
				str.append(" gcgodc.codigo as \"gcgodc.codigo\", gcgodc.disciplina  as \"gcgodc.disciplina\", ");
				str.append(" gradedisciplinacomposta.horaaula AS \"gradedisciplinacomposta.horaaula\", ");
				str.append(" gradedisciplinacomposta.codigo AS \"gradedisciplinacomposta.codigo\", ");
				str.append(" gradedisciplina.disciplina AS \"gradedisciplinacomposta.disciplina\", ");
				str.append(" gradedisciplinacomposta.cargaHoraria AS \"gradedisciplinacomposta.cargaHoraria\", ");
				str.append(" gradedisciplinacomposta.cargaHorariaPratica AS \"gradedisciplinacomposta.cargaHorariaPratica\", ");
				str.append(" gradedisciplinacomposta.cargaHorariaTeorica AS \"gradedisciplinacomposta.cargaHorariaTeorica\", ");
				str.append(" gradedisciplinacomposta.nrCreditos AS \"gradedisciplinacomposta.nrCreditos\", ");
				str.append(" gradedisciplinacomposta.grupoOptativa AS \"gradedisciplinacomposta.grupoOptativa\", ");
				
				
		str.append(" null as data, ");
		str.append(" null as dataPrimeiraAula, ");
		str.append(" false as ocultardataaula, ");
		str.append(" '' AS \"professor.nome\",  ");
		str.append(" exists (select historiconota.codigo from historiconota where historiconota.historico = historico.codigo and historiconota.notarecuperacao and situacaorecuperacaonota = '").append(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO.name()).append("' limit 1) as emrecuperacao" );

		str.append(" FROM historico AS historico ");

		str.append(" LEFT JOIN matricula on matricula.matricula = historico.matricula ");
		str.append(" LEFT JOIN matriculaPeriodo on matricula.matricula = matriculaPeriodo.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		str.append(" inner JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");

		if (turmaVO.getSubturma() && (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.TEORICA) || turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.PRATICA))) {
			if (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.TEORICA)) {
				str.append("INNER JOIN Turma ON turma.codigo = MatriculaPeriodoTurmaDisciplina.turmaTeorica ");
			} else if (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.PRATICA)) {
				str.append("INNER JOIN Turma ON turma.codigo = MatriculaPeriodoTurmaDisciplina.turmaPratica ");
			}
		} else {
			str.append("INNER JOIN turma on turma.codigo = case when matriculaPeriodoTurmaDisciplina.turma is not null then matriculaPeriodoTurmaDisciplina.turma else matriculaPeriodo.turma end ");
		}

		str.append(" LEFT JOIN gradeCurricular on historico.matrizCurricular = gradeCurricular.codigo ");
		str.append(" LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		str.append(" INNER JOIN disciplina on disciplina.codigo = historico.disciplina  ");
		// Comentado porque estava impedindo que as disciplinas do
		// gradeCurricularGrupoOptativaDisciplina viessem no relatorio
		// str.append(" AND disciplina.codigo in  (select distinct disciplina.codigo from gradecurricular  AS gc ");
		// str.append(" inner join periodoletivo on periodoletivo.gradecurricular = gc.codigo ");
		// str.append(" inner join gradedisciplina on periodoletivo.codigo = gradedisciplina.periodoletivo ");
		// str.append(" inner join disciplina on disciplina.codigo = gradedisciplina.disciplina ");
		// str.append(" inner join turma on gradecurricular.codigo = turma.gradecurricular ");
		// str.append(" where gc.codigo = gradeCurricular.codigo) ");

		str.append(" LEFT JOIN pessoa AS \"aluno\" ON aluno.codigo = matricula.aluno ");
		str.append(" LEFT JOIN periodoLetivo on matriculaPeriodo.periodoLetivoMatricula = periodoLetivo.codigo ");
		str.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradedisciplina ");
		str.append(" LEFT JOIN usuario on usuario.codigo = historico.responsavel ");

		str.append(" LEFT JOIN turno on matricula.turno = turno.codigo ");
		str.append(" LEFT JOIN unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeEnsino ");
		str.append(" LEFT JOIN curso on curso.codigo = matricula.curso ");
		str.append(" LEFT JOIN configuracaoAcademico on configuracaoAcademico.codigo = historico.configuracaoAcademico ");
		str.append(" LEFT JOIN periodoauladisciplinaaluno(historico.codigo) as aula on aula.disciplina_codigo is not null and historico.matriculaperiodoturmadisciplina is not null ");
		str.append(" left join gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		str.append(" left join gradedisciplina gdc on gradedisciplinacomposta.gradedisciplina is not null and gdc.codigo = gradedisciplinacomposta.gradedisciplina ");
		str.append(" left join gradeCurricularGrupoOptativaDisciplina gcgodc on gradedisciplinacomposta.gradeCurricularGrupoOptativaDisciplina is not null and gcgodc.codigo = gradedisciplinacomposta.gradeCurricularGrupoOptativaDisciplina ");
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			str.append(" WHERE ");
			str.append(" ((MatriculaPeriodoTurmaDisciplina.turma in (select turma from turmaAgrupada where turmaOrigem =  ").append(turmaVO.getCodigo()).append(") )");
			str.append("or (MatriculaPeriodoTurmaDisciplina.turmaPratica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'PRATICA'))");
			str.append("or (MatriculaPeriodoTurmaDisciplina.turmaTeorica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'TEORICA'))");
			str.append(") ");
		} else {
			str.append(" WHERE Turma.codigo = ").append(turmaVO.getCodigo());
		}
		if (!turmaVO.getSubturma() && !turmaVO.getTurmaAgrupada()) {
			str.append(" and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
		}
		if(tipoAluno != null && !tipoAluno.trim().isEmpty() && tipoAluno.equals("normal")){
			str.append(" and matriculaperiodo.turma = matriculaperiodoturmadisciplina.turma ");
		}else if(tipoAluno != null && !tipoAluno.trim().isEmpty() && tipoAluno.equals("reposicao")){
			str.append(" and matriculaperiodo.turma != matriculaperiodoturmadisciplina.turma ");
		}

		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		if(!filtroRelatorioAcademicoVO.getTrazerAlunosComTransferenciaMatriz()){
			str.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		}
		if (unidadeEnsino != null && !unidadeEnsino.equals(0)) {
			str.append(" and turma.unidadeensino = ");
			str.append(unidadeEnsino);
		}
		if (verificarDisciplina) {
			if (disciplina != null && !disciplina.equals(0)) {
				str.append(" and (historico.disciplina = ");
				str.append(disciplina);
				if (turmaVO.getTurmaAgrupada()) {
					str.append(" or historico.disciplina in(select distinct disciplinaEquivalenteTurmaAgrupada from turmadisciplina where turmadisciplina.turma = ");
					str.append(turmaVO.getCodigo()).append(" and turmadisciplina.disciplina = ").append(disciplina).append(") ");
					str.append(" or historico.disciplina in (select distinct equivalente from disciplinaequivalente where disciplinaequivalente.disciplina = ").append(disciplina.intValue()).append(") ");
					str.append(" or historico.disciplina in (select distinct disciplina from disciplinaequivalente where disciplinaequivalente.equivalente = ").append(disciplina.intValue()).append(") ");
				}
				str.append(" )");
			}
		} else {
			str.append(" and (historico.disciplina = ");
			str.append(disciplina);
			if (turmaVO.getTurmaAgrupada()) {
				str.append(" or historico.disciplina in(select distinct disciplinaEquivalenteTurmaAgrupada from turmadisciplina where turmadisciplina.turma = ");
				str.append(turmaVO.getCodigo()).append(" and turmadisciplina.disciplina = ").append(disciplina).append(") ");
				str.append(" or historico.disciplina in (select distinct equivalente from disciplinaequivalente where disciplinaequivalente.disciplina = ").append(disciplina.intValue()).append(") ");
				str.append(" or historico.disciplina in (select distinct disciplina from disciplinaequivalente where disciplinaequivalente.equivalente = ").append(disciplina.intValue()).append(") ");
			}
			str.append(" )");
		}
		if (!semestre.equals("")) {
			str.append(" and matriculaPeriodo.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			str.append(" and matriculaPeriodo.ano = '").append(ano).append("' ");
		}
		if (!situacaoMatricula.equals("")) {
			str.append(" and matricula.situacao = '").append(situacaoMatricula).append("' ");
		}

		if ((usuario.getIsApresentarVisaoProfessor() || usuario.getIsApresentarVisaoCoordenador()) && !permitirRealizarLancamentoAlunosPreMatriculados) {
			str.append(" and matriculaperiodo.situacaoMatriculaPeriodo <> 'PR' ");
		}

		if (!situacaoHistorico.equals("")) {
			str.append(" and historico.situacao not in (").append(situacaoHistorico).append(") ");
		}
		if (Uteis.isAtributoPreenchido(turmaVO.getPeriodicidade()) && turmaVO.getPeriodicidade().equals("IN")) {
			str.append(" AND ").append(adicionarFiltroSituacaoAcademicaMatricula(filtroRelatorioAcademicoVO, "matricula"));
		} else {
			str.append(" AND ").append(adicionarFiltroSituacaoAcademicaMatriculaPeriodo(filtroRelatorioAcademicoVO, "matriculaperiodo"));
		}
		str.append(" AND ").append(adicionarFiltroSituacaoFinanceiraMatriculaPeriodo(filtroRelatorioAcademicoVO, "matriculaperiodo"));
		if (disciplina != null && !disciplina.equals(0)) {
			str.append(" ORDER BY nomeAlunoSemAcentos ");
		}else {
			str.append(" ORDER BY disciplina.nome, nomeAlunoSemAcentos ");
		}

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(str.toString());

		return montarDadosConsultaOrdenacaoDisciplina(tabelaResultado, true, usuario);
	}

	public List<HistoricoVO> montarDadosConsultaOrdenacaoDisciplina(SqlRowSet tabelaResultado, boolean historicoTurmaRel, UsuarioVO usuario) throws Exception {
		final List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {			
			HistoricoVO obj = new HistoricoVO();
			montarDadosCompletoDataOrdenacaoDisciplina(obj, tabelaResultado, historicoTurmaRel, usuario);
			obj.setConfiguracaoAcademico(getAplicacaoControle().carregarDadosConfiguracaoAcademica(obj.getConfiguracaoAcademico().getCodigo()));
//			carregarDadosHorarioAulaAluno(obj, true);
			carregarDadosNotaConceitoHistorico(obj);
			vetResultado.add(obj);
		}	
		return vetResultado;
	}

	public void validarDadosParaMontarListaHistorico(MatriculaVO matricula, Integer periodoLetivo, UsuarioVO usuario) throws Exception {
		if (matricula == null || matricula.getMatricula().equals("")) {
			throw new Exception(UteisJSF.internacionalizar("msg_CampoDeveSerInformado").replace("{0}", "CURSO (Minhas Notas)"));
		}
//		if (periodoLetivo.intValue() == 0) {
//			throw new Exception(UteisJSF.internacionalizar("msg_CampoDeveSerInformado").replace("{0}", "PERIODO LETIVO (Minhas Notas)"));
//		}
	}

	/**
	 * Método responsável por montar a lista de notas do Aluno(Histórico), ele
	 * percorre a lista de disciplinas e para cada disciplina traz o resultado
	 * do historico de cada uma. Importante: as disciplinas são montadas de
	 * acordo com a configuração academico, as disciplinas que possuem a mesma
	 * configuração ficam na mesma lista, separando assim as disciplinas pela
	 * configuração.
	 *
	 * @param matriculaVO
	 * @param periodoLetivo
	 * @param configuracaoAcademico
	 * @return
	 * @throws Exception
	 *
	 */

	public List<HistoricoVO> executarMontagemListaHistoricoAluno(MatriculaVO matriculaVO, Integer periodoLetivo, ConfiguracaoAcademicoVO configuracaoAcademico, CursoVO cursoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, String anoSemestre, boolean trazerUltimoHistorico, Boolean validarAcesso,Boolean trazerQuantidadesDisciplinas , UsuarioVO usuario) throws Exception {
		return executarMontagemListaHistoricoAlunoPorCodigoHistorico(null, matriculaVO, periodoLetivo, configuracaoAcademico, cursoVO, configuracaoFinanceiro, anoSemestre, trazerUltimoHistorico, validarAcesso,trazerQuantidadesDisciplinas,  usuario);
	}

	public void verificarCampoNuloAdicionarTextoSemNota(ConfiguracaoAcademicoVO configuracaoAcademicoVO, HistoricoVO obj) {
		if (!obj.getConfiguracaoAcademico().getApresentarTextoSemNotaCampoNuloHistorico()) {
			return;
		}
		if (obj.getNota1() == null && !obj.getConfiguracaoAcademico().getTituloNota1().equals("")) {
			obj.setNota1Texto("SN");
		}
		if (obj.getNota2() == null && !obj.getConfiguracaoAcademico().getTituloNota2().equals("")) {
			obj.setNota2Texto("SN");
		}
		if (obj.getNota3() == null && !obj.getConfiguracaoAcademico().getTituloNota3().equals("")) {
			obj.setNota3Texto("SN");
		}
		if (obj.getNota4() == null && !obj.getConfiguracaoAcademico().getTituloNota4().equals("")) {
			obj.setNota4Texto("SN");
		}
		if (obj.getNota5() == null && !obj.getConfiguracaoAcademico().getTituloNota5().equals("")) {
			obj.setNota5Texto("SN");
		}
		if (obj.getNota6() == null && !obj.getConfiguracaoAcademico().getTituloNota6().equals("")) {
			obj.setNota6Texto("SN");
		}
		if (obj.getNota7() == null && !obj.getConfiguracaoAcademico().getTituloNota7().equals("")) {
			obj.setNota7Texto("SN");
		}
		if (obj.getNota8() == null && !obj.getConfiguracaoAcademico().getTituloNota8().equals("")) {
			obj.setNota8Texto("SN");
		}
		if (obj.getNota9() == null && !obj.getConfiguracaoAcademico().getTituloNota9().equals("")) {
			obj.setNota9Texto("SN");
		}
		if (obj.getNota10() == null && !obj.getConfiguracaoAcademico().getTituloNota10().equals("")) {
			obj.setNota10Texto("SN");
		}
		if (obj.getNota11() == null && !obj.getConfiguracaoAcademico().getTituloNota11().equals("")) {
			obj.setNota11Texto("SN");
		}
		if (obj.getNota12() == null && !obj.getConfiguracaoAcademico().getTituloNota12().equals("")) {
			obj.setNota12Texto("SN");
		}
		if (obj.getNota13() == null && !obj.getConfiguracaoAcademico().getTituloNota13().equals("")) {
			obj.setNota13Texto("SN");
		}

		if (obj.getNota14() == null && !obj.getConfiguracaoAcademico().getTituloNota14().equals("")) {
			obj.setNota14Texto("SN");
		}
		if (obj.getNota15() == null && !obj.getConfiguracaoAcademico().getTituloNota15().equals("")) {
			obj.setNota15Texto("SN");
		}
		if (obj.getNota16() == null && !obj.getConfiguracaoAcademico().getTituloNota16().equals("")) {
			obj.setNota16Texto("SN");
		}
		if (obj.getNota17() == null && !obj.getConfiguracaoAcademico().getTituloNota17().equals("")) {
			obj.setNota17Texto("SN");
		}
		if (obj.getNota18() == null && !obj.getConfiguracaoAcademico().getTituloNota18().equals("")) {
			obj.setNota18Texto("SN");
		}
		if (obj.getNota19() == null && !obj.getConfiguracaoAcademico().getTituloNota19().equals("")) {
			obj.setNota19Texto("SN");
		}
		if (obj.getNota20() == null && !obj.getConfiguracaoAcademico().getTituloNota20().equals("")) {
			obj.setNota20Texto("SN");
		}
		if (obj.getNota21() == null && !obj.getConfiguracaoAcademico().getTituloNota21().equals("")) {
			obj.setNota21Texto("SN");
		}
		if (obj.getNota22() == null && !obj.getConfiguracaoAcademico().getTituloNota22().equals("")) {
			obj.setNota22Texto("SN");
		}
		if (obj.getNota23() == null && !obj.getConfiguracaoAcademico().getTituloNota23().equals("")) {
			obj.setNota23Texto("SN");
		}
		if (obj.getNota24() == null && !obj.getConfiguracaoAcademico().getTituloNota24().equals("")) {
			obj.setNota24Texto("SN");
		}
		if (obj.getNota25() == null && !obj.getConfiguracaoAcademico().getTituloNota25().equals("")) {
			obj.setNota25Texto("SN");
		}
		if (obj.getNota26() == null && !obj.getConfiguracaoAcademico().getTituloNota26().equals("")) {
			obj.setNota26Texto("SN");
		}
		if (obj.getNota27() == null && !obj.getConfiguracaoAcademico().getTituloNota27().equals("")) {
			obj.setNota27Texto("SN");
		}
		if (obj.getNota28() == null && !obj.getConfiguracaoAcademico().getTituloNota28().equals("")) {
			obj.setNota28Texto("SN");
		}
		if (obj.getNota29() == null && !obj.getConfiguracaoAcademico().getTituloNota29().equals("")) {
			obj.setNota29Texto("SN");
		}
		if (obj.getNota30() == null && !obj.getConfiguracaoAcademico().getTituloNota30().equals("")) {
			obj.setNota30Texto("SN");
		}
		if (obj.getNota31() == null && !obj.getConfiguracaoAcademico().getTituloNota31().equals("")) {
			obj.setNota31Texto("SN");
		}
		if (obj.getNota32() == null && !obj.getConfiguracaoAcademico().getTituloNota32().equals("")) {
			obj.setNota32Texto("SN");
		}
		if (obj.getNota33() == null && !obj.getConfiguracaoAcademico().getTituloNota33().equals("")) {
			obj.setNota33Texto("SN");
		}
		if (obj.getNota34() == null && !obj.getConfiguracaoAcademico().getTituloNota34().equals("")) {
			obj.setNota34Texto("SN");
		}
		if (obj.getNota35() == null && !obj.getConfiguracaoAcademico().getTituloNota35().equals("")) {
			obj.setNota35Texto("SN");
		}
		if (obj.getNota36() == null && !obj.getConfiguracaoAcademico().getTituloNota36().equals("")) {
			obj.setNota36Texto("SN");
		}
		if (obj.getNota37() == null && !obj.getConfiguracaoAcademico().getTituloNota37().equals("")) {
			obj.setNota37Texto("SN");
		}
		if (obj.getNota38() == null && !obj.getConfiguracaoAcademico().getTituloNota38().equals("")) {
			obj.setNota38Texto("SN");
		}
		if (obj.getNota39() == null && !obj.getConfiguracaoAcademico().getTituloNota39().equals("")) {
			obj.setNota39Texto("SN");
		}
		if (obj.getNota40() == null && !obj.getConfiguracaoAcademico().getTituloNota40().equals("")) {
			obj.setNota40Texto("SN");
		}

		if (obj.getMediaFinal() == null) {
			obj.setMediaFinalTexto("SN");
		}
	}

	// public List consultarDisciplinaPorMatriculaPeriodo(Integer
	// matriculaPeriodo, UsuarioVO usuario) throws Exception {
	// List listaDisciplina =
	// getFacadeFactory().getDisciplinaFacade().consultarDisciplinaPorMatriculaPeriodoParaVisualizarNota(matriculaVO.getMatricula(),
	// periodoLetivo, false,
	// Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
	// return listaDisciplina;
	// }
	public void consultarConfiguracaoAcademicaDeAcordoComDisciplina(DisciplinaVO disciplinaVO, CursoVO cursoVO, HistoricoVO historicoVO, UsuarioVO usuario) throws Exception {
		ConfiguracaoAcademicoVO configuracaoAcademicoVO = getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorDisciplinaMatriculaPeriodoAlunoVinculadoGradeDisciplina(historicoVO.getDisciplina().getCodigo(), historicoVO.getMatriculaPeriodo().getCodigo(), usuario);
		if (!configuracaoAcademicoVO.getCodigo().equals(0)) {
			historicoVO.setConfiguracaoAcademico(configuracaoAcademicoVO);
		} else {
			historicoVO.setConfiguracaoAcademico(cursoVO.getConfiguracaoAcademico());
		}
	}

	

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarMediaFinal(HistoricoVO historicoVO) throws Exception {
		String sqlStr = "UPDATE historico SET mediaFinal = ? WHERE codigo = ?";
		try {
			getConexao().getJdbcTemplate().update(sqlStr, new Object[] { historicoVO.getMediaFinal(), historicoVO.getCodigo() });
		} finally {
			sqlStr = null;
		}
	}

	public List<HistoricoVO> consultarHistoricoPorListaDeMatriculaPeriodoTurmaDisciplina(List<Integer> listaMPTDs, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		String sqlStr = "SELECT * FROM historico WHERE ";
		for (int i = 0; i < listaMPTDs.size(); i++) {
			sqlStr += "matriculaperiodoturmadisciplina = " + listaMPTDs.get(i);
			if (i != listaMPTDs.size() - 1) {
				sqlStr += " or ";
			}
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, confFinanVO, usuarioLogado);
	}

	public HistoricoVO consultarHistoricoPorMatriculaPeriodoTurmaDisciplina(Integer codigoMPTD, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		String sqlStr = "SELECT * FROM historico WHERE matriculaperiodoturmadisciplina = ?";
		try {
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr, new Object[] { codigoMPTD });
			if (!tabelaResultado.next()) {
				return null;
			}
			return montarDados(tabelaResultado, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, confFinanVO, usuarioLogado);
		} finally {
			sqlStr = null;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarInformacoesInseridasRegistroAulaNota(HistoricoVO histVO) throws Exception {
		StringBuilder sqlStr = new StringBuilder("UPDATE historico SET nota1 = ").append(histVO.getNota1()).append(", nota2 = ").append(histVO.getNota2()).append(", ");
		sqlStr.append("nota3 = ").append(histVO.getNota3()).append(", nota4 = ").append(histVO.getNota4()).append(", nota5 = ").append(histVO.getNota5()).append(", ");
		sqlStr.append("nota6 = ").append(histVO.getNota6()).append(", nota7 = ").append(histVO.getNota7()).append(", nota8 = ").append(histVO.getNota8()).append(", ");
		sqlStr.append("nota9 = ").append(histVO.getNota9()).append(", nota10 = ").append(histVO.getNota10()).append(", nota11 = ").append(histVO.getNota11()).append(", ");
		sqlStr.append("nota12 = ").append(histVO.getNota12()).append(", nota13 = ").append(histVO.getNota13()).append(", nota14 = ").append(histVO.getNota14()).append(", ");
		sqlStr.append("nota15 = ").append(histVO.getNota15()).append(", nota16 = ").append(histVO.getNota16()).append(", nota17 = ").append(histVO.getNota17()).append(", ");
		sqlStr.append("nota18 = ").append(histVO.getNota18()).append(", nota19 = ").append(histVO.getNota19()).append(", nota20 = ").append(histVO.getNota20()).append(", ");
		sqlStr.append("nota21 = ").append(histVO.getNota21()).append(", nota22 = ").append(histVO.getNota22()).append(", nota23 = ").append(histVO.getNota23()).append(", ");
		sqlStr.append("nota24 = ").append(histVO.getNota24()).append(", nota25 = ").append(histVO.getNota25()).append(", nota26 = ").append(histVO.getNota26()).append(", ");
		sqlStr.append("nota27 = ").append(histVO.getNota27()).append(", nota28 = ").append(histVO.getNota28()).append(", nota29 = ").append(histVO.getNota29()).append(", ");
		sqlStr.append("nota30 = ").append(histVO.getNota30()).append(", ");
		sqlStr.append("nota31 = ").append(histVO.getNota31()).append(", nota32 = ").append(histVO.getNota32()).append(", nota33 = ").append(histVO.getNota33()).append(", ");
		sqlStr.append("nota34 = ").append(histVO.getNota34()).append(", nota35 = ").append(histVO.getNota35()).append(", nota36 = ").append(histVO.getNota36()).append(", ");
		sqlStr.append("nota37 = ").append(histVO.getNota37()).append(", nota38 = ").append(histVO.getNota38()).append(", nota39 = ").append(histVO.getNota39()).append(", ");
		sqlStr.append("nota40 = ").append(histVO.getNota40()).append(", ");

		sqlStr.append("nota1lancada = ").append(histVO.getNota1Lancada()).append(", nota2lancada = ").append(histVO.getNota2Lancada()).append(", ");
		sqlStr.append("nota3lancada = ").append(histVO.getNota3Lancada()).append(", nota4lancada = ").append(histVO.getNota4Lancada()).append(", ");
		sqlStr.append("nota5lancada = ").append(histVO.getNota5Lancada()).append(", nota6lancada = ").append(histVO.getNota6Lancada()).append(", ");
		sqlStr.append("nota7lancada = ").append(histVO.getNota7Lancada()).append(", nota8lancada = ").append(histVO.getNota8Lancada()).append(", ");
		sqlStr.append("nota9lancada = ").append(histVO.getNota9Lancada()).append(", nota10lancada = ").append(histVO.getNota10Lancada()).append(", ");
		sqlStr.append("nota11lancada = ").append(histVO.getNota11Lancada()).append(", nota12lancada = ").append(histVO.getNota12Lancada()).append(", ");
		sqlStr.append("nota13lancada = ").append(histVO.getNota13Lancada()).append(", nota14lancada = ").append(histVO.getNota14Lancada()).append(", ");
		sqlStr.append("nota15lancada = ").append(histVO.getNota15Lancada()).append(", nota16lancada = ").append(histVO.getNota16Lancada()).append(", ");
		sqlStr.append("nota17lancada = ").append(histVO.getNota17Lancada()).append(", nota18lancada = ").append(histVO.getNota18Lancada()).append(", ");
		sqlStr.append("nota19lancada = ").append(histVO.getNota19Lancada()).append(", nota20lancada = ").append(histVO.getNota20Lancada()).append(", ");
		sqlStr.append("nota21lancada = ").append(histVO.getNota21Lancada()).append(", nota22lancada = ").append(histVO.getNota22Lancada()).append(", ");
		sqlStr.append("nota23lancada = ").append(histVO.getNota23Lancada()).append(", nota24lancada = ").append(histVO.getNota24Lancada()).append(", ");
		sqlStr.append("nota25lancada = ").append(histVO.getNota25Lancada()).append(", nota26lancada = ").append(histVO.getNota26Lancada()).append(", ");
		sqlStr.append("nota27lancada = ").append(histVO.getNota27Lancada()).append(", nota28lancada = ").append(histVO.getNota28Lancada()).append(", ");
		sqlStr.append("nota29lancada = ").append(histVO.getNota29Lancada()).append(", nota30lancada = ").append(histVO.getNota30Lancada()).append(", ");
		sqlStr.append("nota31lancada = ").append(histVO.getNota31Lancada()).append(", nota32lancada = ").append(histVO.getNota32Lancada()).append(", ");
		sqlStr.append("nota33lancada = ").append(histVO.getNota33Lancada()).append(", nota34lancada = ").append(histVO.getNota34Lancada()).append(", ");
		sqlStr.append("nota35lancada = ").append(histVO.getNota35Lancada()).append(", nota36lancada = ").append(histVO.getNota36Lancada()).append(", ");
		sqlStr.append("nota37lancada = ").append(histVO.getNota37Lancada()).append(", nota38lancada = ").append(histVO.getNota38Lancada()).append(", ");
		sqlStr.append("nota39lancada = ").append(histVO.getNota39Lancada()).append(", nota40lancada = ").append(histVO.getNota40Lancada()).append(", ");

		sqlStr.append("mediafinal = ").append(histVO.getMediaFinal()).append(", ");
		sqlStr.append("situacao = '").append(histVO.getSituacao()).append("', freguencia = ").append(histVO.getFreguencia()).append(" ");
		sqlStr.append("WHERE codigo = ").append(histVO.getCodigo()).append(" ");
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}

	public void alterarNotaDisciplinaComposta(String nomeNota, Integer historico, Double nota) {
		StringBuilder sb = new StringBuilder();
		sb.append("UPDATE historico SET ").append(nomeNota.toString()).append(" = ").append(nota);
		sb.append(" WHERE codigo = ").append(historico);
		try {
			getConexao().getJdbcTemplate().update(sb.toString());
		} finally {
			sb = null;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirComBaseNaMatricula(String matricula, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("DELETE FROM historico WHERE matricula = '").append(matricula).append("' ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirComBaseNaMatriculaPeriodo(Integer codMatriculaPeriodo, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("DELETE FROM historico WHERE matriculaperiodo = ").append(codMatriculaPeriodo).append(" ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirComBaseNaMatriculaPeriodoCodDisciplinaSituacaoHistorico(Integer codMatriculaPeriodo, Integer codDisciplina, String situacao, Integer gradeCurricularAtual, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("DELETE FROM historico WHERE matriculaperiodo = ").append(codMatriculaPeriodo);
		sqlStr.append(" AND (disciplina = ").append(codDisciplina).append(") ");
		sqlStr.append(" AND (situacao = '").append(situacao).append("') ");
		if (gradeCurricularAtual != null && !gradeCurricularAtual.equals(0)) {
			sqlStr.append(" AND matrizCurricular = ").append(gradeCurricularAtual);
		}
		sqlStr.append(" ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirComBaseNaMatriculaPeriodoMatrizCurricularCodDisciplinaSituacaoHistorico(Integer codMatriculaPeriodo, Integer matrizCurricular, Integer codDisciplina, String situacao, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("DELETE FROM historico WHERE matriculaperiodo = ").append(codMatriculaPeriodo);
		sqlStr.append(" AND matrizcurricular = ").append(matrizCurricular);
		sqlStr.append(" AND (disciplina = ").append(codDisciplina).append(") ");
		if (!situacao.equals("")) {
			sqlStr.append(" AND (situacao = '").append(situacao).append("') ");
		}
		sqlStr.append(" ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}


	public String consultarMediaAlunoDisciplina(String matricula, Integer disciplina) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		try {
			sqlStr.append("SELECT mediafinal FROM historico WHERE matricula = '").append(matricula).append("' ");
			sqlStr.append("AND disciplina = ").append(disciplina).append(" ORDER BY codigo DESC LIMIT 1");
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			if (!tabelaResultado.next()) {
				return "";
			}
			return String.valueOf(tabelaResultado.getDouble("mediafinal"));
		} finally {
			sqlStr = null;
		}
	}

	public List<HistoricoVO> consultaRapidaPorMatriculaSituacaoAprovadoAproveitamentoMedia(String matricula, boolean aprovadoAproveitamento, boolean aprovadoMedia, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (historico.matricula = '").append(matricula).append("') ");
		if (aprovadoAproveitamento && aprovadoMedia) {
			sqlStr.append(" AND (historico.situacao = 'AA' OR historico.situacao = 'AP') ");
		} else {
			if (aprovadoAproveitamento) {
				sqlStr.append(" AND (historico.situacao = 'AA') ");
			}
			if (aprovadoMedia) {
				sqlStr.append(" AND (historico.situacao = 'AP') ");
			}
		}
		sqlStr.append(" ORDER BY disciplina.codigo");
		// //System.out.println(sqlStr.toString());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaCompleta(tabelaResultado, usuario);
	}

	public HashMap<Integer, HistoricoVO> consultaRapidaPorMatriculaDisciplinasHistoricoSemDadosSubordinados(String matricula, List<HistoricoVO> listaHistorico, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder("SELECT historico.*, configuracaoAcademico.intervaloNotasDiferente AS \"configuracaoAcademico.intervaloNotasDiferente\"  FROM historico left join configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico");
		StringBuffer sqlStrModificada = null;
		SqlRowSet tabelaResultado = null;
		sqlStr.append(" WHERE (historico.matricula = '").append(matricula).append("') ");
		if (listaHistorico != null && !listaHistorico.isEmpty()) {
			sqlStr.append(" AND historico.disciplina in(");
			for (HistoricoVO historico : listaHistorico) {
				sqlStr.append(historico.getDisciplina().getCodigo()).append(", ");
			}
			sqlStrModificada = new StringBuffer();
			sqlStrModificada.append(sqlStr.toString().substring(0, sqlStr.toString().length() - 2));
		}
		if (sqlStrModificada == null) {
			sqlStr.append(" ORDER BY historico.disciplina");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		} else {
			sqlStrModificada.append(") ORDER BY historico.disciplina");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStrModificada.toString());
		}
		return montarDadosConsultaSemDadosSubordinados(tabelaResultado, usuario);
	}

	public HashMap<Integer, HistoricoVO> montarDadosConsultaSemDadosSubordinados(SqlRowSet tabelaResultado, UsuarioVO usuario) throws Exception {
		HashMap<Integer, HistoricoVO> vetResultado = new HashMap<Integer, HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			obj = montarDadosSemDadosSubordinados(tabelaResultado, usuario);
			vetResultado.put(obj.getDisciplina().getCodigo(), obj);
		}
		return vetResultado;
	}

	public static HistoricoVO montarDadosSemDadosSubordinados(SqlRowSet dadosSQL, UsuarioVO usuario) throws Exception {
		HistoricoVO obj = new HistoricoVO();
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula"));
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina")));
		obj.getCidadeVO().setCodigo(new Integer(dadosSQL.getInt("cidade")));
		obj.setCargaHorariaAproveitamentoDisciplina(dadosSQL.getInt("cargaHorariaAproveitamentoDisciplina"));
		obj.setCargaHorariaCursada(dadosSQL.getInt("cargaHorariaCursada"));
		obj.setInstituicao(dadosSQL.getString("instituicao"));
		obj.setTipoHistorico(dadosSQL.getString("tipoHistorico"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setAnoHistorico(dadosSQL.getString("anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestreHistorico"));
		obj.setFreguencia(new Double(dadosSQL.getDouble("freguencia")));
		obj.getResponsavel().setCodigo(new Integer(dadosSQL.getInt("responsavel")));
		obj.setDataRegistro(dadosSQL.getDate("dataRegistro"));
		obj.setUtilizaNotaFinalConceito(dadosSQL.getBoolean("utilizaNotaFinalConceito"));
		obj.setNotaFinalConceito(dadosSQL.getString("notaFinalConceito"));
		obj.setNumeroAgrupamentoEquivalenciaDisciplina(dadosSQL.getInt("numeroAgrupamentoEquivalenciaDisciplina"));
		if (dadosSQL.getObject("nota1") == null) {
			obj.setNota1((Double) dadosSQL.getObject("nota1"));
		} else {
			obj.setNota1(dadosSQL.getDouble("nota1"));
		}
		if (dadosSQL.getObject("nota2") == null) {
			obj.setNota2((Double) dadosSQL.getObject("nota2"));
		} else {
			obj.setNota2(dadosSQL.getDouble("nota2"));
		}
		if (dadosSQL.getObject("nota3") == null) {
			obj.setNota3((Double) dadosSQL.getObject("nota3"));
		} else {
			obj.setNota3(dadosSQL.getDouble("nota3"));
		}
		if (dadosSQL.getObject("nota4") == null) {
			obj.setNota4((Double) dadosSQL.getObject("nota4"));
		} else {
			obj.setNota4(dadosSQL.getDouble("nota4"));
		}
		if (dadosSQL.getObject("nota5") == null) {
			obj.setNota5((Double) dadosSQL.getObject("nota5"));
		} else {
			obj.setNota5(dadosSQL.getDouble("nota5"));
		}
		if (dadosSQL.getObject("nota6") == null) {
			obj.setNota6((Double) dadosSQL.getObject("nota6"));
		} else {
			obj.setNota6(dadosSQL.getDouble("nota6"));
		}
		if (dadosSQL.getObject("nota7") == null) {
			obj.setNota7((Double) dadosSQL.getObject("nota7"));
		} else {
			obj.setNota7(dadosSQL.getDouble("nota7"));
		}
		if (dadosSQL.getObject("nota8") == null) {
			obj.setNota8((Double) dadosSQL.getObject("nota8"));
		} else {
			obj.setNota8(dadosSQL.getDouble("nota8"));
		}
		if (dadosSQL.getObject("nota9") == null) {
			obj.setNota9((Double) dadosSQL.getObject("nota9"));
		} else {
			obj.setNota9(dadosSQL.getDouble("nota9"));
		}
		if (dadosSQL.getObject("nota10") == null) {
			obj.setNota10((Double) dadosSQL.getObject("nota10"));
		} else {
			obj.setNota10(dadosSQL.getDouble("nota10"));
		}
		if (dadosSQL.getObject("nota11") == null) {
			obj.setNota11((Double) dadosSQL.getObject("nota11"));
		} else {
			obj.setNota11(dadosSQL.getDouble("nota11"));
		}
		if (dadosSQL.getObject("nota12") == null) {
			obj.setNota12((Double) dadosSQL.getObject("nota12"));
		} else {
			obj.setNota12(dadosSQL.getDouble("nota12"));
		}
		if (dadosSQL.getObject("nota13") == null) {
			obj.setNota13((Double) dadosSQL.getObject("nota13"));
		} else {
			obj.setNota13(dadosSQL.getDouble("nota13"));
		}
		if (dadosSQL.getObject("nota14") == null) {
			obj.setNota14((Double) dadosSQL.getObject("nota14"));
		} else {
			obj.setNota14(dadosSQL.getDouble("nota14"));
		}
		if (dadosSQL.getObject("nota15") == null) {
			obj.setNota15((Double) dadosSQL.getObject("nota15"));
		} else {
			obj.setNota15(dadosSQL.getDouble("nota15"));
		}
		if (dadosSQL.getObject("nota16") == null) {
			obj.setNota16((Double) dadosSQL.getObject("nota16"));
		} else {
			obj.setNota16(dadosSQL.getDouble("nota16"));
		}
		if (dadosSQL.getObject("nota17") == null) {
			obj.setNota17((Double) dadosSQL.getObject("nota17"));
		} else {
			obj.setNota17(dadosSQL.getDouble("nota17"));
		}
		if (dadosSQL.getObject("nota18") == null) {
			obj.setNota18((Double) dadosSQL.getObject("nota18"));
		} else {
			obj.setNota18(dadosSQL.getDouble("nota18"));
		}
		if (dadosSQL.getObject("nota19") == null) {
			obj.setNota19((Double) dadosSQL.getObject("nota19"));
		} else {
			obj.setNota19(dadosSQL.getDouble("nota19"));
		}
		if (dadosSQL.getObject("nota20") == null) {
			obj.setNota20((Double) dadosSQL.getObject("nota20"));
		} else {
			obj.setNota20(dadosSQL.getDouble("nota20"));
		}
		if (dadosSQL.getObject("nota21") == null) {
			obj.setNota21((Double) dadosSQL.getObject("nota21"));
		} else {
			obj.setNota21(dadosSQL.getDouble("nota21"));
		}
		if (dadosSQL.getObject("nota22") == null) {
			obj.setNota22((Double) dadosSQL.getObject("nota22"));
		} else {
			obj.setNota22(dadosSQL.getDouble("nota22"));
		}
		if (dadosSQL.getObject("nota23") == null) {
			obj.setNota23((Double) dadosSQL.getObject("nota23"));
		} else {
			obj.setNota23(dadosSQL.getDouble("nota23"));
		}
		if (dadosSQL.getObject("nota24") == null) {
			obj.setNota24((Double) dadosSQL.getObject("nota24"));
		} else {
			obj.setNota24(dadosSQL.getDouble("nota24"));
		}
		if (dadosSQL.getObject("nota25") == null) {
			obj.setNota25((Double) dadosSQL.getObject("nota25"));
		} else {
			obj.setNota25(dadosSQL.getDouble("nota25"));
		}
		if (dadosSQL.getObject("nota26") == null) {
			obj.setNota26((Double) dadosSQL.getObject("nota26"));
		} else {
			obj.setNota26(dadosSQL.getDouble("nota26"));
		}
		if (dadosSQL.getObject("nota27") == null) {
			obj.setNota27((Double) dadosSQL.getObject("nota27"));
		} else {
			obj.setNota27(dadosSQL.getDouble("nota27"));
		}
		if (dadosSQL.getObject("nota28") == null) {
			obj.setNota28((Double) dadosSQL.getObject("nota28"));
		} else {
			obj.setNota28(dadosSQL.getDouble("nota28"));
		}
		if (dadosSQL.getObject("nota29") == null) {
			obj.setNota29((Double) dadosSQL.getObject("nota29"));
		} else {
			obj.setNota29(dadosSQL.getDouble("nota29"));
		}
		if (dadosSQL.getObject("nota30") == null) {
			obj.setNota30((Double) dadosSQL.getObject("nota30"));
		} else {
			obj.setNota30(dadosSQL.getDouble("nota30"));
		}
		if (dadosSQL.getObject("nota31") == null) {
			obj.setNota31((Double) dadosSQL.getObject("nota31"));
		} else {
			obj.setNota31(dadosSQL.getDouble("nota31"));
		}
		if (dadosSQL.getObject("nota32") == null) {
			obj.setNota32((Double) dadosSQL.getObject("nota32"));
		} else {
			obj.setNota32(dadosSQL.getDouble("nota32"));
		}
		if (dadosSQL.getObject("nota33") == null) {
			obj.setNota33((Double) dadosSQL.getObject("nota33"));
		} else {
			obj.setNota33(dadosSQL.getDouble("nota33"));
		}
		if (dadosSQL.getObject("nota34") == null) {
			obj.setNota34((Double) dadosSQL.getObject("nota34"));
		} else {
			obj.setNota34(dadosSQL.getDouble("nota34"));
		}
		if (dadosSQL.getObject("nota35") == null) {
			obj.setNota35((Double) dadosSQL.getObject("nota35"));
		} else {
			obj.setNota35(dadosSQL.getDouble("nota35"));
		}
		if (dadosSQL.getObject("nota36") == null) {
			obj.setNota36((Double) dadosSQL.getObject("nota36"));
		} else {
			obj.setNota36(dadosSQL.getDouble("nota36"));
		}
		if (dadosSQL.getObject("nota37") == null) {
			obj.setNota37((Double) dadosSQL.getObject("nota37"));
		} else {
			obj.setNota37(dadosSQL.getDouble("nota37"));
		}
		if (dadosSQL.getObject("nota38") == null) {
			obj.setNota38((Double) dadosSQL.getObject("nota38"));
		} else {
			obj.setNota38(dadosSQL.getDouble("nota38"));
		}
		if (dadosSQL.getObject("nota39") == null) {
			obj.setNota39((Double) dadosSQL.getObject("nota39"));
		} else {
			obj.setNota39(dadosSQL.getDouble("nota39"));
		}
		if (dadosSQL.getObject("nota40") == null) {
			obj.setNota40((Double) dadosSQL.getObject("nota40"));
		} else {
			obj.setNota40(dadosSQL.getDouble("nota40"));
		}

		obj.setNota1Lancada(dadosSQL.getBoolean("nota1Lancada"));
		obj.setNota2Lancada(dadosSQL.getBoolean("nota2Lancada"));
		obj.setNota3Lancada(dadosSQL.getBoolean("nota3Lancada"));
		obj.setNota4Lancada(dadosSQL.getBoolean("nota4Lancada"));
		obj.setNota5Lancada(dadosSQL.getBoolean("nota5Lancada"));
		obj.setNota6Lancada(dadosSQL.getBoolean("nota6Lancada"));
		obj.setNota7Lancada(dadosSQL.getBoolean("nota7Lancada"));
		obj.setNota8Lancada(dadosSQL.getBoolean("nota8Lancada"));
		obj.setNota9Lancada(dadosSQL.getBoolean("nota9Lancada"));
		obj.setNota10Lancada(dadosSQL.getBoolean("nota10Lancada"));
		obj.setNota11Lancada(dadosSQL.getBoolean("nota11Lancada"));
		obj.setNota12Lancada(dadosSQL.getBoolean("nota12Lancada"));
		obj.setNota13Lancada(dadosSQL.getBoolean("nota13Lancada"));
		obj.setNota14Lancada(dadosSQL.getBoolean("nota14Lancada"));
		obj.setNota15Lancada(dadosSQL.getBoolean("nota15Lancada"));
		obj.setNota16Lancada(dadosSQL.getBoolean("nota16Lancada"));
		obj.setNota17Lancada(dadosSQL.getBoolean("nota17Lancada"));
		obj.setNota18Lancada(dadosSQL.getBoolean("nota18Lancada"));
		obj.setNota19Lancada(dadosSQL.getBoolean("nota19Lancada"));
		obj.setNota20Lancada(dadosSQL.getBoolean("nota20Lancada"));
		obj.setNota21Lancada(dadosSQL.getBoolean("nota21Lancada"));
		obj.setNota22Lancada(dadosSQL.getBoolean("nota22Lancada"));
		obj.setNota23Lancada(dadosSQL.getBoolean("nota23Lancada"));
		obj.setNota24Lancada(dadosSQL.getBoolean("nota24Lancada"));
		obj.setNota25Lancada(dadosSQL.getBoolean("nota25Lancada"));
		obj.setNota26Lancada(dadosSQL.getBoolean("nota26Lancada"));
		obj.setNota27Lancada(dadosSQL.getBoolean("nota27Lancada"));
		obj.setNota28Lancada(dadosSQL.getBoolean("nota28Lancada"));
		obj.setNota29Lancada(dadosSQL.getBoolean("nota29Lancada"));
		obj.setNota30Lancada(dadosSQL.getBoolean("nota30Lancada"));

		obj.setNota31Lancada(dadosSQL.getBoolean("nota31Lancada"));
		obj.setNota32Lancada(dadosSQL.getBoolean("nota32Lancada"));
		obj.setNota33Lancada(dadosSQL.getBoolean("nota33Lancada"));
		obj.setNota34Lancada(dadosSQL.getBoolean("nota34Lancada"));
		obj.setNota35Lancada(dadosSQL.getBoolean("nota35Lancada"));
		obj.setNota36Lancada(dadosSQL.getBoolean("nota36Lancada"));
		obj.setNota37Lancada(dadosSQL.getBoolean("nota37Lancada"));
		obj.setNota38Lancada(dadosSQL.getBoolean("nota38Lancada"));
		obj.setNota39Lancada(dadosSQL.getBoolean("nota39Lancada"));
		obj.setNota40Lancada(dadosSQL.getBoolean("nota40Lancada"));
		obj.setApresentarAprovadoHistorico(dadosSQL.getBoolean("apresentarAprovadoHistorico"));
		obj.setUpdated(dadosSQL.getTimestamp("updated"));

		obj.getMatriculaPeriodo().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodo")));
		if (dadosSQL.getObject("mediaFinal") == null) {
			obj.setMediaFinal((Double) dadosSQL.getObject("mediaFinal"));
		} else {
			obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
		}
		obj.getConfiguracaoAcademico().setCodigo(dadosSQL.getInt("configuracaoAcademico"));
		obj.getMatriculaPeriodo().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodo")));
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(new Integer(dadosSQL.getInt("matriculaPeriodoTurmaDisciplina")));
		obj.setTransferenciaEntradaDisciplinasAproveitadas(new Integer(dadosSQL.getInt("transferenciaEntradaDisciplinasAproveitadas")));
		obj.setNovoObj(Boolean.FALSE);
		obj.setFrequenciaTeorica(dadosSQL.getDouble("frequenciaTeorica"));
		obj.setFrequenciaPratica(dadosSQL.getDouble("frequenciaPratica"));
		return obj;
	}

	public void inicializarDadosHistoricoUnificacaoDisciplina(HistoricoVO historicoPermanecer, HistoricoVO historicoExcluir) {
		historicoPermanecer.setNota1(historicoExcluir.getNota1());
		historicoPermanecer.setNota2(historicoExcluir.getNota2());
		historicoPermanecer.setNota3(historicoExcluir.getNota3());
		historicoPermanecer.setNota4(historicoExcluir.getNota4());
		historicoPermanecer.setNota5(historicoExcluir.getNota5());
		historicoPermanecer.setNota6(historicoExcluir.getNota6());
		historicoPermanecer.setNota7(historicoExcluir.getNota7());
		historicoPermanecer.setNota8(historicoExcluir.getNota8());
		historicoPermanecer.setNota9(historicoExcluir.getNota9());
		historicoPermanecer.setNota10(historicoExcluir.getNota10());
		historicoPermanecer.setNota11(historicoExcluir.getNota11());
		historicoPermanecer.setNota12(historicoExcluir.getNota12());
		historicoPermanecer.setNota13(historicoExcluir.getNota13());
		historicoPermanecer.setNota14(historicoExcluir.getNota14());
		historicoPermanecer.setNota15(historicoExcluir.getNota15());
		historicoPermanecer.setNota16(historicoExcluir.getNota16());
		historicoPermanecer.setNota17(historicoExcluir.getNota17());
		historicoPermanecer.setNota18(historicoExcluir.getNota18());
		historicoPermanecer.setNota19(historicoExcluir.getNota19());
		historicoPermanecer.setNota20(historicoExcluir.getNota20());
		historicoPermanecer.setNota21(historicoExcluir.getNota21());
		historicoPermanecer.setNota22(historicoExcluir.getNota22());
		historicoPermanecer.setNota23(historicoExcluir.getNota23());
		historicoPermanecer.setNota24(historicoExcluir.getNota24());
		historicoPermanecer.setNota25(historicoExcluir.getNota25());
		historicoPermanecer.setNota26(historicoExcluir.getNota26());
		historicoPermanecer.setNota27(historicoExcluir.getNota27());
		historicoPermanecer.setNota28(historicoExcluir.getNota28());
		historicoPermanecer.setNota29(historicoExcluir.getNota29());
		historicoPermanecer.setNota30(historicoExcluir.getNota30());
		historicoPermanecer.setNota31(historicoExcluir.getNota31());
		historicoPermanecer.setNota32(historicoExcluir.getNota32());
		historicoPermanecer.setNota33(historicoExcluir.getNota33());
		historicoPermanecer.setNota34(historicoExcluir.getNota34());
		historicoPermanecer.setNota35(historicoExcluir.getNota35());
		historicoPermanecer.setNota36(historicoExcluir.getNota36());
		historicoPermanecer.setNota37(historicoExcluir.getNota37());
		historicoPermanecer.setNota38(historicoExcluir.getNota38());
		historicoPermanecer.setNota39(historicoExcluir.getNota39());
		historicoPermanecer.setNota40(historicoExcluir.getNota40());

		historicoPermanecer.setDataRegistro(historicoExcluir.getDataRegistro());
		historicoPermanecer.setResponsavel(historicoExcluir.getResponsavel());
		historicoPermanecer.setFreguencia(historicoExcluir.getFreguencia());
		historicoPermanecer.setSituacao(historicoExcluir.getSituacao());
		historicoPermanecer.setTipoHistorico(historicoExcluir.getTipoHistorico());
		historicoPermanecer.setTransferenciaEntradaDisciplinasAproveitadas(historicoExcluir.getTransferenciaEntradaDisciplinasAproveitadas());
		historicoPermanecer.setMediaFinal(historicoExcluir.getMediaFinal());
		historicoPermanecer.setUtilizaNotaFinalConceito(historicoExcluir.getUtilizaNotaFinalConceito());
		historicoPermanecer.setNotaFinalConceito(historicoExcluir.getNotaFinalConceito());
		historicoPermanecer.setConfiguracaoAcademico(historicoExcluir.getConfiguracaoAcademico());
		historicoPermanecer.setDisciplinasAproveitadas(historicoExcluir.getDisciplinasAproveitadas());
		historicoPermanecer.setCargaHorariaAproveitamentoDisciplina(historicoExcluir.getCargaHorariaAproveitamentoDisciplina());
		historicoPermanecer.setCargaHorariaCursada(historicoExcluir.getCargaHorariaCursada());
		historicoPermanecer.setAnoHistorico(historicoExcluir.getAnoHistorico());
		historicoPermanecer.setSemestreHistorico(historicoExcluir.getSemestreHistorico());
		historicoPermanecer.setInstituicao(historicoExcluir.getInstituicao());
		historicoPermanecer.getCidadeVO().setCodigo(historicoExcluir.getCidadeVO().getCodigo());
		historicoPermanecer.setNota1Lancada(historicoExcluir.getNota1Lancada());
		historicoPermanecer.setNota2Lancada(historicoExcluir.getNota2Lancada());
		historicoPermanecer.setNota3Lancada(historicoExcluir.getNota3Lancada());
		historicoPermanecer.setNota4Lancada(historicoExcluir.getNota4Lancada());
		historicoPermanecer.setNota5Lancada(historicoExcluir.getNota5Lancada());
		historicoPermanecer.setNota6Lancada(historicoExcluir.getNota6Lancada());
		historicoPermanecer.setNota7Lancada(historicoExcluir.getNota7Lancada());
		historicoPermanecer.setNota8Lancada(historicoExcluir.getNota8Lancada());
		historicoPermanecer.setNota9Lancada(historicoExcluir.getNota9Lancada());
		historicoPermanecer.setNota10Lancada(historicoExcluir.getNota10Lancada());
		historicoPermanecer.setNota11Lancada(historicoExcluir.getNota11Lancada());
		historicoPermanecer.setNota12Lancada(historicoExcluir.getNota12Lancada());
		historicoPermanecer.setNota13Lancada(historicoExcluir.getNota13Lancada());
		historicoPermanecer.setNota14Lancada(historicoExcluir.getNota14Lancada());
		historicoPermanecer.setNota15Lancada(historicoExcluir.getNota15Lancada());
		historicoPermanecer.setNota16Lancada(historicoExcluir.getNota16Lancada());
		historicoPermanecer.setNota17Lancada(historicoExcluir.getNota17Lancada());
		historicoPermanecer.setNota18Lancada(historicoExcluir.getNota18Lancada());
		historicoPermanecer.setNota19Lancada(historicoExcluir.getNota19Lancada());
		historicoPermanecer.setNota20Lancada(historicoExcluir.getNota20Lancada());
		historicoPermanecer.setNota21Lancada(historicoExcluir.getNota21Lancada());
		historicoPermanecer.setNota22Lancada(historicoExcluir.getNota22Lancada());
		historicoPermanecer.setNota23Lancada(historicoExcluir.getNota23Lancada());
		historicoPermanecer.setNota24Lancada(historicoExcluir.getNota24Lancada());
		historicoPermanecer.setNota25Lancada(historicoExcluir.getNota25Lancada());
		historicoPermanecer.setNota26Lancada(historicoExcluir.getNota26Lancada());
		historicoPermanecer.setNota27Lancada(historicoExcluir.getNota27Lancada());
		historicoPermanecer.setNota28Lancada(historicoExcluir.getNota28Lancada());
		historicoPermanecer.setNota29Lancada(historicoExcluir.getNota29Lancada());
		historicoPermanecer.setNota30Lancada(historicoExcluir.getNota30Lancada());
		historicoPermanecer.setNota31Lancada(historicoExcluir.getNota31Lancada());
		historicoPermanecer.setNota32Lancada(historicoExcluir.getNota32Lancada());
		historicoPermanecer.setNota33Lancada(historicoExcluir.getNota33Lancada());
		historicoPermanecer.setNota34Lancada(historicoExcluir.getNota34Lancada());
		historicoPermanecer.setNota35Lancada(historicoExcluir.getNota35Lancada());
		historicoPermanecer.setNota36Lancada(historicoExcluir.getNota36Lancada());
		historicoPermanecer.setNota37Lancada(historicoExcluir.getNota37Lancada());
		historicoPermanecer.setNota38Lancada(historicoExcluir.getNota38Lancada());
		historicoPermanecer.setNota39Lancada(historicoExcluir.getNota39Lancada());
		historicoPermanecer.setNota40Lancada(historicoExcluir.getNota40Lancada());
		historicoPermanecer.setApresentarAprovadoHistorico(historicoExcluir.getApresentarAprovadoHistorico());
		historicoPermanecer.setUpdated(historicoExcluir.getUpdated());
	}

	public List<Integer> consultarPorCodigoDisciplina(Integer codigoExcluir) {
		List<Integer> listaMatriculaPeriodo = new ArrayList(0);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT matriculaPeriodo FROM  historico WHERE disciplina = ");
		sqlStr.append(codigoExcluir);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		while (tabelaResultado.next()) {
			listaMatriculaPeriodo.add(tabelaResultado.getInt("matriculaPeriodo"));
		}
		return listaMatriculaPeriodo;
	}

	public List<HistoricoVO> consultarDisciplinaCursadasAlunoPorMatricula(String matricula, Integer gradeCurricular, Integer disciplina, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, Integer limit, Boolean considerarDisciplinasCursando) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select periodoletivo.periodoletivo as \"periodoletivo.periodoletivo\", historico.*, configuracaoAcademico.intervaloNotasDiferente as \"configuracaoAcademico.intervaloNotasDiferente\", ");
		sqlStr.append(" (case when historico.cargahorariadisciplina is not null and historico.cargahorariadisciplina > 0 ");
		sqlStr.append(" then historico.cargahorariadisciplina else case when gradedisciplina.codigo is not null ");
		sqlStr.append(" then gradedisciplina.cargahoraria else gradecurriculargrupooptativadisciplina.cargahoraria end end) AS cargaHorariaDisciplinaFinal, historico.dataInicioAula as \"historico.dataInicioAula\", historico.dataFimAula as \"historico.dataFimAula\" ");
		sqlStr.append(" from historico ");
		sqlStr.append(" LEFT JOIN matriculaPeriodo on matriculaPeriodo.matricula = historico.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		sqlStr.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		sqlStr.append(" INNER JOIN gradecurricular on historico.matrizcurricular = gradecurricular.codigo ");
		sqlStr.append(" LEFT JOIN configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico ");
		sqlStr.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		sqlStr.append(" LEFT JOIN gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = historico.gradecurriculargrupooptativadisciplina ");
		sqlStr.append(" INNER JOIN periodoletivo on matriculaperiodo.periodoletivomatricula = periodoletivo.codigo ");
		sqlStr.append(" where historico.matricula = '").append(matricula).append("' ");
		if (!gradeCurricular.equals(0)) {
			sqlStr.append(" and gradeCurricular.codigo = ").append(gradeCurricular);
		}
		sqlStr.append(" and (historico.gradecurriculargrupooptativadisciplina is not null or historico.gradedisciplina is not null or historico.historicodisciplinaforagrade) ");
		sqlStr.append(" and (historico.historicoequivalente = false or historico.historicoequivalente is null) ");
		sqlStr.append(" and (historico.historicodisciplinafazpartecomposicao = false or historico.historicodisciplinafazpartecomposicao is null) ");
		sqlStr.append(" and historico.situacao <> 'DP' ");
		sqlStr.append(" and historico.situacao <> 'IS' ");
		sqlStr.append(" and historico.situacao <> 'NC' ");
		sqlStr.append(" and historico.situacao <> 'TR' ");
		sqlStr.append(" and historico.situacao <> 'AC' ");
		sqlStr.append(" and historico.situacao <> 'CA' ");
		sqlStr.append(" and historico.situacao <> 'TF' ");
		if (!considerarDisciplinasCursando) {
			sqlStr.append(" and historico.situacao <> 'CS' ");
		}
		sqlStr.append(" and historico.situacao <> 'RE' ");
		sqlStr.append(" and historico.situacao <> 'RF' ");
		if (Uteis.isAtributoPreenchido(disciplina)) {
			sqlStr.append(" and historico.disciplina = ").append(disciplina);
		}
		sqlStr.append(" order by historico.disciplina ");
		if(limit !=  null && limit != 0) {
			sqlStr.append("limit ").append(limit);
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsultaComGradeDisciplina(tabelaResultado, nivelMontarDados, new ConfiguracaoFinanceiroVO(), usuario));
	}

	public Integer consultarQuantidadeAlunoMediaCalculada(String nivelEducacional, Integer unidadeEnsino, Integer curso, Integer disciplina, Integer turma, UsuarioVO usuario) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("SELECT COUNT(DISTINCT historico.codigo) AS qtde FROM historico ");
		sb.append(" INNER JOIN matricula ON matricula.matricula = historico.matricula ");
		sb.append(" INNER JOIN curso ON curso.codigo = matricula.curso ");
		sb.append(" INNER JOIN matriculaPeriodo ON matriculaPeriodo.matricula = matricula.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		sb.append(" WHERE historico.situacao IS NOT NULL AND historico.situacao <> '' AND mediaFinal IS NOT NULL ");
		sb.append(" AND curso.nivelEducacional = '");
		sb.append(nivelEducacional.toUpperCase());
		sb.append("' AND matricula.unidadeEnsino = ");
		sb.append(unidadeEnsino.intValue());
		sb.append(" AND matricula.curso = ");
		sb.append(curso.intValue());
		sb.append(" AND matriculaPeriodo.turma = ");
		sb.append(turma.intValue());
		sb.append(" AND historico.disciplina = ");
		sb.append(disciplina.intValue());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt(1);
		}
		return 0;
	}

	public void validarHistoricoDisciplinaCursandoPorMatricula(String matricula, Integer disciplina, Integer turma, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append(" select historico.codigo from historico ");
		sb.append(" left join matriculaperiodo on historico.matriculaperiodo = matriculaperiodo.codigo ");
		sb.append(" where historico.matricula = '").append(matricula).append("' ");
		sb.append(" and disciplina = ").append(disciplina).append(" and historico.situacao = 'CS' ");
		sb.append(" and matriculaperiodo.turma = ").append(turma);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			throw new Exception(UteisJSF.internacionalizar("msg_Historico_ErroAdicionarDisciplinaAlunoCursandoEmOutroPeriodo"));
		}
	}

	public List<HistoricoVO> consultarAlunoSolicitouAvisoAulaFutura() throws Exception {
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" where notificarsolicitacaoreposicao = true and exists ( ");
		sqlStr.append(" select horarioturmadiaitem.codigo ");
		sqlStr.append(" from horarioturmadia inner join horarioturma on horarioturma.codigo = horarioturmadia.horarioturma inner join horarioturmadiaitem on horarioturmadia.codigo = horarioturmadiaitem.horarioturmadia ");
		sqlStr.append(" where horarioturmadiaitem.disciplina = historico.disciplina and horarioturmadia.data >= current_date limit 1) ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO historicoVO = new HistoricoVO();
			montarDadosCompleto(historicoVO, tabelaResultado, new UsuarioVO());
			vetResultado.add(historicoVO);
		}
		return vetResultado;
	}

	public void realizarCalculoCargaHorariaCursada(HistoricoVO historicoVO) throws Exception {
		if (!historicoVO.getSituacao().equals("AA") && !historicoVO.getSituacao().equals("CC") && !historicoVO.getSituacao().equals("CH") && !historicoVO.getSituacao().equals("IS")) {
			if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_REGISTRO_AULA)
					&& getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(historicoVO.getMatricula().getMatricula(), historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurma().getCodigo(), historicoVO.getDisciplina().getCodigo(), 0, historicoVO.getSemestreHistorico(), historicoVO.getAnoHistorico())) {
				Integer cargaHorariaCursadaEmMinutos = getFacadeFactory().getFrequenciaAulaFacade().consultarSomaFrequenciaAlunoEspecifico(historicoVO.getMatricula().getMatricula(), historicoVO.getSemestreHistorico(), historicoVO.getAnoHistorico(), historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurma().getCodigo(), historicoVO.getDisciplina().getCodigo(), true, false, null);
				if(cargaHorariaCursadaEmMinutos != null && cargaHorariaCursadaEmMinutos > 0){
					historicoVO.setCargaHorariaCursada(cargaHorariaCursadaEmMinutos/60);
				}else if(historicoVO.getFreguencia() > 0){
					historicoVO.setCargaHorariaCursada(Double.valueOf((historicoVO.getCargaHorariaDisciplina() * historicoVO.getFreguencia()) / 100).intValue());
				}else{
					historicoVO.setCargaHorariaCursada(0);
				}
			}else if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_DISCIPLINA)
					|| historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA)){
				if (!Uteis.isAtributoPreenchido(historicoVO.getCargaHorariaDisciplina())) {
					if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
						if (!Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO().getCargaHoraria())) {
							historicoVO.setGradeDisciplinaVO(getFacadeFactory().getGradeDisciplinaFacade().consultarGradeDisciplinaPorChavePrimariaDadosCargaHorariaNrCreditos(historicoVO.getGradeDisciplinaVO().getCodigo()));
						}
						historicoVO.setCargaHorariaDisciplina(historicoVO.getGradeDisciplinaVO().getCargaHoraria());
					} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
						if (!Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria())) {
							historicoVO.setGradeCurricularGrupoOptativaDisciplinaVO(getFacadeFactory().getGradeCurricularGrupoOptativaDisciplinaFacade().consultarPorChavePrimaria(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), null));
						}
						historicoVO.setCargaHorariaDisciplina(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria());
					} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
						if (!Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta().getCargaHoraria())) {
							historicoVO.setGradeDisciplinaComposta(getFacadeFactory().getGradeDisciplinaCompostaFacade().consultarPorChavePrimaria(historicoVO.getGradeDisciplinaComposta().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, null));
						}
						historicoVO.setCargaHorariaDisciplina(historicoVO.getGradeDisciplinaComposta().getCargaHoraria());
					}
				}
				historicoVO.setCargaHorariaCursada(Double.valueOf((historicoVO.getCargaHorariaDisciplina() * historicoVO.getFreguencia()) / 100).intValue());
			}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarHistoricoAlteracaoAproveitamentoDisciplina(final Integer codigo, final DisciplinaAproveitadaAlteradaMatriculaVO obj, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set situacao=?, mediaFinal=?, freguencia=?, cargaHorariaAproveitamentoDisciplina=?, anoHistorico=?, semestreHistorico=?, instituicao=?, cidade=?, cargaHorariaCursada=?, isentarMediaFinal=?, tipoHistorico=?, utilizanotafinalconceito=?, notafinalconceito=?, apresentarAprovadoHistorico=?, dataInicioAula=?, dataFimAula=? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					sqlAlterar.setString(++i, obj.getSituacao());
					sqlAlterar.setDouble(++i, obj.getMedia());
					sqlAlterar.setDouble(++i, obj.getFrequencia());
					sqlAlterar.setInt(++i, obj.getCargaHoraria());
					sqlAlterar.setString(++i, obj.getAno());
					sqlAlterar.setString(++i, obj.getSemestre());
					sqlAlterar.setString(++i, obj.getInstituicao());
					sqlAlterar.setInt(++i, obj.getCidadeVO().getCodigo().intValue());
					sqlAlterar.setInt(++i, obj.getCargaHorariaCursada());
					sqlAlterar.setBoolean(++i, obj.getIsentarMediaFinal());
					sqlAlterar.setString(++i, obj.getTipoHistorico());
					sqlAlterar.setBoolean(++i, obj.getUtilizaNotaConceito());
					sqlAlterar.setString(++i, obj.getMediaFinalConceito());
					sqlAlterar.setBoolean(++i, obj.getApresentarAprovadoHistorico());
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataInicioAula()));
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(obj.getDataFimAula()));
					sqlAlterar.setInt(++i, obj.getCodigoHistorico());
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	/**
	 * Responsável por executar a geração da Falta do primeiro, segundo,
	 * terceiro, quarto bimestre, Total Falta e Frequência do Histórico.
	 *
	 * @author Wellington Rodrigues - 06/04/2015
	 * @param historicoVO
	 * @param configuracaoAcademicoVO
	 * @param usuarioVO
	 * @throws Exception
	 */
	@Override
	public void executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFaltaFrequenciaHistorico(HistoricoVO historicoVO, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuarioVO) throws Exception {
		if (!Uteis.isAtributoPreenchido(historicoVO.getMatriculaPeriodoTurmaDisciplina())) {
			return;
		}

		MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO = getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarPorChavePrimaria(historicoVO.getMatriculaPeriodoTurmaDisciplina().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);
		getFacadeFactory().getTurmaFacade().carregarDados(matriculaPeriodoTurmaDisciplinaVO.getTurma(), NivelMontarDados.TODOS, usuarioVO);
		DefinicoesTutoriaOnlineEnum definicoes = getFacadeFactory().getTurmaDisciplinaFacade().consultarDefinicoesTutoriaOnlineTurmaDisciplina(matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo());
		if (!configuracaoAcademicoVO.getUsarFormulaCalculoFrequencia()
				&& matriculaPeriodoTurmaDisciplinaVO.getModalidadeDisciplina().isOnline()
				&& definicoes != null && definicoes.isDinamica()) {
			historicoVO.setFreguencia(100.00);
			return;
		}
		boolean liberarRegistroAulaEntrePeriodo = getFacadeFactory().getCursoFacade().consultarLiberarRegistroAulaEntrePeriodoPorTurma(matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo(), usuarioVO);
		String ano = matriculaPeriodoTurmaDisciplinaVO.getAno();
		String semestre = matriculaPeriodoTurmaDisciplinaVO.getSemestre();
		boolean existeRegistroAulaTeorica = false;
		boolean existeRegistroAulaPratica = false;
		Integer totalFaltaTeorica = 0;
		Integer totalFaltaPratica = 0;
		if (liberarRegistroAulaEntrePeriodo) {
			ano = "";
			semestre = "";
		}
		if (Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica())) {
			existeRegistroAulaTeorica = getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(null, historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().getCodigo(), historicoVO.getDisciplina().getCodigo(), null, historicoVO.getMatriculaPeriodoTurmaDisciplina().getSemestre(), historicoVO.getMatriculaPeriodoTurmaDisciplina().getAno());
			if (existeRegistroAulaTeorica) {
				historicoVO.setFrequenciaTeorica(Uteis.arrendondarForcando2CadasDecimais(calcularFrequenciaAluno(matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica().getCodigo(), historicoVO.getDisciplina().getCodigo(), semestre, ano, historicoVO.getMatricula().getMatricula(), configuracaoAcademicoVO, usuarioVO, executarDefinicaoCargaHorariaUtilizarCalculoFrequenciaTeorica(historicoVO), false, matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica().getCodigo(),  matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getTurma().getTurno().getConsiderarHoraAulaSessentaMinutosGeracaoDiario())));
				totalFaltaTeorica = getFacadeFactory().getRegistroAulaFacade().consultaRapidaFaltasAlunoBoletimAcademico(historicoVO.getMatricula().getMatricula(), historicoVO.getDisciplina().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getSemestre(), matriculaPeriodoTurmaDisciplinaVO.getAno(), matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica().getCodigo(), false, usuarioVO);
			}
		}else{
			historicoVO.setFrequenciaTeorica(0.0);
		}
		if (Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica())) {
			existeRegistroAulaPratica = getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(null, historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().getCodigo(), historicoVO.getDisciplina().getCodigo(), null, historicoVO.getMatriculaPeriodoTurmaDisciplina().getSemestre(), historicoVO.getMatriculaPeriodoTurmaDisciplina().getAno());
			if (existeRegistroAulaPratica) {
				historicoVO.setFrequenciaPratica(Uteis.arrendondarForcando2CadasDecimais(calcularFrequenciaAluno(matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica().getCodigo(), historicoVO.getDisciplina().getCodigo(), semestre, ano, historicoVO.getMatricula().getMatricula(), configuracaoAcademicoVO, usuarioVO, executarDefinicaoCargaHorariaUtilizarCalculoFrequenciaPratica(historicoVO), false, matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica().getCodigo(),  matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getTurma().getTurno().getConsiderarHoraAulaSessentaMinutosGeracaoDiario())));
				totalFaltaPratica = getFacadeFactory().getRegistroAulaFacade().consultaRapidaFaltasAlunoBoletimAcademico(historicoVO.getMatricula().getMatricula(), historicoVO.getDisciplina().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getSemestre(), matriculaPeriodoTurmaDisciplinaVO.getAno(), matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica().getCodigo(), false, usuarioVO);
			}
		}else{
			historicoVO.setFrequenciaPratica(0.0);
		}
		if (!Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica()) && !Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica())) {
			boolean existeRegistroAula = getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(null, historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurma().getCodigo(), historicoVO.getDisciplina().getCodigo(), null, semestre, ano);
			if (existeRegistroAula || historicoVO.getFreguencia().equals(0.0)) {
				boolean considerarTurmaTeoricaEPratica = Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica()) || Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica());
				historicoVO.setFreguencia(Uteis.arrendondarForcando2CadasDecimais(calcularFrequenciaAluno(matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo(), historicoVO.getDisciplina().getCodigo(), semestre, ano, historicoVO.getMatricula().getMatricula(), configuracaoAcademicoVO, usuarioVO, executarDefinicaoCargaHorariaUtilizarCalculoFrequencia(historicoVO), considerarTurmaTeoricaEPratica, matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica().getCodigo(),  matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getTurma().getTurno().getConsiderarHoraAulaSessentaMinutosGeracaoDiario())));
			}
			executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreETotalFaltaHistorico(historicoVO, matriculaPeriodoTurmaDisciplinaVO, usuarioVO);
		} else {
			executarCalculoFrequenciaGeralDeAcordoComCargaHorariaDisciplina(historicoVO, matriculaPeriodoTurmaDisciplinaVO, existeRegistroAulaTeorica, totalFaltaTeorica, existeRegistroAulaPratica, totalFaltaPratica);
		}
		if(configuracaoAcademicoVO.getUsarFormulaCalculoFrequencia() && !configuracaoAcademicoVO.getFormulaCalculoFrequencia().trim().isEmpty()) {
			String formula = configuracaoAcademicoVO.substituirSimbolosFormulaCalculoMediaFinal(historicoVO, configuracaoAcademicoVO.getFormulaCalculoFrequencia(), null);
			historicoVO.setFreguencia(Uteis.arrendondarForcando2CadasDecimais(Uteis.realizarCalculoFormula(formula)));
	}
	}

	@Override
	public Map<String, SituacaoHistorico> executarCalcularResultadoFinalAluno(Map<String, Map<String, String>> mapMatriculaDisciplina, Map<String, ConfiguracaoAcademicoVO> mapConfiguracaoAcademicoVOs) {
		Map<String, SituacaoHistorico> mapMatriculaSituacaoFinal = new HashMap<String, SituacaoHistorico>(0);
		Map<Integer, String> mapDisciplinaSituacao = new HashMap<Integer, String>(0);

		for (String matricula : mapMatriculaDisciplina.keySet()) {
			Integer qtdeReprovacoes = 0;
			Map<String, String> mapDisciplina = mapMatriculaDisciplina.get(matricula);
			ConfiguracaoAcademicoVO configuracaoAcademicoVO = mapConfiguracaoAcademicoVOs.get(matricula);
			mapDisciplinaSituacao.clear();
			for (String disciplina : mapDisciplina.keySet()) {
				String situacao = mapDisciplina.get(disciplina);
				if (situacao.equals("TR") || situacao.equals(SituacaoHistorico.TRANCAMENTO.getDescricao()) || situacao.equals(SituacaoMatriculaPeriodoEnum.TRANCADA.getDescricao()) || situacao.equals("TF") || situacao.equals(SituacaoHistorico.TRANSFERIDO.getDescricao()) || situacao.equals("TS")  || situacao.equals(SituacaoMatriculaPeriodoEnum.TRANFERENCIA_SAIDA.getDescricao()) || situacao.equals("TI") || situacao.equals(SituacaoMatriculaPeriodoEnum.TRANFERENCIA_INTERNA.getDescricao()) || situacao.equals("CA") || situacao.equals(SituacaoMatriculaPeriodoEnum.CANCELADA.getDescricao()) || situacao.equals(SituacaoHistorico.CANCELADO.getDescricao()) || situacao.equals("PR") || situacao.equals(SituacaoMatriculaPeriodoEnum.PRE_MATRICULA.getDescricao()) || situacao.equals("AC") || situacao.equals(SituacaoMatriculaPeriodoEnum.ABANDONO_CURSO.getDescricao()) || situacao.equals(SituacaoHistorico.ABANDONO_CURSO.getDescricao()) || situacao.equals(SituacaoHistorico.JUBILADO.getValor())) {
					boolean encontrado = false;
					for (SituacaoHistorico sh : SituacaoHistorico.values()) {
						if (sh.getDescricao().equals(situacao) || sh.getValor().equals(situacao)) {
							mapDisciplinaSituacao.put(1, sh.getValor());
							encontrado = true;
						}
					}
					if (!encontrado) {
						for (SituacaoMatriculaPeriodoEnum smp : SituacaoMatriculaPeriodoEnum.values()) {
							if (smp.getDescricao().equals(situacao) || smp.getValor().equals(situacao)) {
								mapDisciplinaSituacao.put(1, smp.getValor());
							}
						}
					}
				} else if (situacao.equals("CS") || situacao.equals(SituacaoHistorico.CURSANDO.getDescricao()) || situacao.equals("CE") || situacao.equals(SituacaoHistorico.CURSANDO_POR_EQUIVALENCIA.getDescricao())) {
					mapDisciplinaSituacao.put(2, "CS");

				} else if (situacao.equals("RF") || situacao.equals("RE") || situacao.equals("DP") || situacao.equals("RP") || situacao.equals("VS") || situacao.equals(SituacaoHistorico.REPROVADO.getDescricao()) || situacao.equals(SituacaoHistorico.REPROVADO_FALTA.getDescricao()) || situacao.equals(SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getDescricao())) {
					mapDisciplinaSituacao.put(3, "RE");
					qtdeReprovacoes++;

				} else if (situacao.equals("AP") || situacao.equals("AA") || situacao.equals("CC") || situacao.equals("CH") || situacao.equals("IS") || situacao.equals("AE") || situacao.equals("AD") || situacao.equals(SituacaoHistorico.APROVADO.getDescricao()) || situacao.equals(SituacaoHistorico.APROVADO_APROVEITAMENTO.getDescricao()) || situacao.equals(SituacaoHistorico.CONCESSAO_CREDITO.getDescricao()) || situacao.equals(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getDescricao()) || situacao.equals(SituacaoHistorico.ISENTO.getDescricao()) || situacao.equals(SituacaoHistorico.APROVADO_APROVEITAMENTO.getDescricao()) || situacao.equals(SituacaoHistorico.APROVADO_COM_DEPENDENCIA.getDescricao())) {
					mapDisciplinaSituacao.put(4, "AP");
				}
			}
			if (mapDisciplinaSituacao.containsKey(1)) {
				if (mapDisciplinaSituacao.get(1).equals("TS")) {
					mapMatriculaSituacaoFinal.put(matricula, SituacaoHistorico.TRANSFERIDO);
				} else if (mapDisciplinaSituacao.get(1).equals("TI")) {
					mapMatriculaSituacaoFinal.put(matricula, SituacaoHistorico.TRANSFERIDO);
				} else {
					mapMatriculaSituacaoFinal.put(matricula, SituacaoHistorico.getEnum(mapDisciplinaSituacao.get(1)));
				}
			} else if (mapDisciplinaSituacao.containsKey(2)) {
				mapMatriculaSituacaoFinal.put(matricula, SituacaoHistorico.CURSANDO);
			} else if (mapDisciplinaSituacao.containsKey(3)) {
				if (configuracaoAcademicoVO.getIsPossuiControleDisciplinaReprovacao() && qtdeReprovacoes < configuracaoAcademicoVO.getNumeroDisciplinaConsiderarReprovadoPeriodoLetivo() && mapDisciplinaSituacao.containsKey(4)) {
					if (qtdeReprovacoes > 0) {
						mapMatriculaSituacaoFinal.put(matricula, SituacaoHistorico.APROVADO_COM_DEPENDENCIA);
					} else {
						mapMatriculaSituacaoFinal.put(matricula, SituacaoHistorico.APROVADO);
					}
				} else {
					mapMatriculaSituacaoFinal.put(matricula, SituacaoHistorico.REPROVADO);
				}
			} else if (mapDisciplinaSituacao.containsKey(4)) {
				mapMatriculaSituacaoFinal.put(matricula, SituacaoHistorico.APROVADO);
			}
		}
		return mapMatriculaSituacaoFinal;
	}

	/**
	 * Método responsável por fazer trabalho similar ao método
	 * carregarDadosMatriculaComHistoricoAlunoVO contudo, o mesmo, não carrega
	 * novamente a grade curricular novamente, ele simplemestre atualiza a lista
	 * de históricos da matricula e reprocessa os mesmos novamente atualizando a
	 * evolução academica do aluno.
	 */
	public void atualizarDadosMatriculaComHistoricoAlunoVO(MatriculaVO matriculaVO, Integer codigoGradeCurricular, Boolean carregarDadosProfessor, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuario) throws Exception {
		matriculaVO.getMatriculaComHistoricoAlunoVO().limparDadosHistoricos();
		// Montando todos os histórico do aluno para esta determinada matriz
		// curricular.
		// Iremos montar todos os históricos da matriz para este aluno.
		// Lembrando que o SEI gerencia os históricos
		// por matriz curricular. Tudo da vida academica de um aluno.
		List<HistoricoVO> listaHistoricoAlunoMatrizCurricular = getFacadeFactory().getHistoricoFacade().consultaRapidaPorMatriculaSituacaoHistorico(null, matriculaVO.getMatricula(), codigoGradeCurricular, new String[] {}, OrdemHistoricoDisciplina.MATRICULA_COM_HISTORICO_ALUNO.getValor(), carregarDadosProfessor, false, NivelMontarDados.TODOS, usuario, matriculaVO.getCurso().getConfiguracaoAcademico(), false);

		if (!matriculaVO.getHistoricosAproveitamentoDisciplinaPrevisto().isEmpty()) {
			// Lista utilizada quando uma nova matrícula está sendo realizada
			// por meio de uma transferencia
			// de entrada, com um aproveitamento de disciplinas previsto
			// vinculado à mesma.
			// Assim, este atributo é utilizado para fornecer como parametro
			// para este método
			// a lista de históricos previstos que foram registrados no
			// aproveitamento
			// de forma que a renovação já considere estas disciplinas do
			// aproveitamento como aprovadas.
			// Isto possibilitará ao aluno, por exemplo, já se matricular em um
			// período letivo
			// avançado, evitando atrasos na vida academica do mesmo e economia
			// financeira para o mesmo.
			listaHistoricoAlunoMatrizCurricular.addAll(matriculaVO.getHistoricosAproveitamentoDisciplinaPrevisto());
		}

		matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().setTodosHistoricosAlunoGradeCurricular(listaHistoricoAlunoMatrizCurricular);
		matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().montarGradeDisciplinaComHistoricoAlunoVO(configuracaoAcademicoVO);
	}

	/**
	 * Este método diferece-se do outro
	 * carregarDadosMatriculaComHistoricoAlunoVO, pois o mesmo já admite que uma
	 * gradeCurricular já carregada seja fornecida como parametro. O mesmo será
	 * utilizado somente quando este objeto gradeCurricularVO já estiver
	 * totalmente montado no método origem e, por questões, de performance,
	 * deseja-se que esta grade curricular não seja montada novamente.
	 *
	 * @param matriculaVO
	 * @param gradeCurricular
	 * @param gradeJaCarregada
	 * @param configuracaoAcademicoVO
	 * @param usuario
	 * @return
	 * @throws Exception
	 */
	public MatriculaComHistoricoAlunoVO carregarDadosMatriculaComHistoricoAlunoVO(MatriculaVO matriculaVO, GradeCurricularVO gradeCurricularCarregada, boolean gradeJaCarregada, Boolean carregarDadosProfessor,  ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuario) throws Exception {

		MatriculaComHistoricoAlunoVO matriculaComHistoricoAlunoVO = new MatriculaComHistoricoAlunoVO();
		matriculaComHistoricoAlunoVO.setMatriculaVO(matriculaVO);
		matriculaComHistoricoAlunoVO.setConfiguracaoAcademico(configuracaoAcademicoVO);

		// Montando os dados da GradeCurricular e atualizando o total da carga
		// horaria / número de creditos do curso
		if (!gradeJaCarregada) {
			GradeCurricularVO gradeCurricularCurso = getFacadeFactory().getGradeCurricularFacade().consultarPorChavePrimaria(gradeCurricularCarregada.getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, usuario);
			matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().setGradeCurricularVO(gradeCurricularCurso);
		} else {
			matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().setGradeCurricularVO(gradeCurricularCarregada);
		}

		// Montando todos os histórico do aluno para esta determinada matriz
		// curricular.
		// Iremos montar todos os históricos da matriz para este aluno.
		// Lembrando que o SEI gerencia os históricos
		// por matriz curricular. Tudo da vida academica de um aluno.
		List<HistoricoVO> listaHistoricoAlunoMatrizCurricular = getFacadeFactory().getHistoricoFacade().consultaRapidaPorMatriculaSituacaoHistorico(null, matriculaVO.getMatricula(), gradeCurricularCarregada.getCodigo(), new String[] {}, OrdemHistoricoDisciplina.MATRICULA_COM_HISTORICO_ALUNO.getValor(),  carregarDadosProfessor, false, NivelMontarDados.TODOS, usuario, matriculaVO.getCurso().getConfiguracaoAcademico(), false);
		
		if (Uteis.isAtributoPreenchido(matriculaVO.getTransferenciaEntrada()) 
				&& matriculaVO.getTransferenciaEntrada().getCarregarDisciplinasAproveitadas()
				&& matriculaVO.getTransferenciaEntrada().getSituacao().equals("AV")
				&& Uteis.isAtributoPreenchido(matriculaVO.getTransferenciaEntrada().getMatricula().getMatricula()) 
				&& matriculaVO.isNovoObj() 
				&& !matriculaVO.getMatriculaJaRegistrada()) {
			List<HistoricoVO> historicoVOs = getFacadeFactory().getHistoricoFacade().consultarHistoricoParaAproveitamentoNaTransferenciaInternaPorCursoGrade(matriculaVO.getTransferenciaEntrada().getMatricula().getAluno().getCodigo(), matriculaVO.getTransferenciaEntrada().getCurso().getCodigo(), gradeCurricularCarregada.getCodigo(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, null, usuario, matriculaVO.getCurso().getConfiguracaoAcademico());
			List<TransferenciaEntradaDisciplinasAproveitadasVO> transferenciaEntradaDisciplinasAproveitadasVOs = new ArrayList<>(0);
			getFacadeFactory().getTransferenciaEntradaFacade().adicionarDisciplinaSeremAproveitadaTransferenciaInterna(historicoVOs, transferenciaEntradaDisciplinasAproveitadasVOs, matriculaVO.getTransferenciaEntrada().getCurso().getCodigo(), gradeCurricularCarregada.getCodigo(), usuario);
			getFacadeFactory().getTransferenciaEntradaFacade().verificarDisciplinasAproveitadasRepetidas(transferenciaEntradaDisciplinasAproveitadasVOs);
			matriculaVO.getTransferenciaEntrada().setTransferenciaEntradaDisciplinasAproveitadasVOs(transferenciaEntradaDisciplinasAproveitadasVOs);
			historicoVOs.stream().forEach(h -> h.setSituacao(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor()));
			listaHistoricoAlunoMatrizCurricular.addAll(historicoVOs);
		}else if(matriculaVO.getMatriculaOnlineProcSeletivo() &&
                matriculaVO.isNovoObj()	&&
                !matriculaVO.getMatriculaJaRegistrada()){
            if( !Uteis.isAtributoPreenchido(matriculaVO.getListaProcessoSeletivoDisciplinasAproveitadas())){
                List<HistoricoVO> historicos =	getFacadeFactory().getMatriculaFacade().realizarCriacaoHistoricoApartirDisciplinasAprovadasMesmaGradeCurricularMatriculaOnline(matriculaVO.getMatricula() ,matriculaVO.getAluno().getCodigo() ,matriculaVO.getGradeCurricularAtual().getCodigo(), new TurmaVO(),null  ,NivelMontarDados.TODOS , usuario);
                matriculaVO.setListaProcessoSeletivoDisciplinasAproveitadas(historicos);
            }
 			listaHistoricoAlunoMatrizCurricular.addAll(matriculaVO.getListaProcessoSeletivoDisciplinasAproveitadas());
		}
		if (!matriculaVO.getHistoricosAproveitamentoDisciplinaPrevisto().isEmpty()) {
			// Lista utilizada quando uma nova matrícula está sendo realizada
			// por meio de uma transferencia
			// de entrada, com um aproveitamento de disciplinas previsto
			// vinculado à mesma.
			// Assim, este atributo é utilizado para fornecer como parametro
			// para este método
			// a lista de históricos previstos que foram registrados no
			// aproveitamento
			// de forma que a renovação já considere estas disciplinas do
			// aproveitamento como aprovadas.
			// Isto possibilitará ao aluno, por exemplo, já se matricular em um
			// período letivo
			// avançado, evitando atrasos na vida academica do mesmo e economia
			// financeira para o mesmo.
			listaHistoricoAlunoMatrizCurricular.addAll(matriculaVO.getHistoricosAproveitamentoDisciplinaPrevisto());
		}

		matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().setTodosHistoricosAlunoGradeCurricular(listaHistoricoAlunoMatrizCurricular);

		// Distribuindo historicos por GradeDisciplina - Ou seja, iremos
		// associar os historicos
		// de cada disciplina com a sua respectiva GradeDisciplinaVO.
		matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().montarGradeDisciplinaComHistoricoAlunoVO(configuracaoAcademicoVO);

		Integer cargaHorariaRealizada = getFacadeFactory().getEstagioFacade().consultarCargaHorariaRealizadaEstagioMatricula(matriculaVO.getMatricula());
		Integer cargaHorariaEmRealizacao = getFacadeFactory().getEstagioFacade().consultarCargaHorariaEmRealizacaoEstagioMatricula(matriculaVO.getMatricula());
		matriculaComHistoricoAlunoVO.atualizarSituacaoAlunoEstagio(cargaHorariaRealizada, cargaHorariaEmRealizacao);
		
		matriculaComHistoricoAlunoVO.setNumeroHorasTotalTCCGrade(getFacadeFactory().getGradeCurricularFacade().consultarCargaHorariaTCCPorMatrizCurricular(matriculaVO.getGradeCurricularAtual().getCodigo()));
		
		Integer cargaHorariaAtividadeComplementarAluno = getFacadeFactory().getRegistroAtividadeComplementarMatriculaFacade().consultarCargaHorariaRealizada(matriculaVO.getMatricula(), gradeCurricularCarregada.getCodigo(), false);
		matriculaComHistoricoAlunoVO.atualizarSituacaoAlunoAtividadeComplementar(cargaHorariaAtividadeComplementarAluno);
		for(GradeCurricularGrupoOptativaVO gradeCurricularGrupoOptativaVO:matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getGradeCurricularGrupoOptativaVOs()){
			for(GradeCurricularGrupoOptativaDisciplinaVO disOp : gradeCurricularGrupoOptativaVO.getGradeCurricularGrupoOptativaDisciplinaVOs()){
				disOp.setHistoricoAtualAluno(matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().obterHistoricoAtualGradeCurricularGrupoOptativaVO(disOp.getDisciplina().getCodigo(), disOp.getCargaHoraria()));
			}
		}
		matriculaComHistoricoAlunoVO.setInicializado(true);
		return matriculaComHistoricoAlunoVO;
	}

	/**
	 * Método padrão para obter a situação acadêmica de um aluno, carregando os
	 * dados gradeCurricular do curso (dados completo), bem como todos os
	 * históricos do aluno para cada disciplina, além de todos os dados
	 * necessários para definição da vida acadêmica de um aluno no SEI. Este
	 * método também já fornece as informações necessárias relativas a evolução
	 * acadêmica do aluno. O mesmo já está apto a formar, carga horaria definida
	 * na matriz, carga horaráia cusarda pelo aluno, se o aluno já cumpriu as
	 * atividades extracurriculares obrigatorias (como enade, estágio e
	 * atividades complementares). É o método padrão para obtenção dos dados
	 * para emissão do histórico, processamento de uma renovação de matrícula e
	 * transferencia e itens afins.
	 */
	public MatriculaComHistoricoAlunoVO carregarDadosMatriculaComHistoricoAlunoVO(MatriculaVO matriculaVO, Integer codigoGradeCurricular, Boolean carregarDadosProfessor,  ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuario) throws Exception {
		GradeCurricularVO gradeCarregar = new GradeCurricularVO();
		gradeCarregar.setCodigo(codigoGradeCurricular);
		return carregarDadosMatriculaComHistoricoAlunoVO(matriculaVO, gradeCarregar, false, carregarDadosProfessor, configuracaoAcademicoVO, usuario);
	}

	/**
	 * * Versão 5.0 Atualizar para composicao que pode ser definida na
	 * GradeDisciplinaVO ou GradeCrupoOptativaDisciplinaVO. Método responsavel
	 * por calcular a media parcial da disciplina composta. Realiza a consulta
	 * da Composta e retorna uma lista de disciplinas e para cada disciplina e
	 * consultado o respectivo historico e adicionado em uma lista, verifica se
	 * a configuracao academica de cada historico sao iguais. Percorre a lista
	 * de notas e verifica se utiliza a nota se sim percorre a lista de
	 * historico soma ao valor final o valor da nota de cada historico e por fim
	 * faz a divisao do valor final da nota pela quantidade de disciplinas
	 * compostas e seta no historico a nota final.
	 *
	 * @author Wellington Rodrigues - 13/04/2015
	 * @param historicoDisciplinaComposta
	 * @param historicoDisciplinaFazParteComposicaoVOs
	 * @param usuarioVO
	 * @throws Exception
	 */
	public void executarCalculoMediaParcialDisciplinaComposta(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs, UsuarioVO usuarioVO) throws Exception {
		for (int i = 1; i <= 40; i++) {
			Boolean utilizarNota = (Boolean) UtilReflexao.invocarMetodoGet(historicoDisciplinaComposta.getConfiguracaoAcademico(), "utilizarNota" + i);
//			Boolean utilizarNotaMediaFinal = (Boolean) UtilReflexao.invocarMetodoGet(historicoDisciplinaComposta.getConfiguracaoAcademico(), "nota" + i + "MediaFinal");
//			if (utilizarNota && !utilizarNotaMediaFinal) {
			if (utilizarNota) {
				executarCalculoMediaParcialDisciplinaComposta(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, i);
			}
//			else if (utilizarNota && utilizarNotaMediaFinal) {
//				executarCalculoMediaParcialDisciplinaComposta(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, i);
//				executarCalculoMediaFinalParcialDisciplinaComposta(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, i);
//			}
		}
	}

	@Override
	public void realizarValidacaoNotaLancada(HistoricoVO historicoVO, List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs,  ConfiguracaoAcademicoVO configuracaoAcademicoVO, int numeroNota) throws Exception {
		Double nota = (Double) UtilReflexao.invocarMetodoGet(historicoVO, "nota" + numeroNota);
		Boolean isMediaFinal = (Boolean) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "nota" + numeroNota + "MediaFinal");
		if (nota != null) {
			String regraArredondamentoNota = (String) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "regraArredondamentoNota" + numeroNota);
			if (!regraArredondamentoNota.trim().isEmpty()
					&& ((!isMediaFinal && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos())
					|| (isMediaFinal && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && !configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais()))) {
				/**
				 * A10	dicionada regra para arredondamento de casas decimais de
				 * nota, tal regra será adicionada na configuração academica de
				 * cada nota seguindo o padrão VALOR INICIO-VALOR FIM:VALOR
				 * SUBSTITUIR; Ex.: 00-24:00, todo valor decimal de nota que
				 * estiver entre 00 e 24 será arredondado para 00.
				 */
				nota = configuracaoAcademicoVO.executarArredondamentoNota(regraArredondamentoNota, nota);
			} else if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos()) {
				nota = (Math.round(2 * nota) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && isMediaFinal) {
				nota = (Uteis.arredondarMultiploDeCincoParaCima(nota));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && isMediaFinal) {
				nota = (Math.round(2 * nota) / 2.0);
			}
			// Verificando regra especifica para nota substitutiva.
			Boolean utilizarComoSubstitutiva = (Boolean) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "utilizarComoSubstitutiva" + numeroNota);
			Double faixaMenor = (Double) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "faixaNota" + numeroNota + "Menor");
			Double faixaMaior = (Double) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "faixaNota" + numeroNota + "Maior");
			if ((utilizarComoSubstitutiva) && (faixaMenor <= 0.0) && (faixaMaior <= 0.0)) {
				// caso a nota seja substitutiva e a faixa de valores dela,
				// estiver zerada, significa
				// que o SEI deverá verificar se o valor da nota substitutiva
				// obdece na verdade a faixa
				// de notas da nota que será substituída. Para isto toda a regra
				// de substituiçõa precisará
				// ser aplicada para saber qual nota será substituída e poder
				// validar a faixa da mesma sobre
				// o valor a ser substituído.
				historicoVO.setErroNotaSubstitutiva("");
				if(historicoVO.getHistoricoDisciplinaComposta() && !Uteis.isAtributoPreenchido(historicoDisciplinaFazParteComposicaoVOs)) {
					historicoVO.setHistoricoDisciplinaFilhaComposicaoVOs(getFacadeFactory().getHistoricoFacade().consultaRapidaHistoricoFazParteComposicaoPorMatriculaPorGradeCurricularPorMatriculaPeriodo(historicoVO.getMatricula().getMatricula(), 0, historicoVO.getMatriculaPeriodo().getCodigo(), historicoVO.getMatrizCurricular().getCodigo(), historicoVO.getGradeDisciplinaVO().getCodigo(), historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), false, null));
					historicoDisciplinaFazParteComposicaoVOs = historicoVO.getHistoricoDisciplinaFilhaComposicaoVOs();
				}
				if (!configuracaoAcademicoVO.verificarFaixaNotaSubstitutivaValidaComRelacaoNotaASerSubstituida(historicoVO, historicoDisciplinaFazParteComposicaoVOs)) {
					// caso tenha erro, ou a nota esteja fora do faixa da nota a
					// ser substituida, entao
					// o erro será registrado dentro do atributo transient de
					// historicoVO erro erroNotaSubstitutiva.
					UtilReflexao.invocarMetodoSetParametroNull(historicoVO, "nota" + numeroNota);
					throw new Exception(historicoVO.getErroNotaSubstitutiva());
				}
			} else {
				if (nota > (Double) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "faixaNota" + numeroNota + "Maior")) {
					UtilReflexao.invocarMetodoSetParametroNull(historicoVO, "nota" + numeroNota);
					throw new Exception(UteisJSF.internacionalizar("msg_Historico_valorNotaMaior").replace("{0}", (String) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "tituloNotaApresentar" + numeroNota)).replace("{1}", Uteis.getDoubleFormatado((Double) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "faixaNota" + numeroNota + "Maior")))+" - Matrícula "+historicoVO.getMatricula().getMatricula());
				} else if (nota < (Double) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "faixaNota" + numeroNota + "Menor")) {
					UtilReflexao.invocarMetodoSetParametroNull(historicoVO, "nota" + numeroNota);
					throw new Exception(UteisJSF.internacionalizar("msg_Historico_valorNotaMenor").replace("{0}", (String) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "tituloNotaApresentar" + numeroNota)).replace("{1}", Uteis.getDoubleFormatado((Double) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "faixaNota" + numeroNota + "Menor")))+" - Matrícula "+historicoVO.getMatricula().getMatricula());
				}
			}
			UtilReflexao.invocarMetodo(historicoVO, "setNota" + numeroNota, nota);
		}
	}

	/**
	 * HOMOLOGADO VERSAO 5.0 Método responsável por alimentar os dados histórico
	 * com os dados de um aproveitamento. Contudo, este método atualiza somente
	 * os campos que podem ser alterados no histórico a partir de uma edição de
	 * um DisciplinaAproveitada. Os dados que são setados somente quando uma
	 * nova DisciplinaAproveitaVO é setada são inicializados no histórico pelo
	 * método criarHistoricoAPartirDisciplinaAproveitada. Assim, evita-se de ter
	 * código repetido, pois ao executar o método
	 * criarHistoricoAPartirDisciplinaAproveitada, este método também é chamado
	 * automaticamente.
	 */
	public void atualizarDadosHistoricoComBaseDisciplinaAproveitada(HistoricoVO historicoVO, DisciplinasAproveitadasVO objItem) throws Exception {
		historicoVO.setNomeDisciplina(objItem.getDisciplina().getNome());
		historicoVO.setFreguencia(objItem.getFrequencia());
		historicoVO.setResponsavel(objItem.getAproveitamentoDisciplinaVO().getResponsavelAutorizacao());
		historicoVO.setAnoHistorico(objItem.getAno());
		historicoVO.setSemestreHistorico(objItem.getSemestre());
		if (!objItem.getGradeCurricularGrupoOptativaDisciplina().getCodigo().equals(0)) {
			historicoVO.setPeriodoLetivoMatrizCurricular(objItem.getPeriodoletivoGrupoOptativaVO());
		}
		if (objItem.getUtilizaNotaConceito()) {
			historicoVO.setUtilizaNotaFinalConceito(true);
			historicoVO.setNotaFinalConceito(objItem.getMediaFinalConceito());
		} else {
			historicoVO.setUtilizaNotaFinalConceito(false);
		}
		if (Uteis.isAtributoPreenchido(objItem.getNota())) {
			historicoVO.setMediaFinal(objItem.getNota());
		}
		historicoVO.setInstituicao(objItem.getInstituicao());
		historicoVO.setCidadeVO(objItem.getCidade());
		historicoVO.setDataInicioAula(objItem.getDataInicioAula());
		historicoVO.setDataFimAula(objItem.getDataFimAula());
		if (objItem.getAproveitamentoPorIsencao()) {
			historicoVO.setCargaHorariaDisciplina(objItem.getCargaHoraria());
			historicoVO.setCriadoPorNovaDisciplinaAproveitada(objItem.getCriarNovoHistorico());
			historicoVO.setCargaHorariaAproveitamentoDisciplina(objItem.getCargaHoraria());
			historicoVO.setCargaHorariaCursada(objItem.getCargaHorariaCursada());
			historicoVO.setIsentarMediaFinal(objItem.getAproveitamentoPorIsencao());
			historicoVO.setSituacao("IS");
		} else {
			if (objItem.getTipo().equals("AP")) {
				historicoVO.setCargaHorariaDisciplina(objItem.getCargaHoraria());
				historicoVO.setCriadoPorNovaDisciplinaAproveitada(objItem.getCriarNovoHistorico());
				historicoVO.setCargaHorariaAproveitamentoDisciplina(objItem.getCargaHoraria());
				historicoVO.setCargaHorariaCursada(objItem.getCargaHorariaCursada());
				historicoVO.setIsentarMediaFinal(objItem.getAproveitamentoPorIsencao());
				historicoVO.setSituacao("AA");
			} else if (objItem.getTipo().equals("CO")) {
				historicoVO.setCargaHorariaDisciplina(objItem.getCargaHoraria());
				historicoVO.setFreguencia(100.0);
				historicoVO.setMediaFinal(0.0);
				historicoVO.setCargaHorariaCursada(objItem.getCargaHoraria());
				historicoVO.setCreditoDisciplina(objItem.getQtdeCreditoConcedido());
				historicoVO.setSituacao("CC");
			} else {
				historicoVO.setCargaHorariaDisciplina(objItem.getCargaHoraria());
				historicoVO.setFreguencia(100.0);
				historicoVO.setMediaFinal(0.0);
				historicoVO.setCargaHorariaCursada(objItem.getQtdeCargaHorariaConcedido());
				historicoVO.setSituacao("CH");
			}
			if (Uteis.isAtributoPreenchido(objItem.getSituacaoHistorico()) && !objItem.getSituacaoHistorico().equals(SituacaoHistorico.APROVADO) && !objItem.getSituacaoHistorico().equals(SituacaoHistorico.ISENTO)) {
				historicoVO.setSituacao(objItem.getSituacaoHistorico().getValor());
			}
			historicoVO.setApresentarAprovadoHistorico(objItem.getApresentarAprovadoHistorico());
		}
	}

	/**
	 * HOMOLOGADO VERSÃO 5.0 Método responsável por, a partir, dos dados de uma
	 * DisciplinaAproveitadasVO gerar um histórico correspondente para o mesmo.
	 */
	public HistoricoVO criarHistoricoAPartirDisciplinaAproveitada(DisciplinasAproveitadasVO objItem) throws Exception {
		HistoricoVO historicoVO = new HistoricoVO();
		historicoVO.setDataRegistro(new Date());
		historicoVO.setData(new Date());
		historicoVO.getDisciplina().setCodigo(objItem.getDisciplina().getCodigo());
		historicoVO.getDisciplina().setNome(objItem.getDisciplina().getNome());
		historicoVO.setGradeDisciplinaVO(objItem.getGradeDisciplinaVO());
		historicoVO.setMatricula(objItem.getAproveitamentoDisciplinaVO().getMatricula());
		historicoVO.setMatrizCurricular(objItem.getAproveitamentoDisciplinaVO().getGradeCurricular());
		if(objItem.getAproveitamentoDisciplinaVO().getMatriculaPeriodo().getAno().equals(objItem.getAno()) && objItem.getAproveitamentoDisciplinaVO().getMatriculaPeriodo().getSemestre().equals(objItem.getSemestre())){
			historicoVO.setMatriculaPeriodo(objItem.getAproveitamentoDisciplinaVO().getMatriculaPeriodo());
		}else{
			MatriculaPeriodoVO matriculaPeriodoVO = getFacadeFactory().getMatriculaPeriodoFacade().consultaRapidaPorMatriculaAnoSemestre(objItem.getAproveitamentoDisciplinaVO().getMatricula().getMatricula(), objItem.getSemestre(), objItem.getAno(), false, null);
			if(matriculaPeriodoVO != null && !matriculaPeriodoVO.getCodigo().equals(0)){
				historicoVO.setMatriculaPeriodo(matriculaPeriodoVO);
			}else{
				historicoVO.setMatriculaPeriodo(objItem.getAproveitamentoDisciplinaVO().getMatriculaPeriodo());
			}
		}
		historicoVO.setHistoricoDisciplinaAproveitada(Boolean.TRUE);
		// INDEPENDENTE DO TIPO DO APROVEITAMENTO, SEMPRE DEVEREMOS GRAVAR O
		// CÓDIGO
		// DO APROVEITAMENTO, PARA QUE FIQUE CLARO A ORIGEM DO HISTORICO
		historicoVO.setDisciplinasAproveitadas(objItem.getCodigo());

		// TRATANDO SE TRATA-SE DE UMA DISCIPLINA REGULAR (GRADEDISCIPLINA) OU
		// TRATA-SE
		// DE UMA DISCIPLINA DE UM GRUPO DE OPTATIVA
		historicoVO.setGradeCurricularGrupoOptativaDisciplinaVO(objItem.getGradeCurricularGrupoOptativaDisciplina());
		if (!objItem.getGradeCurricularGrupoOptativaDisciplina().getCodigo().equals(0)) {
			historicoVO.setDisciplinaReferenteAUmGrupoOptativa(Boolean.TRUE);
			historicoVO.setHistoricoDisciplinaOptativa(Boolean.TRUE);
			historicoVO.setPeriodoLetivoMatrizCurricular(objItem.getPeriodoletivoGrupoOptativaVO());
			historicoVO.setGradeDisciplinaVO(null);
			historicoVO.setCreditoDisciplina(objItem.getGradeCurricularGrupoOptativaDisciplina().getNrCreditos());
			historicoVO.setConfiguracaoAcademico(objItem.getGradeCurricularGrupoOptativaDisciplina().getConfiguracaoAcademico());
		} else {
			historicoVO.setDisciplinaReferenteAUmGrupoOptativa(Boolean.FALSE);
			historicoVO.setGradeCurricularGrupoOptativaDisciplinaVO(null);
			historicoVO.setCreditoDisciplina(objItem.getGradeDisciplinaVO().getNrCreditos());
			historicoVO.setConfiguracaoAcademico(objItem.getGradeDisciplinaVO().getConfiguracaoAcademico());
			historicoVO.setPeriodoLetivoMatrizCurricular(objItem.getGradeDisciplinaVO().getPeriodoLetivoVO());
			historicoVO.setPeriodoLetivoCursada(objItem.getGradeDisciplinaVO().getPeriodoLetivoVO());
		}

		// TRATANDO A EQUIVALENCIA - SE TRATA-SE DE UM APROVEITAMENTO DE UMA
		// DISCIPLINA ENVOLVIDA
		// EM UM MAPA DE EQUIVALENCIA
		if (!objItem.getMapaEquivalenciaDisciplinaCursada().getCodigo().equals(0)) {
			// se entrarmos aqui é por que trata-se de um aproveitamento de uma
			// disciplina,
			// de fora da grade, que o aluno teria que cursar para cumprir um
			// mapa de equivalencia.
			historicoVO.setHistoricoEquivalente(Boolean.TRUE);
			historicoVO.setHistoricoDisciplinaForaGrade(Boolean.FALSE);
			historicoVO.setMapaEquivalenciaDisciplinaCursada(objItem.getMapaEquivalenciaDisciplinaCursada());
			historicoVO.setMapaEquivalenciaDisciplina(objItem.getMapaEquivalenciaDisciplinaCursada().getMapaEquivalenciaDisciplina());
		}

		// TRATANDO A CONFIGURACAO ACADEMICA DO HISTORICO
		// CASO NAO EXISTA UMA CONFIGURACAO ACADEMICA DEFINIDA NA MATRIZ
		// CURRICULAR PARA A DISCIPLINA OU
		// DISCIPLINA DO GRUPO DE OPTATIVA, ENTAO ASSUMIMOS A
		// CONFIGURACAOACADEMICA DO CURSO.
		if (historicoVO.getConfiguracaoAcademico().getCodigo().intValue() == 0) {
			historicoVO.setConfiguracaoAcademico(getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorCodigoCurso(objItem.getAproveitamentoDisciplinaVO().getCurso().getCodigo(), null));
		}
		historicoVO.setTipoHistorico("NO");
		atualizarDadosHistoricoComBaseDisciplinaAproveitada(historicoVO, objItem);
		return historicoVO;
	}

	@Override
	public List<HistoricoVO> consultarHistoricoAptoVincularAtividadeComplementarPorMatricula(String matricula) {
		StringBuilder sql = new StringBuilder("SELECT historico.codigo, disciplina.nome as disciplina from historico ");
		sql.append(" inner join disciplina on disciplina.codigo = historico.disciplina ");
		sql.append(" inner join matricula on matricula.matricula = historico.matricula ");
		sql.append(" where historico.matricula = '").append(matricula).append("'");
		sql.append(" and historico.situacao in ('AP', 'AA', 'CC', 'CH') and (historicoDisciplinaAtividadeComplementar = false or historicoDisciplinaAtividadeComplementar is null) ");
		sql.append(" and historico.matrizcurricular = matricula.gradecurricularatual ");
		sql.append(" order by disciplina.nome ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
		HistoricoVO historicoVO = null;
		while (rs.next()) {
			historicoVO = new HistoricoVO();
			historicoVO.setCodigo(rs.getInt("codigo"));
			historicoVO.getDisciplina().setNome(rs.getString("disciplina"));
			historicoVOs.add(historicoVO);
		}
		return historicoVOs;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarVinculoHistoricoAtividadeComplementar(Integer historico, boolean historicoDisciplinaAtividadeComplementar) throws Exception {
		getConexao().getJdbcTemplate().update("UPDATE historico set historicoDisciplinaAtividadeComplementar = ? where codigo = ? ", historicoDisciplinaAtividadeComplementar, historico);
	}

	public List<HistoricoVO> verificarExisteHistoricoMatrizNaoCriadoPorTrasnferenciaMatriz(String matricula, Integer codigoGradeCurricularAtual, Integer codigoTransferenciaMatricula) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT historico.codigo as historico_codigo, disciplina.codigo as disciplina_codigo, disciplina.nome as disciplina_nome FROM Historico ");
		sqlStr.append("INNER JOIN Disciplina on disciplina.codigo = historico.disciplina ");
		sqlStr.append("WHERE matrizcurricular = ").append(codigoGradeCurricularAtual);
		sqlStr.append(" AND matricula = '").append(matricula).append("'");
		sqlStr.append(" AND (transferenciaMatrizCurricularMatricula != ").append(codigoTransferenciaMatricula).append(" or transferenciaMatrizCurricularMatricula is null)");
		sqlStr.append(" ORDER BY disciplina.nome");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
		while (rs.next()) {
			HistoricoVO obj = new HistoricoVO();
			obj.setCodigo(rs.getInt("historico_codigo"));
			obj.getDisciplina().setCodigo(rs.getInt("disciplina_codigo"));
			obj.getDisciplina().setNome(rs.getString("disciplina_nome"));
			historicoVOs.add(obj);
		}
		return historicoVOs;
	}

	public boolean verificarExisteHistoricoMatriculaVinculadoGradeDestino(String matricula, Integer codigoGradeVerificar) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" SELECT COUNT(codigo) AS nrHistoricoMatriz FROM Historico WHERE (matrizcurricular = ").append(codigoGradeVerificar).append(") ");
		sqlStr.append("   AND (matricula = '").append(matricula).append("')");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			int nrHistoricoMatriz = tabelaResultado.getInt("nrHistoricoMatriz");
			if (nrHistoricoMatriz > 0) {
				return true;
			}
		}
		return false;
	}

	@Override
	public HistoricoVO consultaHistoricoDisciplinaCompostaPorMatriculaGradeCurricularAnoSemestreGradeDisciplinaComposta(String matricula, Integer gradeCurricular, String ano, String semestre, Integer gradeDisciplinaComposta, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (matricula.matricula = '").append(matricula).append("') ");
		sqlStr.append(" AND (historico.matrizCurricular = ").append(gradeCurricular).append(") ");
		sqlStr.append(" AND (historico.disciplina = (");
		sqlStr.append(" select case when gradedisciplina.codigo is not null then gradedisciplina.disciplina else gradecurriculargrupooptativadisciplina.disciplina end as disciplina from gradedisciplinacomposta ");
		sqlStr.append(" left join gradedisciplina on gradedisciplina.codigo = gradedisciplinacomposta.gradedisciplina ");
		sqlStr.append(" left join gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = gradedisciplinacomposta.gradecurriculargrupooptativadisciplina ");
		sqlStr.append(" where gradedisciplinacomposta.codigo = ").append(gradeDisciplinaComposta).append(")) ");
		sqlStr.append(" AND (historico.historicodisciplinacomposta = true ) ");
		if (ano != null && !ano.trim().isEmpty()) {
			sqlStr.append(" AND (anohistorico = '").append(ano).append("') ");
		}
		if (semestre != null && !semestre.trim().isEmpty()) {
			sqlStr.append(" AND (semestrehistorico = '").append(semestre).append("') ");
		}

		sqlStr.append(" ORDER BY gradeDisciplinaComposta.ordem, historico.codigo");

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		// System.out.println(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO historicoVO = new HistoricoVO();
		montarDadosCompleto(historicoVO, tabelaResultado, usuario);
		return historicoVO;
	}

	/*
	 * Método responsável por executar o cálculo do Coeficiente de Rendimento do
	 * Aluno no periodo. Forma de cálculo: Soma das médias das disciplinas
	 * aprovadas (AP) ou reprovadas (RE, RF, RP) no periodo, dividido pela
	 * quantidade de disciplinas do periodo em questão.
	 */
	@Override
	public Double calcularCoeficienteRendimentoPeriodoLetivoAluno(String matricula, String ano, String semestre) throws Exception {
		try {
			StringBuffer sqlStr = new StringBuffer();
			sqlStr.append(" SELECT (sum(historico.mediafinal) / count(historico.codigo))::NUMERIC(20,2) AS coeficienterendimentoperiodoletivo ");
			sqlStr.append(" FROM historico ");
			sqlStr.append(" INNER JOIN matricula on matricula.matricula = historico.matricula ");
			sqlStr.append(" INNER JOIN curso on matricula.curso = curso.codigo ");
			sqlStr.append(" WHERE 1=1 ");
			sqlStr.append(" AND historico.situacao in ('AP', 'RE', 'RF', 'RP') ");
			sqlStr.append(" AND historico.matricula = '").append(matricula).append("' ");
			sqlStr.append(" AND (historico.historicoequivalente = false or historico.historicoequivalente is null) ");
			sqlStr.append(" AND (historico.historicodisciplinafazpartecomposicao = false or historico.historicodisciplinafazpartecomposicao is null) ");
			sqlStr.append(" and case when curso.periodicidade = 'SE' then (anohistorico = '").append(ano).append("' AND historico.semestrehistorico = '").append(semestre).append("') ");
			sqlStr.append(" else case when curso.periodicidade = 'AN' then (anohistorico = '").append(ano).append("') ");
			sqlStr.append(" else true end end  ");

			SqlRowSet dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			if (dadosSQL.next()) {
				return dadosSQL.getDouble("coeficienterendimentoperiodoletivo");
			}

			return 0.0;
		} catch (Exception e) {
			throw e;
		}
	}

	/*
	 * Método responsável por executar o cálculo do Coeficiente de Rendimento
	 * Geral do Aluno (Todos periodos). Forma de cálculo: Soma das médias das
	 * disciplinas aprovadas (AP) ou reprovadas (RE, RF, RP) de todos periodos,
	 * dividido pela quantidade de disciplinas dos periodos em questão.
	 */
	@Override
	public Double calcularCoeficienteRendimentoGeralAluno(String matricula) throws Exception {
		try {
			StringBuffer sqlStr = new StringBuffer();
			sqlStr.append(" select (sum(coeficienteperiodo)/count(anohistorico||'/'||semestrehistorico))::NUMERIC(20,2) as coeficienterendimentogeral from ( ");
			sqlStr.append(" SELECT (sum(historico.mediafinal)/count(historico.codigo))::NUMERIC(20,2) AS coeficienteperiodo, anohistorico, semestrehistorico FROM historico ");
			sqlStr.append(" WHERE 1=1  AND historico.situacao in ('AP', 'RE', 'RF', 'RP')  AND historico.matricula = '").append(matricula).append("' ");
			sqlStr.append(" AND (historico.historicoequivalente = false or historico.historicoequivalente is null) ");
			sqlStr.append(" AND (historico.historicodisciplinafazpartecomposicao = false or historico.historicodisciplinafazpartecomposicao is null) ");
			sqlStr.append(" group by anohistorico, semestrehistorico ) as t ");

			SqlRowSet dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			if (dadosSQL.next()) {
				return dadosSQL.getDouble("coeficienterendimentogeral");
			}

			return 0.0;
		} catch (Exception e) {
			throw e;
		}
	}

	public String realizarCriacaoMensagemNotaLancada(HistoricoVO obj, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuarioVO) {
		StringBuilder mensagemNota = new StringBuilder(" O Aluno possui a(s) seguinte(s) nota(s) lançada(s) ( ");
		if (obj.getNota1() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota1()).append(": ").append(obj.getNota1()).append(", ");
		}
		if (obj.getNota2() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota2()).append(": ").append(obj.getNota2()).append(", ");
		}
		if (obj.getNota3() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota3()).append(": ").append(obj.getNota3()).append(", ");
		}
		if (obj.getNota4() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota4()).append(": ").append(obj.getNota4()).append(", ");
		}
		if (obj.getNota5() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota5()).append(": ").append(obj.getNota5()).append(", ");
		}
		if (obj.getNota6() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota6()).append(": ").append(obj.getNota6()).append(", ");
		}
		if (obj.getNota7() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota7()).append(": ").append(obj.getNota7()).append(", ");
		}
		if (obj.getNota8() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota8()).append(": ").append(obj.getNota8()).append(", ");
		}
		if (obj.getNota9() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota9()).append(": ").append(obj.getNota9()).append(", ");
		}
		if (obj.getNota10() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota10()).append(": ").append(obj.getNota10()).append(", ");
		}
		if (obj.getNota11() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota11()).append(": ").append(obj.getNota11()).append(", ");
		}
		if (obj.getNota12() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota12()).append(": ").append(obj.getNota12()).append(", ");
		}
		if (obj.getNota13() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota13()).append(": ").append(obj.getNota13()).append(", ");
		}
		if (obj.getNota14() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota14()).append(": ").append(obj.getNota14()).append(", ");
		}
		if (obj.getNota15() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota15()).append(": ").append(obj.getNota15()).append(", ");
		}
		if (obj.getNota16() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota16()).append(": ").append(obj.getNota16()).append(", ");
		}
		if (obj.getNota17() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota17()).append(": ").append(obj.getNota17()).append(", ");
		}
		if (obj.getNota18() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota18()).append(": ").append(obj.getNota18()).append(", ");
		}
		if (obj.getNota19() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota19()).append(": ").append(obj.getNota19()).append(", ");
		}
		if (obj.getNota20() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota20()).append(": ").append(obj.getNota20()).append(", ");
		}
		if (obj.getNota21() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota21()).append(": ").append(obj.getNota21()).append(", ");
		}
		if (obj.getNota22() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota22()).append(": ").append(obj.getNota22()).append(", ");
		}
		if (obj.getNota23() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota23()).append(": ").append(obj.getNota23()).append(", ");
		}
		if (obj.getNota24() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota24()).append(": ").append(obj.getNota24()).append(", ");
		}
		if (obj.getNota25() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota25()).append(": ").append(obj.getNota25()).append(", ");
		}
		if (obj.getNota26() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota26()).append(": ").append(obj.getNota26()).append(", ");
		}
		if (obj.getNota27() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota27()).append(": ").append(obj.getNota27()).append(", ");
		}
		if (obj.getNota28() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota28()).append(": ").append(obj.getNota28()).append(", ");
		}
		if (obj.getNota29() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota29()).append(": ").append(obj.getNota29()).append(", ");
		}
		if (obj.getNota30() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota30()).append(": ").append(obj.getNota30()).append(", ");
		}
		if (obj.getNota31() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota31()).append(": ").append(obj.getNota31()).append(", ");
		}
		if (obj.getNota32() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota32()).append(": ").append(obj.getNota32()).append(", ");
		}
		if (obj.getNota33() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota33()).append(": ").append(obj.getNota33()).append(", ");
		}
		if (obj.getNota34() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota34()).append(": ").append(obj.getNota34()).append(", ");
		}
		if (obj.getNota35() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota35()).append(": ").append(obj.getNota35()).append(", ");
		}
		if (obj.getNota36() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota36()).append(": ").append(obj.getNota36()).append(", ");
		}
		if (obj.getNota37() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota37()).append(": ").append(obj.getNota37()).append(", ");
		}
		if (obj.getNota38() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota38()).append(": ").append(obj.getNota38()).append(", ");
		}
		if (obj.getNota39() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota39()).append(": ").append(obj.getNota39()).append(", ");
		}
		if (obj.getNota40() != null) {
			mensagemNota.append(configuracaoAcademicoVO.getTituloNota40()).append(": ").append(obj.getNota40()).append(", ");
		}
		if (mensagemNota.toString().contains(",")) {
			mensagemNota.replace(mensagemNota.lastIndexOf(","), mensagemNota.length(), "");
			mensagemNota.append("). ");
		} else {
			return "";
		}
		return mensagemNota.toString();
	}

	public String realizarCriacaoMensagemMediaFrequencia(HistoricoVO obj, UsuarioVO usuarioVO) {
		StringBuilder mensagemMediaFrequencia = new StringBuilder();
		if (obj.getMediaFinal() != null) {
			mensagemMediaFrequencia.append(" A Média Final do aluno é: ").append(obj.getMediaFinal_Apresentar()).append(", Frequência: ").append(obj.getFrequencia_Apresentar());
		} else {
			mensagemMediaFrequencia.append(" O aluno não possui média final calculada.");
		}
		return mensagemMediaFrequencia.toString();
	}

	public void validarDadosExclusaoDisciplinaSituacaoHistorico(SituacaoHistorico situacao) throws Exception {
		if (!situacao.getValor().equals("CS")) {
			throw new Exception("Só é possível excluir a disciplina com a SITUAÇÃO Cursando.");
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<HistoricoVO> excluirDisciplinaAlunoPorDisciplina(HistoricoVO obj, boolean realizandoExclusaoDisciplinaForaPrazo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
		if (Uteis.isAtributoPreenchido(obj.getMatriculaPeriodoTurmaDisciplina())) {
			obj.setMatriculaPeriodoTurmaDisciplina(getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarPorChavePrimaria(obj.getMatriculaPeriodoTurmaDisciplina().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO));
		}
		if (obj.getHistoricoDisciplinaComposta() && !Uteis.isAtributoPreenchido(obj.getGradeDisciplinaComposta())) {
			historicoVOs.addAll(executarExclusaoHistoricoDisciplinaFazParteComposicao(obj, usuarioVO));
		}
		if (realizandoExclusaoDisciplinaForaPrazo) {
			historicoVOs.addAll(excluirHistoricoForaPrazo(obj, configuracaoFinanceiroVO, usuarioVO));
		} else {
//			método comentado por motivo do chamado 40706, cliente solicitou que permitisse a exclusão de disciplinas que não sejam apenas as com a situação "Cursando"
//			validarDadosExclusaoDisciplinaSituacaoHistorico(SituacaoHistorico.getEnum(obj.getSituacao()));
			if (Uteis.isAtributoPreenchido(obj.getTransferenciaMatrizCurricularMatricula())) {
				HistoricoVO historicoCursandoPorCorrespondecia = this.consultarHistoricoCursandoPoCorrespondenciaAposTransferencia(obj.getMatriculaPeriodo().getCodigo(), obj.getDisciplina().getCodigo(), false, usuarioVO);
				if (Uteis.isAtributoPreenchido(historicoCursandoPorCorrespondecia)) {
					alterarHistoricoCursandoPorCorrespondenciaAposTransferencia(historicoCursandoPorCorrespondecia.getCodigo(), false, false, usuarioVO);
				}
			}
			historicoVOs.addAll(excluirHistoricoForaPrazoVerificandoHistoricoPorEquivalencia(obj, configuracaoFinanceiroVO, usuarioVO));
		}
		return historicoVOs;
	}

	/**
	 * Responsável por preencher os dados referente as faltas da disciplina
	 * composta de cada bimestre levando em consideração o maior número de
	 * faltas das disciplinas filhas
	 *
	 * @param historicoVOs
	 * @param historicoDisciplinaComposta
	 */
	public void executarCalculoFaltasAlunoBimestreDisciplinaComposta(List<HistoricoVO> historicoVOs, HistoricoVO historicoDisciplinaComposta) {
		historicoDisciplinaComposta.setTotalFalta(0);
		historicoDisciplinaComposta.setFaltaPrimeiroBimestre(0);
		historicoDisciplinaComposta.setFaltaSegundoBimestre(0);
		historicoDisciplinaComposta.setFaltaTerceiroBimestre(0);
		historicoDisciplinaComposta.setFaltaQuartoBimestre(0);
		for (HistoricoVO obj : historicoVOs) {
			historicoDisciplinaComposta.setFaltaPrimeiroBimestre(Math.max(historicoDisciplinaComposta.getFaltaPrimeiroBimestre(), obj.getFaltaPrimeiroBimestre()));
			historicoDisciplinaComposta.setFaltaSegundoBimestre(Math.max(historicoDisciplinaComposta.getFaltaSegundoBimestre(), obj.getFaltaSegundoBimestre()));
			historicoDisciplinaComposta.setFaltaTerceiroBimestre(Math.max(historicoDisciplinaComposta.getFaltaTerceiroBimestre(), obj.getFaltaTerceiroBimestre()));
			historicoDisciplinaComposta.setFaltaQuartoBimestre(Math.max(historicoDisciplinaComposta.getFaltaQuartoBimestre(), obj.getFaltaQuartoBimestre()));
			historicoDisciplinaComposta.setTotalFalta(Math.max(historicoDisciplinaComposta.getTotalFalta(), obj.getTotalFalta()));
		}
	}

	@Override
	public List<HistoricoVO> consultarAnoSemestreHistoricoPorMatriculaBoletimAcademicoRel(String matricula, Integer matrizCurricular, boolean verificarAcesso, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select distinct anohistorico, semestrehistorico, periodoletivo.codigo as periodoletivo_codigo, periodoletivo.descricao as periodoletivo_descricao from historico ");
		sqlStr.append("left join periodoletivo on periodoletivo.codigo = historico.periodoletivocursada ");
		sqlStr.append("inner join matricula on matricula.matricula = historico.matricula ");
		sqlStr.append("inner join matriculaPeriodo on matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		sqlStr.append("where historico.matricula = '").append(matricula).append("' ");
		sqlStr.append("and anohistorico <> '' ");
		sqlStr.append(" and matriculaPeriodo.situacaoMatriculaPeriodo not in('PC') ");
		if (!matrizCurricular.equals(0)) {
			sqlStr.append(" and historico.matrizcurricular = ").append(matrizCurricular);
		}
		sqlStr.append(" order by anohistorico, semestrehistorico");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
		while (rs.next()) {
			HistoricoVO obj = new HistoricoVO();
			obj.setAnoHistorico(rs.getString("anohistorico"));
			obj.setSemestreHistorico(rs.getString("semestrehistorico"));
			obj.getPeriodoLetivoMatrizCurricular().setCodigo(rs.getInt("periodoletivo_codigo"));
			obj.getPeriodoLetivoMatrizCurricular().setDescricao(rs.getString("periodoletivo_descricao"));
			historicoVOs.add(obj);
		}
		return historicoVOs;
	}

	@Override
	public List<HistoricoVO> consultarSomenteAnoSemestreHistoricoPorMatriculaBoletimAcademicoRel(String matricula, boolean verificarAcesso, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" select distinct anohistorico, semestrehistorico from historico ");
		sqlStr.append(" inner join matricula on matricula.matricula = historico.matricula ");
		sqlStr.append(" inner join curso on matricula.curso = curso.codigo ");
		sqlStr.append(" where matricula.matricula = '").append(matricula).append("' ");
		sqlStr.append(" and case when curso.periodicidade != 'IN' then anohistorico <> '' else true end ");
		sqlStr.append(" order by anohistorico, semestrehistorico");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
		while (rs.next()) {
			HistoricoVO obj = new HistoricoVO();
			obj.setAnoHistorico(rs.getString("anohistorico"));
			obj.setSemestreHistorico(rs.getString("semestrehistorico"));
			historicoVOs.add(obj);
		}
		return historicoVOs;
	}

	/**
	 * Método responsável por consultar historicos cuja situacao seja cursando
	 * por correspondencia
	 *
	 * @param matriculaPeriodo
	 * @param disciplina
	 * @param verificarAcesso
	 * @param usuarioVO
	 * @return
	 * @throws Exception
	 */
	public HistoricoVO consultarHistoricoCursandoPoCorrespondenciaAposTransferencia(Integer matriculaPeriodo, Integer disciplina, boolean verificarAcesso, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select codigo, matricula, matriculaperiodo, disciplina, historicocursandoporcorrespondenciaapostransferencia, matriculaperiodoturmadisciplina, historicoporequivalencia  ");
		sqlStr.append("from historico ");
		sqlStr.append("where matriculaperiodo = ").append(matriculaPeriodo);
		sqlStr.append(" and disciplina = ").append(disciplina);
		sqlStr.append(" and historicoCursandoPorCorrespondenciaAposTransferencia ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		HistoricoVO obj = new HistoricoVO();
		if (rs.next()) {
			obj.setCodigo(rs.getInt("codigo"));
			obj.getMatricula().setMatricula(rs.getString("matricula"));
			obj.getMatriculaPeriodo().setCodigo(rs.getInt("matriculaperiodo"));
			obj.getDisciplina().setCodigo(rs.getInt("disciplina"));
			obj.setHistoricoCursandoPorCorrespondenciaAposTransferencia(rs.getBoolean("historicoCursandoPorCorrespondenciaAposTransferencia"));
			obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(rs.getInt("matriculaperiodoturmadisciplina"));
			obj.setHistoricoPorEquivalencia(rs.getBoolean("historicoporequivalencia"));
		}
		return obj;
	}

	/**
	 * Método responsável por consultar historicos que fazem parte da
	 * composição, ou seja, historicos filhos
	 *
	 * @param matriculaPeriodo
	 * @param disciplina
	 * @param verificarAcesso
	 * @param usuarioVO
	 * @return
	 * @throws Exception
	 */
	@Override
	public List<HistoricoVO> consultarHistoricoDisciplinaFazParteComposicao(String matricula, Integer gradeDisciplina, Integer matrizCurricular, boolean verificarAcesso, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select distinct historico.codigo, historico.matricula, historico.matriculaperiodo, historico.disciplina, historico.gradedisciplinacomposta, historico.matriculaperiodoturmadisciplina, matriculaperiodo.ano, matriculaperiodo.semestre ");
		sqlStr.append("from historico ");
		sqlStr.append("inner join  matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo ");
		sqlStr.append("where historico.matricula = '").append(matricula).append("' ");
		sqlStr.append(" and gradedisciplinacomposta in (");
		sqlStr.append(" select codigo from gradedisciplinacomposta where gradedisciplina = ").append(gradeDisciplina).append(")");
		sqlStr.append(" and historicodisciplinafazpartecomposicao");
		if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getAno())) {
			sqlStr.append(" and matriculaperiodo.ano = '").append(matriculaPeriodoVO.getAno()).append("' ");
		}
		if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getSemestre())) {
			sqlStr.append(" and matriculaperiodo.semestre = '").append(matriculaPeriodoVO.getSemestre()).append("' ");
		}
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
		while (rs.next()) {
			HistoricoVO obj = new HistoricoVO();
			obj.setCodigo(rs.getInt("codigo"));
			obj.getMatricula().setMatricula(rs.getString("matricula"));
			obj.getMatriculaPeriodo().setCodigo(rs.getInt("matriculaperiodo"));
			obj.getDisciplina().setCodigo(rs.getInt("disciplina"));
			obj.getGradeDisciplinaComposta().setCodigo(rs.getInt("gradedisciplinacomposta"));
			obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(rs.getInt("matriculaperiodoturmadisciplina"));
			obj.getMatriculaPeriodoTurmaDisciplina().setMatricula(rs.getString("matricula"));
			obj.getMatriculaPeriodo().setAno(rs.getString("ano"));
			obj.getMatriculaPeriodo().setSemestre(rs.getString("semestre"));
			historicoVOs.add(obj);
		}
		return historicoVOs;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarHistoricoCursandoPorCorrespondenciaAposTransferencia(final Integer historico, final boolean historicoCursandoPorCorrespondenciaAposTransferencia, boolean verificarAcesso, UsuarioVO usuarioVO) throws Exception {
		TipoAdvertencia.alterar(getIdEntidade(), verificarAcesso, usuarioVO);
		final String sql = "UPDATE Historico set historicoCursandoPorCorrespondenciaAposTransferencia = ? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection con) throws SQLException {
				PreparedStatement sqlAlterar = con.prepareStatement(sql);
				sqlAlterar.setBoolean(1, historicoCursandoPorCorrespondenciaAposTransferencia);
				sqlAlterar.setInt(2, historico);
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<HistoricoVO> executarExclusaoHistoricoDisciplinaFazParteComposicao(HistoricoVO obj, UsuarioVO usuarioVO) throws Exception {
		List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs = this.consultarHistoricoDisciplinaFazParteComposicao(obj.getMatricula().getMatricula(), obj.getGradeDisciplinaVO().getCodigo(), null, false, obj.getMatriculaPeriodo(), usuarioVO);
		for (HistoricoVO hist : historicoDisciplinaFazParteComposicaoVOs) {
			excluir(hist, false, usuarioVO);
			if (Uteis.isAtributoPreenchido(hist.getMatriculaPeriodoTurmaDisciplina())) {
				getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().excluir(hist.getMatriculaPeriodoTurmaDisciplina(), false, usuarioVO);
			}
		}
		return historicoDisciplinaFazParteComposicaoVOs;
	}

	/*
	 * Este médoto é responsável em verificar se o aluno ficou de recuperacao em
	 * alguma nota, ou se o mesmo conseguiu recuperar a nota
	 */
	@Override
	public void realizarCriacaoHistoricoNotaVO(HistoricoVO historicoVO, List<HistoricoVO> historicoFilhaComposicaoVOs) throws Exception {
		/**
		 * Esta regra foi adicionada para atender a necessidade do colégio CIN onde a disciplina qye faz parte da composições nunca fica em recuperação, pois
		 * a recuperação é controlada apenas pela disciplina principal, ou seja o aluno poderá obter uma nota ruim em uma das filhas mas na outra filha
		 * poderá tirar uma nota muito boa que compensa a nota ruim recebida na primeira composição. Ex: Filha1 = 1 e Filha 2 = 5 se usar a regra do somatório então
		 * obterá na disciplina principal a nota 6 onde o mesmo ficará aprovado então irá aprovar também em todas as filhas.
		 *
		 */
		if(historicoVO.getHistoricoDisciplinaFazParteComposicao() && historicoVO.getConfiguracaoAcademico().getSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal()){
			return;
		}
		historicoVO.getHistoricoNotaVOs().clear();
		q: for (int i = 1; i <= 40; i++) {
			ConfiguracaoAcademicaNotaVO configuracaoAcademicaNotaVO = (ConfiguracaoAcademicaNotaVO) UtilReflexao.invocarMetodoGet(historicoVO.getConfiguracaoAcademico(), "configuracaoAcademicaNota" + i + "VO");
			if (configuracaoAcademicaNotaVO.getNotaRecuperacao() && !configuracaoAcademicaNotaVO.getFormulaUso().trim().isEmpty()) {
				String formulaUso = historicoVO.getConfiguracaoAcademico().substituirSimbolosNaFormulaUsoNota(historicoVO, historicoFilhaComposicaoVOs, configuracaoAcademicaNotaVO.getFormulaUso(), i);
				if (historicoVO.getConfiguracaoAcademico().obterSituacaoFormula(formulaUso)) {
					Double notaRecuperacao = (Double) UtilReflexao.invocarMetodoGet(historicoVO, "nota" + i);

					if (configuracaoAcademicaNotaVO.getQtdeDisciplinaRecuperacao() > 0 && configuracaoAcademicaNotaVO.getQtdeDisciplinaRecuperacao() < getFacadeFactory().getHistoricoNotaFacade().consultarQtdeDisciplinaEmRecuperacaoPorMatriculaAnoSemestreTipoNota(historicoVO.getMatricula().getMatricula(), historicoVO.getAnoHistorico(), historicoVO.getSemestreHistorico(), configuracaoAcademicaNotaVO.getNota())) {
						if (notaRecuperacao != null) {
							throw new Exception("A nota " + configuracaoAcademicaNotaVO.getTitulo() + " do aluno " + historicoVO.getMatricula().getAluno().getNome() + " (" + historicoVO.getMatricula().getMatricula() + ") não pode ser informada pois o mesmo está em recuperação em mais de " + configuracaoAcademicaNotaVO.getQtdeDisciplinaRecuperacao() + " disciplinas.");
						} else {
							continue q;
						}
					}
					if (!configuracaoAcademicaNotaVO.getPermiteRealizarRecuperacaoDisciplinaAdaptacao() && historicoVO.getTipoHistorico().equals(TipoHistorico.ADAPTACAO.getValor())) {
						if (notaRecuperacao != null) {
							throw new Exception("A nota " + configuracaoAcademicaNotaVO.getTitulo() + " do aluno " + historicoVO.getMatricula().getAluno().getNome() + " (" + historicoVO.getMatricula().getMatricula() + ") não pode ser informada porque o aluno está estudando em regime de adaptação.");
						} else {
							continue q;
						}
					}
					if (!configuracaoAcademicaNotaVO.getPermiteRealizarRecuperacaoDisciplinaDependencia() && historicoVO.getTipoHistorico().equals(TipoHistorico.DEPENDENCIA.getValor())) {
						if (notaRecuperacao != null) {
							throw new Exception("A nota " + configuracaoAcademicaNotaVO.getTitulo() + " do aluno " + historicoVO.getMatricula().getAluno().getNome() + " (" + historicoVO.getMatricula().getMatricula() + ") não pode ser informada porque o aluno está estudando em regime de dependência.");
						} else {
							continue q;
						}
					}
					if (configuracaoAcademicaNotaVO.getUtilizarComoSubstitutiva()) {
						formulaUso = realizarSubstituicaoSimboloFormaCalculoConsiderandoNotaSubstitutiva(historicoVO, historicoFilhaComposicaoVOs, configuracaoAcademicaNotaVO.getFormulaCalculoVerificaNotaRecuperada());
					} else {
						formulaUso = historicoVO.getConfiguracaoAcademico().substituirSimbolosNaFormulaUsoNota(historicoVO, historicoFilhaComposicaoVOs, configuracaoAcademicaNotaVO.getFormulaCalculoVerificaNotaRecuperada(), i);
					}

					SituacaoRecuperacaoNotaEnum situacaoRecuperacaoNota = SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO;
					if (notaRecuperacao != null) {
						if (historicoVO.getConfiguracaoAcademico().obterSituacaoFormula(formulaUso)) {
							situacaoRecuperacaoNota = SituacaoRecuperacaoNotaEnum.NOTA_RECUPERADA;
						} else {
							situacaoRecuperacaoNota = SituacaoRecuperacaoNotaEnum.NOTA_NAO_RECUPERADA;
						}
					}
					HistoricoNotaVO historicoNotaVO = new HistoricoNotaVO();
					historicoNotaVO.getHistorico().setCodigo(historicoVO.getCodigo());
					historicoNotaVO.setTipoNota(configuracaoAcademicaNotaVO.getNota());
					historicoNotaVO.setAgrupamentoNota(configuracaoAcademicaNotaVO.getAgrupamentoNota());
					historicoNotaVO.setNotaRecuperacao(configuracaoAcademicaNotaVO.getNotaRecuperacao());
					historicoNotaVO.setTituloNota(configuracaoAcademicaNotaVO.getTitulo());
					historicoNotaVO.setSituacaoRecuperacaoNota(situacaoRecuperacaoNota);
					historicoNotaVO.setNotaLancada(notaRecuperacao);
					historicoVO.getHistoricoNotaVOs().add(historicoNotaVO);
					if(!historicoVO.getEmRecuperacao()){
						historicoVO.setEmRecuperacao(situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO));
					}
				}
			}
		}
	}

	public String realizarSubstituicaoSimboloFormaCalculoConsiderandoNotaSubstitutiva(HistoricoVO historicoVO, List<HistoricoVO> historicoFilhaComposicaoVOs, String formulaCalculoNota) throws Exception{
		for (int i = 1; i <= 40; i++) {
			String tituloNota = (String) UtilReflexao.invocarMetodoGet(historicoVO.getConfiguracaoAcademico(), "tituloNota" + i);
			if (!tituloNota.equals("")) {
				if (formulaCalculoNota.contains(tituloNota)) {
					Double valorNotaLancado = (Double) UtilReflexao.invocarMetodoGet(historicoVO, "nota" + i);
					Double notaSubstitutiva = historicoVO.getConfiguracaoAcademico().verificarExisteEDeveSerAplicadaNotaSubstitutiva(historicoVO, historicoFilhaComposicaoVOs, i);
					if (notaSubstitutiva != null) {
						valorNotaLancado = notaSubstitutiva;
					}
					if (valorNotaLancado == null && historicoVO.getConfiguracaoAcademico().getConsiderarCampoNuloNotaZerada() && historicoVO.getConfiguracaoAcademico().verificarUsoNota(historicoVO, historicoFilhaComposicaoVOs, i)) {
						valorNotaLancado = 0.0;
					}
					formulaCalculoNota = formulaCalculoNota.replaceAll("\\b" + tituloNota + "\\b", String.valueOf(valorNotaLancado));
				}
			}
		}
		return formulaCalculoNota;
	}

//	public void adicionarFiltroRelatorioAcademico(FiltroRelatorioAcademicoVO filtroRelatorioAcademicoVO, StringBuilder sqlStr) {
//		sqlStr.append(" AND matriculaperiodo.situacaomatriculaperiodo in (''");
//		if (filtroRelatorioAcademicoVO.getAtivo()) {
//			sqlStr.append(", 'AT'");
//		}
//		if (filtroRelatorioAcademicoVO.getPreMatricula()) {
//			sqlStr.append(", 'PR'");
//		}
//		if (filtroRelatorioAcademicoVO.getPreMatriculaCancelada()) {
//			sqlStr.append(", 'PC'");
//		}
//		if (filtroRelatorioAcademicoVO.getTrancado()) {
//			sqlStr.append(", 'TR'");
//		}
//		if (filtroRelatorioAcademicoVO.getConcluido()) {
//			sqlStr.append(", 'FI'");
//		}
//		if (filtroRelatorioAcademicoVO.getCancelado()) {
//			sqlStr.append(", 'CA'");
//		}
//		sqlStr.append(")");
//		if (!filtroRelatorioAcademicoVO.getPendenteFinanceiro()) {
//			sqlStr.append(" AND matriculaperiodo.situacao != 'PF'");
//		}
//	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Boolean realizarLancamentoNotaHistoricoAutomaticamente(String variavelNota, Double nota, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO, Boolean realizarCalculo, UsuarioVO usuarioVO) throws Exception {
		HistoricoVO historicoVO = consultarHistoricoParaRegistroLancamentoNotaHistoricoAutomatico(matriculaPeriodoTurmaDisciplinaVO, usuarioVO);
		if (historicoVO == null) {
			return false;
		}
		TipoNotaConceitoEnum tipoNotaAlterar = historicoVO.getConfiguracaoAcademico().getNumeroNotaPorVariavel(variavelNota);
		if (tipoNotaAlterar != null) {
			return realizarLancamentoNotaHistoricoAutomaticamente(tipoNotaAlterar, historicoVO, nota, false, null, matriculaPeriodoTurmaDisciplinaVO, realizarCalculo, usuarioVO);
		} else {
			return false;
		}
	}

	@Override
	public HistoricoVO consultarHistoricoParaRegistroLancamentoNotaHistoricoAutomatico(MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO, UsuarioVO usuarioVO) throws Exception {
		List<HistoricoVO> lista = consultarPorMatriculaDisciplinaTurmaSituacaoHistoricoAnoSemestre(matriculaPeriodoTurmaDisciplinaVO.getMatricula(), null, matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo(), 
				Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica()) ? matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica() : Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica()) ? matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica() : matriculaPeriodoTurmaDisciplinaVO.getTurma(), 
						SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor(), matriculaPeriodoTurmaDisciplinaVO.getAno(), matriculaPeriodoTurmaDisciplinaVO.getSemestre(), false, false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, null, matriculaPeriodoTurmaDisciplinaVO.getCodigo(), usuarioVO);
		HistoricoVO obj = null;
		if (lista.isEmpty()) {
			return null;
		} else {
			obj = lista.get(0);
			getFacadeFactory().getMatriculaPeriodoFacade().carregarDados(obj.getMatriculaPeriodo(), null, usuarioVO);
		}
		matriculaPeriodoTurmaDisciplinaVO.setTurma(lista.get(0).getMatriculaPeriodoTurmaDisciplina().getTurma());
		if (getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(obj.getMatricula().getMatricula(), obj.getMatriculaPeriodoTurmaDisciplina().getTurma().getCodigo(), obj.getDisciplina().getCodigo(), null, obj.getAnoHistorico(), obj.getSemestreHistorico())) {
			executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFaltaFrequenciaHistorico(obj, obj.getConfiguracaoAcademico(), usuarioVO);
		}
		return obj;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarConfiguracaoAcademicaHistorico(HistoricoVO historicoVO, final Integer configuracaoaAcadHistorico, UsuarioVO usuarioVO) throws Exception {
		try {
			final StringBuilder sql = new StringBuilder();
			sql.append("Update historico SET configuracaoacademico = ? where codigo = " + historicoVO.getCodigo() + " " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql.toString());
					sqlAlterar.setInt(1, configuracaoaAcadHistorico);
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Override
	public List<HistoricoVO> consultaRapidaAlterarConfiguracaoAcadHistorico(String matricula, Integer unidadeEnsino, Integer curso, Integer turma, Integer disciplina, Integer configuracaoAcademico, String ano, String semestre, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuffer sqlStr = new StringBuffer("");
		sqlStr.append(" select historico.codigo, matricula.matricula, pessoa.nome as aluno, configuracaoacademico.codigo as \"configuracaoacademico.codigo\", configuracaoacademico.nome as \"configuracaoacademico.nome\", turma.identificadorturma ");
		sqlStr.append(" from historico ");
		sqlStr.append(" inner join matricula on matricula.matricula = historico.matricula ");
		sqlStr.append(" inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo ");
		sqlStr.append(" inner join pessoa on pessoa.codigo = matricula.aluno ");
		sqlStr.append(" left join configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico ");
		sqlStr.append(" left join matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		sqlStr.append(" left join turma on matriculaPeriodoTurmaDisciplina.turma = turma.codigo ");
		if (Uteis.isAtributoPreenchido(unidadeEnsino)) {
			sqlStr.append(" WHERE matricula.unidadeensino = ").append(unidadeEnsino);
		}
		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		if (Uteis.isAtributoPreenchido(matricula)) {
			sqlStr.append(" AND matricula.matricula = '").append(matricula).append("' ");
		}
		if (Uteis.isAtributoPreenchido(curso) && !Uteis.isAtributoPreenchido(turma)) {
			sqlStr.append(" AND matricula.curso = ").append(curso).append(" ");
		}
		if (Uteis.isAtributoPreenchido(turma)) {
			sqlStr.append(" AND matriculaPeriodoTurmaDisciplina.turma = ").append(turma).append(" ");
		}
		if (Uteis.isAtributoPreenchido(disciplina)) {
			sqlStr.append(" AND historico.disciplina = ").append(disciplina).append(" ");
		}
		if (Uteis.isAtributoPreenchido(configuracaoAcademico)) {
			sqlStr.append(" AND historico.configuracaoacademico = ").append(configuracaoAcademico).append(" ");
		}
		if (Uteis.isAtributoPreenchido(ano)) {
			sqlStr.append(" AND historico.anohistorico = '").append(ano).append("' ");
		}
		if (Uteis.isAtributoPreenchido(semestre)) {
			sqlStr.append(" AND historico.semestrehistorico = '").append(semestre).append("' ");
		}
		sqlStr.append(" order by aluno ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getMatricula().setMatricula(tabelaResultado.getString("matricula"));
			obj.getMatricula().getAluno().setNome(tabelaResultado.getString("aluno"));
			obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setIdentificadorTurma(tabelaResultado.getString("identificadorturma"));
			obj.getConfiguracaoAcademico().setNome(tabelaResultado.getString("configuracaoacademico.nome"));
			obj.getConfiguracaoAcademico().setCodigo(tabelaResultado.getInt("configuracaoacademico.codigo"));
			obj.setNovoObj(false);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Integer consultarCargaHorariaQueAlunoEstaCursandoDoUltimoPeriodo(String matricula, Integer gradeCurricular, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append(" select sum(cargahorariadisciplina) AS cargahorariadisciplina from (");
		sb.append(" select distinct historico.codigo, historico.cargahorariadisciplina from historico ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo and matriculaperiodo.codigo in ");
		sb.append(" (");
		sb.append(" select mp.codigo from matriculaperiodo mp where mp.matricula = historico.matricula order by mp.codigo desc, mp.ano desc, mp.semestre desc limit 1 ");
		sb.append(" ) ");
		sb.append(" where historico.matricula = '").append(matricula).append("' ");
		sb.append(" and historico.situacao = 'CS' ");
		sb.append(" and historico.matrizcurricular = ").append(gradeCurricular);
		sb.append(" ) as t ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("cargahorariadisciplina");
		}
		return 0;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarHistoricoPorHistoricoGradeAnteriorAlterada(final HistoricoGradeAnteriorAlteradaVO obj, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set situacao=?, mediaFinal=?, freguencia=?, anoHistorico=?, semestreHistorico=?, instituicao=?, cidade=?, cargaHorariaCursada=?, matriculaPeriodo=?, isentarMediaFinal=? WHERE codigo = ? ";
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					sqlAlterar.setString(++i, obj.getSituacao());
					sqlAlterar.setDouble(++i, obj.getMediaFinal());
					sqlAlterar.setDouble(++i, obj.getFrequencia());
					sqlAlterar.setString(++i, obj.getAno());
					sqlAlterar.setString(++i, obj.getSemestre());
					sqlAlterar.setString(++i, obj.getInstituicao());
					sqlAlterar.setInt(++i, obj.getCidadeVO().getCodigo());
					sqlAlterar.setInt(++i, obj.getCargaHorariaCursada());
					sqlAlterar.setInt(++i, obj.getMatriculaPeriodoVO().getCodigo());
					sqlAlterar.setBoolean(++i, obj.getIsentarMediaFinal());
					sqlAlterar.setInt(++i, obj.getHistoricoVO().getCodigo());
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarHistoricoPorAlteracaoGradeCurricularCursoIntegral(TurmaVO turmaNovaGradeCurricular,  DisciplinaVO novaDisciplina, Integer disciplina, GradeDisciplinaVO gd, GradeCurricularGrupoOptativaDisciplinaVO gcgod, List<MatriculaPeriodoVO> listaMatriculaPeriodo, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("update Historico set  ");
		sqlStr.append(" matrizcurricular = ").append(turmaNovaGradeCurricular.getGradeCurricularVO().getCodigo()).append(", ");
		sqlStr.append(" periodoletivocursada = ").append(turmaNovaGradeCurricular.getPeridoLetivo().getCodigo()).append(", ");
		sqlStr.append(" periodoletivomatrizcurricular = ").append(turmaNovaGradeCurricular.getPeridoLetivo().getCodigo()).append(", ");
		sqlStr.append(" historicodisciplinaforagrade  = false, ");
		if(Uteis.isAtributoPreenchido(gd)){
			sqlStr.append(" gradeDisciplina = ").append(gd.getCodigo()).append(", ");
			sqlStr.append(" cargahorariadisciplina = ").append(gd.getCargaHoraria()).append(", ");
			sqlStr.append(" creditodisciplina = ").append(gd.getNrCreditos()).append(", ");
			sqlStr.append(" gradeCurricularGrupoOptativaDisciplina = null, ");
			sqlStr.append(" disciplinareferenteaumgrupooptativa = false, ");
		}
		if(Uteis.isAtributoPreenchido(gcgod)){
			sqlStr.append(" gradeCurricularGrupoOptativaDisciplina = ").append(gcgod.getCodigo()).append(", ");
			sqlStr.append(" cargahorariadisciplina = ").append(gcgod.getCargaHoraria()).append(", ");
			sqlStr.append(" creditodisciplina = ").append(gcgod.getNrCreditos()).append(", ");
			sqlStr.append(" disciplinareferenteaumgrupooptativa = true, ");
			sqlStr.append(" gradeDisciplina = null, ");
		}
		sqlStr.append(" disciplina = ").append(novaDisciplina.getCodigo()).append(", ");
		sqlStr.append(" nomedisciplina = '").append(novaDisciplina.getNome()).append("' ");

		sqlStr.append(" where matriculaperiodoturmadisciplina in ( ");
		sqlStr.append(" select codigo from matriculaperiodoturmadisciplina ");
		sqlStr.append(" where matriculaperiodo in (").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaMatriculaPeriodo, "codigo")).append(")");
		sqlStr.append(" and turma = ").append(turmaNovaGradeCurricular.getCodigo()).append(" ");
		sqlStr.append(" and disciplina = ").append(disciplina).append(" ");
		sqlStr.append(" ) ");
		sqlStr.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
		getConexao().getJdbcTemplate().update(sqlStr.toString());
	}
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarHistoricoPorAlteracaoGradeCurricularCursoIntegralComReposicao(Boolean isOrigemHistorico, Integer codigoOrigem, Integer matrizCurricular, Integer periodoLetivoCursada, Integer periodoLetivoMatrizCurricular, DisciplinaVO novaDisciplina, GradeDisciplinaVO gd, GradeCurricularGrupoOptativaDisciplinaVO gcgod, Integer mapaEquivalenciaDisciplina, Integer mapaEquivalenciaDisciplinaCursada, Integer mapaEquivalenciaDisciplinaMatrizCurricular, Integer numeroAgrupamentoEquivalenciaDisciplina,  boolean historicoEquivalente, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("update Historico set  ");
		if(Uteis.isAtributoPreenchido(mapaEquivalenciaDisciplina)){
			sqlStr.append(" mapaequivalenciadisciplina = ").append(mapaEquivalenciaDisciplina).append(", ");
			sqlStr.append(" numeroAgrupamentoEquivalenciaDisciplina = ").append(numeroAgrupamentoEquivalenciaDisciplina).append(", ");
			sqlStr.append(" historicoequivalente =  ").append(historicoEquivalente).append(", ");
		}
		if(Uteis.isAtributoPreenchido(mapaEquivalenciaDisciplinaCursada)){
			sqlStr.append(" mapaequivalenciadisciplinacursada = ").append(mapaEquivalenciaDisciplinaCursada).append(", ");
		}
		if(Uteis.isAtributoPreenchido(mapaEquivalenciaDisciplinaMatrizCurricular)){
			sqlStr.append(" mapaequivalenciadisciplinamatrizcurricular = ").append(mapaEquivalenciaDisciplinaMatrizCurricular).append(", ");
		}
		if(Uteis.isAtributoPreenchido(matrizCurricular)){
			sqlStr.append(" matrizcurricular = ").append(matrizCurricular).append(", ");
		}
		if(Uteis.isAtributoPreenchido(periodoLetivoCursada)){
			sqlStr.append(" periodoletivocursada = ").append(periodoLetivoCursada).append(", ");
		}
		if(Uteis.isAtributoPreenchido(periodoLetivoMatrizCurricular)){
			sqlStr.append(" periodoletivomatrizcurricular = ").append(periodoLetivoMatrizCurricular).append(", ");
		}
		if(Uteis.isAtributoPreenchido(gd)){
			sqlStr.append(" gradeDisciplina = ").append(gd.getCodigo()).append(", ");
			sqlStr.append(" cargahorariadisciplina = ").append(gd.getCargaHoraria()).append(", ");
			sqlStr.append(" creditodisciplina = ").append(gd.getNrCreditos()).append(", ");
			sqlStr.append(" gradeCurricularGrupoOptativaDisciplina = null, ");
			sqlStr.append(" disciplinareferenteaumgrupooptativa = false, ");
		}
		if(Uteis.isAtributoPreenchido(gcgod)){
			sqlStr.append(" gradeCurricularGrupoOptativaDisciplina = ").append(gcgod.getCodigo()).append(", ");
			sqlStr.append(" cargahorariadisciplina = ").append(gcgod.getCargaHoraria()).append(", ");
			sqlStr.append(" creditodisciplina = ").append(gcgod.getNrCreditos()).append(", ");
			sqlStr.append(" disciplinareferenteaumgrupooptativa = true, ");
			sqlStr.append(" gradeDisciplina = null, ");
		}
		if(Uteis.isAtributoPreenchido(novaDisciplina)){
			sqlStr.append(" disciplina = ").append(novaDisciplina.getCodigo()).append(", ");
			sqlStr.append(" nomedisciplina = '").append(novaDisciplina.getNome()).append("', ");
		}
		if(isOrigemHistorico){
			sqlStr.append(" codigo = ").append(codigoOrigem).append(" ");
			sqlStr.append(" where codigo = ").append(codigoOrigem).append(" ");
		}else{
			sqlStr.append(" matriculaperiodoturmadisciplina = ").append(codigoOrigem).append(" ");
			sqlStr.append(" where matriculaperiodoturmadisciplina = ").append(codigoOrigem).append(" ");
		}
		sqlStr.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
		getConexao().getJdbcTemplate().update(sqlStr.toString());
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarHistoricoForaDaGradePorAlteracaoGradeCurricularCursoIntegral(List<MatriculaPeriodoVO> listaMatriculaPeriodo, TurmaVO turma, Integer disciplina, Integer gradeCurricular, boolean historicodisciplinaforagrade, UsuarioVO usuario) throws Exception {
		try {
			StringBuilder sqlStr = new StringBuilder("update Historico set  ");
			sqlStr.append(" historicodisciplinaforagrade  = ").append(historicodisciplinaforagrade).append(" ,");
			sqlStr.append(" matrizcurricular = ").append(turma.getGradeCurricularVO().getCodigo()).append(", ");
			sqlStr.append(" periodoletivocursada = ").append(turma.getPeridoLetivo().getCodigo()).append(" ");
			sqlStr.append(" where codigo in ( ");
			sqlStr.append(" select distinct historico.codigo from historico  ");
			sqlStr.append(" inner join matriculaperiodoturmadisciplina on historico.matriculaperiodoturmadisciplina = matriculaperiodoturmadisciplina.codigo");
			sqlStr.append(" inner join matriculaperiodo on matriculaperiodo.codigo = matriculaperiodoturmadisciplina.matriculaperiodo");
			sqlStr.append(" where matriculaPeriodo.codigo in (").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaMatriculaPeriodo, "codigo")).append(") ");
			sqlStr.append(" and historico.matrizcurricular = ").append(gradeCurricular);
			if(Uteis.isAtributoPreenchido(disciplina)){
				sqlStr.append(" and matriculaperiodoturmadisciplina.disciplina = ").append(disciplina);
				sqlStr.append(" and historico.historicodisciplinaforagrade = ").append(!historicodisciplinaforagrade);
			}
			sqlStr.append(" ) ");
			sqlStr.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} catch (Exception e) {
			throw e;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<MatriculaPeriodoVO> verificarSeExisteHistoricoForaGradePorAlteracaoGradeCurricularCursoIntegral(List<MatriculaPeriodoVO> listaMatriculaPeriodo, Integer disciplina, Integer gradeCurricular, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = new StringBuilder(" ");
		sqlStr.append(" select distinct matriculaperiodo.codigo  from historico  ");
		sqlStr.append(" inner join matriculaperiodoturmadisciplina on historico.matriculaperiodoturmadisciplina = matriculaperiodoturmadisciplina.codigo");
		sqlStr.append(" inner join matriculaperiodo on matriculaperiodo.codigo = matriculaperiodoturmadisciplina.matriculaperiodo");
		sqlStr.append(" where matriculaPeriodo.codigo in (").append(UteisTexto.converteListaEntidadeCampoCodigoParaCondicaoIn(listaMatriculaPeriodo, "codigo")).append(") ");
		sqlStr.append(" and historico.matrizcurricular = ").append(gradeCurricular);
		sqlStr.append(" and historico.historicodisciplinaforagrade  ");
		if(Uteis.isAtributoPreenchido(disciplina)){
			sqlStr.append(" and matriculaperiodoturmadisciplina.disciplina = ").append(disciplina);
		}
		sqlStr.append(" ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<MatriculaPeriodoVO> listaMp = new ArrayList<>();
		while (rs.next()) {
			MatriculaPeriodoVO mp = new MatriculaPeriodoVO();
			mp.setCodigo(rs.getInt("codigo"));
			listaMp.add(mp);
		}
		return listaMp;
	}

	@Override
	public boolean verificarExisteHistoricoVinculadoMatriculaMatrizCurricular(String matricula, Integer matrizCurricular, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select count(codigo) from historico ");
		sqlStr.append("where matricula = '").append(matricula).append("' ");
		sqlStr.append("and matrizcurricular = ").append(matrizCurricular);
		return getConexao().getJdbcTemplate().queryForInt(sqlStr.toString()) > 0;
	}


	public StringBuilder getSqlConsultaHistoricoPorMapaEquivalencia(){
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" select historico.codigo, historico.matricula, historico.matriculaperiodo, historico.disciplina, historico.matriculaperiodoturmadisciplina, historico.mapaequivalenciadisciplina, historico.mapaequivalenciadisciplinacursada, ");
		sqlStr.append(" historico.numeroAgrupamentoEquivalenciaDisciplina, historico.situacao, historico.anohistorico, historico.semestrehistorico, historico.historicoequivalente, historico.historicoporequivalencia, ");
		sqlStr.append(" historico.cargaHorariaDisciplina ");
		sqlStr.append(" FROM historico ");
		return sqlStr;
	}

	private List<HistoricoVO> montarDadosListaConsultaHistoricoPorMapaEquivalencia(SqlRowSet rs) throws SQLException {
		List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
		while (rs.next()) {
			historicoVOs.add(montarDadosConsultaHistoricoPorMapaEquivalencia(rs));
		}
		return historicoVOs;
	}

	private HistoricoVO montarDadosConsultaHistoricoPorMapaEquivalencia(SqlRowSet rs) throws SQLException {
		HistoricoVO obj = new HistoricoVO();
		obj.setCodigo(rs.getInt("codigo"));
		obj.getMatricula().setMatricula(rs.getString("matricula"));
		obj.getMatriculaPeriodo().setCodigo(rs.getInt("matriculaperiodo"));
		obj.getDisciplina().setCodigo(rs.getInt("disciplina"));
		if (Uteis.isColunaExistente(rs, "nomeDisciplinaEquivalente")) {
			obj.getDisciplina().setNome(rs.getString("nomeDisciplinaEquivalente"));
		}
		obj.getMapaEquivalenciaDisciplina().setCodigo(rs.getInt("mapaequivalenciadisciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(rs.getInt("matriculaperiodoturmadisciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().setMatricula(rs.getString("matricula"));
		obj.getMatriculaPeriodoTurmaDisciplina().getDisciplina().setCodigo(rs.getInt("disciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().getMapaEquivalenciaDisciplinaCursada().setCodigo(rs.getInt("mapaequivalenciadisciplinacursada"));
		obj.getMatriculaPeriodoTurmaDisciplina().getMapaEquivalenciaDisciplinaVOIncluir().setCodigo(rs.getInt("mapaequivalenciadisciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().setAno(rs.getString("anohistorico"));
		obj.getMatriculaPeriodoTurmaDisciplina().setSemestre(rs.getString("semestrehistorico"));
		obj.getMatriculaPeriodoTurmaDisciplina().setDisciplinaEquivale(rs.getBoolean("historicoequivalente"));
		obj.getMatriculaPeriodoTurmaDisciplina().getMatriculaPeriodoObjetoVO().setCodigo(rs.getInt("matriculaperiodo"));
		obj.getMatriculaPeriodoTurmaDisciplina().setMatriculaPeriodo(rs.getInt("matriculaperiodo"));
		obj.getMatriculaPeriodoTurmaDisciplina().setMatricula(rs.getString("matricula"));
		obj.getMatriculaPeriodoTurmaDisciplina().getMatriculaObjetoVO().setMatricula(rs.getString("matricula"));
		obj.setNumeroAgrupamentoEquivalenciaDisciplina(rs.getInt("numeroAgrupamentoEquivalenciaDisciplina"));
		obj.setSituacao(rs.getString("situacao"));
		obj.getMapaEquivalenciaDisciplinaCursada().setCodigo(rs.getInt("mapaequivalenciadisciplinacursada"));
		obj.setAnoHistorico(rs.getString("anohistorico"));
		obj.setSemestreHistorico(rs.getString("semestrehistorico"));
		obj.setHistoricoEquivalente(rs.getBoolean("historicoequivalente"));
		obj.setHistoricoPorEquivalencia(rs.getBoolean("historicoporequivalencia"));
		obj.setCargaHorariaDisciplina(rs.getInt("cargaHorariaDisciplina"));
		return obj;
	}



	/**
	 * Método responsável por consultar históricos por matrícula e por mapa
	 * equivalência disciplina cujo históricos sejam equivalentes.
	 *
	 * @param matricula
	 * @param mapaEquivalenciaDisciplina
	 * @param verificarAcesso
	 * @param usuarioVO
	 * @return
	 * @throws Exception
	 */
	public List<HistoricoVO> consultarHistoricoEquivalentePorMatriculaMapaEquivalenciaDisciplina(String matricula, Integer mapaEquivalenciaDisciplina, Integer numeroAgrupamentoEquivalenciaDisciplina, boolean verificarAcesso, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = getSqlConsultaHistoricoPorMapaEquivalencia();
		sqlStr.append("where matricula = '").append(matricula).append("' ");
		sqlStr.append(" and mapaequivalenciadisciplina = ").append(mapaEquivalenciaDisciplina);
		sqlStr.append(" and numeroAgrupamentoEquivalenciaDisciplina = ").append(numeroAgrupamentoEquivalenciaDisciplina);
		sqlStr.append(" and historicoequivalente ");
		sqlStr.append("order by codigo");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosListaConsultaHistoricoPorMapaEquivalencia(rs);
	}

	/**
	 * Método responsável por consultar históricos por matrícula e por mapa
	 * equivalência disciplina cujo históricos sejam equivalentes.
	 *
	 * @param matricula
	 * @param mapaEquivalenciaDisciplina
	 * @param verificarAcesso
	 * @param usuarioVO
	 * @return
	 * @throws Exception
	 */
	public List<HistoricoVO> consultarHistoricoPorEquivalenciaPorMatriculaMapaEquivalenciaDisciplina(String matricula, Integer mapaEquivalenciaDisciplina, Integer numeroAgrupamentoEquivalenciaDisciplina, boolean verificarAcesso, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = getSqlConsultaHistoricoPorMapaEquivalencia();
		sqlStr.append(" where matricula = '").append(matricula).append("' ");
		sqlStr.append(" and mapaequivalenciadisciplina = ").append(mapaEquivalenciaDisciplina);
		sqlStr.append(" and historicoporequivalencia ");
		sqlStr.append(" and numeroAgrupamentoEquivalenciaDisciplina = ").append(numeroAgrupamentoEquivalenciaDisciplina);
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosListaConsultaHistoricoPorMapaEquivalencia(rs);
	}

	public HistoricoVO consultarHistoricoDoMapaDisciplinaEquivalenteMatrizCurricular(Integer mptd, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = getSqlConsultaHistoricoPorMapaEquivalencia();
		sqlStr.append(" inner join historico as his_mptd on his_mptd.mapaequivalenciadisciplina = historico.mapaequivalenciadisciplina  ");
		sqlStr.append(" and his_mptd.numeroAgrupamentoEquivalenciaDisciplina = historico.numeroAgrupamentoEquivalenciaDisciplina ");
		sqlStr.append(" and his_mptd.matriculaperiodo = historico.matriculaperiodo ");
		sqlStr.append(" and his_mptd.mapaequivalenciadisciplinacursada is not null ");
		sqlStr.append(" and his_mptd.historicoequivalente  ");
		sqlStr.append(" and historico.mapaequivalenciadisciplinamatrizcurricular is not null ");
		sqlStr.append(" and historico.historicoporequivalencia ");
		sqlStr.append(" where his_mptd.matriculaperiodoturmadisciplina = ").append(mptd).append(" ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!rs.next()) {
			return new HistoricoVO();
		}
		return montarDadosConsultaHistoricoPorMapaEquivalencia(rs);
	}



	@Override
	public List<HistoricoVO> consultarPorMatriculaPeriodoGradeCurricularAtual(Integer matriculaPeriodo, Integer gradeCurricularAtual, String[] situacaoHistoricoDesconsiderar, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append("WHERE historico.matriculaperiodo = ").append(matriculaPeriodo);
		sqlStr.append(" and matricula.gradecurricularatual = ").append(gradeCurricularAtual);
		sqlStr.append(" and (historicoequivalente = false or historicoequivalente is null)");
		sqlStr.append(" and (historicodisciplinafazpartecomposicao = false or historicodisciplinafazpartecomposicao is null)");
		if (situacaoHistoricoDesconsiderar.length > 0) {
			sqlStr.append(" and historico.situacao not in (''");
			for (String situacaoHistorico : situacaoHistoricoDesconsiderar) {
				sqlStr.append(", '").append(situacaoHistorico).append("'");
			}
			sqlStr.append(")");
		}
		sqlStr.append(" order by disciplina.nome");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaCompleta(tabelaResultado, usuario);
	}

	/**
	 * Responsável por executar o processamento das faltas do primeiro ao quarto
	 * bimestre e a total de faltas dos alunos.
	 *
	 * @author Wellington Rodrigues - 06/04/2015
	 * @param historicoVO
	 * @param matriculaPeriodoTurmaDisciplinaVO
	 * @param usuarioVO
	 * @throws Exception
	 */
	private void executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreETotalFaltaHistorico(HistoricoVO historicoVO, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO, UsuarioVO usuarioVO) throws Exception {
		String nivelEducacional = getFacadeFactory().getCursoFacade().consultarNivelEducacionalPorTurma(matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo());
		if (nivelEducacional.equals(TipoNivelEducacional.INFANTIL.getValor()) || nivelEducacional.equals(TipoNivelEducacional.BASICO.getValor()) || nivelEducacional.equals(TipoNivelEducacional.MEDIO.getValor())) {
			Map<BimestreEnum, Integer> faltaBimestres = getFacadeFactory().getRegistroAulaFacade().consultarQuantidadeFaltasAlunoBimestre(historicoVO.getMatricula().getMatricula(), historicoVO.getDisciplina().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getSemestre(), matriculaPeriodoTurmaDisciplinaVO.getAno(), matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo(), false, usuarioVO);
			historicoVO.setFaltaPrimeiroBimestre(faltaBimestres.get(BimestreEnum.BIMESTRE_01));
			historicoVO.setFaltaSegundoBimestre(faltaBimestres.get(BimestreEnum.BIMESTRE_02));
			historicoVO.setFaltaTerceiroBimestre(faltaBimestres.get(BimestreEnum.BIMESTRE_03));
			historicoVO.setFaltaQuartoBimestre(faltaBimestres.get(BimestreEnum.BIMESTRE_04));
			historicoVO.setTotalFalta(historicoVO.getFaltaPrimeiroBimestre() + historicoVO.getFaltaSegundoBimestre() + historicoVO.getFaltaTerceiroBimestre() + historicoVO.getFaltaQuartoBimestre());
		} else {
			historicoVO.setTotalFalta(getFacadeFactory().getRegistroAulaFacade().consultaRapidaFaltasAlunoBoletimAcademico(historicoVO.getMatricula().getMatricula(), historicoVO.getDisciplina().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getSemestre(), matriculaPeriodoTurmaDisciplinaVO.getAno(), matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo(), false, usuarioVO));
		}
	}

	private void alterarFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFalta(HistoricoVO historicoVO, boolean controlarAcesso, UsuarioVO usuarioVO) throws Exception {
		Historico.alterar(getIdEntidade(), controlarAcesso, usuarioVO);
		StringBuilder sqlUpdate = new StringBuilder();
		sqlUpdate.append("UPDATE Historico set faltaprimeirobimestre = ?, faltasegundobimestre = ?, faltaterceirobimestre = ?, faltaquartobimestre = ?, totalfalta = ? where codigo = ?");
		Object atributosAlterar = new Object[] { historicoVO.getFaltaPrimeiroBimestre(), historicoVO.getFaltaSegundoBimestre(), historicoVO.getFaltaTerceiroBimestre(), historicoVO.getFaltaQuartoBimestre(), historicoVO.getTotalFalta(), historicoVO.getCodigo() };
		getConexao().getJdbcTemplate().update(sqlUpdate.toString(), atributosAlterar);
	}

	/**
	 * Responsável por executar a alteração das faltas do primeiro, segundo,
	 * terceiro, quarto bimestre, total falta e frequencia, considerando
	 * histórico por correspondência, por equivalência e que faz parte de
	 * composição.
	 *
	 * @author Wellington Rodrigues - 07/04/2015
	 * @param historicoVO
	 * @param controlarAcesso
	 * @param usuarioVO
	 * @throws Exception
	 */
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void executarAlteracaoFaltaPrimeiroSegundoTerceiroQuartoTotalFaltaBimestreFrequenciaConsiderandoHistoricoPorCorrespondenciaEquivalenciaFazParteComposicao(HistoricoVO historicoVO, boolean controlarAcesso, UsuarioVO usuarioVO) throws Exception {
		if (historicoVO.getHistoricoPorEquivalencia()) {
			alterarFaltaPrimeiroSegundoTerceiroQuartoTotalFaltaBimestreFrequenciaHistoricoEquivalente(historicoVO, controlarAcesso, usuarioVO);
		}
		if (historicoVO.getHistoricoDisciplinaFazParteComposicao()) {
			alterarFaltaPrimeiroSegundoTerceiroQuartoTotalFaltaBimestreFrequenciaHistoricoDisciplinaComposta(historicoVO, controlarAcesso, usuarioVO);
		}
		if (Uteis.isAtributoPreenchido(historicoVO.getTransferenciaMatrizCurricularMatricula())) {
			alterarFaltaPrimeiroSegundoTerceiroQuartoTotalFaltaBimestreFrequenciaHistoricoCursandoPorCorrespondenciaAposTransferencia(historicoVO, controlarAcesso, usuarioVO);
		}
		executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreETotalFaltaHistorico(historicoVO, historicoVO.getMatriculaPeriodoTurmaDisciplina(), usuarioVO);
		alterarFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFalta(historicoVO, controlarAcesso, usuarioVO);
	}

	/**
	 * Responsável por executar a alteração das faltas do primeiro, segundo,
	 * terceiro, quarto bimestre, total falta e frequencia, considerando
	 * histórico por equivalência.
	 *
	 * @author Wellington Rodrigues - 07/04/2015
	 * @param historicoVO
	 * @param controlarAcesso
	 * @param usuarioVO
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void alterarFaltaPrimeiroSegundoTerceiroQuartoTotalFaltaBimestreFrequenciaHistoricoEquivalente(HistoricoVO historicoVO, boolean controlarAcesso, UsuarioVO usuarioVO) throws Exception {
		List<HistoricoVO> historicoEquivalenteVOs = getFacadeFactory().getHistoricoFacade().consultarHistoricoEquivalentePorMatriculaMapaEquivalenciaDisciplina(historicoVO.getMatricula().getMatricula(), historicoVO.getMapaEquivalenciaDisciplina().getCodigo(), historicoVO.getNumeroAgrupamentoEquivalenciaDisciplina(), false, usuarioVO);
		for (HistoricoVO historicoEquivalenteVO : historicoEquivalenteVOs) {
			MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO = getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarPorChavePrimaria(historicoEquivalenteVO.getMatriculaPeriodoTurmaDisciplina().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);
			executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreETotalFaltaHistorico(historicoEquivalenteVO, matriculaPeriodoTurmaDisciplinaVO, usuarioVO);
			alterarFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFalta(historicoEquivalenteVO, controlarAcesso, usuarioVO);
		}
	}

	/**
	 * Responsável por executar a alteração das faltas do primeiro, segundo,
	 * terceiro, quarto bimestre, total falta e frequencia, considerando
	 * histórico cursando por correspondência.
	 *
	 * @author Wellington Rodrigues - 07/04/2015
	 * @param historicoVO
	 * @param controlarAcesso
	 * @param usuarioVO
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void alterarFaltaPrimeiroSegundoTerceiroQuartoTotalFaltaBimestreFrequenciaHistoricoCursandoPorCorrespondenciaAposTransferencia(HistoricoVO historicoVO, boolean controlarAcesso, UsuarioVO usuarioVO) throws Exception {
		HistoricoVO historicoCursandoPorCorrespondecia = this.consultarHistoricoCursandoPoCorrespondenciaAposTransferencia(historicoVO.getMatriculaPeriodo().getCodigo(), historicoVO.getDisciplina().getCodigo(), false, usuarioVO);
		if (Uteis.isAtributoPreenchido(historicoCursandoPorCorrespondecia)) {
			MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO = getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarPorChavePrimaria(historicoCursandoPorCorrespondecia.getMatriculaPeriodoTurmaDisciplina().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);
			executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreETotalFaltaHistorico(historicoCursandoPorCorrespondecia, matriculaPeriodoTurmaDisciplinaVO, usuarioVO);
			alterarFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFalta(historicoCursandoPorCorrespondecia, controlarAcesso, usuarioVO);
		}
	}

	/**
	 * Responsável por executar a alteração das faltas do primeiro, segundo,
	 * terceiro, quarto bimestre, total falta e frequencia, considerando
	 * histórico composto.
	 *
	 * @author Wellington Rodrigues - 07/04/2015
	 * @param historicoVO
	 * @param controlarAcesso
	 * @param usuarioVO
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void alterarFaltaPrimeiroSegundoTerceiroQuartoTotalFaltaBimestreFrequenciaHistoricoDisciplinaComposta(HistoricoVO historicoVO, boolean controlarAcesso, UsuarioVO usuarioVO) throws Exception {
		HistoricoVO historicoDisciplinaComposta = getFacadeFactory().getHistoricoFacade().consultaHistoricoDisciplinaCompostaPorMatriculaGradeCurricularAnoSemestreGradeDisciplinaComposta(historicoVO.getMatricula().getMatricula(), historicoVO.getMatrizCurricular().getCodigo(), historicoVO.getAnoHistorico(), historicoVO.getSemestreHistorico(), historicoVO.getGradeDisciplinaComposta().getCodigo(), false, usuarioVO);
		if (Uteis.isAtributoPreenchido(historicoDisciplinaComposta)) {
			List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
			List<GradeDisciplinaCompostaVO> gradeDisciplinaCompostaVOs = new ArrayList<GradeDisciplinaCompostaVO>(0);
			if (Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getGradeDisciplinaVO())) {
				gradeDisciplinaCompostaVOs = getFacadeFactory().getGradeDisciplinaCompostaFacade().consultarPorGradeDisciplina(historicoDisciplinaComposta.getGradeDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);
			} else if (Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO())) {
				gradeDisciplinaCompostaVOs = getFacadeFactory().getGradeDisciplinaCompostaFacade().consultarPorGrupoOptativaDisciplina(historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);
			}
			for (GradeDisciplinaCompostaVO disciplinaCompostaVO : gradeDisciplinaCompostaVOs) {
				if (disciplinaCompostaVO.getCodigo().equals(historicoVO.getGradeDisciplinaComposta().getCodigo())) {
					historicoVOs.add(historicoVO);
				} else {
					historicoVOs.add(getFacadeFactory().getHistoricoFacade().consultaRapidaPorMatricula_matriculaPeriodo_Disciplina(historicoDisciplinaComposta.getMatricula().getMatricula(), historicoDisciplinaComposta.getMatriculaPeriodo().getCodigo(), historicoDisciplinaComposta.getMatrizCurricular().getCodigo(), disciplinaCompostaVO.getDisciplina().getCodigo(), false, usuarioVO));
				}
			}
			executarCalculoFaltasAlunoBimestreDisciplinaComposta(historicoVOs, historicoDisciplinaComposta);
			alterarFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFalta(historicoVO, controlarAcesso, usuarioVO);
		}
	}

	/**
	 * Responsável por executar o cálcudo da média parcial das notas do
	 * histórico da disciplina composta de acordo com os históricos da
	 * disciplinas que fazem parte da composição, e realizar o preenchimento das
	 * notas via reflexão.
	 *
	 * @author Wellington Rodrigues - 14/04/2015
	 * @param historicoDisciplinaComposta
	 * @param historicoDisciplinaFazParteComposicaoVOs
	 * @param posicao
	 * @throws Exception
	 */
	private void executarCalculoMediaParcialDisciplinaComposta(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs, int posicao) throws Exception {
		Double valorFinal = null;
		for (HistoricoVO historicoVO : historicoDisciplinaFazParteComposicaoVOs) {
			Double valorNota = (Double) UtilReflexao.invocarMetodoGet(historicoVO, "nota" + posicao);
			if (valorNota != null) {
				if (valorFinal == null) {
					valorFinal = valorNota;
				} else {
					valorFinal += valorNota;
				}
			}
		}
		if (valorFinal != null) {
			valorFinal = (valorFinal / historicoDisciplinaFazParteComposicaoVOs.size());
			valorFinal = Uteis.formatarDeAcordoQuantidadeCasasDecimaisAposVirgulaDouble(valorFinal, historicoDisciplinaComposta.getConfiguracaoAcademico().getQuantidadeCasasDecimaisPermitirAposVirgula());
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setNota" + posicao, valorFinal);
			realizarValidacaoNotaLancada(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, historicoDisciplinaComposta.getConfiguracaoAcademico(), posicao);
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setNota" + posicao + "Lancada", true);
		} else {
			UtilReflexao.invocarMetodoSetParametroNull(historicoDisciplinaComposta, "nota" + posicao);
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setNota" + posicao + "Lancada", false);
		}
	}

	/**
	 * Responsável por executar o cálculo da média final parcial do histórico da
	 * disciplina composta de acordo com os históricos da disciplinas que fazem
	 * parte da composição.
	 *
	 * @author Wellington Rodrigues - 14/04/2015
	 * @param historicoDisciplinaComposta
	 * @param historicoDisciplinaFazParteComposicaoVOs
	 * @param posicao
	 * @throws Exception
	 */
	private void executarCalculoMediaFinalParcialDisciplinaComposta(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs, int posicao) throws Exception {
		int x = 0;
		for (HistoricoVO historicoVO : historicoDisciplinaFazParteComposicaoVOs) {
			Double valorNota = (Double) UtilReflexao.invocarMetodoGet(historicoVO, "nota" + posicao);
			if (valorNota != null) {
				x++;
			}
		}
		if (x == historicoDisciplinaFazParteComposicaoVOs.size()) {
			historicoDisciplinaComposta.getConfiguracaoAcademico().verificarNotasQueSaoUtilizadas(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs);
			realizarValidacaoNotaLancada(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, historicoDisciplinaComposta.getConfiguracaoAcademico(), posicao);
		} else {
			historicoDisciplinaComposta.setMediaFinal(null);
			UtilReflexao.invocarMetodoSetParametroNull(historicoDisciplinaComposta, "nota" + posicao);
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setNota" + posicao + "Lancada", false);
		}
	}

	public void executarSomatorioNotaDisciplinaComposta(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs, UsuarioVO usuarioVO) throws Exception {
		for (int i = 1; i <= 40; i++) {
			Boolean utilizarNota = (Boolean) UtilReflexao.invocarMetodoGet(historicoDisciplinaComposta.getConfiguracaoAcademico(), "utilizarNota" + i);
//			Boolean utilizarNotaMediaFinal = (Boolean) UtilReflexao.invocarMetodoGet(historicoDisciplinaComposta.getConfiguracaoAcademico(), "nota" + i + "MediaFinal");
			if (utilizarNota) {
				executarSomatorioNotaDisciplinaComposta(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, i);
			}
//			} else if (utilizarNota && utilizarNotaMediaFinal) {
//				executarCalculoMediaFinalParcialDisciplinaComposta(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, i);
//			}
		}
	}


	private void executarSomatorioNotaDisciplinaComposta(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs, int posicao) throws Exception {
		Double valorFinal = null;
		for (HistoricoVO historicoVO : historicoDisciplinaFazParteComposicaoVOs) {
			Double valorNota = (Double) UtilReflexao.invocarMetodoGet(historicoVO, "nota" + posicao);
			if (valorNota != null) {
				if (valorFinal == null) {
					valorFinal = valorNota;
				} else {
					valorFinal += valorNota;
				}
			}
		}
		if (valorFinal != null) {
			valorFinal = Uteis.formatarDeAcordoQuantidadeCasasDecimaisAposVirgulaDouble(valorFinal, historicoDisciplinaComposta.getConfiguracaoAcademico().getQuantidadeCasasDecimaisPermitirAposVirgula());
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setNota" + posicao, valorFinal);
			realizarValidacaoNotaLancada(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, historicoDisciplinaComposta.getConfiguracaoAcademico(), posicao);
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setNota" + posicao + "Lancada", true);
		} else {
			UtilReflexao.invocarMetodoSetParametroNull(historicoDisciplinaComposta, "nota" + posicao);
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setNota" + posicao + "Lancada", false);
		}
	}

	/**
	 * * Versão 5.0.3.5 Este método aplica a regra de calcula da nota da
	 * disciplina composta (Mãe), com base em uma fórmula de calculo definida na
	 * GradeDisciplina ou GradeCurricularGrupoOptativaDisciplina
	 *
	 * @author Rodrigo Wind - 24/04/2015
	 * @param historicoDisciplinaComposta
	 * @param historicoDisciplinaFazParteComposicaoVOs
	 * @param usuarioVO
	 * @throws Exception
	 */
	public void executarCalculoMediaParcialDisciplinaCompostaPorFormulaCalculo(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs, UsuarioVO usuarioVO) throws Exception {
		for (int i = 1; i <= 40; i++) {
			Boolean utilizarNota = (Boolean) UtilReflexao.invocarMetodoGet(historicoDisciplinaComposta.getConfiguracaoAcademico(), "utilizarNota" + i);
//			Boolean utilizarNotaMediaFinal = (Boolean) UtilReflexao.invocarMetodoGet(historicoDisciplinaComposta.getConfiguracaoAcademico(), "nota" + i + "MediaFinal");
			if (utilizarNota) {
				executarCalculoNotaParcialDisciplinaCompostaPorFormulaCalculo(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, i);
			}
//			} else if (utilizarNota && utilizarNotaMediaFinal) {
//				executarCalculoMediaFinalParcialDisciplinaComposta(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, i);
//			}
		}
	}

	/**
	 * Responsável por executar o cálcudo da média parcial de uma nota
	 * específica histórico da disciplina composta (Mãe) de acordo com os
	 * históricos da disciplinas que fazem parte da composição (Filhas), e
	 * realizar o preenchimento das notas via reflexão, onde a mesma utiliza a
	 * fórmula de calculo definida GradeDisciplina ou
	 * GradeCurricularGrupoOptativaDisciplina substituindo as variaveis da
	 * formula pela notas das filhas para calcular a nota da mãe
	 *
	 * @author Rodrigo - 24/04/2015
	 * @param historicoDisciplinaComposta
	 *            (Mae)
	 * @param historicoDisciplinaFazParteComposicaoVOs
	 *            (Filhas)
	 * @param posicao
	 *            (notaCalcular)
	 * @throws Exception
	 */
	private void executarCalculoNotaParcialDisciplinaCompostaPorFormulaCalculo(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs, int posicao) throws Exception {
		String formula = Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getGradeDisciplinaVO()) ? historicoDisciplinaComposta.getGradeDisciplinaVO().getFormulaCalculo() : historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getFormulaCalculo();
		for (HistoricoVO historicoVO : historicoDisciplinaFazParteComposicaoVOs) {
			Double valorNota = (Double) UtilReflexao.invocarMetodoGet(historicoVO, "nota" + posicao);
			if (valorNota != null) {
				formula = formula.replaceAll(historicoVO.getGradeDisciplinaComposta().getVariavelNota(), valorNota.toString());
			}
		}
		Double valorFinal = Uteis.realizarCalculoFormula(formula);
		if (valorFinal != null) {
			valorFinal = Uteis.formatarDeAcordoQuantidadeCasasDecimaisAposVirgulaDouble(valorFinal, historicoDisciplinaComposta.getConfiguracaoAcademico().getQuantidadeCasasDecimaisPermitirAposVirgula());
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setNota" + posicao, valorFinal);
			realizarValidacaoNotaLancada(historicoDisciplinaComposta, historicoDisciplinaFazParteComposicaoVOs, historicoDisciplinaComposta.getConfiguracaoAcademico(), posicao);
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setNota" + posicao + "Lancada", true);
		} else {
			UtilReflexao.invocarMetodoSetParametroNull(historicoDisciplinaComposta, "nota" + posicao);
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setNota" + posicao + "Lancada", false);
		}
	}

	/**
	 * Para determinar se o aluno cumpriu a carga horária mínima optativa é subtraido
	 * da carga horária total da grade as cargas horárias de estágio, atividade complementar e disciplinas obrigatório
	 * o que sobra é considerado optativa, então é somado a carga horária dos históricos das disciplinas optativas seja ela vinculado ao periodo letivo
	 * ou ao grupo de disciplina optativas  que o aluno aprovou, caso esta carga horária seja maior que o restante da carga horaria da matriz então este cumpriu
	 * a carga horária mínima de disciplinas optativas.
	 */
	@Override
	public Boolean realizarVerificacaoAlunoCumpriuCargaHorariaDisciplinaOptativa(MatriculaVO matricula, Integer gradeCurricular, ProgramacaoFormaturaAlunoVO programacaoFormaturaAlunoVO){
		StringBuilder sql  = new StringBuilder(" ");
		sql.append(" select curso.quantidadeDisciplinasOptativasExpedicaoDiploma, gradecurricular.quantidadeDisciplinasOptativasMatrizCurricular as quantidadeDisciplinasOptativasMatrizCurricular, cargahoraria, totalcargahorariaestagio, totalcargahorariaatividadecomplementar, (");
		sql.append(" 			select sum(cargahoraria) from gradedisciplina ");
		sql.append(" 			inner join periodoletivo on periodoletivo.codigo = gradedisciplina.periodoletivo");
		sql.append(" 			where periodoletivo.gradecurricular = gradecurricular.codigo and gradedisciplina.tipodisciplina not in ('OP', 'LO')");
		sql.append(" 			)as cargahorariaobrigatoria, ");
		sql.append(" 			(select sum(cargahorariadisciplina) from ");
		sql.append(" 				(select historico.cargahorariadisciplina from historico  ");
		sql.append(" 				inner join gradedisciplina on gradedisciplina.codigo = historico.gradedisciplina");
		sql.append(" 				where matricula  = ? and matrizcurricular = gradecurricular.codigo");
		sql.append(" 				and gradedisciplina.tipodisciplina in ('OP', 'LO')");
		sql.append(" 			 and (historico.historicoequivalente = false or historico.historicoequivalente is null)");
		sql.append(" 				and situacao in ('AA','IS','CC','CH','AP','AE','CO','AD','AB')	");
		sql.append(" 				union all");
		sql.append(" 				select historico.cargahorariadisciplina from historico  ");
		sql.append(" 				inner join gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = historico.gradecurriculargrupooptativadisciplina				");
		sql.append(" 				where matricula  = ? and historico.matrizcurricular = gradecurricular.codigo				");
		sql.append(" 			 and (historico.historicoequivalente = false or historico.historicoequivalente is null)");
		sql.append(" 				and situacao in ('AA','IS','CC','CH','AP','AE','CO','AD','AB'))");
		sql.append(" 			 as t) as cargaHorariaOptativaCumprida, ");

		sql.append(" 			(select count(disciplina) from ");
		sql.append(" 				(select historico.disciplina from historico  ");
		sql.append(" 				inner join gradedisciplina on gradedisciplina.codigo = historico.gradedisciplina");
		sql.append(" 				where matricula  = ? and matrizcurricular = gradecurricular.codigo");
		sql.append(" 				and gradedisciplina.tipodisciplina in ('OP', 'LO')");
		sql.append(" 			 and (historico.historicoequivalente = false or historico.historicoequivalente is null)");
		sql.append(" 				and situacao in ('AA','IS','CC','CH','AP','AE','CO','AD','AB')	");
		sql.append(" 				union all");
		sql.append(" 				select historico.disciplina from historico  ");
		sql.append(" 				inner join gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = historico.gradecurriculargrupooptativadisciplina				");
		sql.append(" 				where matricula  = ? and historico.matrizcurricular = gradecurricular.codigo				");
		sql.append(" 			 and (historico.historicoequivalente = false or historico.historicoequivalente is null)");
		sql.append(" 				and situacao in ('AA','IS','CC','CH','AP','AE','CO','AD','AB'))");
		sql.append(" 			 as t) as quantidadeDisciplinaOptativaCumprida");
		sql.append(" from gradecurricular inner join curso on curso.codigo = gradecurricular.curso where gradecurricular.codigo = ? ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), matricula.getMatricula(), matricula.getMatricula() ,matricula.getMatricula(), matricula.getMatricula(), gradeCurricular);
		if(rs.next()){
			if(programacaoFormaturaAlunoVO != null) {
				programacaoFormaturaAlunoVO.setHorasDisciplinaOptativaExigida(rs.getInt("cargaHoraria") - rs.getInt("totalcargahorariaestagio") - rs.getInt("totalcargahorariaatividadecomplementar") - rs.getInt("cargahorariaobrigatoria"));
				programacaoFormaturaAlunoVO.setHorasDisciplinaOptativaCumprida(rs.getInt("cargaHorariaOptativaCumprida"));
				if(programacaoFormaturaAlunoVO.getHorasDisciplinaOptativaExigida() < 0) {
					programacaoFormaturaAlunoVO.setHorasDisciplinaOptativaExigida(0);
				}
			}
			if(matricula != null) {
				matricula.setHorasDisciplinaOptativaExigida(rs.getInt("cargaHoraria") - rs.getInt("totalcargahorariaestagio") - rs.getInt("totalcargahorariaatividadecomplementar") - rs.getInt("cargahorariaobrigatoria"));
				matricula.setHorasDisciplinaOptativaCumprida(rs.getInt("cargaHorariaOptativaCumprida"));
				if(matricula.getHorasDisciplinaOptativaExigida() < 0) {
					matricula.setHorasDisciplinaOptativaExigida(0);
				}
			}
			if (rs.getInt("quantidadeDisciplinasOptativasMatrizCurricular") > 0) {
				return rs.getInt("quantidadeDisciplinaOptativaCumprida") >= rs.getInt("quantidadeDisciplinasOptativasMatrizCurricular");
			}
			if (rs.getInt("quantidadeDisciplinasOptativasExpedicaoDiploma") > 0) {
				return rs.getInt("quantidadeDisciplinaOptativaCumprida") >= rs.getInt("quantidadeDisciplinasOptativasExpedicaoDiploma");
			}
			return  rs.getInt("cargaHorariaOptativaCumprida") >= (rs.getInt("cargaHoraria") - rs.getInt("totalcargahorariaestagio") - rs.getInt("totalcargahorariaatividadecomplementar") - rs.getInt("cargahorariaobrigatoria")) ;
		}
		return true;
	}

	public HistoricoVO consultaRapidaPorChavePrimariaDadosCompletosSemExcessao(Integer codHistorico, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (historico.codigo= ").append(codHistorico).append(")");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		HistoricoVO obj = new HistoricoVO();
		if (!tabelaResultado.next()) {
			return null;
		}
		montarDadosCompleto((HistoricoVO) obj, tabelaResultado, usuario);
		return obj;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	@Override
	public String gravarLancamentoNota(HistoricoVO historico, Boolean incluirNotaRecuperacao, String visao, TipoAlteracaoSituacaoHistoricoEnum tipoAlteracaoSituacaoHistorico, UsuarioVO usuario) throws Exception {
		String operacao = "";
		if (historico.getCodigo().intValue() == 0) {
			try {
				incluir(historico, "", usuario);
				if (incluirNotaRecuperacao) {
					realizarCriacaoHistoricoNotaVO(historico, null);
					getFacadeFactory().getHistoricoNotaFacade().incluirHistoricoNotaVOs(historico);
				}
				operacao = "Inclusão pela " + visao;
			} catch (Exception e) {
				historico.setNovoObj(true);
				throw e;
			}
		} else {
			List<HistoricoVO> historicoFilhaComposicaoVOs =  null;
			if (historico.getHistoricoDisciplinaFazParteComposicao()) {
				executarAtualizacaoDisciplinaComposta(historico, null, tipoAlteracaoSituacaoHistorico, true, false, usuario);
				alterar(historico, "", usuario);
			}else if(historico.getHistoricoDisciplinaComposta()){
				historicoFilhaComposicaoVOs = executarAtualizacaoDisciplinaFilhaComposicaoComBaseDisciplinaCompostaComposta(historico, tipoAlteracaoSituacaoHistorico, true, usuario);
				incluirNotaRecuperacao =  false;
			}else {
					alterar(historico, "", usuario);
			}
			if (incluirNotaRecuperacao) {
				if(!historico.getHistoricoDisciplinaFazParteComposicao()){
					realizarCriacaoHistoricoNotaVO(historico, historicoFilhaComposicaoVOs);
				}
				getFacadeFactory().getHistoricoNotaFacade().incluirHistoricoNotaVOs(historico);
			}

			operacao = "Alteração pela " + visao;
		}
		return operacao;
	}



	@Override
	public String getSqlCompletoConsultaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor,  Integer codigoProfessor, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, int nivelMontarDados, Integer limite, Integer offSet, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados) throws Exception {
		return getSqlCompletoConsultaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(unidadeEnsino, curso, disciplina, turmaVO, ano, semestre, trazerAlunoPendenteFinanceiramente, situacaoHistorico, verificarDisciplina, filtroVisaoProfessor, codigoProfessor, controlarAcesso, configuracaoAcademicoVO, permitiVisualizarAlunoTR_CA, trazerDisciplinaComposta, nivelMontarDados, limite, offSet, usuario, permitirRealizarLancamentoAlunosPreMatriculados, false);
	}

	@Override
	public String getSqlCompletoConsultaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor,  Integer codigoProfessor, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, int nivelMontarDados, Integer limite, Integer offSet, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados, boolean considerarProfessorExclusivo) throws Exception {
		if(trazerDisciplinaComposta){
			if(!Uteis.isAtributoPreenchido(turmaVO)) {
				trazerDisciplinaComposta = false;
			}else if(!getFacadeFactory().getTurmaDisciplinaFacade().consultarDisciplinaCompostaTurmaDisciplina(turmaVO.getCodigo(), disciplina)){
				trazerDisciplinaComposta = false;
			}
		}
		StringBuffer sqlStr = getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica(turmaVO, disciplina, trazerDisciplinaComposta);
		montarFiltroConsultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(sqlStr, unidadeEnsino, curso, disciplina, turmaVO, ano, semestre, trazerAlunoPendenteFinanceiramente, situacaoHistorico, verificarDisciplina, filtroVisaoProfessor, codigoProfessor, controlarAcesso, configuracaoAcademicoVO, permitiVisualizarAlunoTR_CA, trazerDisciplinaComposta, usuario, permitirRealizarLancamentoAlunosPreMatriculados, considerarProfessorExclusivo);
		if (Uteis.isAtributoPreenchido(turmaVO) && turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			StringBuffer sql = new StringBuffer();
			sql.append("select t.* from ");
			sql.append("(").append(sqlStr).append(") as t ");
			sql.append(" where  (exists (").append(sqlStr).append(" and historico.disciplina = t.\"disciplina.codigo\" and historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1) ") ;
			sql.append(" or not exists (").append(sqlStr).append(" and historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1)) ") ;
			sql.append(" order by  t.nomeSemAcento ");
			if (limite != null) {
				sql.append(" LIMIT ").append(limite);
				if (offSet != null) {
					sql.append(" OFFSET ").append(offSet);
				}
			}
			return sql.toString();
		}else {
			sqlStr.append(" ORDER BY nomeSemAcento ");
			if (limite != null) {
				sqlStr.append(" LIMIT ").append(limite);
				if (offSet != null) {
					sqlStr.append(" OFFSET ").append(offSet);
				}
			}

			return sqlStr.toString();
		}

	}

	@Override
	public List<HistoricoVO> consultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, Integer codigoProfessor, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, int nivelMontarDados, Integer limite, Integer offSet, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados) throws Exception {
		return consultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(unidadeEnsino, curso, disciplina, turmaVO, ano, semestre, trazerAlunoPendenteFinanceiramente, situacaoHistorico, verificarDisciplina, filtroVisaoProfessor, codigoProfessor, controlarAcesso, configuracaoAcademicoVO, permitiVisualizarAlunoTR_CA, trazerDisciplinaComposta, nivelMontarDados, limite, offSet, usuario, permitirRealizarLancamentoAlunosPreMatriculados, false);
	}

	public List<HistoricoVO> consultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, Integer codigoProfessor, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, int nivelMontarDados, Integer limite, Integer offSet, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados, boolean considerarProfessorExcluisvo) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder(getSqlCompletoConsultaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(unidadeEnsino, curso, disciplina, turmaVO, ano, semestre, trazerAlunoPendenteFinanceiramente, situacaoHistorico, verificarDisciplina, filtroVisaoProfessor, codigoProfessor, controlarAcesso, configuracaoAcademicoVO, permitiVisualizarAlunoTR_CA, trazerDisciplinaComposta, nivelMontarDados, limite, offSet, usuario, permitirRealizarLancamentoAlunosPreMatriculados, considerarProfessorExcluisvo));
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<HistoricoVO> historicoVOs = montarDadosConsultaCompleta(tabelaResultado, usuario);
		Ordenacao.ordenarLista(historicoVOs, "ordenacao");
		return historicoVOs;
	}

	@Override
	public Integer consultaRapidaTotalizadoPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, int nivelMontarDados, Integer limite, Integer offSet, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados) throws Exception {
		return consultaRapidaTotalizadoPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(unidadeEnsino, curso, disciplina, turmaVO, ano, semestre, trazerAlunoPendenteFinanceiramente, situacaoHistorico, verificarDisciplina, filtroVisaoProfessor, controlarAcesso, configuracaoAcademicoVO, permitiVisualizarAlunoTR_CA, trazerDisciplinaComposta, nivelMontarDados, limite, offSet, usuario, permitirRealizarLancamentoAlunosPreMatriculados, false);
	}

	public Integer consultaRapidaTotalizadoPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, int nivelMontarDados, Integer limite, Integer offSet, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados, boolean considerarProfessorExclusivo) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);

		if(trazerDisciplinaComposta){
			if(!getFacadeFactory().getTurmaDisciplinaFacade().consultarDisciplinaCompostaTurmaDisciplina(turmaVO.getCodigo(), disciplina)){
				trazerDisciplinaComposta = false;
			}
		}

		StringBuffer sqlStr = new StringBuffer();
		sqlStr.append("select count(distinct historico.codigo) AS qtde  ");
		sqlStr.append(" FROM historico AS historico ");

		sqlStr.append(" INNER JOIN matricula on matricula.matricula = historico.matricula ");
		sqlStr.append(" INNER JOIN matriculaPeriodo on matriculaPeriodo.matricula = matricula.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");

		if (Uteis.isAtributoPreenchido(turmaVO)) {
			sqlStr.append(" INNER JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
			if (turmaVO.getSubturma() && !trazerDisciplinaComposta) {
				if (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.TEORICA)) {
					sqlStr.append("INNER JOIN Turma ON turma.codigo = MatriculaPeriodoTurmaDisciplina.turmaTeorica ");
				} else if (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.PRATICA)) {
					sqlStr.append("INNER JOIN Turma ON turma.codigo = MatriculaPeriodoTurmaDisciplina.turmaPratica ");
				} else {
					sqlStr.append("INNER JOIN Turma ON MatriculaPeriodoTurmaDisciplina.turma = turma.codigo and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
				}
			} else {
				sqlStr.append("INNER JOIN Turma ON turma.codigo = matriculaPeriodoTurmaDisciplina.turma ");
				if (!turmaVO.getTurmaAgrupada()  && !trazerDisciplinaComposta) {
					sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
				}
			}
		} else {
			sqlStr.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
			sqlStr.append("INNER JOIN Turma ON turma.codigo = case when matriculaPeriodoTurmaDisciplina.turma is not null then matriculaPeriodoTurmaDisciplina.turma else matriculaPeriodo.turma end ");
		}
		sqlStr.append(" inner JOIN gradeCurricular on historico.matrizCurricular = gradeCurricular.codigo ");
		sqlStr.append(" inner JOIN disciplina on disciplina.codigo = historico.disciplina ");
		sqlStr.append(" inner JOIN pessoa AS \"aluno\" on aluno.codigo = matricula.aluno ");
		sqlStr.append(" LEFT JOIN periodoLetivo on historico.periodoLetivoMatrizCurricular = periodoLetivo.codigo ");
		sqlStr.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		sqlStr.append(" LEFT JOIN gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		sqlStr.append(" LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		sqlStr.append(" LEFT JOIN usuario on usuario.codigo = historico.responsavel ");

		sqlStr.append(" inner JOIN turno on matricula.turno = turno.codigo ");
		sqlStr.append(" inner JOIN unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeEnsino ");
		sqlStr.append(" inner JOIN curso on curso.codigo = matricula.curso ");

		sqlStr.append(" LEFT JOIN periodoLetivo as periodoLetivoMatrizCurricular on historico.periodoLetivoMatrizCurricular = periodoLetivoMatrizCurricular.codigo ");
		sqlStr.append(" LEFT JOIN periodoLetivo as periodoLetivoCursada on historico.periodoLetivoCursada = periodoLetivoCursada.codigo ");
		sqlStr.append(" inner JOIN gradeCurricular as matrizCurricular on matricula.gradecurricularatual = matrizCurricular.codigo ");
		sqlStr.append(" inner JOIN configuracaoAcademico on configuracaoAcademico.codigo = historico.configuracaoAcademico ");
		montarFiltroConsultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(sqlStr, unidadeEnsino, curso, disciplina, turmaVO, ano, semestre, trazerAlunoPendenteFinanceiramente, situacaoHistorico, verificarDisciplina, filtroVisaoProfessor, usuario.getPessoa().getCodigo(), controlarAcesso, configuracaoAcademicoVO, permitiVisualizarAlunoTR_CA, trazerDisciplinaComposta, usuario, permitirRealizarLancamentoAlunosPreMatriculados, considerarProfessorExclusivo);

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("qtde");
		} else {
			return 0;
		}
	}

	public void montarFiltroConsultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(StringBuffer sqlStr, Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, Integer codigoProfessor, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados, boolean considerarProfessorExclusivo) {
		if(!Uteis.isAtributoPreenchido(turmaVO)) {
			sqlStr.append(" WHERE 1 = 1 ");
		}else if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			sqlStr.append(" WHERE ");
			sqlStr.append(" ((MatriculaPeriodoTurmaDisciplina.turma in (select turma from turmaAgrupada where turmaOrigem =  ").append(turmaVO.getCodigo()).append(") )");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaPratica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'PRATICA'))");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaTeorica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'TEORICA'))");
			sqlStr.append(") ");
		} else {
			if (!trazerDisciplinaComposta) {
				sqlStr.append(" WHERE (Turma.codigo = ").append(turmaVO.getCodigo()).append(") ");
			} else {
				sqlStr.append(" WHERE historico.historicodisciplinacomposta = true ");
			}
		}
		if (Uteis.isAtributoPreenchido(turmaVO) && !turmaVO.getSubturma() && !turmaVO.getTurmaAgrupada() && !trazerDisciplinaComposta) {
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
		}
		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		if (unidadeEnsino != null && !unidadeEnsino.equals(0)) {
			sqlStr.append(" and unidadeensino.codigo = ");
			sqlStr.append(unidadeEnsino);
		}
		if (curso != null && !curso.equals(0)) {
			sqlStr.append(" and curso.codigo = ");
			sqlStr.append(curso);
		}
		if (verificarDisciplina) {
			if (disciplina != null && !disciplina.equals(0)) {
				sqlStr.append(" and (historico.disciplina = ").append(disciplina);
				if(Uteis.isAtributoPreenchido(turmaVO) && turmaVO.getTurmaAgrupada()){
					sqlStr.append(" or historico.disciplina in(select distinct disciplinaEquivalenteTurmaAgrupada from turmadisciplina where turmadisciplina.turma = ");
					sqlStr.append(turmaVO.getCodigo()).append(" and turmadisciplina.disciplina = ").append(disciplina).append(") ");
					sqlStr.append(" or historico.disciplina in (select disciplina from disciplinaequivalente where equivalente = ").append(disciplina).append(") ");
					sqlStr.append(" or historico.disciplina in (select equivalente from disciplinaequivalente where disciplina = ").append(disciplina).append(") ");
				}
				sqlStr.append(") ");
			}
		} else {
			sqlStr.append(" and (historico.disciplina = ").append(disciplina);
			if(Uteis.isAtributoPreenchido(turmaVO) && turmaVO.getTurmaAgrupada()){
				sqlStr.append(" or historico.disciplina in(select distinct disciplinaEquivalenteTurmaAgrupada from turmadisciplina where turmadisciplina.turma = ");
				sqlStr.append(turmaVO.getCodigo()).append(" and turmadisciplina.disciplina = ").append(disciplina).append(") ");
				sqlStr.append(" or historico.disciplina in (select disciplina from disciplinaequivalente where equivalente = ").append(disciplina).append(") ");
				sqlStr.append(" or historico.disciplina in (select equivalente from disciplinaequivalente where disciplina = ").append(disciplina).append(") ");
			}
			sqlStr.append(") ");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.ano = '").append(ano).append("' ");
		}
		if (!trazerAlunoPendenteFinanceiramente) {
			sqlStr.append(" and matriculaPeriodo.situacao <> 'PF' ");
		}
		if (!permitiVisualizarAlunoTR_CA) {
			sqlStr.append(" and matricula.situacao <> 'CA' ");
			sqlStr.append(" and matricula.situacao <> 'TR' ");
		}

		if (!situacaoHistorico.equals("")) {
			sqlStr.append(" and historico.situacao not in (").append(situacaoHistorico).append(") ");
		}
		// sqlStr.append(" and historico.situacao not in ('TR', 'AA', 'CH', 'CC', 'IS') ");
		if (filtroVisaoProfessor && !considerarProfessorExclusivo) {
			if(Uteis.isAtributoPreenchido(codigoProfessor)) {
				sqlStr.append(Historico.getWhereAlunoCursaDisciplinaTurmaProfessor(codigoProfessor, "historico", "matriculaPeriodoTurmaDisciplina", trazerDisciplinaComposta));
			}
		}

		if (Uteis.isAtributoPreenchido(usuario) && (usuario.getIsApresentarVisaoCoordenador() || usuario.getIsApresentarVisaoProfessor())){
			sqlStr.append(" and matriculaperiodo.situacaoMatriculaPeriodo not in('PC'");
			if (!permitirRealizarLancamentoAlunosPreMatriculados) {
				sqlStr.append(",'PR'");
			}
			sqlStr.append(")");
		}

		if (configuracaoAcademicoVO != null && !configuracaoAcademicoVO.getCodigo().equals(0)) {
			sqlStr.append(" and historico.configuracaoAcademico = ").append(configuracaoAcademicoVO.getCodigo());
		}


		// Garante que só será alterado o histórico atual do aluno
		// sqlStr.append(" and matricula.gradecurricularatual = historico.matrizcurricular ");
		// Garante que o histórico cursado por equivalencia não seja alterado
		// diretamente, pois a nota deve ser lançado no histórico equivalente
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		// Garante que o histórico de disciplina composta não seja alterado
		// diretamente, pois a nota deve ser lançado no histórico de uma
		// disciplina que faz parte da composicao
		if (!trazerDisciplinaComposta) {
			sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		}
		//System.out.println(sqlStr.toString());
	}

	public Integer consultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaTotalRegistro(String nomeAluno, Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, int nivelMontarDados, Integer limite, Integer offSet, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		if(trazerDisciplinaComposta){
			if(!getFacadeFactory().getTurmaDisciplinaFacade().consultarDisciplinaCompostaTurmaDisciplina(turmaVO.getCodigo(), disciplina)){
				trazerDisciplinaComposta = false;
			}
		}
		StringBuffer sqlStr = new StringBuffer();
		sqlStr.append("select count(distinct historico.matricula) AS qtde  ");
		sqlStr.append(" FROM historico AS historico ");

		sqlStr.append(" INNER JOIN matricula on matricula.matricula = historico.matricula ");
		sqlStr.append(" INNER JOIN matriculaPeriodo on matriculaPeriodo.matricula = matricula.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		if (Uteis.isAtributoPreenchido(turmaVO)) {
			sqlStr.append(" INNER JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
			if (turmaVO.getSubturma() && !trazerDisciplinaComposta) {
				if (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.TEORICA)) {
					sqlStr.append("INNER JOIN Turma ON turma.codigo = MatriculaPeriodoTurmaDisciplina.turmaTeorica ");
				} else if (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.PRATICA)) {
					sqlStr.append("INNER JOIN Turma ON turma.codigo = MatriculaPeriodoTurmaDisciplina.turmaPratica ");
				} else {
					sqlStr.append("INNER JOIN Turma ON MatriculaPeriodoTurmaDisciplina.turma = turma.codigo and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
				}
			} else {
				sqlStr.append("INNER JOIN Turma ON turma.codigo = matriculaPeriodoTurmaDisciplina.turma ");
				if (!turmaVO.getTurmaAgrupada() && !trazerDisciplinaComposta) {
					sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
				}
			}
		} else {
			sqlStr.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
			sqlStr.append("INNER JOIN Turma ON turma.codigo = case when matriculaPeriodoTurmaDisciplina.turma is not null then matriculaPeriodoTurmaDisciplina.turma else matriculaPeriodo.turma end ");
		}
		sqlStr.append(" LEFT JOIN gradeCurricular on historico.matrizCurricular = gradeCurricular.codigo ");
		sqlStr.append(" LEFT JOIN disciplina on disciplina.codigo = historico.disciplina ");
		sqlStr.append(" LEFT JOIN pessoa AS \"aluno\" on aluno.codigo = matricula.aluno ");
		sqlStr.append(" LEFT JOIN periodoLetivo on historico.periodoLetivoMatrizCurricular = periodoLetivo.codigo ");
		sqlStr.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		sqlStr.append(" LEFT JOIN gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		sqlStr.append(" LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		sqlStr.append(" LEFT JOIN usuario on usuario.codigo = historico.responsavel ");

		sqlStr.append(" LEFT JOIN turno on matricula.turno = turno.codigo ");
		sqlStr.append(" LEFT JOIN unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeEnsino ");
		sqlStr.append(" LEFT JOIN curso on curso.codigo = matricula.curso ");

		sqlStr.append(" LEFT JOIN periodoLetivo as periodoLetivoMatrizCurricular on historico.periodoLetivoMatrizCurricular = periodoLetivoMatrizCurricular.codigo ");
		sqlStr.append(" LEFT JOIN periodoLetivo as periodoLetivoCursada on historico.periodoLetivoCursada = periodoLetivoCursada.codigo ");
		sqlStr.append(" LEFT JOIN gradeCurricular as matrizCurricular on matricula.gradecurricularatual = matrizCurricular.codigo ");
		sqlStr.append(" LEFT JOIN configuracaoAcademico on configuracaoAcademico.codigo = historico.configuracaoAcademico ");
		montarFiltrosConsultarRegistroNota(sqlStr, nomeAluno, unidadeEnsino, curso, disciplina, turmaVO, ano, semestre, trazerAlunoPendenteFinanceiramente, situacaoHistorico, verificarDisciplina, filtroVisaoProfessor, configuracaoAcademicoVO, permitiVisualizarAlunoTR_CA, trazerDisciplinaComposta, usuario, permitirRealizarLancamentoAlunosPreMatriculados);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), nomeAluno + PERCENT);
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("qtde");
		} else {
			return 0;
		}
	}

	public List<HistoricoVO> consultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaNomeAluno(String nomeAluno, Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, int nivelMontarDados, Integer limite, Integer offSet, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados, DataModelo dataModelo) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		if(trazerDisciplinaComposta){
			if(!getFacadeFactory().getTurmaDisciplinaFacade().consultarDisciplinaCompostaTurmaDisciplina(turmaVO.getCodigo(), disciplina)){
				trazerDisciplinaComposta = false;
			}
		}
		StringBuffer sqlStr = getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica(turmaVO, disciplina, trazerDisciplinaComposta);
		montarFiltrosConsultarRegistroNota(sqlStr, nomeAluno, unidadeEnsino, curso, disciplina, turmaVO, ano, semestre, trazerAlunoPendenteFinanceiramente, situacaoHistorico, verificarDisciplina, filtroVisaoProfessor, configuracaoAcademicoVO, permitiVisualizarAlunoTR_CA, trazerDisciplinaComposta, usuario, permitirRealizarLancamentoAlunosPreMatriculados);
		SqlRowSet tabelaResultado = null;
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			StringBuffer sql = new StringBuffer();
			sql.append("select count(*) over() as qtde_total_registros, t.* from ");
			sql.append("(").append(sqlStr).append(") as t ");
			sql.append(" where  (exists (").append(sqlStr).append(" and historico.disciplina = t.\"disciplina.codigo\" and historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1) ") ;
			sql.append(" or not exists (").append(sqlStr).append(" and historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1)) ") ;
			sql.append(" order by  t.nomeSemAcento ");
			if (limite != null) {
				sql.append(" LIMIT ").append(limite);
				if (offSet != null) {
					sql.append(" OFFSET ").append(offSet);
				}
			}
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), nomeAluno + PERCENT, nomeAluno + PERCENT, nomeAluno + PERCENT);
		}else {
			StringBuilder sql = new StringBuilder();
			sql.append("select count(*) over() as qtde_total_registros, t.* from ( ");
			sql.append(sqlStr);
			sql.append(" ) as t ORDER BY nomeSemAcento");
			if (limite != null) {
				sql.append(" LIMIT ").append(limite);
				if (offSet != null) {
					sql.append(" OFFSET ").append(offSet);
				}
			}
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), nomeAluno + PERCENT);
		}
		dataModelo.setTotalRegistrosEncontrados(0);
		if (tabelaResultado.next()) {
			dataModelo.setTotalRegistrosEncontrados(tabelaResultado.getInt("qtde_total_registros"));
		}
		tabelaResultado.beforeFirst();
		List<HistoricoVO> historicoVOs = montarDadosConsultaCompleta(tabelaResultado, usuario);
		Ordenacao.ordenarLista(historicoVOs, "ordenacao");
		return historicoVOs;
	}

	public void montarFiltrosConsultarRegistroNota(StringBuffer sqlStr, String nomeAluno, Integer unidadeEnsino, Integer curso, Integer disciplina, TurmaVO turmaVO, String ano, String semestre, Boolean trazerAlunoPendenteFinanceiramente, String situacaoHistorico, boolean verificarDisciplina, boolean filtroVisaoProfessor, ConfiguracaoAcademicoVO configuracaoAcademicoVO, Boolean permitiVisualizarAlunoTR_CA, Boolean trazerDisciplinaComposta, UsuarioVO usuario, boolean permitirRealizarLancamentoAlunosPreMatriculados) {
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			sqlStr.append(" WHERE ");
			sqlStr.append(" ((MatriculaPeriodoTurmaDisciplina.turma in (select turma from turmaAgrupada where turmaOrigem =  ").append(turmaVO.getCodigo()).append(") )");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaPratica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'PRATICA'))");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaTeorica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'TEORICA'))");
			sqlStr.append(") ");
		} else {
			if(!trazerDisciplinaComposta) {
				sqlStr.append(" WHERE (Turma.codigo = ").append(turmaVO.getCodigo()).append(") ");
			} else {
				sqlStr.append(" WHERE historico.historicodisciplinacomposta = true ");
			}
		}
		if (!turmaVO.getSubturma() && !turmaVO.getTurmaAgrupada() && !trazerDisciplinaComposta) {
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.turma = turma.codigo ");
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.disciplina = disciplina.codigo ");
		}
		sqlStr.append(" AND sem_acentos(aluno.nome) ilike sem_acentos(?) ");
		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		if (unidadeEnsino != null && !unidadeEnsino.equals(0)) {
			sqlStr.append(" and unidadeensino.codigo = ");
			sqlStr.append(unidadeEnsino);
		}
		if (verificarDisciplina) {
			if (disciplina != null && !disciplina.equals(0)) {
				sqlStr.append(" and (historico.disciplina = ").append(disciplina);
				if(turmaVO.getTurmaAgrupada()){
					sqlStr.append(" or historico.disciplina in(select distinct disciplinaEquivalenteTurmaAgrupada from turmadisciplina where turmadisciplina.turma = ");
					sqlStr.append(turmaVO.getCodigo()).append(" and turmadisciplina.disciplina = ").append(disciplina).append(") ");
					sqlStr.append(" or historico.disciplina in(select disciplina from disciplinaequivalente where equivalente = ").append(disciplina).append(")");
					sqlStr.append(" or historico.disciplina in(select equivalente from disciplinaequivalente where disciplina = ").append(disciplina).append(")");
				}
				sqlStr.append(") ");
			}
		} else {
			sqlStr.append(" and (historico.disciplina = ").append(disciplina);
			if(turmaVO.getTurmaAgrupada()){
				sqlStr.append(" or historico.disciplina in(select distinct disciplinaEquivalenteTurmaAgrupada from turmadisciplina where turmadisciplina.turma = ");
				sqlStr.append(turmaVO.getCodigo()).append(" and turmadisciplina.disciplina = ").append(disciplina).append(") ");
				sqlStr.append(" or historico.disciplina in(select disciplina from disciplinaequivalente where equivalente = ").append(disciplina).append(")");
				sqlStr.append(" or historico.disciplina in(select equivalente from disciplinaequivalente where disciplina = ").append(disciplina).append(")");
			}
			sqlStr.append(") ");
		}
		if (!semestre.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.ano = '").append(ano).append("' ");
		}
		if (!trazerAlunoPendenteFinanceiramente) {
			sqlStr.append(" and matriculaPeriodo.situacao <> 'PF' ");
		}
		if (!permitiVisualizarAlunoTR_CA) {
			sqlStr.append(" and matricula.situacao <> 'CA' ");
			sqlStr.append(" and matricula.situacao <> 'TR' ");
		}

		if (!situacaoHistorico.equals("")) {
			sqlStr.append(" and historico.situacao not in (").append(situacaoHistorico).append(") ");
		}
		// sqlStr.append(" and historico.situacao not in ('TR', 'AA', 'CH', 'CC', 'IS') ");
		if (filtroVisaoProfessor) {
			sqlStr.append(Historico.getWhereAlunoCursaDisciplinaTurmaProfessor(usuario.getPessoa().getCodigo(), "historico", "matriculaPeriodoTurmaDisciplina", trazerDisciplinaComposta));
		}
		if (usuario.getIsApresentarVisaoCoordenador() || usuario.getIsApresentarVisaoProfessor()){
			sqlStr.append(" and matriculaperiodo.situacaoMatriculaPeriodo not in('PC'");
			if (!permitirRealizarLancamentoAlunosPreMatriculados) {
				sqlStr.append(",'PR'");
			}
			sqlStr.append(")");
		}
		if (configuracaoAcademicoVO != null && !configuracaoAcademicoVO.getCodigo().equals(0)) {
			sqlStr.append(" and historico.configuracaoAcademico = ").append(configuracaoAcademicoVO.getCodigo());
		}


		// Garante que só será alterado o histórico atual do aluno
		// sqlStr.append(" and matricula.gradecurricularatual = historico.matrizcurricular ");
		// Garante que o histórico cursado por equivalencia não seja alterado
		// diretamente, pois a nota deve ser lançado no histórico equivalente
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		// Garante que o histórico de disciplina composta não seja alterado
		// diretamente, pois a nota deve ser lançado no histórico de uma
		// disciplina que faz parte da composicao
		if (!trazerDisciplinaComposta) {
			sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		}
	}

	private StringBuffer getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica(TurmaVO turmaVO, Integer disciplina, boolean trazerDisciplinaComposta) {
		// AO ADICIONAR CAMPOS NESTE SQL ADICIONAR NOS METODOS: 
				// getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica, 
				// consultaRapidaPorTurmaUnidadeEnsinoCursoDisciplinaAnoSemestreDataHistoricoOrdenarDisciplina
				// getSQLPadraoConsultaCompleta
		if(trazerDisciplinaComposta){
			if (Uteis.isAtributoPreenchido(turmaVO)) {
				if(!getFacadeFactory().getTurmaDisciplinaFacade().consultarDisciplinaCompostaTurmaDisciplina(turmaVO.getCodigo(), disciplina)){
					trazerDisciplinaComposta = false;
				}
			}
		}
		StringBuffer str = new StringBuffer();
		// Dados do Historico
		str.append("SELECT distinct historico.codigo, historico.anoHistorico, historico.semestreHistorico, historico.tipoHistorico, historico.instituicao, historico.situacao, historico.freguencia, historico.frequenciaTeorica, historico.frequenciaPratica, historico.dataRegistro, historico.cidade, historico.cargaHorariaAproveitamentoDisciplina, historico.cargahorariacursada, historico.cargaHorariaDisciplina, ");
		str.append("historico.utilizaNotaFinalConceito, historico.notaFinalConceito, historico.historicoCriterioAvaliacaoAluno, historico.criterioAvaliacao, historico.creditodisciplina,  ");
		str.append(" historico.apresentarAprovadoHistorico, historico.isentarMediaFinal, historico.numeroAgrupamentoEquivalenciaDisciplina, ");

		str.append("historico.mediaFinal, historico.transferenciaEntradaDisciplinasAproveitadas, historico.disciplinasAproveitadas, historico.mediaFinalConceito, ");
		for(int x = 1; x<=40;x++) {
			str.append(" historico.nota").append(x).append(", ");
			str.append(" historico.nota").append(x).append("lancada, ");
			str.append(" historico.nota").append(x).append("conceito, ");
		}	
		str.append("historico.updated, anohistorico, semestrehistorico, historico.isentarMediaFinal, historico.notaFinalConceito as \"historico.notaFinalConceito\", ");

		str.append("historico.observacao AS \"historico.observacao\", historico.historicoDisciplinaAtividadeComplementar AS \"historico.historicoDisciplinaAtividadeComplementar\", ");
		str.append("historico.cargaHorariaDisciplina AS \"historico.cargaHorariaDisciplina\", historico.creditoDisciplina AS \"historico.creditoDisciplina\", ");
		str.append("historico.historicoDisciplinaOptativa AS \"historico.historicoDisciplinaOptativa\", historico.historicoDisciplinaForaGrade AS \"historico.historicoDisciplinaForaGrade\", ");
		str.append("historico.nomeDisciplina AS \"historico.nomeDisciplina\", historico.historicoDisciplinaAproveitada AS \"historico.historicoDisciplinaAproveitada\", ");
		str.append("historico.faltaPrimeiroBimestre AS \"historico.faltaPrimeiroBimestre\", historico.faltaSegundoBimestre AS \"historico.faltaSegundoBimestre\", ");
		str.append("historico.faltaTerceiroBimestre AS \"historico.faltaTerceiroBimestre\", historico.faltaQuartoBimestre AS \"historico.faltaQuartoBimestre\", ");
		str.append("historico.totalFalta AS \"historico.totalFalta\", ");
		str.append("historico.utilizaNotaFinalConceito AS \"historico.utilizaNotaFinalConceito\", ");

		str.append("historico.transferenciaMatrizCurricularMatricula AS \"historico.transferenciaMatrizCurricularMatricula\",  ");
		str.append("historico.historicoGeradoAPartirTransferenciaMatrizCurricular AS \"historico.historicoGeradoAPartirTransferenciaMatrizCurricular\",  ");
		str.append("historico.observacaoTransferenciaMatrizCurricular AS \"historico.observacaoTransferenciaMatrizCurricular\",  ");
		str.append("historico.historicoCursandoPorCorrespondenciaAposTransferencia AS \"historico.historicoCursandoPorCorrespondenciaAposTransferencia\",  historico.dataInicioAula as \"historico.dataInicioAula\", historico.dataFimAula as \"historico.dataFimAula\", ");
		// Dados da Matriz Curricular do Historico
		str.append("gradeCurricular.codigo AS \"gradeCurricular.codigo\", ");
		str.append("gradeCurricular.nome AS \"gradeCurricular.nome\", ");

		// Dados do Periodo Letivo Matriz Curricular
		str.append("periodoLetivoMatrizCurricular.codigo AS \"periodoLetivoMatrizCurricular.codigo\", ");
		str.append("periodoLetivoMatrizCurricular.descricao AS \"periodoLetivoMatrizCurricular.descricao\", ");
		str.append("periodoLetivoMatrizCurricular.periodoLetivo AS \"periodoLetivoMatrizCurricular.periodoLetivo\", ");

		// Dados da Matriz Curricular
		str.append("matrizCurricular.codigo AS \"matrizCurricular.codigo\", ");
		str.append("matrizCurricular.nome AS \"matrizCurricular.nome\", ");

		// Dados do Periodo Letivo Cursada
		str.append("periodoLetivoCursada.codigo AS \"periodoLetivoCursada.codigo\", ");
		str.append("periodoLetivoCursada.descricao AS \"periodoLetivoCursada.descricao\", ");
		str.append("periodoLetivoCursada.periodoLetivo AS \"periodoLetivoCursada.periodoLetivo\", ");

		// Dados do Configuracao Academico
		str.append(" configuracaoAcademico.codigo AS \"configuracaoAcademico.codigo\",  ");
		str.append(" configuracaoAcademico.nome AS \"configuracaoAcademico.nome\",  ");
		str.append(" configuracaoAcademico.intervaloNotasDiferente AS \"configuracaoAcademico.intervaloNotasDiferente\",  ");

		// Dados do Matricula Periodo Turma Disciplina
		str.append(" matriculaPeriodoTurmaDisciplina.codigo AS \"matriculaPeriodoTurmaDisciplina.codigo\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Semestre
		str.append(" matriculaPeriodoTurmaDisciplina.semestre AS \"matriculaPeriodoTurmaDisciplina.semestre\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Ano
		str.append(" matriculaPeriodoTurmaDisciplina.ano AS \"matriculaPeriodoTurmaDisciplina.ano\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turma AS \"matriculaPeriodoTurmaDisciplina.turma\", matriculaPeriodoTurmaDisciplina.turmaTeorica, matriculaPeriodoTurmaDisciplina.turmaPratica, ");
		// Dados do Turma
		str.append(" turma.codigo AS \"turma.codigo\",  ");
		str.append(" turma.identificadorTurma AS \"turma.identificadorTurma\",  ");
		// Dados do Turno
		str.append(" turno.nome AS \"turno.nome\",  ");
		// Dados da Grade Curricular
		str.append(" gradeCurricular.nome AS \"gradeCurricular.nome\", ");
		// Dados do Matricula Periodo
		str.append(" matriculaPeriodo.codigo AS \"matriculaPeriodo.codigo\", matriculaPeriodo.situacao AS \"matriculaPeriodo.situacao\", matriculaperiodo.situacaoMatriculaPeriodo as \"matriculaperiodo.situacaoMatriculaPeriodo\", matriculaperiodo.datafechamentomatriculaperiodo as \"matriculaperiodo.datafechamentomatriculaperiodo\", matriculaperiodo.data as \"matriculaperiodo.data\", ");
		// Dados do Periodo Letivo
		str.append(" periodoLetivo.descricao AS \"periodoLetivo.descricao\",  ");
		// Dados da Matricula
		str.append(" matricula.matricula AS \"matricula.matricula\",  ");
		str.append(" matricula.updated AS \"matricula.updated\",  ");
		str.append(" matricula.situacao AS \"matricula.situacao\",  ");
		str.append(" matricula.tipoMatricula AS \"matricula.tipoMatricula\",  ");
		str.append(" matricula.situacaoFinanceira AS \"matricula.situacaoFinanceira\", matricula.canceladoFinanceiro, ");
		str.append(" matricula.gradecurricularatual AS \"matricula.gradecurricularatual\",  ");
		// Dados do Curso
		str.append(" curso.codigo AS \"curso.codigo\", curso.nome AS \"curso.nome\", ");
		// Dados da Unidade Ensino
		str.append(" unidadeEnsino.codigo AS \"unidadeEnsino.codigo\", unidadeEnsino.nome AS \"unidadeEnsino.nome\", ");
		// Dados do Aluno
		str.append(" aluno.codigo AS \"aluno.codigo\", aluno.nome AS \"aluno.nome\", sem_acentos(aluno.nome) as nomeSemAcento, ");
		// Dados do Usuario
		str.append(" usuario.nome AS \"responsavel.nome\", usuario.codigo AS \"responsavel.codigo\", ");
		// Dados da Disciplina
		str.append(" disciplina.codigo AS \"disciplina.codigo\", disciplina.nome AS \"disciplina.nome\", ");

		// DISCIPLINA COMPOSTA E EQUIVALENCIA
		str.append(" historico.historicoPorEquivalencia AS \"historico.historicoPorEquivalencia\", historico.historicoEquivalente AS \"historico.historicoEquivalente\", ");
		str.append(" historico.gradeDisciplinaComposta AS \"historico.gradeDisciplinaComposta\", ");
		str.append(" gradeDisciplinaComposta.variavelNota AS \"gradeDisciplinaComposta.variavelNota\", ");
		str.append(" gradeDisciplinaComposta.ordem AS \"gradeDisciplinaComposta.ordem\", ");
		str.append(" gradeDisciplinaComposta.horaaula AS \"gradeDisciplinaComposta.horaaula\", ");
		str.append(" gradeDisciplinaComposta.cargahoraria AS \"gradeDisciplinaComposta.cargahoraria\", ");
		str.append(" gradeDisciplinaComposta.nrcreditos AS \"gradeDisciplinaComposta.nrcreditos\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaPratica AS \"gradeDisciplinaComposta.cargahorariaPratica\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaTeorica AS \"gradeDisciplinaComposta.cargahorariaTeorica\", ");
		str.append(" historico.historicoDisciplinaComposta AS \"historico.historicoDisciplinaComposta\", historico.historicoDisciplinaFazParteComposicao, ");
		str.append(" historico.mapaEquivalenciaDisciplina AS \"historico.mapaEquivalenciaDisciplina\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaCursada AS \"historico.mapaEquivalenciaDisciplinaCursada\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaMatrizCurricular AS \"historico.mapaEquivalenciaDisciplinaMatrizCurricular\", ");

		// Dados da Grade Disciplina
		str.append(" gradedisciplina.codigo AS \"gradedisciplina.codigo\", ");
		str.append(" gradedisciplina.disciplina AS \"gradedisciplina.disciplina\", ");
		str.append(" gradedisciplina.cargaHoraria AS \"gradedisciplina.cargaHoraria\", ");
		str.append(" gradedisciplina.cargaHorariapratica AS \"gradedisciplina.cargaHorariapratica\", ");
		str.append(" gradedisciplina.nrCreditos AS \"gradedisciplina.nrCreditos\", ");
		str.append(" gradedisciplina.diversificada AS \"gradedisciplina.diversificada\", ");
		str.append(" gradedisciplina.disciplinaComposta AS \"gradedisciplina.disciplinaComposta\", ");
		str.append(" gradedisciplina.disciplinaEixoTematico AS \"gradedisciplina.disciplinaEixoTematico\", ");
		str.append(" gradedisciplina.formulaCalculoNota AS \"gradedisciplina.formulaCalculoNota\", ");
		str.append(" gradedisciplina.formulaCalculo AS \"gradedisciplina.formulaCalculo\", ");
		str.append(" gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradedisciplina.variavelNotaRecuperacao AS \"gradedisciplina.variavelNotaRecuperacao\", ");
		str.append(" gradedisciplina.condicaoUsoRecuperacao AS \"gradedisciplina.condicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gradedisciplina.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperada AS \"gradedisciplina.formulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperacao AS \"gradedisciplina.formulaCalculoNotaRecuperacao\", ");
		str.append(" gradedisciplina.horaaula AS \"gradedisciplina.horaaula\", ");

		// Dados da Grade Curricular Grupo Optativa Disciplina
		// (GradeCurricularGrupoOptativaDisciplina)
		str.append(" historico.gradeCurricularGrupoOptativaDisciplina AS \"historico.gradeCurricularGrupoOptativaDisciplina\",  ");
		str.append(" historico.disciplinaReferenteAUmGrupoOptativa AS \"historico.disciplinaReferenteAUmGrupoOptativa\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.codigo AS \"gradeCurricularGrupoOptativaDisciplina.codigo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplina AS \"gradeCurricularGrupoOptativaDisciplina.disciplina\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHoraria AS \"gradeCurricularGrupoOptativaDisciplina.cargaHoraria\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica AS \"gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.nrCreditos AS \"gradeCurricularGrupoOptativaDisciplina.nrCreditos\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.diversificada AS \"gradeCurricularGrupoOptativaDisciplina.diversificada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplinaComposta AS \"gradeCurricularGrupoOptativaDisciplina.disciplinaComposta\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculo AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gcgod.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaRecuperacao AS \"gcgod.variavelNotaRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.condicaoUsoRecuperacao AS \"gcgod.condicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gcgod.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperada AS \"gcgod.formulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gcgod.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperacao AS \"gcgod.formulaCalculoNotaRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.horaaula AS \"gcgod.horaaula\", ");
		str.append(" exists (select historiconota.codigo from historiconota where historiconota.historico = historico.codigo and historiconota.notarecuperacao and situacaorecuperacaonota = '").append(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO.name()).append("' limit 1) as emrecuperacao " );
		str.append(" FROM historico AS historico ");

		str.append(" INNER JOIN matricula on matricula.matricula = historico.matricula ");
		str.append(" INNER JOIN matriculaPeriodo on matriculaPeriodo.matricula = matricula.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		str.append(" and matriculaperiodo.codigo in(");
		str.append(" select mp.codigo from matriculaperiodo mp where mp.matricula = matricula.matricula and mp.ano = matriculaperiodo.ano and mp.semestre = matriculaperiodo.semestre and mp.codigo = historico.matriculaPeriodo ");
		str.append(" order by codigo desc limit 1 ");
		str.append(" ) ");

		if(Uteis.isAtributoPreenchido(turmaVO)){
			str.append(" INNER JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
			if (turmaVO.getSubturma() && !trazerDisciplinaComposta) {
				if (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.TEORICA)) {
					str.append("INNER JOIN Turma ON turma.codigo = MatriculaPeriodoTurmaDisciplina.turmaTeorica ");
				} else if (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.PRATICA)) {
					str.append("INNER JOIN Turma ON turma.codigo = MatriculaPeriodoTurmaDisciplina.turmaPratica ");
				} else {
					str.append("INNER JOIN Turma ON MatriculaPeriodoTurmaDisciplina.turma = turma.codigo and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
				}
			} else {
				str.append("INNER JOIN Turma ON turma.codigo = matriculaPeriodoTurmaDisciplina.turma ");
				if (!turmaVO.getTurmaAgrupada() && !trazerDisciplinaComposta) {
					str.append(" and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
				}
			}
			if(trazerDisciplinaComposta) {
				str.append(" and (exists ( ");
				str.append(" select from historico his ");
				str.append(" inner join matriculaperiodoturmadisciplina mptd on mptd.codigo = his.matriculaperiodoturmadisciplina ");
				str.append(" inner join gradedisciplinacomposta gdc on gdc.codigo = his.gradedisciplinacomposta ");
				str.append(" where his.matricula = matricula.matricula ");
				str.append(" and his.matriculaperiodo = matriculaperiodo.codigo ");
				str.append(" and his.anohistorico = historico.anohistorico ");
				str.append(" and his.semestrehistorico = historico.semestrehistorico ");
				str.append(" and ((historico.gradedisciplina is not null and gdc.gradedisciplina = historico.gradedisciplina) ");
				str.append(" or (historico.gradecurriculargrupooptativadisciplina is not null and gdc.gradecurriculargrupooptativadisciplina = historico.gradecurriculargrupooptativadisciplina) ");
				str.append(" ) ");
				if (turmaVO.getSubturma() && turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.PRATICA)) {
					str.append(" and mptd.turmapratica = ").append(turmaVO.getCodigo());
				}else if (turmaVO.getSubturma() && turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.TEORICA)) {
						str.append(" and mptd.turmateorica = ").append(turmaVO.getCodigo());
				}else if (turmaVO.getSubturma() && turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.GERAL)) {
					str.append(" and mptd.turma= ").append(turmaVO.getCodigo());
				}else if (!turmaVO.getSubturma() && !turmaVO.getTurmaAgrupada()) {
					str.append(" and mptd.turma= ").append(turmaVO.getCodigo());
				}else if (!turmaVO.getSubturma() && turmaVO.getTurmaAgrupada()) {
					str.append(" and exists(select ta.codigo from turmaagrupada ta where ta.turma = mptd.turma and ta.turmaorigem =  ").append(turmaVO.getCodigo()).append(" ) ");
				}
				str.append(" )) ");
			}
		}else{
			str.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
			str.append("INNER JOIN Turma ON turma.codigo = case when matriculaPeriodoTurmaDisciplina.turma is not null then matriculaPeriodoTurmaDisciplina.turma else matriculaPeriodo.turma end ");
		}
		str.append(" LEFT JOIN gradeCurricular on historico.matrizCurricular = gradeCurricular.codigo ");
		str.append(" LEFT JOIN disciplina on disciplina.codigo = historico.disciplina ");
		str.append(" LEFT JOIN pessoa AS \"aluno\" on aluno.codigo = matricula.aluno ");
		str.append(" LEFT JOIN periodoLetivo on historico.periodoLetivoMatrizCurricular = periodoLetivo.codigo ");
		str.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		str.append(" LEFT JOIN gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		str.append(" LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		str.append(" LEFT JOIN usuario on usuario.codigo = historico.responsavel ");

		str.append(" LEFT JOIN turno on matricula.turno = turno.codigo ");
		str.append(" LEFT JOIN unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeEnsino ");
		str.append(" LEFT JOIN curso on curso.codigo = matricula.curso ");

		str.append(" LEFT JOIN periodoLetivo as periodoLetivoMatrizCurricular on historico.periodoLetivoMatrizCurricular = periodoLetivoMatrizCurricular.codigo ");
		str.append(" LEFT JOIN periodoLetivo as periodoLetivoCursada on historico.periodoLetivoCursada = periodoLetivoCursada.codigo ");
		str.append(" LEFT JOIN gradeCurricular as matrizCurricular on matricula.gradecurricularatual = matrizCurricular.codigo ");
		str.append(" LEFT JOIN configuracaoAcademico on configuracaoAcademico.codigo = historico.configuracaoAcademico ");

		return str;
	}

	private StringBuffer getSQLPadraoConsultaCompletaConsiderandoTurmaPadrao() {
		StringBuffer str = new StringBuffer();
		// Dados do Historico
		str.append("SELECT distinct historico.codigo, historico.anoHistorico, historico.semestreHistorico, historico.tipoHistorico, historico.instituicao, historico.situacao, historico.freguencia, historico.frequenciaTeorica, historico.frequenciaPratica, historico.dataRegistro, historico.cidade, historico.cargaHorariaAproveitamentoDisciplina, historico.cargahorariacursada, historico.cargaHorariaDisciplina, ");
		str.append("historico.utilizaNotaFinalConceito, historico.notaFinalConceito, historico.historicoCriterioAvaliacaoAluno, historico.criterioAvaliacao, historico.creditodisciplina, ");
		str.append(" historico.apresentarAprovadoHistorico, historico.numeroAgrupamentoEquivalenciaDisciplina, ");

		str.append("historico.mediaFinal, historico.transferenciaEntradaDisciplinasAproveitadas, historico.disciplinasAproveitadas, historico.mediaFinalConceito, ");
		for(int x = 1; x<=40;x++) {
			str.append(" historico.nota").append(x).append(", ");
			str.append(" historico.nota").append(x).append("lancada, ");
			str.append(" historico.nota").append(x).append("conceito, ");
		}
		str.append("historico.updated, anohistorico, semestrehistorico, historico.isentarMediaFinal, historico.notaFinalConceito as \"historico.notaFinalConceito\", ");

		str.append("historico.observacao AS \"historico.observacao\", historico.historicoDisciplinaAtividadeComplementar AS \"historico.historicoDisciplinaAtividadeComplementar\", ");
		str.append("historico.cargaHorariaDisciplina AS \"historico.cargaHorariaDisciplina\", historico.creditoDisciplina AS \"historico.creditoDisciplina\", ");
		str.append("historico.historicoDisciplinaOptativa AS \"historico.historicoDisciplinaOptativa\", historico.historicoDisciplinaForaGrade AS \"historico.historicoDisciplinaForaGrade\", ");
		str.append("historico.nomeDisciplina AS \"historico.nomeDisciplina\", historico.historicoDisciplinaAproveitada AS \"historico.historicoDisciplinaAproveitada\", ");
		str.append("historico.faltaPrimeiroBimestre AS \"historico.faltaPrimeiroBimestre\", historico.faltaSegundoBimestre AS \"historico.faltaSegundoBimestre\", ");
		str.append("historico.faltaTerceiroBimestre AS \"historico.faltaTerceiroBimestre\", historico.faltaQuartoBimestre AS \"historico.faltaQuartoBimestre\", ");
		str.append("historico.totalFalta AS \"historico.totalFalta\", ");
		str.append("historico.utilizaNotaFinalConceito AS \"historico.utilizaNotaFinalConceito\", ");

		str.append("historico.transferenciaMatrizCurricularMatricula AS \"historico.transferenciaMatrizCurricularMatricula\",  ");
		str.append("historico.historicoGeradoAPartirTransferenciaMatrizCurricular AS \"historico.historicoGeradoAPartirTransferenciaMatrizCurricular\",  ");
		str.append("historico.observacaoTransferenciaMatrizCurricular AS \"historico.observacaoTransferenciaMatrizCurricular\",  ");
		str.append("historico.historicoCursandoPorCorrespondenciaAposTransferencia AS \"historico.historicoCursandoPorCorrespondenciaAposTransferencia\", historico.dataInicioAula as \"historico.dataInicioAula\", historico.dataFimAula as \"historico.dataFimAula\",");
		// Dados da Matriz Curricular do Historico
		str.append("gradeCurricular.codigo AS \"gradeCurricular.codigo\", ");
		str.append("gradeCurricular.nome AS \"gradeCurricular.nome\", ");

		// Dados do Periodo Letivo Matriz Curricular
		str.append("periodoLetivoMatrizCurricular.codigo AS \"periodoLetivoMatrizCurricular.codigo\", ");
		str.append("periodoLetivoMatrizCurricular.descricao AS \"periodoLetivoMatrizCurricular.descricao\", ");
		str.append("periodoLetivoMatrizCurricular.periodoLetivo AS \"periodoLetivoMatrizCurricular.periodoLetivo\", ");

		// Dados da Matriz Curricular
		str.append("matrizCurricular.codigo AS \"matrizCurricular.codigo\", ");
		str.append("matrizCurricular.nome AS \"matrizCurricular.nome\", ");

		// Dados do Periodo Letivo Cursada
		str.append("periodoLetivoCursada.codigo AS \"periodoLetivoCursada.codigo\", ");
		str.append("periodoLetivoCursada.descricao AS \"periodoLetivoCursada.descricao\", ");
		str.append("periodoLetivoCursada.periodoLetivo AS \"periodoLetivoCursada.periodoLetivo\", ");

		// Dados do Configuracao Academico
		str.append(" configuracaoAcademico.codigo AS \"configuracaoAcademico.codigo\",  ");
		str.append(" configuracaoAcademico.nome AS \"configuracaoAcademico.nome\",  ");
		str.append(" configuracaoAcademico.intervaloNotasDiferente AS \"configuracaoAcademico.intervaloNotasDiferente\",  ");

		// Dados do Matricula Periodo Turma Disciplina
		str.append(" matriculaPeriodoTurmaDisciplina.codigo AS \"matriculaPeriodoTurmaDisciplina.codigo\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Semestre
		str.append(" matriculaPeriodoTurmaDisciplina.semestre AS \"matriculaPeriodoTurmaDisciplina.semestre\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Ano
		str.append(" matriculaPeriodoTurmaDisciplina.ano AS \"matriculaPeriodoTurmaDisciplina.ano\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turma AS \"matriculaPeriodoTurmaDisciplina.turma\", matriculaPeriodoTurmaDisciplina.turmaTeorica, matriculaPeriodoTurmaDisciplina.turmaPratica, ");
		// Dados do Turma
		str.append(" turma.codigo AS \"turma.codigo\",  ");
		str.append(" turma.identificadorTurma AS \"turma.identificadorTurma\",  ");
		// Dados do Turno
		str.append(" turno.nome AS \"turno.nome\",  ");
		// Dados da Grade Curricular
		str.append(" gradeCurricular.nome AS \"gradeCurricular.nome\", ");
		// Dados do Matricula Periodo
		str.append(" matriculaPeriodo.codigo AS \"matriculaPeriodo.codigo\", matriculaPeriodo.situacao AS \"matriculaPeriodo.situacao\", matriculaperiodo.situacaoMatriculaPeriodo as \"matriculaperiodo.situacaoMatriculaPeriodo\", matriculaperiodo.datafechamentomatriculaperiodo as \"matriculaperiodo.datafechamentomatriculaperiodo\", matriculaperiodo.data as \"matriculaperiodo.data\", ");
		// Dados do Periodo Letivo
		str.append(" periodoLetivo.descricao AS \"periodoLetivo.descricao\",  ");
		// Dados da Matricula
		str.append(" matricula.matricula AS \"matricula.matricula\",  ");
		str.append(" matricula.updated AS \"matricula.updated\",  ");
		str.append(" matricula.situacao AS \"matricula.situacao\",  ");
		str.append(" matricula.tipoMatricula AS \"matricula.tipoMatricula\",  ");
		str.append(" matricula.situacaoFinanceira AS \"matricula.situacaoFinanceira\", matricula.canceladoFinanceiro, ");
		str.append(" matricula.gradecurricularatual AS \"matricula.gradecurricularatual\",  ");
		// Dados do Curso
		str.append(" curso.codigo AS \"curso.codigo\", curso.nome AS \"curso.nome\", ");
		// Dados da Unidade Ensino
		str.append(" unidadeEnsino.codigo AS \"unidadeEnsino.codigo\", unidadeEnsino.nome AS \"unidadeEnsino.nome\", ");
		// Dados do Aluno
		str.append(" aluno.codigo AS \"aluno.codigo\", aluno.nome AS \"aluno.nome\", ");
		// Dados do Usuario
		str.append(" usuario.nome AS \"responsavel.nome\", usuario.codigo AS \"responsavel.codigo\", ");
		// Dados da Disciplina
		str.append(" disciplina.codigo AS \"disciplina.codigo\", disciplina.nome AS \"disciplina.nome\", ");

		// DISCIPLINA COMPOSTA E EQUIVALENCIA
		str.append(" historico.historicoPorEquivalencia AS \"historico.historicoPorEquivalencia\", historico.historicoEquivalente AS \"historico.historicoEquivalente\", ");
		str.append(" historico.gradeDisciplinaComposta AS \"historico.gradeDisciplinaComposta\", ");
		str.append(" gradeDisciplinaComposta.variavelNota AS \"gradeDisciplinaComposta.variavelNota\", ");
		str.append(" gradeDisciplinaComposta.ordem AS \"gradeDisciplinaComposta.ordem\", ");
		str.append(" gradeDisciplinaComposta.cargahoraria AS \"gradeDisciplinaComposta.cargahoraria\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaPratica AS \"gradeDisciplinaComposta.cargahorariaPratica\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaTeorica AS \"gradeDisciplinaComposta.cargahorariaTeorica\", ");
		str.append(" gradeDisciplinaComposta.nrcreditos AS \"gradeDisciplinaComposta.nrcreditos\", ");
		str.append(" gradeDisciplinaComposta.horaaula AS \"gradeDisciplinaComposta.horaaula\", ");
		str.append(" historico.historicoDisciplinaComposta AS \"historico.historicoDisciplinaComposta\", historico.historicoDisciplinaFazParteComposicao, ");
		str.append(" historico.mapaEquivalenciaDisciplina AS \"historico.mapaEquivalenciaDisciplina\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaCursada AS \"historico.mapaEquivalenciaDisciplinaCursada\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaMatrizCurricular AS \"historico.mapaEquivalenciaDisciplinaMatrizCurricular\", ");

		// Dados da Grade Disciplina
		str.append(" gradedisciplina.codigo AS \"gradedisciplina.codigo\", ");
		str.append(" gradedisciplina.disciplina AS \"gradedisciplina.disciplina\", ");
		str.append(" gradedisciplina.cargaHoraria AS \"gradedisciplina.cargaHoraria\", ");
		str.append(" gradedisciplina.cargaHorariapratica AS \"gradedisciplina.cargaHorariapratica\", ");
		str.append(" gradedisciplina.nrCreditos AS \"gradedisciplina.nrCreditos\", ");
		str.append(" gradedisciplina.diversificada AS \"gradedisciplina.diversificada\", ");
		str.append(" gradedisciplina.disciplinaComposta AS \"gradedisciplina.disciplinaComposta\", ");
		str.append(" gradedisciplina.disciplinaEixoTematico AS \"gradedisciplina.disciplinaEixoTematico\", ");
		str.append(" gradedisciplina.formulaCalculoNota AS \"gradedisciplina.formulaCalculoNota\", ");
		str.append(" gradedisciplina.formulaCalculo AS \"gradedisciplina.formulaCalculo\", ");
		str.append(" gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradedisciplina.variavelNotaRecuperacao AS \"gradedisciplina.variavelNotaRecuperacao\", ");
		str.append(" gradedisciplina.condicaoUsoRecuperacao AS \"gradedisciplina.condicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gradedisciplina.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperada AS \"gradedisciplina.formulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperacao AS \"gradedisciplina.formulaCalculoNotaRecuperacao\", ");
		str.append(" gradedisciplina.horaaula AS \"gradedisciplina.horaaula\", ");

		// Dados da Grade Curricular Grupo Optativa Disciplina
		// (GradeCurricularGrupoOptativaDisciplina)
		str.append(" historico.gradeCurricularGrupoOptativaDisciplina AS \"historico.gradeCurricularGrupoOptativaDisciplina\",  ");
		str.append(" historico.disciplinaReferenteAUmGrupoOptativa AS \"historico.disciplinaReferenteAUmGrupoOptativa\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.codigo AS \"gradeCurricularGrupoOptativaDisciplina.codigo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplina AS \"gradeCurricularGrupoOptativaDisciplina.disciplina\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHoraria AS \"gradeCurricularGrupoOptativaDisciplina.cargaHoraria\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica AS \"gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.nrCreditos AS \"gradeCurricularGrupoOptativaDisciplina.nrCreditos\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.diversificada AS \"gradeCurricularGrupoOptativaDisciplina.diversificada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplinaComposta AS \"gradeCurricularGrupoOptativaDisciplina.disciplinaComposta\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculo AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gcgod.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaRecuperacao AS \"gcgod.variavelNotaRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.condicaoUsoRecuperacao AS \"gcgod.condicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gcgod.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperada AS \"gcgod.formulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gcgod.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.horaaula AS \"gcgod.horaaula\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperacao AS \"gcgod.formulaCalculoNotaRecuperacao\", ");
		str.append(" exists (select historiconota.codigo from historiconota where historiconota.historico = historico.codigo and historiconota.notarecuperacao and situacaorecuperacaonota = '").append(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO.name()).append("' limit 1) as emrecuperacao" );
		str.append(" FROM historico AS historico ");

		str.append(" INNER JOIN matricula on matricula.matricula = historico.matricula ");
		str.append(" INNER JOIN matriculaPeriodo on matriculaPeriodo.matricula = matricula.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		str.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		str.append(" INNER JOIN Turma ON turma.codigo = matriculaPeriodo.turma ");
		str.append(" LEFT JOIN gradeCurricular on historico.matrizCurricular = gradeCurricular.codigo ");
		str.append(" LEFT JOIN disciplina on disciplina.codigo = historico.disciplina ");
		str.append(" LEFT JOIN pessoa AS \"aluno\" on aluno.codigo = matricula.aluno ");
		str.append(" LEFT JOIN periodoLetivo on historico.periodoLetivoMatrizCurricular = periodoLetivo.codigo ");
		str.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		str.append(" LEFT JOIN gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		str.append(" LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		str.append(" LEFT JOIN usuario on usuario.codigo = historico.responsavel ");

		str.append(" LEFT JOIN turno on matricula.turno = turno.codigo ");
		str.append(" LEFT JOIN unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeEnsino ");
		str.append(" LEFT JOIN curso on curso.codigo = matricula.curso ");

		str.append(" LEFT JOIN periodoLetivo as periodoLetivoMatrizCurricular on historico.periodoLetivoMatrizCurricular = periodoLetivoMatrizCurricular.codigo ");
		str.append(" LEFT JOIN periodoLetivo as periodoLetivoCursada on historico.periodoLetivoCursada = periodoLetivoCursada.codigo ");
		str.append(" LEFT JOIN gradeCurricular as matrizCurricular on matricula.gradecurricularatual = matrizCurricular.codigo ");

		str.append(" LEFT JOIN configuracaoAcademico on configuracaoAcademico.codigo = historico.configuracaoAcademico ");
		return str;
	}

	private Double executarDefinicaoCargaHorariaUtilizarCalculoFrequencia(HistoricoVO historicoVO) throws Exception {
		Double cargaHoraria = 0.0;
		if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_REGISTRO_AULA)) {
			cargaHoraria = getFacadeFactory().getRegistroAulaFacade().consultarSomaCargaHorarioDisciplina(historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().getCodigo(), historicoVO.getSemestreHistorico(), historicoVO.getAnoHistorico(), historicoVO.getDisciplina().getCodigo(), false, null, true).doubleValue();
			cargaHoraria += getFacadeFactory().getRegistroAulaFacade().consultarSomaCargaHorarioDisciplina(historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().getCodigo(), historicoVO.getSemestreHistorico(), historicoVO.getAnoHistorico(), historicoVO.getDisciplina().getCodigo(), false, null, true).doubleValue();
			cargaHoraria = Uteis.arrendondarForcando2CadasDecimais(cargaHoraria/60);
		}else if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_DISCIPLINA)) {
			if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria().doubleValue();
			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
			cargaHoraria = historicoVO.getGradeDisciplinaComposta().getCargaHoraria().doubleValue();
			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeDisciplinaVO().getCargaHoraria().doubleValue();
			}else{
				cargaHoraria = historicoVO.getCargaHorariaDisciplina().doubleValue();
			}
		}else if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA)) {
			if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getHoraAula().doubleValue();
			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
				cargaHoraria = historicoVO.getGradeDisciplinaComposta().getHoraAula().doubleValue();
			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeDisciplinaVO().getHoraAula().doubleValue();
			}else{
				cargaHoraria = historicoVO.getCargaHorariaDisciplina().doubleValue();
			}
		}
		return cargaHoraria;
	}

	private Double executarDefinicaoCargaHorariaUtilizarCalculoFrequenciaPratica(HistoricoVO historicoVO) throws Exception {
		Double cargaHoraria = 0.0;
		if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_REGISTRO_AULA)) {
			cargaHoraria = getFacadeFactory().getRegistroAulaFacade().consultarSomaCargaHorarioDisciplina(historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().getCodigo(), historicoVO.getSemestreHistorico(), historicoVO.getAnoHistorico(), historicoVO.getDisciplina().getCodigo(), false, null, true).doubleValue();
			cargaHoraria = Uteis.arrendondarForcando2CasasDecimais(cargaHoraria/60.0);
		}else  if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_DISCIPLINA)) {
			if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHorariaPratica().doubleValue();
			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
				cargaHoraria = historicoVO.getGradeDisciplinaComposta().getCargaHorariaPratica().doubleValue();
			} else  if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeDisciplinaVO().getCargaHorariaPratica().doubleValue();
			}else{
				cargaHoraria = historicoVO.getCargaHorariaDisciplina().doubleValue();
			}
		}else if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA)) {
			if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getHoraAula().doubleValue();
			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
				cargaHoraria = historicoVO.getGradeDisciplinaComposta().getHoraAula().doubleValue();
			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeDisciplinaVO().getHoraAula().doubleValue();
			} else {
				cargaHoraria = historicoVO.getCargaHorariaDisciplina().doubleValue();
			}
		}
		return cargaHoraria;
	}

	private Double executarDefinicaoCargaHorariaUtilizarCalculoFrequenciaTeorica(HistoricoVO historicoVO) throws Exception {
		Double cargaHoraria = 0.0;
		if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_REGISTRO_AULA)) {
			cargaHoraria = getFacadeFactory().getRegistroAulaFacade().consultarSomaCargaHorarioDisciplina(historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().getCodigo(), historicoVO.getSemestreHistorico(), historicoVO.getAnoHistorico(), historicoVO.getDisciplina().getCodigo(), false, null, true).doubleValue();
			cargaHoraria = Uteis.arrendondarForcando2CasasDecimais(cargaHoraria/60.0);
		}else if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_DISCIPLINA)) {
			if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHorariaTeorica().doubleValue();
			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
				cargaHoraria = historicoVO.getGradeDisciplinaComposta().getCargaHorariaTeorica().doubleValue();
			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeDisciplinaVO().getCargaHorariaTeorica().doubleValue();
			} else {
				cargaHoraria = historicoVO.getCargaHorariaDisciplina().doubleValue();
			}
		}else if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA)) {

			if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getHoraAula().doubleValue();

			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
				cargaHoraria = historicoVO.getGradeDisciplinaComposta().getHoraAula().doubleValue();

			} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
				cargaHoraria = historicoVO.getGradeDisciplinaVO().getHoraAula().doubleValue();

			} else {
				cargaHoraria = historicoVO.getCargaHorariaDisciplina().doubleValue();
			}
		}
		return cargaHoraria;
	}

	private void executarCalculoFrequenciaGeralDeAcordoComCargaHorariaDisciplina(HistoricoVO historicoVO, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO, boolean existeRegistroAulaTeorica, Integer totalFaltaTeorica, boolean existeRegistroAulaPratica, Integer totalFaltaPratica) throws Exception {
		Double cargaHorariaTeorica = existeRegistroAulaTeorica ? executarDefinicaoCargaHorariaUtilizarCalculoFrequenciaTeorica(historicoVO) : 0;
		Double cargaHorariaPratica = existeRegistroAulaPratica ? executarDefinicaoCargaHorariaUtilizarCalculoFrequenciaPratica(historicoVO) : 0;
		if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.CARGA_HORARIA_REGISTRO_AULA)) {
			if(cargaHorariaTeorica.equals(0.0) && Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica())){
				if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
					cargaHorariaTeorica = historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHorariaTeorica().doubleValue();
				} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
					cargaHorariaTeorica = historicoVO.getGradeDisciplinaComposta().getCargaHorariaTeorica().doubleValue();
				} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
					cargaHorariaTeorica = historicoVO.getGradeDisciplinaVO().getCargaHorariaTeorica().doubleValue();
				} else {
					cargaHorariaTeorica = historicoVO.getCargaHorariaDisciplina().doubleValue();
				}
			}
			if(cargaHorariaPratica.equals(0.0) && Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica())){
				if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
					cargaHorariaPratica = historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHorariaPratica().doubleValue();
				} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
					cargaHorariaPratica = historicoVO.getGradeDisciplinaComposta().getCargaHorariaPratica().doubleValue();
				} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
					cargaHorariaPratica = historicoVO.getGradeDisciplinaVO().getCargaHorariaPratica().doubleValue();
				} else {
					cargaHorariaPratica = historicoVO.getCargaHorariaDisciplina().doubleValue();
				}
			}
		}
		Double frequenciaTeorica = historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA) ? historicoVO.getFrequenciaTeorica() : historicoVO.getFrequenciaTeorica() * cargaHorariaTeorica / 100;
		Double frequenciaPratica = historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA) ? historicoVO.getFrequenciaPratica() : historicoVO.getFrequenciaPratica() * cargaHorariaPratica / 100;

		if ((frequenciaTeorica + frequenciaPratica) == 0) {
			historicoVO.setFreguencia(Uteis.arrendondarForcando2CadasDecimais(0));
		} else {
			double cargaHorariaBase = 0.0;
			if(!existeRegistroAulaPratica && !existeRegistroAulaTeorica){
				if (!historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA)) {
					if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
						cargaHorariaBase = historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria().doubleValue();
					} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
						cargaHorariaBase = historicoVO.getGradeDisciplinaComposta().getCargaHoraria().doubleValue();
					} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
						cargaHorariaBase = historicoVO.getGradeDisciplinaVO().getCargaHoraria().doubleValue();
					}else{
						cargaHorariaBase = historicoVO.getCargaHorariaDisciplina().doubleValue();
					}
				}else if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA)) {
						if (Uteis.isAtributoPreenchido(historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO())) {
							cargaHorariaBase = historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getHoraAula().doubleValue();
						} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaComposta())) {
							cargaHorariaBase = historicoVO.getGradeDisciplinaComposta().getHoraAula().doubleValue();
						} else if (Uteis.isAtributoPreenchido(historicoVO.getGradeDisciplinaVO())) {
							cargaHorariaBase = historicoVO.getGradeDisciplinaVO().getHoraAula().doubleValue();
						}else{
							cargaHorariaBase = historicoVO.getCargaHorariaDisciplina().doubleValue();
						}
				}
			}else{
				cargaHorariaBase = executarDefinicaoCargaHorariaUtilizarCalculoFrequencia(historicoVO);
			}
			if (historicoVO.getConfiguracaoAcademico().getTipoCalculoCargaHorariaFrequencia().equals(TipoCalculoCargaHorariaFrequencia.HORA_AULA_DISCIPLINA)){
				 historicoVO.setFreguencia(Uteis.arrendondarForcando2CadasDecimais((frequenciaTeorica + frequenciaPratica)));
			}else{
				historicoVO.setFreguencia(Uteis.arrendondarForcando2CadasDecimais((frequenciaTeorica + frequenciaPratica) * 100 / cargaHorariaBase));
			}
		}
		if(historicoVO.getFreguencia() > 100){
			historicoVO.setFreguencia(100.0);
		}
		historicoVO.setTotalFalta(totalFaltaTeorica + totalFaltaPratica);
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Boolean realizarLancamentoNotaHistoricoAutomaticamente(TipoNotaConceitoEnum tipoNotaAlterar, HistoricoVO historicoVO, Double nota, Boolean utilizaNotaConceito, ConfiguracaoAcademicoNotaConceitoVO notaConceito, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO, Boolean realizarCalculo, boolean alterar, UsuarioVO usuarioVO) throws Exception {
		if (historicoVO == null) {
			return false;
		}
		if (tipoNotaAlterar != null) {
			if(utilizaNotaConceito){
				notaConceito = getFacadeFactory().getConfiguracaoAcademicoNotaConceitoFacade().consultarPorChavePrimaria(notaConceito.getCodigo());
				UtilReflexao.invocarMetodo(historicoVO, "setNota"+tipoNotaAlterar.getNumeroNota()+"Conceito", notaConceito);
				nota = notaConceito.getFaixaNota2();
			}
			if(nota == null) {
				UtilReflexao.invocarMetodoSetParametroNull(historicoVO, "nota"+tipoNotaAlterar.getNumeroNota());
			}else {
				UtilReflexao.invocarMetodo(historicoVO, "setNota"+tipoNotaAlterar.getNumeroNota(), nota);
			}
			if(realizarCalculo) {
				if(!getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(historicoVO.getMatricula().getMatricula(), matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo(), 0, matriculaPeriodoTurmaDisciplinaVO.getSemestre(), matriculaPeriodoTurmaDisciplinaVO.getAno())){
					if(historicoVO.getFreguencia().equals(0.0)){
						historicoVO.setFreguencia(100.00);
					}
				}else{
					getFacadeFactory().getHistoricoFacade().executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFaltaFrequenciaHistorico(historicoVO, historicoVO.getConfiguracaoAcademico(), usuarioVO);
				}
				calcularMedia(historicoVO.getConfiguracaoAcademico(), historicoVO, usuarioVO);
			}
			if (alterar) {
				alterar(historicoVO, null, usuarioVO);
			}
			return true;
		} else {
			return false;
		}
	}


	public void realizarCalculoMediaFinalDisciplinaComposta(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> historicoDisciplinaFazParteComposicaoVOs, FormulaCalculoNotaEnum formulaCalculoNota, UsuarioVO usuarioVO){
		String formula = null;
		if(formulaCalculoNota.equals(FormulaCalculoNotaEnum.FORMULA_CALCULO)){
			formula = Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getGradeDisciplinaVO()) ? historicoDisciplinaComposta.getGradeDisciplinaVO().getFormulaCalculo() : historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getFormulaCalculo();
		}
		Double valorFinal = null;
		for (HistoricoVO historicoVO : historicoDisciplinaFazParteComposicaoVOs) {
			if(historicoVO.getMediaFinal() != null || (historicoVO.getMediaFinal() == null && historicoVO.getConfiguracaoAcademico().getConsiderarCampoNuloNotaZerada())){
				if(valorFinal == null){
					valorFinal = 0.0;
				}
				if(historicoVO.getMediaFinal() != null) {
					valorFinal += historicoVO.getMediaFinal();
				}
				if(formulaCalculoNota.equals(FormulaCalculoNotaEnum.FORMULA_CALCULO)){
					formula = formula.replaceAll(historicoVO.getGradeDisciplinaComposta().getVariavelNota(), historicoVO.getMediaFinal().toString());
				}
			}else if(historicoDisciplinaComposta.getConfiguracaoAcademico().getCalcularMediaFinalDisciplinaCompostaAposCalculoTodasComposicoes()){
				valorFinal = null;
				break;
			}
		}
		if (valorFinal != null) {
			if(formulaCalculoNota.equals(FormulaCalculoNotaEnum.MEDIA)){
				valorFinal = valorFinal/historicoDisciplinaFazParteComposicaoVOs.size();
			}else if(formulaCalculoNota.equals(FormulaCalculoNotaEnum.FORMULA_CALCULO)){
				valorFinal = Uteis.realizarCalculoFormula(formula);
			}
			valorFinal = Uteis.formatarDeAcordoQuantidadeCasasDecimaisAposVirgulaDouble(valorFinal, historicoDisciplinaComposta.getConfiguracaoAcademico().getQuantidadeCasasDecimaisPermitirAposVirgula());
			UtilReflexao.invocarMetodo(historicoDisciplinaComposta, "setMediaFinal", valorFinal);
		} else {
			UtilReflexao.invocarMetodoSetParametroNull(historicoDisciplinaComposta, "mediaFinal");
		}
	}

	@Override
	public Boolean realizarVerificacaoEAtualizacaoFrequenciaHistoricoAluno(HistoricoVO historicoVO, UsuarioVO usuarioVO) throws Exception{
		Boolean existeRegistroAula = false;
		if (!historicoVO.getSituacao().equals(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor()) && !historicoVO.getSituacao().equals(SituacaoHistorico.ISENTO.getValor()) && !historicoVO.getSituacao().equals(SituacaoHistorico.CONCESSAO_CREDITO.getValor()) && !historicoVO.getSituacao().equals(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getValor())) {
			if (!existeRegistroAula && historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().getCodigo() > 0) {
				existeRegistroAula = getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(null, historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().getCodigo(), historicoVO.getDisciplina().getCodigo(), null, historicoVO.getSemestreHistorico(), historicoVO.getAnoHistorico());
			}
			if (!existeRegistroAula && historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().getCodigo() > 0) {
				existeRegistroAula = getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(null, historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().getCodigo(), historicoVO.getDisciplina().getCodigo(), null, historicoVO.getSemestreHistorico(), historicoVO.getAnoHistorico());
			}
			if(!existeRegistroAula && historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaPratica().getCodigo().equals(0) && historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurmaTeorica().getCodigo().equals(0) && !historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurma().getCodigo().equals(0)){
				existeRegistroAula = getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(null, historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurma().getCodigo(), historicoVO.getDisciplina().getCodigo(), null, historicoVO.getSemestreHistorico(), historicoVO.getAnoHistorico());
			}
			if (existeRegistroAula) {
				getFacadeFactory().getHistoricoFacade().executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFaltaFrequenciaHistorico(historicoVO, historicoVO.getConfiguracaoAcademico(), usuarioVO);
			}else if(historicoVO.getHistoricoDisciplinaComposta()){
				List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
				historicoVOs = getFacadeFactory().getHistoricoFacade().consultaRapidaHistoricoFazParteComposicaoPorMatriculaPorGradeCurricularPorMatriculaPeriodo(historicoVO.getMatricula().getMatricula(), historicoVO.getCodigo(), historicoVO.getMatriculaPeriodo().getCodigo(), historicoVO.getMatrizCurricular().getCodigo(), historicoVO.getGradeDisciplinaVO().getCodigo(), historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), false, usuarioVO);
				if(!historicoVOs.isEmpty()){
				if (historicoVO.getHistoricoDisciplinaFazParteComposicao()) {
					historicoVOs.add(historicoVO);
				}
				Double frequencia = 0.0;
				Double frequenciaReprovadaPorFalta = 0.0;
				Map<Integer, ConfiguracaoAcademicoVO> mapConf = new HashMap<Integer, ConfiguracaoAcademicoVO>(0);
				mapConf.put(historicoVO.getConfiguracaoAcademico().getCodigo(), historicoVO.getConfiguracaoAcademico());
				int qtdeDisciplinaControlaFrequencia = 0;
				for (HistoricoVO obj : historicoVOs) {
					if (!mapConf.containsKey(obj.getConfiguracaoAcademico().getCodigo())) {
						mapConf.put(obj.getConfiguracaoAcademico().getCodigo(), getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(obj.getConfiguracaoAcademico().getCodigo(), usuarioVO));
					}
					obj.setConfiguracaoAcademico(mapConf.get(obj.getConfiguracaoAcademico().getCodigo()));
					if (!obj.getConfiguracaoAcademico().getPercentualFrequenciaAprovacao().equals(0.0)) {
						qtdeDisciplinaControlaFrequencia++;
						if(obj.getFreguencia().equals(0.0)){
							realizarVerificacaoEAtualizacaoFrequenciaHistoricoAluno(obj, usuarioVO);
						}
						frequencia += obj.getFreguencia();
						if(historicoVO.getConfiguracaoAcademico().getReprovarFaltaDisciplinaCompostaCasoReprovadoFaltaDisciplinaFilha()
								&& obj.getFreguencia() < obj.getConfiguracaoAcademico().getPercentualFrequenciaAprovacao()){
							frequenciaReprovadaPorFalta =  obj.getFreguencia();
						}
					}
				}
				executarCalculoFaltasAlunoBimestreDisciplinaComposta(historicoVOs, historicoVO);
				if(historicoVO.getConfiguracaoAcademico().getReprovarFaltaDisciplinaCompostaCasoReprovadoFaltaDisciplinaFilha() && frequenciaReprovadaPorFalta > 0){
					historicoVO.setFreguencia(frequenciaReprovadaPorFalta);
				}else if (qtdeDisciplinaControlaFrequencia > 0) {
					historicoVO.setFreguencia(Uteis.arrendondarForcando2CadasDecimais(frequencia / qtdeDisciplinaControlaFrequencia));
				} else {
					historicoVO.setFreguencia(100.0);
				}
			}
				if(historicoVO.getConfiguracaoAcademico().getUsarFormulaCalculoFrequencia() && !historicoVO.getConfiguracaoAcademico().getFormulaCalculoFrequencia().trim().isEmpty()) {
					String formula = historicoVO.getConfiguracaoAcademico().substituirSimbolosFormulaCalculoMediaFinal(historicoVO, historicoVO.getConfiguracaoAcademico().getFormulaCalculoFrequencia(), null);
					historicoVO.setFreguencia(Uteis.arrendondarForcando2CadasDecimais(Uteis.realizarCalculoFormula(formula)));
			}
			}else {
				if(historicoVO.getConfiguracaoAcademico().getUsarFormulaCalculoFrequencia() && !historicoVO.getConfiguracaoAcademico().getFormulaCalculoFrequencia().trim().isEmpty()) {
					String formula = historicoVO.getConfiguracaoAcademico().substituirSimbolosFormulaCalculoMediaFinal(historicoVO, historicoVO.getConfiguracaoAcademico().getFormulaCalculoFrequencia(), null);
					historicoVO.setFreguencia(Uteis.arrendondarForcando2CadasDecimais(Uteis.realizarCalculoFormula(formula)));
		}
			}
		}
		return existeRegistroAula;
	}

	public List<HistoricoVO> consultarPorMatriculaCancelada(Integer matriculaPeriodo, UsuarioVO usuario) throws Exception {
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append("where historico.situacao = 'CA' and historico.matriculaPeriodo = ?");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), matriculaPeriodo);
		return montarDadosConsultaCompleta(tabelaResultado, usuario);
	}

	public List<HistoricoVO> consultarPorMatriculaTrancadaAbandonadaJubilada(Integer matriculaPeriodo, UsuarioVO usuario) throws Exception {
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append("where historico.situacao in ('TR','AC','JU') and historico.matriculaPeriodo = ?");
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual("and"));
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), matriculaPeriodo);
		return montarDadosConsultaCompleta(tabelaResultado, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void verificarAprovacaoAlunos(final List<HistoricoVO> alunosTurma, boolean processarComParalelismo, boolean realizarCalculoMediaFinal, final UsuarioVO usuarioVO) throws Exception {
		if (processarComParalelismo) {
			final ConsistirException ex = new ConsistirException();
			try {
				ProcessarParalelismo.executar(0, alunosTurma.size(), ex, new ProcessarParalelismo.Processo() {
					@Override
					public void run(int i) {
						final HistoricoVO historicoVO = alunosTurma.get(i);
						try {
							if (!historicoVO.getSituacao().equals(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor())
									&& !historicoVO.getSituacao().equals(SituacaoHistorico.ISENTO.getValor())
									&& !historicoVO.getSituacao().equals(SituacaoHistorico.CONCESSAO_CREDITO.getValor())
									&& !historicoVO.getSituacao()
											.equals(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getValor())) {
								//List<HistoricoVO> historicoFilhaComposicaoVOs = new ArrayList<HistoricoVO>(0);
								if(historicoVO.getHistoricoDisciplinaComposta() && !Uteis.isAtributoPreenchido(historicoVO.getHistoricoDisciplinaFilhaComposicaoVOs())) {
									historicoVO.setHistoricoDisciplinaFilhaComposicaoVOs(getFacadeFactory().getHistoricoFacade().consultaRapidaHistoricoFazParteComposicaoPorMatriculaPorGradeCurricularPorMatriculaPeriodo(historicoVO.getMatricula().getMatricula(), 0, historicoVO.getMatriculaPeriodo().getCodigo(), historicoVO.getMatrizCurricular().getCodigo(), historicoVO.getGradeDisciplinaVO().getCodigo(), historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), false, usuarioVO));
									Map<Integer, ConfiguracaoAcademicoVO> mapConf =  new HashMap<Integer, ConfiguracaoAcademicoVO>(0);
									if(!mapConf.containsKey(historicoVO.getConfiguracaoAcademico().getCodigo())){
										mapConf.put(historicoVO.getConfiguracaoAcademico().getCodigo(), historicoVO.getConfiguracaoAcademico());
									}
									mapConf.put(historicoVO.getConfiguracaoAcademico().getCodigo(), historicoVO.getConfiguracaoAcademico());
									for (HistoricoVO obj : historicoVO.getHistoricoDisciplinaFilhaComposicaoVOs()) {
										if(!obj.getConfiguracaoAcademico().getNivelMontarDados().equals(NivelMontarDados.TODOS)) {
											if (!mapConf.containsKey(obj.getConfiguracaoAcademico().getCodigo())) {
												mapConf.put(obj.getConfiguracaoAcademico().getCodigo(), getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(obj.getConfiguracaoAcademico().getCodigo(), usuarioVO));
											}
											obj.setConfiguracaoAcademico(mapConf.get(obj.getConfiguracaoAcademico().getCodigo()));
										}
									}
								}
								realizarVerificacaoEAtualizacaoFrequenciaHistoricoAluno(historicoVO, usuarioVO);
								verificarNotasLancadas(historicoVO, usuarioVO);
								if(realizarCalculoMediaFinal) {
									calcularMedia(historicoVO, historicoVO.getHistoricoDisciplinaFilhaComposicaoVOs(), historicoVO.getConfiguracaoAcademico(), null,
											TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, true, usuarioVO);	
								}
								gravarLancamentoNota(historicoVO, true, "Visão Administrativa", TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, usuarioVO);
							}
						} catch (ConsistirException e) {
							ex.adicionarListaMensagemErro("Erro ao processar matrícula "
									+ historicoVO.getMatricula().getMatricula() + " - " + e.getMessage() + ".");
						} catch (Exception e) {
							ex.adicionarListaMensagemErro("Erro ao processar matrícula "
									+ historicoVO.getMatricula().getMatricula() + " - " + e.getMessage() + ".");
						}
					}
				});
				if (!ex.getListaMensagemErro().isEmpty()) {
					throw ex;
				}
				getFacadeFactory().getLogLancamentoNotaFacade().registrarLogLancamentoNota(alunosTurma,
						"ALTERAÇÃO HISTORICO", usuarioVO);
			} catch (ConsistirException exc) {
				throw exc;
			} catch (Exception e) {
				throw e;
			}
		} else {
			try {
				for (HistoricoVO historicoVO : alunosTurma) {
					if (!historicoVO.getSituacao().equals(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor())
							&& !historicoVO.getSituacao().equals(SituacaoHistorico.ISENTO.getValor())
							&& !historicoVO.getSituacao().equals(SituacaoHistorico.CONCESSAO_CREDITO.getValor())
							&& !historicoVO.getSituacao()
									.equals(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getValor())) {
						if(historicoVO.getHistoricoDisciplinaComposta() && !Uteis.isAtributoPreenchido(historicoVO.getHistoricoDisciplinaFilhaComposicaoVOs())) {
							historicoVO.setHistoricoDisciplinaFilhaComposicaoVOs(getFacadeFactory().getHistoricoFacade().consultaRapidaHistoricoFazParteComposicaoPorMatriculaPorGradeCurricularPorMatriculaPeriodo(historicoVO.getMatricula().getMatricula(), 0, historicoVO.getMatriculaPeriodo().getCodigo(), historicoVO.getMatrizCurricular().getCodigo(), historicoVO.getGradeDisciplinaVO().getCodigo(), historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), false, usuarioVO));
							Map<Integer, ConfiguracaoAcademicoVO> mapConf =  new HashMap<Integer, ConfiguracaoAcademicoVO>(0);
							if(!mapConf.containsKey(historicoVO.getConfiguracaoAcademico().getCodigo())){
								mapConf.put(historicoVO.getConfiguracaoAcademico().getCodigo(), historicoVO.getConfiguracaoAcademico());
							}
							mapConf.put(historicoVO.getConfiguracaoAcademico().getCodigo(), historicoVO.getConfiguracaoAcademico());
							for (HistoricoVO obj : historicoVO.getHistoricoDisciplinaFilhaComposicaoVOs()) {
								if(!obj.getConfiguracaoAcademico().getNivelMontarDados().equals(NivelMontarDados.TODOS)) {
									if (!mapConf.containsKey(obj.getConfiguracaoAcademico().getCodigo())) {
										mapConf.put(obj.getConfiguracaoAcademico().getCodigo(), getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(obj.getConfiguracaoAcademico().getCodigo(), usuarioVO));
									}
									obj.setConfiguracaoAcademico(mapConf.get(obj.getConfiguracaoAcademico().getCodigo()));
								}
							}
						}
						realizarVerificacaoEAtualizacaoFrequenciaHistoricoAluno(historicoVO, usuarioVO);
						verificarNotasLancadas(historicoVO, usuarioVO);
						calcularMedia(historicoVO, historicoVO.getHistoricoDisciplinaFilhaComposicaoVOs(), historicoVO.getConfiguracaoAcademico(), null,
								TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, true, usuarioVO);
						gravarLancamentoNota(historicoVO, true, "Visão Administrativa",
								TipoAlteracaoSituacaoHistoricoEnum.TODOS_HISTORICOS, usuarioVO);
					}
				}
				getFacadeFactory().getLogLancamentoNotaFacade().registrarLogLancamentoNota(alunosTurma,
						"ALTERAÇÃO HISTORICO", usuarioVO);
			} catch (ConsistirException exc) {
				throw exc;
			} catch (Exception e) {
				throw e;
			}
		}
	}


	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarAlteracaoHistoricoCursandoPeriodoLetivoDeAcordoConfiguracaoAcademica(List<MatriculaPeriodoVO> matriculaPeriodoVOs, String ano, String semestre, UsuarioVO usuarioLogado) throws Exception {
		if (matriculaPeriodoVOs.isEmpty()) {
			return;
		}

		StringBuilder sql = new StringBuilder("");
		sql.append("  update historico set situacao = '").append(SituacaoHistorico.CURSANDO.getValor());
		sql.append("'  where matriculaperiodo in (0 ");
		for (MatriculaPeriodoVO matriculaPeriodoVO : matriculaPeriodoVOs) {
			sql.append(", ").append(matriculaPeriodoVO.getCodigo());
		}
		sql.append(") and historico.situacao = '").append(SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getValor()).append("' ");

		getConexao().getJdbcTemplate().execute(sql.toString());
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarAlteracaoHistoricoReprovadoPeriodoLetivoDeAcordoConfiguracaoAcademica(List<MatriculaPeriodoVO> matriculaPeriodoVOs, String ano, String semestre, UsuarioVO usuarioLogado) throws Exception {
		if (matriculaPeriodoVOs.isEmpty()) {
			return;
		}
		StringBuilder sql = new StringBuilder("");
		sql.append("  update historico set situacao = '").append(SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getValor()).append("' from (");
		sql.append("	select distinct matriculaperiodo.codigo as matriculaperiodo, pl.codigo as periodoletivo, matriculaperiodo.matricula, matricula.gradecurricularatual, matriculaperiodo.ano, matriculaperiodo.semestre, ");
		sql.append("	array_to_string(array_agg(case when historico.situacao not in ('RE', 'RP', 'RF') then historico.codigo end ), ', ') as historicos ");
		sql.append("	from matricula ");
		sql.append("	inner join matriculaperiodo on matriculaperiodo.matricula = matricula.matricula");
		sql.append("	inner join periodoletivo on periodoletivo.codigo = matriculaperiodo.periodoletivomatricula ");
		sql.append("	inner join periodoletivo pl on pl.gradecurricular = matricula.gradecurricularatual and pl.periodoletivo = periodoletivo.periodoletivo ");
		sql.append("	inner join curso on curso.codigo = matricula.curso");
		sql.append("	inner join configuracaoacademico on ((pl.configuracaoacademico is not null and pl.configuracaoacademico = configuracaoacademico.codigo) or (pl.configuracaoacademico is null and curso.configuracaoacademico = configuracaoacademico.codigo))");
		sql.append("	inner join historico on historico.matriculaperiodo = matriculaperiodo.codigo");
		sql.append("	and historico.anohistorico = matriculaperiodo.ano and historico.semestrehistorico = matriculaperiodo.semestre");
		sql.append("	where ");
		sql.append("	configuracaoacademico.reprovadoMatricularDisciplinaPeriodoLetivo ");
		sql.append("    and configuracaoacademico.numeroDisciplinaConsiderarReprovadoPeriodoLetivo > 0 ");
		sql.append("	and ((curso.periodicidade = 'AN' and matriculaperiodo.ano = '").append(ano).append("') ");
		sql.append("	or (curso.periodicidade = 'SE' and matriculaperiodo.ano = '").append(ano).append("' and matriculaperiodo.semestre = '").append(semestre).append("') ");
		sql.append("	or (curso.periodicidade = 'IN'))");
		sql.append("	and matriculaperiodo.situacaomatriculaperiodo in ('AT', 'FI', 'CO')");
		sql.append("	and (historico.historicodisciplinafazpartecomposicao is null or historico.historicodisciplinafazpartecomposicao = false)");
		sql.append("	and (historico.historicoequivalente is null or historico.historicoequivalente= false) ");
		sql.append("	and (historico.historicodisciplinaforagrade is null or historico.historicodisciplinaforagrade = false)");
		sql.append("	and (historico.gradecurriculargrupooptativadisciplina is not null or historico.gradedisciplina is not null)");
		sql.append("	and historico.matrizcurricular = matricula.gradecurricularatual ");
		sql.append("	and historico.situacao not in ('AA', 'CC', 'CH', 'IS', 'AB') ");
		sql.append("	and ((historico.periodoletivomatrizcurricular is not null and pl.codigo = historico.periodoletivomatrizcurricular) ");
		sql.append("	 or exists ( ");
		sql.append("	select gradecurriculargrupooptativadisciplina.codigo from gradecurriculargrupooptativadisciplina ");
		sql.append("	inner join periodoletivo plgo on plgo.gradecurriculargrupooptativa = gradecurriculargrupooptativadisciplina.gradecurriculargrupooptativa ");
		sql.append("	where gradecurriculargrupooptativadisciplina.codigo = historico.gradecurriculargrupooptativadisciplina ");
		sql.append("	and plgo.codigo = pl.codigo ");
		sql.append("	union all ");
		sql.append("	select gradedisciplina.codigo from gradedisciplina ");
		sql.append("	inner join periodoletivo plgo on plgo.codigo = gradedisciplina.periodoletivo ");
		sql.append("	where gradedisciplina.codigo = historico.gradedisciplina ");
		sql.append("	and plgo.codigo = pl.codigo ");
		sql.append("	) ) ");
		sql.append("	and matriculaperiodo.codigo in (0 ");
		for (MatriculaPeriodoVO matriculaPeriodoVO : matriculaPeriodoVOs) {
			sql.append(", ").append(matriculaPeriodoVO.getCodigo());
		}
		sql.append(") ");
		sql.append("	group by matriculaperiodo.codigo ,matriculaperiodo.matricula, matricula.gradecurricularatual, matriculaperiodo.ano, matriculaperiodo.semestre, configuracaoacademico.numeroDisciplinaConsiderarReprovadoPeriodoLetivo, pl.codigo");
		sql.append("	having sum(case when historico.situacao in ('RE', 'RF') then 1 else 0 end ) >= configuracaoacademico.numeroDisciplinaConsiderarReprovadoPeriodoLetivo) as t ");
		sql.append("	where t.matriculaperiodo = historico.matriculaperiodo and historico.matrizcurricular = t.gradecurricularatual and t.ano = historico.anohistorico ");
		sql.append("	and ((historico.periodoletivomatrizcurricular is not null and t.periodoletivo = historico.periodoletivomatrizcurricular) ");
		sql.append("	or (historico.gradedisciplinacomposta is not null and exists (select gradedisciplina.periodoletivo from gradedisciplinacomposta ");
		sql.append("	inner join gradedisciplina on gradedisciplina.codigo = gradedisciplinacomposta.gradedisciplina where gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		sql.append("	and t.periodoletivo = gradedisciplina.periodoletivo ");
		sql.append("	union ");
		sql.append("	select plgo.codigo from gradedisciplinacomposta ");
		sql.append("	inner join gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = gradedisciplinacomposta.gradecurriculargrupooptativadisciplina ");
		sql.append("	inner join periodoletivo plgo on plgo.gradecurriculargrupooptativa = gradecurriculargrupooptativadisciplina.gradecurriculargrupooptativa ");
		sql.append("	where gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta 	and t.periodoletivo = plgo.periodoletivo  ");
		sql.append("	) )) ");
		sql.append("	and t.semestre = historico.semestrehistorico and historico.situacao not in ('RE', 'RF', 'RP', 'AA', 'IS', 'CH', 'CC', 'AB') ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		getConexao().getJdbcTemplate().execute(sql.toString());
	}

	@Override
	public Integer consultarUltimoNumeroAgrupamentoEquivalenciaDisciplina(String matricula, Integer mapaEquivalenciaDisciplina) throws Exception{
		StringBuilder sql  = new StringBuilder("SELECT max(numeroAgrupamentoEquivalenciaDisciplina) as numeroAgrupamentoEquivalenciaDisciplina from historico ");
		sql.append(" where matricula = ? ");
		sql.append(" and mapaEquivalenciaDisciplina = ? ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), matricula, mapaEquivalenciaDisciplina);
		if(rs.next()){
			return rs.getInt("numeroAgrupamentoEquivalenciaDisciplina");
		}
		return 0;
	}

	@Override
	public Integer consultarNumeroAgrupamentoEquivalenciaDisciplinaPorMatriculaPeriodoTurmaDisciplina(Integer matriculaPeriodoTurmaDisciplina, Integer mapaEquivalenciaDisciplina) throws Exception{
		StringBuilder sql  = new StringBuilder("SELECT max(numeroAgrupamentoEquivalenciaDisciplina) as numeroAgrupamentoEquivalenciaDisciplina from historico ");
		sql.append(" where matriculaPeriodoTurmaDisciplina = ? ");
		sql.append(" and mapaEquivalenciaDisciplina = ? ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), matriculaPeriodoTurmaDisciplina, mapaEquivalenciaDisciplina);
		if(rs.next()){
			return rs.getInt("numeroAgrupamentoEquivalenciaDisciplina");
		}
		return 0;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarNumeroAgrupamentoEquivalenciaDisciplina(HistoricoVO historicoVO) throws Exception{
		StringBuilder sql  = new StringBuilder("update historico set numeroAgrupamentoEquivalenciaDisciplina = ? where codigo = ? ");
		getConexao().getJdbcTemplate().update(sql.toString(), historicoVO.getNumeroAgrupamentoEquivalenciaDisciplina(), historicoVO.getCodigo());
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarDataRegistroHistorico(final Integer codigo, final Date dataRegistro, final Date dataInicioAula, final Date dataFimAula, final UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set dataRegistro = ?, dataInicioAula = ?, dataFimAula = ?  WHERE codigo = ?" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(dataRegistro));
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(dataInicioAula));
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(dataFimAula));
					sqlAlterar.setInt(++i, codigo);
					return sqlAlterar;
				}
			});
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					StringBuilder sqlDisciplinaComposicao = new StringBuilder("UPDATE Historico set dataRegistro = ?, dataInicioAula = ?, dataFimAula = ?  WHERE codigo in (select hist1.codigo from historico as hist1 ");
					sqlDisciplinaComposicao.append(" inner join historico as hist2 on hist1.matricula = hist2.matricula and hist2.historicodisciplinacomposta ");
					sqlDisciplinaComposicao.append(" and hist2.anohistorico = hist1.anohistorico and hist2.semestrehistorico = hist1.semestrehistorico ");
							sqlDisciplinaComposicao.append(" and hist2.matriculaperiodo = hist1.matriculaperiodo ");
							sqlDisciplinaComposicao.append(" inner join gradedisciplinacomposta on gradedisciplinacomposta.codigo = hist1.gradedisciplinacomposta ");
							sqlDisciplinaComposicao.append(" where hist2.codigo = ? ");
							sqlDisciplinaComposicao.append(" and ( ");
							sqlDisciplinaComposicao.append(" (gradedisciplinacomposta.gradedisciplina is not null ");
							sqlDisciplinaComposicao.append(" and hist2.gradedisciplina is not null");
							sqlDisciplinaComposicao.append(" and gradedisciplinacomposta.gradedisciplina = hist2.gradedisciplina) ");
							sqlDisciplinaComposicao.append(" or ");
							sqlDisciplinaComposicao.append(" (gradedisciplinacomposta.gradecurriculargrupooptativadisciplina is not null ");
							sqlDisciplinaComposicao.append(" and hist2.gradecurriculargrupooptativadisciplina is not null ");
							sqlDisciplinaComposicao.append(" and gradedisciplinacomposta.gradecurriculargrupooptativadisciplina = hist2.gradecurriculargrupooptativadisciplina) ");
							sqlDisciplinaComposicao.append(" )) ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
					PreparedStatement sqlAlterar = arg0.prepareStatement(sqlDisciplinaComposicao.toString());
					int i = 0;
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(dataRegistro));
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(dataInicioAula));
					sqlAlterar.setDate(++i, Uteis.getDataJDBC(dataFimAula));
					sqlAlterar.setInt(++i, codigo);
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	public void checarFormatarValoresNota31(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota31() != null) {
			if (historicoAux.getNota31() > configuracaoAcademicoVO.getFaixaNota31Maior()) {
				historicoAux.setNota31(configuracaoAcademicoVO.getFaixaNota31Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota31(Math.round(2 * historicoAux.getNota31()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota31MediaFinal()) {
				historicoAux.setNota31(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota31()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota31MediaFinal()) {
				historicoAux.setNota31(Math.round(2 * historicoAux.getNota31()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota32(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota32() != null) {
			if (historicoAux.getNota32() > configuracaoAcademicoVO.getFaixaNota32Maior()) {
				historicoAux.setNota32(configuracaoAcademicoVO.getFaixaNota32Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota32(Math.round(2 * historicoAux.getNota32()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota32MediaFinal()) {
				historicoAux.setNota32(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota32()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota32MediaFinal()) {
				historicoAux.setNota32(Math.round(2 * historicoAux.getNota32()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota33(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota33() != null) {
			if (historicoAux.getNota33() > configuracaoAcademicoVO.getFaixaNota33Maior()) {
				historicoAux.setNota33(configuracaoAcademicoVO.getFaixaNota33Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota33(Math.round(2 * historicoAux.getNota33()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota33MediaFinal()) {
				historicoAux.setNota33(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota33()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota33MediaFinal()) {
				historicoAux.setNota33(Math.round(2 * historicoAux.getNota33()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota34(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota34() != null) {
			if (historicoAux.getNota34() > configuracaoAcademicoVO.getFaixaNota34Maior()) {
				historicoAux.setNota34(configuracaoAcademicoVO.getFaixaNota34Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota34(Math.round(2 * historicoAux.getNota34()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota34MediaFinal()) {
				historicoAux.setNota34(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota34()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota34MediaFinal()) {
				historicoAux.setNota34(Math.round(2 * historicoAux.getNota34()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota35(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota35() != null) {
			if (historicoAux.getNota35() > configuracaoAcademicoVO.getFaixaNota35Maior()) {
				historicoAux.setNota35(configuracaoAcademicoVO.getFaixaNota35Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota35(Math.round(2 * historicoAux.getNota35()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota35MediaFinal()) {
				historicoAux.setNota35(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota35()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota35MediaFinal()) {
				historicoAux.setNota35(Math.round(2 * historicoAux.getNota35()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota36(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota36() != null) {
			if (historicoAux.getNota36() > configuracaoAcademicoVO.getFaixaNota36Maior()) {
				historicoAux.setNota36(configuracaoAcademicoVO.getFaixaNota36Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota36(Math.round(2 * historicoAux.getNota36()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota36MediaFinal()) {
				historicoAux.setNota36(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota36()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota36MediaFinal()) {
				historicoAux.setNota36(Math.round(2 * historicoAux.getNota36()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota37(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota37() != null) {
			if (historicoAux.getNota37() > configuracaoAcademicoVO.getFaixaNota37Maior()) {
				historicoAux.setNota37(configuracaoAcademicoVO.getFaixaNota37Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota37(Math.round(2 * historicoAux.getNota37()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota37MediaFinal()) {
				historicoAux.setNota37(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota37()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota37MediaFinal()) {
				historicoAux.setNota37(Math.round(2 * historicoAux.getNota37()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota38(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota38() != null) {
			if (historicoAux.getNota38() > configuracaoAcademicoVO.getFaixaNota38Maior()) {
				historicoAux.setNota38(configuracaoAcademicoVO.getFaixaNota38Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota38(Math.round(2 * historicoAux.getNota38()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota38MediaFinal()) {
				historicoAux.setNota38(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota38()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota38MediaFinal()) {
				historicoAux.setNota38(Math.round(2 * historicoAux.getNota38()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota39(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota39() != null) {
			if (historicoAux.getNota39() > configuracaoAcademicoVO.getFaixaNota39Maior()) {
				historicoAux.setNota39(configuracaoAcademicoVO.getFaixaNota39Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota39(Math.round(2 * historicoAux.getNota39()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota39MediaFinal()) {
				historicoAux.setNota39(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota39()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota39MediaFinal()) {
				historicoAux.setNota39(Math.round(2 * historicoAux.getNota39()) / 2.0);
			}
		}
	}

	public void checarFormatarValoresNota40(HistoricoVO historicoAux, ConfiguracaoAcademicoVO configuracaoAcademicoVO) {
		if (historicoAux.getNota40() != null) {
			if (historicoAux.getNota40() > configuracaoAcademicoVO.getFaixaNota40Maior()) {
				historicoAux.setNota40(configuracaoAcademicoVO.getFaixaNota40Maior());
			}
			if (configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && !configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia()) {
				historicoAux.setNota40(Math.round(2 * historicoAux.getNota40()) / 2.0);
			} else if (configuracaoAcademicoVO.getUtilizarArredondamentoMediaParaMais() && configuracaoAcademicoVO.getNota40MediaFinal()) {
				historicoAux.setNota40(Uteis.arredondarMultiploDeCincoParaCima(historicoAux.getNota40()));
			} else if (!configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimos() && configuracaoAcademicoVO.getNotasDeCincoEmCincoDecimosApenasMedia() && configuracaoAcademicoVO.getNota40MediaFinal()) {
				historicoAux.setNota40(Math.round(2 * historicoAux.getNota40()) / 2.0);
			}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarVinculoHistoricoMatriculaPeriodoTurmaDisciplina(final Integer codigoHistorico, final Integer codigoMatriculaPeriodoTurmaDisciplina, final Boolean historicoCursandoPorCorrespondenciaAposTransferencia, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set matriculaPeriodoTurmaDisciplina=?, historicoCursandoPorCorrespondenciaAposTransferencia=? " + "WHERE codigo = ? " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					if (codigoMatriculaPeriodoTurmaDisciplina != null) {
						sqlAlterar.setInt(++i, codigoMatriculaPeriodoTurmaDisciplina);
					} else {
						sqlAlterar.setNull(++i, 0);
					}
					sqlAlterar.setBoolean(++i, historicoCursandoPorCorrespondenciaAposTransferencia);
					sqlAlterar.setInt(++i, codigoHistorico);
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Override
	public HistoricoVO consultarPorMatriculaPeriodoTurmaDisciplinaDadosBasicos(Integer matriculaPeriodoTurmaDisciplina, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE historico.matriculaPeriodoTurmaDisciplina = ").append(matriculaPeriodoTurmaDisciplina);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		HistoricoVO obj = new HistoricoVO();
		if (tabelaResultado.next()) {
			montarDadosBasico(obj, tabelaResultado, usuario);
		}
		return obj;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarNotasHistoricoGestaoEventoConteudoTurmaResultadoFinal(final Integer matriculaPeriodoTurmaDisciplina, final String variavelTipoNota, final Double nota, UsuarioVO usuario) throws Exception {
		try {
			final StringBuilder sb = new StringBuilder(" UPDATE Historico set ");
			sb.append(" nota").append(variavelTipoNota).append(" = ?, ");
			sb.append(" nota").append(variavelTipoNota).append("Lancada = ? ");
			sb.append(" WHERE matriculaPeriodoTurmaDisciplina = ? ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sb.toString());
					int i = 0;
					if(nota != null){
						sqlAlterar.setDouble(++i, nota);
					}else{
						sqlAlterar.setNull(++i, 0);
					}
 					sqlAlterar.setBoolean(++i, true);
					sqlAlterar.setInt(++i, matriculaPeriodoTurmaDisciplina.intValue());
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}
@Override
	public List<HistoricoVO> consultarPorMatriculaPeriodoSituacoes(Integer matriculaPeriodo, String situacoes, UsuarioVO usuario) throws Exception {
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append("where historico.situacao in ("+situacoes+") and historico.matriculaPeriodo = ?");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), matriculaPeriodo);
		return montarDadosConsultaCompleta(tabelaResultado, usuario);
	}

	@Override
	public List<HistoricoVO> consultaBasicaHistoricoAplicativo(MatriculaVO matricula, UsuarioVO usuario) throws Exception {
		if(Uteis.isAtributoPreenchido(usuario)) {
		validarUsuarioConsultarMinhasNotas(usuario);
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		}
		StringBuilder str = new StringBuilder();
		str.append(getSQLPadraoConsultaCompleta());
		str.append(" WHERE matricula.matricula = '").append(matricula.getMatricula()).append("'");
		str.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		str.append(" and (historico.historicoporequivalencia = false or historico.historicoporequivalencia is null) ");
		str.append(" and (historico.gradedisciplina is not null or historico.gradeCurricularGrupoOptativaDisciplina is not null or historico.historicodisciplinaforagrade = true or historico.gradedisciplinacomposta is not null) ");
		if (matricula.getCurso().getIntegral()) {
			str.append(" and historico.codigo = (select his.codigo from historico his where his.matricula = matricula.matricula ");
			str.append(" and ((his.gradedisciplina is not null and historico.gradedisciplina  is not null and his.gradedisciplina = historico.gradedisciplina) ");
			str.append(" or (his.gradecurriculargrupooptativadisciplina is not null and historico.gradecurriculargrupooptativadisciplina  is not null and his.gradecurriculargrupooptativadisciplina = historico.gradecurriculargrupooptativadisciplina) ");
			str.append(" or (his.gradedisciplinacomposta is not null and historico.gradedisciplinacomposta  is not null and his.gradedisciplinacomposta = historico.gradedisciplinacomposta) ");
			str.append(" or (coalesce(his.historicodisciplinaforagrade, false) and his.disciplina = disciplina.codigo) ");
			str.append(" or (coalesce(his.historicoequivalente, false) and his.mapaequivalenciadisciplinacursada = historico.mapaequivalenciadisciplinacursada) ");
			str.append(" ) order by his.dataregistro desc, case when his.situacao in ('AP', 'AA', 'CC', 'CH', 'AE', 'AB', 'CS', 'CE') then 0 else 1 end, his.codigo desc limit 1 ) ");
		}
		str.append("  ORDER BY \"configuracaoAcademico.codigo\", historico.anohistorico, historico.semestrehistorico,  case when historico.historicodisciplinafazpartecomposicao then (");
		str.append(" select gdc.ordem::VARCHAR||dis.nome from gradedisciplinacomposta gdc ");
		str.append(" inner join gradedisciplina on gradedisciplina.codigo = gdc.gradedisciplina ");
		str.append(" inner join disciplina dis on dis.codigo = gradedisciplina.disciplina ");
		str.append(" where gdc.codigo = historico.gradedisciplinacomposta ");
		str.append(" ) else case when historico.historicodisciplinacomposta then '-1'||disciplina.nome else disciplina.nome end end ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(str.toString());
		List<HistoricoVO> historicoVOs = new ArrayList<>();
		HistoricoVO obj = null;
		Map<Integer, HistoricoVO> mapHistoricoComposto = new HashMap<Integer, HistoricoVO>(0);
		Map<Integer, HistoricoVO> mapHistoricoCompostoOptativa = new HashMap<Integer, HistoricoVO>(0);
		while (tabelaResultado.next()) {
			obj = new HistoricoVO();
			montarDadosCompleto(obj, tabelaResultado, false, false, false, usuario);
			matricula.getCurso().setPeriodicidade(tabelaResultado.getString("curso.periodicidade"));
			obj.getMatricula().getCurso().setPeriodicidade(tabelaResultado.getString("curso.periodicidade"));
			obj.getMatricula().getUnidadeEnsino().setCodigo(tabelaResultado.getInt("unidadeEnsino.codigo"));
			matricula.getUnidadeEnsino().setCodigo(tabelaResultado.getInt("unidadeEnsino.codigo"));
			obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setCodigo(tabelaResultado.getInt("turma.codigo"));
			if ((Uteis.isAtributoPreenchido(obj.getGradeDisciplinaVO()) && obj.getGradeDisciplinaVO().getDisciplinaComposta()) || (Uteis.isAtributoPreenchido(obj.getGradeCurricularGrupoOptativaDisciplinaVO()) && obj.getGradeCurricularGrupoOptativaDisciplinaVO().getDisciplinaComposta())) {
				if (Uteis.isAtributoPreenchido(obj.getGradeDisciplinaVO())) {
					mapHistoricoComposto.put(obj.getGradeDisciplinaVO().getCodigo(), obj);
				} else {
					mapHistoricoCompostoOptativa.put(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), obj);
				}
			}
			if (!obj.getHistoricoDisciplinaFazParteComposicao()) {
				historicoVOs.add(obj);
			} else {
				if (Uteis.isAtributoPreenchido(tabelaResultado.getInt("gradeDisciplinaComposta.gradeDisciplina")) && mapHistoricoComposto.containsKey(tabelaResultado.getInt("gradeDisciplinaComposta.gradeDisciplina"))) {
					mapHistoricoComposto.get(tabelaResultado.getInt("gradeDisciplinaComposta.gradeDisciplina")).getListaHistorico().add(obj);
				} else if (Uteis.isAtributoPreenchido(tabelaResultado.getInt("gradeDisciplinaComposta.gradeCurricularGrupoOptativaDisciplina")) && mapHistoricoCompostoOptativa.containsKey(tabelaResultado.getInt("gradeDisciplinaComposta.gradeDisciplina"))) {
					mapHistoricoCompostoOptativa.get(tabelaResultado.getInt("gradeDisciplinaComposta.gradeCurricularGrupoOptativaDisciplina")).getListaHistorico().add(obj);
				}
			}
		}
		carregarDadosNotaConceitoHistorico(historicoVOs);
		getFacadeFactory().getHistoricoNotaParcialInterfaceFacade().carregarHistoricoNotaParcialPorHistorico(historicoVOs, Uteis.NIVELMONTARDADOS_DADOSBASICOS);
		final ConsistirException consistirException = new ConsistirException();
		ProcessarParalelismo.executar(0, historicoVOs.size(), consistirException, new ProcessarParalelismo.Processo() {
			@Override
			public void run(int i) {
				HistoricoVO obj = historicoVOs.get(i);
				try {
				carregarDadosHorarioAulaAluno(obj, obj.getMatricula().getCurso().getNivelEducacionalPosGraduacao());
				obj.setCalendarioLancamentoNotaVO(getFacadeFactory().getCalendarioLancamentoNotaFacade().consultarPorCalendarioAcademicoUtilizar(obj.getMatricula().getUnidadeEnsino().getCodigo(),
						obj.getMatriculaPeriodoTurmaDisciplina().getTurma().getCodigo(), false, obj.getMatriculaPeriodoTurmaDisciplina().getProfessor().getCodigo(),
						obj.getDisciplina().getCodigo(), obj.getConfiguracaoAcademico().getCodigo(), matricula.getCurso().getPeriodicidade(),
						obj.getAnoHistorico(), obj.getSemestreHistorico(),
						false, usuario));

					if(Uteis.isAtributoPreenchido(obj.getCalendarioLancamentoNotaVO())
							&& !obj.getCalendarioLancamentoNotaVO().getApresentarCalculoMediaFinalVisaoAluno()) {
						obj.setMediaFinal(null);
						obj.setMediaFinalConceito(null);
						obj.setMediaFinalTexto("");
					}

					if (obj.getConfiguracaoAcademico().getOcultarMediaFinalDisciplinaCasoReprovado()) {
						if (obj.getSituacao().equals(SituacaoHistorico.REPROVADO.getValor()) || obj.getSituacao().equals(SituacaoHistorico.REPROVADO_FALTA.getValor()) || obj.getSituacao().equals(SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getValor())) {
							obj.setMediaFinal(null);
							obj.setMediaFinalConceito(null);
							obj.setMediaFinalTexto("");
						}
					}

					if((Uteis.isAtributoPreenchido(obj.getCalendarioLancamentoNotaVO())
							&& !obj.getCalendarioLancamentoNotaVO().getApresentarCalculoMediaFinalVisaoAluno())
							|| !obj.getApresentarSituacaoAplicandoRegraConfiguracaoAcademica()) {
						obj.setSituacao("");
					}
				} catch (Exception e) {
					consistirException.adicionarListaMensagemErro(e.getMessage());
				}

			}
		});
		if ((matricula.getCurso().getNivelEducacionalPosGraduacao()) && (!matricula.getCurso().getConfiguracaoAcademico().getApresentarDisciplinaSemAulaProgramadaMinhasNotasVisaoAluno())) {
			for (Iterator<HistoricoVO> iterator = historicoVOs.iterator(); iterator.hasNext();) {
				HistoricoVO historicoVO = (HistoricoVO) iterator.next();
				if(historicoVO.getDataPrimeiraAula() == null){
					iterator.remove();
				}
			}
		}
		return historicoVOs;
	}

	@Override
	public List<HistoricoVO> executarMontagemListaHistoricoAlunoPorCodigoHistorico(Integer codigoHistorico, MatriculaVO matriculaVO, Integer periodoLetivo, ConfiguracaoAcademicoVO configuracaoAcademico, CursoVO cursoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, String anoSemestre, boolean trazerUltimoHistorico, Boolean validarAcesso,Boolean trazerQuantidadesDisciplinas , UsuarioVO usuario) throws Exception {
		if(validarAcesso) {
		validarUsuarioConsultarMinhasNotas(usuario);
		}
		validarDadosParaMontarListaHistorico(matriculaVO, periodoLetivo, usuario);
		final List<HistoricoVO> listaHistorico = new ArrayList<>(0);
		if (cursoVO == null) {
			cursoVO = getFacadeFactory().getCursoFacade().consultarCursoPorMatricula(matriculaVO.getMatricula(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		}
		StringBuilder str = new StringBuilder();
		str.append("SELECT historico.codigo, aula.datainicio as \"aula.datainicio\", historico.tipoHistorico, historico.situacao, historico.freguencia, historico.frequenciaTeorica, historico.frequenciaPratica, historico.dataRegistro,  ");
		str.append(" historico.utilizaNotaFinalConceito, historico.notaFinalConceito, historico.cargaHorariaDisciplina, historico.numeroAgrupamentoEquivalenciaDisciplina, ");
		str.append(" historico.apresentarAprovadoHistorico, historico.totalfalta,  historico.mediafinalconceito, ");

		str.append("historico.mediaFinal, historico.transferenciaEntradaDisciplinasAproveitadas, ");
		for(int x = 1; x<=40;x++) {
			str.append(" historico.nota").append(x).append(", ");
			str.append(" historico.nota").append(x).append("lancada, ");
			str.append(" historico.nota").append(x).append("conceito, ");
		}

		str.append("historico.updated, historico.historicoDisciplinaFazParteComposicao AS subDisciplina, anohistorico, semestrehistorico, historico.instituicao, historico.cargaHorariaCursada, historico.cidade, historico.cargaHorariaAproveitamentoDisciplina, historico.isentarMediaFinal, historico.matrizcurricular, ");
		// Dados do Configuracao Academico
		str.append(" configuracaoAcademico.codigo AS \"configuracaoAcademico.codigo\", ");


		// Dados do Matricula Periodo Turma Disciplina
		str.append(" matriculaPeriodoTurmaDisciplina.codigo AS \"matriculaPeriodoTurmaDisciplina.codigo\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Semestre
		str.append(" matriculaPeriodoTurmaDisciplina.semestre AS \"matriculaPeriodoTurmaDisciplina.semestre\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Ano
		str.append(" matriculaPeriodoTurmaDisciplina.ano AS \"matriculaPeriodoTurmaDisciplina.ano\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turma AS \"matriculaPeriodoTurmaDisciplina.turma\",  ");

		str.append(" matriculaPeriodoTurmaDisciplina.turmaTeorica AS \"matriculaPeriodoTurmaDisciplina.turmaTeorica\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turmaPratica AS \"matriculaPeriodoTurmaDisciplina.turmaPratica\",  ");
		// Dados do Turma
		str.append(" turma.codigo AS \"turma.codigo\",  ");
		str.append(" turma.identificadorTurma AS \"turma.identificadorTurma\",  ");
		str.append(" turma.turmaagrupada AS \"turma.turmaagrupada\",  ");
		// Dados do Turno
		str.append(" turno.nome AS \"turno.nome\",  ");
		// Dados da Grade Curricular
		str.append(" gradeCurricular.nome AS \"gradeCurricular.nome\", ");
		// Dados do Matricula Periodo
		str.append(" matriculaPeriodo.codigo AS \"matriculaPeriodo.codigo\", matriculaPeriodo.situacao AS \"matriculaPeriodo.situacao\", matriculaPeriodo.situacaoMatriculaPeriodo AS \"matriculaPeriodo.situacaoMatriculaPeriodo\", ");
		// Dados do Periodo Letivo
		str.append(" periodoLetivo.descricao AS \"periodoLetivo.descricao\",  ");
		str.append(" periodoLetivo.totalcargahoraria AS \"periodoLetivo.totalcargahoraria\",  ");
		// Dados da Matricula
		str.append(" matricula.matricula AS \"matricula.matricula\",  ");
		str.append(" matricula.updated AS \"matricula.updated\",  ");
		str.append(" matricula.situacao AS \"matricula.situacao\",  ");
		str.append(" matricula.situacaoFinanceira AS \"matricula.situacaoFinanceira\", matricula.canceladoFinanceiro, ");
		str.append(" matricula.gradecurricularatual AS \"matricula.gradecurricularatual\", ");
		// Dados do Curso
		str.append(" curso.codigo AS \"curso.codigo\", curso.nome AS \"curso.nome\", curso.nivelEducacional AS \"curso.nivelEducacional\", curso.periodicidade AS \"curso.periodicidade\", ");
		// Dados da Unidade Ensino
		str.append(" unidadeEnsino.codigo AS \"unidadeEnsino.codigo\", unidadeEnsino.nome AS \"unidadeEnsino.nome\", ");
		// Dados do Aluno
		str.append(" aluno.codigo AS \"aluno.codigo\", aluno.nome AS \"aluno.nome\", ");
		// Dados do Usuario
		str.append(" usuario.nome AS \"responsavel.nome\", usuario.codigo AS \"responsavel.codigo\", ");
		// Dados da Disciplina
		str.append(" disciplina.codigo AS \"disciplina.codigo\", disciplina.nome AS \"disciplina.nome\", disciplina.abreviatura as \"disciplina.abreviatura\", ");

		// DISCIPLINA COMPOSTA E EQUIVALENCIA
		str.append(" historico.historicoPorEquivalencia AS \"historico.historicoPorEquivalencia\", historico.historicoEquivalente AS \"historico.historicoEquivalente\", ");
		str.append(" historico.gradeDisciplinaComposta AS \"historico.gradeDisciplinaComposta\", ");
		str.append(" historico.historicoDisciplinaComposta AS \"historico.historicoDisciplinaComposta\", ");
		str.append(" historico.mapaEquivalenciaDisciplina AS \"historico.mapaEquivalenciaDisciplina\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaCursada AS \"historico.mapaEquivalenciaDisciplinaCursada\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaMatrizCurricular AS \"historico.mapaEquivalenciaDisciplinaMatrizCurricular\", ");

		// Dados da Grade Disciplina
		str.append(" gradedisciplina.codigo AS \"gradedisciplina.codigo\", ");
		str.append(" gradedisciplina.disciplina AS \"gradedisciplina.disciplina\", ");
		str.append(" gradedisciplina.cargaHoraria AS \"gradedisciplina.cargaHoraria\", ");
		str.append(" gradedisciplina.cargaHorariaPratica AS \"gradedisciplina.cargaHorariaPratica\", ");
		str.append(" gradedisciplina.nrCreditos AS \"gradedisciplina.nrCreditos\", ");
		str.append(" gradedisciplina.diversificada AS \"gradedisciplina.diversificada\", ");
		str.append(" gradedisciplina.disciplinaComposta AS \"gradedisciplina.disciplinaComposta\", ");
		str.append(" gradedisciplina.disciplinaEixoTematico AS \"gradedisciplina.disciplinaEixoTematico\", ");
		str.append(" gradedisciplina.horaaula AS \"gradedisciplina.horaaula\", ");
		str.append(" gradedisciplinacomposta.horaaula AS \"gradedisciplinacomposta.horaaula\", ");

		// Dados da Grade Curricular Grupo Optativa Disciplina
		// (GradeCurricularGrupoOptativaDisciplina)
		str.append(" historico.gradeCurricularGrupoOptativaDisciplina AS \"historico.gradeCurricularGrupoOptativaDisciplina\",  ");
		str.append(" historico.disciplinaReferenteAUmGrupoOptativa AS \"historico.disciplinaReferenteAUmGrupoOptativa\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.codigo AS \"gradeCurricularGrupoOptativaDisciplina.codigo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplina AS \"gradeCurricularGrupoOptativaDisciplina.disciplina\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHoraria AS \"gradeCurricularGrupoOptativaDisciplina.cargaHoraria\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.nrCreditos AS \"gradeCurricularGrupoOptativaDisciplina.nrCreditos\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.diversificada AS \"gradeCurricularGrupoOptativaDisciplina.diversificada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplinaComposta AS \"gradeCurricularGrupoOptativaDisciplina.disciplinaComposta\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.horaaula AS \"gradeCurricularGrupoOptativaDisciplina.horaaula\", ");
		str.append(" gdc.codigo as \"gdc.codigo\", gdc.disciplina  as \"gdc.disciplina\", ");
		str.append(" gcgodc.codigo as \"gcgodc.codigo\", gcgodc.disciplina  as \"gcgodc.disciplina\", ");
		str.append(" gradedisciplinacomposta.horaaula AS \"gradedisciplinacomposta.horaaula\", ");
		str.append(" gradedisciplinacomposta.codigo AS \"gradedisciplinacomposta.codigo\", ");
		str.append(" gradedisciplina.disciplina AS \"gradedisciplinacomposta.disciplina\", ");
		str.append(" gradedisciplinacomposta.cargaHoraria AS \"gradedisciplinacomposta.cargaHoraria\", ");
		str.append(" gradedisciplinacomposta.cargaHorariaPratica AS \"gradedisciplinacomposta.cargaHorariaPratica\", ");
		str.append(" gradedisciplinacomposta.cargaHorariaTeorica AS \"gradedisciplinacomposta.cargaHorariaTeorica\", ");
		str.append(" gradedisciplinacomposta.nrCreditos AS \"gradedisciplinacomposta.nrCreditos\", ");
		str.append(" gradedisciplinacomposta.grupoOptativa AS \"gradedisciplinacomposta.grupoOptativa\", ");
		str.append(" turmadisciplina.definicoestutoriaonline as definicoestutoriaonline, ");
		str.append(" null as data, ");
		str.append(" null as dataPrimeiraAula, ");
		str.append(" false as ocultardataaula, ");
		str.append(" null as \"professor.codigo\", null AS \"professor.nome\", ");
		 if(matriculaVO.getCurso().getIntegral()  && trazerQuantidadesDisciplinas) {

				str.append(" (select count(codigo)	from turmadisciplina	where	turmadisciplina.turma = turma.codigo) as qtdDisc , ");
				str.append(" (select count(codigo)	from historico	where	historico.matriculaperiodo = matriculaperiodo.codigo	and historico.matrizcurricular = gradecurricularatual ");
				str.append("    and (historico.historicoequivalente = false	or historico.historicoequivalente is null)	and historico.situacao in ('AA', 'IS', 'CC', 'CH', 'AP', 'AE', 'CE', 'CO', 'AD', 'AB')) as qtdDiscCursada , ");

			}
		str.append(" exists (select historiconota.codigo from historiconota where historiconota.historico = historico.codigo and historiconota.notarecuperacao and situacaorecuperacaonota = '").append(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO.name()).append("' limit 1) as emrecuperacao,");
		str.append(" historicodisciplinaaproveitada ");
		str.append(" FROM historico AS historico ");
		str.append(" INNER JOIN matricula on matricula.matricula = historico.matricula ");
		str.append(" INNER JOIN gradeCurricular on historico.matrizcurricular = gradeCurricular.codigo  ");
		str.append(" INNER JOIN pessoa AS \"aluno\" ON aluno.codigo = matricula.aluno ");
		str.append(" INNER JOIN disciplina on disciplina.codigo = historico.disciplina ");
		str.append(" LEFT JOIN configuracaoAcademico on configuracaoAcademico.codigo = historico.configuracaoAcademico ");
		str.append(" LEFT JOIN matriculaPeriodo on matricula.matricula = matriculaPeriodo.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		str.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		str.append(" LEFT JOIN turma on turma.codigo = case when matriculaPeriodoTurmaDisciplina.turma  is not null then matriculaPeriodoTurmaDisciplina.turma else matriculaPeriodo.turma end  ");
		str.append(" LEFT JOIN periodoLetivo on matriculaPeriodo.periodoLetivoMatricula = periodoLetivo.codigo ");
		str.append(" LEFT JOIN gradedisciplina on gradeDisciplina.codigo = historico.gradeDisciplina ");
		str.append(" LEFT JOIN gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		str.append(" left join gradedisciplina gdc on gradedisciplinacomposta.gradedisciplina is not null and gdc.codigo = gradedisciplinacomposta.gradedisciplina ");
		str.append(" left join gradeCurricularGrupoOptativaDisciplina gcgodc on gradedisciplinacomposta.gradeCurricularGrupoOptativaDisciplina is not null and gcgodc.codigo = gradedisciplinacomposta.gradeCurricularGrupoOptativaDisciplina ");
		str.append(" LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		str.append(" LEFT JOIN usuario on usuario.codigo = historico.responsavel ");
		str.append(" LEFT JOIN turno on matricula.turno = turno.codigo ");
		str.append(" LEFT JOIN unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeEnsino ");
		str.append(" LEFT JOIN curso on curso.codigo = matricula.curso ");
		str.append(" LEFT JOIN turmadisciplina on turmadisciplina.turma = matriculaPeriodoTurmaDisciplina.turma and turmadisciplina.disciplina = matriculaPeriodoTurmaDisciplina.disciplina ");
		str.append(" LEFT JOIN periodoauladisciplinaaluno(historico.codigo) as aula on aula.disciplina_codigo is not null and historico.matriculaperiodoturmadisciplina is not null ");
		str.append(" WHERE (matricula.matricula = '");
		str.append(matriculaVO.getMatricula());
		str.append("') ");
		if (matriculaVO.getCurso().getIntegral() && trazerUltimoHistorico) {
			str.append(" and historico.codigo = (select his.codigo from historico his where his.matricula = matricula.matricula ");
			str.append(" and ((his.gradedisciplina is not null and historico.gradedisciplina  is not null and his.gradedisciplina = historico.gradedisciplina) ");
			str.append(" or (his.gradecurriculargrupooptativadisciplina is not null and historico.gradecurriculargrupooptativadisciplina  is not null and his.gradecurriculargrupooptativadisciplina = historico.gradecurriculargrupooptativadisciplina) ");
			str.append(" or (his.gradedisciplinacomposta is not null and historico.gradedisciplinacomposta  is not null and his.gradedisciplinacomposta = historico.gradedisciplinacomposta) ");
			str.append(" or (coalesce(his.historicodisciplinaforagrade, false) and his.disciplina = disciplina.codigo) ");
			str.append(" or (coalesce(his.historicoequivalente, false) and his.mapaequivalenciadisciplinacursada = historico.mapaequivalenciadisciplinacursada) ");
			str.append(" ) order by his.dataregistro desc, case when his.situacao in ('AP', 'AA', 'CC', 'CH', 'AE', 'AB', 'CS', 'CE') then 0 else 1 end, his.codigo desc limit 1 ) ");
		}
		if(Uteis.isAtributoPreenchido(anoSemestre)) {
			if(anoSemestre.contains("/")) {
				str.append(" and (historico.anohistorico || '/' || historico.semestrehistorico) = '").append(anoSemestre).append("'  ");
			}else {
				str.append(" and historico.anohistorico = '").append(anoSemestre).append("'  ");
			}
		}
		if (codigoHistorico != null) {
			str.append(" AND historico.codigo = ").append(codigoHistorico);
		}
		/*
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		str.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));

		// Alteração realizada para trazer as disciplinas compostas e a mãe da
		// composição.
		str.append(" and (historico.historicoporequivalencia = false or historico.historicoporequivalencia is null) ");
		// ANTIGO CODIGO
		// str.append(" and (historico.historicodisciplinacomposta = false or historico.historicodisciplinacomposta is null) and (historico.historicoporequivalencia = false or historico.historicoporequivalencia is null) ");

		str.append(" and (historico.gradedisciplina is not null or historico.gradeCurricularGrupoOptativaDisciplina is not null or historico.historicodisciplinaforagrade = true or historico.gradedisciplinacomposta is not null) ");
		if(Uteis.isAtributoPreenchido(periodoLetivo)){
			str.append(" and periodoLetivo.codigo  = ");
			str.append(periodoLetivo);
			// str.append(" and (ptd.ano = matriculaperiodo.ano or ptd.ano is null)");
			// str.append(" and (ptd.semestre = matriculaperiodo.semestre or ptd.semestre is null)");
			str.append(" AND disciplina.codigo in (");
			str.append(" select disciplina.codigo from matriculaPeriodo  inner join historico on historico.matriculaPeriodo = matriculaPeriodo.codigo  inner join disciplina on historico.disciplina = disciplina.codigo ");
			str.append(" where  matriculaPeriodo.matricula = '").append(matriculaVO.getMatricula()).append("' and matriculaPeriodo.periodoLetivoMatricula = ").append(periodoLetivo).append(" union all  ");
			str.append(" select disciplina.codigo from matriculaPeriodo  inner join matriculaPeriodo as mpa on mpa.codigo <> matriculaPeriodo.codigo and matriculaPeriodo.periodoLetivoMatricula= mpa.periodoLetivoMatricula ");
			str.append(" and mpa.matricula = matriculaPeriodo.matricula  inner join historico on (historico.matriculaPeriodo = mpa.codigo and (historico.situacao = 'AP' or historico.situacao = 'AA'))  inner join disciplina on historico.disciplina = disciplina.codigo ");
			str.append(" where  matriculaPeriodo.matricula = '").append(matriculaVO.getMatricula()).append("' and matriculaPeriodo.periodoLetivoMatricula = ").append(periodoLetivo);
			str.append(" ) ");
		}

		str.append(" ORDER BY anohistorico, semestrehistorico, case when historico.historicodisciplinafazpartecomposicao then (");
		str.append("  select trim(replace(sem_acentos(dis.nome), ' ', ''))||gdc.ordem::VARCHAR||trim(replace(sem_acentos(disciplina.nome), ' ', '')) ");
		str.append(" from gradedisciplinacomposta gdc inner join gradedisciplina on gradedisciplina.codigo = gdc.gradedisciplina ");
		str.append(" inner join disciplina dis on dis.codigo = gradedisciplina.disciplina  where gdc.codigo = historico.gradedisciplinacomposta  ) ");
		str.append(" else case when historico.historicodisciplinacomposta then trim(replace(sem_acentos(disciplina.nome), ' ', '')) ");
		str.append(" else trim(replace(sem_acentos(disciplina.nome), ' ', '')) end  end ");
		
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(str.toString());
		while (tabelaResultado.next()) {
			HistoricoVO historicoVO = new HistoricoVO();
			montarDadosCompletoDataOrdenacaoDisciplina(historicoVO, tabelaResultado, false, usuario);
			if (historicoVO.getConfiguracaoAcademico().getCodigo().equals(0)) {
				historicoVO.setConfiguracaoAcademico(configuracaoAcademico);
			}
			historicoVO.getMatricula().getCurso().setPeriodicidade(tabelaResultado.getString("curso.periodicidade"));
			historicoVO.getMatricula().getUnidadeEnsino().setCodigo(tabelaResultado.getInt("unidadeEnsino.codigo"));
			historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurma().setCodigo(tabelaResultado.getInt("turma.codigo"));
			historicoVO.setHistoricoDisciplinaAproveitada(tabelaResultado.getBoolean("historicodisciplinaaproveitada"));
			historicoVO.getDisciplina().setAbreviatura(tabelaResultado.getString("disciplina.abreviatura"));
			historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurma().setTurmaAgrupada(tabelaResultado.getBoolean("turma.turmaagrupada"));
			if(Uteis.isAtributoPreenchido(tabelaResultado.getString("definicoestutoriaonline"))) {
				historicoVO.getMatriculaPeriodoTurmaDisciplina().setDefinicoesTutoriaOnline(DefinicoesTutoriaOnlineEnum.valueOf(tabelaResultado.getString("definicoestutoriaonline")));
			}
			historicoVO.getMatrizCurricular().setCodigo(tabelaResultado.getInt("matrizcurricular"));

			 if(matriculaVO.getCurso().getIntegral()  && trazerQuantidadesDisciplinas) {
				 historicoVO.setTotalDisciplinasCursadasPeriodoLetivo(tabelaResultado.getInt("qtdDiscCursada"));
				 historicoVO.setTotalDisciplinasPeriodoLetivo(tabelaResultado.getInt("qtdDisc"));
			 }
			 verificarCampoNuloAdicionarTextoSemNota(configuracaoAcademico, historicoVO);
			 Boolean montarDadosProfessor = historicoVO.getMatricula().getCurso().getNivelEducacionalPosGraduacao() || (Uteis.isAtributoPreenchido(usuario) && !usuario.getIsApresentarVisaoAluno() && !usuario.getIsApresentarVisaoPais());
			 if(!historicoVO.getSituacao().equals("AA") && !historicoVO.getSituacao().equals("CC") && !historicoVO.getSituacao().equals("AB") && !historicoVO.getSituacao().equals("CH") && !historicoVO.getSituacao().equals("IS")) {
				 carregarDadosHorarioAulaAluno(historicoVO, true);
			 }
			 if(Uteis.isAtributoPreenchido(historicoVO.getMatriculaPeriodoTurmaDisciplina())){
				 historicoVO.setCalendarioLancamentoNotaVO(getFacadeFactory().getCalendarioLancamentoNotaFacade().consultarPorCalendarioAcademicoUtilizar(historicoVO.getMatricula().getUnidadeEnsino().getCodigo(), historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurma().getCodigo(), historicoVO.getMatriculaPeriodoTurmaDisciplina().getTurma().getTurmaAgrupada(), historicoVO.getMatriculaPeriodoTurmaDisciplina().getProfessor().getCodigo(), historicoVO.getDisciplina().getCodigo(), historicoVO.getConfiguracaoAcademico().getCodigo(), historicoVO.getMatricula().getCurso().getPeriodicidade(), historicoVO.getAnoHistorico(), historicoVO.getSemestreHistorico(), false, usuario));
				 if(!montarDadosProfessor) {
					 historicoVO.setNomeProfessor("");			
					 historicoVO.getMatriculaPeriodoTurmaDisciplina().getProfessor().setCodigo(0);
				 }
			 }
			 if ((cursoVO.getNivelEducacionalPosGraduacao()) && (configuracaoAcademico != null && !configuracaoAcademico.getApresentarDisciplinaSemAulaProgramadaMinhasNotasVisaoAluno())) {
				 if(historicoVO.getDataPrimeiraAula() == null && Uteis.isAtributoPreenchido(historicoVO.getMatriculaPeriodoTurmaDisciplina()) && (!Uteis.isAtributoPreenchido(historicoVO.getMatriculaPeriodoTurmaDisciplina().getDefinicoesTutoriaOnline()) || (Uteis.isAtributoPreenchido(historicoVO.getMatriculaPeriodoTurmaDisciplina().getDefinicoesTutoriaOnline()) && historicoVO.getMatriculaPeriodoTurmaDisciplina().getDefinicoesTutoriaOnline().equals(DefinicoesTutoriaOnlineEnum.PROGRAMACAO_DE_AULA)))){
					 // neste caso não deve listar histórico no portal do aluno
				 }else {
					 listaHistorico.add(historicoVO);
				 }
			 }else {
				 listaHistorico.add(historicoVO);
			 }
			
		}

//		getFacadeFactory().getHistoricoNotaParcialInterfaceFacade().carregarHistoricoNotaParcialPorHistorico(listaHistorico, Uteis.NIVELMONTARDADOS_DADOSBASICOS);
		carregarDadosNotaConceitoHistorico(listaHistorico);

		return listaHistorico;
	}

	@Override
	public void carregarDadosHorarioAulaAluno(HistoricoVO historicoVO, Boolean montarNomeProfessor){
//		StringBuilder sql = new StringBuilder("select ");
//		sql.append(" horario.dataTermino AS DATA, ");
//		sql.append(" horario.datainicio AS dataPrimeiraAula, ");
//		sql.append(" FALSE AS ocultardataaula, ");
//		sql.append(" horario.professor_codigo AS \"professor.codigo\", ");
//		sql.append(" horario.professor_nome AS \"professor.nome\" ");
//		sql.append(" from periodoauladisciplinaaluno(").append(historicoVO.getCodigo()).append(") as horario ");
//		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
//		if(rs.next()){
//			historicoVO.setData(rs.getDate("data"));
//			historicoVO.setDataPrimeiraAula(rs.getDate("dataprimeiraaula"));
//			historicoVO.setOcultarDataAula(rs.getBoolean("ocultardataaula"));
//			if(!Uteis.isAtributoPreenchido(historicoVO.getDataInicioAula())) {
//				historicoVO.setDataInicioAula(rs.getDate("dataPrimeiraAula"));
//			}
//			if(!Uteis.isAtributoPreenchido(historicoVO.getDataFimAula())) {
//				historicoVO.setDataFimAula(rs.getDate("data"));
//			}
//			if (montarNomeProfessor) {
//				historicoVO.setNomeProfessor(rs.getString("professor.nome"));
//				historicoVO.getMatriculaPeriodoTurmaDisciplina().getProfessor().setCodigo(rs.getInt("professor.codigo"));
//			}
//		}
	}

	public void realizarControleRecuperacaoDisciplinaComposta(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> listaHistoricoDaComposicao, Boolean alterarHistorico, UsuarioVO usuarioVO) throws Exception {
		if (historicoDisciplinaComposta.getControlaRecuperacaoDisciplinaComposta()
				&& !historicoDisciplinaComposta.getFormulaCondicaoUsoRecuperacao().trim().isEmpty()
				&& !historicoDisciplinaComposta.getFormulaCondicaoNotaRecuperadaDisciplinaComposta().trim().isEmpty()
				&& !historicoDisciplinaComposta.getVariavelNotaRecuperacao().trim().isEmpty()
				&& !historicoDisciplinaComposta.getVariavelNotaCondicaoUso().trim().isEmpty()
				&& !historicoDisciplinaComposta.getVariavelNotaCondicaoRecuperacao().trim().isEmpty()
				) {
 			historicoDisciplinaComposta.getHistoricoNotaVOs().clear();
			Boolean emRecuperacao = realizarVerificacaoRecuperacaoDisciplinaCompostaEstaEmCondicaoUso(historicoDisciplinaComposta, listaHistoricoDaComposicao);
			if (emRecuperacao != null && emRecuperacao) {
				SituacaoRecuperacaoNotaEnum situacaoRecuperacaoNotaEnum = SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO;
				Boolean recuperado = realizarVerificacaoRecuperacaoDisciplinaCompostaFoiRecuperada(historicoDisciplinaComposta, listaHistoricoDaComposicao);
				if ((recuperado == null || !recuperado) && SituacaoHistorico.getEnum(historicoDisciplinaComposta.getSituacao()).getHistoricoAprovado()) {
					recuperado = true;
				}
				if (recuperado != null) {
					situacaoRecuperacaoNotaEnum = recuperado ? SituacaoRecuperacaoNotaEnum.NOTA_RECUPERADA : SituacaoRecuperacaoNotaEnum.NOTA_NAO_RECUPERADA;
				}
				realizarCalculoNotaRecuperacaoDisciplinaComposta(historicoDisciplinaComposta, listaHistoricoDaComposicao, usuarioVO);
				realizarCriacaoHistoricoNotaRecuperacaoDisciplinaDaComposicaoBaseNaComposta(historicoDisciplinaComposta, listaHistoricoDaComposicao, situacaoRecuperacaoNotaEnum, alterarHistorico, usuarioVO);
				if (alterarHistorico) {
					for (HistoricoVO historicoVO : listaHistoricoDaComposicao) {
						getFacadeFactory().getHistoricoNotaFacade().incluirHistoricoNotaVOs(historicoVO);
					}
					getFacadeFactory().getHistoricoNotaFacade().incluirHistoricoNotaVOs(historicoDisciplinaComposta);
				}
			} else {
				String formulaUsar = historicoDisciplinaComposta.getFormulaCalculoNotaRecuperacaoDisciplinaComposta();
				if(!formulaUsar.trim().isEmpty()){
					String variavel =historicoDisciplinaComposta.getVariavelNotaRecuperacao();
					TipoNotaConceitoEnum tipoNota = historicoDisciplinaComposta.getConfiguracaoAcademico().getNumeroNotaPorVariavel(variavel);
					if (tipoNota != null) {
						UtilReflexao.invocarMetodoSetParametroNull(historicoDisciplinaComposta, "nota"+tipoNota.getNumeroNota() );
					}
				}
				historicoDisciplinaComposta.setEmRecuperacao(false);
			}
		}
	}

	private Boolean realizarVerificacaoRecuperacaoDisciplinaCompostaEstaEmCondicaoUso(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> listaHistoricoDaComposicao) throws Exception {
		String codicao = historicoDisciplinaComposta.getFormulaCondicaoUsoRecuperacao();
		String variavel = historicoDisciplinaComposta.getVariavelNotaCondicaoUso();
		String formula = realizarSubstituicaoNotasComposicaoFormulaCalculoDisciplinaComposta(historicoDisciplinaComposta, codicao, variavel, listaHistoricoDaComposicao);
		return formula.contains("null") ? null : Uteis.realizarFormulaCondicaoUso(formula);
	}

	public String realizarSubstituicaoNotasComposicaoFormulaCalculoDisciplinaComposta(HistoricoVO historicoCompostaVO, String formula, String variavel, List<HistoricoVO> listaHistoricoDaComposicao) throws Exception {
		for (HistoricoVO historicoVO : listaHistoricoDaComposicao) {
			if(formula.contains(historicoVO.getGradeDisciplinaComposta().getVariavelNota())){
				TipoNotaConceitoEnum tipoNota = historicoVO.getConfiguracaoAcademico().getNumeroNotaPorVariavel(variavel);
				if (tipoNota == null) {
					throw new Exception("Existe um erro de parametrização na variável (" + variavel + ") da nota definida no controle de recuperação da disciplina composta.");
				}
				Double nota = (Double) UtilReflexao.invocarMetodoGet(historicoVO, "nota" + tipoNota.getNumeroNota());
				if (nota == null && historicoVO.getConfiguracaoAcademico().getConsiderarCampoNuloNotaZerada()) {
					nota = 0.0;
				}
				formula = formula.replaceAll(historicoVO.getGradeDisciplinaComposta().getVariavelNota(), nota == null ? "null" : nota.toString());
			}
		}
		formula = historicoCompostaVO.getConfiguracaoAcademico().substituirVariaveisPorValor(historicoCompostaVO, listaHistoricoDaComposicao, formula);
		return formula;
	}

	private Boolean realizarVerificacaoRecuperacaoDisciplinaCompostaFoiRecuperada(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> listaHistoricoDaComposicao) throws Exception {
		String formulaUsar = historicoDisciplinaComposta.getFormulaCondicaoNotaRecuperadaDisciplinaComposta();
		for (HistoricoVO historicoVO : listaHistoricoDaComposicao) {
			String variavel = historicoDisciplinaComposta.getVariavelNotaRecuperacao();
			if(formulaUsar.contains(historicoVO.getGradeDisciplinaComposta().getVariavelNota())){
				TipoNotaConceitoEnum tipoNota = historicoVO.getConfiguracaoAcademico().getNumeroNotaPorVariavel(variavel);
				if (tipoNota == null) {
					throw new Exception("A variável (" + variavel + ") definida no controle de recuperação da disciplina composta não foi localizada na configuração acadêmica " + historicoVO.getConfiguracaoAcademico().getNome() + ".");
				}
				Double nota = (Double) UtilReflexao.invocarMetodoGet(historicoVO, "nota" + tipoNota.getNumeroNota());
				if (nota == null && !historicoVO.getConfiguracaoAcademico().getConsiderarCampoNuloNotaZerada()) {
					return null;
				}
			}
		}
		String variavel = historicoDisciplinaComposta.getVariavelNotaCondicaoRecuperacao();
		String formula = realizarSubstituicaoNotasComposicaoFormulaCalculoDisciplinaComposta(historicoDisciplinaComposta, formulaUsar, variavel, listaHistoricoDaComposicao);
		return formula.contains("null") ? null : Uteis.realizarFormulaCondicaoUso(formula);
	}

	public void realizarCriacaoHistoricoNotaRecuperacaoDisciplinaDaComposicaoBaseNaComposta(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> listaHistoricoDaComposicao, SituacaoRecuperacaoNotaEnum situacaoRecuperacaoNota, Boolean alterarHistorico, UsuarioVO usuarioVO) throws Exception {
		String variavel = historicoDisciplinaComposta.getVariavelNotaRecuperacao();
		TipoNotaConceitoEnum tipoNota = historicoDisciplinaComposta.getConfiguracaoAcademico().getNumeroNotaPorVariavel(variavel);
		Double nota = null;
		if (tipoNota != null) {
			ConfiguracaoAcademicaNotaVO configuracaoAcademicaNotaVO = (ConfiguracaoAcademicaNotaVO) UtilReflexao.invocarMetodoGet(historicoDisciplinaComposta.getConfiguracaoAcademico(), "configuracaoAcademicaNota" + tipoNota.getNumeroNota() + "VO");
			nota = (Double) UtilReflexao.invocarMetodoGet(historicoDisciplinaComposta, "nota" + tipoNota.getNumeroNota());
			HistoricoNotaVO historicoNotaVO = new HistoricoNotaVO();
			historicoNotaVO.getHistorico().setCodigo(historicoDisciplinaComposta.getCodigo());
			historicoNotaVO.setTipoNota(configuracaoAcademicaNotaVO.getNota());
			historicoNotaVO.setAgrupamentoNota(configuracaoAcademicaNotaVO.getAgrupamentoNota());
			historicoNotaVO.setNotaRecuperacao(true);
			historicoNotaVO.setTituloNota(configuracaoAcademicaNotaVO.getTitulo());
			historicoNotaVO.setSituacaoRecuperacaoNota(situacaoRecuperacaoNota);
			historicoNotaVO.setNotaLancada(nota);
			configuracaoAcademicaNotaVO.setNotaDigitada(historicoNotaVO.getNotaLancada());
			if (historicoDisciplinaComposta.getMediaFinal() != null && (situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO) || situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.NOTA_NAO_RECUPERADA)) && !historicoDisciplinaComposta.getSituacao().equals(SituacaoHistorico.REPROVADO_FALTA.getValor()) && !historicoDisciplinaComposta.getSituacao().equals(SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getValor())) {
				historicoDisciplinaComposta.setSituacao(SituacaoHistorico.REPROVADO.getValor());
			} else if (historicoDisciplinaComposta.getMediaFinal() != null && situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.NOTA_RECUPERADA) && !historicoDisciplinaComposta.getSituacao().equals(SituacaoHistorico.REPROVADO_FALTA.getValor()) && !historicoDisciplinaComposta.getSituacao().equals(SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getValor())) {
				historicoDisciplinaComposta.setSituacao(SituacaoHistorico.APROVADO.getValor());
			}else if(historicoDisciplinaComposta.getMediaFinal() == null) {
				historicoDisciplinaComposta.setSituacao(SituacaoHistorico.CURSANDO.getValor());
			}
			historicoDisciplinaComposta.setEmRecuperacao(situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO));
			if(historicoDisciplinaComposta.getHistoricoNotaVOs().contains(historicoNotaVO)) {
				historicoDisciplinaComposta.getHistoricoNotaVOs().set(historicoDisciplinaComposta.getHistoricoNotaVOs().indexOf(historicoNotaVO), historicoNotaVO);
			}else {
				historicoDisciplinaComposta.getHistoricoNotaVOs().add(historicoNotaVO);
			}
			if (alterarHistorico) {
				getFacadeFactory().getHistoricoNotaFacade().incluirHistoricoNotaVOs(historicoDisciplinaComposta);
			}
		} else {
			throw new Exception("A variável (" + variavel + ") definida no controle de recuperação da disciplina composta não foi localizada na configuração acadêmica " + historicoDisciplinaComposta.getConfiguracaoAcademico().getNome() + ".");
		}

		for (HistoricoVO historicoVO : listaHistoricoDaComposicao) {
			tipoNota = historicoVO.getConfiguracaoAcademico().getNumeroNotaPorVariavel(variavel);
			if (tipoNota == null) {
				throw new Exception("A variável (" + variavel + ") definida no controle de recuperação da disciplina composta não foi localizada na configuração acadêmica " + historicoVO.getConfiguracaoAcademico().getNome() + ".");
			}
			ConfiguracaoAcademicaNotaVO configuracaoAcademicaNotaVO = (ConfiguracaoAcademicaNotaVO) UtilReflexao.invocarMetodoGet(historicoVO.getConfiguracaoAcademico(), "configuracaoAcademicaNota" + tipoNota.getNumeroNota() + "VO");
			HistoricoNotaVO historicoNotaVO = new HistoricoNotaVO();
			historicoNotaVO.getHistorico().setCodigo(historicoVO.getCodigo());
			historicoNotaVO.setTipoNota(configuracaoAcademicaNotaVO.getNota());
			historicoNotaVO.setAgrupamentoNota(configuracaoAcademicaNotaVO.getAgrupamentoNota());
			historicoNotaVO.setNotaRecuperacao(true);
			historicoNotaVO.setTituloNota(configuracaoAcademicaNotaVO.getTitulo());
			historicoNotaVO.setSituacaoRecuperacaoNota(situacaoRecuperacaoNota);
			historicoNotaVO.setNotaLancada(nota);
			configuracaoAcademicaNotaVO.setNotaDigitada(historicoNotaVO.getNotaLancada());
			historicoVO.setEmRecuperacao(situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO));
			if (historicoDisciplinaComposta.getConfiguracaoAcademico().getSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal()) {
				historicoVO.setSituacao(historicoDisciplinaComposta.getSituacao());
				historicoVO.setEmRecuperacao(historicoDisciplinaComposta.getEmRecuperacao());
			} else if (historicoVO.getMediaFinal() != null && (situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO) || situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.NOTA_NAO_RECUPERADA)) && !historicoVO.getSituacao().equals(SituacaoHistorico.REPROVADO_FALTA.getValor()) && !historicoVO.getSituacao().equals(SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getValor())) {
				historicoVO.setSituacao(SituacaoHistorico.REPROVADO.getValor());
			} else if (historicoVO.getMediaFinal() != null && situacaoRecuperacaoNota.equals(SituacaoRecuperacaoNotaEnum.NOTA_RECUPERADA) && !historicoVO.getSituacao().equals(SituacaoHistorico.REPROVADO_FALTA.getValor()) && !historicoVO.getSituacao().equals(SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getValor())) {
				historicoVO.setSituacao(SituacaoHistorico.APROVADO.getValor());
			}else if(historicoVO.getMediaFinal() == null) {
				historicoVO.setSituacao(SituacaoHistorico.CURSANDO.getValor());
			}
			if(historicoVO.getHistoricoNotaVOs().contains(historicoNotaVO)) {
				historicoVO.getHistoricoNotaVOs().set(historicoVO.getHistoricoNotaVOs().indexOf(historicoNotaVO), historicoNotaVO);
			}else {
				historicoVO.getHistoricoNotaVOs().add(historicoNotaVO);
			}
			if (alterarHistorico) {
				alterarSituacaoHistoricoPorCodigo(historicoVO.getCodigo(), historicoVO.getSituacao(), usuarioVO);
				getFacadeFactory().getHistoricoNotaFacade().incluirHistoricoNotaVOs(historicoVO);
			}
		}

	}

	private static StringBuilder sqlConsultaBaseNotaConceitoHistorico;

	public static StringBuilder getSqlConsultaBaseNotaConceitoHistorico() {
		if(sqlConsultaBaseNotaConceitoHistorico == null) {
			StringBuilder str  = new StringBuilder("");
	str.append(" select historico.codigo, ");
	for(int x = 1; x<= 40; x++){
		str.append(" canc").append(x).append(".codigo as \"canc").append(x).append(".codigo\", canc").append(x).append(".conceitoNota as \"canc").append(x).append(".conceitoNota\", canc").append(x).append(".abreviaturaConceitoNota as \"canc").append(x).append(".abreviaturaConceitoNota\", canc").append(x).append(".situacao as \"canc").append(x).append(".situacao\", ");
		str.append(" canc").append(x).append(".tipoNotaConceito as \"canc").append(x).append(".tipoNotaConceito\", canc").append(x).append(".faixaNota1 as \"canc").append(x).append(".faixaNota1\", canc").append(x).append(".faixaNota2 as \"canc").append(x).append(".faixaNota2\", canc").append(x).append(".configuracaoAcademico as \"canc").append(x).append(".configuracaoAcademico\",  ");
	}
	str.append(" mfc.codigo as \"mfc.codigo\", mfc.conceitoNota as \"mfc.conceitoNota\", mfc.abreviaturaConceitoNota as \"mfc.abreviaturaConceitoNota\", mfc.situacao as \"mfc.situacao\", ");
	str.append(" mfc.tipoNotaConceito as \"mfc.tipoNotaConceito\", mfc.faixaNota1 as \"mfc.faixaNota1\", mfc.faixaNota2 as \"mfc.faixaNota2\", mfc.configuracaoAcademico as \"mfc.configuracaoAcademico\"  ");
	str.append(" from historico ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc1 on canc1.codigo = historico.nota1Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc2 on canc2.codigo = historico.nota2Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc3 on canc3.codigo = historico.nota3Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc4 on canc4.codigo = historico.nota4Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc5 on canc5.codigo = historico.nota5Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc6 on canc6.codigo = historico.nota6Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc7 on canc7.codigo = historico.nota7Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc8 on canc8.codigo = historico.nota8Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc9 on canc9.codigo = historico.nota9Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc10 on canc10.codigo = historico.nota10Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc11 on canc11.codigo = historico.nota11Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc12 on canc12.codigo = historico.nota12Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc13 on canc13.codigo = historico.nota13Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc14 on canc14.codigo = historico.nota14Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc15 on canc15.codigo = historico.nota15Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc16 on canc16.codigo = historico.nota16Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc17 on canc17.codigo = historico.nota17Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc18 on canc18.codigo = historico.nota18Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc19 on canc19.codigo = historico.nota19Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc20 on canc20.codigo = historico.nota20Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc21 on canc21.codigo = historico.nota21Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc22 on canc22.codigo = historico.nota22Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc23 on canc23.codigo = historico.nota23Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc24 on canc24.codigo = historico.nota24Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc25 on canc25.codigo = historico.nota25Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc26 on canc26.codigo = historico.nota26Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc27 on canc27.codigo = historico.nota27Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc28 on canc28.codigo = historico.nota28Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc29 on canc29.codigo = historico.nota29Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc30 on canc30.codigo = historico.nota30Conceito ");

	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc31 on canc31.codigo = historico.nota31Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc32 on canc32.codigo = historico.nota32Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc33 on canc33.codigo = historico.nota33Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc34 on canc34.codigo = historico.nota34Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc35 on canc35.codigo = historico.nota35Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc36 on canc36.codigo = historico.nota36Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc37 on canc37.codigo = historico.nota37Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc38 on canc38.codigo = historico.nota38Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc39 on canc39.codigo = historico.nota39Conceito ");
	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito canc40 on canc40.codigo = historico.nota40Conceito ");

	str.append(" LEFT JOIN configuracaoAcademicoNotaConceito mfc on mfc.codigo = historico.mediaFinalConceito ");
	str.append(" where historico.codigo = ? ");
	str.append(" and  (mfc.codigo is not null ");
	for(int x = 1; x<= 40; x++){
		str.append(" or canc").append(x).append(".codigo is not null");
	}
	str.append(" ) ");
	sqlConsultaBaseNotaConceitoHistorico = str;
		}
		return sqlConsultaBaseNotaConceitoHistorico;
	}

	@Override
	public void carregarDadosNotaConceitoHistorico(HistoricoVO historicoVO) throws Exception{
		ConfiguracaoAcademicoVO confAcad =  getAplicacaoControle().carregarDadosConfiguracaoAcademica(historicoVO.getConfiguracaoAcademico().getCodigo());
		if(Uteis.isAtributoPreenchido(confAcad) && (confAcad.getUtilizaConceitoMediaFinal() || (confAcad.getUtilizarNota1() && confAcad.getUtilizarNota1PorConceito())
			|| (confAcad.getUtilizarNota2() && confAcad.getUtilizarNota2PorConceito()) || (confAcad.getUtilizarNota3() && confAcad.getUtilizarNota3PorConceito())
			|| (confAcad.getUtilizarNota4() && confAcad.getUtilizarNota4PorConceito()) || (confAcad.getUtilizarNota5() && confAcad.getUtilizarNota5PorConceito())
			|| (confAcad.getUtilizarNota6() && confAcad.getUtilizarNota6PorConceito()) || (confAcad.getUtilizarNota7() && confAcad.getUtilizarNota7PorConceito())
			|| (confAcad.getUtilizarNota8() && confAcad.getUtilizarNota8PorConceito()) || (confAcad.getUtilizarNota9() && confAcad.getUtilizarNota9PorConceito())
			|| (confAcad.getUtilizarNota10() && confAcad.getUtilizarNota10PorConceito()) || (confAcad.getUtilizarNota11() && confAcad.getUtilizarNota11PorConceito())
			|| (confAcad.getUtilizarNota12() && confAcad.getUtilizarNota12PorConceito()) || (confAcad.getUtilizarNota13() && confAcad.getUtilizarNota13PorConceito())
			|| (confAcad.getUtilizarNota14() && confAcad.getUtilizarNota14PorConceito()) || (confAcad.getUtilizarNota15() && confAcad.getUtilizarNota15PorConceito())
			|| (confAcad.getUtilizarNota16() && confAcad.getUtilizarNota16PorConceito()) || (confAcad.getUtilizarNota17() && confAcad.getUtilizarNota17PorConceito())
			|| (confAcad.getUtilizarNota18() && confAcad.getUtilizarNota18PorConceito()) || (confAcad.getUtilizarNota19() && confAcad.getUtilizarNota19PorConceito())
			|| (confAcad.getUtilizarNota20() && confAcad.getUtilizarNota20PorConceito()) || (confAcad.getUtilizarNota21() && confAcad.getUtilizarNota21PorConceito())
			|| (confAcad.getUtilizarNota22() && confAcad.getUtilizarNota22PorConceito()) || (confAcad.getUtilizarNota23() && confAcad.getUtilizarNota23PorConceito())
			|| (confAcad.getUtilizarNota24() && confAcad.getUtilizarNota24PorConceito()) || (confAcad.getUtilizarNota25() && confAcad.getUtilizarNota25PorConceito())
			|| (confAcad.getUtilizarNota26() && confAcad.getUtilizarNota26PorConceito()) || (confAcad.getUtilizarNota27() && confAcad.getUtilizarNota27PorConceito())
			|| (confAcad.getUtilizarNota28() && confAcad.getUtilizarNota28PorConceito()) || (confAcad.getUtilizarNota29() && confAcad.getUtilizarNota29PorConceito())
			|| (confAcad.getUtilizarNota30() && confAcad.getUtilizarNota30PorConceito()) || (confAcad.getUtilizarNota31() && confAcad.getUtilizarNota31PorConceito())
			|| (confAcad.getUtilizarNota32() && confAcad.getUtilizarNota32PorConceito()) || (confAcad.getUtilizarNota33() && confAcad.getUtilizarNota33PorConceito())
			|| (confAcad.getUtilizarNota34() && confAcad.getUtilizarNota34PorConceito()) || (confAcad.getUtilizarNota35() && confAcad.getUtilizarNota35PorConceito())
			|| (confAcad.getUtilizarNota36() && confAcad.getUtilizarNota36PorConceito()) || (confAcad.getUtilizarNota37() && confAcad.getUtilizarNota37PorConceito())
			|| (confAcad.getUtilizarNota38() && confAcad.getUtilizarNota38PorConceito()) || (confAcad.getUtilizarNota39() && confAcad.getUtilizarNota39PorConceito())
			|| (confAcad.getUtilizarNota40() && confAcad.getUtilizarNota40PorConceito()) )){
			
							
			for (int x = 1; x <= 40; x++) {
				if (Uteis.isAtributoPreenchido(UtilReflexao.invocarMetodoGet(historicoVO, "nota"+x+"Conceito"))) {
					ConfiguracaoAcademicoNotaConceitoVO configuracaoAcademicoNotaConceitoVO = historicoVO.getObterConfiguracaoNotaConceito(x);
					List<ConfiguracaoAcademicoNotaConceitoVO> conceitoVOs = (List<ConfiguracaoAcademicoNotaConceitoVO>) UtilReflexao.invocarMetodoGet(confAcad, "configuracaoAcademicoNota"+x+"ConceitoVOs");
					if(conceitoVOs.stream().anyMatch(c -> c.getCodigo().equals(configuracaoAcademicoNotaConceitoVO.getCodigo()))) {
						ConfiguracaoAcademicoNotaConceitoVO conceitoVO = conceitoVOs.stream().filter(c -> c.getCodigo().equals(configuracaoAcademicoNotaConceitoVO.getCodigo())).findFirst().get();
						configuracaoAcademicoNotaConceitoVO.setCodigo(conceitoVO.getCodigo());
						configuracaoAcademicoNotaConceitoVO.setNovoObj(false);
						configuracaoAcademicoNotaConceitoVO.setConfiguracaoAcademico(conceitoVO.getConfiguracaoAcademico());
						configuracaoAcademicoNotaConceitoVO.setTipoNotaConceito(conceitoVO.getTipoNotaConceito());
						configuracaoAcademicoNotaConceitoVO.setAbreviaturaConceitoNota(conceitoVO.getAbreviaturaConceitoNota());
						configuracaoAcademicoNotaConceitoVO.setSituacao(conceitoVO.getSituacao());
						configuracaoAcademicoNotaConceitoVO.setConceitoNota(conceitoVO.getConceitoNota());
						configuracaoAcademicoNotaConceitoVO.setFaixaNota1(conceitoVO.getFaixaNota1());
						configuracaoAcademicoNotaConceitoVO.setFaixaNota2(conceitoVO.getFaixaNota2());
					}
				}				
			}
			if(Uteis.isAtributoPreenchido(historicoVO.getMediaFinalConceito())){
				List<ConfiguracaoAcademicoNotaConceitoVO> conceitoVOs = confAcad.getConfiguracaoAcademicaMediaFinalConceito();
				if(conceitoVOs.stream().anyMatch(c -> c.getCodigo().equals(historicoVO.getMediaFinalConceito().getCodigo()))) {
					ConfiguracaoAcademicoNotaConceitoVO conceitoVO = conceitoVOs.stream().filter(c -> c.getCodigo().equals(historicoVO.getMediaFinalConceito().getCodigo())).findFirst().get();
					historicoVO.getMediaFinalConceito().setCodigo(conceitoVO.getCodigo());
					historicoVO.getMediaFinalConceito().setNovoObj(false);
					historicoVO.getMediaFinalConceito().setConfiguracaoAcademico(conceitoVO.getConfiguracaoAcademico());
					historicoVO.getMediaFinalConceito().setTipoNotaConceito(conceitoVO.getTipoNotaConceito());
					historicoVO.getMediaFinalConceito().setAbreviaturaConceitoNota(conceitoVO.getAbreviaturaConceitoNota());
					historicoVO.getMediaFinalConceito().setSituacao(conceitoVO.getSituacao());
					historicoVO.getMediaFinalConceito().setConceitoNota(conceitoVO.getConceitoNota());
					historicoVO.getMediaFinalConceito().setFaixaNota1(conceitoVO.getFaixaNota1());
					historicoVO.getMediaFinalConceito().setFaixaNota2(conceitoVO.getFaixaNota2());
				}
			}
		}
	}

	@Override
	public List<HistoricoVO> executarAtualizacaoDisciplinaFilhaComposicaoComBaseDisciplinaCompostaComposta(HistoricoVO historicoDisciplinaComposta, TipoAlteracaoSituacaoHistoricoEnum tipoAlteracaoSituacaoHistorico, Boolean alterarHistorico, UsuarioVO usuarioVO) throws Exception {
		List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
		if (Uteis.isAtributoPreenchido(historicoDisciplinaComposta)) {
			if(!Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getHistoricoDisciplinaFilhaComposicaoVOs())) {
				historicoVOs = getFacadeFactory().getHistoricoFacade().consultaRapidaHistoricoFazParteComposicaoPorMatriculaPorGradeCurricularPorMatriculaPeriodo(historicoDisciplinaComposta.getMatricula().getMatricula(), 0, historicoDisciplinaComposta.getMatriculaPeriodo().getCodigo(), historicoDisciplinaComposta.getMatrizCurricular().getCodigo(), historicoDisciplinaComposta.getGradeDisciplinaVO().getCodigo(), historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), false, usuarioVO);
			}else {
				historicoVOs = historicoDisciplinaComposta.getHistoricoDisciplinaFilhaComposicaoVOs();
			}
			Map<Integer, ConfiguracaoAcademicoVO> mapConf = new HashMap<Integer, ConfiguracaoAcademicoVO>(0);
			mapConf.put(historicoDisciplinaComposta.getConfiguracaoAcademico().getCodigo(), historicoDisciplinaComposta.getConfiguracaoAcademico());
			for (HistoricoVO obj : historicoVOs) {
				if(!obj.getConfiguracaoAcademico().getNivelMontarDados().equals(NivelMontarDados.TODOS)) {
					if (!mapConf.containsKey(obj.getConfiguracaoAcademico().getCodigo())) {
						mapConf.put(obj.getConfiguracaoAcademico().getCodigo(), getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(obj.getConfiguracaoAcademico().getCodigo(), usuarioVO));
					}
					obj.setConfiguracaoAcademico(mapConf.get(obj.getConfiguracaoAcademico().getCodigo()));
				}
			}
			boolean deveAtualizarDisciplinaFazParteComposicao = realizarAtualizacaoSituacaoRegraEstabelecidaComboBoxTipoAlteracaoSituacaoHistorico(historicoDisciplinaComposta, tipoAlteracaoSituacaoHistorico);
			if(deveAtualizarDisciplinaFazParteComposicao){
				realizarControleRecuperacaoDisciplinaComposta(historicoDisciplinaComposta, historicoVOs, alterarHistorico, usuarioVO);
				boolean resultado = historicoDisciplinaComposta.getConfiguracaoAcademico().substituirVariaveisFormulaPorValores(historicoDisciplinaComposta, historicoVOs, true);
				if(!resultado){
					if(!historicoDisciplinaComposta.getSituacao().equals("RF")){
						if(historicoDisciplinaComposta.getMediaFinal() != null ){
							historicoDisciplinaComposta.setSituacao("RE");
						}else{
							historicoDisciplinaComposta.setSituacao("CS");
						}
					}
				}
			}
			if (alterarHistorico) {
				if(historicoDisciplinaComposta.getConfiguracaoAcademico().getSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal()){
					if (deveAtualizarDisciplinaFazParteComposicao) {
						for(HistoricoVO historico : historicoVOs){
							historico.setSituacao(historicoDisciplinaComposta.getSituacao());
							alterarSituacaoHistoricoPorCodigo(historico.getCodigo(), historicoDisciplinaComposta.getSituacao(), usuarioVO);
						}
					}
				}
				alterar(historicoDisciplinaComposta, usuarioVO);
				if(historicoDisciplinaComposta.getConfiguracaoAcademico().getSituacaoDisciplinaQueFazParteComposicaoControladaDisciplinaPrincipal()){
					HistoricoNotaVO historicoNotaVO = null;
					if(!historicoDisciplinaComposta.getHistoricoNotaVOs().isEmpty()){
						historicoNotaVO = historicoDisciplinaComposta.getHistoricoNotaVOs().get(0);
					}
					realizarCriacaoHistoricoNotaVO(historicoDisciplinaComposta, historicoVOs);
					if(((Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getGradeDisciplinaVO().getCodigo())
							&& historicoDisciplinaComposta.getGradeDisciplinaVO().getControlarRecuperacaoPelaDisciplinaPrincipal())||
							(Uteis.isAtributoPreenchido(historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo())
									&& historicoDisciplinaComposta.getGradeCurricularGrupoOptativaDisciplinaVO().getControlarRecuperacaoPelaDisciplinaPrincipal()))
							&& historicoNotaVO != null){
						historicoDisciplinaComposta.getHistoricoNotaVOs().add(historicoNotaVO);
					}
				}
				getFacadeFactory().getHistoricoNotaFacade().incluirHistoricoNotaVOs(historicoDisciplinaComposta);

			}
		}
		return historicoVOs;
	}


	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarFaltaEFrequenciaHistorico(final  HistoricoVO historicoVO, boolean controlarAcesso, final UsuarioVO usuarioVO) throws Exception {
		Historico.alterar(getIdEntidade(), controlarAcesso, usuarioVO);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				StringBuilder sqlUpdate = new StringBuilder();
					sqlUpdate.append("UPDATE Historico set freguencia = ?, frequenciapratica = ?, frequenciateorica = ?, faltaprimeirobimestre = ?, faltasegundobimestre = ?, faltaterceirobimestre = ?, faltaquartobimestre = ?, totalfalta = ? where codigo = ? ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
					PreparedStatement sqlAlterar = arg0.prepareStatement(sqlUpdate.toString());
					int i = 1;
					sqlAlterar.setDouble(i++, historicoVO.getFreguencia());
					sqlAlterar.setDouble(i++, historicoVO.getFrequenciaPratica());
					sqlAlterar.setDouble(i++, historicoVO.getFrequenciaTeorica());
					sqlAlterar.setDouble(i++, historicoVO.getFaltaPrimeiroBimestre());
					sqlAlterar.setInt(i++, historicoVO.getFaltaSegundoBimestre());
					sqlAlterar.setInt(i++, historicoVO.getFaltaTerceiroBimestre());
					sqlAlterar.setInt(i++, historicoVO.getFaltaQuartoBimestre());
					sqlAlterar.setInt(i++, historicoVO.getTotalFalta());
					sqlAlterar.setInt(i++, historicoVO.getCodigo());
					return sqlAlterar;
				}
		});
	}

	@Override
	public List<HistoricoVO> consultarHistoricoPorMatriculaPeriodoFichaAluno(Integer matriculaPeriodo, Integer gradeCurricular, boolean consultarHistoricoDisciplinaCompostaSemFilhas, UsuarioVO usuarioVO) throws Exception{
		StringBuilder sb = new StringBuilder();
		sb.append("select distinct historico.codigo, historico.matricula, historico.matriculaperiodo, historico.freguencia, historico.mediafinal, historico.situacao, historico.anohistorico, historico.semestrehistorico, ");
		sb.append(" historico.historicodisciplinacomposta, historico.historicodisciplinafazpartecomposicao, ");
		sb.append(" disciplina.codigo AS \"disciplina.codigo\", disciplina.nome AS \"disciplina.nome\", ");
		sb.append(" turma.codigo AS \"turma.codigo\", turma.identificadorturma, disciplina.abreviatura, sem_acentos(disciplina.nome) ordenador ");
		sb.append(" from historico ");
		sb.append(" inner join matricula on matricula.matricula = historico.matricula ");
		sb.append(" inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo ");
		sb.append(" inner join disciplina on disciplina.codigo = historico.disciplina ");
		sb.append(" left join matriculaperiodoturmadisciplina mptd on mptd.codigo = historico.matriculaperiodoturmadisciplina ");
		sb.append(" left join turma on turma.codigo = mptd.turma ");

		sb.append(" where matriculaperiodo.codigo = ").append(matriculaPeriodo);
		sb.append(" AND (coalesce(matriculaperiodo.ano, '') = coalesce(historico.anohistorico, '') and coalesce(matriculaperiodo.semestre, '') = coalesce(historico.semestrehistorico, '') ) ");
		if (!Uteis.isAtributoPreenchido(gradeCurricular)) {
			sb.append(" and (").append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(consultarHistoricoDisciplinaCompostaSemFilhas)).append(" )");
		} else {
			sb.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularEspecifico(" and ", gradeCurricular));
		}
		sb.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		sb.append(consultarHistoricoDisciplinaCompostaSemFilhas ? "" : " and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		sb.append("and historico.situacao <> '").append(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor()).append("'  ");
		sb.append("and historico.situacao <> '").append(SituacaoHistorico.CURSANDO_POR_EQUIVALENCIA.getValor()).append("'  ");
		sb.append("and historico.situacao <> '").append(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getValor()).append("'  ");
		sb.append("and historico.situacao <> '").append(SituacaoHistorico.CONCESSAO_CREDITO.getValor()).append("'  ");

		sb.append(" order by ordenador ");

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<HistoricoVO> listaHistoricoVOs = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getMatricula().setMatricula(tabelaResultado.getString("matricula"));
			obj.getMatriculaPeriodo().setCodigo(tabelaResultado.getInt("matriculaPeriodo"));
			obj.setFreguencia(tabelaResultado.getDouble("freguencia"));
			obj.setMediaFinal(tabelaResultado.getDouble("mediaFinal"));
			obj.setSituacao(tabelaResultado.getString("situacao"));
			obj.setAnoHistorico(tabelaResultado.getString("anoHistorico"));
			obj.setSemestreHistorico(tabelaResultado.getString("semestreHistorico"));
			obj.setHistoricoDisciplinaComposta(tabelaResultado.getBoolean("historicoDisciplinaComposta"));
			obj.setHistoricoDisciplinaFazParteComposicao(tabelaResultado.getBoolean("historicodisciplinafazpartecomposicao"));

			obj.getDisciplina().setCodigo(tabelaResultado.getInt("disciplina.codigo"));
			String abreviaturaDisciplina = tabelaResultado.getString("abreviatura");
			obj.getDisciplina().setNome((Uteis.isAtributoPreenchido(abreviaturaDisciplina) ? abreviaturaDisciplina + " - " : "") + tabelaResultado.getString("disciplina.nome"));

			obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setCodigo(tabelaResultado.getInt("turma.codigo"));
			obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setIdentificadorTurma(tabelaResultado.getString("identificadorTurma"));
			listaHistoricoVOs.add(obj);
		}
		return listaHistoricoVOs;
	}

	@Override
	public HistoricoVO consultarPorMatriculaPeriodoTurmaDisciplinaHistoricoEquivalente(Integer matriculaPeriodoTurmaDisciplina, boolean filtroVisaoProfessor, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append("WHERE matriculaPeriodoTurmaDisciplina.codigo = ").append(matriculaPeriodoTurmaDisciplina);
		sqlStr.append(" and historico.historicoEquivalente ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		//System.out.println(sqlStr.toString());
		HistoricoVO obj = new HistoricoVO();
		if (tabelaResultado.next()) {
			montarDadosCompleto(obj, tabelaResultado, filtroVisaoProfessor, true, true, usuario);
		}
		return obj;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void removerVinculoMatriculaPeriodoTurmaDisciplinaHistoricoTransferidoMatrizCurricularAfimDePreservarOHistoricoDaMatrizAntigaCasoTenhaEquivalencia(final String matricula, final Integer matriculaPeriodoTurmaDisciplina, final Integer transferenciaMatrizCurricularMatricula, final Integer disciplina, UsuarioVO usuario) throws Exception {
		try {
			final StringBuilder sql = new StringBuilder(" UPDATE historico set matriculaPeriodoTurmaDisciplina = null, historicocursandoporcorrespondenciaapostransferencia = false where matriculaPeriodoTurmaDisciplina = ? ");
			if (!transferenciaMatrizCurricularMatricula.equals(0)) {
				sql.append(" and transferenciamatrizcurricularmatricula = ? ");
			}
			sql.append(" and disciplina = ? and matricula = ? ");
			sql.append(" and matrizcurricular != (select distinct matricula.gradecurricularatual from matricula where matricula.matricula = historico.matricula) ");
			sql.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));

			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql.toString());
					int i = 0;
					sqlAlterar.setInt(++i, matriculaPeriodoTurmaDisciplina);
					if (!transferenciaMatrizCurricularMatricula.equals(0)) {
						sqlAlterar.setInt(++i, transferenciaMatrizCurricularMatricula);
					}
					sqlAlterar.setInt(++i, disciplina);
					sqlAlterar.setString(++i, matricula);
					return sqlAlterar;
				}
			});

		} catch (Exception e) {
			throw e;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarVinculoHistoricoCursandoTransferenciaMatrizCurricularMatricula(final Integer codigoHistorico, final Integer codigoTransferenciaMatrizCurricularMatricula, final String situacao, final Boolean historicoCursandoPorCorrespondenciaAposTransferencia, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set transferenciaMatrizCurricularMatricula=?, historicoCursandoPorCorrespondenciaAposTransferencia=?, situacao=? WHERE codigo = ? " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					if (codigoTransferenciaMatrizCurricularMatricula != null) {
						sqlAlterar.setInt(++i, codigoTransferenciaMatrizCurricularMatricula);
					} else {
						sqlAlterar.setNull(++i, 0);
					}
					sqlAlterar.setBoolean(++i, historicoCursandoPorCorrespondenciaAposTransferencia);
					sqlAlterar.setString(++i, situacao);
					sqlAlterar.setInt(++i, codigoHistorico);
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarMatriculaPeriodoTurmaDisciplina(final Integer codigoHistorico, final Integer codigoMatriculaPeriodoTurmaDisciplina, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set matriculaPeriodoTurmaDisciplina=? WHERE codigo = ? " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					if (codigoMatriculaPeriodoTurmaDisciplina != null && !codigoMatriculaPeriodoTurmaDisciplina.equals(0)) {
						sqlAlterar.setInt(++i, codigoMatriculaPeriodoTurmaDisciplina);
					} else {
						sqlAlterar.setNull(++i, 0);
					}
					sqlAlterar.setInt(++i, codigoHistorico);
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarEliminandoVinculoHistoricoCursandoPorCorrespondencia(final Integer codigoHistorico, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set historicocursandoporcorrespondenciaapostransferencia = false WHERE codigo = ? " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					sqlAlterar.setInt(++i, codigoHistorico);
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	public HistoricoVO consultaRapidaPorMatricula_matriculaPeriodo_Disciplina_CargaHoraria_DisciplinaSemCorrespondeciaEEquivalencia(String matricula, Integer matriculaPeriodo, Integer gradeCurricular, Integer disciplina, Integer cargaHoraria, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (historico.matricula = '").append(matricula).append("') ");
		sqlStr.append(" AND (historico.matrizCurricular = ").append(gradeCurricular).append(") ");
		if (matriculaPeriodo != 0) {
			sqlStr.append(" AND (matriculaPeriodo.codigo = ").append(matriculaPeriodo).append(") ");
		}
		if (disciplina.intValue() != 0) {
			sqlStr.append(" AND (disciplina.codigo = ").append(disciplina).append(") ");
		}
		if (cargaHoraria.intValue() != 0) {
			sqlStr.append(" AND (historico.cargaHorariaDisciplina = ").append(cargaHoraria).append(") ");
		}
		sqlStr.append(" AND (historico.historicoequivalente = false or historico.historicoequivalente is null) ");
		sqlStr.append(" AND (historico.historicoporEquivalencia = false or historico.historicoporEquivalencia is null) ");
		sqlStr.append(" AND (historico.historicocursandoporcorrespondenciaapostransferencia = false or historico.historicocursandoporcorrespondenciaapostransferencia is null) ");
		sqlStr.append(" ORDER BY historico.codigo desc");

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		HistoricoVO historicoVO = new HistoricoVO();
		montarDadosBasico(historicoVO, tabelaResultado, usuario);
		return historicoVO;
	}


	@Override
	public List<List<HistoricoVO>> realizarSeparacaoHistoricoPorPeriodicidade(List<HistoricoVO> historicoVOs, UsuarioVO usuarioVO) throws Exception{
		List<List<HistoricoVO>> listaPrincipalHistoricos =  new ArrayList<List<HistoricoVO>>(0);
		List<HistoricoVO> listaHistoricoSecundario = null;
		Map<String, List<HistoricoVO>> mapHistoricoPorAnoSemestreEConfAcademico = new HashMap<String, List<HistoricoVO>>(0);
		String anoSemestre = "";

		for (HistoricoVO historico : (List<HistoricoVO>) historicoVOs) {
			anoSemestre = historico.getAnoSemestreApresentar();
			if (!mapHistoricoPorAnoSemestreEConfAcademico.containsKey(anoSemestre)) {
				listaHistoricoSecundario = new ArrayList<HistoricoVO>(0);
				mapHistoricoPorAnoSemestreEConfAcademico.put(anoSemestre, listaHistoricoSecundario);
			}
			listaHistoricoSecundario = mapHistoricoPorAnoSemestreEConfAcademico.get(anoSemestre);
//			Boolean possuiRequerimento = getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultaRapidaReposicaoInclusaoAluno(historico.getMatricula().getMatricula(), historico.getDisciplina().getCodigo(), historico.getMatriculaPeriodoTurmaDisciplina().getCodigo());
//			if (!possuiRequerimento) {
//				historico.setPermiteMarcarReposicao(false);
//			} else {
				historico.setPermiteMarcarReposicao(true);
//			}
			if (!historico.getMatriculaPeriodoTurmaDisciplina().getCodigo().equals(0)) {
				historico.setMatriculaPeriodoTurmaDisciplina(getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarPorChavePrimaria(historico.getMatriculaPeriodoTurmaDisciplina().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO));
				getFacadeFactory().getHistoricoFacade().realizarVerificacaoEAtualizacaoFrequenciaHistoricoAluno(historico, usuarioVO);
				if (getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(historico.getMatricula().getMatricula(), 0, historico.getDisciplina().getCodigo(), 0, historico.getMatriculaPeriodoTurmaDisciplina().getSemestre(), historico.getMatriculaPeriodoTurmaDisciplina().getAno())) {
					getFacadeFactory().getHistoricoFacade().executarGeracaoFaltaPrimeiroSegundoTerceiroQuartoBimestreTotalFaltaFrequenciaHistorico(historico, historico.getConfiguracaoAcademico(), usuarioVO);
				}
			}
			getFacadeFactory().getCalendarioLancamentoNotaFacade().verificarApresentarCampoNotaVisaoAluno(historico.getCalendarioLancamentoNotaVO());
			listaHistoricoSecundario.add(historico);
		}
		SortedSet<String> keys = new TreeSet<String>();
		keys.addAll(mapHistoricoPorAnoSemestreEConfAcademico.keySet());

		for(String anoSem : keys){
			listaPrincipalHistoricos.add(mapHistoricoPorAnoSemestreEConfAcademico.get(anoSem));
		}
		Collections.reverse(listaPrincipalHistoricos);
		realizarCriacaoDescricaoNotasParciaisHistoricos(listaPrincipalHistoricos, usuarioVO);
		return listaPrincipalHistoricos;
	}

	private void realizarCriacaoDescricaoNotasParciaisHistoricos(List<List<HistoricoVO>> listHistoricoVOs, UsuarioVO usuarioVO) throws Exception{
		boolean permitirApresentarTodasNotasParametrizadasConfiguracaoAcademica = 
				verificarPermissaoFuncionalidadeUsuario(PerfilAcessoPermissaoVisaoAlunoEnum.PERMITIR_APRESENTAR_TODAS_NOTAS_PARAMETRIZADAS_CONFIGURACAO_ACADEMICA.getValor(), usuarioVO);
		for (List<HistoricoVO> historicoVOs : listHistoricoVOs) {
			realizarCriacaoDescricaoNotasParciaisHistoricoVOs(historicoVOs, permitirApresentarTodasNotasParametrizadasConfiguracaoAcademica, usuarioVO);
		}
	}

	@Override
	public void realizarCriacaoDescricaoNotasParciaisHistoricoVOs(List<HistoricoVO> historicoVOs, Boolean permitirApresentarTodasNotasParametrizadasConfiguracaoAcademica,  UsuarioVO usuarioVO) throws Exception{
		
			for (HistoricoVO historico : historicoVOs) {
				List<TurmaDisciplinaNotaTituloVO> turmaDisciplinaNotaTituloVOs = new ArrayList<TurmaDisciplinaNotaTituloVO>(); //getFacadeFactory().getTurmaDisciplinaNotaTituloFacade().consultarPorHistorico(historico, usuarioVO);
				StringBuilder notas = new StringBuilder("");
				NumberFormat nf = NumberFormat.getInstance();
				nf.setMinimumFractionDigits(historico.getConfiguracaoAcademico().getQuantidadeCasasDecimaisPermitirAposVirgula());
				Integer coluna = 1;
				for(int x = 1; x <= 40; x++){
					boolean permiteApresentarNota =  ((Boolean) UtilReflexao.invocarMetodoGet(historico.getCalendarioLancamentoNotaVO(), "apresentarNota"+x+"VisaoAluno"))
							&& ((Boolean)UtilReflexao.invocarMetodoGet(historico.getConfiguracaoAcademico(), "apresentarNota"+x))
							&& ((Boolean)UtilReflexao.invocarMetodoGet(historico.getConfiguracaoAcademico(), "utilizarNota"+x));
					boolean permiteApresentarNotaBoletim = permiteApresentarNota && ((ConfiguracaoAcademicaNotaVO)UtilReflexao.invocarMetodoGet(historico.getConfiguracaoAcademico(), "configuracaoAcademicaNota"+x+"VO")).getApresentarNotaBoletim();
					boolean permiteApresentarTodasNotasConfiguracao = permiteApresentarNota && permitirApresentarTodasNotasParametrizadasConfiguracaoAcademica;

					if (permiteApresentarTodasNotasConfiguracao || permiteApresentarNotaBoletim) {
						String titulo = ((String)UtilReflexao.invocarMetodoGet(historico.getConfiguracaoAcademico(), "tituloNotaApresentar"+x)).trim();
						if(turmaDisciplinaNotaTituloVOs != null && !turmaDisciplinaNotaTituloVOs.isEmpty()){
						for(TurmaDisciplinaNotaTituloVO tituloVO:turmaDisciplinaNotaTituloVOs){
							if(tituloVO.getNota().getNumeroNota().intValue() == x){
								if(!tituloVO.getTitulo().trim().isEmpty()){
									titulo = tituloVO.getTitulo();
								}
								break;
							}
						}
						}

						HistoricoNotaVO historicoNotaVO = new HistoricoNotaVO();
						historicoNotaVO.setTituloNota(titulo);

						if(Uteis.isAtributoPreenchido((List<HistoricoNotaParcialVO>)UtilReflexao.invocarMetodoGet(historico, "historicoNotaParcialNota"+x+"VOs"))) {
							coluna = realizarCriacaoDescricaoHistoricoNotasParciaisVOs(coluna, notas, (List<HistoricoNotaParcialVO>)UtilReflexao.invocarMetodoGet(historico, "historicoNotaParcialNota"+x+"VOs"), nf);
						}



						if(notas.length() == 0){
							notas.append("<span style=\"padding:3px 15px;text-align:center;height:40px;float:left;display:block;\">");
						}else{
							notas.append("<span style=\"padding:3px 15px;text-align:center;border-left:solid 1px #C4C0C9;float:left;height:40px;display:block;\">");
						}
						notas.append("<span>");
						notas.append("<strong><span style=\"font-size:10px;display:block;white-space: nowrap;\">").append(titulo).append("</span></strong>");
						notas.append("</span>");
						notas.append("<span style=\"font-size:10px;white-space: nowrap;\">");
						if(UtilReflexao.invocarMetodoGet(historico, "nota"+x) != null){
							if(!((Boolean)UtilReflexao.invocarMetodoGet(historico.getConfiguracaoAcademico(), "utilizarNota"+x+"PorConceito"))){
								notas.append(nf.format(Double.valueOf(UtilReflexao.invocarMetodoGet(historico, "nota"+x).toString())));
								titulo = nf.format(Double.valueOf(UtilReflexao.invocarMetodoGet(historico, "nota"+x).toString()));
							}else if(historico.getConfiguracaoAcademico().getApresentarTextoSemNotaCampoNuloHistorico()){
								notas.append(UtilReflexao.invocarMetodoGet(historico, "nota"+x+"Texto"));
								titulo = (String)UtilReflexao.invocarMetodoGet(historico, "nota"+x+"Texto");
							}else if(!historico.getConfiguracaoAcademico().getApresentarTextoSemNotaCampoNuloHistorico() && ((ConfiguracaoAcademicoNotaConceitoVO)UtilReflexao.invocarMetodoGet(historico, "nota"+x+"Conceito")).getCodigo() > 0){
								notas.append(((ConfiguracaoAcademicoNotaConceitoVO)UtilReflexao.invocarMetodoGet(historico, "nota"+x+"Conceito")).getConceitoNota());
								titulo = ((ConfiguracaoAcademicoNotaConceitoVO)UtilReflexao.invocarMetodoGet(historico, "nota"+x+"Conceito")).getConceitoNota();
							}else{
								titulo="--";
								notas.append("    ");
							}
						}else{
							titulo="--";
							notas.append("    ");
						}
						notas.append("</span>");
						notas.append("</span>");


						historicoNotaVO.setNotaApresentar(titulo);
						historicoNotaVO.setTipoNota(TipoNotaConceitoEnum.getTipoNota(x));
						historicoNotaVO.setHistoricoNotaParcialVOs((List<HistoricoNotaParcialVO>)UtilReflexao.invocarMetodoGet(historico, "historicoNotaParcialNota"+x+"VOs"));
						historico.getHistoricoNotaMobileVOs().add(historicoNotaVO);
					}
				}
				historico.setNotasDescritasAluno("<div class=\"scrollNota\" style=\"width:auto; max-width: 400px; display: flex;overflow-y: auto;\">"+notas.toString()+"</div>");
			}


		}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Boolean realizarVerificacaoAlunoReprovadoPeriodoLetivoDeAcordoConfiguracaoAcademica(Integer matriculaPeriodo, String ano, String semestre) throws Exception{
		StringBuilder sql  = new StringBuilder("");
		sql.append("	select distinct matriculaperiodo.codigo as matriculaperiodo, pl.codigo as periodoletivo, matriculaperiodo.matricula, matricula.gradecurricularatual, matriculaperiodo.ano, matriculaperiodo.semestre, ");
		sql.append("	array_to_string(array_agg(case when historico.situacao not in ('RE', 'RP', 'RF') then historico.codigo end ), ', ') as historicos ");
		sql.append("	from matricula ");
		sql.append("	inner join matriculaperiodo on matriculaperiodo.matricula = matricula.matricula");
		sql.append("	inner join curso on curso.codigo = matricula.curso");
		sql.append("	inner join configuracaoacademico on curso.configuracaoacademico = configuracaoacademico.codigo");
		sql.append("	inner join periodoletivo on periodoletivo.codigo = matriculaperiodo.periodoletivomatricula ");
		sql.append("	inner join periodoletivo pl on pl.gradecurricular = matricula.gradecurricularatual and pl.periodoletivo = periodoletivo.periodoletivo ");
		sql.append("	inner join historico on historico.matriculaperiodo = matriculaperiodo.codigo");
		sql.append("	and historico.anohistorico = matriculaperiodo.ano and historico.semestrehistorico = matriculaperiodo.semestre");
		sql.append("	where ");
		sql.append("	configuracaoacademico.reprovadoMatricularDisciplinaPeriodoLetivo ");
		sql.append("    and configuracaoacademico.numeroDisciplinaConsiderarReprovadoPeriodoLetivo > 0 ");
		sql.append("	and ((curso.periodicidade = 'AN' and matriculaperiodo.ano = '").append(ano).append("') ");
		sql.append("	or (curso.periodicidade = 'SE' and matriculaperiodo.ano = '").append(ano).append("' and matriculaperiodo.semestre = '").append(semestre).append("') ");
		sql.append("	or (curso.periodicidade = 'IN'))");
		sql.append("	and matriculaperiodo.situacaomatriculaperiodo in ('AT', 'FI', 'CO')");
		sql.append("	and (historico.historicodisciplinafazpartecomposicao is null or historico.historicodisciplinafazpartecomposicao = false)");
		sql.append("	and (historico.historicoequivalente is null or historico.historicoequivalente= false) ");
		sql.append("	and (historico.historicodisciplinaforagrade is null or historico.historicodisciplinaforagrade = false)");
		sql.append("	and (historico.gradecurriculargrupooptativadisciplina is not null or historico.gradedisciplina is not null)");
		sql.append("	and historico.matrizcurricular = matricula.gradecurricularatual ");
		sql.append("	and matriculaperiodo.codigo = ").append(matriculaPeriodo);
		sql.append("	group by matriculaperiodo.codigo ,matriculaperiodo.matricula, matricula.gradecurricularatual, matriculaperiodo.ano, matriculaperiodo.semestre, configuracaoacademico.numeroDisciplinaConsiderarReprovadoPeriodoLetivo, pl.codigo");
		sql.append("	having sum(case when historico.situacao in ('RE', 'RF') then 1 else 0 end ) >= configuracaoacademico.numeroDisciplinaConsiderarReprovadoPeriodoLetivo ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		if (tabelaResultado.next()) {
			return true;
		}
		return false;
	}

	// Caso o período letivo do aluno já tenha sido encerrado
	// o mesmo só poderá mudar a situação do histórico Reprovado no Periodo Letivo
	// caso o número de historicos reprovados seja menor que o número de disciplinas reprovadas no período letivo configurada.
	@Override
	public void realizarAlteracaoSituacaoHistoricoReprovadoPeriodoLetivoDeAcordoRegraConfiguracaoAcademica(HistoricoVO histVO, String situacaoAtual, String ano, String semestre, UsuarioVO usuarioVO) throws Exception {
		if (situacaoAtual.equals(SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getValor())) {
			Boolean alunoPermaneceReprovadoPeriodoLetivoDeAcordoConfiguracaoAcademica = realizarVerificacaoAlunoReprovadoPeriodoLetivoDeAcordoConfiguracaoAcademica(histVO.getMatriculaPeriodo().getCodigo(), ano, semestre);
			if (alunoPermaneceReprovadoPeriodoLetivoDeAcordoConfiguracaoAcademica) {
				histVO.setSituacao(SituacaoHistorico.REPROVADO_PERIODO_LETIVO.getValor());
			}
		}
	}

	public static StringBuilder getWhereAlunoCursaDisciplinaTurmaProfessor(Integer professor, String keyHistorico, String keyMatriculaPeriodoTurmaDisciplina, Boolean trazerDisciplinaComposta) {
		StringBuilder sql = new StringBuilder("");
		if(trazerDisciplinaComposta != null && trazerDisciplinaComposta){
			sql.append(" and exists (");
			sql.append(getSqlHorarioAluno_GradeDisciplinaComposta(professor, keyHistorico));
			sql.append(" union all ");
			sql.append(getSqlHorarioAluno_GrupoDisciplinaOptativaComposta(professor, keyHistorico));
			sql.append(" )");
		}else{
			sql.append(" and (exists(");
			sql.append(" select distinct his.codigo from historico his inner join matriculaperiodoturmadisciplina mptd on mptd.codigo = his.matriculaperiodoturmadisciplina ");
			sql.append(" where his.historicodisciplinafazpartecomposicao and his.codigo = ").append(keyHistorico).append(".codigo) ");
			sql.append(" or exists ( ");
			sql.append(" select distinct his.codigo from historico his inner join matriculaperiodoturmadisciplina mptd on mptd.codigo = his.matriculaperiodoturmadisciplina ");
			sql.append(" inner join turmadisciplina on turmadisciplina.turma = mptd.turma and turmadisciplina.disciplina  = mptd.disciplina ");
			sql.append(" and (turmadisciplina.definicoestutoriaonline is null or turmadisciplina.definicoestutoriaonline <> 'DINAMICA') and ").append(keyHistorico).append(".matriculaperiodoturmadisciplina = ").append(keyMatriculaPeriodoTurmaDisciplina).append(".codigo and his.codigo = ").append(keyHistorico).append(".codigo ");
			sql.append(" ) or exists (");
			sql.append(" select distinct his.codigo ");
			sql.append(" from matriculaperiodoturmadisciplina as mptd ");
			sql.append(" inner join turmadisciplina on turmadisciplina.disciplina = mptd.disciplina and turmadisciplina.definicoestutoriaonline = 'DINAMICA'");
			sql.append(" inner join disciplina as d on d.codigo = turmadisciplina.disciplina ");
			sql.append(" inner join turma as t on t.codigo = turmadisciplina.turma");
			sql.append(" inner join historico as his on his.codigo = ").append(keyHistorico).append(".codigo and mptd.codigo = his.matriculaperiodoturmadisciplina ");
			sql.append(" inner join pessoa as prof on prof.codigo = mptd.professor");
			sql.append(" where d.codigo = his.disciplina ");
			sql.append("  and ").append(keyHistorico).append(".matriculaperiodoturmadisciplina = ").append(keyMatriculaPeriodoTurmaDisciplina).append(".codigo ");
			if(Uteis.isAtributoPreenchido(professor)) {
				sql.append("  and prof.codigo = ").append(professor);
			}
			sql.append(" 	and (( t.turmaagrupada = false and mptd.turma = t.codigo) or (t.turmaagrupada and mptd.turma in (select tu.codigo from turmaagrupada as ta inner join turma as tu on tu.codigo = ta.turma where ta.turmaorigem = t.codigo)))");
			sql.append("  )");
			sql.append(" ) ");
		}
		return sql;
	}


	public static StringBuilder getSqlHorarioAulaAluno(Integer professor, String keyHistorico,
			Boolean trazerDisciplinaComposta) {
		StringBuilder sql = new StringBuilder("");
			if (trazerDisciplinaComposta == null || !trazerDisciplinaComposta) {
				sql.append(getSqlHorarioAluno_DisciplinaNormal(professor, keyHistorico));
				sql.append(" union all ");
				sql.append(getSqlHorarioAluno_DisciplinaEquivalente(professor, keyHistorico));
				sql.append(" union all ");
				sql.append(getSqlHorarioAluno_DisciplinaEquivale(professor, keyHistorico));
				sql.append(" union all ");
				sql.append(getSqlHorarioAluno_DisciplinaEAD(professor, keyHistorico));
			}
			if (trazerDisciplinaComposta != null && trazerDisciplinaComposta) {
				sql.append(getSqlHorarioAluno_GradeDisciplinaComposta(professor, keyHistorico));
				sql.append(" union all ");
				sql.append(getSqlHorarioAluno_GrupoDisciplinaOptativaComposta(professor, keyHistorico));
			}
		return sql;
	}

	public static  StringBuilder getSqlHorarioAluno_DisciplinaNormal(Integer professor, String keyHistorico){
		StringBuilder sql = new StringBuilder("");
		sql.append(" ( ");
		sql.append("  select distinct max(prof.codigo) as professor_codigo, ");
		sql.append("  array_to_string(array_agg(distinct prof.nome), ', ') as professor_nome, ");
		sql.append("  array_agg(distinct prof.codigo) as professores_codigo,");
		sql.append("  d.codigo as disciplina_codigo, d.nome as disciplina_nome ,");
		sql.append("  min(horarioturmadiaitem.data) as datainicio, max(horarioturmadiaitem.data) as datatermino , 'PRESENCIAL' as modalidadeDisciplina  ");
		sql.append("  from horarioturma  ");
		sql.append("  inner join horarioturmadia on horarioturmadia.horarioturma = horarioturma.codigo ");
		sql.append("  inner join turma as tur on tur.codigo = horarioturma.turma");
		sql.append("  inner join horarioturmadiaitem on horarioturmadiaitem.horarioturmadia = horarioturmadia.codigo");
		sql.append("  inner join pessoa as prof on prof.codigo = horarioturmadiaitem.professor");
		sql.append("  inner join disciplina as d on d.codigo = horarioturmadiaitem.disciplina");
		sql.append("  inner join historico as his on his.codigo = ").append(keyHistorico).append(".codigo");
		sql.append("  inner join matricula m on m.matricula = his.matricula");
		sql.append("  inner join curso as c on m.curso = c.codigo");
		sql.append("  inner join matriculaperiodo mp on mp.codigo = his.matriculaperiodo");
		sql.append("  left join matriculaperiodoturmadisciplina as mptd on mptd.codigo = his.matriculaperiodoturmadisciplina");
		sql.append("  where d.codigo = his.disciplina ");
		if(Uteis.isAtributoPreenchido(professor)){
			sql.append("  and prof.codigo = ").append(professor);
		}
		sql.append("  and ((c.periodicidade = 'AN' and horarioturma.anovigente = mp.ano)");
		sql.append("    or (c.periodicidade = 'SE' and horarioturma.anovigente = mp.ano and horarioturma.semestrevigente = mp.semestre)");
		sql.append("    or (c.periodicidade = 'IN')");
		sql.append("   ) ");
		sql.append(" and horarioturma.turma in (");
		sql.append(" 	select case when mptd.turmateorica is null ");
		sql.append(" 		and mptd.turmapratica is null and mptd.turma is not null then mptd.turma  ");
		sql.append(" 		else case when mp.turma is not null then mp.turma else 0 end end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmapratica is not null then mptd.turmapratica  else 0 end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmateorica is not null then mptd.turmateorica else 0 end");
		sql.append(" 	union all");
		sql.append(" 	select t.codigo from turma t");
		sql.append(" 	inner join turmaagrupada ta on ta.turmaorigem = t.codigo");
		sql.append(" 	and ta.turma in (");
		sql.append(" 		select case when mptd.turmateorica is null ");
		sql.append(" 		and mptd.turmapratica is null and mptd.turma is not null then mptd.turma  ");
		sql.append(" 		else case when mp.turma is not null then mp.turma else 0 end end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmapratica is not null then mptd.turmapratica  else 0 end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmateorica is not null then mptd.turmateorica else 0 end");
		sql.append(" 		");
		sql.append(" 	)");
		sql.append("  )");
		sql.append("  group by d.codigo, d.nome,  modalidadedisciplina");
		sql.append(" )");
		return sql;
	}


	public static  StringBuilder getSqlHorarioAluno_DisciplinaEquivalente(Integer professor, String keyHistorico){
		StringBuilder sql = new StringBuilder("");
		sql.append(" ( ");
		sql.append("  select distinct max(prof.codigo) as professor_codigo, ");
		sql.append("  array_to_string(array_agg(distinct prof.nome), ', ') as professor_nome, ");
		sql.append("  array_agg(distinct prof.codigo) as professores_codigo,");
		sql.append("  d.codigo as disciplina_codigo, d.nome as disciplina_nome ,");
		sql.append("  min(horarioturmadiaitem.data) as datainicio, max(horarioturmadiaitem.data) as datatermino , 'PRESENCIAL' as modalidadeDisciplina  ");
		sql.append("  from horarioturma  ");
		sql.append("  inner join horarioturmadia on horarioturmadia.horarioturma = horarioturma.codigo ");
		sql.append("  inner join turma as tur on tur.codigo = horarioturma.turma");
		sql.append("  inner join horarioturmadiaitem on horarioturmadiaitem.horarioturmadia = horarioturmadia.codigo");
		sql.append("  inner join pessoa as prof on prof.codigo = horarioturmadiaitem.professor");
		sql.append("  inner join disciplinaequivalente  on disciplinaequivalente.disciplina = horarioturmadiaitem.disciplina ");
		sql.append("  inner join disciplina as d on d.codigo = disciplinaequivalente.equivalente");
		sql.append("  inner join historico as his on his.codigo = ").append(keyHistorico).append(".codigo").append(" and d.codigo = his.disciplina");
		sql.append("  inner join matricula m on m.matricula = his.matricula");
		sql.append("  inner join curso as c on m.curso = c.codigo");
		sql.append("  inner join matriculaperiodo mp on mp.codigo = his.matriculaperiodo");
		sql.append("  left join matriculaperiodoturmadisciplina as mptd on mptd.codigo = his.matriculaperiodoturmadisciplina");
		sql.append("  where tur.turmaagrupada  and ");
		sql.append(" ((c.periodicidade = 'AN' and horarioturma.anovigente = mp.ano)");
		sql.append("    or (c.periodicidade = 'SE' and horarioturma.anovigente = mp.ano and horarioturma.semestrevigente = mp.semestre)");
		sql.append("    or (c.periodicidade = 'IN')");
		sql.append("   ) ");
		if(Uteis.isAtributoPreenchido(professor)){
			sql.append("  and prof.codigo = ").append(professor);
		}
		sql.append(" and horarioturma.turma in (");
		sql.append(" 	select case when mptd.turmateorica is null ");
		sql.append(" 		and mptd.turmapratica is null and mptd.turma is not null then mptd.turma  ");
		sql.append(" 		else case when mp.turma is not null then mp.turma else 0 end end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmapratica is not null then mptd.turmapratica  else 0 end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmateorica is not null then mptd.turmateorica else 0 end");
		sql.append(" 	union all");
		sql.append(" 	select t.codigo from turma t");
		sql.append(" 	inner join turmaagrupada ta on ta.turmaorigem = t.codigo");
		sql.append(" 	and ta.turma in (");
		sql.append(" 		select case when mptd.turmateorica is null ");
		sql.append(" 		and mptd.turmapratica is null and mptd.turma is not null then mptd.turma  ");
		sql.append(" 		else case when mp.turma is not null then mp.turma else 0 end end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmapratica is not null then mptd.turmapratica  else 0 end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmateorica is not null then mptd.turmateorica else 0 end");
		sql.append(" 		");
		sql.append(" 	)");
		sql.append("  )");
		sql.append("  group by d.codigo, d.nome,  modalidadedisciplina");
		sql.append(" )");
		return sql;
	}

	public static  StringBuilder getSqlHorarioAluno_DisciplinaEquivale(Integer professor, String keyHistorico){
		StringBuilder sql = new StringBuilder("");
		sql.append(" ( ");
		sql.append("  select distinct max(prof.codigo) as professor_codigo, ");
		sql.append("  array_to_string(array_agg(distinct prof.nome), ', ') as professor_nome, ");
		sql.append("  array_agg(distinct prof.codigo) as professores_codigo,");
		sql.append("  disciplina.codigo as disciplina_codigo, disciplina.nome as disciplina_nome ,");
		sql.append("  min(horarioturmadiaitem.data) as datainicio, max(horarioturmadiaitem.data) as datatermino , 'PRESENCIAL' as modalidadeDisciplina  ");
		sql.append("  from horarioturma  ");
		sql.append("  inner join horarioturmadia on horarioturmadia.horarioturma = horarioturma.codigo ");
		sql.append("  inner join turma as tur on tur.codigo = horarioturma.turma");
		sql.append("  inner join horarioturmadiaitem on horarioturmadiaitem.horarioturmadia = horarioturmadia.codigo");
		sql.append("  inner join pessoa as prof on prof.codigo = horarioturmadiaitem.professor");
		sql.append("  inner join disciplinaequivalente  on disciplinaequivalente.equivalente = horarioturmadiaitem.disciplina ");
		sql.append("  inner join disciplina as d on d.codigo = disciplinaequivalente.disciplina");
		sql.append("  inner join historico as his on his.codigo = ").append(keyHistorico).append(".codigo").append(" and d.codigo = his.disciplina");
		sql.append("  inner join matricula m on m.matricula = his.matricula");
		sql.append("  inner join curso as c on m.curso = c.codigo");
		sql.append("  inner join matriculaperiodo mp on mp.codigo = his.matriculaperiodo");
		sql.append("  left join matriculaperiodoturmadisciplina as mptd on mptd.codigo = his.matriculaperiodoturmadisciplina");
		sql.append("  where tur.turmaagrupada  and ");
		sql.append(" ((c.periodicidade = 'AN' and horarioturma.anovigente = mp.ano)");
		sql.append("    or (c.periodicidade = 'SE' and horarioturma.anovigente = mp.ano and horarioturma.semestrevigente = mp.semestre)");
		sql.append("    or (c.periodicidade = 'IN')");
		sql.append("   ) ");
		if(Uteis.isAtributoPreenchido(professor)){
			sql.append("  and prof.codigo = ").append(professor);
		}
		sql.append(" and horarioturma.turma in (");
		sql.append(" 	select case when mptd.turmateorica is null ");
		sql.append(" 		and mptd.turmapratica is null and mptd.turma is not null then mptd.turma  ");
		sql.append(" 		else case when mp.turma is not null then mp.turma else 0 end end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmapratica is not null then mptd.turmapratica  else 0 end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmateorica is not null then mptd.turmateorica else 0 end");
		sql.append(" 	union all");
		sql.append(" 	select t.codigo from turma t");
		sql.append(" 	inner join turmaagrupada ta on ta.turmaorigem = t.codigo");
		sql.append(" 	and ta.turma in (");
		sql.append(" 		select case when mptd.turmateorica is null ");
		sql.append(" 		and mptd.turmapratica is null and mptd.turma is not null then mptd.turma  ");
		sql.append(" 		else case when mp.turma is not null then mp.turma else 0 end end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmapratica is not null then mptd.turmapratica  else 0 end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmateorica is not null then mptd.turmateorica else 0 end");
		sql.append(" 		");
		sql.append(" 	)");
		sql.append("  )");
		sql.append("  group by d.codigo, d.nome,  modalidadedisciplina");
		sql.append(" )");
		return sql;
	}

	public static  StringBuilder getSqlHorarioAluno_GradeDisciplinaComposta(Integer professor, String keyHistorico){
		StringBuilder sql = new StringBuilder("");
		sql.append(" ( ");
		sql.append("  select distinct max(prof.codigo) as professor_codigo, ");
		sql.append("  array_to_string(array_agg(distinct prof.nome), ', ') as professor_nome, ");
		sql.append("  array_agg(distinct prof.codigo) as professores_codigo,");
		sql.append("  d.codigo as disciplina_codigo, d.nome as disciplina_nome ,");
		sql.append("  min(horarioturmadiaitem.data) as datainicio, max(horarioturmadiaitem.data) as datatermino , 'PRESENCIAL' as modalidadeDisciplina  ");
		sql.append("  from horarioturma  ");
		sql.append("  inner join horarioturmadia on horarioturmadia.horarioturma = horarioturma.codigo ");
		sql.append("  inner join turma as tur on tur.codigo = horarioturma.turma");
		sql.append("  inner join horarioturmadiaitem on horarioturmadiaitem.horarioturmadia = horarioturmadia.codigo");
		sql.append("  inner join pessoa as prof on prof.codigo = horarioturmadiaitem.professor");
		sql.append("  inner join gradedisciplinacomposta on gradedisciplinacomposta.disciplina = horarioturmadiaitem.disciplina ");
		sql.append("  inner join gradedisciplina on gradedisciplina.codigo = gradedisciplinacomposta.gradedisciplina ");
		sql.append("  inner join disciplina as d on d.codigo =  gradedisciplina.disciplina");
		sql.append("  inner join historico as his on his.codigo = ").append(keyHistorico).append(".codigo").append(" and gradedisciplina.codigo = his.gradedisciplina ");
		sql.append("  inner join matricula m on m.matricula = his.matricula");
		sql.append("  inner join curso as c on m.curso = c.codigo");
		sql.append("  inner join matriculaperiodo mp on mp.codigo = his.matriculaperiodo");
		sql.append("  left join matriculaperiodoturmadisciplina as mptd on mptd.matriculaperiodo = mp.codigo ");
		sql.append("  and mptd.gradedisciplinacomposta = gradedisciplinacomposta.codigo ");
		sql.append("  where ");
		sql.append(" ((c.periodicidade = 'AN' and horarioturma.anovigente = mp.ano)");
		sql.append("    or (c.periodicidade = 'SE' and horarioturma.anovigente = mp.ano and horarioturma.semestrevigente = mp.semestre)");
		sql.append("    or (c.periodicidade = 'IN')");
		sql.append("   ) ");
		if(Uteis.isAtributoPreenchido(professor)){
			sql.append("  and prof.codigo = ").append(professor);
		}
		sql.append(" and horarioturma.turma in (");
		sql.append(" 	select case when mptd.turmateorica is null ");
		sql.append(" 		and mptd.turmapratica is null and mptd.turma is not null then mptd.turma  ");
		sql.append(" 		else case when mp.turma is not null then mp.turma else 0 end end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmapratica is not null then mptd.turmapratica  else 0 end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmateorica is not null then mptd.turmateorica else 0 end");
		sql.append(" 	union all");
		sql.append(" 	select t.codigo from turma t");
		sql.append(" 	inner join turmaagrupada ta on ta.turmaorigem = t.codigo");
		sql.append(" 	and ta.turma in (");
		sql.append(" 		select case when mptd.turmateorica is null ");
		sql.append(" 		and mptd.turmapratica is null and mptd.turma is not null then mptd.turma  ");
		sql.append(" 		else case when mp.turma is not null then mp.turma else 0 end end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmapratica is not null then mptd.turmapratica  else 0 end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmateorica is not null then mptd.turmateorica else 0 end");
		sql.append(" 		");
		sql.append(" 	)");
		sql.append("  )");
		sql.append("  group by d.codigo, d.nome ");
		sql.append(" )");
		return sql;
	}


	public static  StringBuilder getSqlHorarioAluno_GrupoDisciplinaOptativaComposta(Integer professor, String keyHistorico){
		StringBuilder sql = new StringBuilder("");
		sql.append(" ( ");
		sql.append("  select distinct max(prof.codigo) as professor_codigo, ");
		sql.append("  array_to_string(array_agg(distinct prof.nome), ', ') as professor_nome, ");
		sql.append("  array_agg(distinct prof.codigo) as professores_codigo,");
		sql.append("  d.codigo as disciplina_codigo, d.nome as disciplina_nome ,");
		sql.append("  min(horarioturmadiaitem.data) as datainicio, max(horarioturmadiaitem.data) as datatermino , 'PRESENCIAL' as modalidadeDisciplina  ");
		sql.append("  from horarioturma  ");
		sql.append("  inner join horarioturmadia on horarioturmadia.horarioturma = horarioturma.codigo ");
		sql.append("  inner join turma as tur on tur.codigo = horarioturma.turma");
		sql.append("  inner join horarioturmadiaitem on horarioturmadiaitem.horarioturmadia = horarioturmadia.codigo");
		sql.append("  inner join pessoa as prof on prof.codigo = horarioturmadiaitem.professor");
		sql.append("  inner join gradedisciplinacomposta on gradedisciplinacomposta.disciplina = horarioturmadiaitem.disciplina ");
		sql.append("  inner join gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = gradedisciplinacomposta.gradecurriculargrupooptativadisciplina ");
		sql.append("  inner join disciplina as d on d.codigo =  gradecurriculargrupooptativadisciplina.disciplina");
		sql.append("  inner join historico as his on his.codigo = ").append(keyHistorico).append(".codigo").append(" and gradecurriculargrupooptativadisciplina.codigo = his.gradecurriculargrupooptativadisciplina ");
		sql.append("  inner join matricula m on m.matricula = his.matricula");
		sql.append("  inner join curso as c on m.curso = c.codigo");
		sql.append("  inner join matriculaperiodo mp on mp.codigo = his.matriculaperiodo");
		sql.append("  left join matriculaperiodoturmadisciplina as mptd on mptd.matriculaperiodo = mp.codigo ");
		sql.append("  and mptd.gradedisciplinacomposta = gradedisciplinacomposta.codigo ");
		sql.append("  where ");
		sql.append(" ((c.periodicidade = 'AN' and horarioturma.anovigente = mp.ano)");
		sql.append("    or (c.periodicidade = 'SE' and horarioturma.anovigente = mp.ano and horarioturma.semestrevigente = mp.semestre)");
		sql.append("    or (c.periodicidade = 'IN')");
		sql.append("   ) ");
		if(Uteis.isAtributoPreenchido(professor)){
			sql.append("  and prof.codigo = ").append(professor);
		}
		sql.append(" and horarioturma.turma in (");
		sql.append(" 	select case when mptd.turmateorica is null ");
		sql.append(" 		and mptd.turmapratica is null and mptd.turma is not null then mptd.turma  ");
		sql.append(" 		else case when mp.turma is not null then mp.turma else 0 end end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmapratica is not null then mptd.turmapratica  else 0 end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmateorica is not null then mptd.turmateorica else 0 end");
		sql.append(" 	union all");
		sql.append(" 	select t.codigo from turma t");
		sql.append(" 	inner join turmaagrupada ta on ta.turmaorigem = t.codigo");
		sql.append(" 	and ta.turma in (");
		sql.append(" 		select case when mptd.turmateorica is null ");
		sql.append(" 		and mptd.turmapratica is null and mptd.turma is not null then mptd.turma  ");
		sql.append(" 		else case when mp.turma is not null then mp.turma else 0 end end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmapratica is not null then mptd.turmapratica  else 0 end");
		sql.append(" 		union all");
		sql.append(" 		select case when mptd.turmateorica is not null then mptd.turmateorica else 0 end");
		sql.append(" 		");
		sql.append(" 	)");
		sql.append("  )");
		sql.append("  group by d.codigo, d.nome ");
		sql.append(" )");
		return sql;
	}

	public static  StringBuilder getSqlHorarioAluno_DisciplinaEAD(Integer professor, String keyHistorico){
		StringBuilder sql = new StringBuilder("");
		sql.append(" 	(select distinct prof.codigo as professor_codigo , prof.nome as professor_nome, array_agg(prof.codigo) as professores_codigo,");
		sql.append(" 	d.codigo as disciplina_codigo, d.nome as disciplina_nome,");
		sql.append(" 	null::date as datainicio, null::date as datatermino, 'ON_LINE' as modalidadeDisciplina");
		sql.append(" 	from matriculaperiodoturmadisciplina as mptd ");
		sql.append(" 	inner join turmadisciplina on turmadisciplina.disciplina = mptd.disciplina and turmadisciplina.definicoestutoriaonline = 'DINAMICA'");
		sql.append(" 	inner join disciplina as d on d.codigo = turmadisciplina.disciplina ");
		sql.append(" 	inner join turma as t on t.codigo = turmadisciplina.turma");
		sql.append(" 	inner join historico as his on his.codigo = ").append(keyHistorico).append(".codigo and mptd.codigo = his.matriculaperiodoturmadisciplina ");
		sql.append(" 	inner join pessoa as prof on prof.codigo = mptd.professor");
		sql.append(" 	where d.codigo = his.disciplina ");
		if(Uteis.isAtributoPreenchido(professor)){
			sql.append("  and prof.codigo = ").append(professor);
		}
		sql.append(" 	and (( t.turmaagrupada = false and mptd.turma = t.codigo) or (t.turmaagrupada and mptd.turma in (select tu.codigo from turmaagrupada as ta inner join turma as tu on tu.codigo = ta.turma where ta.turmaorigem = t.codigo)))");
		sql.append(" 	group by prof.codigo , prof.nome, d.codigo, d.nome )");






		return sql;
	}


	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public StringBuilder realizarCorrecaoLancamentoNotaEADHistorico(Integer unidadeEnsino,
	Integer curso, Integer turno, Integer turma, Integer disciplina, String ano, String semestre,
	String nivelEducacional, Integer configuracaoAcademica, String situacoesMatriculaPeriodo, UsuarioVO usuarioVO) throws Exception{
		StringBuilder log =  new StringBuilder("");

		StringBuilder sql = new StringBuilder("");
		sql.append(" 	select historico.codigo as historico, avaliacaoonline.codigo as avaliacaoonline, avaliacaoonline.variavelnotacfgpadraoavaliacaoonlinerea as variavel, ");
		sql.append(" 	configuracaoacademiconota.nota as notaconf,");
		sql.append(" 	avaliacaoonlinematricula.nota,");
		sql.append(" 	case configuracaoacademiconota.nota ");
		for(int x = 1; x <= 40 ; x++){
			sql.append(" 	when 'NOTA_").append(x).append("' then historico.nota").append(x);
		}
		sql.append(" end as notaHistorico,");
		sql.append(" 	disciplina.codigo as disciplina_codigo, ");
		sql.append(" 	disciplina.nome as disciplina, configuracaoacademico.codigo as configuracaoacademico_codigo, ");
		sql.append(" 	configuracaoacademico.nome as configuracaoacademico, matriculaperiodoturmadisciplina.conteudo,");
		sql.append(" 	conteudounidadepaginarecursoeducacional.titulo, ");
		sql.append(" 	avaliacaoonlinematricula.codigo as avaliacaoonlinematricula, ");
		sql.append(" 	matricula.matricula as matricula ");
		sql.append(" 	from avaliacaoonlinematricula  ");
		sql.append(" 	inner join matriculaperiodoturmadisciplina on matriculaperiodoturmadisciplina.codigo = avaliacaoonlinematricula.matriculaperiodoturmadisciplina");
		sql.append(" 	inner join matriculaperiodo on matriculaperiodoturmadisciplina.matriculaperiodo = matriculaperiodo.codigo ");
		sql.append(" 	inner join matricula on matricula.matricula = matriculaperiodoturmadisciplina.matricula");
		sql.append(" 	inner join curso on matricula.curso = curso.codigo ");
		sql.append(" 	inner join historico on historico.matriculaperiodoturmadisciplina = avaliacaoonlinematricula.matriculaperiodoturmadisciplina");
		sql.append(" 	inner join configuracaoacademico on historico.configuracaoacademico = configuracaoacademico.codigo");
		sql.append(" 	inner join disciplina on historico.disciplina = disciplina.codigo");
		sql.append(" 	inner join avaliacaoonline on avaliacaoonline.codigo = avaliacaoonlinematricula.avaliacaoonline");
		sql.append(" 	inner join conteudounidadepaginarecursoeducacional on conteudounidadepaginarecursoeducacional.avaliacaoonline = avaliacaoonline.codigo");
		sql.append(" 	inner join configuracaoacademiconota on configuracaoacademiconota.configuracaoacademico = configuracaoacademico.codigo");
		sql.append(" 	and configuracaoacademiconota.variavel = variavelnotacfgpadraoavaliacaoonlinerea");
		sql.append(" 	where notalancadanohistorico = false ");
		sql.append(" 	and avaliacaoonline.tipouso= 'REA'");
		sql.append(" 	and case configuracaoacademiconota.nota ");
		for(int x = 1; x <= 40 ; x++){
			sql.append(" 	when 'NOTA_").append(x).append("' then historico.nota").append(x);
		}
		sql.append(" end is null ");
		sql.append(" 	and situacaoavaliacaoonlinematricula in ('APROVADO', 'REPROVADO')");
		if(Uteis.isAtributoPreenchido(unidadeEnsino)){
			sql.append(" and matricula.unidadeensino = ").append(unidadeEnsino);
		}
		if(Uteis.isAtributoPreenchido(turno)){
			sql.append(" and matricula.turno = ").append(turno);
		}
		if(Uteis.isAtributoPreenchido(turno)){
			sql.append(" and matricula.turno = ").append(turno);
		}
		if(Uteis.isAtributoPreenchido(curso)){
			sql.append(" and matricula.curso = ").append(curso);
		}
		if(Uteis.isAtributoPreenchido(disciplina)){
			sql.append(" and matriculaperiodoturmadisciplina.disciplina = ").append(disciplina);
		}
		if(Uteis.isAtributoPreenchido(ano)){
			sql.append(" and matriculaperiodoturmadisciplina.ano = '").append(ano).append("' ");
		}
		if(Uteis.isAtributoPreenchido(semestre)){
			sql.append(" and matriculaperiodoturmadisciplina.semestre = '").append(semestre).append("' ");
		}
		if(Uteis.isAtributoPreenchido(nivelEducacional)){
			sql.append(" and curso.nivelEducacional = '").append(nivelEducacional).append("' ");
		}
		if(Uteis.isAtributoPreenchido(configuracaoAcademica)){
			sql.append(" and historico.configuracaoAcademico = ").append(configuracaoAcademica).append(" ");
		}
		if(Uteis.isAtributoPreenchido(situacoesMatriculaPeriodo)){
			sql.append(" and matriculaperiodo.situacaoMatriculaPeriodo in (").append(situacoesMatriculaPeriodo).append(") ");
		}
		if(Uteis.isAtributoPreenchido(turma)){
			sql.append(" and (matriculaperiodoturmadisciplina.turma = ").append(turma);
			sql.append(" or matriculaperiodoturmadisciplina.turmapratica = ").append(turma);
			sql.append(" or matriculaperiodoturmadisciplina.turmateorica = ").append(turma);
			sql.append(" ) ");
		}
		final SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		while(rs.next()){
			final StringBuilder sqlHis = new StringBuilder("update historico set nota");
			sqlHis.append(rs.getString("notaconf").replace("NOTA_", "")).append(" = ? ");
			sqlHis.append(" where codigo = ? ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sqlHis.toString());
					sqlAlterar.setDouble(1, rs.getDouble("nota"));
					sqlAlterar.setInt(2, rs.getInt("historico"));
					return sqlAlterar;
				}
			});


			final StringBuilder sqlAval = new StringBuilder("update avaliacaoonlinematricula set notalancadanohistorico = true ");
			sqlAval.append(" where codigo = ? ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sqlAval.toString());
					sqlAlterar.setInt(1, rs.getInt("avaliacaoonlinematricula"));
					return sqlAlterar;
				}
			});
			log.append("NOTA ").append(rs.getString("notaconf").replace("NOTA_", "")).append(" CORRIGIDA NO HISTORICO DA MATRICULA ").append(rs.getString("matricula")).append(" NA DISCIPLINA ").append(rs.getString("disciplina")).append("(").append(rs.getInt("disciplina_codigo")).append(")\n");
		}
		return log;
	}

	@Override
	public void realizarVerificacaoBloqueiNotaDisciplinaComposta (List<HistoricoVO> historicos,
			ConfiguracaoAcademicoVO configuracaoAcademicoVO,  UsuarioVO usuarioVO) throws Exception{
		configuracaoAcademicoVO.setDisciplinaComposta(false);
		configuracaoAcademicoVO.setNumeroNotaRecuperacao(0);
		configuracaoAcademicoVO.setDisciplinaCompostaConfiAcadDiferente(false);
		configuracaoAcademicoVO.setQtdeDisciplinaFilhaComposicao(0);
		if(!historicos.isEmpty() && historicos.get(0).getHistoricoDisciplinaComposta()){
			List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
			if(Uteis.isAtributoPreenchido(historicos.get(0).getHistoricoDisciplinaFilhaComposicaoVOs())) {
				historicoVOs = historicos.get(0).getHistoricoDisciplinaFilhaComposicaoVOs();
			}else {
				historicoVOs = getFacadeFactory().getHistoricoFacade().consultaRapidaHistoricoFazParteComposicaoPorMatriculaPorGradeCurricularPorMatriculaPeriodo(historicos.get(0).getMatricula().getMatricula(), historicos.get(0).getCodigo(), historicos.get(0).getMatriculaPeriodo().getCodigo(), historicos.get(0).getMatrizCurricular().getCodigo(), historicos.get(0).getGradeDisciplinaVO().getCodigo(), historicos.get(0).getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), false, usuarioVO);
			}
			if (!historicoVOs.isEmpty()) {
				configuracaoAcademicoVO.setDisciplinaComposta(true);
				configuracaoAcademicoVO.setNumeroNotaRecuperacao(historicos.get(0).getNumeroNotaRecuperacao());
				configuracaoAcademicoVO.setQtdeDisciplinaFilhaComposicao(historicoVOs.size());
				for (HistoricoVO obj : historicoVOs) {
					if (!configuracaoAcademicoVO.getCodigo().equals(obj.getConfiguracaoAcademico().getCodigo())) {
						configuracaoAcademicoVO.setDisciplinaCompostaConfiAcadDiferente(true);
						break;
					}
				}
			}
		}
	}


	private void realizarCalculoNotaRecuperacaoDisciplinaComposta(HistoricoVO historicoDisciplinaComposta, List<HistoricoVO> listaHistoricoDaComposicao, UsuarioVO usuarioVO) throws Exception {
		String formulaUsar = historicoDisciplinaComposta.getFormulaCalculoNotaRecuperacaoDisciplinaComposta();
		if(!formulaUsar.trim().isEmpty()){
			String variavel = historicoDisciplinaComposta.getVariavelNotaRecuperacao();
			TipoNotaConceitoEnum tipoNota = historicoDisciplinaComposta.getConfiguracaoAcademico().getNumeroNotaPorVariavel(variavel);
			if (tipoNota == null) {
				throw new Exception("A variável (" + variavel + ") definida no controle de recuperação da disciplina composta não foi localizada na configuração acadêmica " + historicoDisciplinaComposta.getConfiguracaoAcademico().getNome() + ".");
			}
		for (HistoricoVO historicoVO : listaHistoricoDaComposicao) {
			if(formulaUsar.contains(historicoVO.getGradeDisciplinaComposta().getVariavelNota())){
				tipoNota = historicoVO.getConfiguracaoAcademico().getNumeroNotaPorVariavel(variavel);
				if (tipoNota == null) {
					throw new Exception("A variável (" + variavel + ") definida no controle de recuperação da disciplina composta não foi localizada na configuração acadêmica " + historicoVO.getConfiguracaoAcademico().getNome() + ".");
				}
				Double nota = (Double) UtilReflexao.invocarMetodoGet(historicoVO, "nota" + tipoNota.getNumeroNota());
				if (nota == null && !historicoVO.getConfiguracaoAcademico().getConsiderarCampoNuloNotaZerada()) {
					return;
				}
			}
		}
		String formula = realizarSubstituicaoNotasComposicaoFormulaCalculoDisciplinaComposta(historicoDisciplinaComposta, formulaUsar, variavel, listaHistoricoDaComposicao);
		Double nota = Uteis.realizarCalculoFormula(formula);
		tipoNota = historicoDisciplinaComposta.getConfiguracaoAcademico().getNumeroNotaPorVariavel(variavel);
		inicializarDadosNotaDisciplinaComposta(historicoDisciplinaComposta, nota, "NOTA"+tipoNota.getNumeroNota());
		}
	}


	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarReplicacaoNota(List<HistoricoVO> historicoVOs, ConfiguracaoAcademicoVO configuracaoAcademicoVO, TipoNotaConceitoEnum tipoNotaConceitoEnum, FormaReplicarNotaOutraDisciplinaEnum formaReplicarNotaOutraDisciplina, UsuarioVO usuarioVO) throws Exception{
		if(!Uteis.isAtributoPreenchido(tipoNotaConceitoEnum)){
			throw new Exception("O campo NOTA a ser REPLICADA deve ser informada");
		}
		if(Uteis.isAtributoPreenchido(configuracaoAcademicoVO) && Uteis.isAtributoPreenchido(tipoNotaConceitoEnum) && Uteis.isAtributoPreenchido(formaReplicarNotaOutraDisciplina) && Uteis.isAtributoPreenchido(historicoVOs)){
			String variavelNota = (String) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "tituloNota"+tipoNotaConceitoEnum.getNumeroNota());
			Boolean utilizarNotaConceito = (Boolean) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "utilizarNota"+tipoNotaConceitoEnum.getNumeroNota()+"PorConceito");
			for(HistoricoVO historicoVO: historicoVOs){
				realizarReplicacaoNotaHistoricoAluno(historicoVO, utilizarNotaConceito, variavelNota, tipoNotaConceitoEnum, formaReplicarNotaOutraDisciplina, usuarioVO);
			}
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarReplicacaoNotaHistoricoAluno(final HistoricoVO historicoVO, final Boolean utilizarNotaConceito, String variavelNota, TipoNotaConceitoEnum tipoNotaConceitoEnum, FormaReplicarNotaOutraDisciplinaEnum formaReplicarNotaOutraDisciplina, final UsuarioVO usuarioVO) throws Exception{
		if (Uteis.isAtributoPreenchido(historicoVO) && Uteis.isAtributoPreenchido(tipoNotaConceitoEnum)
				&& Uteis.isAtributoPreenchido(formaReplicarNotaOutraDisciplina)
				&& Uteis.isAtributoPreenchido(variavelNota)) {
			ConfiguracaoAcademicoNotaConceitoVO configuracaoAcademicoNotaConceitoVO = null;
			if (utilizarNotaConceito) {
				configuracaoAcademicoNotaConceitoVO = (ConfiguracaoAcademicoNotaConceitoVO) UtilReflexao
						.invocarMetodoGet(historicoVO, "nota" + tipoNotaConceitoEnum.getNumeroNota() + "Conceito");
				if (Uteis.isAtributoPreenchido(configuracaoAcademicoNotaConceitoVO)) {
					configuracaoAcademicoNotaConceitoVO =  getFacadeFactory().getConfiguracaoAcademicoNotaConceitoFacade().consultarPorChavePrimaria(configuracaoAcademicoNotaConceitoVO.getCodigo());
				}
			}
			final Object nota = utilizarNotaConceito
					? Uteis.isAtributoPreenchido(configuracaoAcademicoNotaConceitoVO)
							? configuracaoAcademicoNotaConceitoVO.getFaixaNota2() : null
					: UtilReflexao.invocarMetodoGet(historicoVO, "nota" + tipoNotaConceitoEnum.getNumeroNota());
			if (formaReplicarNotaOutraDisciplina.equals(FormaReplicarNotaOutraDisciplinaEnum.TODAS)
					|| (formaReplicarNotaOutraDisciplina.equals(FormaReplicarNotaOutraDisciplinaEnum.NOTAS_LANCADAS) && nota != null)
					|| (formaReplicarNotaOutraDisciplina.equals(FormaReplicarNotaOutraDisciplinaEnum.NOTAS_NAO_LANCADAS) && nota == null)) {
				final SqlRowSet rs = consultarHistoricoAlunoReplicarNota(historicoVO, variavelNota, nota);
				while (rs.next()) {
					final StringBuilder sqlHis = new StringBuilder("update historico set nota");
					sqlHis.append(rs.getString("nota").replace("NOTA_", "")).append(" = ?, nota");
					sqlHis.append(rs.getString("nota").replace("NOTA_", "")).append("Conceito = ?");
					sqlHis.append(" where codigo = ? ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
					getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
						public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
							PreparedStatement sqlAlterar = arg0.prepareStatement(sqlHis.toString());
							if (nota == null || (rs.getBoolean("utilizarnotaporconceito") && !Uteis.isAtributoPreenchido(rs.getInt("conceito")))) {
								sqlAlterar.setNull(1, 0);
							} else {
								if(rs.getBoolean("utilizarnotaporconceito") && Uteis.isAtributoPreenchido(rs.getInt("conceito"))){
									sqlAlterar.setDouble(1, rs.getDouble("faixanota2"));
								}else if((Double) nota < rs.getDouble("faixanotamenor")){
									sqlAlterar.setDouble(1, rs.getDouble("faixanotamenor"));
								}else if((Double) nota > rs.getDouble("faixanotamaior")){
									sqlAlterar.setDouble(1, rs.getDouble("faixanotamaior"));
								}else{
									sqlAlterar.setDouble(1, (Double) nota);
								}
							}
							if (rs.getBoolean("utilizarnotaporconceito") && Uteis.isAtributoPreenchido(rs.getInt("conceito"))) {
								sqlAlterar.setInt(2, rs.getInt("conceito"));
							} else {
								sqlAlterar.setNull(2, 0);
							}
							sqlAlterar.setInt(3, rs.getInt("codigo"));
							return sqlAlterar;
						}
					});
				}
			}
		}
	}

	private SqlRowSet consultarHistoricoAlunoReplicarNota(HistoricoVO historicoVO, String variavelNota, Object nota){
		StringBuilder sql =  new StringBuilder("");
		sql.append(" select historico.codigo, historico.disciplina, configuracaoacademiconota.nota, configuracaoacademiconota.faixanotamaior , ");
		sql.append(" configuracaoacademiconota.faixanotamenor, configuracaoacademiconota.regraarredondamentonota, configuracaoacademiconota.utilizarnotaporconceito, ");
		if(nota != null){
			sql.append(" configuracaoacademiconotaconceito.codigo as conceito, configuracaoacademiconotaconceito.faixanota2  ");
		}else{
			sql.append(" null as conceito, configuracaoacademiconota.faixanotamaior as faixanota2 ");
		}
		sql.append(" from historico ");
		sql.append(" inner join matricula on matricula.matricula = historico.matricula ");
		sql.append(" inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo ");
		sql.append(" inner join matriculaperiodoturmadisciplina on matriculaperiodoturmadisciplina.codigo = historico.matriculaperiodoturmadisciplina ");
		sql.append(" inner join configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico ");
		sql.append(" inner join configuracaoacademiconota on configuracaoacademico.codigo = configuracaoacademiconota.configuracaoacademico ");
		if(nota != null){
			sql.append(" left join configuracaoacademiconotaconceito on configuracaoacademiconota.utilizarnotaporconceito and configuracaoacademiconotaconceito.configuracaoacademico = configuracaoacademico.codigo ");
			sql.append(" and configuracaoacademiconotaconceito.tiponotaconceito = configuracaoacademiconota.nota ");
			sql.append(" and configuracaoacademiconotaconceito.faixanota1 <= ").append((Double) nota);
			sql.append(" and configuracaoacademiconotaconceito.faixanota2 >= ").append((Double) nota);
		}

		sql.append(" where matricula.matricula = '").append(historicoVO.getMatricula().getMatricula()).append("' ");
		sql.append(" and historico.situacao not in ('AA', 'CC', 'CH', 'IS', 'AB') ");
		sql.append(" and matriculaperiodo.codigo = ").append(historicoVO.getMatriculaPeriodo().getCodigo());
		sql.append(" and anohistorico = '").append(historicoVO.getAnoHistorico()).append("' and semestrehistorico = '").append(historicoVO.getSemestreHistorico()).append("' ");
		sql.append(" and configuracaoacademiconota.variavel = '").append(variavelNota).append("' ");
		sql.append(" and configuracaoacademiconota.utilizarnota ");
		sql.append(" and configuracaoacademiconota.permiteReplicarNotaOutraDisciplina ");
		sql.append(" and length(trim(configuracaoacademiconota.formulacalculo)) = 0  ");
		sql.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		sql.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		return getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
	}

	public List<HistoricoVO> consultarPorMatriculaPeriodoLetivoAtualImpressaoDeclaracao(Integer codigoMatriculaPeriodo, Boolean apresentarDisciplinaComposta, Integer disciplina, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, Integer gradeCurricular) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT historico.codigo, historico.matricula, historico.disciplina, historico.nomedisciplina, historico.cargahorariadisciplina, historico.matriculaperiodoturmadisciplina, periodoletivo.descricao, historico.tipohistorico, turma.identificadorturma , historico.creditodisciplina,   ");
		sqlStr.append(" array_to_string(array( ");
			sqlStr.append(" select disc.nome from disciplinaprerequisito inner join disciplina disc on disc.codigo = disciplinaprerequisito.disciplina ");
			sqlStr.append(" and historico.gradedisciplina is not null and disciplinaprerequisito.gradedisciplina = historico.gradedisciplina ");
			sqlStr.append(" union ");
			sqlStr.append(" select disc.nome from disciplinaprerequisito inner join disciplina disc on disc.codigo = disciplinaprerequisito.disciplina ");
			sqlStr.append(" and historico.gradecurriculargrupooptativadisciplina is not null and disciplinaprerequisito.gradecurriculargrupooptativadisciplina = historico.gradecurriculargrupooptativadisciplina ");
			sqlStr.append(" ), ', ') as preRequisito, ");
			sqlStr.append("  historico.situacao, historico.dataInicioAula as \"historico.dataInicioAula\", historico.dataFimAula as \"historico.dataFimAula\" ");
		sqlStr.append("FROM Historico ");
		sqlStr.append("inner join matricula on matricula.matricula = historico.matricula  ");
		sqlStr.append("inner join curso on curso.codigo = matricula.curso ");
		sqlStr.append("inner join disciplina on disciplina.codigo = historico.disciplina ");
		sqlStr.append("inner join configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico ");
		sqlStr.append("left join matriculaperiodo ON historico.matriculaperiodo = matriculaperiodo.codigo ");
		sqlStr.append("left join periodoletivo ON case when matriculaperiodo.codigo is not null then matriculaperiodo.periodoletivomatricula else case when historico.periodoletivocursada is not null then historico.periodoletivocursada else historico.periodoletivomatrizcurricular end end  = periodoletivo.codigo ");
		sqlStr.append("left join matriculaperiodoturmadisciplina on matriculaperiodoturmadisciplina.codigo = historico.matriculaperiodoturmadisciplina ");
		sqlStr.append("left join turma on turma.codigo = matriculaperiodoturmadisciplina.turma ");
		sqlStr.append("WHERE historico.matriculaperiodo = ").append(codigoMatriculaPeriodo);
		sqlStr.append(" and ");
		if (gradeCurricular != null) {
			sqlStr.append(" ((").append(gradeCurricular).append(" = historico.matrizcurricular");
		} else {
			sqlStr.append(" ((matricula.gradecurricularatual = historico.matrizcurricular");
		}
		if (Uteis.isAtributoPreenchido(disciplina)) {
			sqlStr.append(" and historico.disciplina = ").append(disciplina);
		}
		sqlStr.append(" and historico.situacao not in ('AA', 'IS', 'CC', 'CH', 'AB')");
		sqlStr.append(" and (historico.historicocursandoporcorrespondenciaapostransferencia is null or");
		sqlStr.append(" historico.historicocursandoporcorrespondenciaapostransferencia = false)");
		sqlStr.append(" and (historico.transferenciamatrizcurricularmatricula IS NULL OR (historico.transferenciamatrizcurricularmatricula IS NOT NULL ");
		sqlStr.append(" and historico.disciplina not in (select disciplina from historico his");
		sqlStr.append(" where his.matricula = historico.matricula");
		sqlStr.append(" and his.anohistorico = historico.anohistorico");
		sqlStr.append(" and his.semestrehistorico = historico.semestrehistorico");
		sqlStr.append(" and his.disciplina = historico.disciplina");
		sqlStr.append(" and his.historicocursandoporcorrespondenciaapostransferencia");
		sqlStr.append(" and his.transferenciamatrizcurricularmatricula = historico.transferenciamatrizcurricularmatricula");
		if (gradeCurricular != null) {
			sqlStr.append(" and his.matrizcurricular != ").append(gradeCurricular).append(" limit 1");
		} else {
			sqlStr.append(" and his.matrizcurricular != matricula.gradecurricularatual limit 1");
		}
		sqlStr.append(" )))) ");

		if (gradeCurricular != null) {
			sqlStr.append(" or (").append(gradeCurricular).append(" != historico.matrizcurricular");
		} else {
			sqlStr.append(" or (matricula.gradecurricularatual != historico.matrizcurricular");
		}
		sqlStr.append(" and historico.historicocursandoporcorrespondenciaapostransferencia ");
		sqlStr.append(" and historico.transferenciamatrizcurricularmatricula IS NOT NULL ");
		sqlStr.append(" and historico.disciplina = (select disciplina from historico his");
		sqlStr.append(" where his.matricula = historico.matricula ");
		sqlStr.append(" and his.anohistorico = historico.anohistorico");
		sqlStr.append(" and his.semestrehistorico = historico.semestrehistorico");
		sqlStr.append(" and his.disciplina = historico.disciplina");
		sqlStr.append(" and his.transferenciamatrizcurricularmatricula = historico.transferenciamatrizcurricularmatricula");
		sqlStr.append(" and (his.historicocursandoporcorrespondenciaapostransferencia is null or ");
		sqlStr.append(" his.historicocursandoporcorrespondenciaapostransferencia = false)");
		if (gradeCurricular != null) {
			sqlStr.append(" and his.matrizcurricular = ").append(gradeCurricular).append(" limit 1");
		} else {
			sqlStr.append(" and his.matrizcurricular = matricula.gradecurricularatual limit 1");
		}
		sqlStr.append("  ) and historico.historicoporequivalencia = false) ");
		sqlStr.append(" OR ( ");
		if (gradeCurricular != null) {
			sqlStr.append(" ").append(gradeCurricular).append(" != historico.matrizcurricular ");
		} else {
			sqlStr.append(" matricula.gradecurricularatual != historico.matrizcurricular ");
		}

		sqlStr.append(" AND historico.historicoequivalente =  true                 ");
		sqlStr.append(" AND exists ( ");
		sqlStr.append(" select hist.codigo from historico as hist ");
		sqlStr.append(" WHERE historico.matricula = hist.matricula ");
		sqlStr.append(" and historico.mapaequivalenciadisciplina = hist.mapaequivalenciadisciplina ");
		sqlStr.append(" and hist.historicoporequivalencia = true ");
		sqlStr.append(" and hist.numeroagrupamentoequivalenciadisciplina = historico.numeroagrupamentoequivalenciadisciplina ");
		sqlStr.append(" and exists ( ");
		sqlStr.append(" SELECT his.disciplina FROM historico his ");
		sqlStr.append(" WHERE his.matricula = hist.matricula ");
		sqlStr.append(" AND his.anohistorico = hist.anohistorico ");
		sqlStr.append(" AND his.semestrehistorico = hist.semestrehistorico ");
		sqlStr.append(" AND his.disciplina = hist.disciplina ");
		sqlStr.append(" AND his.transferenciamatrizcurricularmatricula = hist.transferenciamatrizcurricularmatricula ");
		sqlStr.append(" AND (his.historicocursandoporcorrespondenciaapostransferencia IS NULL OR his.historicocursandoporcorrespondenciaapostransferencia = FALSE ) ");
		if (gradeCurricular != null) {
			sqlStr.append(" AND his.matrizcurricular = ").append(gradeCurricular).append(" ");
		} else {
			sqlStr.append(" AND his.matrizcurricular = matricula.gradecurricularatual ");
		}

		sqlStr.append(" LIMIT 1)) ");
		sqlStr.append(" ) ");
		// Essa condição OR é responsável por trazer as disciplinas que fazem parte da composição após realizar transferencia
		// de matriz curricular. Isso porque após a transferência o aluno irá cursar a disciplina na grade antiga mesmo estando
		// já realizada a transferência para nova grade. O sistema então irá trazer o histórico da matriz antiga caso não possua a mesma disciplina na nova grade.
		sqlStr.append(" or (historico.matrizcurricular = matriculaPeriodo.gradecurricular ");
		if (gradeCurricular != null) {
			sqlStr.append(" and ").append(gradeCurricular).append(" != historico.matrizcurricular ");
		} else {
			sqlStr.append(" and matricula.gradecurricularatual != historico.matrizcurricular ");
		}

		sqlStr.append(" and historico.historicodisciplinafazpartecomposicao ");
		sqlStr.append(" and historico.disciplina not in (");
		sqlStr.append(" select his.disciplina from historico his ");
		sqlStr.append(" where his.matriculaperiodo = historico.matriculaperiodo ");
		sqlStr.append(" and his.disciplina = historico.disciplina ");
		if (gradeCurricular != null) {
			sqlStr.append(" and ").append(gradeCurricular).append(" = his.matrizcurricular))	");
		} else {
			sqlStr.append(" and matricula.gradecurricularatual = his.matrizcurricular))	");
		}

		sqlStr.append(") ");


		if (apresentarDisciplinaComposta) {
			sqlStr.append(" and (historico.historicoDisciplinaComposta is null or historico.historicoDisciplinaComposta = false)");
		} else {
			sqlStr.append(" and (historico.historicoDisciplinaFazParteComposicao is null or historico.historicoDisciplinaFazParteComposicao = false)");
		}

		sqlStr.append(" and (historico.gradedisciplina is not null or historico.gradeCurricularGrupoOptativaDisciplina is not null or historico.historicoDisciplinaForaGrade = true or historico.gradedisciplinacomposta is not null)");
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false)");
		sqlStr.append("and case when curso.periodicidade = 'IN' then historico.codigo = (select his.codigo from historico his ");
		sqlStr.append("where his.matricula = matricula.matricula and his.disciplina = disciplina.codigo ");
		sqlStr.append("and his.matrizcurricular = historico.matrizcurricular order by his.dataregistro desc, case when his.situacao in ('AP', 'AA', 'CC', 'CH', 'AE', 'AB', 'CS') then 0 else 1 end, his.codigo desc limit 1) else true end ");
		sqlStr.append("ORDER BY periodoletivo.periodoletivo, disciplina.nome");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsultaMatriculaPeriodoLetivoAtual(tabelaResultado, nivelMontarDados, usuario, gradeCurricular));
	}

	public static List<HistoricoVO> montarDadosConsultaMatriculaPeriodoLetivoAtual(SqlRowSet tabelaResultado, int nivelMontarDados, UsuarioVO usuario, Integer gradeCurricular) throws Exception {
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>(0);
		while (tabelaResultado.next()) {
			vetResultado.add(montarDadosMatriculaPeriodoLetivoAtual(tabelaResultado, nivelMontarDados, usuario, gradeCurricular));
		}
		return vetResultado;
	}

	public static HistoricoVO montarDadosMatriculaPeriodoLetivoAtual(SqlRowSet dadosSQL, int nivelMontarDados, UsuarioVO usuario, Integer gradeCurricular) throws Exception {
		HistoricoVO obj = new HistoricoVO();
		obj.setCodigo(new Integer(dadosSQL.getInt("codigo")));
		obj.getDisciplina().setCodigo(new Integer(dadosSQL.getInt("disciplina")));
		obj.getMatricula().setMatricula(dadosSQL.getString("matricula"));
		obj.setCargaHorariaDisciplina(dadosSQL.getInt("cargahorariadisciplina"));
		obj.setNomeDisciplina(dadosSQL.getString("nomedisciplina"));
		obj.getMatriculaPeriodoTurmaDisciplina().setCodigo(dadosSQL.getInt("matriculaperiodoturmadisciplina"));
		obj.getPeriodoLetivoMatrizCurricular().setDescricao(dadosSQL.getString("descricao"));
		obj.setTipoHistorico(dadosSQL.getString("tipohistorico"));
		obj.getMatriculaPeriodoTurmaDisciplina().getTurma().setIdentificadorTurma(dadosSQL.getString("identificadorturma"));
		obj.getPreRequisito().getDisciplina().setNome(dadosSQL.getString("preRequisito"));
		obj.setCreditoDisciplina(dadosSQL.getInt("creditoDisciplina"));

		DisciplinaPreRequisitoVO objPre = new DisciplinaPreRequisitoVO();

		objPre.getDisciplina().setNome(dadosSQL.getString("preRequisito"));

		obj.setSituacao(dadosSQL.getString("situacao"));

		obj.setDataInicioAula(dadosSQL.getDate("historico.dataInicioAula"));
		obj.setDataFimAula(dadosSQL.getDate("historico.dataFimAula"));
		montarDadosDisciplina(obj, nivelMontarDados, usuario);
		montarDadosMatriculaPeriodoTurmaDisciplina(obj, nivelMontarDados, usuario);
		return obj;
	}

	@Override
	public List<HistoricoVO> consultarCodigoNotaFrequenciaPorParametros(String cpf, String email, Integer curso, Integer turma, Integer disciplina, String ano, String semestre, String bimestre) throws Exception {

		StringBuilder str = new StringBuilder();
		//SQL deixou de usar getConsultaCompleta para estruturar melhor e entregar performance
		
		str.append(" ");
		
		if(Uteis.isAtributoPreenchido(cpf)) {
			str.append(" WITH cte_pessoaaluno AS ( ");
			str.append(" SELECT pessoa.codigo AS pessoa FROM pessoa ");
			str.append(" WHERE replace(replace((pessoa.cpf), '.', ''), '-', '') = '").append(cpf).append("'");
			str.append(" ) ");
		}else {	
			str.append(" WITH cte_pessoaaluno AS ( ");
			str.append(" SELECT pei.pessoa FROM pessoaemailinstitucional pei ");
			str.append(" WHERE pei.email ILIKE '").append(email).append("'");
			str.append(" ) ");
		}
		
		str.append("SELECT historico.codigo, historico.anoHistorico, historico.semestreHistorico, historico.tipoHistorico, historico.instituicao, historico.situacao, historico.freguencia, historico.frequenciaTeorica, historico.frequenciaPratica, historico.dataRegistro, historico.nota1, historico.nota2, historico.cidade, historico.cargaHorariaAproveitamentoDisciplina, historico.cargahorariacursada, historico.cargaHorariaDisciplina, ");
		str.append("historico.utilizaNotaFinalConceito, historico.notaFinalConceito, historico.historicoCriterioAvaliacaoAluno, historico.criterioAvaliacao, historico.creditodisciplina,  ");
		str.append("historico.nota3, historico.nota4, historico.nota5, historico.nota6, historico.nota7, historico.nota8, historico.nota9, historico.nota10, ");
		str.append("historico.nota11, historico.nota12, historico.nota13, historico.nota14, historico.nota15, historico.nota16, ");
		str.append("historico.nota17, historico.nota18, historico.nota19, historico.nota20, historico.nota21, historico.nota22, ");
		str.append("historico.nota23, historico.nota24, historico.nota25, historico.nota26, historico.nota27, historico.nota28, ");
		str.append("historico.nota29, historico.nota30, historico.numeroagrupamentoequivalenciadisciplina, ");
		str.append("historico.mediaFinal, historico.transferenciaEntradaDisciplinasAproveitadas, historico.disciplinasAproveitadas, ");
		str.append("historico.nota1lancada, historico.nota2lancada, historico.nota3lancada, historico.nota4lancada, historico.nota5lancada, historico.nota6lancada, historico.nota7lancada, ");
		str.append("historico.nota8lancada, historico.nota9lancada, historico.nota10lancada, historico.nota11lancada, historico.nota12lancada, historico.nota13lancada, ");
		str.append("historico.nota14lancada, historico.nota15lancada, historico.nota16lancada, historico.nota17lancada, historico.nota18lancada, historico.nota19lancada, ");
		str.append("historico.nota20lancada, historico.nota21lancada, historico.nota22lancada, historico.nota23lancada, historico.nota24lancada, historico.nota25lancada, ");
		str.append("historico.nota26lancada, historico.nota27lancada, historico.nota28lancada, historico.nota29lancada, historico.nota30lancada,  ");
		str.append("historico.updated, historico.isentarMediaFinal, historico.notaFinalConceito as \"historico.notaFinalConceito\", ");

		str.append("historico.observacao AS \"historico.observacao\", historico.historicoDisciplinaAtividadeComplementar AS \"historico.historicoDisciplinaAtividadeComplementar\", ");
		str.append("historico.cargaHorariaDisciplina AS \"historico.cargaHorariaDisciplina\", historico.creditoDisciplina AS \"historico.creditoDisciplina\", ");
		str.append("historico.historicoDisciplinaOptativa AS \"historico.historicoDisciplinaOptativa\", historico.historicoDisciplinaForaGrade AS \"historico.historicoDisciplinaForaGrade\", ");
		str.append("historico.nomeDisciplina AS \"historico.nomeDisciplina\", historico.historicoDisciplinaAproveitada AS \"historico.historicoDisciplinaAproveitada\", ");
		str.append("historico.faltaPrimeiroBimestre AS \"historico.faltaPrimeiroBimestre\", historico.faltaSegundoBimestre AS \"historico.faltaSegundoBimestre\", ");
		str.append("historico.faltaTerceiroBimestre AS \"historico.faltaTerceiroBimestre\", historico.faltaQuartoBimestre AS \"historico.faltaQuartoBimestre\", ");
		str.append("historico.totalFalta AS \"historico.totalFalta\", ");
		str.append("historico.utilizaNotaFinalConceito AS \"historico.utilizaNotaFinalConceito\", ");

		str.append("historico.transferenciaMatrizCurricularMatricula AS \"historico.transferenciaMatrizCurricularMatricula\",  ");
		str.append("historico.historicoGeradoAPartirTransferenciaMatrizCurricular AS \"historico.historicoGeradoAPartirTransferenciaMatrizCurricular\",  ");
		str.append("historico.observacaoTransferenciaMatrizCurricular AS \"historico.observacaoTransferenciaMatrizCurricular\",  ");
		str.append("historico.historicoCursandoPorCorrespondenciaAposTransferencia AS \"historico.historicoCursandoPorCorrespondenciaAposTransferencia\",  ");
		// Dados da Matriz Curricular do Historico
		str.append("gradeCurricular.codigo AS \"gradeCurricular.codigo\", ");
		str.append("gradeCurricular.nome AS \"gradeCurricular.nome\", ");

		// Dados do Periodo Letivo Matriz Curricular
		str.append("periodoLetivoMatrizCurricular.codigo AS \"periodoLetivoMatrizCurricular.codigo\", ");
		str.append("periodoLetivoMatrizCurricular.descricao AS \"periodoLetivoMatrizCurricular.descricao\", ");
		str.append("periodoLetivoMatrizCurricular.periodoLetivo AS \"periodoLetivoMatrizCurricular.periodoLetivo\", ");

		// Dados da Matriz Curricular
		str.append("matrizCurricular.codigo AS \"matrizCurricular.codigo\", ");
		str.append("matrizCurricular.nome AS \"matrizCurricular.nome\", ");

		// Dados do Periodo Letivo Cursada
		str.append("periodoLetivoCursada.codigo AS \"periodoLetivoCursada.codigo\", ");
		str.append("periodoLetivoCursada.descricao AS \"periodoLetivoCursada.descricao\", ");
		str.append("periodoLetivoCursada.periodoLetivo AS \"periodoLetivoCursada.periodoLetivo\", ");

		// Dados do Configuracao Academico
		str.append(" configuracaoAcademico.codigo AS \"configuracaoAcademico.codigo\",  ");
		str.append(" configuracaoAcademico.nome AS \"configuracaoAcademico.nome\",  ");
		str.append(" configuracaoAcademico.intervaloNotasDiferente AS \"configuracaoAcademico.intervaloNotasDiferente\",  ");

		// Dados do Matricula Periodo Turma Disciplina
		str.append(" matriculaPeriodoTurmaDisciplina.codigo AS \"matriculaPeriodoTurmaDisciplina.codigo\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Semestre
		str.append(" matriculaPeriodoTurmaDisciplina.semestre AS \"matriculaPeriodoTurmaDisciplina.semestre\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Ano
		str.append(" matriculaPeriodoTurmaDisciplina.ano AS \"matriculaPeriodoTurmaDisciplina.ano\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turma AS \"matriculaPeriodoTurmaDisciplina.turma\", matriculaPeriodoTurmaDisciplina.turmaTeorica, matriculaPeriodoTurmaDisciplina.turmaPratica, ");
		// Dados do Turma
		str.append(" turma.codigo AS \"turma.codigo\",  ");
		str.append(" turma.identificadorTurma AS \"turma.identificadorTurma\",  ");
		// Dados do Turno
		str.append(" turno.nome AS \"turno.nome\",  ");
		// Dados da Grade Curricular
		str.append(" gradeCurricular.nome AS \"gradeCurricular.nome\", ");
		// Dados do Matricula Periodo
		str.append(" matriculaPeriodo.codigo AS \"matriculaPeriodo.codigo\", matriculaPeriodo.situacao AS \"matriculaPeriodo.situacao\", matriculaperiodo.situacaoMatriculaPeriodo as \"matriculaperiodo.situacaoMatriculaPeriodo\", matriculaPeriodo.datafechamentomatriculaperiodo AS \"matriculaPeriodo.datafechamentomatriculaperiodo\", matriculaPeriodo.data AS \"matriculaPeriodo.data\", ");
		// Dados do Periodo Letivo
		str.append(" periodoLetivo.descricao AS \"periodoLetivo.descricao\",  ");
		// Dados da Matricula
		str.append(" matricula.matricula AS \"matricula.matricula\",  ");
		str.append(" matricula.updated AS \"matricula.updated\",  ");
		str.append(" matricula.situacao AS \"matricula.situacao\",  ");
		str.append(" matricula.tipoMatricula AS \"matricula.tipoMatricula\",  ");
		str.append(" matricula.situacaoFinanceira AS \"matricula.situacaoFinanceira\", matricula.canceladoFinanceiro, ");
		str.append(" matricula.gradecurricularatual AS \"matricula.gradecurricularatual\",  ");
		// Dados do Curso
		str.append(" curso.codigo AS \"curso.codigo\", curso.nome AS \"curso.nome\", curso.periodicidade as \"curso.periodicidade\", ");
		// Dados da Unidade Ensino
		str.append(" unidadeEnsino.codigo AS \"unidadeEnsino.codigo\", unidadeEnsino.nome AS \"unidadeEnsino.nome\", ");
		// Dados do Aluno
		str.append(" aluno.codigo AS \"aluno.codigo\", aluno.nome AS \"aluno.nome\", ");
		// Dados do Usuario
		str.append(" usuario.nome AS \"responsavel.nome\", usuario.codigo AS \"responsavel.codigo\", ");
		// Dados da Disciplina
		str.append(" disciplina.codigo AS \"disciplina.codigo\", disciplina.nome AS \"disciplina.nome\", ");

		// DISCIPLINA COMPOSTA E EQUIVALENCIA
		str.append(" historico.historicoPorEquivalencia AS \"historico.historicoPorEquivalencia\", historico.historicoEquivalente AS \"historico.historicoEquivalente\", ");
		str.append(" historico.gradeDisciplinaComposta AS \"historico.gradeDisciplinaComposta\", ");
		str.append(" gradeDisciplinaComposta.variavelNota AS \"gradeDisciplinaComposta.variavelNota\", ");
		str.append(" gradeDisciplinaComposta.ordem AS \"gradeDisciplinaComposta.ordem\", ");
		str.append(" gradeDisciplinaComposta.nrcreditos AS \"gradeDisciplinaComposta.nrcreditos\", ");
		str.append(" gradeDisciplinaComposta.cargahoraria AS \"gradeDisciplinaComposta.cargahoraria\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaPratica AS \"gradeDisciplinaComposta.cargahorariaPratica\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaTeorica AS \"gradeDisciplinaComposta.cargahorariaTeorica\", ");
		str.append(" gradeDisciplinaComposta.gradedisciplina AS \"gradeDisciplinaComposta.gradedisciplina\", ");
		str.append(" gradeDisciplinaComposta.horaaula AS \"gradeDisciplinaComposta.horaaula\", ");
		str.append(" gradeDisciplinaComposta.gradeCurricularGrupoOptativaDisciplina AS \"gradeDisciplinaComposta.gradeCurricularGrupoOptativaDisciplina\", ");
		str.append(" historico.historicoDisciplinaComposta AS \"historico.historicoDisciplinaComposta\", historico.historicoDisciplinaFazParteComposicao, ");
		str.append(" historico.mapaEquivalenciaDisciplina AS \"historico.mapaEquivalenciaDisciplina\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaCursada AS \"historico.mapaEquivalenciaDisciplinaCursada\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaMatrizCurricular AS \"historico.mapaEquivalenciaDisciplinaMatrizCurricular\", ");

		// Dados da Grade Disciplina
		str.append(" gradedisciplina.codigo AS \"gradedisciplina.codigo\", ");
		str.append(" gradedisciplina.disciplina AS \"gradedisciplina.disciplina\", ");
		str.append(" gradedisciplina.cargaHoraria AS \"gradedisciplina.cargaHoraria\", ");
		str.append(" gradedisciplina.cargaHorariapratica AS \"gradedisciplina.cargaHorariapratica\", ");
		str.append(" gradedisciplina.nrCreditos AS \"gradedisciplina.nrCreditos\", ");
		str.append(" gradedisciplina.diversificada AS \"gradedisciplina.diversificada\", ");
		str.append(" gradedisciplina.disciplinaComposta AS \"gradedisciplina.disciplinaComposta\", ");
		str.append(" gradedisciplina.disciplinaEixoTematico AS \"gradedisciplina.disciplinaEixoTematico\", ");
		str.append(" gradedisciplina.formulaCalculoNota AS \"gradedisciplina.formulaCalculoNota\", ");
		str.append(" gradedisciplina.formulaCalculo AS \"gradedisciplina.formulaCalculo\", ");
		str.append(" gradedisciplina.horaaula AS \"gradedisciplina.horaaula\", ");

		str.append(" gradedisciplina.formulaCalculo AS \"gradedisciplina.formulaCalculo\", ");
		str.append(" gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradedisciplina.variavelNotaRecuperacao AS \"gradedisciplina.variavelNotaRecuperacao\", ");
		str.append(" gradedisciplina.condicaoUsoRecuperacao AS \"gradedisciplina.condicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gradedisciplina.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperada AS \"gradedisciplina.formulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperacao AS \"gradedisciplina.formulaCalculoNotaRecuperacao\", ");

		// Dados da Grade Curricular Grupo Optativa Disciplina
		// (GradeCurricularGrupoOptativaDisciplina)
		str.append(" historico.gradeCurricularGrupoOptativaDisciplina AS \"historico.gradeCurricularGrupoOptativaDisciplina\",  ");
		str.append(" historico.disciplinaReferenteAUmGrupoOptativa AS \"historico.disciplinaReferenteAUmGrupoOptativa\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.codigo AS \"gradeCurricularGrupoOptativaDisciplina.codigo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplina AS \"gradeCurricularGrupoOptativaDisciplina.disciplina\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHoraria AS \"gradeCurricularGrupoOptativaDisciplina.cargaHoraria\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica AS \"gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.nrCreditos AS \"gradeCurricularGrupoOptativaDisciplina.nrCreditos\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.diversificada AS \"gradeCurricularGrupoOptativaDisciplina.diversificada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplinaComposta AS \"gradeCurricularGrupoOptativaDisciplina.disciplinaComposta\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculo AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gcgod.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaRecuperacao AS \"gcgod.variavelNotaRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.condicaoUsoRecuperacao AS \"gcgod.condicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gcgod.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperada AS \"gcgod.formulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gcgod.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperacao AS \"gcgod.formulaCalculoNotaRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.horaaula AS \"gcgod.horaaula\", ");

		str.append(" historico.nota31, historico.nota31Lancada, ");

		str.append(" historico.nota32, historico.nota32Lancada, ");

		str.append(" historico.nota33, historico.nota33Lancada, ");

		str.append(" historico.nota34, historico.nota34Lancada, ");

		str.append(" historico.nota35, historico.nota35Lancada, ");

		str.append(" historico.nota36, historico.nota36Lancada, ");

		str.append(" historico.nota37, historico.nota37Lancada, ");

		str.append(" historico.nota38, historico.nota38Lancada, ");

		str.append(" historico.nota39, historico.nota39Lancada, ");

		str.append(" historico.nota40, historico.nota40Lancada, historico.apresentarAprovadoHistorico, historico.dataInicioAula as \"historico.dataInicioAula\", historico.dataFimAula as \"historico.dataFimAula\", ");

		str.append(" exists (select historiconota.codigo from historiconota where historiconota.historico = historico.codigo and historiconota.notarecuperacao and situacaorecuperacaonota = '").append(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO.name()).append("' limit 1) as emrecuperacao, historico.mediaFinalConceito, " );
		str.append(" historico.nota1Conceito, historico.nota2Conceito, historico.nota3Conceito, historico.nota4Conceito, historico.nota5Conceito, historico.nota6Conceito, historico.nota7Conceito, historico.nota8Conceito, historico.nota9Conceito, historico.nota10Conceito, " );
		str.append(" historico.nota11Conceito, historico.nota12Conceito, historico.nota13Conceito, historico.nota14Conceito, historico.nota15Conceito, historico.nota16Conceito, historico.nota17Conceito, historico.nota18Conceito, historico.nota19Conceito, historico.nota20Conceito, " );
		str.append(" historico.nota21Conceito, historico.nota22Conceito, historico.nota23Conceito, historico.nota24Conceito, historico.nota25Conceito, historico.nota26Conceito, historico.nota27Conceito, historico.nota28Conceito, historico.nota29Conceito, historico.nota30Conceito, " );
		str.append(" historico.nota31Conceito, historico.nota32Conceito, historico.nota33Conceito, historico.nota34Conceito, historico.nota35Conceito, historico.nota36Conceito, historico.nota37Conceito, historico.nota38Conceito, historico.nota39Conceito, historico.nota40Conceito " );		

		str.append(" FROM historico AS historico ");
		str.append(" INNER JOIN matricula 				ON matricula.matricula     = historico.matricula ");
		str.append(" INNER JOIN cte_pessoaaluno   	    ON cte_pessoaaluno.pessoa  = matricula.aluno ");
		str.append(" INNER JOIN pessoa AS \"aluno\" 	ON aluno.codigo 		   = matricula.aluno ");
	
		str.append(" INNER JOIN curso 					ON curso.codigo = matricula.curso ");
		str.append(" INNER JOIN unidadeEnsino 			ON unidadeEnsino.codigo = matricula.unidadeEnsino ");
		str.append(" INNER JOIN turno 					ON matricula.turno = turno.codigo ");
		
		str.append(" LEFT JOIN matriculaPeriodo on matriculaPeriodo.matricula = matricula.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		str.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		str.append(" LEFT JOIN turma on turma.codigo = case when matriculaPeriodoTurmaDisciplina.turma  is not null then matriculaPeriodoTurmaDisciplina.turma else matriculaPeriodo.turma end  ");
		str.append(" LEFT JOIN gradeCurricular on historico.matrizCurricular = gradeCurricular.codigo ");
		str.append(" LEFT JOIN disciplina on disciplina.codigo = historico.disciplina ");
		
		str.append(" LEFT JOIN periodoLetivo on historico.periodoLetivoMatrizCurricular = periodoLetivo.codigo ");
		str.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		str.append(" LEFT JOIN gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		str.append(" LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		str.append(" LEFT JOIN usuario on usuario.codigo = historico.responsavel ");
		
		str.append(" LEFT JOIN periodoLetivo as periodoLetivoMatrizCurricular on historico.periodoLetivoMatrizCurricular = periodoLetivoMatrizCurricular.codigo ");
		str.append(" LEFT JOIN periodoLetivo as periodoLetivoCursada on historico.periodoLetivoCursada = periodoLetivoCursada.codigo ");
		str.append(" LEFT JOIN gradeCurricular as matrizCurricular on matricula.gradecurricularatual = matrizCurricular.codigo ");
		str.append(" LEFT JOIN configuracaoAcademico on configuracaoAcademico.codigo = historico.configuracaoAcademico ");
		
		if(Uteis.isAtributoPreenchido(turma)) {
			str.append(" LEFT JOIN turmaagrupada ta ON ta.turmaorigem = ").append(turma).append(" LEFT JOIN turma t ON ta.turma = t.codigo ");
			str.append(" INNER JOIN LATERAL (")
			.append("   SELECT ").append(disciplina).append(" codigo ")
			.append(" 	UNION SELECT de.equivalente codigo FROM disciplinaequivalente de WHERE t.codigo IS NOT NULL AND de.disciplina = ").append(disciplina)
			.append(" 	UNION SELECT de.disciplina codigo FROM disciplinaequivalente de WHERE t.codigo IS NOT NULL AND de.equivalente = ").append(disciplina)
			.append(" ) AS disciplinas ON matriculaPeriodoTurmaDisciplina.disciplina = disciplinas.codigo ");
		}
		
		str.append(" WHERE 1=1 ");
		
		if(!Uteis.isAtributoPreenchido(turma)) {
			str.append(" AND matriculaPeriodoTurmaDisciplina.disciplina = ").append(disciplina);
		}
		if(Uteis.isAtributoPreenchido(ano)) {
			str.append(" AND (matriculaPeriodoTurmaDisciplina.ano = '").append(ano).append("' ) ");
		}
		if(Uteis.isAtributoPreenchido(semestre)) {
			str.append(" AND (matriculaPeriodoTurmaDisciplina.semestre = '").append(semestre).append("' ) ");
		}
		if(!Uteis.isAtributoPreenchido(semestre) && Uteis.isAtributoPreenchido(bimestre) && (bimestre.equals("1") || bimestre.equals("2"))) {
			str.append(" AND (matriculaPeriodoTurmaDisciplina.semestre = '1' ) ");
		}
		if(!Uteis.isAtributoPreenchido(semestre) && Uteis.isAtributoPreenchido(bimestre) && (bimestre.equals("3") || bimestre.equals("4"))) {
			str.append(" AND (matriculaPeriodoTurmaDisciplina.semestre = '2' ) ");
		}
		if(Uteis.isAtributoPreenchido(curso)) {
			str.append(" AND matricula.curso = ").append(curso);
		}
		if(Uteis.isAtributoPreenchido(turma)) {
			str.append(" AND ((matriculaPeriodoTurmaDisciplina.turma = ").append(turma).append(" ) ")
			.append(" OR ( matriculaPeriodoTurmaDisciplina.turma = t.codigo))");
		}

		str.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual("and"));

		str.append(" order by case when matricula.situacao = 'AT' then 0 else 1 end, case when matriculaperiodo.situacaomatriculaperiodo = 'AT' then 0 else 1 end,  historico.anohistorico desc, historico.semestrehistorico desc, historico.codigo desc ");
//		System.out.println(str.toString());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(str.toString());

		return montarDadosConsultaCompleta(tabelaResultado, null);

	}


	@Override
	public List<HistoricoVO> realizarCriacaoHistoricoParaValidacaoConnfiguracaoAcademica(int qtde, List<HistoricoVO> historicoFilhaComposicaoVOs) throws Exception{
		if(qtde <= 0) {
			throw new Exception("O número de disciplinas composta deve ser maior que 0.");
		}
		int x  = historicoFilhaComposicaoVOs.size();
		while(x > qtde) {
			historicoFilhaComposicaoVOs.remove(historicoFilhaComposicaoVOs.size() - 1);
			x--;
		}
		x  = historicoFilhaComposicaoVOs.size()+1;
		while(x <= qtde) {
			HistoricoVO historicoVO = new HistoricoVO();
			historicoVO.setHistoricoDisciplinaFazParteComposicao(true);
			historicoVO.setSituacao("CS");
			historicoVO.setFreguencia(100.0);
			historicoVO.getGradeDisciplinaComposta().setCodigo(x);
			historicoVO.getGradeDisciplinaComposta().setVariavelNota("N"+x);
			historicoVO.getGradeDisciplinaComposta().setOrdem(x);
			historicoVO.getGradeDisciplinaComposta().getDisciplina().setCodigo(x);
			historicoVO.getGradeDisciplinaComposta().getDisciplina().setNome(x+"ª Disciplina da Composição ");
			historicoVO.getGradeDisciplinaComposta().setCargaHoraria(60);
			historicoVO.getGradeDisciplinaComposta().setNrCreditos(3);
			historicoVO.setCargaHorariaDisciplina(60);
			historicoVO.setCreditoDisciplina(3);
			historicoVO.getDisciplina().setCodigo(x);
			historicoVO.getDisciplina().setNome(x+"ª Disciplina da Composição");
			historicoFilhaComposicaoVOs.add(historicoVO);
			x++;
		}
		return historicoFilhaComposicaoVOs;
	}

	@Override
	public Integer consultarNumeroAgrupamentoEquivalenciaDisciplinaPorCodigo(Integer historico) throws Exception{
		StringBuilder sql  = new StringBuilder("SELECT max(numeroAgrupamentoEquivalenciaDisciplina) as numeroAgrupamentoEquivalenciaDisciplina from historico ");
		sql.append(" where codigo = ? ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), historico);
		if(rs.next()){
			return rs.getInt("numeroAgrupamentoEquivalenciaDisciplina");
		}
		return 0;
	}

	@Override
	public Boolean realizarVerificacaoDataHistoricoPosteriorDataAulaPorMatriculaDisciplina(String matricula, Integer matriculaPeriodo, Integer gradeCurricular, Integer disciplina, UsuarioVO usuario) throws  Exception{
		HistoricoVO historicoVO = consultaRapidaPorMatricula_matriculaPeriodo_Disciplina(matricula, matriculaPeriodo, gradeCurricular, disciplina, false, usuario);
		if(Uteis.isAtributoPreenchido(historicoVO)) {
			carregarDadosHorarioAulaAluno(historicoVO, historicoVO.getMatricula().getCurso().getNivelEducacionalPosGraduacao());
			return (Uteis.isAtributoPreenchido(historicoVO.getDataPrimeiraAula())
					&& historicoVO.getMatriculaPeriodo().getData().compareTo(historicoVO.getDataPrimeiraAula()) > 0
					&& !Uteis.getData(historicoVO.getMatriculaPeriodo().getData()).equals(Uteis.getData(historicoVO.getDataPrimeiraAula())));
		}
		return false;
	}

	@Override
	public void realizarDesistenciaEquivalencia(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MapaEquivalenciaDisciplinaVO mapaEquivalenciaDisciplinaVO, UsuarioVO usuarioVO) throws Exception {
		boolean historicoReferenteAUmGrupoOptativa = false;
		matriculaPeriodoVO.getListaHistoricoDesistenciaEquivalenciaVOs().clear();
		for (MapaEquivalenciaDisciplinaMatrizCurricularVO mapaEquivalenciaMatrizCurricularVO : mapaEquivalenciaDisciplinaVO.getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {
			if (!mapaEquivalenciaMatrizCurricularVO.getHistorico().getCodigo().equals(0)) {
				mapaEquivalenciaMatrizCurricularVO.getHistorico().setSituacao(SituacaoHistorico.REPROVADO.getValor());
				mapaEquivalenciaMatrizCurricularVO.getHistorico().setDesistiuEquivalencia(true);
				matriculaPeriodoVO.getListaHistoricoDesistenciaEquivalenciaVOs().add(mapaEquivalenciaMatrizCurricularVO.getHistorico());
//				alterarSituacaoHistoricoPorCodigo(mapaEquivalenciaMatrizCurricularVO.getHistorico().getCodigo(), SituacaoHistorico.REPROVADO.getValor(), usuarioVO);
//				alterarHistoricoPorCodigoDesistiuEquivalencia(mapaEquivalenciaMatrizCurricularVO.getHistorico().getCodigo(), true, usuarioVO);
				if (mapaEquivalenciaMatrizCurricularVO.getHistorico().getDisciplinaReferenteAUmGrupoOptativa()) {
					historicoReferenteAUmGrupoOptativa = true;
				}
			}
		}
		for (MapaEquivalenciaDisciplinaCursadaVO mapaEquivalenciaCursadaVO : mapaEquivalenciaDisciplinaVO.getMapaEquivalenciaDisciplinaCursadaVOs()) {
			if (!mapaEquivalenciaCursadaVO.getHistorico().getCodigo().equals(0)) {
				mapaEquivalenciaCursadaVO.getHistorico().setSituacao(SituacaoHistorico.REPROVADO.getValor());
				mapaEquivalenciaCursadaVO.getHistorico().setDesistiuEquivalencia(true);
				matriculaPeriodoVO.getListaHistoricoDesistenciaEquivalenciaVOs().add(mapaEquivalenciaCursadaVO.getHistorico());
//				alterarSituacaoHistoricoPorCodigo(mapaEquivalenciaCursadaVO.getHistorico().getCodigo(), SituacaoHistorico.REPROVADO.getValor(), usuarioVO);
//				alterarHistoricoPorCodigoDesistiuEquivalencia(mapaEquivalenciaCursadaVO.getHistorico().getCodigo(), true, usuarioVO);
				getFacadeFactory().getMatriculaPeriodoFacade().removerMapaEquivalenciaDisciplinaCursadaAposDesistenciaEquivalencia(matriculaVO, matriculaPeriodoVO, matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs(), mapaEquivalenciaCursadaVO.getDisciplinaVO(), usuarioVO);
			}else if(matriculaPeriodoVO.getCodigo().equals(0)) {				
				for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()) {
					if (matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo().equals(mapaEquivalenciaCursadaVO.getDisciplinaVO().getCodigo())) {
						getFacadeFactory().getMatriculaPeriodoFacade().removerMatriculaPeriodoTurmaDisciplinaObjEspecifico(matriculaPeriodoVO, matriculaVO, matriculaPeriodoTurmaDisciplinaVO, usuarioVO);
						return;
					}					
				}			
			}
		}
		if (historicoReferenteAUmGrupoOptativa == false) {
			getFacadeFactory().getMatriculaPeriodoFacade().removerHistoricoListaCursandoAdicionandoListaPendenteObjEspecifico(matriculaVO, matriculaPeriodoVO, mapaEquivalenciaDisciplinaVO, usuarioVO);
		} else {
			getFacadeFactory().getMatriculaPeriodoFacade().removerHistoricoGrupoOptativaListaCursandoAdicionandoListaPendenteObjEspecifico(matriculaVO, matriculaPeriodoVO, mapaEquivalenciaDisciplinaVO, usuarioVO);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarHistoricoPorCodigoDesistiuEquivalencia(final Integer historico, final Boolean desistiuEquivalencia, UsuarioVO usuario) throws Exception {
		try {
			final String sql = "UPDATE Historico set desistiuEquivalencia=? WHERE codigo = ?" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					int i = 0;
					sqlAlterar.setBoolean(++i, desistiuEquivalencia);
					sqlAlterar.setInt(++i, historico.intValue());
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Boolean verificarHistoricoDisciplinaMatrizCurrciularRealizouDesistenciaEquivalencia(MapaEquivalenciaDisciplinaVO mapaEquivalenciaDisciplinaVO, UsuarioVO usuarioVO) {
		Boolean desistiuEquivalencia = false;
		for (MapaEquivalenciaDisciplinaMatrizCurricularVO disciplinaMatriz : mapaEquivalenciaDisciplinaVO.getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {
			HistoricoVO historico = disciplinaMatriz.getHistorico();
			if (historico != null && !historico.getCodigo().equals(0)) {
				desistiuEquivalencia = consultarPorCodigoDesistenciaEquivalencia(historico.getCodigo(), usuarioVO);
			}
		}
		return desistiuEquivalencia;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Boolean consultarPorCodigoDesistenciaEquivalencia(Integer codigo, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("select desistiuEquivalencia from historico where codigo = ").append(codigo);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("desistiuEquivalencia");
		}
		return false;
	}

	@Override
	public void realizarAlteracaoSituacaoHistoricoDesistenciaEquivalencia(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception {
		for (HistoricoVO historicoVO : matriculaPeriodoVO.getListaHistoricoDesistenciaEquivalenciaVOs()) {
			alterarSituacaoHistoricoPorCodigo(historicoVO.getCodigo(), SituacaoHistorico.REPROVADO.getValor(), usuarioVO);
			alterarHistoricoPorCodigoDesistiuEquivalencia(historicoVO.getCodigo(), true, usuarioVO);
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarAtualizacaoHoraComplementarHistorico(Integer matriculaPeriodoTurmaDisciplina, UsuarioVO usuarioLogado) throws Exception {
		if (Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplina)) {
			StringBuilder sql = new StringBuilder();
			sql.append(" update historico set horacomplementar = ");
			sql.append(" (select sum(atividadecomplementar.qtdeHoraComplementar) from atividadecomplementar ");
			sql.append(" inner join atividadecomplementarmatricula on atividadecomplementarmatricula.atividadecomplementar = atividadecomplementar.codigo ");
			sql.append(" where alunoSelecionado and atividadecomplementarmatricula.matriculaperiodoturmadisciplina = ? ) ");
			sql.append(" where historico.matriculaperiodoturmadisciplina = ? ");
			sql.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
			getConexao().getJdbcTemplate().update(sql.toString(), matriculaPeriodoTurmaDisciplina, matriculaPeriodoTurmaDisciplina);
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarConfiguracaoAcademicaHistoricoConformeTurmaDisciplinaEstatisticaAlunoVO(TurmaVO turmaVO, TurmaDisciplinaEstatisticaAlunoVO turmaDisciplinaEstatisticaAlunoVO, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("update historico set configuracaoacademico = ? where codigo in (SELECT distinct historico.codigo FROM MatriculaPeriodoTurmaDisciplina ");
		sqlStr.append("INNER JOIN Matricula ON (MatriculaPeriodoTurmaDisciplina.matricula = Matricula.matricula) ");
		sqlStr.append("INNER JOIN matriculaPeriodo on matriculaPeriodo.codigo = matriculaperiodoturmadisciplina.matriculaperiodo ");
		sqlStr.append("INNER JOIN historico ON (MatriculaPeriodoTurmaDisciplina.codigo = historico.MatriculaPeriodoTurmaDisciplina) ");
		if (turmaVO.getSubturma()) {
			if (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.TEORICA)) {
				sqlStr.append("INNER JOIN Turma ON turma.codigo = MatriculaPeriodoTurmaDisciplina.turmaTeorica ");
			} else if (turmaVO.getTipoSubTurma().equals(TipoSubTurmaEnum.PRATICA)) {
				sqlStr.append("INNER JOIN Turma ON turma.codigo = MatriculaPeriodoTurmaDisciplina.turmaPratica ");
			} else {
				sqlStr.append("INNER JOIN Turma ON MatriculaPeriodoTurmaDisciplina.turma = turma.codigo ");
			}
		} else {
			sqlStr.append("INNER JOIN Turma ON MatriculaPeriodoTurmaDisciplina.turma = turma.codigo ");
		}
		sqlStr.append(" WHERE ");
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			sqlStr.append(" Turma.codigo  in ( select turma from turmaAgrupada where turmaOrigem =  " + turmaVO.getCodigo() + ")");
		} else {
			sqlStr.append(" Turma.codigo  = " + turmaVO.getCodigo());
		}
		if(turmaVO.getAnual() || turmaVO.getSemestral()){
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.ano = '").append(turmaDisciplinaEstatisticaAlunoVO.getAno()).append("' ");
		}
		if(turmaVO.getSemestral()){
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.semestre = '").append(turmaDisciplinaEstatisticaAlunoVO.getSemestre()).append("' ");
		}
		sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		Integer configuracaoAcademicaUsar = null;
		if(Uteis.isAtributoPreenchido(turmaDisciplinaEstatisticaAlunoVO.getTurmaDisciplinaVO().getDisciplina())) {
			sqlStr.append(" and historico.configuracaoacademico != ").append(turmaDisciplinaEstatisticaAlunoVO.getTurmaDisciplinaVO().getConfiguracaoAcademicoVO().getCodigo()).append(" ");
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.disciplina = " + turmaDisciplinaEstatisticaAlunoVO.getTurmaDisciplinaVO().getDisciplina().getCodigo().intValue());
			configuracaoAcademicaUsar = turmaDisciplinaEstatisticaAlunoVO.getTurmaDisciplinaVO().getConfiguracaoAcademicoVO().getCodigo();
		}else {
			sqlStr.append(" and historico.configuracaoacademico != ").append(turmaDisciplinaEstatisticaAlunoVO.getTurmaDisciplinaCompostaVO().getConfiguracaoAcademicoVO().getCodigo()).append(" ");
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.disciplina = " + turmaDisciplinaEstatisticaAlunoVO.getTurmaDisciplinaCompostaVO().getGradeDisciplinaCompostaVO().getDisciplina().getCodigo().intValue());
			configuracaoAcademicaUsar = turmaDisciplinaEstatisticaAlunoVO.getTurmaDisciplinaCompostaVO().getConfiguracaoAcademicoVO().getCodigo();
		}
		sqlStr.append(" ) ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
		getConexao().getJdbcTemplate().update(sqlStr.toString(), configuracaoAcademicaUsar);
	}

	@Override
	public List<HistoricoVO> consultarHistoricoLancamentoNotaMobile(TurmaVO turmaVO, DisciplinaVO disciplinaVO, String ano, String semestre, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuarioVO) throws Exception{

		ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO = getFacadeFactory().getConfiguracaoGeralSistemaFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_DADOSBASICOS_APLICATIVO, usuarioVO, turmaVO.getUnidadeEnsino().getCodigo());
		boolean permitirRealizarLancamentoAlunosPreMatriculados = configuracaoGeralSistemaVO.getPermitirProfessorRealizarLancamentoAlunosPreMatriculados();
		boolean trazerAlunoPendenteFinanceiramente = usuarioVO.getIsApresentarVisaoProfessor() ?
				configuracaoGeralSistemaVO.getApresentarAlunoPendenteFinanceiroVisaoProfessor()
				: usuarioVO.getIsApresentarVisaoCoordenador() ? configuracaoGeralSistemaVO.getApresentarAlunoPendenteFinanceiroVisaoCoordenador() : true;
		boolean permitiVisualizarAlunoTR_CA = getFacadeFactory().getRegistroAulaFacade().verificarPermissaoVisualizarMatriculaTR_CA(usuarioVO);
		Boolean permiteLancarNotaDisciplinaComposta;
		try {
			permiteLancarNotaDisciplinaComposta = Historico.verificarPermissaoFuncionalidadeUsuario("PermiteLancarNotaDisciplinaComposta", usuarioVO);
		} catch (Exception e) {
			permiteLancarNotaDisciplinaComposta = false;
		}
		CalendarioLancamentoNotaVO calendarioLancamentoNotaVO = getFacadeFactory().getCalendarioLancamentoNotaFacade().consultarPorCalendarioAcademicoProfessorExcluisoLancamentoNota(turmaVO.getUnidadeEnsino().getCodigo(), turmaVO.getCodigo(), turmaVO.getTurmaAgrupada(), usuarioVO.getPessoa().getCodigo(), 0, 0, "", ano, semestre, false, usuarioVO);
		boolean professorExclusiso = getFacadeFactory().getHistoricoFacade().professorExclusivoLancamentoNota(calendarioLancamentoNotaVO, usuarioVO);
		return consultaRapidaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHistFiltroVisaoProfessorRegistroNotaLimiteOffSet(0, 0, disciplinaVO.getCodigo(), turmaVO, ano, semestre, trazerAlunoPendenteFinanceiramente, "'AA', 'CC', 'CH', 'IS'", false, true, usuarioVO.getPessoa().getCodigo(), false, configuracaoAcademicoVO, permitiVisualizarAlunoTR_CA, permiteLancarNotaDisciplinaComposta,  Uteis.NIVELMONTARDADOS_TODOS, 10000, 0, usuarioVO, permitirRealizarLancamentoAlunosPreMatriculados, professorExclusiso);
	}

	public void carregarDadosProfessorTitularTitulacao(List<HistoricoVO> historicoVOs) throws StreamSeiException {
		historicoVOs.forEach(this::carregarDadosProfessorTitularTitulacao);
	}

	private void carregarDadosProfessorTitularTitulacao(HistoricoVO historicoVO) throws StreamSeiException {
		try {
			Optional<SqlRowSet> professorTitularTitulacao = consultarProfessorTitularTitulacao(historicoVO, Boolean.FALSE,Boolean.FALSE);
			professorTitularTitulacao.ifPresent(s -> montarDadosProfessorTitularTitulacao(s, historicoVO));
		} catch (Exception e) {
			throw new StreamSeiException(e);
		}
	}

	/**
	 * Consulta padrão de professor titular, sexo e seu  maior nível de formação acadêmica
	 * @return SqlRowSet ou null
	 */
	public Optional<SqlRowSet> consultarProfessorTitularTitulacao(HistoricoVO historicoVO, boolean apresentarApenasProfessorTitulacaoTurmaOrigem,boolean situacaoConcluido) throws Exception {
		String sqlEscolaridade = getSQLConsultaEscolaridadeTitulacaoProfessor(situacaoConcluido);
		SqlRowSet rs = null;
		if(historicoVO.getHistoricoPorEquivalencia()) {
			List<HistoricoVO> historicosMapa = getFacadeFactory().getHistoricoFacade().consultaRapidaPorDisciplinaGradeCurricular(historicoVO.getMatricula().getMatricula(),
					historicoVO.getMatrizCurricular().getCodigo(), null, null, false, true, false,  historicoVO.getMapaEquivalenciaDisciplina().getCodigo(), historicoVO.getNumeroAgrupamentoEquivalenciaDisciplina(), 0, NivelMontarDados.TODOS, null);
			for (HistoricoVO historicoVO2: historicosMapa) {
				return consultarProfessorTitularTitulacao(historicoVO2, apresentarApenasProfessorTitulacaoTurmaOrigem,situacaoConcluido);
			}
		}
		if(Uteis.isAtributoPreenchido(historicoVO.getTransferenciaMatrizCurricularMatricula()) && !historicoVO.getHistoricoPorEquivalencia() && !Uteis.isAtributoPreenchido(historicoVO.getMatriculaPeriodoTurmaDisciplina())) {
			HistoricoVO historicoPorCorrespondencia = consultarHistoricoCursandoPoCorrespondenciaAposTransferencia(historicoVO.getMatriculaPeriodo().getCodigo(), historicoVO.getDisciplina().getCodigo(), false, null);
			if(Uteis.isAtributoPreenchido(historicoPorCorrespondencia)) {
				return consultarProfessorTitularTitulacao(historicoPorCorrespondencia, apresentarApenasProfessorTitulacaoTurmaOrigem,situacaoConcluido);
			}
		}
		if(!apresentarApenasProfessorTitulacaoTurmaOrigem
				&& (historicoVO.getSituacao().equals(SituacaoHistorico.APROVADO_APROVEITAMENTO.getValor())
						|| historicoVO.getSituacao().equals(SituacaoHistorico.APROVADO_APROVEITAMENTO.getDescricao())
						|| historicoVO.getSituacao().equals(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getValor())
						|| historicoVO.getSituacao().equals(SituacaoHistorico.CONCESSAO_CARGA_HORARIA.getDescricao())
						|| historicoVO.getSituacao().equals(SituacaoHistorico.CONCESSAO_CREDITO.getValor())
						|| historicoVO.getSituacao().equals(SituacaoHistorico.CONCESSAO_CREDITO.getDescricao())
						|| historicoVO.getSituacao().equals(SituacaoHistorico.APROVEITAMENTO_BANCA.getValor())
						|| historicoVO.getSituacao().equals(SituacaoHistorico.APROVEITAMENTO_BANCA.getDescricao())
						|| historicoVO.getSituacao().equals(SituacaoHistorico.ISENTO.getValor())
						|| historicoVO.getSituacao().equals(SituacaoHistorico.ISENTO.getDescricao())
						)
				) {
			apresentarApenasProfessorTitulacaoTurmaOrigem = true;
		}
		StringBuilder sql = new StringBuilder()
				.append("(")
				.append(getSQLConsultaProfessorPorMatriculaPeriodoTurmaDisciplina(historicoVO, sqlEscolaridade))
				.append(") union all (")
				.append(getSQLConsultaProfessorTutorDisciplinaTutoriaOnlinePorHistoricoTurmaBaseMatriculaPeriodo(historicoVO, sqlEscolaridade))
				.append(" ) order by turmabaseprogramado");
		rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		if (rs.next()) {
			return Optional.ofNullable(rs);
		}
		// TODO consulta ira traze apenas um professor titular getSQLConsultaProfessorTitularPorProgramacaoAula//
		rs = getConexao().getJdbcTemplate().queryForRowSet(getSQLConsultaProfessorTitularPorProgramacaoAula(historicoVO, sqlEscolaridade, apresentarApenasProfessorTitulacaoTurmaOrigem));
		if (rs.next()) {
			return Optional.ofNullable(rs);
		}

		return Optional.empty();
	}

	private String getSQLConsultaEscolaridadeTitulacaoProfessor(boolean situacaoConcluida) {
		StringBuilder sql = new StringBuilder();
		sql.append(" SELECT escolaridade FROM formacaoAcademica WHERE formacaoAcademica.pessoa = pessoa.codigo  ");
		if(situacaoConcluida) {
			sql.append(" AND situacao = 'CO' ");
		}
		sql.append(" ORDER BY case escolaridade ");
		List<NivelFormacaoAcademica> listaNivelFormacaoAcademica = Arrays.asList(NivelFormacaoAcademica.values());
		listaNivelFormacaoAcademica.sort(Comparator.comparing(NivelFormacaoAcademica::getNivel));
		listaNivelFormacaoAcademica.forEach(nfa -> {
			sql.append(" when '").append(nfa.getValor()).append("' then ").append(nfa.getNivel());
		});
		Integer count = listaNivelFormacaoAcademica.stream().mapToInt(NivelFormacaoAcademica::getNivel).max().getAsInt() + 1;
		sql.append(" else ").append(count).append(" end DESC LIMIT 1 ");
		return sql.toString();
	}

	private void montarDadosProfessorTitularTitulacao(SqlRowSet sqlRowSet, HistoricoVO historicoVO) throws StreamSeiException {
		List<FuncionarioVO> listaProfessores = new ArrayList<>(0);

		sqlRowSet.beforeFirst();
		while (sqlRowSet.next()) {
			FuncionarioVO  professor = new FuncionarioVO();
			professor.getPessoa().setNome(sqlRowSet.getString("nome"));
			professor.setEscolaridade(sqlRowSet.getString("escolaridade"));
			if (listaProfessores.stream().noneMatch(p -> p.getPessoa().getNome().equalsIgnoreCase(professor.getPessoa().getNome()))) {
				listaProfessores.add(professor);
			}

		}
		if(Uteis.isAtributoPreenchido(listaProfessores)) {
			montarProfessoresDisciplina(listaProfessores, historicoVO);
		}

	}


	@Override
	public List<String> consultarAnoSemestreHistoricoPorMatricula(String matricula, String marcadorPrioridade, UsuarioVO usuario, SituacaoMatriculaPeriodoEnum... situacoes) throws Exception {
		final List<String> listaAnoSemestre = new ArrayList<>(0);
		StringBuilder str = new StringBuilder();
		str.append(" SELECT distinct case when curso.periodicidade = 'SE' then case when historico.codigo is null then matriculaperiodo.ano||'/'||matriculaperiodo.semestre else historico.anohistorico||'/'||historico.semestrehistorico end else case when curso.periodicidade = 'AN' then case when historico.codigo is null then matriculaperiodo.ano else historico.anohistorico end else '' end end as anosemestre, ");
		str.append(" case when matriculaperiodo.situacaomatriculaperiodo in ('AT', 'FI') then '").append(marcadorPrioridade).append("' else '' end as prioridade ");
		str.append(" FROM matriculaPeriodo  ");
		str.append(" INNER JOIN matricula on matricula.matricula = matriculaPeriodo.matricula ");
		str.append(" INNER JOIN curso on matricula.curso = curso.codigo ");
		str.append(" left JOIN historico AS historico on historico.matricula = matriculaPeriodo.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		if (situacoes != null && situacoes.length > 0) {
			str.append(Stream.of(situacoes).map(SituacaoMatriculaPeriodoEnum::getValor).collect(Collectors.joining("', '", " AND (MatriculaPeriodo.situacaomatriculaperiodo IN ('", "') ) ")));
		}
		str.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		str.append(" WHERE (matricula.matricula = ? ) and (historico.codigo is null or (");
		str.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" "));
		str.append(" and (historico.historicoporequivalencia = false or historico.historicoporequivalencia is null) ");
		str.append(" and (historico.gradedisciplina is not null or historico.gradeCurricularGrupoOptativaDisciplina is not null or historico.historicodisciplinaforagrade = true or historico.gradedisciplinacomposta is not null))) ");
		str.append("  ORDER BY anosemestre desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(str.toString(), matricula);
		if (Uteis.isAtributoPreenchido(marcadorPrioridade)) {
			while (tabelaResultado.next()) {
				listaAnoSemestre.add(tabelaResultado.getString("anosemestre") + tabelaResultado.getString("prioridade"));
			}
		} else {
			while (tabelaResultado.next()) {
				listaAnoSemestre.add(tabelaResultado.getString("anosemestre"));
			}
		}
		return listaAnoSemestre;
	}

	private String getSQLConsultaProfessorTutorDisciplinaTutoriaOnlinePorHistoricoTurmaBaseMatriculaPeriodo(HistoricoVO historicoVO, String consultaEscolaridade) {
		StringBuilder sql = new StringBuilder();
		sql.append(" select pessoa.nome, pessoa.sexo, (").append(consultaEscolaridade);
		sql.append(" ), 0 as turmabaseprogramado from historico inner join matriculaperiodo on historico.matriculaperiodo = matriculaperiodo.codigo ");
		sql.append(" inner join turma on matriculaperiodo.turma = turma.codigo ");
		sql.append(" inner join turmadisciplina on historico.disciplina = turmadisciplina.disciplina and turma.codigo = turmadisciplina.turma");
		sql.append(" inner join programacaotutoriaonlineprofessor on programacaotutoriaonlineprofessor.programacaotutoriaonline = ( ");
		sql.append(" select t.codigoprogramacao from ( select 1 as ordem, programacaotutoriaonline.codigo as codigoprogramacao from programacaotutoriaonline");
		sql.append(" where programacaotutoriaonline.disciplina = turmadisciplina.disciplina");
		sql.append(" and programacaotutoriaonline.turma = turma.codigo and programacaotutoriaonline.situacao = 'ATIVO' union all");
		sql.append(" select 2 as ordem, programacaotutoriaonline.codigo as codigoprogramacao from matricula");
		sql.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino inner join curso on curso.codigo = matricula.curso ");
		sql.append(" inner join programacaotutoriaonline on programacaotutoriaonline.curso = curso.codigo");
		sql.append(" and programacaotutoriaonline.disciplina = turmadisciplina.disciplina ");
		sql.append(" and programacaotutoriaonline.unidadeensino = unidadeensino.codigo and programacaotutoriaonline.situacao = 'ATIVO'");
		sql.append(" where matricula.matricula = matriculaperiodo.matricula	union all");
		sql.append(" select 3 as ordem, programacaotutoriaonline.codigo as codigoprogramacao from matricula");
		sql.append(" inner join curso on curso.codigo = matricula.curso inner join programacaotutoriaonline on programacaotutoriaonline.curso = curso.codigo");
		sql.append(" and programacaotutoriaonline.disciplina = turmadisciplina.disciplina and programacaotutoriaonline.unidadeensino is null and programacaotutoriaonline.situacao = 'ATIVO'");
		sql.append(" where matricula.matricula = matriculaperiodo.matricula	union all");
		sql.append(" select 4 as ordem, programacaotutoriaonline.codigo as codigoprogramacao from matricula");
		sql.append(" inner join curso on curso.codigo = matricula.curso inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sql.append(" inner join programacaotutoriaonline on programacaotutoriaonline.curso = curso.codigo");
		sql.append(" and programacaotutoriaonline.disciplina = turmadisciplina.disciplina and programacaotutoriaonline.unidadeensino = unidadeensino.codigo");
		sql.append(" and programacaotutoriaonline.situacao = 'ATIVO' and matricula.matricula = matriculaperiodo.matricula and programacaotutoriaonline.niveleducacional = 'SU' union all");
		sql.append(" select 5 as ordem, programacaotutoriaonline.codigo as codigoprogramacao from matricula");
		sql.append(" inner join curso on curso.codigo = matricula.curso inner join programacaotutoriaonline on programacaotutoriaonline.curso = curso.codigo");
		sql.append(" and programacaotutoriaonline.disciplina = turmadisciplina.disciplina");
		sql.append(" and programacaotutoriaonline.unidadeensino is null and programacaotutoriaonline.situacao = 'ATIVO'");
		sql.append(" where matricula.matricula = matriculaperiodo.matricula and programacaotutoriaonline.niveleducacional = 'SU' union all");
		sql.append(" select 6 as ordem, programacaotutoriaonline.codigo as codigoprogramacao from matricula");
		sql.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino");
		sql.append(" inner join programacaotutoriaonline on programacaotutoriaonline.unidadeensino = unidadeensino.codigo");
		sql.append(" and programacaotutoriaonline.disciplina = turmadisciplina.disciplina and programacaotutoriaonline.situacao = 'ATIVO'");
		sql.append(" where matricula.matricula = matriculaperiodo.matricula union all ");
		sql.append(" select 7 as ordem, programacaotutoriaonline.codigo as codigoprogramacao from matricula");
		sql.append(" inner join programacaotutoriaonline on programacaotutoriaonline.disciplina = turmadisciplina.disciplina");
		sql.append(" and programacaotutoriaonline.situacao = 'ATIVO' where matricula.matricula = matriculaperiodo.matricula order by ordem limit 1");
		sql.append(" ) as t ) left join pessoa on programacaotutoriaonlineprofessor.professor = pessoa.codigo");
		sql.append(" where turmadisciplina.modalidadedisciplina = '").append(ModalidadeDisciplinaEnum.ON_LINE.name()).append("' and historico.codigo = ").append(historicoVO.getCodigo()).append(" limit 1");
		return sql.toString();
	}

	private String getSQLConsultaProfessorTitularPorMatriculaPeriodoTurmaDisciplina(HistoricoVO historicoVO, String sqlEscolaridade) {
		StringBuilder sql = new StringBuilder("");
		if(Uteis.isAtributoPreenchido(historicoVO.getMatriculaPeriodoTurmaDisciplina())) {
			sql.append("SELECT distinct pessoa.nome, pessoa.sexo, ( ").append(sqlEscolaridade);
			sql.append(" ), case when matriculaperiodoturmadisciplina.turma = professortitulardisciplinaturma.turma then 0 else 1 end as turmabaseprogramado  from matriculaperiodoturmadisciplina ");
			sql.append("inner join professortitulardisciplinaturma on (professortitulardisciplinaturma.turma = matriculaperiodoturmadisciplina.turma ");
			sql.append("or professortitulardisciplinaturma.turma in (select turmaorigem from turmaagrupada where turma = matriculaperiodoturmadisciplina.turma)) ");
			sql.append("and professortitulardisciplinaturma.disciplina = matriculaperiodoturmadisciplina.disciplina ");
			sql.append("and professortitulardisciplinaturma.ano = matriculaperiodoturmadisciplina.ano ");
			sql.append("and professortitulardisciplinaturma.semestre = matriculaperiodoturmadisciplina.semestre ");
			sql.append("inner join pessoa on professortitulardisciplinaturma.professor = pessoa.codigo ");
			sql.append("where professortitulardisciplinaturma.titular and matriculaperiodoturmadisciplina.codigo = ").append(historicoVO.getMatriculaPeriodoTurmaDisciplina().getCodigo());
		} else {
			sql.append("SELECT distinct pessoa.nome, pessoa.sexo, ( ").append(sqlEscolaridade).append(" ), 0 as turmabaseprogramado from historico ");
			sql.append("inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo ");
			sql.append("inner join professortitulardisciplinaturma on (professortitulardisciplinaturma.turma = matriculaperiodo.turma ");
			sql.append("or professortitulardisciplinaturma.turma in (select turmaorigem from turmaagrupada where turma = matriculaperiodo.turma)) ");
			sql.append("and professortitulardisciplinaturma.disciplina = historico.disciplina ");
			sql.append("and professortitulardisciplinaturma.ano = historico.anohistorico ");
			sql.append("and professortitulardisciplinaturma.semestre = historico.semestrehistorico ");
			sql.append("inner join pessoa on professortitulardisciplinaturma.professor = pessoa.codigo ");
			sql.append("where professortitulardisciplinaturma.titular and historico.codigo = ").append(historicoVO.getCodigo());
		}
		return sql.toString();
	}

	private String getSQLConsultaProfessorTitularPorProgramacaoAula(HistoricoVO historicoVO, String sqlEscolaridade, boolean apresentarApenasProfessorTitulacaoTurmaOrigem) {
		StringBuilder sql = new StringBuilder("SELECT pessoa.sexo , horario.professor_codigo AS \"professor.codigo\", pessoa.nome AS nome, ( ").append(sqlEscolaridade).append(" ) as escolaridade ");
		if (apresentarApenasProfessorTitulacaoTurmaOrigem){
			sql.append(" from periodoauladisciplinaaluno(").append(historicoVO.getCodigo()).append(", false, null, true").append(") as horario ");
		} else {
			sql.append(" from periodoauladisciplinaaluno(").append(historicoVO.getCodigo()).append(") as horario ");
		}
		sql.append(" inner join pessoa on pessoa.codigo = horario.professor_codigo");
		return sql.toString();
	}

	private boolean consultarDisciplinaHistoricoIsTutoriaOnlineTurmaDisciplina(HistoricoVO historicoVO) throws Exception {
		boolean isTutoriaOnline = false;
		StringBuilder str = new StringBuilder("select case turmadisciplina.modalidadedisciplina when 'ON_LINE' then true else false end as isTutoriaOnline from historico inner join matriculaperiodo on historico.matriculaperiodo = matriculaperiodo.codigo");
		str.append(" inner join turmadisciplina on turmadisciplina.disciplina = historico.disciplina and turmadisciplina.turma = matriculaperiodo.turma where historico.codigo = ").append(historicoVO.getCodigo());
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(str.toString());
		if (rs.next()) {
			isTutoriaOnline = rs.getBoolean("isTutoriaOnline");
		}
		return isTutoriaOnline;
	}

	public List<HistoricoVO> consultaRapidaHistoricoPorDisciplinaTurmaAnoSemestreSituacaoMatSituacaoHist(Integer disciplina, TurmaVO turmaVO, String ano, String semestre, boolean controlarAcesso, ConfiguracaoAcademicoVO configuracaoAcademicoVO, int nivelMontarDados, FiltroRelatorioAcademicoVO filtroRelatorioAcademicoVO, UsuarioVO usuario, boolean trazerAlunosTransferenciaMatriz, boolean permiteLancarNotaDisciplinaComposta) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompletaConsiderandoSubTurmaTeoricaOuPratica(turmaVO,disciplina, permiteLancarNotaDisciplinaComposta);
		Boolean permiteLancarNotaDisciplinaComposta2 = Boolean.FALSE;
		if (permiteLancarNotaDisciplinaComposta) {
			permiteLancarNotaDisciplinaComposta2 = permiteLancarNotaDisciplinaComposta && getFacadeFactory().getTurmaDisciplinaFacade().consultarDisciplinaCompostaTurmaDisciplina(turmaVO.getCodigo(), disciplina);
		}
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			sqlStr.append(" WHERE ");
			sqlStr.append(" ((MatriculaPeriodoTurmaDisciplina.turma in (select turma from turmaAgrupada where turmaOrigem =  ").append(turmaVO.getCodigo()).append(") and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null )");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaPratica is not null and MatriculaPeriodoTurmaDisciplina.turmaPratica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'PRATICA'))");
			sqlStr.append("or (MatriculaPeriodoTurmaDisciplina.turmaTeorica is not null and MatriculaPeriodoTurmaDisciplina.turmaTeorica in (select TurmaAgrupada.turma from TurmaAgrupada inner join turma as turmaOrigem on turmaOrigem.codigo = TurmaAgrupada.turmaOrigem inner join turma on turma.codigo = turmaagrupada.turma where turmaOrigem.codigo = ").append(turmaVO.getCodigo()).append(" and turmaOrigem.subturma = false and turma.tiposubturma = 'TEORICA'))");
			sqlStr.append(") ");
		} else {
			if(!permiteLancarNotaDisciplinaComposta2) {
				sqlStr.append(" WHERE (Turma.codigo = ").append(turmaVO.getCodigo()).append(") ");
			}else {
				sqlStr.append(" WHERE historico.historicodisciplinacomposta = true ");
			}
		}
		if (!turmaVO.getSubturma() && !turmaVO.getTurmaAgrupada() && !permiteLancarNotaDisciplinaComposta2) {
			sqlStr.append(" and MatriculaPeriodoTurmaDisciplina.turmaPratica is null and MatriculaPeriodoTurmaDisciplina.turmaTeorica is null ");
		}

		/**
		 * Adicionada regra para resolver impactos relacionados a alunos que
		 * estão Cursando por Correspondência e que disciplinas saiam duplicadas
		 * no Boletim Acadêmico
		 */
		if (!trazerAlunosTransferenciaMatriz) {
			sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" and "));
		}else {
			sqlStr.append(" and (").append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" "));
			sqlStr.append(MatriculaPeriodoTurmaDisciplina.getSqlFiltroBaseGradeCurricularAtual(" or ")).append(" = false )");
			sqlStr.append(" and historico.codigo = (select his.codigo from historico his where his.matricula = matricula.matricula and his.matriculaperiodo = matriculaperiodo.codigo and his.MatriculaPeriodoTurmaDisciplina = MatriculaPeriodoTurmaDisciplina.codigo order by case when his.matrizcurricular = matricula.gradecurricularatual then 0 else 1 end limit 1 ) ");
		}

			sqlStr.append(" and (( historico.disciplina = ").append(disciplina).append(") ");
			if(turmaVO.getTurmaAgrupada()){
				sqlStr.append(" or (historico.disciplina in (select equivalente from disciplinaequivalente where disciplina = ").append(disciplina).append("))");
				sqlStr.append(" or (historico.disciplina in (select disciplina from disciplinaequivalente where equivalente = ").append(disciplina).append("))");
				sqlStr.append(" or (historico.disciplina in (select disciplinaequivalenteturmaagrupada from turmadisciplina where disciplinaequivalenteturmaagrupada is not null and turmadisciplina.disciplina = ").append(disciplina).append(" and turmadisciplina.turma = ").append(turmaVO.getCodigo()).append("))");
			}
			sqlStr.append(") ");

		if (!semestre.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.semestre = '").append(semestre).append("' ");
		}
		if (!ano.equals("")) {
			sqlStr.append(" and matriculaPeriodoTurmaDisciplina.ano = '").append(ano).append("' ");
		}

		if (configuracaoAcademicoVO != null && !configuracaoAcademicoVO.getCodigo().equals(0)) {
			sqlStr.append(" and historico.configuracaoAcademico = ").append(configuracaoAcademicoVO.getCodigo());
		}
		// Garante que sempre estará lançando nota para as disciplina da grade
		// atual do aluno
		// sqlStr.append(" and (matricula.gradecurricularatual = historico.matrizcurricular) ");


		// Não permite que historicos que o aluno está estudando por
		// equivalencia apresente para lançamento de nota, pois a nota deve ser
		// lançada no histórico equivalente
		sqlStr.append(" and (historico.historicoporequivalencia is null or historico.historicoporequivalencia = false) ");
		// Não permite que historicos de disciplina composta apareça para
		// lançamento de nota, pois a nota deve ser lançada para as disciplinas
		// que fazem parte da composição
		if(!permiteLancarNotaDisciplinaComposta2){
			sqlStr.append(" and (historico.historicodisciplinacomposta is null or historico.historicodisciplinacomposta = false) ");
		}


		SqlRowSet tabelaResultado = null;
		if (turmaVO.getTurmaAgrupada() && !turmaVO.getSubturma()) {
			StringBuffer sql = new StringBuffer();
			sql.append("select t.* from ");
			sql.append("(").append(sqlStr).append(") as t ");
			sql.append(" where  (exists (").append(sqlStr).append(" and historico.disciplina = t.\"disciplina.codigo\" and historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1) ") ;
			sql.append(" or not exists (").append(sqlStr).append(" and historico.disciplina = ").append(disciplina).append(" and historico.matricula = t.\"matricula.matricula\" limit 1)) ") ;
			sql.append(" order by t.nomeSemAcento ");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		}else {
			sqlStr.append(" ORDER BY nomeSemAcento");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		}

	//	System.out.println(sqlStr);
		// if(!tabelaResultado.next()){
		// throw new
		// Exception("Não foi encontrado nenhum resultado com os parâmetros passados.");
		// }
		List<HistoricoVO> historicoVOs = montarDadosConsultaCompleta(tabelaResultado, usuario);
		Ordenacao.ordenarLista(historicoVOs, "ordenacao");
		return historicoVOs;
	}

	public void carregarDadosHistoricoNotaParcial(HistoricoVO obj, UsuarioVO usuario) throws Exception{
		getFacadeFactory().getHistoricoNotaParcialInterfaceFacade().carregarHistoricoNotaParcialPorHistorico(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS);
	}

	public Integer realizarCriacaoDescricaoHistoricoNotasParciaisVOs( Integer coluna, StringBuilder notas, List<HistoricoNotaParcialVO> listHistoricoNotaParcialVO, NumberFormat nf) {


		for(HistoricoNotaParcialVO historicoNotaParcialVO:listHistoricoNotaParcialVO){

			String titulo = ((String)UtilReflexao.invocarMetodoGet(historicoNotaParcialVO.getTurmaDisciplinaNotaParcial(), "tituloNota")).trim();


			if(notas.length() == 0){
				notas.append("<span style=\"padding:3px 15px;text-align:center;height:40px;float:left;display:block;\">");
			}else{
				notas.append("<span style=\"padding:3px 15px;text-align:center;border-left:solid 1px #C4C0C9;float:left;height:40px;display:block;\">");
			}
			notas.append("<span>");
			notas.append("<strong><span style=\"font-size:10px;display:block;white-space: nowrap;\">").append(titulo).append("</span></strong>");
			notas.append("</span>");
			notas.append("<span style=\"font-size:10px;white-space: nowrap;\">");


			notas.append(nf.format(Double.valueOf(UtilReflexao.invocarMetodoGet(historicoNotaParcialVO, "nota").toString())));
			titulo = nf.format(Double.valueOf(UtilReflexao.invocarMetodoGet(historicoNotaParcialVO, "nota").toString()));


			notas.append("</span>");
			notas.append("</span>");

			coluna++;

		}
		return coluna;
	}

@Override
	public HashMap<String, Date> carregarUltimoPeriodoAulaDisciplinaAluno(Integer codigoHistorico) {

		HashMap<String, Date> datas = new HashMap<String, Date>();
		StringBuilder str = new StringBuilder("select  datainicio , datatermino from  periodoauladisciplinaaluno (? , true, null, false)");

		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(str.toString(),codigoHistorico);
		if (rs.next()) {
			datas.put("datatermino", rs.getDate("datatermino"));
			datas.put("datainicio", rs.getDate("datainicio"));
		}

		return datas;

	}

	public List consultarDisciplinaCursadasPeriodoLetivoAlunoPorMatricula(String matricula, Integer gradeCurricular, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, Integer limit) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select periodoletivo.periodoletivo as \"periodoletivo.periodoletivo\", historico.*, configuracaoAcademico.intervaloNotasDiferente as \"configuracaoAcademico.intervaloNotasDiferente\", ");
		sqlStr.append(" (case when historico.cargahorariadisciplina is not null and historico.cargahorariadisciplina > 0 ");
		sqlStr.append(" then historico.cargahorariadisciplina else case when gradedisciplina.codigo is not null ");
		sqlStr.append(" then gradedisciplina.cargahoraria else gradecurriculargrupooptativadisciplina.cargahoraria end end) AS cargaHorariaDisciplinaFinal, historico.dataInicioAula as \"historico.dataInicioAula\", historico.dataFimAula as \"historico.dataFimAula\" ");
		sqlStr.append(" from historico ");
		sqlStr.append(" LEFT JOIN matriculaPeriodo on matriculaPeriodo.matricula = historico.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		sqlStr.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		sqlStr.append(" INNER JOIN gradecurricular on historico.matrizcurricular = gradecurricular.codigo ");
		sqlStr.append(" LEFT JOIN configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico ");
		sqlStr.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		sqlStr.append(" LEFT JOIN gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = historico.gradecurriculargrupooptativadisciplina ");
		sqlStr.append(" INNER JOIN periodoletivo on matriculaperiodo.periodoletivomatricula = periodoletivo.codigo ");
		sqlStr.append(" where historico.matricula = '").append(matricula).append("' ");
		if (!gradeCurricular.equals(0)) {
			sqlStr.append(" and gradeCurricular.codigo = ").append(gradeCurricular);
		}
		sqlStr.append(" and (historico.gradecurriculargrupooptativadisciplina is not null or historico.gradedisciplina is not null or historico.historicodisciplinaforagrade) ");
		sqlStr.append(" and (historico.historicoequivalente = false or historico.historicoequivalente is null) ");
		sqlStr.append(" and (historico.historicodisciplinafazpartecomposicao = false or historico.historicodisciplinafazpartecomposicao is null) ");
		/*sqlStr.append(" and historico.situacao <> 'DP' ");
		sqlStr.append(" and historico.situacao <> 'IS' ");
		sqlStr.append(" and historico.situacao <> 'NC' ");
		sqlStr.append(" and historico.situacao <> 'TR' ");
		sqlStr.append(" and historico.situacao <> 'AC' ");
		sqlStr.append(" and historico.situacao <> 'CA' ");
		sqlStr.append(" and historico.situacao <> 'TF' ");
		sqlStr.append(" and historico.situacao <> 'CS' ");
		sqlStr.append(" and historico.situacao <> 'RE' ");
		sqlStr.append(" and historico.situacao <> 'RF' ");*/
		sqlStr.append(" order by periodoletivo.periodoletivo desc ");
		if(limit !=  null && limit != 0) {
			sqlStr.append("limit ").append(limit);
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsultaComGradeDisciplina(tabelaResultado, nivelMontarDados, new ConfiguracaoFinanceiroVO(), usuario));
	}

	@Override
	public Double consultarMediaAprovadasReprovadasAlunoPorMatricula(String matricula, Integer gradeCurricular, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		Double media = 0.0;
		sqlStr.append(" select cast(sum (mediafinal) / count (historico.codigo) as numeric(20,2)) as media ");
		sqlStr.append(" from historico ");
		sqlStr.append(" LEFT JOIN matriculaPeriodo on matriculaPeriodo.matricula = historico.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		sqlStr.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		sqlStr.append(" INNER JOIN gradecurricular on historico.matrizcurricular = gradecurricular.codigo ");
		sqlStr.append(" LEFT JOIN configuracaoacademico on configuracaoacademico.codigo = historico.configuracaoacademico ");
		sqlStr.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		sqlStr.append(" LEFT JOIN gradecurriculargrupooptativadisciplina on gradecurriculargrupooptativadisciplina.codigo = historico.gradecurriculargrupooptativadisciplina ");
		sqlStr.append(" where historico.matricula = '").append(matricula).append("' ");
		if (!gradeCurricular.equals(0)) {
			sqlStr.append(" and gradeCurricular.codigo = ").append(gradeCurricular);
		}
		sqlStr.append(" and (historico.gradecurriculargrupooptativadisciplina is not null or historico.gradedisciplina is not null or historico.historicodisciplinaforagrade) ");
		sqlStr.append(" and (historico.historicoequivalente = false or historico.historicoequivalente is null) ");
		sqlStr.append(" and (historico.historicodisciplinafazpartecomposicao = false or historico.historicodisciplinafazpartecomposicao is null) ");
		sqlStr.append(" and historico.situacao <> 'DP' ");
		sqlStr.append(" and historico.situacao <> 'IS' ");
		sqlStr.append(" and historico.situacao <> 'NC' ");
		sqlStr.append(" and historico.situacao <> 'TR' ");
		sqlStr.append(" and historico.situacao <> 'AC' ");
		sqlStr.append(" and historico.situacao <> 'CA' ");
		sqlStr.append(" and historico.situacao <> 'TF' ");
		sqlStr.append(" and historico.situacao <> 'CS' ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (rs.next()) {
			media = rs.getDouble("media");
		}
		return media;
	}

	@Override
	public Integer consultarQtdHistorioCursandoPorCalendarioAtividadeMatriculaPorPeriodo(Integer codigoMatriculaPeriodo, Integer mptdAnterior, TipoCalendarioAtividadeMatriculaEnum tipocalendarioatividade,  boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" select count (case when historico.situacao in ('CS', 'CE', 'CO') then 1 else 0 end) as qtdHistorioCursando ");
		sqlStr.append(" from matriculaperiodoturmadisciplina ");
		sqlStr.append(" inner join historico on historico.matriculaperiodoturmadisciplina  = matriculaperiodoturmadisciplina.codigo ");
		sqlStr.append(" inner join calendarioatividadematricula on calendarioatividadematricula.matriculaperiodoturmadisciplina = matriculaperiodoturmadisciplina.codigo ");
		sqlStr.append(" and calendarioatividadematricula.tipocalendarioatividade = '").append(tipocalendarioatividade.name()).append("' ");
		sqlStr.append(" and calendarioatividadematricula.datafim >= ").append("'" + Uteis.getDataJDBC(new Date())+ "'");
		sqlStr.append(" where matriculaperiodoturmadisciplina.matriculaperiodo = ").append(codigoMatriculaPeriodo);
		if(Uteis.isAtributoPreenchido(mptdAnterior)) {
			sqlStr.append(" and matriculaperiodoturmadisciplina.codigo = ").append(mptdAnterior);
		}
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (Integer) Uteis.getSqlRowSetTotalizador(rs, "qtdHistorioCursando", TipoCampoEnum.INTEIRO);
	}



	public void carregarDadosNotaConceitoHistorico(List<HistoricoVO> historicoVOs) throws Exception{
		for(HistoricoVO historicoVO: historicoVOs) {
			carregarDadosNotaConceitoHistorico(historicoVO);
		}
	}

	public void incluirHistoricoNotaParcial(List<HistoricoVO> alunosTurma, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuario) throws Exception{
		for(HistoricoVO historicoVO: alunosTurma) {
			for(int x = 1; x<= 40; x++) {
				TurmaDisciplinaNotaTituloVO turmaDisciplinaNotaTituloVO = (TurmaDisciplinaNotaTituloVO) UtilReflexao.invocarMetodoGet(configuracaoAcademicoVO, "turmaDisciplinaNotaTitulo"+x);
				if(Uteis.isAtributoPreenchido(turmaDisciplinaNotaTituloVO) && !turmaDisciplinaNotaTituloVO.getTurmaDisciplinaNotaParcialVOs().isEmpty()) {
					List<HistoricoNotaParcialVO> historicoNotaParcialVOs = (List<HistoricoNotaParcialVO>) UtilReflexao.invocarMetodoGet(historicoVO, "istoricoNotaParcialNota"+x+"VOs");
					if(historicoNotaParcialVOs.isEmpty()) {
						for(TurmaDisciplinaNotaParcialVO turmaDisciplinaNotaParcialVO: turmaDisciplinaNotaTituloVO.getTurmaDisciplinaNotaParcialVOs()) {
							HistoricoNotaParcialVO historicoNotaParcialVO = new HistoricoNotaParcialVO();
							historicoNotaParcialVO.setHistorico(historicoVO);
							historicoNotaParcialVO.setTurmaDisciplinaNotaParcial(turmaDisciplinaNotaParcialVO);
							historicoNotaParcialVO.setTipoNota(turmaDisciplinaNotaParcialVO.getTurmaDisciplinaNotaTituloVO().getNota());
							getFacadeFactory().getHistoricoNotaParcialInterfaceFacade().incluir(historicoNotaParcialVO, usuario);
						}
					}
				}
			}
		}
	}

	/**
	 * Valida se existe professor exclusivo no {@link CalendarioLancamentoNotaVO} caso exista e o usuario logado esta na visão do professor
	 * o regra compara os dois professores e caso sejam diferente o metodo retornará uma exceção.
	 *
	 * @param calendarioLancamentoNotaVO
	 * @param usuarioVO
	 */
	@Override
	public void validarProfessorExclusivoLancamentoNota(CalendarioLancamentoNotaVO calendarioLancamentoNotaVO, UsuarioVO usuarioVO) throws ConsistirException {
		if (Uteis.isAtributoPreenchido(calendarioLancamentoNotaVO) && Uteis.isAtributoPreenchido(calendarioLancamentoNotaVO.getProfessorExclusivoLancamentoDeNota()) && usuarioVO.getIsApresentarVisaoProfessor()) {
			if (!calendarioLancamentoNotaVO.getProfessorExclusivoLancamentoDeNota().getCodigo().equals(usuarioVO.getPessoa().getCodigo())) {
				throw new ConsistirException(UteisJSF.internacionalizar("msg_CalendarioLancamentoNota_lancamentoPermitidoParaProfessorExclusivo")
						.replace("{0}", calendarioLancamentoNotaVO.getTurma().getIdentificadorTurma())
						.replace("{1}", calendarioLancamentoNotaVO.getDisciplina().getNome())
						.replace("{2}", calendarioLancamentoNotaVO.getProfessorExclusivoLancamentoDeNota().getNome()));
			}
		}
	}

	@Override
	public boolean professorExclusivoLancamentoNota(CalendarioLancamentoNotaVO calendarioLancamentoNotaVO, UsuarioVO usuarioVO) {

		if (Uteis.isAtributoPreenchido(calendarioLancamentoNotaVO) && Uteis.isAtributoPreenchido(calendarioLancamentoNotaVO.getProfessorExclusivoLancamentoDeNota())) {
			if (calendarioLancamentoNotaVO.getProfessorExclusivoLancamentoDeNota().getCodigo().equals(usuarioVO.getPessoa().getCodigo())) {
				return true;
			}
		}
		return false;
	}

	private boolean existeAnoSemestreAtual(String anoSemestre) {
		return Uteis.isAtributoPreenchido(anoSemestre) ?
				anoSemestre.contains("/") ? anoSemestre.contains(Uteis.getAnoDataAtual() + "/" + Uteis.getSemestreAtual()) : anoSemestre.contains(Uteis.getAnoDataAtual()) : false;
	}

	private String realizarPriorizacaoAnoSemestreHistoricoAtivoConcluido(List<String> anoSemestres, String marcadorPrioridade) {
		Optional<String> anoSemestre = Optional.empty();
		if (anoSemestres.stream().anyMatch(as -> as.contains(marcadorPrioridade))) {
			if (anoSemestres.stream().filter(as -> as.contains(marcadorPrioridade)).anyMatch(this::existeAnoSemestreAtual)) {
				anoSemestre = anoSemestres.stream().filter(as -> as.contains(marcadorPrioridade)).filter(this::existeAnoSemestreAtual).map(as -> as.replace(marcadorPrioridade, "")).findFirst();
			} else {
				anoSemestre = anoSemestres.stream().filter(as -> as.contains(marcadorPrioridade)).map(as -> as.replace(marcadorPrioridade, "")).findFirst();
			}
		} else {
			anoSemestre = anoSemestres.stream().findFirst();
		}
		return anoSemestre.orElseGet(() -> Uteis.STRING_VAZIA);
	}

	private void montarListaSelectItemAnoSemestreHistorico(List<String> anoSemestres, List<SelectItem> itens, String marcadorPrioridade) {
		anoSemestres.stream().map(as -> as.replace(marcadorPrioridade, "")).map(as -> new SelectItem(as, as)).forEach(itens::add);
	}

	public String inicializarDadosAnoSemestreHistoricoPriorizandoAtivoConcluido(String matricula, List<SelectItem> itens, SituacaoMatriculaPeriodoEnum... situacoes) throws Exception {
		final String marcadorPrioridade = "{p}";
		List<String> anoSemestres = null;
		if(getAplicacaoControle().getAnoSemestreMatriculaCache().containsKey(matricula)) {
			anoSemestres = getAplicacaoControle().getAnoSemestreMatriculaCache().get(matricula);
		}else {
			anoSemestres = consultarAnoSemestreHistoricoPorMatricula(matricula, marcadorPrioridade, null, situacoes);
		}
		montarListaSelectItemAnoSemestreHistorico(anoSemestres, itens, marcadorPrioridade);
		return realizarPriorizacaoAnoSemestreHistoricoAtivoConcluido(anoSemestres, marcadorPrioridade);
	}

	@Override
	public List<HistoricoVO> consultarPorGradeDisciplinaVinculoHistoricoAlteracaoMatrizCurricular(GradeDisciplinaVO gradeDisciplina, UsuarioVO usuario) throws Exception {
		StringBuffer sql = getSQLConsultaGradeCurricularLog(NivelMontarDados.TODOS);
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>();

		sql.append(" WHERE gradedisciplina = ").append(gradeDisciplina.getCodigo());

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		while (tabelaResultado.next()) {
			HistoricoVO obj = new HistoricoVO();
			montarDadosGradeCurricularLog(obj, tabelaResultado, usuario,NivelMontarDados.TODOS);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	private StringBuffer getSQLConsultaGradeCurricularLog(NivelMontarDados nivelMontarDados) {
		StringBuffer sql = new StringBuffer();
		sql.append(" select distinct historico.codigo, historico.matricula AS \"historico.matricula\", pessoa.nome AS \"aluno\", matricula.situacao AS \"matricula.situacao\", matriculaperiodo.situacaomatriculaperiodo AS  \"matriculaperiodo.situacaomatriculaperiodo\", historico.anoHistorico, historico.semestreHistorico, historico.matriculaperiodo ");

		if(nivelMontarDados.equals(NivelMontarDados.TODOS)) {
			sql.append(" ,historico.disciplina, historico.freguencia, historico.mediafinal, historico.situacao AS \"historico.situacao\" ");
		}
		sql.append(" from historico  ");
		sql.append(" inner join matricula on matricula.matricula = historico.matricula ");
		sql.append(" inner join matriculaperiodo on historico.matriculaperiodo = matriculaperiodo.codigo ");
		sql.append(" inner join pessoa on matricula.aluno = pessoa.codigo ");

		return sql;
	}

	private void montarDadosGradeCurricularLog(HistoricoVO obj, SqlRowSet dadosSQL, UsuarioVO usuario, NivelMontarDados nivelMontarDados) throws Exception {
		obj.setCodigo(dadosSQL.getInt("codigo"));
		obj.getMatricula().setMatricula(dadosSQL.getString("historico.matricula"));
		obj.getMatricula().getAluno().setNome(dadosSQL.getString("aluno"));
		obj.getMatricula().setSituacao(dadosSQL.getString("matricula.situacao"));
		obj.getMatriculaPeriodo().setCodigo(dadosSQL.getInt("matriculaperiodo"));
		obj.getMatriculaPeriodo().setSituacaoMatriculaPeriodo(dadosSQL.getString("matriculaperiodo.situacaomatriculaperiodo"));
		obj.setAnoHistorico(dadosSQL.getString("anoHistorico"));
		obj.setSemestreHistorico(dadosSQL.getString("semestreHistorico"));

		if (nivelMontarDados.equals(NivelMontarDados.TODOS)) {
			if (dadosSQL.getObject("disciplina") == null) {
				obj.getDisciplina().setCodigo((Integer) (dadosSQL.getObject("disciplina")));
			} else {
				obj.getDisciplina().setCodigo(dadosSQL.getInt("disciplina"));
			}
			if (dadosSQL.getObject("freguencia") == null) {
				obj.setFreguencia((Double) (dadosSQL.getObject("freguencia")));
			} else {
				obj.setFreguencia(new Double(dadosSQL.getDouble("freguencia")));
			}
			if (dadosSQL.getObject("mediaFinal") == null) {
				obj.setMediaFinal((Double) dadosSQL.getObject("mediaFinal"));
			} else {
				obj.setMediaFinal(dadosSQL.getDouble("mediaFinal"));
			}
			if (dadosSQL.getObject("historico.situacao") == null) {
				obj.setSituacao((String) dadosSQL.getObject("historico.situacao"));
			} else {
				obj.setSituacao(dadosSQL.getString("historico.situacao"));
			}
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarHistoricoPorGradeDisciplinaAlteracaoMatrizCurricularAtivaInativa(GradeDisciplinaVO gradeDisciplinaVO, UsuarioVO usuarioVO) {

		StringBuilder sql = new StringBuilder("update historico set cargahorariadisciplina = ?, creditodisciplina = ?, historicodisciplinacomposta = ?, disciplina = ? where gradedisciplina = ?");

		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql.toString());
				int i = 0;

				sqlAlterar.setInt(++i, gradeDisciplinaVO.getCargaHoraria().intValue());
				sqlAlterar.setInt(++i, gradeDisciplinaVO.getNrCreditos());
				sqlAlterar.setBoolean(++i, gradeDisciplinaVO.getDisciplinaComposta());
				sqlAlterar.setInt(++i, gradeDisciplinaVO.getDisciplina().getCodigo());
				sqlAlterar.setInt(++i, gradeDisciplinaVO.getCodigo());
				return sqlAlterar;
			}
		});
	}

	@Override
	public String consultarMensagemImpactoHistoricoPorGradeDisciplina(GradeDisciplinaVO gradeDisciplina, UsuarioVO usuario) throws Exception {
		StringBuffer sql = new StringBuffer("");
		String resultado = "";

		sql.append("select situacao, anohistorico, semestrehistorico, count(*) as total from historico WHERE gradedisciplina = ").append(gradeDisciplina.getCodigo());
		sql.append(" group by anohistorico, semestrehistorico, situacao order by anohistorico desc, semestrehistorico desc, situacao ");

		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		while (tabelaResultado.next()) {
			resultado  += "Qtd: " + tabelaResultado.getString("total") + " | Período: " + tabelaResultado.getString("anohistorico") + "/" + tabelaResultado.getString("semestrehistorico") + " | Situação: " +  SituacaoHistorico.getDescricao(tabelaResultado.getString("situacao")) + "<br/>";
		}
		return resultado;
	}


	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarHistoricoParaForaDaGradePorGradeDisciplina(GradeDisciplinaVO gradeDisciplinaVO, UsuarioVO usuario) throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append("update historico set gradedisciplina = null, historicodisciplinaforagrade = true where gradedisciplina = ?");
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql.toString());
				sqlAlterar.setInt(1, gradeDisciplinaVO.getCodigo());
				return sqlAlterar;
			}
		});
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirPorGradeDisciplina(Integer gradeDisciplina, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("DELETE FROM historico WHERE gradeDisciplina = ").append(gradeDisciplina).append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}
	public Boolean realizarLancamentoNotaHistoricoAutomaticamente(TipoNotaConceitoEnum tipoNotaAlterar, HistoricoVO historicoVO, Double nota, Boolean utilizaNotaConceito, ConfiguracaoAcademicoNotaConceitoVO notaConceito, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO, Boolean realizarCalculo, UsuarioVO usuarioVO) throws Exception {
		return realizarLancamentoNotaHistoricoAutomaticamente(tipoNotaAlterar, historicoVO, nota, utilizaNotaConceito, notaConceito, matriculaPeriodoTurmaDisciplinaVO, realizarCalculo, true, usuarioVO);
	}

	public void removerVinculoTransferenciaMatrizCurricularMatriculaHistorico(int transferenciaMatrizCurricularMatricula, UsuarioVO usuarioVO) throws Exception {
		if (Uteis.isAtributoPreenchido(transferenciaMatrizCurricularMatricula)) {
			StringBuilder sql = new StringBuilder("UPDATE historico SET transferenciamatrizcurricularmatricula = null WHERE transferenciamatrizcurricularmatricula = ? ")
					.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			getConexao().getJdbcTemplate().update(sql.toString(), new Object[] { transferenciaMatrizCurricularMatricula });
		}
	}


	@Override
	public void realizarMontagemTotalizadoresCargasHorarias(String filterAnoSemestre, HashMap<String, Integer> mapTotalCargasHorarias,	List<List<HistoricoVO>> listaPrincipalHistoricos) throws Exception  {
		 Integer  totalCargaHorariaPeriodoLetivoExigida = 0;
		 Integer totalCargaHorariaPeriodoLetivoCumprida =0;
		for(List<HistoricoVO> historicoVOs: listaPrincipalHistoricos){
			if(filterAnoSemestre.isEmpty() || filterAnoSemestre.equals(historicoVOs.get(0).getAnoSemestreApresentar())){
				Integer cargaHorariaPeriodoLetivoCumprida = 0;
				for(HistoricoVO historicoVO: historicoVOs){
					if(historicoVO.getSituacao().equals("AP")) {
						cargaHorariaPeriodoLetivoCumprida += historicoVO.getGradeDisciplinaVO().getCargaHoraria();
					}
				}
				totalCargaHorariaPeriodoLetivoExigida  += historicoVOs.get(0).getMatriculaPeriodo().getPeridoLetivo().getTotalCargaHoraria();

				historicoVOs.get(0).setTotalCargaHorariaPeriodoLetivoCumprida(cargaHorariaPeriodoLetivoCumprida);
				totalCargaHorariaPeriodoLetivoCumprida += historicoVOs.get(0).getTotalCargaHorariaPeriodoLetivoCumprida();
			}

		}
		mapTotalCargasHorarias.put("totalCargaHorariaPeriodoLetivoExigida", totalCargaHorariaPeriodoLetivoExigida);
		mapTotalCargasHorarias.put("totalCargaHorariaPeriodoLetivoCumprida", totalCargaHorariaPeriodoLetivoCumprida);

	}

    private String getSQLConsultaProfessorPorMatriculaPeriodoTurmaDisciplina(HistoricoVO historicoVO, String sqlEscolaridade) {
		StringBuilder sql = new StringBuilder("");
		if(Uteis.isAtributoPreenchido(historicoVO.getMatriculaPeriodoTurmaDisciplina())) {
			sql.append("(SELECT distinct pessoa.nome, pessoa.sexo, ( ").append(sqlEscolaridade);
			sql.append(" ), case when matriculaperiodoturmadisciplina.turma = professortitulardisciplinaturma.turma then 0 else 1 end as turmabaseprogramado  from matriculaperiodoturmadisciplina ");
			sql.append("inner join professortitulardisciplinaturma on (professortitulardisciplinaturma.turma = matriculaperiodoturmadisciplina.turma ");
			sql.append("or professortitulardisciplinaturma.turma in (select turmaorigem from turmaagrupada where turma = matriculaperiodoturmadisciplina.turma)) ");
			sql.append("and professortitulardisciplinaturma.disciplina = matriculaperiodoturmadisciplina.disciplina ");
			sql.append("and professortitulardisciplinaturma.ano = matriculaperiodoturmadisciplina.ano ");
			sql.append("and professortitulardisciplinaturma.semestre = matriculaperiodoturmadisciplina.semestre ");
			sql.append("inner join pessoa on professortitulardisciplinaturma.professor = pessoa.codigo ");
			sql.append("where matriculaperiodoturmadisciplina.codigo = ").append(historicoVO.getMatriculaPeriodoTurmaDisciplina().getCodigo());
			sql.append(" union ");
			sql.append("SELECT distinct pessoa.nome, pessoa.sexo, ( ").append(sqlEscolaridade);
			sql.append(" ), case when matriculaperiodoturmadisciplina.turma = professortitulardisciplinaturma.turma then 0 else 1 end as turmabaseprogramado  from matriculaperiodoturmadisciplina ");
			sql.append("inner join matricula on matricula.matricula = matriculaperiodoturmadisciplina.matricula ");
			sql.append("inner join professortitulardisciplinaturma on professortitulardisciplinaturma.curso = matricula.curso ");
			sql.append("and professortitulardisciplinaturma.disciplina = matriculaperiodoturmadisciplina.disciplina ");
			sql.append("and professortitulardisciplinaturma.ano = matriculaperiodoturmadisciplina.ano ");
			sql.append("and professortitulardisciplinaturma.semestre = matriculaperiodoturmadisciplina.semestre ");
			sql.append("and professortitulardisciplinaturma.turma is null  ");
			sql.append("inner join pessoa on professortitulardisciplinaturma.professor = pessoa.codigo ");
			sql.append("where matriculaperiodoturmadisciplina.codigo = ").append(historicoVO.getMatriculaPeriodoTurmaDisciplina().getCodigo());
			sql.append(" ) ");
		} else {			
			sql.append("(SELECT distinct pessoa.nome, pessoa.sexo, ( ").append(sqlEscolaridade).append(" ), 0 as turmabaseprogramado from historico ");
			sql.append("inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo ");
			sql.append("inner join professortitulardisciplinaturma on (professortitulardisciplinaturma.turma = matriculaperiodo.turma ");
			sql.append("or professortitulardisciplinaturma.turma in (select turmaorigem from turmaagrupada where turma = matriculaperiodo.turma)) ");
			sql.append("and professortitulardisciplinaturma.disciplina = historico.disciplina ");
			sql.append("and professortitulardisciplinaturma.ano = historico.anohistorico ");
			sql.append("and professortitulardisciplinaturma.semestre = historico.semestrehistorico ");
			sql.append("inner join pessoa on professortitulardisciplinaturma.professor = pessoa.codigo ");
			sql.append("where historico.codigo = ").append(historicoVO.getCodigo());
			sql.append(" union ");
			sql.append("SELECT distinct pessoa.nome, pessoa.sexo, ( ").append(sqlEscolaridade).append(" ), 0 as turmabaseprogramado from historico ");
			sql.append("inner join matriculaperiodo on matriculaperiodo.codigo = historico.matriculaperiodo ");
			sql.append("inner join matricula on matricula.matricula = matriculaperiodo.matricula ");
			sql.append("inner join professortitulardisciplinaturma on professortitulardisciplinaturma.curso = matricula.curso ");
			sql.append("and professortitulardisciplinaturma.disciplina = historico.disciplina ");
			sql.append("and professortitulardisciplinaturma.ano = historico.anohistorico ");
			sql.append("and professortitulardisciplinaturma.semestre = historico.semestrehistorico ");
			sql.append("and professortitulardisciplinaturma.turma is null  ");
			sql.append("inner join pessoa on professortitulardisciplinaturma.professor = pessoa.codigo ");
			sql.append("where historico.codigo = ").append(historicoVO.getCodigo());
			sql.append(" ) ");
		}
		return sql.toString();
	}

	public void montarProfessoresDisciplina(List<FuncionarioVO> professores, HistoricoVO historicoVO) {
		StringBuilder professoresDisciplina = new StringBuilder();

		for (FuncionarioVO professor : professores) {

			if(professor.getPessoa().getSexo().contains("F")) {
				professoresDisciplina.append("Profa. ");

				if(professor.getEscolaridade().equalsIgnoreCase("DR")) {
					professoresDisciplina.append("Dra. ");
				}
			}else {
				professoresDisciplina.append("Prof. ");
				if(professor.getEscolaridade().equalsIgnoreCase("DR")) {
					professoresDisciplina.append("Dr. ");
				}
			}

			if(professor.getEscolaridade().equalsIgnoreCase("PO")) {
				professoresDisciplina.append("POS. ");
			}
			else if(professor.getEscolaridade().equalsIgnoreCase("ME")) {
				professoresDisciplina.append("Ms. ");
			}
			else if(professor.getEscolaridade().equalsIgnoreCase("EP")) {
				professoresDisciplina.append("Esp. ");
			}
			else if(professor.getEscolaridade().equalsIgnoreCase("PD")) {
				professoresDisciplina.append("PhD. ");
			}

			professoresDisciplina.append(professor.getPessoa().getNome()).append(" / ");

		}
		historicoVO.setNomeProfessor(professoresDisciplina.substring(0, professoresDisciplina.length()-2));
	}
	
	@Override
	public boolean consultarSeExisteHistoricoDisciplinaClassificadaTCCAprovadasPorMatricula(String matricula, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select count(historico.situacao) as QTDE  from matricula	");
		sqlStr.append("	inner join periodoletivo on periodoletivo.gradecurricular = matricula.gradecurricularatual 	");
		sqlStr.append("	inner join gradedisciplina on gradedisciplina.periodoletivo = periodoletivo.periodoletivo	 ");
		sqlStr.append("	inner join historico  on historico.matricula = matricula.matricula and historico.gradedisciplina = gradedisciplina.codigo and historico.disciplina = gradedisciplina.disciplina ");
		sqlStr.append("	inner join disciplina on disciplina.codigo = gradedisciplina.disciplina 	");
		sqlStr.append("	where  matricula.matricula = ?  and historico.situacao IN ('AP','AA','AE','IS','CC','CH','AD','AB') 	 ");
		sqlStr.append("	 and ( gradedisciplina.disciplinatcc = true or disciplina.classificacaodisciplina = 'TCC' ) 	 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] {matricula});
		return Uteis.isAtributoPreenchido(tabelaResultado, Uteis.QTDE, TipoCampoEnum.INTEIRO);
	}
	
	@Override
	public List<HistoricoVO> consultaHistoricoParaApuracaoNotaBlackboard(SalaAulaBlackboardNotaVO obj, boolean isDisciplinaTcc, UsuarioVO usuarioLogado) throws Exception {
		String listaCodigoSalaAulaBlackboardPessoa = obj.getListaSalaAulaBlackboardPessoaNotaVO()
				.stream()
				.filter(p-> p.getSalaAulaBlackboardPessoaVO().getCodigo() > 0)
				.map(p -> p.getSalaAulaBlackboardPessoaVO().getCodigo().toString())
				.collect(Collectors.joining(","));
		StringBuffer sqlStr = getSQLPadraoConsultaCompletaConsiderandoTurmaPadrao();
		sqlStr.append(" inner join pessoaemailinstitucional on  pessoaemailinstitucional.pessoa = matricula.aluno ");
		sqlStr.append(" inner join salaaulablackboardpessoa on  salaaulablackboardpessoa.pessoaemailinstitucional = pessoaemailinstitucional.codigo ");
		sqlStr.append(" WHERE 1=1 ");
		if(isDisciplinaTcc) {
			sqlStr.append(" and ( gradedisciplina.disciplinatcc = true or disciplina.classificacaodisciplina = 'TCC' )");	
		}else {
			sqlStr.append(" and historico.disciplina = ").append(obj.getDisciplina());
		}
		sqlStr.append(" and historico.anohistorico = '").append(obj.getAno()).append("' ");
		sqlStr.append(" and historico.semestrehistorico = '").append(obj.getSemestre()).append("' ");
		sqlStr.append(" and ").append(adicionarFiltroSituacaoAcademicaHistorico(obj.getFiltroRelatorioAcademicoVO(), "historico"));
		sqlStr.append(" and salaaulablackboardpessoa.salaaulablackboard = ").append(obj.getSalaAulaBlackboard());
		sqlStr.append(" and salaaulablackboardpessoa.codigo in (").append(listaCodigoSalaAulaBlackboardPessoa).append(") ");		
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaCompleta(tabelaResultado, usuarioLogado);
	}
	
	
	@Override
	public List<HistoricoVO> consultaHistoricoParaConsolidarNotasPorSalaAulaBlackboard(SalaAulaBlackboardNotaVO obj, UsuarioVO usuarioLogado) throws Exception {
		StringBuffer str = new StringBuffer();
		// Dados do Historico
		str.append("SELECT distinct historico.codigo, historico.anoHistorico, historico.semestreHistorico, historico.tipoHistorico, historico.instituicao, historico.situacao, historico.freguencia, historico.frequenciaTeorica, historico.frequenciaPratica, historico.dataRegistro, historico.nota1, historico.nota2, historico.cidade, historico.cargaHorariaAproveitamentoDisciplina, historico.cargahorariacursada, historico.cargaHorariaDisciplina, ");
		str.append("historico.utilizaNotaFinalConceito, historico.notaFinalConceito, historico.historicoCriterioAvaliacaoAluno, historico.criterioAvaliacao, historico.creditodisciplina, ");
		str.append("historico.nota3, historico.nota4, historico.nota5, historico.nota6, historico.nota7, historico.nota8, historico.nota9, historico.nota10, ");
		str.append("historico.nota11, historico.nota12, historico.nota13, historico.nota14, historico.nota15, historico.nota16, ");
		str.append("historico.nota17, historico.nota18, historico.nota19, historico.nota20, historico.nota21, historico.nota22, ");
		str.append("historico.nota23, historico.nota24, historico.nota25, historico.nota26, historico.nota27, historico.nota28, ");
		str.append("historico.nota29, historico.nota30, historico.numeroAgrupamentoEquivalenciaDisciplina, ");
		str.append("historico.nota31, historico.nota32, historico.nota33, historico.nota34, historico.nota35, historico.nota36, ");
		str.append("historico.nota37, historico.nota38, historico.nota39, historico.nota40, historico.apresentarAprovadoHistorico, ");

		str.append("historico.mediaFinal, historico.transferenciaEntradaDisciplinasAproveitadas, historico.disciplinasAproveitadas, ");
		str.append("historico.nota1lancada, historico.nota2lancada, historico.nota3lancada, historico.nota4lancada, historico.nota5lancada, historico.nota6lancada, historico.nota7lancada, ");
		str.append("historico.nota8lancada, historico.nota9lancada, historico.nota10lancada, historico.nota11lancada, historico.nota12lancada, historico.nota13lancada, ");
		str.append("historico.nota14lancada, historico.nota15lancada, historico.nota16lancada, historico.nota17lancada, historico.nota18lancada, historico.nota19lancada, ");
		str.append("historico.nota20lancada, historico.nota21lancada, historico.nota22lancada, historico.nota23lancada, historico.nota24lancada, historico.nota25lancada, ");
		str.append("historico.nota26lancada, historico.nota27lancada, historico.nota28lancada, historico.nota29lancada, historico.nota30lancada,  ");
		str.append("historico.nota31lancada, historico.nota32lancada, historico.nota33lancada, historico.nota34lancada, historico.nota35lancada, historico.nota36lancada, ");
		str.append("historico.nota37lancada, historico.nota38lancada, historico.nota39lancada, historico.nota40lancada, ");

		str.append("historico.updated, anohistorico, semestrehistorico, historico.isentarMediaFinal, historico.notaFinalConceito as \"historico.notaFinalConceito\", ");

		str.append("historico.observacao AS \"historico.observacao\", historico.historicoDisciplinaAtividadeComplementar AS \"historico.historicoDisciplinaAtividadeComplementar\", ");
		str.append("historico.cargaHorariaDisciplina AS \"historico.cargaHorariaDisciplina\", historico.creditoDisciplina AS \"historico.creditoDisciplina\", ");
		str.append("historico.historicoDisciplinaOptativa AS \"historico.historicoDisciplinaOptativa\", historico.historicoDisciplinaForaGrade AS \"historico.historicoDisciplinaForaGrade\", ");
		str.append("historico.nomeDisciplina AS \"historico.nomeDisciplina\", historico.historicoDisciplinaAproveitada AS \"historico.historicoDisciplinaAproveitada\", ");
		str.append("historico.faltaPrimeiroBimestre AS \"historico.faltaPrimeiroBimestre\", historico.faltaSegundoBimestre AS \"historico.faltaSegundoBimestre\", ");
		str.append("historico.faltaTerceiroBimestre AS \"historico.faltaTerceiroBimestre\", historico.faltaQuartoBimestre AS \"historico.faltaQuartoBimestre\", ");
		str.append("historico.totalFalta AS \"historico.totalFalta\", ");
		str.append("historico.utilizaNotaFinalConceito AS \"historico.utilizaNotaFinalConceito\", ");
		
		//Dados Nota Conceito
		str.append(" historico.mediaFinalConceito, historico.nota1Conceito, historico.nota2Conceito, historico.nota3Conceito, historico.nota4Conceito, ");
		str.append(" historico.nota5Conceito, historico.nota6Conceito, historico.nota7Conceito, historico.nota8Conceito, historico.nota9Conceito, historico.nota10Conceito,  ");
		str.append(" historico.nota11Conceito, historico.nota12Conceito, historico.nota13Conceito, historico.nota14Conceito, historico.nota15Conceito, historico.nota16Conceito, ");
		str.append(" historico.nota17Conceito, historico.nota18Conceito, historico.nota19Conceito, historico.nota20Conceito, historico.nota21Conceito, historico.nota22Conceito, ");
		str.append(" historico.nota23Conceito, historico.nota24Conceito, historico.nota25Conceito, historico.nota26Conceito, historico.nota27Conceito, historico.nota28Conceito, ");
		str.append(" historico.nota29Conceito, historico.nota30Conceito, historico.nota31Conceito, historico.nota32Conceito, historico.nota33Conceito, historico.nota34Conceito, ");
		str.append(" historico.nota35Conceito, historico.nota36Conceito, historico.nota37Conceito, historico.nota38Conceito, historico.nota39Conceito, historico.nota40Conceito, ");

		str.append("historico.transferenciaMatrizCurricularMatricula AS \"historico.transferenciaMatrizCurricularMatricula\",  ");
		str.append("historico.historicoGeradoAPartirTransferenciaMatrizCurricular AS \"historico.historicoGeradoAPartirTransferenciaMatrizCurricular\",  ");
		str.append("historico.observacaoTransferenciaMatrizCurricular AS \"historico.observacaoTransferenciaMatrizCurricular\",  ");
		str.append("historico.historicoCursandoPorCorrespondenciaAposTransferencia AS \"historico.historicoCursandoPorCorrespondenciaAposTransferencia\", historico.dataInicioAula as \"historico.dataInicioAula\", historico.dataFimAula as \"historico.dataFimAula\",");
		// Dados da Matriz Curricular do Historico
		str.append("gradeCurricular.codigo AS \"gradeCurricular.codigo\", ");
		str.append("gradeCurricular.nome AS \"gradeCurricular.nome\", ");

		// Dados do Periodo Letivo Matriz Curricular
		str.append("periodoLetivoMatrizCurricular.codigo AS \"periodoLetivoMatrizCurricular.codigo\", ");
		str.append("periodoLetivoMatrizCurricular.descricao AS \"periodoLetivoMatrizCurricular.descricao\", ");
		str.append("periodoLetivoMatrizCurricular.periodoLetivo AS \"periodoLetivoMatrizCurricular.periodoLetivo\", ");

		// Dados da Matriz Curricular
		str.append("matrizCurricular.codigo AS \"matrizCurricular.codigo\", ");
		str.append("matrizCurricular.nome AS \"matrizCurricular.nome\", ");

		// Dados do Periodo Letivo Cursada
		str.append("periodoLetivoCursada.codigo AS \"periodoLetivoCursada.codigo\", ");
		str.append("periodoLetivoCursada.descricao AS \"periodoLetivoCursada.descricao\", ");
		str.append("periodoLetivoCursada.periodoLetivo AS \"periodoLetivoCursada.periodoLetivo\", ");

		// Dados do Configuracao Academico
		str.append(" configuracaoAcademico.codigo AS \"configuracaoAcademico.codigo\",  ");
		str.append(" configuracaoAcademico.nome AS \"configuracaoAcademico.nome\",  ");
		str.append(" configuracaoAcademico.intervaloNotasDiferente AS \"configuracaoAcademico.intervaloNotasDiferente\",  ");

		// Dados do Matricula Periodo Turma Disciplina
		str.append(" matriculaPeriodoTurmaDisciplina.codigo AS \"matriculaPeriodoTurmaDisciplina.codigo\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Semestre
		str.append(" matriculaPeriodoTurmaDisciplina.semestre AS \"matriculaPeriodoTurmaDisciplina.semestre\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Ano
		str.append(" matriculaPeriodoTurmaDisciplina.ano AS \"matriculaPeriodoTurmaDisciplina.ano\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turma AS \"matriculaPeriodoTurmaDisciplina.turma\", matriculaPeriodoTurmaDisciplina.turmaTeorica, matriculaPeriodoTurmaDisciplina.turmaPratica, ");
		// Dados do Turma
		str.append(" turma.codigo AS \"turma.codigo\",  ");
		str.append(" turma.identificadorTurma AS \"turma.identificadorTurma\",  ");
		// Dados do Turno
		str.append(" turno.nome AS \"turno.nome\",  ");
		// Dados da Grade Curricular
		str.append(" gradeCurricular.nome AS \"gradeCurricular.nome\", ");
		// Dados do Matricula Periodo
		str.append(" matriculaPeriodo.codigo AS \"matriculaPeriodo.codigo\", matriculaPeriodo.situacao AS \"matriculaPeriodo.situacao\", matriculaperiodo.situacaoMatriculaPeriodo as \"matriculaperiodo.situacaoMatriculaPeriodo\", matriculaperiodo.datafechamentomatriculaperiodo as \"matriculaperiodo.datafechamentomatriculaperiodo\", matriculaperiodo.data as \"matriculaperiodo.data\", ");
		// Dados do Periodo Letivo
		str.append(" periodoLetivo.descricao AS \"periodoLetivo.descricao\",  ");
		// Dados da Matricula
		str.append(" matricula.matricula AS \"matricula.matricula\",  ");
		str.append(" matricula.updated AS \"matricula.updated\",  ");
		str.append(" matricula.situacao AS \"matricula.situacao\",  ");
		str.append(" matricula.tipoMatricula AS \"matricula.tipoMatricula\",  ");
		str.append(" matricula.situacaoFinanceira AS \"matricula.situacaoFinanceira\", matricula.canceladoFinanceiro, ");
		str.append(" matricula.gradecurricularatual AS \"matricula.gradecurricularatual\",  ");
		// Dados do Curso
		str.append(" curso.codigo AS \"curso.codigo\", curso.nome AS \"curso.nome\", ");
		// Dados da Unidade Ensino
		str.append(" unidadeEnsino.codigo AS \"unidadeEnsino.codigo\", unidadeEnsino.nome AS \"unidadeEnsino.nome\", ");
		// Dados do Aluno
		str.append(" aluno.codigo AS \"aluno.codigo\", aluno.nome AS \"aluno.nome\", ");
		// Dados do Usuario
		str.append(" usuario.nome AS \"responsavel.nome\", usuario.codigo AS \"responsavel.codigo\", ");
		// Dados da Disciplina
		str.append(" disciplina.codigo AS \"disciplina.codigo\", disciplina.nome AS \"disciplina.nome\", ");

		// DISCIPLINA COMPOSTA E EQUIVALENCIA
		str.append(" historico.historicoPorEquivalencia AS \"historico.historicoPorEquivalencia\", historico.historicoEquivalente AS \"historico.historicoEquivalente\", ");
		str.append(" historico.gradeDisciplinaComposta AS \"historico.gradeDisciplinaComposta\", ");
		str.append(" gradeDisciplinaComposta.variavelNota AS \"gradeDisciplinaComposta.variavelNota\", ");
		str.append(" gradeDisciplinaComposta.ordem AS \"gradeDisciplinaComposta.ordem\", ");
		str.append(" gradeDisciplinaComposta.cargahoraria AS \"gradeDisciplinaComposta.cargahoraria\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaPratica AS \"gradeDisciplinaComposta.cargahorariaPratica\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaTeorica AS \"gradeDisciplinaComposta.cargahorariaTeorica\", ");
		str.append(" gradeDisciplinaComposta.nrcreditos AS \"gradeDisciplinaComposta.nrcreditos\", ");
		str.append(" gradeDisciplinaComposta.horaaula AS \"gradeDisciplinaComposta.horaaula\", ");
		str.append(" historico.historicoDisciplinaComposta AS \"historico.historicoDisciplinaComposta\", historico.historicoDisciplinaFazParteComposicao, ");
		str.append(" historico.mapaEquivalenciaDisciplina AS \"historico.mapaEquivalenciaDisciplina\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaCursada AS \"historico.mapaEquivalenciaDisciplinaCursada\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaMatrizCurricular AS \"historico.mapaEquivalenciaDisciplinaMatrizCurricular\", ");

		// Dados da Grade Disciplina
		str.append(" gradedisciplina.codigo AS \"gradedisciplina.codigo\", ");
		str.append(" gradedisciplina.disciplina AS \"gradedisciplina.disciplina\", ");
		str.append(" gradedisciplina.cargaHoraria AS \"gradedisciplina.cargaHoraria\", ");
		str.append(" gradedisciplina.cargaHorariapratica AS \"gradedisciplina.cargaHorariapratica\", ");
		str.append(" gradedisciplina.nrCreditos AS \"gradedisciplina.nrCreditos\", ");
		str.append(" gradedisciplina.diversificada AS \"gradedisciplina.diversificada\", ");
		str.append(" gradedisciplina.disciplinaComposta AS \"gradedisciplina.disciplinaComposta\", ");
		str.append(" gradedisciplina.disciplinaEixoTematico AS \"gradedisciplina.disciplinaEixoTematico\", ");
		str.append(" gradedisciplina.formulaCalculoNota AS \"gradedisciplina.formulaCalculoNota\", ");
		str.append(" gradedisciplina.formulaCalculo AS \"gradedisciplina.formulaCalculo\", ");
		str.append(" gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradedisciplina.variavelNotaRecuperacao AS \"gradedisciplina.variavelNotaRecuperacao\", ");
		str.append(" gradedisciplina.condicaoUsoRecuperacao AS \"gradedisciplina.condicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gradedisciplina.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperada AS \"gradedisciplina.formulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperacao AS \"gradedisciplina.formulaCalculoNotaRecuperacao\", ");
		str.append(" gradedisciplina.horaaula AS \"gradedisciplina.horaaula\", ");

		// Dados da Grade Curricular Grupo Optativa Disciplina
		// (GradeCurricularGrupoOptativaDisciplina)
		str.append(" historico.gradeCurricularGrupoOptativaDisciplina AS \"historico.gradeCurricularGrupoOptativaDisciplina\",  ");
		str.append(" historico.disciplinaReferenteAUmGrupoOptativa AS \"historico.disciplinaReferenteAUmGrupoOptativa\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.codigo AS \"gradeCurricularGrupoOptativaDisciplina.codigo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplina AS \"gradeCurricularGrupoOptativaDisciplina.disciplina\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHoraria AS \"gradeCurricularGrupoOptativaDisciplina.cargaHoraria\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica AS \"gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.nrCreditos AS \"gradeCurricularGrupoOptativaDisciplina.nrCreditos\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.diversificada AS \"gradeCurricularGrupoOptativaDisciplina.diversificada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplinaComposta AS \"gradeCurricularGrupoOptativaDisciplina.disciplinaComposta\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculo AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gcgod.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaRecuperacao AS \"gcgod.variavelNotaRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.condicaoUsoRecuperacao AS \"gcgod.condicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gcgod.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperada AS \"gcgod.formulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gcgod.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.horaaula AS \"gcgod.horaaula\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperacao AS \"gcgod.formulaCalculoNotaRecuperacao\", ");
		str.append(" exists (select historiconota.codigo from historiconota where historiconota.historico = historico.codigo and historiconota.notarecuperacao and situacaorecuperacaonota = '").append(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO.name()).append("' limit 1) as emrecuperacao" );
		str.append(" from  (	");
		str.append(" 	select distinct historico.codigo as historico	");
		str.append(" 	from salaaulablackboardoperacao	");
		str.append(" 	inner join salaaulablackboard on  salaaulablackboard.codigo = salaaulablackboardoperacao.codigoorigem	");
		str.append(" 	inner join salaaulablackboardpessoa on  salaaulablackboardpessoa.salaaulablackboard = salaaulablackboard.codigo	");
		str.append(" 	inner join historico on historico.matricula = salaaulablackboardpessoa.matricula and  historico.disciplina = salaaulablackboard.disciplina 	");
		str.append(" 	and historico.anohistorico = salaaulablackboard.ano and historico.semestrehistorico = salaaulablackboard.semestre 	");
		str.append(" 	where salaaulablackboardoperacao.codigo = ").append(obj.getCodigoOperacao());
		str.append(" 	and salaaulablackboardpessoa.tiposalaaulablackboardpessoaenum = 'ALUNO'	");
		str.append("    and ").append(adicionarFiltroSituacaoAcademicaHistorico(obj.getFiltroRelatorioAcademicoVO(), "historico"));
		str.append(" ) as validar_historico 	");
		str.append(" INNER JOIN historico as historico on validar_historico.historico = historico.codigo ");
		str.append(" INNER JOIN matricula on matricula.matricula = historico.matricula ");
		str.append(" INNER JOIN matriculaPeriodo on matriculaPeriodo.matricula = matricula.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		str.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		str.append(" INNER JOIN Turma ON turma.codigo = matriculaPeriodo.turma ");
		str.append(" LEFT JOIN gradeCurricular on historico.matrizCurricular = gradeCurricular.codigo ");
		str.append(" LEFT JOIN disciplina on disciplina.codigo = historico.disciplina ");
		str.append(" LEFT JOIN pessoa AS \"aluno\" on aluno.codigo = matricula.aluno ");
		str.append(" LEFT JOIN periodoLetivo on historico.periodoLetivoMatrizCurricular = periodoLetivo.codigo ");
		str.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		str.append(" LEFT JOIN gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		str.append(" LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		str.append(" LEFT JOIN usuario on usuario.codigo = historico.responsavel ");

		str.append(" LEFT JOIN turno on matricula.turno = turno.codigo ");
		str.append(" LEFT JOIN unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeEnsino ");
		str.append(" LEFT JOIN curso on curso.codigo = matricula.curso ");

		str.append(" LEFT JOIN periodoLetivo as periodoLetivoMatrizCurricular on historico.periodoLetivoMatrizCurricular = periodoLetivoMatrizCurricular.codigo ");
		str.append(" LEFT JOIN periodoLetivo as periodoLetivoCursada on historico.periodoLetivoCursada = periodoLetivoCursada.codigo ");
		str.append(" LEFT JOIN gradeCurricular as matrizCurricular on matricula.gradecurricularatual = matrizCurricular.codigo ");
		str.append(" LEFT JOIN configuracaoAcademico on configuracaoAcademico.codigo = historico.configuracaoAcademico ");
		str.append(" WHERE 1=1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(str.toString());
		return montarDadosConsultaCompleta(tabelaResultado, usuarioLogado);
	}
	
	

    @Override
    public List<HistoricoVO> consultaPorUnidadeEnsinoCursoDisciplinaTurmaAnoSemestreSituacaoMatricula(List<UnidadeEnsinoVO> unidadeEnsinoVOs, Integer curso, Integer disciplina, Integer turma, String ano, String semestre, List<Integer> matriculaPeriodoTurmaDisciplinas, FiltroRelatorioAcademicoVO filtroRelatorioAcademicoVO, int nivelMontarDados, UsuarioVO usuarioLogado) throws Exception {
        StringBuffer sqlStr = getSQLPadraoConsultaCompletaConsiderandoTurmaPadrao();
        sqlStr.append(" WHERE 1=1 ");
//        adicionarFiltroUnidadeEnsino(unidadeEnsinoVOs, sqlStr);
//        if (Uteis.isAtributoPreenchido(curso)) {
//            sqlStr.append(" AND curso.codigo = ").append(curso);
//        }
//        if (Uteis.isAtributoPreenchido(disciplina)) {
//            sqlStr.append(" AND disciplina.codigo = ").append(disciplina);
//        }
//        if (Uteis.isAtributoPreenchido(turma)) {
//            sqlStr.append(" AND turma.codigo = ").append(turma);
//        }
        
        sqlStr.append(" and matriculaPeriodoTurmaDisciplina.codigo in (")
                .append(matriculaPeriodoTurmaDisciplinas.stream().map(Objects::toString).collect(Collectors.joining(",")))
                .append(") ");
        if (!semestre.equals("")) {
            sqlStr.append(" and matriculaPeriodoTurmaDisciplina.semestre = '").append(semestre).append("' ");
        }
        if (!ano.equals("")) {
            sqlStr.append(" and matriculaPeriodoTurmaDisciplina.ano = '").append(ano).append("' ");
        }
        if(!filtroRelatorioAcademicoVO.isTodasSituacoesMatriculaDesmarcadas()) {
            sqlStr.append(" and ").append(adicionarFiltroSituacaoAcademicaMatricula(filtroRelatorioAcademicoVO, "matricula"));
        }
        SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
        return montarDadosConsultaCompleta(tabelaResultado, usuarioLogado);
    }

    private void adicionarFiltroUnidadeEnsino(List<UnidadeEnsinoVO> unidadeEnsinoVOs, StringBuffer sql) {
        if (unidadeEnsinoVOs.stream().anyMatch(UnidadeEnsinoVO::getFiltrarUnidadeEnsino)) {
            sql.append(" and unidadeensino.codigo in (")
                    .append(unidadeEnsinoVOs.stream().filter(UnidadeEnsinoVO::getFiltrarUnidadeEnsino)
                            .map(UnidadeEnsinoVO::getCodigo)
                            .map(Objects::toString)
                            .collect(Collectors.joining(",")))
                    .append(") ");
        }
    }

	
    
	
	@Override
	public void realizarInclusaoHistoricosAntigosNovaMatriculaPorMatriculaAnterior(MatriculaVO matriculaVO, MatriculaPeriodoVO matPeriodo, 	MatriculaVO matriculaAntigaVO ,List<HistoricoVO> listaHistoricoAproveitar ,UsuarioVO usuario ) throws Exception {
		try {
					
		Iterator i = listaHistoricoAproveitar.iterator(); 
		while(i.hasNext()) {			
			HistoricoVO historicoVO = (HistoricoVO) ((HistoricoVO) i.next()).clone() ;
			historicoVO.setCodigo(0);
			historicoVO.setNovoObj(Boolean.TRUE);
			historicoVO.setDataRegistro(new Date());
			historicoVO.setResponsavel(usuario);
			historicoVO.setMatricula(matriculaVO);
			historicoVO.setMatriculaPeriodo(matPeriodo);
			historicoVO.setMatrizCurricular(matriculaVO.getGradeCurricularAtual());
            historicoVO.setGradeDisciplinaVO(getFacadeFactory().getGradeDisciplinaFacade().consultarPorGradeCurricularEDisciplina(matriculaVO.getGradeCurricularAtual().getCodigo(), historicoVO.getDisciplina().getCodigo(), usuario, historicoVO.getMatricula().getCurso().getConfiguracaoAcademico()));
            historicoVO.setPeriodoLetivoCursada(historicoVO.getGradeDisciplinaVO().getPeriodoLetivoVO());
            historicoVO.setPeriodoLetivoMatrizCurricular(historicoVO.getGradeDisciplinaVO().getPeriodoLetivoVO());
            historicoVO.setMatriculaPeriodoTurmaDisciplina(null);
            if(historicoVO.getHistoricoEquivalente().equals(Boolean.FALSE)) {
                historicoVO.setMapaEquivalenciaDisciplina(null);
                historicoVO.setMapaEquivalenciaDisciplinaCursada(null);
                historicoVO.setMapaEquivalenciaDisciplinaMatrizCurricular(null);
           }
            historicoVO.setGradeDisciplinaComposta(null);
            historicoVO.setGradeCurricularGrupoOptativaDisciplinaVO(null);            
			getFacadeFactory().getHistoricoFacade().incluir(historicoVO, usuario);
		}
		}catch(Exception e) {
			throw e;
		}
		
		
	}
	
	
	@Override
	public List<HistoricoVO> consultaRapidaPorMatriculaDadosCompletos(String matricula,  boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>();
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (matricula.matricula = '").append(matricula).append("') ");		
		sqlStr.append(" ORDER BY historico.codigo desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		while (tabelaResultado.next()) {
			HistoricoVO historicoVO = new HistoricoVO();
			montarDadosCompleto(historicoVO, tabelaResultado, usuario);
			vetResultado.add(historicoVO);
		}
		return vetResultado;	
		
	}
	
	public List<HistoricoVO> consultarHistoricoCalculoCoeficienteRendimento(String matricula) {
		StringBuffer sqlStr = new StringBuffer();
		List<HistoricoVO> vetResultado = new ArrayList<HistoricoVO>();
		sqlStr.append(" SELECT codigo, mediafinal FROM historico ");
		sqlStr.append(" WHERE 1=1  AND historico.situacao in ('AP', 'RE', 'RF', 'RP')  AND historico.matricula = '").append(matricula).append("' ");
		sqlStr.append(" AND (historico.historicoequivalente = false or historico.historicoequivalente is null) ");
		sqlStr.append(" AND (historico.historicodisciplinafazpartecomposicao = false or historico.historicodisciplinafazpartecomposicao is null) ");

		SqlRowSet dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		while (dadosSQL.next()) {
			HistoricoVO historicoVO = new HistoricoVO();
			historicoVO.setCodigo(dadosSQL.getInt("codigo"));
			historicoVO.setMediaFinal(dadosSQL.getDouble("mediafinal"));
			vetResultado.add(historicoVO);
		}
	return vetResultado;
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void verificarMatriculaDohistoricoSituacaoTransferidoERealizarAproveitamentoDisciplinaParaCursoTransferido(HistoricoVO histVO, UsuarioVO usuarioVO) throws Exception {
	    //  verificar se o aluno saiu daqui aprovado 
		// verificar se a matricula desse historico ta com situacao transferido
		// verificar qual curso transferiu
		// verificar se este curso tem esta disciplina e fazer o aproveitamento automatico pro aluno 
		if (histVO.getAprovado() && getFacadeFactory().getMatriculaFacade()
				.verificarMatriculaGeradaDaTransferenciaPossuiDisciplinaNaGradeCurricularParaAproveitamento(
						histVO.getMatricula().getMatricula(), histVO.getDisciplina().getCodigo(), usuarioVO)) {

			MatriculaVO matriculaTransferidaDestino = getFacadeFactory().getMatriculaFacade()
					.consultarMatriculaTransferidaDestinoPorMatriculaTransferidaOrigem(
							histVO.getMatricula().getMatricula(), Uteis.NIVELMONTARDADOS_TODOS, null, usuarioVO);

			if (Uteis.isAtributoPreenchido(matriculaTransferidaDestino)) {

				List<HistoricoVO> listaDeHistoricosDaDisciplina = getFacadeFactory().getHistoricoFacade()
						.consultarPorMatriculaDisciplinaSituacao(matriculaTransferidaDestino.getMatricula(),
								histVO.getDisciplina().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, null,
								usuarioVO);

				if (Uteis.isAtributoPreenchido(listaDeHistoricosDaDisciplina)
						&& listaDeHistoricosDaDisciplina.stream().anyMatch(hist -> hist.getAprovado())) {
					return;
				}

				if (Uteis.isAtributoPreenchido(listaDeHistoricosDaDisciplina)) {

					getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade()
							.excluirComBaseNaMatriculaPeriodoMatriculaCodDisciplina(
									matriculaTransferidaDestino.getUltimoMatriculaPeriodoVO().getCodigo(),
									matriculaTransferidaDestino.getMatricula(), histVO.getDisciplina().getCodigo(),
									usuarioVO);
					getFacadeFactory().getHistoricoFacade()
							.excluirComBaseNaMatriculaPeriodoMatrizCurricularCodDisciplinaSituacaoHistorico(
									matriculaTransferidaDestino.getUltimoMatriculaPeriodoVO().getCodigo(),
									matriculaTransferidaDestino.getGradeCurricularAtual().getCodigo(),
									histVO.getDisciplina().getCodigo(), "", null, usuarioVO);

				}

				getFacadeFactory().getHistoricoFacade()
						.realizarInclusaoHistoricosAntigosNovaMatriculaPorMatriculaAnterior(matriculaTransferidaDestino,
								matriculaTransferidaDestino.getUltimoMatriculaPeriodoVO(), null, Arrays.asList(histVO),
								usuarioVO);

			}
		}
	}
	
	@Override
	public List<HistoricoVO> consultaHistoricoParaFechamentoNotasPorBlackboard(BlackboardFechamentoNotaOperacaoVO obj, FiltroRelatorioAcademicoVO filtroRelatorioAcademico, UsuarioVO usuarioLogado) throws Exception {
		StringBuffer str = new StringBuffer();
		// Dados do Historico
		str.append("SELECT distinct historico.codigo, historico.anoHistorico, historico.semestreHistorico, historico.tipoHistorico, historico.instituicao, historico.situacao, historico.freguencia, historico.frequenciaTeorica, historico.frequenciaPratica, historico.dataRegistro, historico.nota1, historico.nota2, historico.cidade, historico.cargaHorariaAproveitamentoDisciplina, historico.cargahorariacursada, historico.cargaHorariaDisciplina, ");
		str.append("historico.utilizaNotaFinalConceito, historico.notaFinalConceito, historico.historicoCriterioAvaliacaoAluno, historico.criterioAvaliacao, historico.creditodisciplina, ");
		str.append("historico.nota3, historico.nota4, historico.nota5, historico.nota6, historico.nota7, historico.nota8, historico.nota9, historico.nota10, ");
		str.append("historico.nota11, historico.nota12, historico.nota13, historico.nota14, historico.nota15, historico.nota16, ");
		str.append("historico.nota17, historico.nota18, historico.nota19, historico.nota20, historico.nota21, historico.nota22, ");
		str.append("historico.nota23, historico.nota24, historico.nota25, historico.nota26, historico.nota27, historico.nota28, ");
		str.append("historico.nota29, historico.nota30, historico.numeroAgrupamentoEquivalenciaDisciplina, ");
		str.append("historico.nota31, historico.nota32, historico.nota33, historico.nota34, historico.nota35, historico.nota36, ");
		str.append("historico.nota37, historico.nota38, historico.nota39, historico.nota40, historico.apresentarAprovadoHistorico, ");
		str.append("historico.mediaFinal, historico.transferenciaEntradaDisciplinasAproveitadas, historico.disciplinasAproveitadas, ");
		str.append("historico.nota1lancada, historico.nota2lancada, historico.nota3lancada, historico.nota4lancada, historico.nota5lancada, historico.nota6lancada, historico.nota7lancada, ");
		str.append("historico.nota8lancada, historico.nota9lancada, historico.nota10lancada, historico.nota11lancada, historico.nota12lancada, historico.nota13lancada, ");
		str.append("historico.nota14lancada, historico.nota15lancada, historico.nota16lancada, historico.nota17lancada, historico.nota18lancada, historico.nota19lancada, ");
		str.append("historico.nota20lancada, historico.nota21lancada, historico.nota22lancada, historico.nota23lancada, historico.nota24lancada, historico.nota25lancada, ");
		str.append("historico.nota26lancada, historico.nota27lancada, historico.nota28lancada, historico.nota29lancada, historico.nota30lancada,  ");
		str.append("historico.nota31lancada, historico.nota32lancada, historico.nota33lancada, historico.nota34lancada, historico.nota35lancada, historico.nota36lancada, ");
		str.append("historico.nota37lancada, historico.nota38lancada, historico.nota39lancada, historico.nota40lancada, ");
		str.append("historico.updated, anohistorico, semestrehistorico, historico.isentarMediaFinal, historico.notaFinalConceito as \"historico.notaFinalConceito\", ");
		str.append("historico.observacao AS \"historico.observacao\", historico.historicoDisciplinaAtividadeComplementar AS \"historico.historicoDisciplinaAtividadeComplementar\", ");
		str.append("historico.cargaHorariaDisciplina AS \"historico.cargaHorariaDisciplina\", historico.creditoDisciplina AS \"historico.creditoDisciplina\", ");
		str.append("historico.historicoDisciplinaOptativa AS \"historico.historicoDisciplinaOptativa\", historico.historicoDisciplinaForaGrade AS \"historico.historicoDisciplinaForaGrade\", ");
		str.append("historico.nomeDisciplina AS \"historico.nomeDisciplina\", historico.historicoDisciplinaAproveitada AS \"historico.historicoDisciplinaAproveitada\", ");
		str.append("historico.faltaPrimeiroBimestre AS \"historico.faltaPrimeiroBimestre\", historico.faltaSegundoBimestre AS \"historico.faltaSegundoBimestre\", ");
		str.append("historico.faltaTerceiroBimestre AS \"historico.faltaTerceiroBimestre\", historico.faltaQuartoBimestre AS \"historico.faltaQuartoBimestre\", ");
		str.append("historico.totalFalta AS \"historico.totalFalta\", ");
		str.append("historico.utilizaNotaFinalConceito AS \"historico.utilizaNotaFinalConceito\", ");
		//Dados Nota Conceito
		str.append(" historico.mediaFinalConceito, historico.nota1Conceito, historico.nota2Conceito, historico.nota3Conceito, historico.nota4Conceito, ");
		str.append(" historico.nota5Conceito, historico.nota6Conceito, historico.nota7Conceito, historico.nota8Conceito, historico.nota9Conceito, historico.nota10Conceito,  ");
		str.append(" historico.nota11Conceito, historico.nota12Conceito, historico.nota13Conceito, historico.nota14Conceito, historico.nota15Conceito, historico.nota16Conceito, ");
		str.append(" historico.nota17Conceito, historico.nota18Conceito, historico.nota19Conceito, historico.nota20Conceito, historico.nota21Conceito, historico.nota22Conceito, ");
		str.append(" historico.nota23Conceito, historico.nota24Conceito, historico.nota25Conceito, historico.nota26Conceito, historico.nota27Conceito, historico.nota28Conceito, ");
		str.append(" historico.nota29Conceito, historico.nota30Conceito, historico.nota31Conceito, historico.nota32Conceito, historico.nota33Conceito, historico.nota34Conceito, ");
		str.append(" historico.nota35Conceito, historico.nota36Conceito, historico.nota37Conceito, historico.nota38Conceito, historico.nota39Conceito, historico.nota40Conceito, ");
		str.append("historico.transferenciaMatrizCurricularMatricula AS \"historico.transferenciaMatrizCurricularMatricula\",  ");
		str.append("historico.historicoGeradoAPartirTransferenciaMatrizCurricular AS \"historico.historicoGeradoAPartirTransferenciaMatrizCurricular\",  ");
		str.append("historico.observacaoTransferenciaMatrizCurricular AS \"historico.observacaoTransferenciaMatrizCurricular\",  ");
		str.append("historico.historicoCursandoPorCorrespondenciaAposTransferencia AS \"historico.historicoCursandoPorCorrespondenciaAposTransferencia\", historico.dataInicioAula as \"historico.dataInicioAula\", historico.dataFimAula as \"historico.dataFimAula\",");
		// Dados da Matriz Curricular do Historico
		str.append("gradeCurricular.codigo AS \"gradeCurricular.codigo\", ");
		str.append("gradeCurricular.nome AS \"gradeCurricular.nome\", ");
		// Dados do Periodo Letivo Matriz Curricular
		str.append("periodoLetivoMatrizCurricular.codigo AS \"periodoLetivoMatrizCurricular.codigo\", ");
		str.append("periodoLetivoMatrizCurricular.descricao AS \"periodoLetivoMatrizCurricular.descricao\", ");
		str.append("periodoLetivoMatrizCurricular.periodoLetivo AS \"periodoLetivoMatrizCurricular.periodoLetivo\", ");
		// Dados da Matriz Curricular
		str.append("matrizCurricular.codigo AS \"matrizCurricular.codigo\", ");
		str.append("matrizCurricular.nome AS \"matrizCurricular.nome\", ");
		// Dados do Periodo Letivo Cursada
		str.append("periodoLetivoCursada.codigo AS \"periodoLetivoCursada.codigo\", ");
		str.append("periodoLetivoCursada.descricao AS \"periodoLetivoCursada.descricao\", ");
		str.append("periodoLetivoCursada.periodoLetivo AS \"periodoLetivoCursada.periodoLetivo\", ");
		// Dados do Configuracao Academico
		str.append(" configuracaoAcademico.codigo AS \"configuracaoAcademico.codigo\",  ");
		str.append(" configuracaoAcademico.nome AS \"configuracaoAcademico.nome\",  ");
		str.append(" configuracaoAcademico.intervaloNotasDiferente AS \"configuracaoAcademico.intervaloNotasDiferente\",  ");
		// Dados do Matricula Periodo Turma Disciplina
		str.append(" matriculaPeriodoTurmaDisciplina.codigo AS \"matriculaPeriodoTurmaDisciplina.codigo\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Semestre
		str.append(" matriculaPeriodoTurmaDisciplina.semestre AS \"matriculaPeriodoTurmaDisciplina.semestre\",  ");
		// Dados do Matricula Periodo Turma Disciplina - Ano
		str.append(" matriculaPeriodoTurmaDisciplina.ano AS \"matriculaPeriodoTurmaDisciplina.ano\",  ");
		str.append(" matriculaPeriodoTurmaDisciplina.turma AS \"matriculaPeriodoTurmaDisciplina.turma\", matriculaPeriodoTurmaDisciplina.turmaTeorica, matriculaPeriodoTurmaDisciplina.turmaPratica, ");
		// Dados do Turma
		str.append(" turma.codigo AS \"turma.codigo\",  ");
		str.append(" turma.identificadorTurma AS \"turma.identificadorTurma\",  ");
		// Dados do Turno
		str.append(" turno.nome AS \"turno.nome\",  ");
		// Dados da Grade Curricular
		str.append(" gradeCurricular.nome AS \"gradeCurricular.nome\", ");
		// Dados do Matricula Periodo
		str.append(" matriculaPeriodo.codigo AS \"matriculaPeriodo.codigo\", matriculaPeriodo.situacao AS \"matriculaPeriodo.situacao\", matriculaperiodo.situacaoMatriculaPeriodo as \"matriculaperiodo.situacaoMatriculaPeriodo\", matriculaperiodo.datafechamentomatriculaperiodo as \"matriculaperiodo.datafechamentomatriculaperiodo\", matriculaperiodo.data as \"matriculaperiodo.data\", ");
		// Dados do Periodo Letivo
		str.append(" periodoLetivo.descricao AS \"periodoLetivo.descricao\",  ");
		// Dados da Matricula
		str.append(" matricula.matricula AS \"matricula.matricula\",  ");
		str.append(" matricula.updated AS \"matricula.updated\",  ");
		str.append(" matricula.situacao AS \"matricula.situacao\",  ");
		str.append(" matricula.tipoMatricula AS \"matricula.tipoMatricula\",  ");
		str.append(" matricula.situacaoFinanceira AS \"matricula.situacaoFinanceira\", matricula.canceladoFinanceiro, ");
		str.append(" matricula.gradecurricularatual AS \"matricula.gradecurricularatual\",  ");
		// Dados do Curso
		str.append(" curso.codigo AS \"curso.codigo\", curso.nome AS \"curso.nome\", ");
		// Dados da Unidade Ensino
		str.append(" unidadeEnsino.codigo AS \"unidadeEnsino.codigo\", unidadeEnsino.nome AS \"unidadeEnsino.nome\", ");
		// Dados do Aluno
		str.append(" aluno.codigo AS \"aluno.codigo\", aluno.nome AS \"aluno.nome\", ");
		// Dados do Usuario
		str.append(" usuario.nome AS \"responsavel.nome\", usuario.codigo AS \"responsavel.codigo\", ");
		// Dados da Disciplina
		str.append(" disciplina.codigo AS \"disciplina.codigo\", disciplina.nome AS \"disciplina.nome\", ");
		// DISCIPLINA COMPOSTA E EQUIVALENCIA
		str.append(" historico.historicoPorEquivalencia AS \"historico.historicoPorEquivalencia\", historico.historicoEquivalente AS \"historico.historicoEquivalente\", ");
		str.append(" historico.gradeDisciplinaComposta AS \"historico.gradeDisciplinaComposta\", ");
		str.append(" gradeDisciplinaComposta.variavelNota AS \"gradeDisciplinaComposta.variavelNota\", ");
		str.append(" gradeDisciplinaComposta.ordem AS \"gradeDisciplinaComposta.ordem\", ");
		str.append(" gradeDisciplinaComposta.cargahoraria AS \"gradeDisciplinaComposta.cargahoraria\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaPratica AS \"gradeDisciplinaComposta.cargahorariaPratica\", ");
		str.append(" gradeDisciplinaComposta.cargahorariaTeorica AS \"gradeDisciplinaComposta.cargahorariaTeorica\", ");
		str.append(" gradeDisciplinaComposta.nrcreditos AS \"gradeDisciplinaComposta.nrcreditos\", ");
		str.append(" gradeDisciplinaComposta.horaaula AS \"gradeDisciplinaComposta.horaaula\", ");
		str.append(" historico.historicoDisciplinaComposta AS \"historico.historicoDisciplinaComposta\", historico.historicoDisciplinaFazParteComposicao, ");
		str.append(" historico.mapaEquivalenciaDisciplina AS \"historico.mapaEquivalenciaDisciplina\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaCursada AS \"historico.mapaEquivalenciaDisciplinaCursada\", ");
		str.append(" historico.mapaEquivalenciaDisciplinaMatrizCurricular AS \"historico.mapaEquivalenciaDisciplinaMatrizCurricular\", ");
		// Dados da Grade Disciplina
		str.append(" gradedisciplina.codigo AS \"gradedisciplina.codigo\", ");
		str.append(" gradedisciplina.disciplina AS \"gradedisciplina.disciplina\", ");
		str.append(" gradedisciplina.cargaHoraria AS \"gradedisciplina.cargaHoraria\", ");
		str.append(" gradedisciplina.cargaHorariapratica AS \"gradedisciplina.cargaHorariapratica\", ");
		str.append(" gradedisciplina.nrCreditos AS \"gradedisciplina.nrCreditos\", ");
		str.append(" gradedisciplina.diversificada AS \"gradedisciplina.diversificada\", ");
		str.append(" gradedisciplina.disciplinaComposta AS \"gradedisciplina.disciplinaComposta\", ");
		str.append(" gradedisciplina.disciplinaEixoTematico AS \"gradedisciplina.disciplinaEixoTematico\", ");
		str.append(" gradedisciplina.formulaCalculoNota AS \"gradedisciplina.formulaCalculoNota\", ");
		str.append(" gradedisciplina.formulaCalculo AS \"gradedisciplina.formulaCalculo\", ");
		str.append(" gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gradedisciplina.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradedisciplina.variavelNotaRecuperacao AS \"gradedisciplina.variavelNotaRecuperacao\", ");
		str.append(" gradedisciplina.condicaoUsoRecuperacao AS \"gradedisciplina.condicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gradedisciplina.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperada AS \"gradedisciplina.formulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gradedisciplina.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradedisciplina.formulaCalculoNotaRecuperacao AS \"gradedisciplina.formulaCalculoNotaRecuperacao\", ");
		str.append(" gradedisciplina.horaaula AS \"gradedisciplina.horaaula\", ");
		// Dados da Grade Curricular Grupo Optativa Disciplina
		// (GradeCurricularGrupoOptativaDisciplina)
		str.append(" historico.gradeCurricularGrupoOptativaDisciplina AS \"historico.gradeCurricularGrupoOptativaDisciplina\",  ");
		str.append(" historico.disciplinaReferenteAUmGrupoOptativa AS \"historico.disciplinaReferenteAUmGrupoOptativa\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.codigo AS \"gradeCurricularGrupoOptativaDisciplina.codigo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplina AS \"gradeCurricularGrupoOptativaDisciplina.disciplina\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHoraria AS \"gradeCurricularGrupoOptativaDisciplina.cargaHoraria\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica AS \"gradeCurricularGrupoOptativaDisciplina.cargaHorariapratica\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.nrCreditos AS \"gradeCurricularGrupoOptativaDisciplina.nrCreditos\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.diversificada AS \"gradeCurricularGrupoOptativaDisciplina.diversificada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.disciplinaComposta AS \"gradeCurricularGrupoOptativaDisciplina.disciplinaComposta\",  ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculoNota\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculo AS \"gradeCurricularGrupoOptativaDisciplina.formulaCalculo\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.controlarRecuperacaoPelaDisciplinaPrincipal AS \"gcgod.controlarRecuperacaoPelaDisciplinaPrincipal\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaRecuperacao AS \"gcgod.variavelNotaRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.condicaoUsoRecuperacao AS \"gcgod.condicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaCondicaoUsoRecuperacao AS \"gcgod.variavelNotaCondicaoUsoRecuperacao\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperada AS \"gcgod.formulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.variavelNotaFormulaCalculoNotaRecuperada AS \"gcgod.variavelNotaFormulaCalculoNotaRecuperada\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.horaaula AS \"gcgod.horaaula\", ");
		str.append(" gradeCurricularGrupoOptativaDisciplina.formulaCalculoNotaRecuperacao AS \"gcgod.formulaCalculoNotaRecuperacao\", ");
		str.append(" exists (select historiconota.codigo from historiconota where historiconota.historico = historico.codigo and historiconota.notarecuperacao and situacaorecuperacaonota = '").append(SituacaoRecuperacaoNotaEnum.EM_RECUPERACAO.name()).append("' limit 1) as emrecuperacao" );
		str.append(" FROM historico ");
		str.append(" INNER JOIN matricula on matricula.matricula = historico.matricula ");
		str.append(" INNER JOIN matriculaPeriodo on matriculaPeriodo.matricula = matricula.matricula and matriculaPeriodo.codigo = historico.matriculaPeriodo ");
		str.append(" LEFT JOIN matriculaPeriodoTurmaDisciplina on matriculaPeriodoTurmaDisciplina.codigo = historico.matriculaPeriodoTurmaDisciplina ");
		str.append(" INNER JOIN Turma ON turma.codigo = matriculaPeriodo.turma ");
		str.append(" LEFT JOIN gradeCurricular on historico.matrizCurricular = gradeCurricular.codigo ");
		str.append(" LEFT JOIN disciplina on disciplina.codigo = historico.disciplina ");
		str.append(" LEFT JOIN pessoa AS \"aluno\" on aluno.codigo = matricula.aluno ");
		str.append(" LEFT JOIN periodoLetivo on historico.periodoLetivoMatrizCurricular = periodoLetivo.codigo ");
		str.append(" LEFT JOIN gradedisciplina on gradedisciplina.codigo = historico.gradeDisciplina ");
		str.append(" LEFT JOIN gradedisciplinacomposta on gradedisciplinacomposta.codigo = historico.gradedisciplinacomposta ");
		str.append(" LEFT JOIN gradeCurricularGrupoOptativaDisciplina on gradeCurricularGrupoOptativaDisciplina.codigo = historico.gradeCurricularGrupoOptativaDisciplina ");
		str.append(" LEFT JOIN usuario on usuario.codigo = historico.responsavel ");
		str.append(" LEFT JOIN turno on matricula.turno = turno.codigo ");
		str.append(" LEFT JOIN unidadeEnsino on unidadeEnsino.codigo = matricula.unidadeEnsino ");
		str.append(" LEFT JOIN curso on curso.codigo = matricula.curso ");
		str.append(" LEFT JOIN periodoLetivo as periodoLetivoMatrizCurricular on historico.periodoLetivoMatrizCurricular = periodoLetivoMatrizCurricular.codigo ");
		str.append(" LEFT JOIN periodoLetivo as periodoLetivoCursada on historico.periodoLetivoCursada = periodoLetivoCursada.codigo ");
		str.append(" LEFT JOIN gradeCurricular as matrizCurricular on matricula.gradecurricularatual = matrizCurricular.codigo ");
		str.append(" LEFT JOIN configuracaoAcademico on configuracaoAcademico.codigo = historico.configuracaoAcademico ");
		str.append(" WHERE historico.codigo IN (").append(obj.getListaHistorico().stream().map(h -> h).collect(Collectors.joining(", "))).append(") ");
		str.append(" AND ").append(adicionarFiltroSituacaoAcademicaHistorico(filtroRelatorioAcademico, "historico"));
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(str.toString());
		return montarDadosConsultaCompleta(tabelaResultado, usuarioLogado);
	}

	@Override
	public double consultarPercentualCHIntegralizacaoPorMatriculaGradeCurricular(String matricula, int gradeCurricular, UsuarioVO usuarioVO) {
		double percentualCH = 0.0;
		try {
			int cargaHorariaExigida = getFacadeFactory().getGradeCurricularFacade().consultarCargaHorariaExigidaGrade(gradeCurricular, usuarioVO);
			int cargaHorariaCumprida = getFacadeFactory().getDisciplinaFacade().consultarCargaHorariaCumpridaNoHistoricoPorGradeCurricularComDisciplinaEquivalente(matricula, gradeCurricular, true, usuarioVO);
			if (Uteis.isAtributoPreenchido(cargaHorariaExigida)) {
				percentualCH = Uteis.arrendondarForcando2CadasDecimais(cargaHorariaCumprida * 100.00 / cargaHorariaExigida);
			}
		} catch (Exception e) {
			return 0.0;
		}
		return percentualCH;
	}
	
	/**
	 * Método que valida a existência de históricos de estágios vinculado a grade
	 * disciplina do aluno, caso não exista será criado
	 * 
	 * @param ultimaMatriculaPeriodoVO
	 * @param usuarioVO
	 * @author Felipi Alves
	 */
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirHistoricosDeEstagioNaoCriados(MatriculaPeriodoVO ultimaMatriculaPeriodoVO, UsuarioVO usuarioVO) {
		if (Uteis.isAtributoPreenchido(ultimaMatriculaPeriodoVO)) {
			StringBuilder sql = new StringBuilder();
			sql.append("INSERT INTO historico ( ");
			sql.append("matriculaperiodo, dataregistro, situacao, tipohistorico, matricula, disciplina, nomedisciplina, matriculaperiodoturmadisciplina, configuracaoacademico, historicodisciplinafazpartecomposicao, ");
			sql.append("anohistorico, semestrehistorico, freguencia, gradedisciplina, cargahorariacursada, cargahorariadisciplina, historicodisciplinaoptativa, historicodisciplinaforagrade, historicoporequivalencia, historicoequivalente, ");
			sql.append("mapaequivalenciadisciplina, periodoletivomatrizcurricular, periodoletivocursada, matrizcurricular, creditodisciplina, historicodisciplinacomposta, disciplinareferenteaumgrupooptativa, historicoincluidoporsql, created, codigocreated, nomecreated, responsavel) ");
			sql.append("(SELECT matriculaperiodo.codigo, matriculaperiodo.DATA, 'CS', 'NO', matricula.matricula, disciplina.codigo, disciplina.nome, NULL, 5 configuracaoacademico, ");
			sql.append("FALSE, matriculaperiodo.ano, matriculaperiodo.semestre , 100 AS freguencia, gradedisciplina.codigo, gradedisciplina.cargahoraria, gradedisciplina.cargahoraria, FALSE, FALSE, FALSE, ");
			sql.append("FALSE, NULL, periodoletivo.codigo, matriculaperiodo.periodoletivomatricula , matricula.gradecurricularatual, gradedisciplina.nrcreditos, FALSE, FALSE, TRUE, now(), ?, ?, ? ");
			sql.append("FROM matriculaperiodo ");
			sql.append("INNER JOIN matricula ON matricula.matricula = matriculaperiodo.matricula ");
			sql.append("INNER JOIN curso ON curso.codigo = matricula.curso ");
			sql.append("INNER JOIN gradecurricular ON gradecurricular.codigo = matricula.gradecurricularatual ");
			sql.append("INNER JOIN periodoletivo ON periodoletivo.gradecurricular = gradecurricular.codigo ");
			sql.append("INNER JOIN gradedisciplina ON gradedisciplina.periodoletivo = periodoletivo.codigo ");
			sql.append("INNER JOIN disciplina ON disciplina.codigo = gradedisciplina.disciplina ");
			sql.append("WHERE matriculaperiodo.codigo = ? ");
			sql.append("AND disciplina.classificacaodisciplina = 'ESTAGIO' ");
			sql.append("AND NOT EXISTS (SELECT historico.codigo FROM historico WHERE historico.matricula = matricula.matricula AND historico.matrizcurricular = gradecurricular.codigo AND historico.gradedisciplina = gradedisciplina.codigo)) ");
			getConexao().getJdbcTemplate().update(sql.toString(), usuarioVO.getCodigo(), usuarioVO.getNome(), usuarioVO.getCodigo(), ultimaMatriculaPeriodoVO.getCodigo());
		}
	}
	
	/**
	 * UPDATE criado por Rodrigo para corrigir históricos de estágio ao realizar um
	 * DEFERIMENTO de ESTÁGIO
	 * 
	 * @param matricula
	 * @author Felipi Alves
	 */
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarHistoricosEstagioCursandoParaAprovado(MatriculaVO matricula) {
		if (Uteis.isAtributoPreenchido(matricula)) {
			StringBuilder sql = new StringBuilder();
			/**
			 * Antigo UPDATE abaixo criado por Rodrigo para a atualização dos historicos de estagio
			 * com a situação Cursando mudando para Aprovado
			 * sql.append("UPDATE historico SET configuracaoacademico = 5, situacao = 'AP', nota1 = 10, nota2 = 10, mediafinal = 10, nota1conceito = 1, nota2conceito = 3, mediafinalconceito = 3 FROM ( SELECT h.codigo, h.configuracaoacademico, h.situacao FROM historico h INNER JOIN disciplina d ON d.codigo = h.disciplina INNER JOIN ( SELECT matricula.matricula, matricula.gradecurricularatual FROM matricula INNER JOIN gradecurricular g ON g.codigo = matricula.gradecurricularatual WHERE g.totalcargahorariaestagio > 0 AND matricula.matricula = ? AND g.totalcargahorariaestagio <= ( SELECT sum(e.cargahorariadeferida) FROM estagio e WHERE matricula = matricula.matricula AND e.situacaoestagioenum = 'DEFERIDO' )) AS matricula ON matricula.matricula = h.matricula AND h.matrizcurricular = matricula.gradecurricularatual WHERE d.classificacaodisciplina = 'ESTAGIO' AND h.situacao = 'CS' ) AS his WHERE his.codigo = historico.codigo");
			 */
			
			sql.append("UPDATE historico SET configuracaoacademico = 5, situacao = 'AP', nota1 = 10, nota2 = 10, mediafinal = 10, nota1conceito = 1, nota2conceito = 3, mediafinalconceito = 3 FROM ");
			sql.append("(WITH cte_historicos AS ( SELECT historico.codigo, historico.matricula, matricula.gradecurricularatual, historico.configuracaoacademico, historico.situacao, ROW_NUMBER() OVER(PARTITION BY historico.matricula ORDER BY gradedisciplina.cargahoraria) numero, gradedisciplina.cargahoraria FROM historico ");
			sql.append("INNER JOIN matricula ON matricula.matricula = historico.matricula ");
			sql.append("INNER JOIN gradedisciplina ON gradedisciplina.codigo = historico.gradedisciplina ");
			sql.append("INNER JOIN disciplina ON disciplina.codigo = historico.disciplina ");
			sql.append("WHERE historico.matricula = ? AND historico.situacao = 'CS' AND historico.matrizcurricular = matricula.gradecurricularatual AND disciplina.classificacaodisciplina = 'ESTAGIO'), ");
			sql.append("cte_historicos_2 AS ( SELECT cte_historicos.*, valor FROM cte_historicos INNER JOIN LATERAL ( SELECT sum(c.cargahoraria) valor FROM cte_historicos c WHERE c.matricula = cte_historicos.matricula AND c.numero <= cte_historicos.numero) x ON TRUE) ");
			sql.append("SELECT cte_historicos_2.*, ch_hist_aprovada FROM cte_historicos_2 ");
			sql.append("INNER JOIN LATERAL ( SELECT sum(e.cargahorariadeferida) soma FROM estagio e WHERE e.matricula = cte_historicos_2.matricula AND e.situacaoestagioenum = 'DEFERIDO') estagio ON TRUE ");
			sql.append("INNER JOIN LATERAL ( SELECT COALESCE(sum(gradedisciplina.cargahoraria), 0) ch_hist_aprovada FROM historico INNER JOIN matricula ON matricula.matricula = historico.matricula INNER JOIN gradedisciplina ON gradedisciplina.codigo = historico.gradedisciplina INNER JOIN disciplina ON disciplina.codigo = historico.disciplina WHERE historico.matricula = cte_historicos_2.matricula AND historico.matrizcurricular = matricula.gradecurricularatual AND historico.situacao = ANY('{AP,AA,AE,CC,IS}'::TEXT[]) AND disciplina.classificacaodisciplina = 'ESTAGIO' ) hist ON TRUE ");
			sql.append("WHERE (estagio.soma - hist.ch_hist_aprovada) > 0 AND valor <= (estagio.soma - hist.ch_hist_aprovada)) AS his ");
			sql.append("WHERE his.codigo = historico.codigo ");
			getConexao().getJdbcTemplate().update(sql.toString(), matricula.getMatricula());
		}
	}
	
	public StringBuilder getSqlConsultaHistoricoPorMapaEquivalenciaNomeDisciplinaEquivalente(){
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" select historico.codigo, historico.matricula, historico.matriculaperiodo, historico.disciplina, historico.matriculaperiodoturmadisciplina, historico.mapaequivalenciadisciplina, historico.mapaequivalenciadisciplinacursada, ");
		sqlStr.append(" historico.numeroAgrupamentoEquivalenciaDisciplina, historico.situacao, historico.anohistorico, historico.semestrehistorico, historico.historicoequivalente, historico.historicoporequivalencia, ");
		sqlStr.append(" historico.cargaHorariaDisciplina, d.nome as \"nomeDisciplinaEquivalente\" ");
		sqlStr.append(" FROM historico ");
		return sqlStr;
	}
	
	public List<HistoricoVO> consultarHistoricoEquivalentePorMatriculaMapaEquivalenciaDisciplinaNomeDisciplinaEquivalente(String matricula, Integer mapaEquivalenciaDisciplina, boolean verificarAcesso, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = getSqlConsultaHistoricoPorMapaEquivalenciaNomeDisciplinaEquivalente();
		sqlStr.append(" join disciplina d on d.codigo = historico.disciplina ");
		sqlStr.append("where matricula = '").append(matricula).append("' ");
		sqlStr.append(" and mapaequivalenciadisciplina = ").append(mapaEquivalenciaDisciplina);
		sqlStr.append(" and historicoequivalente ");
		sqlStr.append("order by codigo");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosListaConsultaHistoricoPorMapaEquivalencia(rs);
	}
}