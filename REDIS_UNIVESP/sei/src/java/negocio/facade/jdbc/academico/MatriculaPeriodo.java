package negocio.facade.jdbc.academico;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

import org.json.simple.JSONObject;
import org.springframework.context.annotation.Scope;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.PreparedStatementCreator;
import org.springframework.jdbc.core.ResultSetExtractor;
import org.springframework.jdbc.support.rowset.SqlRowSet;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import controle.arquitetura.AplicacaoControle;
import controle.arquitetura.AssuntoDebugEnum;
import controle.arquitetura.DataModelo;
import negocio.comuns.academico.CancelamentoVO;
import negocio.comuns.academico.CondicaoPagamentoPlanoDescontoVO;
import negocio.comuns.academico.CondicaoPagamentoPlanoFinanceiroCursoVO;
import negocio.comuns.academico.ConfiguracaoAcademicoVO;
import negocio.comuns.academico.CursoVO;
import negocio.comuns.academico.DescontoProgressivoVO;
import negocio.comuns.academico.DisciplinaPreRequisitoVO;
import negocio.comuns.academico.DisciplinaVO;
import negocio.comuns.academico.FiliacaoVO;
import negocio.comuns.academico.FrequenciaAulaVO;
import negocio.comuns.academico.GradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO;
import negocio.comuns.academico.GradeCurricularGrupoOptativaDisciplinaVO;
import negocio.comuns.academico.GradeCurricularVO;
import negocio.comuns.academico.GradeDisciplinaComHistoricoAlunoVO;
import negocio.comuns.academico.GradeDisciplinaCompostaVO;
import negocio.comuns.academico.GradeDisciplinaVO;
import negocio.comuns.academico.HistoricoVO;
import negocio.comuns.academico.HorarioAlunoTurnoVO;
import negocio.comuns.academico.HorarioTurmaDiaItemVO;
import negocio.comuns.academico.InclusaoHistoricoForaPrazoVO;
import negocio.comuns.academico.ItemPlanoFinanceiroAlunoVO;
import negocio.comuns.academico.LogRegistroOperacoesVO;
import negocio.comuns.academico.MapaAlunoAptoFormarVO;
import negocio.comuns.academico.MapaEquivalenciaDisciplinaCursadaVO;
import negocio.comuns.academico.MapaEquivalenciaDisciplinaMatrizCurricularVO;
import negocio.comuns.academico.MapaEquivalenciaDisciplinaVO;
import negocio.comuns.academico.MatriculaComHistoricoAlunoVO;
import negocio.comuns.academico.MatriculaPeriodoMensalidadeCalculadaVO;
import negocio.comuns.academico.MatriculaPeriodoTurmaDisciplinaVO;
import negocio.comuns.academico.MatriculaPeriodoVO;
import negocio.comuns.academico.MatriculaVO;
import negocio.comuns.academico.PeriodoLetivoComHistoricoAlunoVO;
import negocio.comuns.academico.PeriodoLetivoVO;
import negocio.comuns.academico.PlanoFinanceiroAlunoVO;
import negocio.comuns.academico.PlanoFinanceiroCursoVO;
import negocio.comuns.academico.ProcessoMatriculaCalendarioVO;
import negocio.comuns.academico.ProcessoMatriculaVO;
import negocio.comuns.academico.RegistroAulaVO;
import negocio.comuns.academico.RenovacaoMatriculaTurmaVO;
import negocio.comuns.academico.TrancamentoVO;
import negocio.comuns.academico.TransferenciaEntradaVO;
import negocio.comuns.academico.TurmaContratoVO;
import negocio.comuns.academico.TurmaDisciplinaCompostaVO;
import negocio.comuns.academico.TurmaDisciplinaInclusaoSugeridaVO;
import negocio.comuns.academico.TurmaDisciplinaVO;
import negocio.comuns.academico.TurmaVO;
import negocio.comuns.academico.TurnoVO;
import negocio.comuns.academico.VagaTurmaDisciplinaVO;
import negocio.comuns.academico.enumeradores.ModalidadeDisciplinaEnum;
import negocio.comuns.academico.enumeradores.MotivoSolicitacaoLiberacaoMatriculaEnum;
import negocio.comuns.academico.enumeradores.OperacaoLogRegistroOperacoesEnum;
import negocio.comuns.academico.enumeradores.OperacaoMatriculaPeriodoContaLogEnum;
import negocio.comuns.academico.enumeradores.OrigemFechamentoMatriculaPeriodoEnum;
import negocio.comuns.academico.enumeradores.SituacaoMatriculaPeriodoEnum;
import negocio.comuns.academico.enumeradores.SituacaoPendenciaLiberacaoMatriculaEnum;
import negocio.comuns.academico.enumeradores.TabelaLogRegistroOperacoesEnum;
import negocio.comuns.academico.enumeradores.TipoAlunoCalendarioMatriculaEnum;
import negocio.comuns.academico.enumeradores.TipoContabilizacaoDisciplinaDependenciaEnum;
import negocio.comuns.academico.enumeradores.TipoContratoMatriculaEnum;
import negocio.comuns.academico.enumeradores.TipoControleComposicaoEnum;
import negocio.comuns.academico.enumeradores.TipoSubTurmaEnum;
import negocio.comuns.administrativo.ConfiguracaoGeralSistemaVO;
import negocio.comuns.administrativo.FormacaoAcademicaVO;
import negocio.comuns.administrativo.PersonalizacaoMensagemAutomaticaVO;
import negocio.comuns.administrativo.UnidadeEnsinoCursoVO;
import negocio.comuns.administrativo.UnidadeEnsinoVO;
import negocio.comuns.administrativo.enumeradores.TemplateMensagemAutomaticaEnum;
import negocio.comuns.administrativo.enumeradores.TipoCampoEnum;
import negocio.comuns.arquitetura.UsuarioVO;
import negocio.comuns.arquitetura.enumeradores.PerfilAcessoPermissaoAcademicoEnum;
import negocio.comuns.basico.FeriadoVO;
import negocio.comuns.crm.InteracaoWorkflowVO;
import negocio.comuns.estagio.ConfiguracaoEstagioObrigatorioVO;
import negocio.comuns.financeiro.ConfiguracaoFinanceiroVO;
import negocio.comuns.financeiro.ContaCorrenteVO;
import negocio.comuns.financeiro.ContaReceberVO;
import negocio.comuns.financeiro.ControleRemessaContaReceberVO;
import negocio.comuns.financeiro.ConvenioVO;
import negocio.comuns.financeiro.MatriculaPeriodoContaReceberLogVO;
import negocio.comuns.financeiro.MatriculaPeriodoContaReceberPlanoDescontoConvenioVO;
import negocio.comuns.financeiro.MatriculaPeriodoVencimentoVO;
import negocio.comuns.financeiro.ParceiroVO;
import negocio.comuns.financeiro.PlanoDescontoContaReceberVO;
import negocio.comuns.financeiro.PlanoFinanceiroAlunoDescricaoDescontosVO;
import negocio.comuns.financeiro.TextoPadraoVO;
import negocio.comuns.financeiro.enumerador.OrdenarMatriculaPeriodoVencimentoEnum;
import negocio.comuns.processosel.ProcSeletivoVO;
import negocio.comuns.secretaria.MapaRegistroEvasaoCursoVO;
import negocio.comuns.utilitarias.ConsistirException;
import negocio.comuns.utilitarias.Ordenacao;
import negocio.comuns.utilitarias.StreamSeiException;
import negocio.comuns.utilitarias.Uteis;
import negocio.comuns.utilitarias.UteisJSF;
import negocio.comuns.utilitarias.dominios.FormaIngresso;
import negocio.comuns.utilitarias.dominios.OrigemContaPagar;
import negocio.comuns.utilitarias.dominios.SituacaoContaReceber;
import negocio.comuns.utilitarias.dominios.SituacaoHistorico;
import negocio.comuns.utilitarias.dominios.SituacaoMatriculaPeriodo;
import negocio.comuns.utilitarias.dominios.SituacaoRequerimento;
import negocio.comuns.utilitarias.dominios.SituacaoVencimentoMatriculaPeriodo;
import negocio.comuns.utilitarias.dominios.SituacaoVinculoMatricula;
import negocio.comuns.utilitarias.dominios.TipoBoletoBancario;
import negocio.comuns.utilitarias.dominios.TipoOrigemContaReceber;
import negocio.comuns.utilitarias.faturamento.nfe.UteisData;
import negocio.facade.jdbc.arquitetura.ControleAcesso;
import negocio.facade.jdbc.financeiro.ContaReceber;
import negocio.facade.jdbc.utilitarias.NivelMontarDados;
import negocio.interfaces.academico.MatriculaPeriodoInterfaceFacade;
import webservice.servicos.MatriculaRSVO;
import webservice.servicos.objetos.DisciplinaRSVO;

/**
 * Classe de persistência que encapsula todas as operações de manipulação dos
 * dados da classe <code>MatriculaPeriodoVO</code>. Responsável por implementar
 * operações como incluir, alterar, excluir e consultar pertinentes a classe
 * <code>MatriculaPeriodoVO</code>. Encapsula toda a interação com o banco de
 * dados.
 * 
 * @see MatriculaPeriodoVO
 * @see ControleAcesso
 * @see Matricula
 */
@Repository
@Scope("singleton")
@SuppressWarnings("unchecked")
public class MatriculaPeriodo extends ControleAcesso implements MatriculaPeriodoInterfaceFacade {

	protected static String idEntidade;
	private static final long ONE_DAY = 24 * 60 * 60 * 1000;
	public static final long serialVersionUID = 1L;

	public MatriculaPeriodo() throws Exception {
		super();
		setIdEntidade("Matricula");
	}

	/**
	 * Operação Responsável por retornar um novo objeto da classe
	 * <code>MatriculaPeriodoVO</code>.
	 */
	public MatriculaPeriodoVO novo() throws Exception {
		MatriculaPeriodo.incluir(getIdEntidade());
		MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
		return obj;
	}

	/**
	 * Operação Responsável por incluir no banco de dados um objeto da classe
	 * <code>MatriculaPeriodoVO</code>. Primeiramente valida os dados (
	 * <code>validarDados</code>) do objeto. Verifica a conexão com o banco de
	 * dados e a permissão do usuário para realizar esta operação na entidade.
	 * Isto, através da operação <code>incluir</code> da superclasse.
	 * 
	 * @param obj
	 *            Objeto da classe <code>MatriculaPeriodoVO</code> que será
	 *            gravado no banco de dados.
	 * @exception Exception
	 *                Caso haja problemas de conexão, restrição de acesso ou
	 *                validação de dados.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluir(final MatriculaPeriodoVO obj, MatriculaVO matriculaVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		try {
			// //System.out.println("++++++++++++++++++++++ INCLUI MATRICULA PERIODO +++++++++++++++++++++++++++");
			// MatriculaPeriodoVO.validarDados(obj);
			if(!obj.getProcessoMatriculaVO().getSituacao().equals(SituacaoMatriculaPeriodoEnum.PRE_MATRICULA.getValor())) {
				obj.setSituacaoMatriculaPeriodo(SituacaoMatriculaPeriodoEnum.ATIVA.getValor());
				obj.setSituacao("CO");				
			}
			realizarVerificacaoAceiteTermoRenovacaoOnline(obj, matriculaVO, usuario);
			inicializarDadosAnoSemestreMatricula(obj, processoMatriculaCalendarioVO, true);
			final String sql = "INSERT INTO MatriculaPeriodo( data, situacao, matricula, gradeCurricular, periodoLetivoMatricula, responsavelRenovacaoMatricula, turma, responsavelLiberacaoMatricula, " 
			+ "dataLiberacaoMatricula, responsavelEmissaoBoletoMatricula , dataEmissaoBoletoMatricula, contaReceber, nrDocumento, unidadeEnsinoCurso, turmaPeriodo, semestre, ano, " 
			+ "responsavelMatriculaForaPrazo, situacaoMatriculaPeriodo, processoMatricula, transferenciaEntrada, contratoMatricula, planoFinanceiroCurso, condicaoPagamentoPlanoFinanceiroCurso, " 
			+ "matriculaPeriodoPreMatricula, nrDisciplinasIncluidas, nrDisciplinasExcluidas, financeiroManual, contratoFiador, reconheceuDivida, carneEntregue, bolsista, contratoExtensao, alunoTransferidoUnidade, " 
			+ "aceitouTermoContratoRenovacaoOnline, matriculaEspecial, dataBaseGeracaoParcelas, categoriaCondicaoPagamento, dataAceitouTermoContratoRenovacaoOnline, dataVencimentoMatriculaEspecifico ) " 
			+ "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ) returning codigo"
					+ adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			obj.setCodigo((Integer) getConexao().getJdbcTemplate().query(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlInserir = arg0.prepareStatement(sql);
					sqlInserir.setDate(1, Uteis.getDataJDBC(obj.getData()));
					sqlInserir.setString(2, obj.getSituacao());
					sqlInserir.setString(3, obj.getMatricula());
					if (obj.getGradeCurricular().getCodigo().intValue() != 0) {
						sqlInserir.setInt(4, obj.getGradeCurricular().getCodigo().intValue());
					} else {
						sqlInserir.setNull(4, 0);
					}
					if (obj.getPeridoLetivo().getCodigo().intValue() != 0) {
						sqlInserir.setInt(5, obj.getPeridoLetivo().getCodigo().intValue());
					} else {
						sqlInserir.setNull(5, 0);
					}
					if (obj.getResponsavelRenovacaoMatricula().getCodigo().intValue() != 0) {
						sqlInserir.setInt(6, obj.getResponsavelRenovacaoMatricula().getCodigo().intValue());
					} else {
						sqlInserir.setNull(6, 0);
					}
					if (obj.getTurma().getCodigo().intValue() != 0) {
						sqlInserir.setInt(7, obj.getTurma().getCodigo().intValue());
					} else {
						sqlInserir.setNull(7, 0);
					}
					if (obj.getResponsavelLiberacaoMatricula().getCodigo().intValue() != 0) {
						sqlInserir.setInt(8, obj.getResponsavelLiberacaoMatricula().getCodigo().intValue());
					} else {
						sqlInserir.setNull(8, 0);
					}
					sqlInserir.setDate(9, Uteis.getDataJDBC(obj.getDataLiberacaoMatricula()));
					if (obj.getResponsavelEmissaoBoletoMatricula().getCodigo().intValue() != 0) {
						sqlInserir.setInt(10, obj.getResponsavelEmissaoBoletoMatricula().getCodigo().intValue());
					} else {
						sqlInserir.setNull(10, 0);
					}
					sqlInserir.setDate(11, Uteis.getDataJDBC(obj.getDataEmissaoBoletoMatricula()));
					sqlInserir.setNull(12, 0);
					sqlInserir.setString(13, obj.getNrDocumento());
					if (obj.getUnidadeEnsinoCurso().intValue() != 0) {
						sqlInserir.setInt(14, obj.getUnidadeEnsinoCurso().intValue());
					} else {
						sqlInserir.setNull(14, 0);
					}
					if (obj.getTurmaPeriodo().getCodigo().intValue() != 0) {
						sqlInserir.setInt(15, obj.getTurmaPeriodo().getCodigo().intValue());
					} else {
						sqlInserir.setNull(15, 0);
					}
					sqlInserir.setString(16, obj.getSemestre());
					sqlInserir.setString(17, obj.getAno());
					if (obj.getResponsavelMatriculaForaPrazo().getCodigo().intValue() != 0) {
						sqlInserir.setInt(18, obj.getResponsavelMatriculaForaPrazo().getCodigo().intValue());
					} else {
						sqlInserir.setNull(18, 0);
					}
					sqlInserir.setString(19, obj.getSituacaoMatriculaPeriodo());
					if (Uteis.isAtributoPreenchido(obj.getProcessoMatricula())) {
						sqlInserir.setInt(20, obj.getProcessoMatricula().intValue());
					} else {
						sqlInserir.setNull(20, 0);
					}
					if (obj.getTranferenciaEntrada().intValue() != 0) {
						sqlInserir.setInt(21, obj.getTranferenciaEntrada().intValue());
					} else {
						sqlInserir.setNull(21, 0);
					}
					if (obj.getContratoMatricula().getCodigo().intValue() != 0) {
						sqlInserir.setInt(22, obj.getContratoMatricula().getCodigo().intValue());
					} else {
						sqlInserir.setNull(22, 0);
					}
					if (obj.getPlanoFinanceiroCurso().getCodigo().intValue() != 0) {
						sqlInserir.setInt(23, obj.getPlanoFinanceiroCurso().getCodigo().intValue());
					} else {
						sqlInserir.setNull(23, 0);
					}
					if (obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo().intValue() != 0) {
						sqlInserir.setInt(24, obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo().intValue());
					} else {
						sqlInserir.setNull(24, 0);
					}
					if (obj.getMatriculaPeriodoPreMatricula().getCodigo().intValue() != 0) {
						sqlInserir.setInt(25, obj.getMatriculaPeriodoPreMatricula().getCodigo().intValue());
					} else {
						sqlInserir.setNull(25, 0);
					}
					sqlInserir.setInt(26, obj.getNrDisciplinasIncluidas());
					sqlInserir.setInt(27, obj.getNrDisciplinasExcluidas());
					sqlInserir.setBoolean(28, obj.getFinanceiroManual());
					if (obj.getContratoFiador().getCodigo().intValue() != 0) {
						sqlInserir.setInt(29, obj.getContratoFiador().getCodigo().intValue());
					} else {
						sqlInserir.setNull(29, 0);
					}
					sqlInserir.setBoolean(30, obj.getReconheceuDivida());
					sqlInserir.setBoolean(31, obj.getCarneEntregue());
					sqlInserir.setBoolean(32, obj.getBolsista());
					if (obj.getContratoExtensao().getCodigo().intValue() != 0) {
						sqlInserir.setInt(33, obj.getContratoExtensao().getCodigo().intValue());
					} else {
						sqlInserir.setNull(33, 0);
					}
					sqlInserir.setBoolean(34, obj.getAlunoTransferidoUnidade());
					sqlInserir.setBoolean(35, obj.getAceitouTermoContratoRenovacaoOnline());
					sqlInserir.setBoolean(36, obj.getMatriculaEspecial());
					int i=36;
					Uteis.setValuePreparedStatement(obj.getDataBaseGeracaoParcelas(), Types.DATE, ++i, sqlInserir);
					Uteis.setValuePreparedStatement(obj.getCategoriaCondicaoPagamento(), ++i, sqlInserir);
					if (obj.getAceitouTermoContratoRenovacaoOnline()) {
						if (obj.getDataAceitouTermoContratoRenovacaoOnline() == null) {
							obj.setDataAceitouTermoContratoRenovacaoOnline(new Date());
						}
						sqlInserir.setTimestamp(++i, Uteis.getDataJDBCTimestamp(obj.getDataAceitouTermoContratoRenovacaoOnline()));
					} else {
						sqlInserir.setTimestamp(++i, null);
					}
					Uteis.setValuePreparedStatement(obj.getDataVencimentoMatriculaEspecifico(),  Types.DATE, ++i, sqlInserir);
					return sqlInserir;
				}
			}, new ResultSetExtractor() {

				public Object extractData(ResultSet arg0) throws SQLException, DataAccessException {
					if (arg0.next()) {
						obj.setNovoObj(Boolean.FALSE);
						return arg0.getInt("codigo");
					}
					return null;
				}
			}));
			if (Uteis.isAtributoPreenchido(obj.getTranferenciaEntrada())) {
				criarHistoricoTransferenciaEntrada(obj, configuracaoFinanceiro, usuario);
			}			
			gravarMatriculaPeriodoTurmaDisciplinaAcordoSituacaoAcademica(matriculaVO, obj, configuracaoFinanceiro, usuario);
			for (HistoricoVO historicoVO : obj.getListaDisciplinasPeriodoLetivoAlunoJaAprovadoDeveReprovar()) {
				getFacadeFactory().getHistoricoFacade().alterarSituacaoHistoricoPorCodigo(historicoVO.getCodigo(), "RP", usuario);
			}
			
			 if(matriculaVO.getMatriculaOnlineProcSeletivo() &&    Uteis.isAtributoPreenchido(matriculaVO.getListaProcessoSeletivoDisciplinasAproveitadas())) {			 
				  getFacadeFactory().getHistoricoFacade().realizarInclusaoHistoricosAntigosNovaMatriculaPorMatriculaAnterior(matriculaVO,  obj , null , matriculaVO.getListaProcessoSeletivoDisciplinasAproveitadas() ,usuario);
		    }
			if (!obj.getOrigemMapaRegistroTrancamentoAbandono()) {
				atualizarSituacaoFinanceiraMatriculaPeriodo(matriculaVO, obj, configuracaoFinanceiro,usuario);
				realizarLiberacaoModuloEstagioAluno(matriculaVO, obj, usuario);
				realizarLiberacaoModuloTCCAluno(matriculaVO, obj, usuario);
			}
			Collections.sort(obj.getMatriculaPeriodoVencimentoVOs(), OrdenarMatriculaPeriodoVencimentoEnum.DATA_VENCIMENTO_AND_TIPO_ORIGEM.asc());
//			realizarExecucaoRegrasContaIntegracaoPorMatricula(matriculaVO, obj, usuario, true);
		  } catch (Exception e) {
			// obj.setContaReceber(0);
//			if (e.getMessage().contains("(Competência Fechada)")) {
				// Se tivemos um erro de bloqueio de competencia (seja na conta a receber ou outra entidade. Iremos replicar esse
				// bloqueio para a MatriculaPeriodoVO. Assim, o usuário poderá visualizar o botao de liberacao de competencia fechada (FechamentoMes)
				// e seguir o fluxo posteriormente.
//				ConsistirException cEx = (ConsistirException)e;
//				obj.forcarControleBloqueioCompetencia(e.getMessage(), cEx.getObjetoOrigem().getFechamentoMesVOBloqueio(), cEx.getObjetoOrigem().getFechamentoMesVOBloqueio().getDataBloqueioVerificada());
//			}
			
			obj.setCodigo(0);
			obj.getConfiguracaoFinanceiro().setCodigo(0);
			Iterator i = obj.getMatriculaPeriodoTumaDisciplinaVOs().iterator();
			while (i.hasNext()) {
				MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplina = (MatriculaPeriodoTurmaDisciplinaVO) i.next();
				matriculaPeriodoTurmaDisciplina.setNovoObj(Boolean.TRUE);
			}
			obj.setNovoObj(Boolean.TRUE);
			throw e;
		}
	}

	

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarSituacaoTransferenciaMatrizCurricularQuandoMigrandoDisciplinaCursandoPorCorrespodencia(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		if (matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO() != null) {
			matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().setSituacao("RM");

			matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().adicionarHistoricoResultadoProcessamento(new Date(), usuario.getNome_Apresentar(), "Migração das Disciplinas Cursando por Correspondência para NOVA MATRIZ / NOVA TURMA realizada com SUCESSO.");
			
			getFacadeFactory().getTransferenciaMatrizCurricularMatriculaFacade().alterarSituacao(matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().getCodigo(), "RM", matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().getResultadoProcessamento(), usuario);
		}
	}

	/**
	 * Método que só será executado quando o usuário estiver editando uma matriculaPeriodo a partir de uma transferencia de 
	 * matriz (com o intuito de remover disciplinas que estavam sendo cursadas por correspodencia). Neste caso, temos que verificar
	 * se alguma matriculaPeriodoTurmaDisciplina será excluída a seguir, referente à um histórico de disciplina já aprovado. Se
 	 * isto ocorreu os historicos destas  matriculaPeriodoTurmaDisciplina estarão na lista abaixo, já disponível para processamento.
     * Os mesmos são armazenados nesta lista, assim que o matriculaPeriodo é editada pelo usuário. Esta remocao da MatriculaPeriodoTurmaDisciplina
  	 * é necessária, pois caso contrário, teríamos uma MatriculaPeriodoTurmaDisciplina vinculado a dados de uma matrizcurricular X, enquanto que a
	 * matriculaPeriodo já estaria vinculada a outra matriz Y, causando inconsistencia de dados e problemas nos relatórios.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void verificarEDesvincularHistoricosAprovadosDeMatriculaPeriodoTurmaDisciplinaRemovidosAoEliminarCursandoPorCorrespodencia(
			MatriculaPeriodoVO obj, Integer gradeCurricularAtual, UsuarioVO usuario) throws Exception {
		if (obj.getTransferenciaMatrizCurricularMatriculaVO() != null) {
			// Se este atributo está informado é por que o usuário está editando a matriculaPeriodo a partir de uma transferencia de 
			// matriz (com o intuito de remover disciplinas que estavam sendo cursadas por correspodencia). Neste caso, temos que verificar
			// se alguma matriculaPeriodoTurmaDisciplina será excluída a seguir, referente à um histórico de disciplina já aprovado. Se
			// isto ocorreu os historicos destas  matriculaPeriodoTurmaDisciplina estarão na lista abaixo, já disponível para processamento.
			// Os mesmos são armazenados nesta lista, assim que o matriculaPeriodo é editada pelo usuário. Esta remocao da MatriculaPeriodoTurmaDisciplina
			// é necessária, pois caso contrário, teríamos uma MatriculaPeriodoTurmaDisciplina vinculado a dados de uma matrizcurricular X, enquanto que a
			// matriculaPeriodo já estaria vinculada a outra matriz Y, causando inconsistencia de dados e problemas nos relatórios.
			if (obj.getTransferenciaMatrizCurricularMatriculaVO().getListaHistoricosAprovadosManterSemVinculoMatriculaPeriodoTurmaDiscipina() != null) {
				for (HistoricoVO historico : obj.getTransferenciaMatrizCurricularMatriculaVO().getListaHistoricosAprovadosManterSemVinculoMatriculaPeriodoTurmaDiscipina()) {
					getFacadeFactory().getHistoricoFacade().alterarVinculoHistoricoMatriculaPeriodoTurmaDisciplina(historico.getCodigo(), null, false, usuario);
				}
			}
			if (obj.getTransferenciaMatrizCurricularMatriculaVO().getListaExcluirDeAcordoMatriculaPeriodoTurmaDisciplinaRemovidaUsuarioVOs() != null
					&& !obj.getTransferenciaMatrizCurricularMatriculaVO().getListaExcluirDeAcordoMatriculaPeriodoTurmaDisciplinaRemovidaUsuarioVOs().isEmpty()) {
				for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : obj.getTransferenciaMatrizCurricularMatriculaVO().getListaExcluirDeAcordoMatriculaPeriodoTurmaDisciplinaRemovidaUsuarioVOs()) {
					getFacadeFactory().getHistoricoFacade().excluirComBaseNaMatriculaPeriodoMatrizCurricularCodDisciplinaSituacaoHistorico(obj.getCodigo(), gradeCurricularAtual, matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo(), "", null, usuario);
				}
			}
		}
	}	
	
	/**
	 * Rotina Responsável por registrar as disciplinas relativas a matricula
	 * Período. A mesma trabalha de acordo com a situacao acadêmicaa da
	 * matrícula Período letivo. Quando a matriculaPeriodo é do tipo
	 * pré-matrícula, temos que gravar as disciplinas na lista de disciplinas
	 * pré-matricula, e não na lista definitiva. Pois, caso as disciplinas sejam
	 * lançadas na lista definitiva, teríamos impactos em diversos locais, como
	 * horário da aula, lotação de turma, dentre outros itens. Quando a
	 * matriculaPeriodo estão ativa, então grava-se as disciplinas na lista
	 * definitiva.
	 * 
	 * @param obj
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gravarMatriculaPeriodoTurmaDisciplinaAcordoSituacaoAcademica(MatriculaVO matriculaVO, MatriculaPeriodoVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		// getFacadeFactory().getHistoricoFacade().excluirPorMatriculaPeriodo(obj.getCodigo(),
		// obj.getMatriculaPeriodoTumaDisciplinaVOs(), false, usuario);

		verificarEDesvincularHistoricosAprovadosDeMatriculaPeriodoTurmaDisciplinaRemovidosAoEliminarCursandoPorCorrespodencia(obj, matriculaVO.getGradeCurricularAtual().getCodigo(), usuario);
		getFacadeFactory().getHistoricoFacade().realizarAlteracaoSituacaoHistoricoDesistenciaEquivalencia(obj, usuario);
		getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().incluirMatriculaPeriodoTurmaDisciplinas(matriculaVO, obj, obj.getMatriculaPeriodoTumaDisciplinaVOs(), configuracaoFinanceiroVO, matriculaVO.getGradeCurricularAtual(), usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private MatriculaPeriodoVencimentoVO gerarVencimentoMatricula(MatriculaPeriodoVO matriculaPeriodoVO, Date dataVctoMatricula) throws Exception {
		MatriculaPeriodoVencimentoVO vctoVO = new MatriculaPeriodoVencimentoVO();
		vctoVO.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);
		vctoVO.setValor(matriculaPeriodoVO.getValorMatriculaCheio());

		// A opção abaixo verifica se a condição de pagamento plano financeiro
		// curso selecionado para a
		// matricula determina que a conta a receber referente a matrícula nao
		// seja gerada. Ou seja,
		// existem instituicoes onde não existe a cobranca de taxa de matrícula.
		// Desta maneira, o sistema
		// deve ser capaz de registrar esta situacao
		// (SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA)
		// nao gerando nenhuma conta a receber referente a matrícula.
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoControlarMatricula()) {
			vctoVO.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA);
			vctoVO.setValor(0.0);
		}
		vctoVO.setParcela("MA");
		if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getDataVencimentoMatriculaEspecifico())) {
			vctoVO.setDataVencimento(matriculaPeriodoVO.getDataVencimentoMatriculaEspecifico());
		}else if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getUsarDataVencimentoDataMatricula()) {
			if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getQtdeDiasAvancarDataVencimentoMatricula() > 0) {
				vctoVO.setDataVencimento(Uteis.obterDataAvancada(matriculaPeriodoVO.getData(), matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getQtdeDiasAvancarDataVencimentoMatricula()));
			} else {
				vctoVO.setDataVencimento(matriculaPeriodoVO.getData());
			}
		} else {
			vctoVO.setDataVencimento(dataVctoMatricula);
		}
		// Local responsavel por setar a data competencia da matricula seguindo
		// flags do processo de matricula do curso.
		if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getConsiderarCompetenciaVctoMatricula()) {
			vctoVO.setDataCompetencia(Uteis.getDataPrimeiroDiaMes(vctoVO.getDataVencimento()));
		} else {
			vctoVO.setDataCompetencia(Uteis.getDataPrimeiroDiaMes(matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDataCompetenciaMatricula()));
		}
		vctoVO.setData(new Date());
		vctoVO.setMatriculaPeriodo(matriculaPeriodoVO.getCodigo());
		vctoVO.setTipoOrigemMatriculaPeriodoVencimento(TipoOrigemContaReceber.MATRICULA);
		vctoVO.setTipoBoleto(TipoBoletoBancario.MATRICULA.getValor());
		Integer indexMatricula = 0;
		try {
			for (PlanoFinanceiroAlunoDescricaoDescontosVO pfaddVO : matriculaPeriodoVO.getListaDescontosMatricula()) {
				indexMatricula = indexMatricula + 1;
				switch (indexMatricula) {
				case 1:
					vctoVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(pfaddVO.getValorBaseComDescontosJaCalculadosAplicados());
					break;
				case 2:
					vctoVO.setValorDescontoCalculadoSegundaFaixaDescontos(pfaddVO.getValorBaseComDescontosJaCalculadosAplicados());
					break;
				case 3:
					vctoVO.setValorDescontoCalculadoTerceiraFaixaDescontos(pfaddVO.getValorBaseComDescontosJaCalculadosAplicados());
					break;
				case 4:
					vctoVO.setValorDescontoCalculadoQuartaFaixaDescontos(pfaddVO.getValorBaseComDescontosJaCalculadosAplicados());
					break;
				}
				if (vctoVO.getValorDescontoCalculadoPrimeiraFaixaDescontos()== null) {
					vctoVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(vctoVO.getValor());
				}
				if (vctoVO.getValorDescontoCalculadoSegundaFaixaDescontos() == null) {
					vctoVO.setValorDescontoCalculadoSegundaFaixaDescontos(vctoVO.getValor());
				}
				if (vctoVO.getValorDescontoCalculadoTerceiraFaixaDescontos() == null) {
					vctoVO.setValorDescontoCalculadoTerceiraFaixaDescontos(vctoVO.getValor());
				}
				if (vctoVO.getValorDescontoCalculadoQuartaFaixaDescontos() == null) {
					vctoVO.setValorDescontoCalculadoQuartaFaixaDescontos(vctoVO.getValor());
				}
			}

			return vctoVO;

		} finally {
			indexMatricula = null;
		}
	}

	private MatriculaPeriodoVencimentoVO gerarVencimentoMatriculaExtraValorDisciplinaIncluida(MatriculaPeriodoVO matriculaPeriodoVO, Date dataVctoMatricula, Double valor) throws Exception {
		MatriculaPeriodoVencimentoVO vctoVO = new MatriculaPeriodoVencimentoVO();
		vctoVO.setValor(valor);
		vctoVO.setValorDesconto(0.0);
		vctoVO.setValorDescontoConvenio(0.0);
		vctoVO.setValorDescontoInstituicao(0.0);
		vctoVO.setParcela("MA");
		vctoVO.setVencimentoExtraCobrancaValorDiferencaInclusaoDisciplina(Boolean.TRUE);
		vctoVO.setDataVencimento(dataVctoMatricula);
		vctoVO.setData(new Date());
		vctoVO.setMatriculaPeriodo(matriculaPeriodoVO.getCodigo());
		vctoVO.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);
		vctoVO.setTipoOrigemMatriculaPeriodoVencimento(TipoOrigemContaReceber.MATRICULA);
		vctoVO.setTipoBoleto(TipoBoletoBancario.MATRICULA.getValor());
		return vctoVO;
	}

	
	private MatriculaPeriodoVencimentoVO gerarVencimentoParcelas(MatriculaPeriodoVO matriculaPeriodoVO, Date dataVctoMatricula, Double valorVcto, Double valorDesconto, Double valorDescontoConvenio, Double valorDescontoInstituicao, String parcela, TipoOrigemContaReceber tipoOrigem, Boolean parcelaExtra, Boolean isParcelaEntrada) throws Exception {
		MatriculaPeriodoVencimentoVO vctoVO = new MatriculaPeriodoVencimentoVO();
		List<MatriculaPeriodoMensalidadeCalculadaVO> listaPeriodoMensalidadeCalculada = null;
		Integer indexMensalidade = 0;
		Integer contabilizarParcelaEntrada = 0;
		vctoVO.setValor(valorVcto);
		// Nesse momento, pegamos a diferença de dias entre a data de vencimento
		// final da mensalidade e o dia setado
		// no calendário do processo de matrícula. Essa diferença será
		// importante para calcularmos a data verdadeira do
		// desconto progressivo a apresentar no boleto.
		Integer diasVariacaoDataVencimento = 0;
		if (!matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getMesDataBaseGeracaoParcelas()) {
			diasVariacaoDataVencimento = matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDiaVencimentoPrimeiraMensalidade() - Uteis.getDiaMesData(dataVctoMatricula);
			Calendar c = Calendar.getInstance();
			c.setTime(dataVctoMatricula);
			c.set(Calendar.DAY_OF_MONTH, c.getActualMaximum(Calendar.DAY_OF_MONTH));
			if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDiaVencimentoPrimeiraMensalidade() > c.getActualMaximum(Calendar.DAY_OF_MONTH)) {
				diasVariacaoDataVencimento = c.getActualMaximum(Calendar.DAY_OF_MONTH) - Uteis.getDiaMesData(dataVctoMatricula);
			}
		} else {
			diasVariacaoDataVencimento = Uteis.getDiaMesData(dataVctoMatricula) - Uteis.getDiaMesData(dataVctoMatricula);
		}
		if (diasVariacaoDataVencimento < 0) {
			diasVariacaoDataVencimento = 0;
		}
		
		vctoVO.setDiasVariacaoDataVencimento(diasVariacaoDataVencimento);
		vctoVO.setParcela(parcela);
		vctoVO.setDataVencimento(dataVctoMatricula);
		vctoVO.setData(new Date());
		vctoVO.setMatriculaPeriodo(matriculaPeriodoVO.getCodigo());
		vctoVO.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);
		vctoVO.setVencimentoExtraCobrancaValorDiferencaInclusaoDisciplina(parcelaExtra);		
		if(tipoOrigem.isMensalidade() && isParcelaEntrada){
			listaPeriodoMensalidadeCalculada = matriculaPeriodoVO.getMatriculaPeriodoMensalidadeEntradaCalculadaVOs();
		}else if(tipoOrigem.isMensalidade() && !isParcelaEntrada){
			listaPeriodoMensalidadeCalculada = matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs();
			contabilizarParcelaEntrada = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isUsaValorPrimeiraParcela() ? 1 : 0;
		}else{
			listaPeriodoMensalidadeCalculada = matriculaPeriodoVO.getMatriculaPeriodoMaterialDidaticoCalculadaVOs();
		}
		try {
			if(parcela.contains("/") && Uteis.getIsValorNumerico(parcela.substring(0, parcela.indexOf("/")))){
				Integer parcelaBase  = Integer.valueOf(parcela.substring(0, parcela.indexOf("/")));
				
				for(MatriculaPeriodoMensalidadeCalculadaVO matriculaPeriodoMensalidadeCalculadaVO: listaPeriodoMensalidadeCalculada){
					if( parcelaBase >= matriculaPeriodoMensalidadeCalculadaVO.getParcelaInicial() &&  parcelaBase <= (contabilizarParcelaEntrada+matriculaPeriodoMensalidadeCalculadaVO.getParcelaFinal())){
						for (PlanoFinanceiroAlunoDescricaoDescontosVO pfaddVO : matriculaPeriodoMensalidadeCalculadaVO.getListaDescontosMensalidade()) {
							indexMensalidade = indexMensalidade + 1;
							switch (indexMensalidade) {
							case 1:
								vctoVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(pfaddVO.executarCalculoValorParaPagamentoDentroDataLimiteDesconto());
								break;
							case 2:
								vctoVO.setValorDescontoCalculadoSegundaFaixaDescontos(pfaddVO.executarCalculoValorParaPagamentoDentroDataLimiteDesconto());
								break;
							case 3:
								vctoVO.setValorDescontoCalculadoTerceiraFaixaDescontos(pfaddVO.executarCalculoValorParaPagamentoDentroDataLimiteDesconto());
								break;
							case 4:
								vctoVO.setValorDescontoCalculadoQuartaFaixaDescontos(pfaddVO.executarCalculoValorParaPagamentoDentroDataLimiteDesconto());
								break;			
							}					
						}
						if (vctoVO.getValorDescontoCalculadoPrimeiraFaixaDescontos() == null) {
							vctoVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(vctoVO.getValor());
						}
						if (vctoVO.getValorDescontoCalculadoSegundaFaixaDescontos() == null) {
							vctoVO.setValorDescontoCalculadoSegundaFaixaDescontos(vctoVO.getValor());
						}
						if (vctoVO.getValorDescontoCalculadoTerceiraFaixaDescontos() == null) {
							vctoVO.setValorDescontoCalculadoTerceiraFaixaDescontos(vctoVO.getValor());
						}
						if (vctoVO.getValorDescontoCalculadoQuartaFaixaDescontos() == null) {
							vctoVO.setValorDescontoCalculadoQuartaFaixaDescontos(vctoVO.getValor());
						}
						break;
					}
				}
			}
			return vctoVO;
		} finally {
			indexMensalidade = null;
		}
	}

	
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private List<MatriculaPeriodoVencimentoVO> gerarVencimentosMaterialDidatico(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVencimentoVO> listaVctosGerados = new ArrayList<>();
		Integer nrParcelas = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getQuantidadeParcelasMaterialDidatico().intValue();
		Integer nrMensalidade = 1;
		Integer nrMensalidadeDataVencimento = 1;
		if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isUsaValorPrimeiraParcela() 
				&& matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isVencimentoPrimeiraParcelaAntesMaterialDidatico()){
			nrMensalidadeDataVencimento = nrMensalidadeDataVencimento + 1;
		}
		while (nrMensalidade <= nrParcelas) {
			Date dataVencimento = montarDataVencimento(nrMensalidadeDataVencimento, matriculaPeriodoVO, usuario);
			if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isControlaDiaBaseVencimentoParcelaMaterialDidatico()){
				dataVencimento = Uteis.getDataVencimentoPadrao(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getDiaBaseVencimentoParcelaOutraUnidade().intValue(), dataVencimento, 0);
			}
			MatriculaPeriodoVencimentoVO vctoVO = gerarVencimentoParcelas(matriculaPeriodoVO, dataVencimento, matriculaPeriodoVO.getValorMaterialDidaticoCheio(), matriculaPeriodoVO.getValorDescontoMaterialDidatico(), matriculaPeriodoVO.getValorDescontoConvenioMaterialDidatico(), matriculaPeriodoVO.getValorDescontoInstituicaoMaterialDidatico(), nrMensalidade + "/" + nrParcelas, TipoOrigemContaReceber.MATERIAL_DIDATICO, false, false);
			// Metodo responsavel por gerencia a data de competencia dasparcelas, ele segue as regras do Processo Matricula Calendario.
			Date dataCompetencia = montarDataCompetencia(nrMensalidadeDataVencimento, dataVencimento, matriculaPeriodoVO, usuario);
			vctoVO.setDataCompetencia(dataCompetencia);
			vctoVO.setTipoOrigemMatriculaPeriodoVencimento(TipoOrigemContaReceber.MATERIAL_DIDATICO);
			vctoVO.setTipoBoleto(TipoBoletoBancario.MATERIAL_DIDATICO.getValor());
			listaVctosGerados.add(vctoVO);
			nrMensalidade++;
			nrMensalidadeDataVencimento++;
		
		}
		return listaVctosGerados;
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<MatriculaPeriodoVencimentoVO> gerarVencimentosMensalidades(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVencimentoVO> listaVctosGerados = new ArrayList<>();
		boolean aplicadoQtdParcelaMaterialDidatico = false;
		Integer nrParcelas = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNrParcelasPeriodo();
		Integer nrMensalidade = 1;
		Integer nrMensalidadeDataVencimento = 1;
		if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isUsaValorPrimeiraParcela()){
			nrParcelas++;
			if(!matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isVencimentoPrimeiraParcelaAntesMaterialDidatico()
					&& matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isGerarParcelaMaterialDidatico() 
					&& matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getTipoGeracaoMaterialDidatico().isAntesParcelaAcademico()){
				nrMensalidadeDataVencimento = nrMensalidadeDataVencimento + matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getQuantidadeParcelasMaterialDidatico().intValue();
				aplicadoQtdParcelaMaterialDidatico = true;
			}
			Date dataVencimento = montarDataVencimento(nrMensalidadeDataVencimento, matriculaPeriodoVO, usuario);
			MatriculaPeriodoVencimentoVO vctoVO = gerarVencimentoParcelas(matriculaPeriodoVO, dataVencimento, matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorPrimeiraParcela(), 0.0, 0.0, 0.0, nrMensalidade + "/" + nrParcelas, TipoOrigemContaReceber.MENSALIDADE, false, true);
			// Metodo responsavel por gerencia a data de competencia das parcelas, ele segue as regras do Processo Matricula Calendario.
			Date dataCompetencia = montarDataCompetencia(nrMensalidadeDataVencimento, dataVencimento, matriculaPeriodoVO, usuario);			
			vctoVO.setUsaValorPrimeiraParcela(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isUsaValorPrimeiraParcela());
			vctoVO.setDataCompetencia(dataCompetencia);
			vctoVO.setTipoOrigemMatriculaPeriodoVencimento(TipoOrigemContaReceber.MENSALIDADE);
			vctoVO.setTipoBoleto(TipoBoletoBancario.MENSALIDADE.getValor());
			vctoVO.setValorDesconto(0.0);
			vctoVO.setValorDescontoInstituicao(0.0);
			nrMensalidade++;
			nrMensalidadeDataVencimento++;
			listaVctosGerados.add(vctoVO);			 
		}
		if(!aplicadoQtdParcelaMaterialDidatico
				&& matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isGerarParcelaMaterialDidatico() 
				&& matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getTipoGeracaoMaterialDidatico().isAntesParcelaAcademico()){
			nrMensalidadeDataVencimento = nrMensalidadeDataVencimento + matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getQuantidadeParcelasMaterialDidatico().intValue();
		}
		while (nrMensalidade <= nrParcelas) {
			Date dataVencimento = montarDataVencimento(nrMensalidadeDataVencimento, matriculaPeriodoVO, usuario);
			MatriculaPeriodoVencimentoVO vctoVO = gerarVencimentoParcelas(matriculaPeriodoVO, dataVencimento, matriculaPeriodoVO.getValorMensalidadeCheio(), matriculaPeriodoVO.getValorDescontoMensalidade(), matriculaPeriodoVO.getValorDescontoConvenioMensalidade(), matriculaPeriodoVO.getValorDescontoInstituicaoMensalidade(), nrMensalidade + "/" + nrParcelas, TipoOrigemContaReceber.MENSALIDADE, false, false);
			// Metodo responsavel por gerencia a data de competencia das parcelas, ele segue as regras do Processo Matricula Calendario.
			Date dataCompetencia = montarDataCompetencia(nrMensalidadeDataVencimento, dataVencimento, matriculaPeriodoVO, usuario);
			vctoVO.setDataCompetencia(dataCompetencia);
			vctoVO.setTipoOrigemMatriculaPeriodoVencimento(TipoOrigemContaReceber.MENSALIDADE);
			vctoVO.setTipoBoleto(TipoBoletoBancario.MENSALIDADE.getValor());
			listaVctosGerados.add(vctoVO);
			nrMensalidade++;
			nrMensalidadeDataVencimento++;
		}
		return listaVctosGerados;
	}
	
	

	/**
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @param parcelaMatricula
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerarContaReceberComBaseParcelaMatricula(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO parcelaMatricula, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		criarContaReceberMatricula(matriculaVO, matriculaPeriodoVO, parcelaMatricula, false, configuracaoFinanceiro, usuario);	
		// matriculaPeriodoVO.setSituacao("PF"); // é definida com pendente financeiramente, até que a atrícula seja paga.
		matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(parcelaMatricula);
	}

	/**
	 * Rotina Responsável por liberar o aluno do pagamento da matrícula, para
	 * isto ela gera uma conta a receber com um desconto necessário, para zerar
	 * o valor que, a priori, o aluno deveria pagar.
	 * 
	 * @param matriculaPeriodoVO
	 * @param parcelaMatricula
	 * @throws Exception
	 */
	public void gerarLiberacaoPagamentoMatricula_CriandoContaReceber(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO parcelaMatricula, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		criarContaReceberMatricula(matriculaVO, matriculaPeriodoVO, parcelaMatricula, true, configuracaoFinanceiro, usuario);
		matriculaPeriodoVO.setSituacao("AT");
		matriculaPeriodoVO.setSituacaoMatriculaPeriodo("AT");
		matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(parcelaMatricula);
		matriculaPeriodoVO.alterarSituacaoVencimentoRelativoMatricula(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarContaReceberLiberandoPagamentoMatricula(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		MatriculaPeriodoVencimentoVO parcelaMatricula = matriculaPeriodoVO.getMatriculaPeriodoVencimentoEspecifico("MA");
		getFacadeFactory().getContaReceberFacade().baixarContaReceberConcedendoDescontoTotalAMesma(parcelaMatricula.getContaReceber().getCodigo(), matriculaPeriodoVO.getData(), "Isenção de pagamento de matrícula.", true, false, usuario, configuracaoFinanceiro, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarContaReceberLiberandoPagamentoParcela(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, String parcela, String justificativa, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		MatriculaPeriodoVencimentoVO parcelaMatricula = matriculaPeriodoVO.getMatriculaPeriodoVencimentoEspecifico(parcela);
		getFacadeFactory().getContaReceberFacade().baixarContaReceberConcedendoDescontoTotalAMesma(parcelaMatricula.getContaReceber().getCodigo(), matriculaPeriodoVO.getData(), justificativa, true, false, usuario, configuracaoFinanceiro, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarMatriculaPeriodoLiberandoPagamentoMatricula(final MatriculaPeriodoVO obj) throws Exception {
		final String sql = "UPDATE MatriculaPeriodo set situacao=?, situacaoMatriculaPeriodo=?, dataLiberacaoMatricula=?, responsavelLiberacaoMatricula=?, motivoLiberacaoPgtoMatricula=? WHERE ((codigo = ?))";

		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
				sqlAlterar.setString(1, obj.getSituacao());
				sqlAlterar.setString(2, obj.getSituacaoMatriculaPeriodo());
				sqlAlterar.setDate(3, Uteis.getDataJDBC(obj.getDataLiberacaoMatricula()));
				sqlAlterar.setInt(4, obj.getResponsavelLiberacaoMatricula().getCodigo().intValue());
				sqlAlterar.setString(5, obj.getMotivoLiberacaoPgtoMatricula());
				sqlAlterar.setInt(6, obj.getCodigo());
				return sqlAlterar;
			}
		});

	}

	public void liberarMatriculaForaDoPrazo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, UsuarioVO usuarioResponsavel) throws Exception {
		ControleAcesso.verificarPermissaoUsuarioFuncionalidade("Matricula_LiberarMatricula", usuarioResponsavel);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void liberarPagamentoMatricula(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, UsuarioVO usuarioResponsavel, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		try {
			inicializarDadosParaProcessarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, usuario, configuracaoFinanceiro);
			ControleAcesso.verificarPermissaoUsuarioFuncionalidade("Matricula_LiberarMatricula", usuario);
			if (matriculaPeriodoVO.verificarParcelaReferenteMatriculaLiberadaPagamento()) {
				throw new Exception("Matrícula já isentada (liberada) de pagamento. Não possível isentar (liberar) o pagamento novamente.");
			}
			SituacaoVencimentoMatriculaPeriodo situacaoMatricula = matriculaPeriodoVO.obterSituacaoParcelasReferenteMatricula();
			if (situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) {
				throw new Exception("Não possível isentar (liberar) o pagamento de uma matrícula, que já foi paga.");
			}
			if (situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA)) {
				MatriculaPeriodoVencimentoVO parcelaMatricula = gerarVencimentoMatricula(matriculaPeriodoVO, matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDataVencimentoMatricula());
				gerarLiberacaoPagamentoMatricula_CriandoContaReceber(matriculaVO, matriculaPeriodoVO, parcelaMatricula, configuracaoFinanceiro, usuario);
				matriculaPeriodoVO.alterarSituacaoVencimentoRelativoMatricula(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA);
				getFacadeFactory().getMatriculaPeriodoVencimentoFacade().incluir(parcelaMatricula, usuario);
			}
			if (situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA)) {
				alterarContaReceberLiberandoPagamentoMatricula(matriculaVO, matriculaPeriodoVO, configuracaoFinanceiro, usuario);
				matriculaPeriodoVO.alterarSituacaoVencimentoRelativoMatricula(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA);
				getFacadeFactory().getMatriculaPeriodoVencimentoFacade().alterar(matriculaPeriodoVO.getMatriculaPeriodoVencimentoReferenteMatricula(), false, null);
			}

			matriculaPeriodoVO.setDataLiberacaoMatricula(new Date());
			matriculaPeriodoVO.setResponsavelLiberacaoMatricula(usuarioResponsavel);
			matriculaPeriodoVO.setSituacao("AT");
			if (configuracaoFinanceiro.getAtivarPreMatriculaAutomaticamenteAposPagamentoTaxaMatricula()) {
				matriculaPeriodoVO.setSituacaoMatriculaPeriodo("AT");
			}
			alterarMatriculaPeriodoLiberandoPagamentoMatricula(matriculaPeriodoVO);
			matriculaVO.setSituacaoFinanceira("QU");
			getFacadeFactory().getMatriculaFacade().alterarSituacaoFinanceiraMatricula(matriculaVO.getMatricula(), matriculaVO.getSituacaoFinanceira());
			processarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, matriculaPeriodoVO.getProcessoMatriculaCalendarioVO(), null, null, configuracaoFinanceiro, usuario, false);
		} catch (Exception e) {
			throw e;
		}
	}

	/**
	 * Processar geracao de um único mï¿½s de uma determinada matrícula.
	 * 
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @param mesReferencia
	 *            - deve estar no formato 03/2010 (mes de referencia/ano de
	 *            referencia)
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void processarGeracaoContasReceberMesReferenciaEspecifica(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO mesReferencia, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, Boolean simulacao) throws Exception {
		// UnidadeEnsinoCursoVO unidadeEnsinoCursoVO =
		// getFacadeFactory().getUnidadeEnsinoCursoFacade().consultarPorChavePrimaria(matriculaVO.getCurso().getCodigo(),
		// matriculaVO.getUnidadeEnsino().getCodigo(),
		// matriculaVO.getTurno().getCodigo(),
		// Uteis.NIVELMONTARDADOS_DADOSBASICOS);
		// ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO =
		// getFacadeFactory().getProcessoMatriculaCalendarioFacade().consultarPorChavePrimaria(unidadeEnsinoCursoVO.getCodigo(),
		// matriculaPeriodoVO.getProcessoMatricula(),
		// Uteis.NIVELMONTARDADOS_TODOS);
		// matriculaPeriodoVO.setProcessoMatriculaCalendarioVO(processoMatriculaCalendarioVO);
		// ConfiguracaoFinanceiroVO configuracaoFinanceiro =
		// getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_DADOSBASICOS);
		// matriculaPeriodoVO.setConfiguracaoFinanceiro(configuracaoFinanceiro);
		SituacaoVencimentoMatriculaPeriodo situacaoAtualizada = SituacaoVencimentoMatriculaPeriodo.getEnum(matriculaPeriodoVO.getSituacaoMatriculaPeriodo());
		processarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, matriculaPeriodoVO.getProcessoMatriculaCalendarioVO(), mesReferencia, situacaoAtualizada, configuracaoFinanceiro, usuario, simulacao);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void processarGeracaoContasReceberAposConfirmacaoPagamentoMatricula(MatriculaVO matriculaVO, Integer codigoMatriculaPeriodoVO, SituacaoVencimentoMatriculaPeriodo situacaoMatriculaAtualizada, ConfiguracaoFinanceiroVO configuracaoFinanceiro, Boolean bloqueioPorFechamentoMesLiberado, UsuarioVO usuario) throws Exception {
		matriculaVO = getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(matriculaVO.getMatricula(), null, NivelMontarDados.TODOS, usuario);
		matriculaVO.setPlanoFinanceiroAluno(getFacadeFactory().getPlanoFinanceiroAlunoFacade().consultarPorMatriculaPeriodo(codigoMatriculaPeriodoVO, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
		MatriculaPeriodoVO matriculaPeriodoVO = null;
		if ((codigoMatriculaPeriodoVO != null) && (codigoMatriculaPeriodoVO != 0)) {
			// matriculaPeriodoVO =
			// matriculaVO.consultarObjMatriculaPeriodoVOPorCodigo(codigoMatriculaPeriodoVO);
			// matriculaPeriodoVO =
			// consultarPorChavePrimaria(codigoMatriculaPeriodoVO,
			// Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiro,
			// usuario);
			matriculaPeriodoVO = new MatriculaPeriodoVO();
			matriculaPeriodoVO.setCodigo(codigoMatriculaPeriodoVO);
			getFacadeFactory().getMatriculaPeriodoFacade().carregarDados(matriculaPeriodoVO, NivelMontarDados.TODOS, configuracaoFinanceiro, usuario);
		} else {
			matriculaPeriodoVO = matriculaVO.getMatriculaPeriodoVOAtiva();// 32
			// 53
			// getFacadeFactory().getMatriculaPeriodoFacade().consultarPorChavePrimaria(codigoMatriculaPeriodoVO,
			// Uteis.NIVELMONTARDADOS_TODOS);
		}
		if (matriculaPeriodoVO == null) {
			return;
		}
		if(bloqueioPorFechamentoMesLiberado) {
			matriculaPeriodoVO.liberarVerificacaoBloqueioFechamentoMes();
		}
		UnidadeEnsinoCursoVO unidadeEnsinoCursoVO = null;
		if (matriculaPeriodoVO.getUnidadeEnsinoCursoVO().getCodigo().equals(0)) {
			unidadeEnsinoCursoVO = getFacadeFactory().getUnidadeEnsinoCursoFacade().consultarPorChavePrimaria(matriculaVO.getCurso().getCodigo(), matriculaVO.getUnidadeEnsino().getCodigo(), matriculaVO.getTurno().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		} else {
			unidadeEnsinoCursoVO = matriculaPeriodoVO.getUnidadeEnsinoCursoVO();
		}
		ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO = getFacadeFactory().getProcessoMatriculaCalendarioFacade().consultarPorChavePrimaria(unidadeEnsinoCursoVO.getCurso().getCodigo(), unidadeEnsinoCursoVO.getTurno().getCodigo(), matriculaPeriodoVO.getProcessoMatricula(), Uteis.NIVELMONTARDADOS_TODOS, usuario);
		matriculaPeriodoVO.setProcessoMatriculaCalendarioVO(processoMatriculaCalendarioVO);
		// ConfiguracaoFinanceiroVO configuracaoFinanceiro =
		// getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_DADOSBASICOS);
		// matriculaPeriodoVO.setConfiguracaoFinanceiro(configuracaoFinanceiro);
		matriculaPeriodoVO.setCondicaoPagamentoPlanoFinanceiroCurso(matriculaVO.getPlanoFinanceiroAluno().getCondicaoPagamentoPlanoFinanceiroCursoVO());
		processarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, null, situacaoMatriculaAtualizada, configuracaoFinanceiro, usuario, false);
	}

	/**
	 * Rotina Responsável por excluir todos os registros de
	 * MatriculaPeriodoVencimento, com as respectivas contas a receber geradas
	 * para a mesma. Este Método deve ser chamado somente, quando uma matrícula
	 * estão sendo alterada, com o objetivo, de gerar os vencimentos novamente,
	 * conforme os novos parâmetros informados.
	 * 
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirTodosVencimentosEContasReceberGeradasMatriculaEParcelas(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		// tem que ser excluido primeiro, pois fazem referencia as conta a receber. Assim, somente,
		// depois de excluir estes dados poderemos excluir as contas a receber de fato.
		getFacadeFactory().getMatriculaPeriodoVencimentoFacade().excluirTodos(matriculaPeriodoVO.getCodigo(), usuario);
		matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().clear();
		matriculaPeriodoVO.setMatriculaPeriodoVencimentoVOs(new ArrayList(0));
		excluirContaReceberGeradasParaConvenios(matriculaPeriodoVO, usuario);
		excluirContaReceberGeradasParaMatricula(matriculaPeriodoVO, usuario);
		excluirContaReceberGeradasParaMensalidade(matriculaPeriodoVO, usuario);
		excluirContaReceberGeradasParaMaterialDidatico(matriculaPeriodoVO, usuario);

	}

	/*
	 * Esta lista ï¿½ utilizada somente para geração de parcelas manual Esta
	 * lista armazena em memï¿½ria, a lista de matriculaPeriodoVencimentoVOs que
	 * foram geradas manualmente pelo usuário para uma determinada
	 * matriculaPeriodo Isto ï¿½ importante, pois quando editamos uma matrícula
	 * periodo, o SEI sozinho exclui contas a receber geradas, e as gera
	 * novamente, de acordo com novas informaï¿½ï¿½es definidas no plano
	 * financeiro ao aluno. Contudo, como o controle estão manual, quando o SEI
	 * exlcuir as parcelas geradas e nao pagas, a rotina de geracao precisa
	 * dominar quais parcelas ja foram anteriormente geradas pelo usuario,
	 * garantindo assim, que as estas parcelas já sejam automaticamente
	 * regeradas, evitando do aluno pagar uma parcela, sem que haja, uma conta a
	 * receber para ser baixada. Por exemplo, imagine que o usuario gere a
	 * parcela 4/5 (com vencimento em 10/10/2010. Considere que o aluno nao
	 * pagou esta parcela, contudo, o mesmo recebeu o boleto pertinente a mesma.
	 * Apos o aluno receber o boleto, image que a matricula do mesmo seja
	 * editada por alguma razao, isto implicarï¿½ que o SEI irá apagar as contas
	 * a receber nao pagas. Contudo, a rotina de geracao deverï¿½ perceber que o
	 * controle de geracao esta manual e automaticamente regerar a parcela 4/5.
	 * Caso controario se o aluno pagar a mesma, teremos um problema grave, pois
	 * nao existirá uma conta a receber para ser baixada.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.SUPPORTS)
	private void registrarMatriculaPeriodoVencimentoJaGeradasEExcluidas(MatriculaPeriodoVO matriculaPeriodoVO) {
		matriculaPeriodoVO.getListaParcelasGeradasManualmenteAnteriormenteAptasParaRegeracao().clear();
		for (MatriculaPeriodoVencimentoVO vcto : matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOsCompleto()) {
			if (vcto.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA)) {
				MatriculaPeriodoVencimentoVO novaVcto = new MatriculaPeriodoVencimentoVO();
				novaVcto.setTipoOrigemMatriculaPeriodoVencimento(vcto.getTipoOrigemMatriculaPeriodoVencimento());
				novaVcto.setUsaValorPrimeiraParcela(vcto.isUsaValorPrimeiraParcela());
				novaVcto.setParcela(vcto.getParcela());
				if (novaVcto.getParcela().contains("/")) {
					novaVcto.setParcela(novaVcto.getParcela().substring(0, novaVcto.getParcela().indexOf("/")));
				}
				matriculaPeriodoVO.getListaParcelasGeradasManualmenteAnteriormenteAptasParaRegeracao().add(novaVcto);
			}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void excluirVencimentosEContasReceberGeradasParaParcelasNaoPagas(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, Boolean possuiValorRateio,  UsuarioVO usuario) throws Exception {
		// tem que ser excluido primeiro, pois fazem referencia as conta a receber. 
		// Assim, somente, depois de excluir estes dados poderemos excluir as contas a receber de fato.
		registrarMatriculaPeriodoVencimentoJaGeradasEExcluidas(matriculaPeriodoVO);
		getFacadeFactory().getMatriculaPeriodoVencimentoFacade().excluirSemCommitVctoNaoPagos(matriculaPeriodoVO, possuiValorRateio, usuario);		
	}

	private void excluirVctoGeradoCorrespondenteAoVctoJaPago(List<MatriculaPeriodoVencimentoVO> listaVctosGerados, MatriculaPeriodoVencimentoVO vctoGeradosAnteriormente) throws Exception {
		for (Iterator<MatriculaPeriodoVencimentoVO> iterator = listaVctosGerados.iterator(); iterator.hasNext();) {			
			MatriculaPeriodoVencimentoVO vctoGerado = (MatriculaPeriodoVencimentoVO) iterator.next();
			String nrParcelaGerado = vctoGerado.getParcela().contains("/") ?  vctoGerado.getParcela().substring(0, vctoGerado.getParcela().indexOf("/")) : vctoGerado.getParcela();
			String nrParcela = "";
			if (vctoGeradosAnteriormente.getParcela().contains("/")) {
				nrParcela = vctoGeradosAnteriormente.getParcela().substring(0, vctoGeradosAnteriormente.getParcela().indexOf("/"));
			} else {
				nrParcela = vctoGeradosAnteriormente.getParcela();
			}						
			if (!nrParcela.contains("EX")  
					&& Integer.parseInt(nrParcelaGerado) == Integer.parseInt(nrParcela)
					&& vctoGerado.getTipoOrigemMatriculaPeriodoVencimento().equals(vctoGeradosAnteriormente.getTipoOrigemMatriculaPeriodoVencimento())) {
				iterator.remove();
				return;			
			}
		}

	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void executarAjusteIdentificadorNumeroParcelasParaTitulosImportados(Integer totalParcelaMaterialDidtatico, Integer totalParcelaMensalidade, MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		Iterator i = matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().iterator();
		while (i.hasNext()) {
			MatriculaPeriodoVencimentoVO vctoExistente = (MatriculaPeriodoVencimentoVO) i.next();
			if ((vctoExistente.getContaReceber().getTituloImportadoSistemaLegado()) 
					&& (!vctoExistente.getTipoOrigemMatriculaPeriodoVencimento().isMatricula()) 
					&& !vctoExistente.getContaReceber().getSituacao().equals("NE") 
					&& (!matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoRegerarParcelaVencida() 
							|| (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoRegerarParcelaVencida() && vctoExistente.getContaReceber().getCodigo() == 0) 
							|| (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoRegerarParcelaVencida() 
									&& vctoExistente.getContaReceber().getCodigo() > 0 
									&& vctoExistente.getContaReceber().getSituacao().equals("AR") 
									&& Uteis.getDataJDBC(vctoExistente.getContaReceber().getDataVencimento()).compareTo(Uteis.getDataJDBC(new Date())) > 0))) {

				String identificadorParcela = vctoExistente.getParcela();
				String nrDaParcela = identificadorParcela.substring(0, identificadorParcela.indexOf("/"));
				String nrDeParcelas = identificadorParcela.substring(identificadorParcela.indexOf("/") + 1, identificadorParcela.length());
				Integer nrDeParcelasInt = Integer.parseInt(nrDeParcelas);
				if (!nrDeParcelasInt.equals(totalParcelaMensalidade) && vctoExistente.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade()) {
					vctoExistente.setParcela(nrDaParcela + "/" + totalParcelaMensalidade);
				}else if (!nrDeParcelasInt.equals(totalParcelaMaterialDidtatico) && vctoExistente.getTipoOrigemMatriculaPeriodoVencimento().isMaterialDidatico()) {
					vctoExistente.setParcela(nrDaParcela + "/" + totalParcelaMaterialDidtatico);
				}
			}
		}
	}

	/**
	 * Esta rotina ï¿½ Responsável por registrar as parcelas ainda não pagas,
	 * considerando o valor de diferença gerado com relação as parcelas já
	 * pagas.
	 * 
	 * @param listaVctosGerados
	 * @param matriculaPeriodoVO
	 * @param valorDiferencaValorCobrarComRelacaoValorJaPago
	 * @throws Exception
	 */
	private void registrarParcelasGeradasAindaNaoPagas_ContabilizandoValorDiferencaCobrarComRelacaoValorPago(List<MatriculaPeriodoVencimentoVO> listaVctosGerados, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, Double valorDiferencaValorCobrarComRelacaoValorJaPago, ConfiguracaoFinanceiroVO configuracaoFinanceiro, boolean simulandoAlteracao, UsuarioVO usuarioVO) throws Exception {
		
		// Processar os vctos já pagos excluindo os mesmos da lista de vcto a gerar
		executarRemocaoVctoPagosOuImportadosSistemaLegadoDaListaVctoAdicionarMatriculaPeriodo(listaVctosGerados, matriculaPeriodoVO);
		boolean ratiarValorDescontoCreditoParaParcelas = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getRatiarValorDiferencaInclusaoExclusaoParaTodasParcelas();
		// Processar a inclusao dos itens restantes, referentes as demais parcelas que ainda não foram pagas.
		Boolean existeDescontoCreditoParaLancarParcelas = true;
		if (valorDiferencaValorCobrarComRelacaoValorJaPago == 0 && !simulandoAlteracao) {
			existeDescontoCreditoParaLancarParcelas = false;
		}
		executarRemocaoVctoAntesDataAtualDaListaVctoAdicionarMatriculaPeriodo(listaVctosGerados, matriculaPeriodoVO, valorDiferencaValorCobrarComRelacaoValorJaPago);		
		registrarParcelasGeradasAindaNaoPagasExtras_ContabilizandoValorDiferencaCobrarComRelacaoValorPago(listaVctosGerados, matriculaPeriodoVO, valorDiferencaValorCobrarComRelacaoValorJaPago, simulandoAlteracao);
		
		Double valorTotalDescontoAplicar = valorDiferencaValorCobrarComRelacaoValorJaPago;
		long qtdParcelaDiferenteMaterialDitatico = listaVctosGerados.stream().filter(v -> v.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade()).count();
		if (ratiarValorDescontoCreditoParaParcelas && (valorDiferencaValorCobrarComRelacaoValorJaPago != 0) && (qtdParcelaDiferenteMaterialDitatico != 0L)) {
			valorDiferencaValorCobrarComRelacaoValorJaPago = Uteis.arrendondarForcando2CadasDecimais((valorDiferencaValorCobrarComRelacaoValorJaPago / qtdParcelaDiferenteMaterialDitatico));
		}
		String tipoCalculoDescontoOuCredito = "Credito";
		if (valorDiferencaValorCobrarComRelacaoValorJaPago < 0) {
			// tirando o valor negativo, para facilitar nos calculos abaixo...
			valorDiferencaValorCobrarComRelacaoValorJaPago = valorDiferencaValorCobrarComRelacaoValorJaPago * -1;
			tipoCalculoDescontoOuCredito = "Desconto";
		}
		Integer numeroParcelaExtra = 0;
		if (valorDiferencaValorCobrarComRelacaoValorJaPago > 0 && !simulandoAlteracao) {
			for (MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO : matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()) {
				if(matriculaPeriodoVencimentoVO.getParcela().contains("EX")){
					if(matriculaPeriodoVencimentoVO.getParcela().replaceAll("EX", "").trim().isEmpty()){
						numeroParcelaExtra++;
					} else if(matriculaPeriodoVencimentoVO.getParcela().replaceAll("EX", "").compareTo(numeroParcelaExtra.toString()) > 0){
						numeroParcelaExtra = Integer.valueOf(matriculaPeriodoVencimentoVO.getParcela().replaceAll("EX", ""))+1;
					}
				}
			}
		}
		
		if(qtdParcelaDiferenteMaterialDitatico == 0L && valorDiferencaValorCobrarComRelacaoValorJaPago > 0){
			realizarCalculoRateioParcelaAinaNaoGerada(matriculaPeriodoVO, valorDiferencaValorCobrarComRelacaoValorJaPago, simulandoAlteracao, tipoCalculoDescontoOuCredito, numeroParcelaExtra, configuracaoFinanceiro, usuarioVO);
			for (MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO : listaVctosGerados) {
				// ..adicionar para ser gerado e gravado na rotina Responsável por isto...
				matriculaPeriodoVencimentoVO.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);
				if (matriculaPeriodoVencimentoVO.getParcela().contains("/") && !simulandoAlteracao) {
					adicionarMatriculaPeriodoVencimento(matriculaPeriodoVO, matriculaPeriodoVencimentoVO);
				}
			}
		}else{
			realizarCalculoRateioParcelaAinaNaoGeradaListaVencimentos(listaVctosGerados, matriculaVO, matriculaPeriodoVO,  valorDiferencaValorCobrarComRelacaoValorJaPago, valorTotalDescontoAplicar, simulandoAlteracao, existeDescontoCreditoParaLancarParcelas, ratiarValorDescontoCreditoParaParcelas, tipoCalculoDescontoOuCredito, numeroParcelaExtra, qtdParcelaDiferenteMaterialDitatico, configuracaoFinanceiro, usuarioVO);
		}
	}
	
	private void realizarCalculoRateioParcelaAinaNaoGerada(MatriculaPeriodoVO matriculaPeriodoVO, Double valorDiferencaValorCobrarComRelacaoValorJaPago, boolean simulandoAlteracao, String tipoCalculoDescontoOuCredito, Integer numeroParcelaExtra, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuarioVO) throws Exception{
		if (tipoCalculoDescontoOuCredito.equals("Credito")) {
			int nrMensalidade = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNrParcelasPeriodo();
			if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isGerarParcelaMaterialDidatico() && matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getTipoGeracaoMaterialDidatico().isAntesParcelaAcademico()){
				nrMensalidade = nrMensalidade + matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getQuantidadeParcelasMaterialDidatico().intValue();
			}
			Date dataVencimento = montarDataVencimento(nrMensalidade, matriculaPeriodoVO, usuarioVO);		
			Date hoje = new Date();
			if(dataVencimento.compareTo(hoje) < 0){
				dataVencimento = hoje;
			}
			Integer nrParcelas = 0;
			for(MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO : matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()){					
				if(matriculaPeriodoVencimentoVO.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade() && !matriculaPeriodoVencimentoVO.getParcela().contains("EX") && matriculaPeriodoVencimentoVO.getDataVencimento().compareTo(hoje) > 0){
					nrParcelas++;
					if(matriculaPeriodoVencimentoVO.getDataVencimento().compareTo(dataVencimento) < 0){
						dataVencimento = matriculaPeriodoVencimentoVO.getDataVencimento();
					}
				}
			}
			if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getRatiarValorDiferencaInclusaoExclusaoParaTodasParcelas() && nrParcelas > 1){
				Double valorParcela =  Uteis.arrendondarForcando2CadasDecimais(valorDiferencaValorCobrarComRelacaoValorJaPago / nrParcelas.doubleValue());
				Double valorParcelaGerado = 0.0;				
				while(nrParcelas >= 1){
					dataVencimento = montarDataVencimento(nrMensalidade - nrParcelas + 1, matriculaPeriodoVO, usuarioVO);
					if(nrParcelas.equals(1)){
						valorParcela = valorDiferencaValorCobrarComRelacaoValorJaPago - valorParcelaGerado;													
					}
					valorParcelaGerado += valorParcela;
					String parcela = "";
					if(numeroParcelaExtra > 0){
						parcela = "EX" + numeroParcelaExtra;
					}else{
						parcela = "EX";
					}
					numeroParcelaExtra++;
					if(!simulandoAlteracao){
						matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(realizarCriacaoMatriculaPeriodoVencimento(matriculaPeriodoVO, dataVencimento, parcela, valorParcela, "Cobrança valor adicionar (R$ " + Uteis.getDoubleFormatado(valorParcela) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula.", false ));
					}else{
						MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO = realizarCriacaoMatriculaPeriodoVencimento(matriculaPeriodoVO, dataVencimento, parcela, valorParcela, "Cobrança valor adicionar (R$ " + Uteis.getDoubleFormatado(valorParcela) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula.",false );
				    	matriculaPeriodoVencimentoVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(valorParcela);
						matriculaPeriodoVO.getMatriculaPeriodoContaReceberAlterarLogVOs().add(realizarPreenchimentoContaReceberSeraIncluidaPorMatriculaPeriodoVencimento(matriculaPeriodoVO, matriculaPeriodoVencimentoVO, OperacaoMatriculaPeriodoContaLogEnum.INCLUIDA_RECEBER));
					}
					nrParcelas--;
				}
			}else{
				String parcela = "";
				if(numeroParcelaExtra > 0){
					parcela = "EX"+numeroParcelaExtra;
				}else{
					parcela = "EX";
				}
				numeroParcelaExtra++;
				if(!simulandoAlteracao){
					matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(realizarCriacaoMatriculaPeriodoVencimento(matriculaPeriodoVO, dataVencimento, parcela, valorDiferencaValorCobrarComRelacaoValorJaPago, "Cobrança valor adicionar (R$ " + Uteis.getDoubleFormatado(valorDiferencaValorCobrarComRelacaoValorJaPago) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula.",false ));
				}else{
					MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO = realizarCriacaoMatriculaPeriodoVencimento(matriculaPeriodoVO, dataVencimento, parcela, valorDiferencaValorCobrarComRelacaoValorJaPago, "Cobrança valor adicionar (R$ " + Uteis.getDoubleFormatado(valorDiferencaValorCobrarComRelacaoValorJaPago) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula.",false );
					matriculaPeriodoVencimentoVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(valorDiferencaValorCobrarComRelacaoValorJaPago);
					matriculaPeriodoVO.getMatriculaPeriodoContaReceberAlterarLogVOs().add(realizarPreenchimentoContaReceberSeraIncluidaPorMatriculaPeriodoVencimento(matriculaPeriodoVO, matriculaPeriodoVencimentoVO, OperacaoMatriculaPeriodoContaLogEnum.INCLUIDA_RECEBER));
				}
			}
		}else if(Uteis.arrendondarForcando2CadasDecimais(valorDiferencaValorCobrarComRelacaoValorJaPago) > 0 && !tipoCalculoDescontoOuCredito.equals("Credito")){
			    if(!simulandoAlteracao){
			    	gerarContaPagarRestituirAlunoValorJaPagoParcelaEspecifica(new Date(), valorDiferencaValorCobrarComRelacaoValorJaPago, matriculaPeriodoVO.getMatriculaVO(), matriculaPeriodoVO, configuracaoFinanceiro, usuarioVO);
			    }else{
			    	MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO = new MatriculaPeriodoVencimentoVO();
			    	matriculaPeriodoVencimentoVO.setValor(valorDiferencaValorCobrarComRelacaoValorJaPago);
			    	matriculaPeriodoVencimentoVO.setParcela("PG");
			    	matriculaPeriodoVencimentoVO.setDataVencimento(new Date());
			    	matriculaPeriodoVencimentoVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(valorDiferencaValorCobrarComRelacaoValorJaPago);
			    	matriculaPeriodoVO.getMatriculaPeriodoContaReceberAlterarLogVOs().add(realizarPreenchimentoContaReceberSeraIncluidaPorMatriculaPeriodoVencimento(matriculaPeriodoVO, matriculaPeriodoVencimentoVO, OperacaoMatriculaPeriodoContaLogEnum.INCLUIDA_PAGAR));
			    }
		}
	}
	
	private void realizarCalculoRateioParcelaAinaNaoGeradaListaVencimentos (List<MatriculaPeriodoVencimentoVO> listaVctosGerados, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, Double valorDiferencaValorCobrarComRelacaoValorJaPago, Double valorTotalDescontoAplicar , boolean simulandoAlteracao, Boolean existeDescontoCreditoParaLancarParcelas, boolean ratiarValorDescontoCreditoParaParcelas, String tipoCalculoDescontoOuCredito, Integer numeroParcelaExtra, long qtdParcelaDiferenteMaterialDitatico, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuarioVO) throws Exception{

		Collections.sort(listaVctosGerados, OrdenarMatriculaPeriodoVencimentoEnum.DATA_VENCIMENTO.asc());
		Double valorCusteadoConvenio = 0.0;
		if(!matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().isEmpty() && !matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().get(0).getListaDescontosMensalidade().isEmpty()){
			valorCusteadoConvenio = matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().get(0).getListaDescontosMensalidade().get(0).getValorCusteadoContaReceber();
		}
		Iterator<MatriculaPeriodoVencimentoVO> i = listaVctosGerados.iterator();
		Double valorDescontoDiferencaParaVcto = 0.0;
		Double valorDescontoJaAplicado = 0.0;
		Integer nrParcelas = 0;
		while (i.hasNext()) {
			MatriculaPeriodoVencimentoVO novosVctoPodemSerAdicionarParaGeracao = (MatriculaPeriodoVencimentoVO) i.next();
			if (existeDescontoCreditoParaLancarParcelas && novosVctoPodemSerAdicionarParaGeracao.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade()) {
				if (tipoCalculoDescontoOuCredito.equals("Credito")) {
					if(!matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getGerarParcelasExtrasSeparadoMensalidadeAReceber()){
						if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getLancarValorRatiadoSobreValorBaseContaReceber()) {	
							Double valorBaseOriginal = novosVctoPodemSerAdicionarParaGeracao.getValor();
							novosVctoPodemSerAdicionarParaGeracao.setValor(Uteis.arrendondarForcando2CadasDecimais(novosVctoPodemSerAdicionarParaGeracao.getValor() + valorDiferencaValorCobrarComRelacaoValorJaPago));							
							
							if(novosVctoPodemSerAdicionarParaGeracao.getTipoOrigemMatriculaPeriodoVencimento().equals(TipoOrigemContaReceber.MENSALIDADE)) {
								getFacadeFactory().getMatriculaPeriodoVencimentoFacade().realizarGeracaoDescricaoParcelaMensalidade(novosVctoPodemSerAdicionarParaGeracao, matriculaVO, matriculaPeriodoVO, matriculaVO.getPlanoFinanceiroAluno().obterOrdemAplicacaoDescontosPadraoAtual(), configuracaoFinanceiro);
							}else if (novosVctoPodemSerAdicionarParaGeracao.getTipoOrigemMatriculaPeriodoVencimento().equals(TipoOrigemContaReceber.MATERIAL_DIDATICO)) {
								getFacadeFactory().getMatriculaPeriodoVencimentoFacade().realizarGeracaoDescricaoParcelaMaterialDidatico(novosVctoPodemSerAdicionarParaGeracao, matriculaVO, matriculaPeriodoVO, matriculaVO.getPlanoFinanceiroAluno().obterOrdemAplicacaoDescontosPadraoAtual(), configuracaoFinanceiro);
							}
							novosVctoPodemSerAdicionarParaGeracao.setDescricaoPagamento("Cobrança valor adicional de (R$ " + Uteis.getDoubleFormatado(Uteis.arrendondarForcando2CadasDecimais(valorDiferencaValorCobrarComRelacaoValorJaPago)) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula, adicionada no valor base "+Uteis.getDoubleFormatado(Uteis.arrendondarForcando2CadasDecimais(valorBaseOriginal))+".");
							
							
							
						}else {
						novosVctoPodemSerAdicionarParaGeracao.setValor(novosVctoPodemSerAdicionarParaGeracao.getValor());
						novosVctoPodemSerAdicionarParaGeracao.setAcrescimoExtra(valorDiferencaValorCobrarComRelacaoValorJaPago);
							novosVctoPodemSerAdicionarParaGeracao.setDescricaoPagamento("Cobrança valor adicional (R$ " + Uteis.getDoubleFormatado(Uteis.arrendondarForcando2CadasDecimais(valorDiferencaValorCobrarComRelacaoValorJaPago)) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula.");
						}
						if(simulandoAlteracao){
							matriculaPeriodoVO.getMatriculaPeriodoContaReceberAlterarLogVOs().add(realizarPreenchimentoContaReceberSeraIncluidaPorMatriculaPeriodoVencimento(matriculaPeriodoVO, novosVctoPodemSerAdicionarParaGeracao, OperacaoMatriculaPeriodoContaLogEnum.ALTERADA_COM_EXTRA));
						}
					}else{
						nrParcelas++;

						if(ratiarValorDescontoCreditoParaParcelas && nrParcelas.equals(qtdParcelaDiferenteMaterialDitatico)){
							valorDiferencaValorCobrarComRelacaoValorJaPago = (valorTotalDescontoAplicar) - Uteis.arrendondarForcando2CadasDecimais(valorDescontoJaAplicado);
						}
						String parcela = "";
						if(numeroParcelaExtra > 0){
							parcela = "EX"+numeroParcelaExtra;
						}else{
							parcela = "EX";
						}
						numeroParcelaExtra++;
						valorDescontoJaAplicado += valorDiferencaValorCobrarComRelacaoValorJaPago;
						if(!simulandoAlteracao){
							adicionarMatriculaPeriodoVencimento(matriculaPeriodoVO, realizarCriacaoMatriculaPeriodoVencimento(matriculaPeriodoVO, novosVctoPodemSerAdicionarParaGeracao.getDataVencimento(), parcela, valorDiferencaValorCobrarComRelacaoValorJaPago, "Cobrança valor adicionar (R$ " + Uteis.getDoubleFormatado(valorDiferencaValorCobrarComRelacaoValorJaPago) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula.", novosVctoPodemSerAdicionarParaGeracao.isUsaValorPrimeiraParcela()));
						}else{
							MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO = realizarCriacaoMatriculaPeriodoVencimento(matriculaPeriodoVO, novosVctoPodemSerAdicionarParaGeracao.getDataVencimento(), parcela, valorDiferencaValorCobrarComRelacaoValorJaPago, "Cobrança valor adicionar (R$ " + Uteis.getDoubleFormatado(valorDiferencaValorCobrarComRelacaoValorJaPago) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula." , novosVctoPodemSerAdicionarParaGeracao.isUsaValorPrimeiraParcela());
					    	matriculaPeriodoVencimentoVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(valorDiferencaValorCobrarComRelacaoValorJaPago);
					    	matriculaPeriodoVO.getMatriculaPeriodoContaReceberAlterarLogVOs().add(realizarPreenchimentoContaReceberSeraIncluidaPorMatriculaPeriodoVencimento(matriculaPeriodoVO, matriculaPeriodoVencimentoVO, OperacaoMatriculaPeriodoContaLogEnum.INCLUIDA_RECEBER));
						}
					}
					if (!ratiarValorDescontoCreditoParaParcelas) {
						existeDescontoCreditoParaLancarParcelas = Boolean.FALSE;
					}
					// Existe uma diferença que precisa ser cobrada do aluno
				} else {
					nrParcelas++;
					valorDescontoDiferencaParaVcto = Uteis.arrendondarForcando2CadasDecimais(valorDiferencaValorCobrarComRelacaoValorJaPago);
					if(ratiarValorDescontoCreditoParaParcelas && nrParcelas.longValue() == qtdParcelaDiferenteMaterialDitatico){
						valorDescontoDiferencaParaVcto = (valorTotalDescontoAplicar*-1) - Uteis.arrendondarForcando2CadasDecimais(valorDescontoJaAplicado);
					}
					// Existe uma diferença que precisa ser dada como desconto para o aluno.					
					Double valorFinalTituloAntesSomarValorDiferente = novosVctoPodemSerAdicionarParaGeracao.getCalcularValorFinal()-valorCusteadoConvenio;
//					if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioBaseadoValorBaseComDescontosAplicados()){
						valorFinalTituloAntesSomarValorDiferente = novosVctoPodemSerAdicionarParaGeracao.getValorDescontoCalculadoPrimeiraFaixaDescontos();
//					}
					if (valorDescontoDiferencaParaVcto > valorFinalTituloAntesSomarValorDiferente) {					
						valorDescontoDiferencaParaVcto = valorFinalTituloAntesSomarValorDiferente;
						if (!ratiarValorDescontoCreditoParaParcelas) {
							valorDiferencaValorCobrarComRelacaoValorJaPago = valorDiferencaValorCobrarComRelacaoValorJaPago-valorDescontoDiferencaParaVcto;
						}
						valorDescontoJaAplicado += valorFinalTituloAntesSomarValorDiferente; 
					} else {
						valorDescontoJaAplicado += valorDescontoDiferencaParaVcto;
						if (!ratiarValorDescontoCreditoParaParcelas) {
							existeDescontoCreditoParaLancarParcelas = Boolean.FALSE;
							valorDiferencaValorCobrarComRelacaoValorJaPago = 0.0;
						}
					}
					if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getLancarValorRatiadoSobreValorBaseContaReceber()) {	
						Double valorBaseOriginal = novosVctoPodemSerAdicionarParaGeracao.getValor();
						novosVctoPodemSerAdicionarParaGeracao.setValor(Uteis.arrendondarForcando2CadasDecimais(novosVctoPodemSerAdicionarParaGeracao.getValor() - valorDescontoDiferencaParaVcto));							
						
						if(novosVctoPodemSerAdicionarParaGeracao.getTipoOrigemMatriculaPeriodoVencimento().equals(TipoOrigemContaReceber.MENSALIDADE)) {
							getFacadeFactory().getMatriculaPeriodoVencimentoFacade().realizarGeracaoDescricaoParcelaMensalidade(novosVctoPodemSerAdicionarParaGeracao, matriculaVO, matriculaPeriodoVO, matriculaVO.getPlanoFinanceiroAluno().obterOrdemAplicacaoDescontosPadraoAtual(), configuracaoFinanceiro);
						}else if (novosVctoPodemSerAdicionarParaGeracao.getTipoOrigemMatriculaPeriodoVencimento().equals(TipoOrigemContaReceber.MATERIAL_DIDATICO)) {
							getFacadeFactory().getMatriculaPeriodoVencimentoFacade().realizarGeracaoDescricaoParcelaMaterialDidatico(novosVctoPodemSerAdicionarParaGeracao, matriculaVO, matriculaPeriodoVO, matriculaVO.getPlanoFinanceiroAluno().obterOrdemAplicacaoDescontosPadraoAtual(), configuracaoFinanceiro);
						}
						novosVctoPodemSerAdicionarParaGeracao.setDescricaoPagamento("\nDesconto valor de (R$ " + Uteis.getDoubleFormatado(Uteis.arrendondarForcando2CadasDecimais(valorDescontoDiferencaParaVcto)) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula, descontado no valor base "+Uteis.getDoubleFormatado(Uteis.arrendondarForcando2CadasDecimais(valorBaseOriginal))+".");
					}else {
						novosVctoPodemSerAdicionarParaGeracao.setValorDesconto(novosVctoPodemSerAdicionarParaGeracao.getValorDesconto() + valorDescontoDiferencaParaVcto);
						novosVctoPodemSerAdicionarParaGeracao.setDescricaoPagamento("\nDesconto valor (R$ " + Uteis.getDoubleFormatado(valorDescontoDiferencaParaVcto) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula.");
					}
					
					if(simulandoAlteracao){
						matriculaPeriodoVO.getMatriculaPeriodoContaReceberAlterarLogVOs().add(realizarPreenchimentoContaReceberSeraIncluidaPorMatriculaPeriodoVencimento(matriculaPeriodoVO, novosVctoPodemSerAdicionarParaGeracao, OperacaoMatriculaPeriodoContaLogEnum.ALTERADA_COM_RATEIO));
					}
				}
			}
			// ..adicionar para ser gerado e gravado na rotina Responsável por isto...
			novosVctoPodemSerAdicionarParaGeracao.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);
			if (novosVctoPodemSerAdicionarParaGeracao.getParcela().contains("EX")) {
				if (tipoCalculoDescontoOuCredito.equals("Credito")) {
					novosVctoPodemSerAdicionarParaGeracao.setValor(valorDiferencaValorCobrarComRelacaoValorJaPago);
				}
			}
			if (novosVctoPodemSerAdicionarParaGeracao.getParcela().contains("/") && !simulandoAlteracao) {
				adicionarMatriculaPeriodoVencimento(matriculaPeriodoVO, novosVctoPodemSerAdicionarParaGeracao);
			}			
		}
		if(!tipoCalculoDescontoOuCredito.equals("Credito")){
			valorDiferencaValorCobrarComRelacaoValorJaPago = (valorTotalDescontoAplicar*-1)-valorDescontoJaAplicado;
		}
		if(Uteis.arrendondarForcando2CadasDecimais(valorDiferencaValorCobrarComRelacaoValorJaPago) > 0 
				&& !tipoCalculoDescontoOuCredito.equals("Credito")){
			if(!simulandoAlteracao){
				gerarContaPagarRestituirAlunoValorJaPagoParcelaEspecifica(new Date(), valorDiferencaValorCobrarComRelacaoValorJaPago, matriculaPeriodoVO.getMatriculaVO(), matriculaPeriodoVO, configuracaoFinanceiro, usuarioVO);
			}else{
				MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO = new MatriculaPeriodoVencimentoVO();
		    	matriculaPeriodoVencimentoVO.setValor(valorDiferencaValorCobrarComRelacaoValorJaPago);
		    	matriculaPeriodoVencimentoVO.setParcela("PG");
		    	matriculaPeriodoVencimentoVO.setDataVencimento(new Date());
		    	matriculaPeriodoVencimentoVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(valorDiferencaValorCobrarComRelacaoValorJaPago);
		    	matriculaPeriodoVO.getMatriculaPeriodoContaReceberAlterarLogVOs().add(realizarPreenchimentoContaReceberSeraIncluidaPorMatriculaPeriodoVencimento(matriculaPeriodoVO, matriculaPeriodoVencimentoVO, OperacaoMatriculaPeriodoContaLogEnum.INCLUIDA_PAGAR));
			}
		}
	}
	
	private void  registrarParcelasGeradasAindaNaoPagasExtras_ContabilizandoValorDiferencaCobrarComRelacaoValorPago(List<MatriculaPeriodoVencimentoVO> listaVctosGerados, MatriculaPeriodoVO matriculaPeriodoVO, Double valorDiferencaValorCobrarComRelacaoValorJaPago, boolean simulandoAlteracao) throws Exception{
		if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getGerarParcelasExtrasSeparadoMensalidadeAReceber() && valorDiferencaValorCobrarComRelacaoValorJaPago > 0 && !simulandoAlteracao){	
			Map<String, MatriculaPeriodoVencimentoVO> mapParcelaExtra = new HashMap<String, MatriculaPeriodoVencimentoVO>(0);
			for (Iterator<MatriculaPeriodoVencimentoVO> iterator = matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().iterator(); iterator.hasNext();) {
				MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO = (MatriculaPeriodoVencimentoVO) iterator.next();
				if(matriculaPeriodoVencimentoVO.getParcela().contains("EX")
						&& matriculaPeriodoVencimentoVO.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade()
						&& matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)){
					mapParcelaExtra.put(Uteis.getDataMesAnoConcatenado(matriculaPeriodoVencimentoVO.getDataVencimento()), matriculaPeriodoVencimentoVO);
				}			
			}
			if(!mapParcelaExtra.isEmpty()){
				for (Iterator<MatriculaPeriodoVencimentoVO> iterator = listaVctosGerados.iterator(); iterator.hasNext();) {
					MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO = (MatriculaPeriodoVencimentoVO) iterator.next();
					if(mapParcelaExtra.containsKey(Uteis.getDataMesAnoConcatenado(matriculaPeriodoVencimentoVO.getDataVencimento()))){
						adicionarMatriculaPeriodoVencimento(matriculaPeriodoVO, matriculaPeriodoVencimentoVO);
						iterator.remove();
					}					
				}
			}
		}
	}

	private void executarRemocaoVctoPagosOuImportadosSistemaLegadoDaListaVctoAdicionarMatriculaPeriodo(List<MatriculaPeriodoVencimentoVO> listaVctosGerados, MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		// Processar os vctos já pagos excluindo os mesmos da lista de vcto a
		// gerar
		Iterator i = matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().iterator();
		while (i.hasNext()) {
			MatriculaPeriodoVencimentoVO vctoGeradosAnteriormente = (MatriculaPeriodoVencimentoVO) i.next();
			if (vctoGeradosAnteriormente.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade()) {
				// só vamos processar aqui vctos convencionais, excluindo a
				// matricula. Pois a matrícula,
				// não estão contida na lista listaVctosGerados
				if ((vctoGeradosAnteriormente.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) || (vctoGeradosAnteriormente.getContaReceber().getTituloImportadoSistemaLegado())) {
					// Se entrarmos aqui ï¿½ por que pegamos um vcto anterior a
					// alteração atual que foi pago. Portanto,
					// o mesmo não pode mais ser alterado. Desta maneira, temos
					// que excluir o novo calculo de vcto
					// correspondente a esta parcelas, pois este novo calculo
					// nao pode ser efetivado.
					excluirVctoGeradoCorrespondenteAoVctoJaPago(listaVctosGerados, vctoGeradosAnteriormente);
				}
			}
		}
	}
	
	private void executarRemocaoVctoAntesDataAtualDaListaVctoAdicionarMatriculaPeriodo(List<MatriculaPeriodoVencimentoVO> listaVctosGerados, MatriculaPeriodoVO matriculaPeriodoVO, Double valorDiferencaValorCobrarComRelacaoValorJaPago) throws Exception {
		if(valorDiferencaValorCobrarComRelacaoValorJaPago > 0 && matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoRegerarParcelaVencida()){
			for (Iterator<MatriculaPeriodoVencimentoVO> iterator = listaVctosGerados.iterator(); iterator.hasNext();) {
				MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO = (MatriculaPeriodoVencimentoVO) iterator.next();
				if(matriculaPeriodoVencimentoVO.getDataVencimento().compareTo(new Date()) < 0 
						&& !Uteis.getData(matriculaPeriodoVencimentoVO.getDataVencimento()).equals(Uteis.getData(new Date()))
						&& matriculaPeriodoVencimentoVO.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade()){
					iterator.remove();
				}
			}			
		}
	}


	/*public void registrarParcelasGeradasParaFuturaGeracaoContasAReceber(List<MatriculaPeriodoVencimentoVO> listaVctosGerados, MatriculaPeriodoVO matriculaPeriodoVO, Double valorDiferencaValorCobrarComRelacaoValorJaPago) throws Exception {
		executarRemocaoVctoPagosOuImportadosSistemaLegadoDaListaVctoAdicionarMatriculaPeriodo(listaVctosGerados, matriculaPeriodoVO, null);
		Iterator i = listaVctosGerados.iterator();
		Boolean existeValorDiferencaAplicar = true;
		if (valorDiferencaValorCobrarComRelacaoValorJaPago == 0) {
			existeValorDiferencaAplicar = false;
		}
		String tipoCalculaAplicar = "Credito";

		if (valorDiferencaValorCobrarComRelacaoValorJaPago < 0) {
			// Retirar o sinal negativo do valor diferença, para que o mesmo
			// possa ser somado ao desconto atual já concedido
			// na parcela em questãoo
			valorDiferencaValorCobrarComRelacaoValorJaPago = (valorDiferencaValorCobrarComRelacaoValorJaPago * -1);
			// TODO Se a matrícula foi paga, e na condição de pagamento, deve
			// restituir o valor da diferença nas parcelas,
			// essa verificaï¿½ï¿½o ï¿½ feita nesse ponto.
			// SituacaoVencimentoMatriculaPeriodo situacaoMatriculaDesconto =
			// matriculaPeriodoVO.obterSituacaoParcelasReferenteMatricula();
			// if
			// (situacaoMatriculaDesconto.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)
			// &&
			// matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getRestituirDiferencaValorMatriculaSistemaPorCredito())
			// {
			// valorDiferencaValorCobrarComRelacaoValorJaPago =
			// valorDiferencaValorCobrarComRelacaoValorJaPago +
			// matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorDescontoDisciplinaExcluida();
			// }
			tipoCalculaAplicar = "Desconto";
			// } else {
			// SituacaoVencimentoMatriculaPeriodo situacaoMatriculaCredito =
			// matriculaPeriodoVO.obterSituacaoParcelasReferenteMatricula();
			// if
			// (situacaoMatriculaCredito.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)
			// &&
			// matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getRestituirDiferencaValorMatriculaSistemaPorCredito())
			// {
			// valorDiferencaValorCobrarComRelacaoValorJaPago =
			// valorDiferencaValorCobrarComRelacaoValorJaPago +
			// matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorFixoDisciplinaIncluida();
			// }
		}
		// TODO
		// boolean ratiarValorDescontoCreditoParaParcelas =
		// matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getRatiarValorDiferencaInclusaoExclusaoParaTodasParcelas();
		while (i.hasNext()) {
			MatriculaPeriodoVencimentoVO vctoGerados = (MatriculaPeriodoVencimentoVO) i.next();
			if (existeValorDiferencaAplicar) {
				if (tipoCalculaAplicar.equals("Credito")) {
					// Double valorDescontoDiferencaParaVcto =
					// Uteis.arrendondarForcando2CadasDecimais(valorDiferencaValorCobrarComRelacaoValorJaPago);

					// if (ratiarValorDescontoCreditoParaParcelas) {
					// valorDescontoDiferencaParaVcto =
					// (valorDiferencaValorCobrarComRelacaoValorJaPago /
					// listaVctosGerados.size());
					// vctoGerados.setValor(vctoGerados.getValor() +
					// valorDescontoDiferencaParaVcto);
					// vctoGerados.setDescricaoPagamento("Cobrança valor adicional (R$ "
					// +
					// Uteis.getDoubleFormatado(valorDescontoDiferencaParaVcto)
					// +
					// ") referente diferença parcelas anteriores pagas (inclusão/Exclusão disciplinas).");
					// } else {
					vctoGerados.setValor(vctoGerados.getValor() + valorDiferencaValorCobrarComRelacaoValorJaPago);
					// Existe uma diferença que precisa ser cobrada do aluno
					vctoGerados.setDescricaoPagamento("Cobrança valor adicional (R$ " + Uteis.getDoubleFormatado(valorDiferencaValorCobrarComRelacaoValorJaPago) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula.");
					existeValorDiferencaAplicar = Boolean.FALSE;
					// }
				} else {
					// Existe uma diferença que precisa ser dada como desconto
					// para o aluno.
					Double valorDescontoDiferencaParaVcto = Uteis.arrendondarForcando2CadasDecimais(valorDiferencaValorCobrarComRelacaoValorJaPago);
					Double valorFinalTituloAntesSomarValorDiferente = vctoGerados.getCalcularValorFinal();

					if (valorDescontoDiferencaParaVcto > valorFinalTituloAntesSomarValorDiferente) {
						// Se entrar aqui ï¿½ por que o valor de desconto a ser
						// dado para o titulo
						// ï¿½ maior que o préprio valor do tï¿½tulo. Logo o
						// desconto a ser dado
						// para o tï¿½tulo deve ser redefinido para o seu total
						// (valorFinalTituloAntesSomarValorDiferente)
						// e a diferença que restou deve permanecer na
						// variï¿½vel
						// valorDiferencaValorCobrarComRelacaoValorJaPago
						// para ser descontada em uma préxima parcela que esteja
						// em aberto.
						valorDescontoDiferencaParaVcto = valorFinalTituloAntesSomarValorDiferente;
						valorDiferencaValorCobrarComRelacaoValorJaPago = valorDiferencaValorCobrarComRelacaoValorJaPago - valorDescontoDiferencaParaVcto;
					} else {
						existeValorDiferencaAplicar = Boolean.FALSE;
					}
					vctoGerados.setDescricaoPagamento("Desconto valor (R$ " + Uteis.getDoubleFormatado(valorDescontoDiferencaParaVcto) + ") referente diferença parcelas anteriores pagas ou por operações de inclusão/exclusão disciplinas na matrícula.");
					vctoGerados.setValorDesconto(vctoGerados.getValorDesconto() + valorDescontoDiferencaParaVcto);
				}
			}

			vctoGerados.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);

			boolean existeParcela = false;
			for (MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO : matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()) {
				if (matriculaPeriodoVencimentoVO.getParcela().contains("/") && vctoGerados.getParcela().contains("/")) {
					if (matriculaPeriodoVencimentoVO.getParcela().substring(0, matriculaPeriodoVencimentoVO.getParcela().indexOf("/")).equals(vctoGerados.getParcela().substring(0, vctoGerados.getParcela().indexOf("/")))) {
						existeParcela = true;
						break;
					}
				} else {
					if (matriculaPeriodoVencimentoVO.getParcela().equals(vctoGerados.getParcela())) {
						existeParcela = true;
						break;
					}
				}
			}
			if (!existeParcela) {
				matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(vctoGerados);
			}

		}
	}*/

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void processarGeracao_AlteracaoParcelasMensalidades(SituacaoVencimentoMatriculaPeriodo situacaoMatricula, List<MatriculaPeriodoVencimentoVO> listaVctosGerados, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, Double valorDiferencaValorCobrarComRelacaoValorJaPago, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		SituacaoVencimentoMatriculaPeriodo situacaoParcelas = matriculaPeriodoVO.obterSituacaoParcelasReferenteMensalidades();
		if (situacaoParcelas.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA) || situacaoParcelas.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA)) {
			// Se entrarmos aqui ï¿½ por que nenhuma conta a receber foi gerada
			// para a matrícula, portanto temos
			// que avaliar, de acordo com a configuração se estas parcelas já
			// devem ser geradas ou não. De qualquer forma, chamamos o Método
			// excluirVencimentoNaoPagos
			// para garantir que no banco não teremos registros duplicados.
			// Como, poder ocorrer, se
			// tivermos, por exemplo, o registro de uma pré-matrícula, que não
			// gera contas a receber
			// mais gera registros na tabela MatriculaPeriodoVencimentoVO.
			// Registros estes que são
			// removidos pela rotina abaixo.
			excluirVencimentosEContasReceberGeradasParaParcelasNaoPagas(matriculaVO, matriculaPeriodoVO,  valorDiferencaValorCobrarComRelacaoValorJaPago < 0,  usuario);
			registrarParcelasGeradasAindaNaoPagas_ContabilizandoValorDiferencaCobrarComRelacaoValorPago(listaVctosGerados, matriculaVO, matriculaPeriodoVO,  valorDiferencaValorCobrarComRelacaoValorJaPago, configuracaoFinanceiro, false, usuario);
		} else if (situacaoParcelas.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA) || situacaoParcelas.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_E_PAGA_PARCIALMENTE)) {
				// Neste caso temos que uma ou mais parcelas já foram pagas.
				// Caso todas já tenham sido geradas e pagas, então não é possível mais realizar nenhum
				// intervencao  dos cálculos.
				if ((matriculaPeriodoVO.verificarTodasAsParcelasJaPagas()) && (executarVerificacaoTodasAsParcelasJaForamGeradas(matriculaPeriodoVO, listaVctosGerados))) {
					// throw new Exception("Todas as parcelas referentes a este Período letivo já foram pagas! Portanto, não ï¿½ mais possível alterar as parcelas ou dados financeiros da matrícula. As parcelas precisam ser alteradas manualmente (Conta a Receber).");
					if(!matriculaPeriodoVO.getPlanoFinanceiroCurso().getModeloGeracaoParcelas().equals("FC")){
						for(MatriculaPeriodoVencimentoVO vctoExcluir: matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()){
							getFacadeFactory().getContaReceberFacade().excluirContasReceberTipoOrigemCodigoOrigem("BCC", matriculaPeriodoVO.getCodigo(), "AR", vctoExcluir.getParcelaCusteadaConvenio(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNrParcelasPeriodo(),matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getQuantidadeParcelasMaterialDidatico().intValue()), !matriculaPeriodoVO.getBloqueioPorFechamentoMesLiberado(), usuario);						
						}
					}
					if(Uteis.arrendondarForcando2CadasDecimais(valorDiferencaValorCobrarComRelacaoValorJaPago) < 0){
						gerarContaPagarRestituirAlunoValorJaPagoParcelaEspecifica(new Date(), valorDiferencaValorCobrarComRelacaoValorJaPago*-1, matriculaPeriodoVO.getMatriculaVO(), matriculaPeriodoVO, configuracaoFinanceiro, usuario);
					}else{
						registrarParcelasGeradasAindaNaoPagas_ContabilizandoValorDiferencaCobrarComRelacaoValorPago(listaVctosGerados, matriculaVO, matriculaPeriodoVO,  valorDiferencaValorCobrarComRelacaoValorJaPago, configuracaoFinanceiro, false, usuario);
					}
				} else {
					excluirVencimentosEContasReceberGeradasParaParcelasNaoPagas(matriculaVO, matriculaPeriodoVO, valorDiferencaValorCobrarComRelacaoValorJaPago < 0, usuario);
					registrarParcelasGeradasAindaNaoPagas_ContabilizandoValorDiferencaCobrarComRelacaoValorPago(listaVctosGerados,  matriculaVO, matriculaPeriodoVO,  valorDiferencaValorCobrarComRelacaoValorJaPago, configuracaoFinanceiro, false, usuario);
				}			
		}
	}
	

	/**
	 * Método Responsável
	 * 
	 * @param matriculaPeriodoVO
	 * @param valorDiferencaValorCobrarComRelacaoValorJaPago
	 * @throws Exception
	 */
	public void executarGeracaoParcelaExtra(MatriculaPeriodoVO matriculaPeriodoVO, Double valorDiferencaValorCobrarComRelacaoValorJaPago, UsuarioVO usuario) throws Exception {
		if (valorDiferencaValorCobrarComRelacaoValorJaPago != 0 && valorDiferencaValorCobrarComRelacaoValorJaPago > 0) {
			Integer nrParcelas = getFacadeFactory().getContaReceberFacade().consultarQuantidadeContasRecebidasPorMatricula(matriculaPeriodoVO.getMatricula());
			Integer nrMensalidade = nrParcelas;
			String parcela = "EX";
			if (matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOsExtras().size() > 0) {
				parcela = "EX" + matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOsExtras().size();
			}
			Date dataVencimento = montarDataVencimento(nrMensalidade, matriculaPeriodoVO, usuario);
			MatriculaPeriodoVencimentoVO vctoVO = realizarGeraracaoVencimentoParcelaInclusaoDisciplinaTodasParcelasJaPagas(matriculaPeriodoVO, dataVencimento, valorDiferencaValorCobrarComRelacaoValorJaPago, parcela, true);
			matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(vctoVO);
			MatriculaPeriodoVencimentoVO vctoVORegeracao = new MatriculaPeriodoVencimentoVO();
			vctoVORegeracao.setParcela(parcela);
			vctoVORegeracao.setTipoOrigemMatriculaPeriodoVencimento(TipoOrigemContaReceber.MENSALIDADE);
			matriculaPeriodoVO.getListaParcelasGeradasManualmenteAnteriormenteAptasParaRegeracao().add(vctoVORegeracao);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private MatriculaPeriodoVencimentoVO realizarGeraracaoVencimentoParcelaInclusaoDisciplinaTodasParcelasJaPagas(MatriculaPeriodoVO matriculaPeriodoVO, Date dataVctoMatricula, Double valorVcto, String parcela, Boolean parcelaExtra) throws Exception {
		MatriculaPeriodoVencimentoVO vctoVO = new MatriculaPeriodoVencimentoVO();
		vctoVO.setValor(valorVcto);

		// Nesse momento, pegamos a diferença de dias entre a data de vencimento
		// final da mensalidade e o dia setado
		// no calendï¿½rio do processo de matrícula. Essa diferença será
		// importante para calcularmos a data verdadeira do
		// desconto progressivo a apresentar no boleto.
		Integer diasVariacaoDataVencimento = 0;
		if (!matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getMesDataBaseGeracaoParcelas()) {
			diasVariacaoDataVencimento = matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDiaVencimentoPrimeiraMensalidade() - Uteis.getDiaMesData(dataVctoMatricula);
			if (diasVariacaoDataVencimento < 0) {
				diasVariacaoDataVencimento = 0;
			}
		} else {
			diasVariacaoDataVencimento = Uteis.getDiaMesData(dataVctoMatricula) - Uteis.getDiaMesData(dataVctoMatricula);
			if (diasVariacaoDataVencimento < 0) {
				diasVariacaoDataVencimento = 0;
			}
		}
		vctoVO.setDiasVariacaoDataVencimento(diasVariacaoDataVencimento);

		vctoVO.setParcela(parcela);
		vctoVO.setDataVencimento(dataVctoMatricula);
		vctoVO.setData(new Date());
		vctoVO.setMatriculaPeriodo(matriculaPeriodoVO.getCodigo());
		vctoVO.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);
		vctoVO.setVencimentoExtraCobrancaValorDiferencaInclusaoDisciplina(parcelaExtra);
		return vctoVO;
	}

	public Boolean executarVerificacaoTodasAsParcelasJaForamGeradas(MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoVencimentoVO> listaVctosGerados) {
		int nrParcelasExistentes = 0;
		for (MatriculaPeriodoVencimentoVO mpExistente : matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()) {
			if(!mpExistente.getVencimentoReferenteMatricula()){
				nrParcelasExistentes++;
			}
		}
		return nrParcelasExistentes >= listaVctosGerados.size();
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public SituacaoVencimentoMatriculaPeriodo processarGeracao_AlteracaoParcelaVencimentoMatricula(MatriculaPeriodoVencimentoVO parcelaMatricula, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		SituacaoVencimentoMatriculaPeriodo situacaoMatricula = matriculaPeriodoVO.obterSituacaoParcelasReferenteMatricula();
		if (!parcelaMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA)) {
			parcelaMatricula.setSituacao(situacaoMatricula);
		}
		if ((situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA) && !parcelaMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA))
				|| (situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA) && parcelaMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA))) {
			// Se a matricula nao foi gerada entao temos que gerar a parcela de
			// matrícula, para que o
			// aluno possa emitir o boleto e pagar o valor correspondente. Aqui
			// temos que avaliar duas
			// situaï¿½ï¿½es. Primeiro temos que verificar se alguï¿½m não
			// liberou o
			// pagamento da matrícula.
			// em caso positivo não existe razï¿½o para geração da conta a
			// receber
			// correspondente e
			// a matrícula pode ser considerada como quitada. Segundo, temos que
			// verificar se este
			// aluno já não realizou uma pré-metricula. Caso o mesmo tenha
			// realizada esta pré-matrícula
			// o valor pago na mesma deverï¿½ ser abatido do valor da matrícula
			// definitiva. Podendo
			// gerar um novo valor a ser pago, ou um resóduo de descontos para
			// serem distribuï¿½dos nas demais
			// parcelas.
			matriculaPeriodoVO.adicionarHistoricoOperacao("Nova conta a receber referente à matrícula gerada - " + parcelaMatricula.getDescricaoVencimentoVOParaHistorico(), matriculaPeriodoVO.getDataProcessamentoAtual());
			/*if (matriculaPeriodoVO.verificarExistePreMatriculaParaPeriodo()) {
				// gerarDescontosMatriculaProvenientePreMatriculaJaRealizada(matriculaVO,
				// matriculaPeriodoVO, parcelaMatricula);
			}*/
			matriculaPeriodoVO.excluirMatriculaPeriodoVencimentoVOPorIdentificador("MA");
			gerarContaReceberComBaseParcelaMatricula(matriculaVO, matriculaPeriodoVO, parcelaMatricula, configuracaoFinanceiro, usuario);
		}else if ((situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA)) && (!parcelaMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA))) {
			// Se entrar aqui ï¿½ por que a conta a receber da matricula foi
			// gerada mais nao foi paga.
			// Assim, caso nenhuma das mensalidades, pertinentes a esta
			// matriculaperiodo, tenha sido
			// paga, significa que podemos apagar o financeiro gerado até o
			// momento e gerar estes dados
			// novamente. Considerando as alterações financeiras realizadas.
			if (matriculaPeriodoVO.verificarExisteAlgumaParcelaPagaMatriculaPeriodo()) {
				// Este erro eh necessario quando ocorre do aluno pagar uma
				// parcela sem ter pago a matrícula primeiro.
				// O que nao pode ocorrer. Assim, o usuário sera aconselhado a
				// estornar o pagamento da parcela, dar baixa na matricula
				// para depois proceder a alteração.
				throw new Exception("já existem parcelas pagas, contudo, a taxa de matrícula não estão quitada. Portanto para realizar " + "alterações nesta matrícula será necessário quitar a taxa de matrícula ou estornar o valor " + " pago das parcelas para prosseguir com alteração.");
			}
			if(!matriculaPeriodoVO.getPlanoFinanceiroCurso().getModeloGeracaoParcelas().equals("FC")){
				excluirTodosVencimentosEContasReceberGeradasMatriculaEParcelas(matriculaVO, matriculaPeriodoVO, usuario);	
			}else {
				getFacadeFactory().getMatriculaPeriodoVencimentoFacade().excluirSemCommitVctoMatricula(matriculaPeriodoVO, usuario);
			}
			/*if (matriculaPeriodoVO.verificarExistePreMatriculaParaPeriodo()) {
				// gerarDescontosMatriculaProvenientePreMatriculaJaRealizada(matriculaVO,
				// matriculaPeriodoVO, parcelaMatricula);
			}*/
			if (!parcelaMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA)) {
				gerarContaReceberComBaseParcelaMatricula(matriculaVO, matriculaPeriodoVO, parcelaMatricula, configuracaoFinanceiro, usuario);
			} else {
				matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(parcelaMatricula);
			}
		}else if ((situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) && (parcelaMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA))) {
			// Neste caso temos um problema que o sistema não irá gerenciar pelo
			// grau de dificuldade envolvida,
			// por levar ao sistema a tratar uma exceï¿½ï¿½o que poderia tornar
			// a
			// rotina instï¿½vel.
			// Desta maneira, caso o aluno tenha sido matrículado e parcela da
			// matrícula esta como paga, então o
			// o sistema não irá mais aceitar que o plano financeiro seja
			// alterado para uma condição do tipo,
			// MATRICULA_NAO_DEVE_SER_GERADA.
			throw new Exception("Este aluno está com a taxa de matrícula paga. Portanto, o PLANO FINANCEIRO não pode ser alterado " + "de forma que a Taxa de Matrícula não seja mais controlada (cobrada). " + "Para realizar esta alteração o pagamento da matrícula deve ser primeirmanete estornado.");
		}else if (situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA) && (!parcelaMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA))) {
			criarContaReceberBolsaCusteadaMatricula(matriculaVO, matriculaPeriodoVO, matriculaPeriodoVO.getProcessoMatriculaCalendarioVO(), configuracaoFinanceiro, parcelaMatricula, null, usuario);
		}else if ((situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA) || situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA)) && parcelaMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA)) {
			getFacadeFactory().getMatriculaPeriodoVencimentoFacade().excluirSemCommitVctoMatricula(matriculaPeriodoVO, usuario);
			matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(parcelaMatricula);
		}
		return situacaoMatricula;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void inicializarDadosParaProcessarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, UsuarioVO usuario, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		if ((matriculaPeriodoVO.getConfiguracaoFinanceiro() == null) || (matriculaPeriodoVO.getConfiguracaoFinanceiro().getCodigo() == 0)) {
			// ConfiguracaoFinanceiroVO configuracaoFinanceiro =
			// getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_DADOSBASICOS,
			// usuario, null);
			matriculaPeriodoVO.setConfiguracaoFinanceiro(configuracaoFinanceiroVO);
		}

		if (processoMatriculaCalendarioVO == null || processoMatriculaCalendarioVO.getCursoVO() == null || processoMatriculaCalendarioVO.getCursoVO().getCodigo() == 0) {
			montarDadosProcessoMatriculaCalendarioVO(matriculaVO, matriculaPeriodoVO, Uteis.NIVELMONTARDADOS_TODOS, usuario);
			// matriculaPeriodoVO.setProcessoMatriculaCalendarioVO(processoMatriculaCalendarioVO);
			processoMatriculaCalendarioVO = matriculaPeriodoVO.getProcessoMatriculaCalendarioVO();
		}
	}

	public boolean mesReferenciaJaRegerado(MatriculaPeriodoVencimentoVO parcelaRegerar, List<MatriculaPeriodoVencimentoVO> mesReferenciaJaRegerados) {
		for (MatriculaPeriodoVencimentoVO mesJaRegerado : mesReferenciaJaRegerados) {
			if (parcelaRegerar.getTipoOrigemMatriculaPeriodoVencimento().equals(mesJaRegerado.getTipoOrigemMatriculaPeriodoVencimento())
					&& parcelaRegerar.getParcela().equals(mesJaRegerado.getParcela()) ) {
				return true;
			}
		}
		return false;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void regerarParcelasQueJaHaviamSidoPreviamenteGeradasMasForamApagasPelaRotinaDeGerenciamentoDeParcelas(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, ConfiguracaoFinanceiroVO configuracaoFinanceira, UsuarioVO usuario) throws Exception {
		Iterator i = matriculaPeriodoVO.getListaParcelasGeradasManualmenteAnteriormenteAptasParaRegeracao().iterator();
		List<MatriculaPeriodoVencimentoVO> mesReferenciaJaRegerados = new ArrayList<MatriculaPeriodoVencimentoVO>(1);
		while (i.hasNext()) {
			MatriculaPeriodoVencimentoVO parcelaRegerar = (MatriculaPeriodoVencimentoVO) i.next();
			if (!mesReferenciaJaRegerado(parcelaRegerar, mesReferenciaJaRegerados)) {
				mesReferenciaJaRegerados.add(parcelaRegerar);
				gerarContasReceberComBaseParcelaMesAnoEspecifico(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, parcelaRegerar, configuracaoFinanceira, usuario, false);
			}
		}
	}

	/**
	 * Rotina reponsóvel por gerar as conta a receber relativas aos vencimentos
	 * (parcelas) provenientes, de uma matrícula em um Período letivo. Ela
	 * trabalha de acordo com a configuração definida no PlanoFinanceiroCursoVO
	 * - modelo de geração de parcelas. Existem trï¿½s modelos de geração de
	 * parcelas. - "AM", "Gerar Todas as Parcelas no Ato da Matrícula" - "VC",
	 * "Gerar as Parcelas somente apï¿½s o Pagto da Matrícula" - "FC",
	 * "Gerar as Parcelas Mï¿½s a Mï¿½s" Caso, a opção seja gerar mes a mes,
	 * esta rotina trabalha com o conceito de gerar a conta a receber de uma
	 * ï¿½nica parcela, considerando um mï¿½s/ano de referï¿½ncia.
	 * 
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @param processoMatriculaCalendarioVO
	 * @param mesAnoReferenciaGerar
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void processarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, MatriculaPeriodoVencimentoVO  mesAnoReferenciaGerar, SituacaoVencimentoMatriculaPeriodo situacaoMatriculaAtualizada, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, Boolean simulacao) throws Exception {
		if (matriculaVO.getMatriculaIndeferida()  || matriculaPeriodoVO.getFinanceiroManual()) {
			// neste caso não podemos gerar nada no financeiro, ou por que a
			// mesma ainda não
			// liberada, ou por que a mesma foi indeferida.
			return;
		}
		// if (matriculaPeriodoVO.isSituacaoPreMatricula()) {
		// neste caso não podemos gerar nada no financeiro relativo as parcelas,
		// pois a matrícula ainda não foi efetivada. Somente apï¿½s a Ativação
		// da
		// matrícula,
		// que estão rotina será acionada com intuito de gerar as parcelas
		// restantes e
		// permitir o pagamento das mesmas.
		// return;
		// }
		inicializarDadosParaProcessarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, usuario, configuracaoFinanceiro);
		matriculaPeriodoVO.setPlanoFinanceiroCurso(getFacadeFactory().getPlanoFinanceiroCursoFacade().consultarModeloGeracaoPorChavePrimaria(matriculaPeriodoVO.getPlanoFinanceiroCurso().getCodigo()));
		String modeloGeracaoParcelas = matriculaPeriodoVO.getPlanoFinanceiroCurso().getModeloGeracaoParcelas();
		// "AM", "Gerar Todas as Parcelas no Ato da Matrícula");
		// "VC", "Gerar as Parcelas somente apos o Pagto da Matrícula");
		// "FC", "Gerar as Parcelas Mes a Ms");
		SituacaoVencimentoMatriculaPeriodo situacaoMatricula = situacaoMatriculaAtualizada;
		if (situacaoMatricula == null) {
			boolean existeParcelaReferenteMatricula = matriculaPeriodoVO.getIsExisteParcelasReferenteMatricula();
			if (!existeParcelaReferenteMatricula) {
				MatriculaPeriodoVencimentoVO vctoMatricula = getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarPorMatriculaPeriodoParcela(matriculaPeriodoVO.getCodigo(), "MA", Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiro, usuario);
				if (vctoMatricula != null) {
					matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(vctoMatricula);
				}
			}
			situacaoMatricula = matriculaPeriodoVO.obterSituacaoParcelasReferenteMatricula();
		}
		SituacaoVencimentoMatriculaPeriodo situacaoParcelasMensalidade = matriculaPeriodoVO.obterSituacaoParcelasReferenteMensalidades();
		processarGeracaoContasReceberMatriculaPeriodoParcelas(situacaoParcelasMensalidade, matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, situacaoMatricula, modeloGeracaoParcelas, mesAnoReferenciaGerar, configuracaoFinanceiro, usuario, simulacao);
		

	}
	
	private void processarGeracaoContasReceberMatriculaPeriodoParcelas(SituacaoVencimentoMatriculaPeriodo situacaoParcelasMensalidade, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, SituacaoVencimentoMatriculaPeriodo situacaoMatricula , String modeloGeracaoParcelas, MatriculaPeriodoVencimentoVO  mesAnoReferenciaGerar, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, Boolean simulacao) throws Exception{
		// Se a situação da MatriculaPeriodoVencimento for
				// CONTARECEBER_GERADA_E_PAGA_PARCIALMENTE, então, as parcelas
				// que não existem, deve ser geradas nesse momento.
				if (situacaoParcelasMensalidade.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_E_PAGA_PARCIALMENTE)) {
					gerarContasReceberComBaseParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, configuracaoFinanceiro, usuario, simulacao);
				}

				if ((modeloGeracaoParcelas.equals("AM")) && (!situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA)) && (situacaoParcelasMensalidade.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA))) {
					// AM - Gerar todas as parcelas no ato da matricula - neste caso
					// caso a conta recebere referente a matrícula já
					// esteja gerada ou mesmo que a nao seja controlado o valor da
					// matrícula, as parcelas referentes a conta a receber
					// devem ser geradas.
					gerarContasReceberComBaseParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, configuracaoFinanceiro, usuario, simulacao);
				}
				if ((modeloGeracaoParcelas.equals("AM")) && (!situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA)) && matriculaPeriodoVO.getFinanceiroManual()) {
					gerarContasReceberComBaseParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, configuracaoFinanceiro, usuario, simulacao);
				}
				if ((modeloGeracaoParcelas.equals("VC")) && ((situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) || (situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA)) || (situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA_EDITADA_MANUALMENTE) || situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA)))) {
					// "VC", "Gerar as Parcelas somente apï¿½s o Pagto da Matrícula");
					// Neste caso, caso a conta a receber referente a matrícula ja
					// esteja paga ou caso
					// caso a taxa de matrícula nao seja controlada (o que podemos
					// subentender que a mesma já estão paga)
					// as parcelas referentes as parcelas devem ser geradas.
					if ((matriculaPeriodoVO.existemParcelasReferenteMensalidadesParaSeremGeradas()) && (getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarExisteMatriculaPeriodoVencimentoPorMatriculaPeriodoSituacao(matriculaPeriodoVO.getCodigo(), "NG", false, usuario))) {
						gerarContasReceberComBaseParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, configuracaoFinanceiro, usuario, simulacao);
					}
				}
				if (modeloGeracaoParcelas.equals("FC")) {
					if (mesAnoReferenciaGerar == null || mesAnoReferenciaGerar.getParcela() == null) {
						// neste caso não fazemos nada, pois a rotina não determinou
						// qual parcela, de qual mês, deve ser gerada. Caso deseje-se que
						// uma parcela seja gerada, este necessário deve ser
						// obrigatoriamente informado.
						regerarParcelasQueJaHaviamSidoPreviamenteGeradasMasForamApagasPelaRotinaDeGerenciamentoDeParcelas(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, configuracaoFinanceiro, usuario);
						List<ContaReceberVO> contaReceberVOs = new ArrayList<ContaReceberVO>(0);
						for(MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO:matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()){
							if(matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA)){
								contaReceberVOs.add(matriculaPeriodoVencimentoVO.getContaReceber());
							}
						}
						if(!contaReceberVOs.isEmpty() && !simulacao){
							getFacadeFactory().getContaReceberFacade().realizarProcessamentoValorFinalContaReceberAtualizadoComAcrescimosEDescontos(null, contaReceberVOs, true, "", true, usuario, true , false , null , null, true);
						}
						return;
					} else if (mesAnoReferenciaGerar.getParcela().equals("/")) {
						gerarContasReceberComBaseParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, configuracaoFinanceiro, usuario, simulacao);
					} else {
						gerarContasReceberComBaseParcelaMesAnoEspecifico(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, mesAnoReferenciaGerar, configuracaoFinanceiro, usuario, simulacao);
					}
				}
				
				if ((situacaoParcelasMensalidade.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) && !matriculaPeriodoVO.getFinanceiroManual()) {
					gerarContasReceberParceiroComBaseParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, configuracaoFinanceiro, usuario, simulacao);
				}
				List<ContaReceberVO> contaReceberVOs = new ArrayList<ContaReceberVO>(0);
				for(MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO:matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()){
					if(matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA)){
						if(matriculaPeriodoVO.getBloqueioPorFechamentoMesLiberado()) {
							matriculaPeriodoVencimentoVO.getContaReceber().liberarVerificacaoBloqueioFechamentoMes();
						}
						contaReceberVOs.add(matriculaPeriodoVencimentoVO.getContaReceber());
					}
				}
				if(!contaReceberVOs.isEmpty() && !simulacao){					
					getFacadeFactory().getContaReceberFacade().realizarProcessamentoValorFinalContaReceberAtualizadoComAcrescimosEDescontos(null, contaReceberVOs, false, "", true, usuario, true , false , null , null, true);
				}
	}

	/*@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void criarContaReceberMensalidade(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO parcelaMensalidade, UsuarioVO usuario, Boolean simulacao) throws Exception {
		criarContaReceberMensalidade(matriculaVO, matriculaPeriodoVO, parcelaMensalidade, usuario, null, simulacao);
	}*/

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void criarContaReceberMensalidade(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO parcelaMensalidade, UsuarioVO usuario, ConfiguracaoFinanceiroVO configuracaoFinanceiro, Boolean simulacao) throws Exception {
		matriculaVO.getUnidadeEnsino().setNivelMontarDados(NivelMontarDados.NAO_INICIALIZADO);
		
		if(parcelaMensalidade.getTipoOrigemMatriculaPeriodoVencimento().isMaterialDidatico() && Uteis.isAtributoPreenchido(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getUnidadeEnsinoFinanceira())){
			matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getUnidadeEnsinoFinanceira().setNivelMontarDados(NivelMontarDados.NAO_INICIALIZADO);
			getFacadeFactory().getUnidadeEnsinoFacade().carregarDados(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getUnidadeEnsinoFinanceira(), NivelMontarDados.BASICO, usuario);
			configuracaoFinanceiro = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario, matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getUnidadeEnsinoFinanceira().getCodigo());
			
		}
		if (configuracaoFinanceiro == null) {
			if (matriculaPeriodoVO.getConfiguracaoFinanceiro().getIsNivelMontarDadosTodos()) {
				configuracaoFinanceiro = matriculaPeriodoVO.getConfiguracaoFinanceiro();
			} else {
				configuracaoFinanceiro = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario, matriculaVO.getUnidadeEnsino().getCodigo());
			}
		}
		getFacadeFactory().getUnidadeEnsinoFacade().carregarDados(matriculaVO.getUnidadeEnsino(), NivelMontarDados.BASICO, usuario);
		if(!Uteis.isAtributoPreenchido(matriculaPeriodoVO.getTurma().getContaCorrente())) {
			matriculaPeriodoVO.getTurma().setContaCorrente(getFacadeFactory().getContaCorrenteFacade().consultarContaCorrentePorTurma(matriculaPeriodoVO.getTurma().getCodigo(), Uteis.NIVELMONTARDADOS_COMBOBOX , usuario));
		}
		ContaReceberVO obj1 = matriculaPeriodoVO.criarContaReceberMensalidadeBaseadoMatriculaPeriodoVencimento(matriculaVO, matriculaPeriodoVO, parcelaMensalidade, configuracaoFinanceiro, true, usuario);
		obj1.setContaCorrenteVO(getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(obj1.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
		obj1.setEmissaoBloqueada(getFacadeFactory().getContaReceberFacade().verificaBloqueioEmissaoBoleto(obj1, usuario));
		alterarSituacaoContaReceberMatriculaMatriculaPeriodoDependendoDescontos(obj1, matriculaPeriodoVO, matriculaVO.getMatricula(), parcelaMensalidade);
		/**
		 * Adicionada regra que verifica se a conta receber já foi gerada, caso
		 * ocorra retorna uma excessão informando ao usuário.
		 */
		boolean contaReceberGerada = getFacadeFactory().getContaReceberFacade().executarVerificarContaReceberGerada(obj1.getCodOrigem(), obj1.getTipoOrigem(), obj1.getParcela(), obj1.getPessoa().getCodigo(), usuario);
		if (contaReceberGerada) {
			throw new Exception(UteisJSF.internacionalizar("msg_contareCeber_dadosDuplicados").replace("{0}", obj1.getParcela()));
		}
		 if(!parcelaMensalidade.getParcela().contains("EX") && 
			!parcelaMensalidade.isUsaValorPrimeiraParcela() &&
	        		(parcelaMensalidade.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade() || 
	        		(parcelaMensalidade.getTipoOrigemMatriculaPeriodoVencimento().isMaterialDidatico() && matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isAplicarDescontoMaterialDidaticoDescontoProgressivo()))
	           ){
			Integer descontoProgressivoAluno = verificarSeContaASerGeradaPossuiConvenioComDescontoDeAntecipacaoAluno(matriculaVO, "Mensalidade");
			if (descontoProgressivoAluno != 0) {
				obj1.getDescontoProgressivo().setCodigo(descontoProgressivoAluno);
				matriculaVO.getPlanoFinanceiroAluno().getDescontoProgressivo().setCodigo(descontoProgressivoAluno);
			}

			if (!matriculaVO.getPlanoFinanceiroAluno().getDescontoProgressivoPrimeiraParcela().getCodigo().equals(0) 
					&& !matriculaVO.getPlanoFinanceiroAluno().getDescontoProgressivoPrimeiraParcela().getCodigo().equals(matriculaVO.getPlanoFinanceiroAluno().getDescontoProgressivo().getCodigo()) 
					&& obj1.getParcela().matches("0?1/(.*)")) {
				obj1.setDescontoProgressivo(matriculaVO.getPlanoFinanceiroAluno().getDescontoProgressivoPrimeiraParcela());
			}
		}
		obj1.setConfiguracaoFinanceiro(configuracaoFinanceiro);
		if (!obj1.getSituacaoEQuitada()) {
			obj1.atualizarSituacaoContaReceberDeAcordoComDescontos(configuracaoFinanceiro, matriculaPeriodoVO.getData(), usuario);
			
		}
		if (!simulacao) {
			if (obj1.getSituacao().equals(SituacaoContaReceber.RECEBIDO.getValor())) {
				obj1.setRealizandoRecebimento(true);
			}
			getFacadeFactory().getContaReceberFacade().incluir(obj1, false, configuracaoFinanceiro, usuario);
		}		
		parcelaMensalidade.setContaReceber(obj1);
		if (obj1.getSituacao().equals(SituacaoContaReceber.RECEBIDO.getValor()) && !simulacao) {
			parcelaMensalidade.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA);
			getFacadeFactory().getContaReceberFacade().baixarContaReceberVOConcedendoDescontoTotalAMesma(parcelaMensalidade.getContaReceber(), matriculaPeriodoVO.getData(), "Desconto 100% na parcela.", false, usuario, configuracaoFinanceiro, usuario);
		} else {
			parcelaMensalidade.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA);
		}
		if (!simulacao) {
			getFacadeFactory().getMatriculaPeriodoVencimentoFacade().alterar(parcelaMensalidade, true, usuario);
		}
		obj1 = null;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void gerarContasReceberComBaseParcelaMesAnoEspecifico(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, MatriculaPeriodoVencimentoVO parcelaRegerar, ConfiguracaoFinanceiroVO configuracaoFinanceira, UsuarioVO usuario, Boolean simulacao) throws Exception {
		Iterator i = matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().iterator();
		while (i.hasNext()) {
			MatriculaPeriodoVencimentoVO vctoGerar = (MatriculaPeriodoVencimentoVO) i.next();
			if ((!vctoGerar.getVencimentoReferenteMatricula()) && (!vctoGerar.getParcela().contains("EX")) && (vctoGerar.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA)) && (vctoGerar.verificarDataVctoCorrespondeteMesAnoReferenciaGerar(parcelaRegerar))) {
				criarContaReceberMensalidade(matriculaVO, matriculaPeriodoVO, vctoGerar, usuario, configuracaoFinanceira, simulacao);
				if (!vctoGerar.isUsaValorPrimeiraParcela() ) {
					criarContaReceberNaoPagasBolsaCusteadaMensalidades(matriculaVO, matriculaPeriodoVO, configuracaoFinanceira, vctoGerar, usuario, simulacao);
				}
			}
			// Criado pelo Carlos em 04.04.2011
			// Cria uma conta receber caso haja uma parcela Extra para ser
			// criada, com a situacao ainda não gerada.
			// Regra válida somente para parcelas extra.
			if ((vctoGerar.getParcela().contains("EX")) && (vctoGerar.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA))) {
				criarContaReceberMensalidade(matriculaVO, matriculaPeriodoVO, vctoGerar, usuario, configuracaoFinanceira, simulacao);
			}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerarContasReceberComBaseParcelasMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, Boolean simulacao) throws Exception {
		Iterator i = matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().iterator();
		while (i.hasNext()) {
			MatriculaPeriodoVencimentoVO vctoGerar = (MatriculaPeriodoVencimentoVO) i.next();
			if ((!vctoGerar.getVencimentoReferenteMatricula()) && (vctoGerar.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA))) {
				criarContaReceberMensalidade(matriculaVO, matriculaPeriodoVO, vctoGerar, usuario, configuracaoFinanceiro, simulacao);
				if (!matriculaPeriodoVO.getFinanceiroManual() && !vctoGerar.isUsaValorPrimeiraParcela() &&  !vctoGerar.getParcela().contains("EX")) {
					criarContaReceberNaoPagasBolsaCusteadaMensalidades(matriculaVO, matriculaPeriodoVO, configuracaoFinanceiro, vctoGerar, usuario, simulacao);
				}
			} else if (!vctoGerar.getVencimentoReferenteMatricula() && !vctoGerar.isUsaValorPrimeiraParcela() && !(vctoGerar.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA)) && !vctoGerar.isUsaValorPrimeiraParcela() && !vctoGerar.getParcela().contains("EX")) {
					criarContaReceberNaoPagasBolsaCusteadaMensalidades(matriculaVO, matriculaPeriodoVO, configuracaoFinanceiro, vctoGerar, usuario, simulacao);					
			}			
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerarContasReceberParceiroComBaseParcelasMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, Boolean simulacao) throws Exception {
		Iterator i = matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().iterator();
		while (i.hasNext()) {
			MatriculaPeriodoVencimentoVO vctoGerar = (MatriculaPeriodoVencimentoVO) i.next();
			if (!vctoGerar.getVencimentoReferenteMatricula() && !matriculaPeriodoVO.getFinanceiroManual()&& !vctoGerar.isUsaValorPrimeiraParcela() ) {
				criarContaReceberNaoPagasBolsaCusteadaMensalidades(matriculaVO, matriculaPeriodoVO, configuracaoFinanceiro, vctoGerar, usuario, simulacao);
			} 
		}
	}

	/**
	 * Rotina reponsavel somente para alterar a situacao financeira do
	 * MatriculaPeriodoVO, quando a condicao do plano financeiro utilizado
	 * determinar que a taxa de matricula nao deve ser controlada. Ou seja,
	 * quando a mesma nao for contralada a situacao da matricula devera cair
	 * como confirmada, e nao como pendente financeiramente.
	 * 
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarSituacaoFinanceiraMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro,UsuarioVO usuarioVO) throws Exception {
		SituacaoVencimentoMatriculaPeriodo situacaoMatricula = matriculaPeriodoVO.obterSituacaoParcelasReferenteMatricula();
		if (situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA) && configuracaoFinanceiro.getConfirmarMatricPendFinanCasoNaoControleMatricula().booleanValue()) {
			   if( matriculaPeriodoVO.getSituacao().equals("PF"))	{
				   alterarSituacaoFinanceiraMatriculaPeriodo(matriculaPeriodoVO.getCodigo(), "AT");
					matriculaPeriodoVO.setSituacao("AT");
					matriculaPeriodoVO.setSituacaoMatriculaPeriodo("AT");
					matriculaPeriodoVO.setUsuarioResponsavelConfirmacaoOuCancelamentoPreMatricula(usuarioVO.getCodigo());
					alterarSituacaoMatriculaPeriodo(matriculaPeriodoVO ,usuarioVO);
			   }				
				
			
		} else if (situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA) && !configuracaoFinanceiro.getConfirmarMatricPendFinanCasoNaoControleMatricula().booleanValue() && configuracaoFinanceiro.getAtivarPreMatriculaAutomaticamenteAposPagamentoTaxaMatricula().booleanValue() ) {
			matriculaPeriodoVO.setSituacao("PF");		
			if(realizarValidacaoRegraAtivacaoMatriculaPorEntregaDocumentoEContratoMatricula(matriculaVO.getMatricula(),usuarioVO).booleanValue()) {				  
					alterarSituacaoFinanceiraMatriculaPeriodo(matriculaPeriodoVO.getCodigo(), "AT");
					matriculaPeriodoVO.setSituacao("AT");
					matriculaPeriodoVO.setSituacaoMatriculaPeriodo("AT");
					matriculaPeriodoVO.setUsuarioResponsavelConfirmacaoOuCancelamentoPreMatricula(usuarioVO.getCodigo());
					alterarSituacaoMatriculaPeriodo(matriculaPeriodoVO, usuarioVO);		    					
				return;	
				  
			  }
			  matriculaPeriodoVO.setSituacao("CO");
			  alterarSituacaoFinanceiraMatriculaPeriodo(matriculaPeriodoVO.getCodigo(), "CO");
			 
		
		} else if (situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) {
			if (matriculaPeriodoVO.getSituacao().equals("PF")) {
				alterarSituacaoFinanceiraMatriculaPeriodo(matriculaPeriodoVO.getCodigo(), "AT");
				matriculaPeriodoVO.setSituacao("AT");
			}
			if (matriculaPeriodoVO.getSituacaoMatriculaPeriodo().equals("PR") && configuracaoFinanceiro.getAtivarPreMatriculaAutomaticamenteAposPagamentoTaxaMatricula().booleanValue()) {
				matriculaPeriodoVO.setSituacaoMatriculaPeriodo("AT");
				matriculaPeriodoVO.setUsuarioResponsavelConfirmacaoOuCancelamentoPreMatricula(usuarioVO.getCodigo());
				alterarSituacaoMatriculaPeriodo(matriculaPeriodoVO,usuarioVO);

			}
		} else if ((!situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) && (!situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_DEVE_SER_GERADA)) && (!situacaoMatricula.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA))) {
			alterarSituacaoFinanceiraMatriculaPeriodo(matriculaPeriodoVO.getCodigo(), "CO");
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Boolean  validarMatriculaPodeSerAtivadaPrematriculaAposEntregaDocumentosObrigatorios(String matricula,UsuarioVO usuarioVO) throws Exception {	     
	   return getFacadeFactory().getDocumetacaoMatriculaFacade().verificarAlunoEntregouTodosDocumentosQueSuspendeMatriculaParaAtivacaoMatricula(matricula);
			
	}
	
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Boolean  validarMatriculaPodeSerAtivadaAposAssinaturaContratoMatricula(String matriculaAluno ,UsuarioVO usuarioVO) throws Exception {	     
	   return getFacadeFactory().getDocumentoAssinadoFacade().verificarAlunoAssinouContratoMatriculaParaAtivacaoMatricula(matriculaAluno);		
	}

	/**
	 * Rotina Responsável por gerar/alterar as parcelas pertinentes a matrícula
	 * Período. Esta rotina avalia a situação da matrícula Período e com base
	 * nesta informação gera as parcelas pertinentes. Tanto a parcela pertinente
	 * ao pagamento da matrícula, quanto as parcelas referentes as mensalidades.
	 * Ela também processa valores já pagos pelo aluno em uma possível
	 * pré-matrícula realizada no semestre anterior.
	 * 
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @param processoMatriculaCalendarioVO
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerenciarParcelasMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		if ((!matriculaPeriodoVO.getFinanceiroManual()) && (!configuracaoFinanceiro.getRealizarMatriculaComFinanceiroManualAtivo())) {
			if ((!matriculaVO.getIsAtiva()) && (!matriculaVO.getIsPreMatricula())) {
				// neste caso não podemos gerar nada no financeiro, ou por que a
				// mesma ainda não
				// liberada, ou por que a mesma foi indeferida.
				return;
			}

			inicializarDadosParaProcessarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, usuario, configuracaoFinanceiro);

			// Primeiro vamos gerar as parcelas, ignorando a situacao atual das
			// parcelas. A idï¿½ia ï¿½ gerar a visão de momento (calculo
			// imediato)
			// e comparar com a situação real (em banco de dados). O cruzamento
			// destas informaï¿½ï¿½es devem indicar o tipo de alteração e forma
			// que as mesmas devem ser realizadas no banco de dados.
			MatriculaPeriodoVencimentoVO parcelaMatricula = gerarVencimentoMatricula(matriculaPeriodoVO, processoMatriculaCalendarioVO.getDataVencimentoMatricula());

			matriculaPeriodoVO.setMatriculaPeriodoVencimentoVOs(getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarPorMatriculaPeriodo(matriculaPeriodoVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSCONSULTARTODOS, configuracaoFinanceiro, usuario));
			List<MatriculaPeriodoVencimentoVO> listaVctosGeradosMaterialDidatico = new ArrayList<>();
			if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isGerarParcelaMaterialDidatico()){
				listaVctosGeradosMaterialDidatico = gerarVencimentosMaterialDidatico(matriculaPeriodoVO, usuario);
			}
			List<MatriculaPeriodoVencimentoVO> listaVctosGerados = gerarVencimentosMensalidades(matriculaPeriodoVO, usuario);
			// Processando a geração de parcelas, lembrando que este processo
			// pode sofrer interferencia da situacao da matricula
			if(!listaVctosGeradosMaterialDidatico.isEmpty()){
					listaVctosGerados.addAll(listaVctosGeradosMaterialDidatico);	
			}
			// Método ï¿½til quando a matrícula importa os vencimentos de
			// sistemas
			// legados. Assim, precisamos
			// de uma rotina capaz de ajustar o numero da parcela, facilitando
			// que a mesma seja localizada
			// e ajustada.
			executarAjusteIdentificadorNumeroParcelasParaTitulosImportados(listaVctosGeradosMaterialDidatico.size(), listaVctosGerados.size() , matriculaPeriodoVO);
			matriculaPeriodoVO.setValorDiferencaParcelasPagasParcelasGeradas(calcularValorDiferencaValorCobrarComRelacaoValorJaPago(matriculaVO, parcelaMatricula, listaVctosGerados, matriculaPeriodoVO, configuracaoFinanceiro, usuario));
			
			
			if(!matriculaVO.getBloqueioPorSolicitacaoLiberacaoMatricula()) {
				SituacaoVencimentoMatriculaPeriodo situacaoMatricula = processarGeracao_AlteracaoParcelaVencimentoMatricula(parcelaMatricula, matriculaVO, matriculaPeriodoVO, configuracaoFinanceiro, usuario);
				processarGeracao_AlteracaoParcelasMensalidades(situacaoMatricula, listaVctosGerados, matriculaVO, matriculaPeriodoVO, matriculaPeriodoVO.getValorFinalSerRestituido(), configuracaoFinanceiro, usuario);
			}
			
			if(matriculaVO.getBloqueioPorSolicitacaoLiberacaoMatricula()) {
				listaVctosGerados.stream()
				.filter(vctosGerados -> !vctosGerados.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA)).
				forEach(vctosGerados ->{
						vctosGerados.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);
				});
				if (!matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoControlarMatricula() && !parcelaMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA)) {
					parcelaMatricula.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);	
				}
				matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(parcelaMatricula);
				matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().addAll(listaVctosGerados);
			}
			
			getFacadeFactory().getMatriculaPeriodoVencimentoFacade().gravarMatriculaPeriodoVencimentoVOs(matriculaPeriodoVO, usuario);
		}
	}

	private MatriculaPeriodoVencimentoVO obterVctoParcelaEspecifica(List<MatriculaPeriodoVencimentoVO> listaVctosGerados, MatriculaPeriodoVencimentoVO  vcto) {
		String parcela = vcto.getParcela();
		if (parcela.contains("/")) {
			parcela = parcela.substring(0, parcela.indexOf("/"));
		}
		for (MatriculaPeriodoVencimentoVO vctoNovo : listaVctosGerados) {
			String parcelaBase = vctoNovo.getParcela();
			if (parcelaBase.contains("/")) {
				parcelaBase = parcelaBase.substring(0, parcelaBase.indexOf("/"));
			}
			if (vcto.getTipoOrigemMatriculaPeriodoVencimento().equals(vctoNovo.getTipoOrigemMatriculaPeriodoVencimento()) && parcelaBase.equals(parcela)) {
				return vctoNovo;
			}
		}
		return null;
	}

	/*public Double obterValorVctoParcelaEspecifica(List<MatriculaPeriodoVencimentoVO> listaVctosGerados, String parcela) {
		MatriculaPeriodoVencimentoVO vctoNovo = obterVctoParcelaEspecifica(listaVctosGerados, parcela);
		if (vctoNovo != null) {
			return Uteis.arrendondarForcando2CadasDecimais(vctoNovo.getCalcularValorFinal());
		}
		return 0.0;
	}*/	

	/**
	 * Método Responsável por calcular o valor que deve ser adicionado ou
	 * excluï¿½do nas parcelas ainda não pagas pelo aluno, isto em decorrï¿½ncia
	 * de existir alguma displina que foi incluída/excluï¿½da em sua grade do
	 * periodo letivo. Este Método deve considerar os seguintes aspectos.
	 * Primeiro, se o valor de disciplina incluídas/excluï¿½das for ser gerado
	 * em uma parcela separada, então não existem razões para esta rotina ser
	 * utilizada. Pois não iremos alterar o valor das parcelas já geradas.
	 * 
	 * @param parcelaMatricula
	 * @param listaVctosGerados
	 * @param matriculaPeriodoVO
	 * @return
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Double calcularValorDiferencaValorCobrarComRelacaoValorJaPago(MatriculaVO matriculaVO, MatriculaPeriodoVencimentoVO parcelaMatricula, List<MatriculaPeriodoVencimentoVO> listaVctosGerados, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		Map<String, UsuarioVO> mapaParcelaDesconsiderarRateio = new HashMap<>();
		matriculaPeriodoVO.getMatriculaPeriodoContaReceberLogVOs().stream()
		.filter(p->p.isLiberadoDiferencaValorRateio())
		.forEach(p->mapaParcelaDesconsiderarRateio.put(p.getParcelaAntiga(), p.getResponsavelLiberadoDiferencaValorRateio()));
		matriculaPeriodoVO.setValorFinalSerRestituido(null);
		matriculaPeriodoVO.setValorConvenioNaoRestituirAluno(0.0);
		matriculaPeriodoVO.setValorParcelaRateioDesconsiderado(0.0);
		matriculaPeriodoVO.getListaConvenioNaoRestituiAluno().clear();
		matriculaPeriodoVO.getMatriculaPeriodoContaReceberLogVOs().clear();
		matriculaPeriodoVO.getMatriculaPeriodoContaReceberAlterarLogVOs().clear();
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getGerarParcelasSeparadasParaDisciplinasIncluidas()) {
			return 0.0;
		}
		SituacaoVencimentoMatriculaPeriodo situacaoMatriculas = matriculaPeriodoVO.obterSituacaoParcelasReferenteMatricula();
		SituacaoVencimentoMatriculaPeriodo situacaoParcelas = matriculaPeriodoVO.obterSituacaoParcelasReferenteMensalidades();
		if ((!situacaoMatriculas.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) && (!situacaoParcelas.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA))) {
			return 0.0;
		}
		MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO = matriculaPeriodoVO.getMatriculaPeriodoVencimentoReferenteMatricula();
		Double valorParcelaMatriculaNova = 0.0;
		Double valorParcelaMatriculaAntiga = 0.0;
		Double valorDescontoConvenioNaoRestituir = 0.0;
		Double valorParcelaRateioDesconsiderado = 0.0;
		Date dataBaseUsoConta = new Date();
		if (matriculaPeriodoVencimentoVO != null && 
				matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getRestituirDiferencaValorMatriculaSistemaPorCredito() && 
				(matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA) 
				|| matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA)
				|| matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA_EDITADA_MANUALMENTE)
				|| (matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA) && 
				matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoRegerarParcelaVencida()
				&& (matriculaPeriodoVencimentoVO.getDataVencimento().compareTo(dataBaseUsoConta) <= 0 
				|| Uteis.getData(dataBaseUsoConta).equals(Uteis.getData(matriculaPeriodoVencimentoVO.getDataVencimento()))))
				|| ((matriculaPeriodoVencimentoVO.getContaReceber().getContaEditadaManualmente() && matriculaPeriodoVencimentoVO.getContaReceber().getSituacaoEQuitada()))
				)
				&& (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioExtraParcelaVencida() 
						|| (!matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioExtraParcelaVencida() 
								&& (matriculaPeriodoVencimentoVO.getDataVencimento().compareTo(dataBaseUsoConta) > 0 
								&& !Uteis.getData(dataBaseUsoConta).equals(Uteis.getData(matriculaPeriodoVencimentoVO.getDataVencimento())))))) {
			MatriculaPeriodoVencimentoVO mpvantiga = (MatriculaPeriodoVencimentoVO)matriculaPeriodoVencimentoVO.clone();			
			matriculaPeriodoVO.getMatriculaPeriodoVencimentoReferenteMatricula().getContaReceber().setValorFinalCalculado(matriculaPeriodoVO.getMatriculaPeriodoVencimentoReferenteMatricula().getContaReceber().getValorRecebido());			
			if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioBaseadoValorBaseComDescontosAplicados()){
				//Calcula os Descontos da Conta Velha
				
				ContaReceberVO contaReceberVO = (ContaReceberVO)matriculaPeriodoVO.getMatriculaPeriodoVencimentoReferenteMatricula().getContaReceber().clone();				
				contaReceberVO.setSituacao(SituacaoContaReceber.A_RECEBER.getValor());
				contaReceberVO.setRealizandoRecebimento(true);
				contaReceberVO.setValorDescontoLancadoRecebimento(0.0);
				contaReceberVO.setValorCalculadoDescontoLancadoRecebimento(0.0);
				Date dataBase = Uteis.getDataPassada(contaReceberVO.getDataVencimento(), 30);
				contaReceberVO.getCalcularValorFinal(dataBase, configuracaoFinanceiroVO, false, dataBase, usuario);
				contaReceberVO.setValorFinalCalculado(matriculaPeriodoVO.getMatriculaPeriodoVencimentoReferenteMatricula().getContaReceber().getValorRecebido());
				valorParcelaMatriculaAntiga = Uteis.arrendondarForcando2CadasDecimais(contaReceberVO.getValorRecebido());
				contaReceberVO.setJuro(matriculaPeriodoVO.getMatriculaPeriodoVencimentoReferenteMatricula().getContaReceber().getJuro());
				contaReceberVO.setMulta(matriculaPeriodoVO.getMatriculaPeriodoVencimentoReferenteMatricula().getContaReceber().getMulta());
				contaReceberVO.setValorCalculadoDescontoLancadoRecebimento(matriculaPeriodoVO.getMatriculaPeriodoVencimentoReferenteMatricula().getContaReceber().getValorCalculadoDescontoLancadoRecebimento());
				mpvantiga.setContaReceber(contaReceberVO);
				valorParcelaMatriculaNova = Uteis.arrendondarForcando2CadasDecimais(parcelaMatricula.getValorDescontoCalculadoPrimeiraFaixaDescontos());
			}else{
				Double valorCursteadoConvenio = 0.0;
				if(!matriculaPeriodoVO.getListaDescontosMatricula().isEmpty()){					
					valorCursteadoConvenio = matriculaPeriodoVO.getListaDescontosMatricula().get(0).getValorCusteadoContaReceber();
				}
				valorParcelaMatriculaNova = parcelaMatricula.getValor() - valorCursteadoConvenio;				
//				valorParcelaMatriculaAntiga = matriculaPeriodoVencimentoVO.getValorReferenciaTituloPago();
				valorParcelaMatriculaAntiga = matriculaPeriodoVencimentoVO.getContaReceber().getValor();
			}			
			if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getRestituirDiferencaValorMatriculaSistemaPorCredito()) {
				MatriculaPeriodoContaReceberLogVO matriculaPeriodoContaReceberLogVO = realizarPreenchimentoAlteracaoContaReceberPorMatriculaPeriodoVencimento(matriculaPeriodoVO, parcelaMatricula, mpvantiga, mapaParcelaDesconsiderarRateio);
				valorDescontoConvenioNaoRestituir += matriculaPeriodoContaReceberLogVO.getValorConvenioNaoRestituirAluno();
				matriculaPeriodoContaReceberLogVO.setValorFinalRestituirAluno(matriculaPeriodoContaReceberLogVO.getDiferencaParcela());
				if(matriculaPeriodoContaReceberLogVO.getValorConvenioNaoRestituirAluno() > 0 && !matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno().equals(0.0)) {
					if(matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno() < 0) {
						matriculaPeriodoContaReceberLogVO.setValorFinalRestituirAluno(Uteis.arrendondarForcando2CadasDecimais((matriculaPeriodoContaReceberLogVO.getValorConvenioNaoRestituirAluno() - (matriculaPeriodoContaReceberLogVO.getDiferencaParcela() * -1))));
					}else {
						matriculaPeriodoContaReceberLogVO.setValorFinalRestituirAluno(Uteis.arrendondarForcando2CadasDecimais((matriculaPeriodoContaReceberLogVO.getValorConvenioNaoRestituirAluno() + matriculaPeriodoContaReceberLogVO.getDiferencaParcela())));
					}
				}
				
				if(mapaParcelaDesconsiderarRateio.containsKey(matriculaPeriodoContaReceberLogVO.getParcelaAntiga())) {
					if(!matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno().equals(0.0)) {
						if(matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno() < 0) {
							valorParcelaRateioDesconsiderado += (matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno() * -1);							
						}else {
							valorParcelaRateioDesconsiderado -= Uteis.arrendondarForcando2CadasDecimais(matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno());
						}
					}
					matriculaPeriodoContaReceberLogVO.setValorParcelaRateioDesconsiderado(matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno());
				}
				matriculaPeriodoVO.getMatriculaPeriodoContaReceberLogVOs().add(matriculaPeriodoContaReceberLogVO);
			}				
		} else {
			valorParcelaMatriculaNova = 0.0;
			valorParcelaMatriculaAntiga = 0.0;			
		}
	
		
		Double valorParcelaPago = 0.0;
		Double valorNovaParcelaCalculadaEquivalenteAPaga = 0.0;
		Double valorCusteadoConvenio = 0.0;
		if(!matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().isEmpty() && !matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().get(0).getListaDescontosMensalidade().isEmpty()){
			valorCusteadoConvenio = matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().get(0).getListaDescontosMensalidade().get(0).getValorCusteadoContaReceber();
		}
		
		Integer nrParcelasPagas = 0;
		Double valorRateioJaAplicadoParcelas = 0.0;
		Iterator<MatriculaPeriodoVencimentoVO> i = matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().iterator();
		while (i.hasNext()) {
			MatriculaPeriodoVencimentoVO vctos = (MatriculaPeriodoVencimentoVO) i.next();
			if (vctos.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade() && 
					(!vctos.getContaReceber().getContaEditadaManualmente() || (vctos.getContaReceber().getContaEditadaManualmente() && vctos.getContaReceber().getSituacaoEQuitada()))) {
				if (((((vctos.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)
						|| vctos.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA_EDITADA_MANUALMENTE)
						|| vctos.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA)) 
						|| (vctos.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA) && 
						matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoRegerarParcelaVencida()
						&& (vctos.getDataVencimento().compareTo(dataBaseUsoConta) <= 0 
						|| Uteis.getData(dataBaseUsoConta).equals(Uteis.getData(vctos.getDataVencimento())))
						)
						|| ((vctos.getContaReceber().getContaEditadaManualmente() && vctos.getContaReceber().getSituacaoEQuitada()))
						)
						&& (!vctos.getParcela().contains("EX")) || (vctos.getContaReceber().getTituloImportadoSistemaLegado())))
						&& (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioExtraParcelaVencida() 
								|| (!matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioExtraParcelaVencida() 
										&& (vctos.getDataVencimento().compareTo(dataBaseUsoConta) > 0 
										&& !Uteis.getData(dataBaseUsoConta).equals(Uteis.getData(vctos.getDataVencimento())))))) {
					// O sistema precisa verificar acima se trata-se de um
					// tï¿½tulo importado de outro sistema, pois
					// caso seja, o sistema deverï¿½ considerar o mesmo como se
					// fosse uma conta paga. Pois a mesma, não
					// poderá ser alterada/gerada novamente pelo SEI. Pois
					// provavelmente o aluno já pegou este boleto
					// e caso o mesmo pague pelo banco não seria possível
					// processar o arquivo de retorno.
					nrParcelasPagas++;
					MatriculaPeriodoVencimentoVO contaNova = obterVctoParcelaEspecifica(listaVctosGerados, vctos);
					if(contaNova != null){
						if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioBaseadoValorBaseComDescontosAplicados() ){
							valorNovaParcelaCalculadaEquivalenteAPaga += contaNova.getValorDescontoCalculadoPrimeiraFaixaDescontos();
						}else{
							valorNovaParcelaCalculadaEquivalenteAPaga += contaNova.getValor()-valorCusteadoConvenio;
						}
					}
										
					MatriculaPeriodoVencimentoVO mpvantiga = (MatriculaPeriodoVencimentoVO)vctos.clone();
					if (vctos.getContaReceber().getTituloImportadoSistemaLegado()) {
						if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioBaseadoValorBaseComDescontosAplicados()){
							valorParcelaPago += Uteis.arrendondarForcando2CadasDecimais(vctos.getContaReceber().getValor() - vctos.getContaReceber().getValorTotalDescontoContaReceber());							
						}else{
							valorParcelaPago += vctos.getContaReceber().getValor();							
						}
					}else if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioBaseadoValorBaseComDescontosAplicados()){
						ContaReceberVO contaReceberVO = (ContaReceberVO)vctos.getContaReceber().clone();						
						contaReceberVO.setSituacao(SituacaoContaReceber.A_RECEBER.getValor());
						contaReceberVO.setRealizandoRecebimento(true);
						contaReceberVO.setValorDescontoLancadoRecebimento(0.0);
						contaReceberVO.setValorCalculadoDescontoLancadoRecebimento(0.0);
						Date dataBase = Uteis.getDataPassada(contaReceberVO.getDataVencimento(), 30);
						contaReceberVO.getCalcularValorFinal(dataBase, configuracaoFinanceiroVO, false, dataBase, usuario);
						contaReceberVO.setValorFinalCalculado(vctos.getContaReceber().getValorRecebido());
						contaReceberVO.setJuro(vctos.getContaReceber().getJuro());
						contaReceberVO.setMulta(vctos.getContaReceber().getMulta());
						contaReceberVO.setValorCalculadoDescontoLancadoRecebimento(vctos.getContaReceber().getValorCalculadoDescontoLancadoRecebimento());
						mpvantiga.setContaReceber(contaReceberVO);						
						valorParcelaPago += Uteis.arrendondarForcando2CadasDecimais(contaReceberVO.getValorRecebido());
					}else{
//						valorParcelaPago += vctos.getValorReferenciaTituloPago();
						
						valorParcelaPago += vctos.getContaReceber().getValor();						
						vctos.getContaReceber().setValorFinalCalculado(vctos.getContaReceber().getValorRecebido());
						valorRateioJaAplicadoParcelas += vctos.getContaReceber().getValorDescontoRateio();
						
					}
					MatriculaPeriodoContaReceberLogVO matriculaPeriodoContaReceberLogVO = realizarPreenchimentoAlteracaoContaReceberPorMatriculaPeriodoVencimento(matriculaPeriodoVO, contaNova, mpvantiga, mapaParcelaDesconsiderarRateio);
					valorDescontoConvenioNaoRestituir += matriculaPeriodoContaReceberLogVO.getValorConvenioNaoRestituirAluno();
					matriculaPeriodoContaReceberLogVO.setValorFinalRestituirAluno(matriculaPeriodoContaReceberLogVO.getDiferencaParcela());
					if(matriculaPeriodoContaReceberLogVO.getValorConvenioNaoRestituirAluno() > 0 && !matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno().equals(0.0)) {
						if(matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno() < 0) {
							matriculaPeriodoContaReceberLogVO.setValorFinalRestituirAluno(Uteis.arrendondarForcando2CadasDecimais((matriculaPeriodoContaReceberLogVO.getValorConvenioNaoRestituirAluno() - (matriculaPeriodoContaReceberLogVO.getDiferencaParcela() * -1))));
						}else {
							matriculaPeriodoContaReceberLogVO.setValorFinalRestituirAluno(Uteis.arrendondarForcando2CadasDecimais((matriculaPeriodoContaReceberLogVO.getValorConvenioNaoRestituirAluno() + matriculaPeriodoContaReceberLogVO.getDiferencaParcela())));
						}
					}
					
					if(mapaParcelaDesconsiderarRateio.containsKey(matriculaPeriodoContaReceberLogVO.getParcelaAntiga())) {
						if(!matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno().equals(0.0)) {
							if(matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno() < 0) {
								valorParcelaRateioDesconsiderado += (matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno() * -1);							
							}else {
								valorParcelaRateioDesconsiderado -= Uteis.arrendondarForcando2CadasDecimais(matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno());
							}
						}
						matriculaPeriodoContaReceberLogVO.setValorParcelaRateioDesconsiderado(matriculaPeriodoContaReceberLogVO.getValorFinalRestituirAluno());
//						matriculaPeriodoContaReceberLogVO.setValorFinalRestituirAluno(0.0);
					}					
					matriculaPeriodoVO.getMatriculaPeriodoContaReceberLogVOs().add(matriculaPeriodoContaReceberLogVO);
				}
			}
		}	
		
		Double valorDiferencaParcelasPagasParcelasGeradas = Uteis.arrendondarForcando2CadasDecimais((valorNovaParcelaCalculadaEquivalenteAPaga+valorParcelaMatriculaNova) - (valorParcelaPago+valorParcelaMatriculaAntiga));
		valorDiferencaParcelasPagasParcelasGeradas = executarCalculoValorDiferencaParcelasPagasExtra(valorDiferencaParcelasPagasParcelasGeradas, matriculaPeriodoVO, configuracaoFinanceiroVO, matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioExtraParcelaVencida() , mapaParcelaDesconsiderarRateio, usuario);
		if (valorDiferencaParcelasPagasParcelasGeradas < 0) {
			valorDiferencaParcelasPagasParcelasGeradas = Uteis.arrendondarForcando2CadasDecimais(valorDiferencaParcelasPagasParcelasGeradas + (valorRateioJaAplicadoParcelas)); 
		} else if (valorDiferencaParcelasPagasParcelasGeradas > 0) {
			valorDiferencaParcelasPagasParcelasGeradas = Uteis.arrendondarForcando2CadasDecimais(valorDiferencaParcelasPagasParcelasGeradas - (valorRateioJaAplicadoParcelas));
		}
		if(valorDescontoConvenioNaoRestituir > 0){
			matriculaPeriodoVO.setValorConvenioNaoRestituirAluno(valorDescontoConvenioNaoRestituir);
		}		
		valorParcelaRateioDesconsiderado = Uteis.arrendondarForcando2CadasDecimais(valorParcelaRateioDesconsiderado);
		matriculaPeriodoVO.setValorParcelaRateioDesconsiderado(valorParcelaRateioDesconsiderado);
	
		if(valorDiferencaParcelasPagasParcelasGeradas < 0 && matriculaPeriodoVO.getContaPagarRestituicaoVO().getQuitada() && matriculaPeriodoVO.getContaPagarRestituicaoVO().getValor().equals(valorDiferencaParcelasPagasParcelasGeradas*-1)){
			valorDiferencaParcelasPagasParcelasGeradas = 0.0;
			matriculaPeriodoVO.getContaPagarRestituicaoVO().setValorAlterar(0.0);
		}else if(matriculaPeriodoVO.getContaPagarRestituicaoVO().getQuitada()){
			matriculaPeriodoVO.getContaPagarRestituicaoVO().setValorAlterar(matriculaPeriodoVO.getContaPagarRestituicaoVO().getValor());
		}
		Ordenacao.ordenarLista(matriculaPeriodoVO.getMatriculaPeriodoContaReceberLogVOs(), "dataVencimentoAntiga");
		matriculaPeriodoVO.setValorDiferencaParcelasPagasParcelasGeradas(valorDiferencaParcelasPagasParcelasGeradas);
		realizarPrevisaoContaReceberImpactadasPorAlteracaoFinanceira(matriculaVO, matriculaPeriodoVO, matriculaPeriodoVO.getValorFinalSerRestituido() , configuracaoFinanceiroVO, usuario);
		return valorDiferencaParcelasPagasParcelasGeradas;
	}

	/**
	 * Método responsavel por calcular a diferença dos valores pagos que são de
	 * parcelas extras. ï¿½ necessário a diminuição desse valor para poder
	 * regerar a proxima parcela extra com o valor exato
	 * 
	 * @param valorDiferencaParcelasPagasParcelasGeradas
	 * @param matriculaPeriodo
	 * @return
	 * @throws Exception
	 * @Autor Carlos
	 */
	public Double executarCalculoValorDiferencaParcelasPagasExtra(Double valorDiferencaParcelasPagasParcelasGeradas, MatriculaPeriodoVO matriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Boolean considerarContaReceberVencida, Map mapaParcelaDesconsiderarRateio, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVencimentoVO> listaMatriculaVencimentoExtrasPagas = new ArrayList<MatriculaPeriodoVencimentoVO>(0);
		listaMatriculaVencimentoExtrasPagas = getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarPorMatriculaPeriodoESituacaoParcelaExtra(matriculaPeriodo.getCodigo().intValue(), "GP", false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		if (!listaMatriculaVencimentoExtrasPagas.isEmpty()) {
			for (MatriculaPeriodoVencimentoVO obj : listaMatriculaVencimentoExtrasPagas) {
				if(considerarContaReceberVencida || (!considerarContaReceberVencida && obj.getDataVencimento().compareTo(new Date()) > 0 
						&& !Uteis.getData(obj.getDataVencimento()).equals(Uteis.getData(new Date()))))
				valorDiferencaParcelasPagasParcelasGeradas = valorDiferencaParcelasPagasParcelasGeradas - obj.getValorReferenciaTituloPago();
				MatriculaPeriodoVencimentoVO objClone = (MatriculaPeriodoVencimentoVO) obj.clone();
				objClone.setValor(0.0);
				objClone.setValorDescontoCalculadoPrimeiraFaixaDescontos(0.0);
				objClone.setContaReceber(new ContaReceberVO());
				objClone.setParcela(obj.getParcela());				
				objClone.setTipoOrigemMatriculaPeriodoVencimento(obj.getTipoOrigemMatriculaPeriodoVencimento());				
				MatriculaPeriodoContaReceberLogVO matriculaPeriodoContaReceberLogVO = realizarPreenchimentoAlteracaoContaReceberPorMatriculaPeriodoVencimento(matriculaPeriodo, objClone, obj,mapaParcelaDesconsiderarRateio);				
				matriculaPeriodo.getMatriculaPeriodoContaReceberLogVOs().add(matriculaPeriodoContaReceberLogVO);
			}
		}
		return valorDiferencaParcelasPagasParcelasGeradas;
	}

	/**
	 * Método Responsável por alterar a situação da ContaReceber, Matricula e
	 * MatriculaPeriodo. A Primeira condição ï¿½ caso o valor de desconto
	 * institucional ou o valor de desconto Convenio for igual ao valor que o
	 * aluno deve pagar, ou seja, um desconto de 100%, a situacao da
	 * contaReceber deve ser alterada para RECEBIDO, a situação da Matricula
	 * para QUITADA e da MatriculaPeriodo para CONFIRMADA A segunda condição ï¿½
	 * caso o tipo desconto seja Porcentagem e o valor do desconto seja de 100%,
	 * ele também irá alterar a situação como citado anteriormente. A terceira
	 * condição ï¿½ caso o tipo de desconto seja igual a Valor e este valor seja
	 * de 100%, ele irá alterar a situação como citado anteriomente. Caso
	 * nenhuma das opï¿½ï¿½es a matriculaPeriodo continuarï¿½ com a situacao
	 * PENDENTE FINANCEIRAMENTE.
	 * 
	 * @param contaReceber
	 * @param matriculaPeriodoVO
	 * @param matricula
	 * @param parcelaMatricula
	 * @throws Exception
	 * @Autor Carlos
	 */
	public void alterarSituacaoContaReceberMatriculaMatriculaPeriodoDependendoDescontos(ContaReceberVO contaReceber, MatriculaPeriodoVO matriculaPeriodoVO, String matricula, MatriculaPeriodoVencimentoVO parcelaMatricula) throws Exception {
		Boolean descontoCemPorCento = false;
		Double valorTotalDesconto = contaReceber.getValorTotalDescontoContaReceber();
		// caso exita um convenio que irá pagar parte da conta a receber, entao
		// temos
		// que considerar este valor custeado tambem como desconto. Pois quem
		// irá pagar
		// este valor ï¿½ a conveniada. Este valorCusteadoContaReceber estarï¿½
		// preenchido somente
		// quando o convenio estão definido para abater valor do convenio do
		// valor da parcela.
		valorTotalDesconto = Uteis.arrendondarForcando2CadasDecimais(valorTotalDesconto + contaReceber.getValorCusteadoContaReceber());
		if (valorTotalDesconto >= contaReceber.getValorBaseContaReceber() || contaReceber.getValorBaseContaReceber().equals(0.0)) {
			descontoCemPorCento = true;
			contaReceber.setValorDescontoRecebido(valorTotalDesconto);
			contaReceber.setSituacao("RE");
			matriculaPeriodoVO.setSituacao("CO");
			alterarSituacaoFinanceiraMatriculaPeriodo(matriculaPeriodoVO.getCodigo(), "CO");
			getFacadeFactory().getMatriculaFacade().alterarSituacaoFinanceiraMatricula(matricula, "QU");
			parcelaMatricula.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA);
		}
		if (!descontoCemPorCento) {
			matriculaPeriodoVO.setSituacao("PF");
			parcelaMatricula.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA);
		}
	}

	/**
	 * Rotina responsavel por gerar uma conta a receber quitada ou não, relativa
	 * a parcela da matricula. O parametro liberarPagamento ï¿½ que irá indicar
	 * se a conta a receber deverï¿½ ser gerada quitada, ou não.
	 * 
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @param processoMatriculaCalendarioVO
	 * @param condicao
	 * @throws Exception
	 */
	// TODOCOPIADO
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void criarContaReceberMatricula(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO parcelaMatricula, Boolean liberarPagamento, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		matriculaVO.getUnidadeEnsino().setNivelMontarDados(NivelMontarDados.NAO_INICIALIZADO);
		getFacadeFactory().getUnidadeEnsinoFacade().carregarDados(matriculaVO.getUnidadeEnsino(), NivelMontarDados.BASICO, usuario);
		ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO = matriculaPeriodoVO.getProcessoMatriculaCalendarioVO();

		ContaReceberVO obj1 = matriculaPeriodoVO.criarContaReceberMatriculaBaseadoMatriculaPeriodoVencimento(matriculaVO, matriculaPeriodoVO, parcelaMatricula, liberarPagamento, configuracaoFinanceiro, true, usuario);
		obj1.setContaCorrenteVO(getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(obj1.getContaCorrente(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
		obj1.setEmissaoBloqueada(getFacadeFactory().getContaReceberFacade().verificaBloqueioEmissaoBoleto(obj1, usuario));
		// ContaReceber.montarListaDescontosAplicaveisContaReceber(obj1,
		// matriculaPeriodoVO.getData(),
		// configuracaoFinanceiro.getUsaDescontoCompostoPlanoDesconto(),
		// configuracaoFinanceiro, usuario, null);
		alterarSituacaoContaReceberMatriculaMatriculaPeriodoDependendoDescontos(obj1, matriculaPeriodoVO, matriculaVO.getMatricula(), parcelaMatricula);

		Integer descontoProgressivoAluno = verificarSeContaASerGeradaPossuiConvenioComDescontoDeAntecipacaoAluno(matriculaVO, "Matrícula");
		if (descontoProgressivoAluno != 0) {
			obj1.getDescontoProgressivo().setCodigo(descontoProgressivoAluno);
			matriculaVO.getPlanoFinanceiroAluno().getDescontoProgressivoMatricula().setCodigo(descontoProgressivoAluno);
		}

		configuracaoFinanceiro.setNivelMontarDados(NivelMontarDados.TODOS);
		obj1.setConfiguracaoFinanceiro(configuracaoFinanceiro);

		getFacadeFactory().getContaReceberFacade().incluir(obj1, false, configuracaoFinanceiro, usuario);

		// matriculaPeriodoVO.setContaReceber(obj1.getCodigo());
		parcelaMatricula.setContaReceber(obj1);
		
		if (obj1.getContaCorrenteVO().getBloquearEmitirBoletoSemRegistroRemessa()) {
			obj1.setBloquearPagamentoVisaoAluno(getFacadeFactory().getControleRemessaContaReceberFacade().verificaContaReceberRegistrada(obj1));
		}

		if (!liberarPagamento && obj1.getSituacaoEQuitada()) {
			// matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(parcelaMatricula);
			// alterarContaReceberLiberandoPagamentoMatricula(matriculaVO,
			// matriculaPeriodoVO, configuracaoFinanceiro, usuario);				
			getFacadeFactory().getContaReceberFacade().baixarContaReceberConcedendoDescontoTotalAMesma(parcelaMatricula.getContaReceber().getCodigo(), matriculaPeriodoVO.getData(), "Desconto 100% na matrícula.", false, true, usuario, configuracaoFinanceiro, usuario);
			getFacadeFactory().getMatriculaPeriodoVencimentoFacade().alterar(parcelaMatricula, false, null);
		}
		criarContaReceberBolsaCusteadaMatricula(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, configuracaoFinanceiro, parcelaMatricula, obj1, usuario);

		configuracaoFinanceiro = null;
		obj1 = null;
	}


	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarTurmaBaseMatriculaPeriodo(Integer matriculaPeriodo, Integer turma) throws Exception {
		String sqlStr = "UPDATE MatriculaPeriodo set turma=? WHERE (codigo = ?)";
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { turma, matriculaPeriodo });
	}	

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void criarContaReceberNaoPagasBolsaCusteadaMensalidades(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoFinanceiroVO configFinan, MatriculaPeriodoVencimentoVO vctoGerar, UsuarioVO usuario, Boolean simulacao) throws Exception {
		Boolean regerarConta = realizarVerificacaoConvenioNaoPagoParaNovaGeracao(matriculaVO, matriculaPeriodoVO, vctoGerar);
		if (vctoGerar.getParcela().contains("EX")) {
			regerarConta = verificarTodasAsParcelasConvenioJaPagas(matriculaPeriodoVO);
		}	
		for (ConvenioVO convenio : matriculaPeriodoVO.getListaConvenioRemoverContaPagarRestituicaoAluno()) {
			Integer convenioRemover = convenio.getCodigo();
			// Excluindo possível conta a receber (nao baixadas) do convênio
			// removido, que possam
			// nao ter sido removidas pela rotina de geração de parcelas (do
			// aluno e do convenio).
			// Esta situação ocorre em especial, quando o aluno não tem
			// convênio, e já possui ao menos
			// uma mensalidade paga (ou seja, a matrícula e mais uma
			// mensalidade). então adiciona-se
			// o convênio para o aluno no meio do semestre. Assim, o SEI irá
			// gerar a parcela do convênio
			// correspondente a esta mensalidade já paga. Posteriormente, se a
			// matrícula do aluno for
			// editada e o convênio removido, o SEI irá remover automaticamnete
			// as parcelas do convênio
			// referentes as mensalidades não pagas. Contudo, para a mensalidade
			// paga, o SEI não faz nada
			// pois precupï¿½e uma situação de fechamento nesta rotina e o
			// Método acima (realizarVerificacaoConvenioNaoPagoParaNovaGeracao)
			// trabalha somente
			// com o foto nos convenios lancados para o aluno. Contudo, pode
			// existir uma parcela
			// de convênio, relacionada a esta parcela que foi gerada, que
			// precisa ser removida.
			// Esta rotina trata deste caso, percorrendo a
			// getListaConvenioRemoverContaPagarRestituicaoAluno
			// que os convenios que foram removidas.
			if (!simulacao) {
				getFacadeFactory().getContaReceberFacade().excluirContasReceberTipoOrigemCodigoOrigemConvenioEspecifico(convenioRemover, "BCC", matriculaPeriodoVO.getCodigo(), "AR", vctoGerar.getParcelaCusteadaConvenio(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNrParcelasPeriodo(),matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getQuantidadeParcelasMaterialDidatico().intValue()), !matriculaPeriodoVO.getBloqueioPorFechamentoMesLiberado(), usuario);
			}
		}	
		if (regerarConta) {
			if (!simulacao) {
				getFacadeFactory().getContaReceberFacade().excluirContasReceberTipoOrigemCodigoOrigem("BCC", matriculaPeriodoVO.getCodigo(), "AR", vctoGerar.getParcelaCusteadaConvenio(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNrParcelasPeriodo(),matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getQuantidadeParcelasMaterialDidatico().intValue()), !matriculaPeriodoVO.getBloqueioPorFechamentoMesLiberado(), usuario);
			}
			List<ContaReceberVO> listaMensalidadesBolsaCusteada = getFacadeFactory().getMatriculaPeriodoFacade().criarContaReceberBolsaCusteadaMensalidade(configFinan, matriculaVO, matriculaPeriodoVO, vctoGerar, usuario);			
			Iterator<ContaReceberVO> i = listaMensalidadesBolsaCusteada.iterator();
			while (i.hasNext()) {
				ContaReceberVO obj = (ContaReceberVO) i.next();
				Integer descontoProgressivoParceiro = verificarSeContaASerGeradaPossuiConvenioComDescontoDeAntecipacaoParceiro(matriculaVO, obj.getConvenio().getCodigo(), "Mensalidade");
				if (descontoProgressivoParceiro != 0) {
					obj.getDescontoProgressivo().setCodigo(descontoProgressivoParceiro);

					if (!matriculaVO.getPlanoFinanceiroAluno().getDescontoProgressivoPrimeiraParcela().getCodigo().equals(0) && !matriculaVO.getPlanoFinanceiroAluno().getDescontoProgressivoPrimeiraParcela().getCodigo().equals(matriculaVO.getPlanoFinanceiroAluno().getDescontoProgressivo().getCodigo()) && obj.getParcela().matches("0?1/(.*)")) {
						obj.setDescontoProgressivo(matriculaVO.getPlanoFinanceiroAluno().getDescontoProgressivoPrimeiraParcela());
					}
				}
				ContaReceber.montarListaDescontosAplicaveisContaReceber(obj, Uteis.getDataPassadaPorDataAtual(730), false, configFinan, usuario, 0);
				obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(obj.getValor());
				obj.setValorDescontoCalculadoSegundaFaixaDescontos(obj.getValor());
				obj.setValorDescontoCalculadoTerceiraFaixaDescontos(obj.getValor());
				obj.setValorDescontoCalculadoQuartaFaixaDescontos(obj.getValor());
				if (obj.getListaDescontosAplicavesContaReceber().size() >= 1) {
					obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(obj.getListaDescontosAplicavesContaReceber().get(0).getValorBaseComDescontosJaCalculadosAplicados());
				}
				if (obj.getListaDescontosAplicavesContaReceber().size() >= 2) {
					obj.setValorDescontoCalculadoSegundaFaixaDescontos(obj.getListaDescontosAplicavesContaReceber().get(1).getValorBaseComDescontosJaCalculadosAplicados());
				}
				if (obj.getListaDescontosAplicavesContaReceber().size() >= 3) {
					obj.setValorDescontoCalculadoTerceiraFaixaDescontos(obj.getListaDescontosAplicavesContaReceber().get(2).getValorBaseComDescontosJaCalculadosAplicados());
				}
				if (obj.getListaDescontosAplicavesContaReceber().size() >= 4) {
					obj.setValorDescontoCalculadoQuartaFaixaDescontos(obj.getListaDescontosAplicavesContaReceber().get(3).getValorBaseComDescontosJaCalculadosAplicados());
				}
				if (!simulacao) {
					getFacadeFactory().getContaReceberFacade().incluir(obj, false, configFinan, usuario);
				}
				obj = null;
			}
			Uteis.liberarListaMemoria(listaMensalidadesBolsaCusteada);
		}

	}

	public Boolean verificarTodasAsParcelasConvenioJaPagas(MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		Iterator i = matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().iterator();
		while (i.hasNext()) {
			MatriculaPeriodoVencimentoVO obj = (MatriculaPeriodoVencimentoVO) i.next();
			StringBuilder sql = new StringBuilder();
			sql.append(" SELECT COUNT(codigo)");
			sql.append(" FROM contareceber ");
			sql.append(" WHERE matriculaperiodo = ?");
			sql.append(" AND matriculaaluno = ? ");
			sql.append(" AND parcela = ?");
			sql.append(" AND convenio is not null");
			sql.append(" AND situacao = 'AR' ");
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), new Object[] { obj.getMatriculaPeriodo(), matriculaPeriodoVO.getMatricula(), obj.getParcelaCusteadaConvenio(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNrParcelasPeriodo(),matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getQuantidadeParcelasMaterialDidatico().intValue()) });
			if (tabelaResultado.next()) {
				return Boolean.FALSE;
			}
		}

		return Boolean.TRUE;
	}	

	public Date obterProximaDataVctoComDiaConvenio(Date dataBase, Integer diaVctoConvenio) throws Exception {
		Date dataUltimoDiaValidoMes = Uteis.getDataUltimoDiaMes(dataBase);
		Integer ultimoDiaValidoMes = Uteis.getDiaMesData(dataUltimoDiaValidoMes);
		if (diaVctoConvenio.compareTo(ultimoDiaValidoMes) > 0) {
			// tratamento para quando o dia de vcto do convenio superior o
			// ultimo dia do mes
			diaVctoConvenio = ultimoDiaValidoMes;
		}

		int mesAtual = Uteis.getMesData(dataBase);
		int anoAtual = Uteis.getAnoData(dataBase);
		Calendar calendar = new GregorianCalendar();
		try {
			calendar.set(anoAtual, mesAtual - 1, diaVctoConvenio);
			return calendar.getTime();
		} finally {
			calendar = null;
		}
	}

	public Date obterProximaDataMantendoDiaVencimentoDataBase(Date dataBase) throws Exception {
		boolean encontrouDataValida = false;
		Date novaData = dataBase;
		int nrInteracoes = 1;
		while (!encontrouDataValida) {
			novaData = Uteis.obterDataAvancadaPorMes(dataBase, nrInteracoes);
			if (!novaData.before(dataBase)) {
				// se a novaData ï¿½ maior que a data atual
				// então podemos adotï¿½-la
				return novaData;
			}
			nrInteracoes++;
			if (nrInteracoes > 100) {
				throw new Exception("Ocorreu um erro ao tentar determinar uma nova data para conta a receber do convênio, que não esteja vencida");
			}
		}

		return novaData;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<ContaReceberVO> criarListaContaReceberBolsaCusteadaMatricula(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO parcelaMatricula, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuarioVO) throws Exception {
		MatriculaPeriodoVencimentoVO vctoGerarMatricula = matriculaPeriodoVO.obterMatriculaPeriodoVencimentoCorrespondente(parcelaMatricula);
		if (vctoGerarMatricula == null) {
			vctoGerarMatricula = parcelaMatricula;
		}
		ContaReceberVO contaReceberRegeradaComValorConvenio = gerarContaReceberSimulandoConvenioAdicionadoMatriculaAluno(vctoGerarMatricula, configuracaoFinanceiro, matriculaVO, matriculaPeriodoVO, usuarioVO);
		List<ContaReceberVO> listaMatriculaBolsaCusteada = new ArrayList<>();
		if(vctoGerarMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA) 
				|| vctoGerarMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA)) {
			for(PlanoDescontoContaReceberVO planoDescontoContaReceberVO: vctoGerarMatricula.getContaReceber().getPlanoDescontoContaReceberVOs()){
				if(planoDescontoContaReceberVO.getIsConvenio() && planoDescontoContaReceberVO.getRegerarConta()) {
						if (planoDescontoContaReceberVO.getConvenio().getBolsaCusteadaParceiroMatricula().doubleValue() != 0.0) {
							Uteis.checkState(contaReceberRegeradaComValorConvenio == null, "Ocorreu um erro ao tentar gerar a parcela de Matrícula do convênio " + planoDescontoContaReceberVO.getConvenio().getDescricao() + " desta Matrícula " + matriculaVO.getMatricula() + ". Não foi possível determinar a base de cálculo do mesmo. Procure o administador do sistema.");
							matriculaPeriodoVO.setValorMatriculaBolsaCusteada(planoDescontoContaReceberVO.getValorUtilizadoRecebimento());
							Double valorMatriculaConvenio = matriculaPeriodoVO.getValorMatriculaBolsaCusteada();
							if (planoDescontoContaReceberVO.getConvenio().getTipoBolsaCusteadaParceiroMatricula().equals("VA")) {
								valorMatriculaConvenio = planoDescontoContaReceberVO.getConvenio().getBolsaCusteadaParceiroMatricula();
							}
							ContaReceberVO contaReceberGeradaMatricula = matriculaPeriodoVO.montarMatriculaBolsaCusteada(matriculaPeriodoVO.getPlanoFinanceiroCurso(), configuracaoFinanceiro, matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, valorMatriculaConvenio, 0.0, 0, planoDescontoContaReceberVO.getConvenio().getCodigo(), 0.0, 0.0, planoDescontoContaReceberVO.getConvenio().getParceiro());
							validarDateVencimentoMaticulaConvenio(matriculaPeriodoVO, vctoGerarMatricula, planoDescontoContaReceberVO.getConvenio(), valorMatriculaConvenio, contaReceberGeradaMatricula);
							listaMatriculaBolsaCusteada.add(contaReceberGeradaMatricula);
						}
						matriculaPeriodoVO.setValorMatriculaBolsaCusteada(0.0);
				}
			}
		}else {
			for (ItemPlanoFinanceiroAlunoVO obj : (List<ItemPlanoFinanceiroAlunoVO>) matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()) {
				if (obj.getTipoItemPlanoFinanceiro().equals("CO") && obj.getRegerarConta()) {
						Uteis.checkState(contaReceberRegeradaComValorConvenio == null, "Ocorreu um erro ao tentar gerar a parcela de Matrícula do convênio " + obj.getConvenio().getDescricao() + " desta Matrícula " + matriculaVO.getMatricula() + ". Não foi possível determinar a base de cálculo da conta receber do aluno. Procure o administador do sistema.");	
						if (obj.getConvenio().getBolsaCusteadaParceiroMatricula().doubleValue() != 0.0) {
							boolean encontrouConvenio = false;
							for (PlanoDescontoContaReceberVO planoDesconto : contaReceberRegeradaComValorConvenio.getPlanoDescontoContaReceberVOs()) {
								if ((planoDesconto.getIsConvenio()) && (planoDesconto.getConvenio().getCodigo().equals(obj.getConvenio().getCodigo()))) {
									matriculaPeriodoVO.setValorMatriculaBolsaCusteada(planoDesconto.getValorUtilizadoRecebimento());
									encontrouConvenio = true;
									break;
								}
							}
							Uteis.checkState(!encontrouConvenio, "Ocorreu um erro ao tentar gerar a parcela de Matrícula do convênio " + obj.getConvenio().getDescricao() + " desta Matrícula " + matriculaVO.getMatricula() + ". Não foi encontrado o convênio na Conta Receber. Procure o administador do sistema.");
							Double valorMatriculaConvenio = matriculaPeriodoVO.getValorMatriculaBolsaCusteada();
							if (obj.getConvenio().getTipoBolsaCusteadaParceiroMatricula().equals("VA")) {
								valorMatriculaConvenio = obj.getConvenio().getBolsaCusteadaParceiroMatricula();
							}						
							ContaReceberVO contaReceberGeradaMatricula = matriculaPeriodoVO.montarMatriculaBolsaCusteada(matriculaPeriodoVO.getPlanoFinanceiroCurso(), configuracaoFinanceiro, matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, valorMatriculaConvenio, 0.0, 0, obj.getConvenio().getCodigo(), 0.0, 0.0, obj.getConvenio().getParceiro());
							validarDateVencimentoMaticulaConvenio(matriculaPeriodoVO, vctoGerarMatricula, obj.getConvenio(), valorMatriculaConvenio, contaReceberGeradaMatricula);
							listaMatriculaBolsaCusteada.add(contaReceberGeradaMatricula);
						}
						matriculaPeriodoVO.setValorMatriculaBolsaCusteada(0.0);
				}
			}
		}
		return listaMatriculaBolsaCusteada;
	}

	private void validarDateVencimentoMaticulaConvenio(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO vctoGerarMatricula, ConvenioVO convenio, Double valorMatriculaConvenio, ContaReceberVO contaReceberGeradaMatricula) throws Exception {
		if (!convenio.getCentroReceitaMatricula().getCodigo().equals(0)) {
			// Se no convenio foi informando um centro de
			// receita especial para a parcela do convenio,
			// referente ï¿½ matrícula, então temos que
			// setï¿½-lo na contaRecever Gerada. Recurso criado
			// na versão 5.0.1 para permitir que todas as contas
			// a receber de um determinado convenio
			// possam ser vinculada a um determinado convênio.
			contaReceberGeradaMatricula.setCentroReceita(convenio.getCentroReceitaMatricula());
		}
		if (convenio.getDiaBaseRecebimentoParceiro() != 0) {
			Date novaDataVcto = obterProximaDataVctoComDiaConvenio(contaReceberGeradaMatricula.getDataVencimento(), convenio.getDiaBaseRecebimentoParceiro());
			contaReceberGeradaMatricula.setDataVencimento(novaDataVcto);
		}
		boolean atualizouDataVctoContaReceberParaNaoGerarVencida = false;
		if (convenio.getGerarParcelasConvenioVencidasComDataAtaulizadaParaMesAtual()) {
			// Recurso criado na versão 5.0.1, no qual impedi
			// que uma parcela de convenio seja
			// gerada vencida. Ou seja, caso a data de vcto da
			// mesma esteja ultrapassada com relação
			// a data atual, então a mesma ï¿½ atualizada para a
			// préxima competencia (mï¿½s). Isto irá
			// impedir que uma parcela a receber seja gerada em
			// competencia que já tenha sido
			// contabilmente fechada.
			if (contaReceberGeradaMatricula.getDataVencimento().before(new Date())) {
				// Se entrarmos aqui ï¿½ por que a conta estão
				// vencida com relação a data
				// de hoje. Logo, teremos que atualizar seu
				// vencimento.
				Date novaDataVctoMatricula = obterProximaDataMantendoDiaVencimentoDataBase(contaReceberGeradaMatricula.getDataVencimento());
				contaReceberGeradaMatricula.setDataVencimento(novaDataVctoMatricula);
				contaReceberGeradaMatricula.setDataCompetencia(novaDataVctoMatricula);
				atualizouDataVctoContaReceberParaNaoGerarVencida = true;
			}
		}
		if(!convenio.getGerarRestituicaoAlunoValorJaPagoRelativoAoConvenio() && matriculaPeriodoVO.getContaPagarRestituicaoVO().getValor()>0 && vctoGerarMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)){
			matriculaPeriodoVO.getContaPagarRestituicaoVO().setValor(matriculaPeriodoVO.getContaPagarRestituicaoVO().getValor() - valorMatriculaConvenio);
		}
//						if (convenio.getGerarRestituicaoAlunoValorJaPagoRelativoAoConvenio()) {
//							// Se entrar aqui ï¿½ por que o convênio determina
//							// que seja gerada uma restituição
//							// para o aluno, referente ao valor que o aluno já
//							// tenha pago. Sendo assim,
//							// teremos que verificar se a conta já foi paga,
//							// caso tenha sido o valor referente
//							// ao convênio deverï¿½ ser acumulado para ser
//							// totalizado e gerenciado para ser
//							// restituï¿½do ao aluno, por meio de uma conta a
//							// pagar.
//							if (vctoGerarMatricula.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) {
//								// Como a parcela de matrícula estão paga, então
//								// vamos acumular o valor para restituição
//								// como estamos na matrícula, o valor pode ser
//								// inicializado com o valor da matrícula.
//								// Contudo, antes de somar este valor para ser
//								// restituï¿½do, temos que avaliar uma outra
//								// situação que refere-se a quando esta conta
//								// foi paga. Por exemplo, se esta conta que foi
//								// paga, foi paga depois que o convenio foi
//								// adicionado para a matriculaPeriodo do aluno,
//								// então, significa que quando o aluno pagou
//								// esta conta, a mesma já estava com o desconto
//								// relativo ao convênio. Assim, não
//								// podemos/devemos devolver o dinheiro desta
//								// parcela para
//								// o aluno.
//								ContaReceberVO contaReceberPagaVO = vctoGerarMatricula.getContaReceber();
//								boolean valorDescontoJaFoiAbatidoContaReceberOrigem = false;
//								for (PlanoDescontoContaReceberVO planoContaReceber : contaReceberPagaVO.getPlanoDescontoContaReceberVOs()) {
//									if ((planoContaReceber.getIsConvenio()) && (planoContaReceber.getConvenio().getCodigo().equals(convenio.getCodigo()))) {
//										// Encontramos um PlanoContaReceberVO do
//										// convenio que estamos processando.
//										// Caso o valor referido ao mesmo já
//										// conste como abatido da conta a
//										// receber,
//										// significa que o aluno já pagou a
//										// conta com o desconto do convênio.
//										// Logo, não
//										// temos que restituir mais este valor
//										// para o aluno.
//										if (planoContaReceber.getValorUtilizadoRecebimento().doubleValue() > 0.0) {
//											valorDescontoJaFoiAbatidoContaReceberOrigem = true;
//										}
//									}
//								}
//								if (!valorDescontoJaFoiAbatidoContaReceberOrigem) {
//									// Se chegarmos aqui ï¿½ por que temos que
//									// verificar e gerar uma conta a pagar
//									// para restituir o aluno com relação a
//									// parcela da matrícula que ele pagou,
//									// antes de ter utilizado o convênio.
//									Date dataVctoContaPagar = contaReceberGeradaMatricula.getDataVencimento();
//									if (!atualizouDataVctoContaReceberParaNaoGerarVencida) {
//										// se a dataVcto da conta receber pode
//										// ser gerada como vencida, o mesmo nao
//										// pode
//										// ocorrer com a data da conta a pagar
//										// de restituição. desta maneira, caso a
//										// data
//										// de vcto da conta a receber nao foi
//										// atualizada, vamos chamar o Método
//										// abaixo que
//										// deduz a préxima data vï¿½lida, com
//										// relação a data atual.
//										dataVctoContaPagar = obterProximaDataMantendoDiaVencimentoDataBase(contaReceberGeradaMatricula.getDataVencimento());
//									}
//									gerarContaPagarRestituirAlunoValorJaPagoParcelaEspecifica(dataVctoContaPagar, valorMatriculaConvenio, vctoGerarMatricula, matriculaVO, matriculaPeriodoVO, convenio, usuarioVO);
//								}
//							}
//		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void criarContaReceberBolsaCusteadaMatricula(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, ConfiguracaoFinanceiroVO configFinan, MatriculaPeriodoVencimentoVO parcelaMatricula, ContaReceberVO contaReceberAlunoBaseGeracaoConvenio, UsuarioVO usuario) throws Exception {
		Boolean regerarConta = realizarVerificacaoConvenioNaoPagoParaNovaGeracao(matriculaVO, matriculaPeriodoVO, parcelaMatricula);
		if(regerarConta){
			getFacadeFactory().getContaReceberFacade().excluirContasReceberTipoOrigemCodigoOrigem("BCC", matriculaPeriodoVO.getCodigo(), "AR", TipoOrigemContaReceber.MATRICULA.getDescricao(), !matriculaPeriodoVO.getBloqueioPorFechamentoMesLiberado(),  usuario);
			List listaMatriculaBolsaCusteada = criarListaContaReceberBolsaCusteadaMatricula(matriculaVO, matriculaPeriodoVO, parcelaMatricula, processoMatriculaCalendarioVO, configFinan, usuario);
			Iterator<ContaReceberVO> i = listaMatriculaBolsaCusteada.iterator();
			while (i.hasNext()) {
				ContaReceberVO obj = (ContaReceberVO) i.next();
				obj.setConfiguracaoFinanceiro(configFinan);

				Integer descontoProgressivoParceiro = verificarSeContaASerGeradaPossuiConvenioComDescontoDeAntecipacaoParceiro(matriculaVO, obj.getConvenio().getCodigo(), "Matrícula");
				if (descontoProgressivoParceiro != 0) {
					obj.getDescontoProgressivo().setCodigo(descontoProgressivoParceiro);
				}
				ContaReceber.montarListaDescontosAplicaveisContaReceber(obj, Uteis.getDataPassadaPorDataAtual(730), false, configFinan, usuario, 0);
				obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(obj.getValor());
				obj.setValorDescontoCalculadoSegundaFaixaDescontos(obj.getValor());
				obj.setValorDescontoCalculadoTerceiraFaixaDescontos(obj.getValor());
				obj.setValorDescontoCalculadoQuartaFaixaDescontos(obj.getValor());
				if (obj.getListaDescontosAplicavesContaReceber().size() >= 1) {
					obj.setValorDescontoCalculadoPrimeiraFaixaDescontos(obj.getListaDescontosAplicavesContaReceber().get(0).getValorBaseComDescontosJaCalculadosAplicados());
				}
				if (obj.getListaDescontosAplicavesContaReceber().size() >= 2) {
					obj.setValorDescontoCalculadoSegundaFaixaDescontos(obj.getListaDescontosAplicavesContaReceber().get(1).getValorBaseComDescontosJaCalculadosAplicados());
				}
				if (obj.getListaDescontosAplicavesContaReceber().size() >= 3) {
					obj.setValorDescontoCalculadoTerceiraFaixaDescontos(obj.getListaDescontosAplicavesContaReceber().get(2).getValorBaseComDescontosJaCalculadosAplicados());
				}
				if (obj.getListaDescontosAplicavesContaReceber().size() >= 4) {
					obj.setValorDescontoCalculadoQuartaFaixaDescontos(obj.getListaDescontosAplicavesContaReceber().get(3).getValorBaseComDescontosJaCalculadosAplicados());
				}
				getFacadeFactory().getContaReceberFacade().incluir(obj, false, configFinan, usuario);
				obj = null;
			}
			Uteis.liberarListaMemoria(listaMatriculaBolsaCusteada);	
		}
	}

	// public void alterarGerandoContasReceber(MatriculaPeriodoVO obj,
	// MatriculaVO matricula, ProcessoMatriculaCalendarioVO
	// processoMatriculaCalendarioVO, CondicaoPagamentoPlanoFinanceiroCursoVO
	// condicao) throws Exception {
	// if (obj.getSituacao().equals("PF") &&
	// matricula.getSituacao().equals("PL")) {
	// criarContaReceber(matricula, obj, processoMatriculaCalendarioVO,
	// condicao);
	// getFacadeFactory().getMatriculaFacade().alterarSituacaoMatricula(matricula.getMatricula(),
	// "AT");
	// alterar(obj);
	// }
	// }
	/**
	 * Operação Responsável por alterar no BD os dados de um objeto da classe
	 * <code>MatriculaPeriodoVO</code>. Sempre utiliza a chave primária da
	 * classe como atributo para localização do registro a ser alterado.
	 * Primeiramente valida os dados (<code>validarDados</code>) do objeto.
	 * Verifica a conexão com o banco de dados e a permissão do usuário para
	 * realizar esta operação na entidade. Isto, através da operação
	 * <code>alterar</code> da superclasse.
	 * 
	 * @param obj
	 *            Objeto da classe <code>MatriculaPeriodoVO</code> que será
	 *            alterada no banco de dados.
	 * @exception Execption
	 *                Caso haja problemas de conexão, restrição de acesso ou
	 *                validação de dados.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarPeriodoLetivoGradeCurricular(final Integer matriculaPeriodo, final Integer periodoLetivo, final Integer gradeCurricularMigrar) throws Exception {
		final String sql = "UPDATE MatriculaPeriodo set gradeCurricular=?, periodoLetivoMatricula = ?  WHERE ((codigo = ?))";
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
				if (gradeCurricularMigrar.intValue() != 0) {
					sqlAlterar.setInt(1, gradeCurricularMigrar.intValue());
				} else {
					sqlAlterar.setNull(1, 0);
				}
				if (periodoLetivo.intValue() != 0) {
					sqlAlterar.setInt(2, periodoLetivo.intValue());
				} else {
					sqlAlterar.setNull(2, 0);
				}
				sqlAlterar.setInt(3, matriculaPeriodo.intValue());
				return sqlAlterar;
			}
		});
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarPeriodoLetivoGradeCurricularPorMatriculaPeriodoTurma(TurmaVO turmaVO,  String situacaoMatricula, String situacaoMatriculaPeriodo, List<MatriculaPeriodoVO> listaMatriculaPeriodoVO, UsuarioVO usuarioVO, Boolean realizandoTransferenciaMatrizCurricularPelaTurma) throws Exception {
		StringBuilder sql = new StringBuilder("UPDATE MatriculaPeriodo set gradeCurricular = ").append(turmaVO.getGradeCurricularVO().getCodigo());
		sql.append(", periodoLetivoMatricula = ").append(turmaVO.getPeridoLetivo().getCodigo()).append(" ");
		if (!listaMatriculaPeriodoVO.isEmpty()) {
			sql.append("WHERE codigo in(" + listaMatriculaPeriodoVO.stream().map(l -> l.getCodigo().toString()).collect(Collectors.joining(",")) + ")");
		} else {
			sql.append("WHERE codigo in( SELECT MatriculaPeriodo.codigo FROM MatriculaPeriodo ");
			sql.append("INNER JOIN Matricula ON (MatriculaPeriodo.matricula = Matricula.matricula) ");
			sql.append("WHERE MatriculaPeriodo.turma = ").append(turmaVO.getCodigo());
			if (turmaVO.getUnidadeEnsino().getCodigo() != null && !turmaVO.getUnidadeEnsino().getCodigo().equals(0)) {
				sql.append(" AND matricula.unidadeensino = ").append(turmaVO.getUnidadeEnsino().getCodigo());
			}
			if(Uteis.isAtributoPreenchido(situacaoMatricula)){
				sql.append(" AND matricula.situacao = '").append(situacaoMatricula).append("' ");
			}
			if(Uteis.isAtributoPreenchido(situacaoMatriculaPeriodo)){
				sql.append(" AND matriculaPeriodo.situacaoMatriculaPeriodo = '").append(situacaoMatriculaPeriodo).append("' ");
			}
			if (realizandoTransferenciaMatrizCurricularPelaTurma) {
//			sql.append(" and not exists (");
//			sql.append(" select  transferenciamatrizcurricularmatricula.codigo from transferenciamatrizcurricularmatricula where matriculaperiodo.codigo = transferenciamatrizcurricularmatricula.matriculaperiodo ");
//			sql.append(" )");
				sql.append(" AND matriculaPeriodo.gradecurricular = matricula.gradecurricularatual");
			}
			sql.append(" ) ");
		}
		sql.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
		getConexao().getJdbcTemplate().update(sql.toString());
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterar(final MatriculaPeriodoVO obj, MatriculaVO matriculaVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		// //System.out.println("===================:5" + new Date() +
		// "===========================");
		// MatriculaPeriodoVO.validarDados(obj);
		try {
			inicializarDadosAnoSemestreMatricula(obj, processoMatriculaCalendarioVO, false);
			final String sql = "UPDATE MatriculaPeriodo set data=?, situacao=?, matricula=?, gradeCurricular=?, periodoLetivoMatricula = ?, responsavelRenovacaoMatricula=?, turma=?, " + "responsavelLiberacaoMatricula=?, dataLiberacaoMatricula=?, responsavelEmissaoBoletoMatricula = ?, dataEmissaoBoletoMatricula = ?, contaReceber = ?, nrDocumento = ?, " + "unidadeEnsinoCurso = ?, turmaPeriodo =?, semestre=?, ano=?, responsavelMatriculaForaPrazo=?, situacaoMatriculaPeriodo=?, processoMatricula=?, transferenciaEntrada=?, " + "contratoMatricula=?, planoFinanceiroCurso=?, condicaoPagamentoPlanoFinanceiroCurso=?, matriculaPeriodoPreMatricula=?, nrDisciplinasIncluidas=?, nrDisciplinasExcluidas=?, " + "financeiroManual=?, contratoFiador=?, reconheceuDivida=?, carneEntregue=?, bolsista=?, contratoExtensao=?, alunoTransferidoUnidade=?, aceitouTermoContratoRenovacaoOnline=?, matriculaEspecial=?, dataBaseGeracaoParcelas=?,categoriaCondicaoPagamento=?, dataVencimentoMatriculaEspecifico=?  WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
				sqlAlterar.setDate(1, Uteis.getDataJDBC(obj.getData()));
				sqlAlterar.setString(2, obj.getSituacao());
				sqlAlterar.setString(3, obj.getMatricula());
				if (obj.getGradeCurricular().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(4, obj.getGradeCurricular().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(4, 0);
				}
				if (obj.getPeridoLetivo().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(5, obj.getPeridoLetivo().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(5, 0);
				}
				if (obj.getResponsavelRenovacaoMatricula().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(6, obj.getResponsavelRenovacaoMatricula().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(6, 0);
				}
				if (obj.getTurma().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(7, obj.getTurma().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(7, 0);
				}
				if (obj.getResponsavelLiberacaoMatricula().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(8, obj.getResponsavelLiberacaoMatricula().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(8, 0);
				}
				sqlAlterar.setDate(9, Uteis.getDataJDBC(obj.getDataLiberacaoMatricula()));
				if (obj.getResponsavelEmissaoBoletoMatricula().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(10, obj.getResponsavelEmissaoBoletoMatricula().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(10, 0);
				}
				sqlAlterar.setDate(11, Uteis.getDataJDBC(obj.getDataEmissaoBoletoMatricula()));
				// if (obj.getContaReceber().intValue() != 0) {
				// sqlAlterar.setInt(12, obj.getContaReceber().intValue());
				// } else {
				// sqlAlterar.setNull(12, 0);
				// }
				sqlAlterar.setNull(12, 0);
				sqlAlterar.setString(13, obj.getNrDocumento());
				if (obj.getUnidadeEnsinoCurso().intValue() != 0) {
					sqlAlterar.setInt(14, obj.getUnidadeEnsinoCurso().intValue());
				} else {
					sqlAlterar.setNull(14, 0);
				}
				if (obj.getTurmaPeriodo().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(15, obj.getTurmaPeriodo().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(15, 0);
				}
				sqlAlterar.setString(16, obj.getSemestre());
				sqlAlterar.setString(17, obj.getAno());
				if (obj.getResponsavelMatriculaForaPrazo().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(18, obj.getResponsavelMatriculaForaPrazo().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(18, 0);
				}
				sqlAlterar.setString(19, obj.getSituacaoMatriculaPeriodo());
				if (Uteis.isAtributoPreenchido(obj.getProcessoMatricula())) {
					sqlAlterar.setInt(20, obj.getProcessoMatricula().intValue());
				} else {
					sqlAlterar.setNull(20, 0);
				}
				if (obj.getTranferenciaEntrada().intValue() != 0) {
					sqlAlterar.setInt(21, obj.getTranferenciaEntrada().intValue());
				} else {
					sqlAlterar.setNull(21, 0);
				}
				if (obj.getContratoMatricula().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(22, obj.getContratoMatricula().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(22, 0);
				}
				if (obj.getPlanoFinanceiroCurso().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(23, obj.getPlanoFinanceiroCurso().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(23, 0);
				}
				if (obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(24, obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(24, 0);
				}
				if (obj.getMatriculaPeriodoPreMatricula().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(25, obj.getMatriculaPeriodoPreMatricula().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(25, 0);
				}
				sqlAlterar.setInt(26, obj.getNrDisciplinasIncluidas());
				sqlAlterar.setInt(27, obj.getNrDisciplinasExcluidas());
				sqlAlterar.setBoolean(28, obj.getFinanceiroManual());
				if (obj.getContratoFiador().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(29, obj.getContratoFiador().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(29, 0);
				}
				sqlAlterar.setBoolean(30, obj.getReconheceuDivida());
				sqlAlterar.setBoolean(31, obj.getCarneEntregue());
				sqlAlterar.setBoolean(32, obj.getBolsista());
				if (obj.getContratoExtensao().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(33, obj.getContratoExtensao().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(33, 0);
				}
				sqlAlterar.setBoolean(34, obj.getAlunoTransferidoUnidade());
				sqlAlterar.setBoolean(35, obj.getAceitouTermoContratoRenovacaoOnline());
				sqlAlterar.setBoolean(36, obj.getMatriculaEspecial());
				int i=36;
				Uteis.setValuePreparedStatement(obj.getDataBaseGeracaoParcelas(), Types.DATE, ++i, sqlAlterar);
                Uteis.setValuePreparedStatement(obj.getCategoriaCondicaoPagamento(), ++i, sqlAlterar);
                Uteis.setValuePreparedStatement(obj.getDataVencimentoMatriculaEspecifico(),  Types.DATE, ++i, sqlAlterar);
                Uteis.setValuePreparedStatement(obj.getCodigo(), ++i, sqlAlterar);
				return sqlAlterar;
			}
			});
		
		
			Boolean regerarFinanceiro = obj.getCondicaoPagamentoPlanoFinanceiroCurso().getRegerarFinanceiro();
			if (regerarFinanceiro || obj.getVindoTelaAlteracaoPlanoFinanceiroAluno()) {
				// Metodo Responsável por obter as contas a receber que foram enviadas em remessa bancaria, que ainda estão com situacao A RECEBER.
				//List<ContaReceberVO> listaContaReceberRemetida = getFacadeFactory().getContaReceberFacade().consultaContasAReceberQuePossuiRemessaGerada(obj.getCodigo(), configuracaoFinanceiro, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				// Metodo Responsável por obter os controle remessa contas a receber da remessa bancaria.
				//List<ControleRemessaContaReceberVO> listaControleRemessaContaReceber = getFacadeFactory().getControleRemessaContaReceberFacade().consultaRapidaContasArquivoRemessaPorCodigoMatriculaPeriodo(obj.getCodigo(), usuario);
				// Limpa vinculo controleremessa com conta a receber
				// AQUI 
				//getFacadeFactory().getControleRemessaContaReceberFacade().removerVinculoContaReceber(obj.getCodigo(), usuario);
				//getFacadeFactory().getProcessamentoArquivoRetornoParceiroExcelFacade().removerVinculoContaReceber(obj.getCodigo(), SituacaoContaReceber.A_RECEBER, usuario);

				//verificarEAlterarContaReceberEditasManualmenteConformeDefinicaoUsuario(obj, usuario);

				gravarMatriculaPeriodoTurmaDisciplinaAcordoSituacaoAcademica(matriculaVO, obj, configuracaoFinanceiro, usuario);
//				obj.getContaReceberNotaFiscalEmitidaVOs().clear();

//				if ((obj.getSituacaoMatriculaPeriodo().equals(SituacaoMatriculaPeriodoEnum.ATIVA.getValor()) || obj.getSituacaoMatriculaPeriodo().equals(SituacaoMatriculaPeriodoEnum.PRE_MATRICULA.getValor()))) {
//
//					if (obj.getInclusaoForaPrazo()) {
//						gerarContarReceberInclusaoForaPrazo(matriculaVO, obj, new ArrayList<MatriculaPeriodoTurmaDisciplinaVO>(0), obj.getNumParcelasInclusaoForaPrazo(), obj.getValorTotalParcelaInclusaoForaPrazo(), null, null, configuracaoFinanceiro, usuario);
//					} else {
//						gerenciarParcelasMatriculaPeriodo(matriculaVO, obj, processoMatriculaCalendarioVO, configuracaoFinanceiro, usuario);
//						
//						if(!matriculaVO.getBloqueioPorSolicitacaoLiberacaoMatricula()) {
//							processarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVO, obj, processoMatriculaCalendarioVO, null, null, configuracaoFinanceiro, usuario, false);
//						}
//						atualizarSituacaoFinanceiraMatriculaPeriodo(matriculaVO, obj, configuracaoFinanceiro,usuario);
//					}
//				}
//				verificarEExcluirRestituicoesContaAReceberRelativasAConveniosExcluidosMatriculaPeriodo(matriculaVO, obj, usuario);
//				realizarDefinicaoContaPagarRestituicaoAluno(obj, usuario);
				atualizarSituacaoTransferenciaMatrizCurricularQuandoMigrandoDisciplinaCursandoPorCorrespodencia(obj, usuario);
//				getFacadeFactory().getContaReceberFacade().realizarVinculoNotaFiscalSaidaContaReceberPorNossoNumero(obj.getContaReceberNotaFiscalEmitidaVOs(), usuario);
				// Metodo Responsável por comparar a listagem de contas que tiveram remessa enviada antes de realizar alteração na matricula periodo, 
				// e que sofrem alteração no valor, datavencimento ou descontos, de forma que marque na conta a receber um booleano para determinar que a mesma possuia remessa e foi alterada.
				// Caso a conta nao tenha sofrido alteração esse booleano não é marcado.
//				getFacadeFactory().getContaReceberFacade().verificarContasRemetidasQueTiveramAlteracao(obj.getCodigo(), matriculaVO, listaContaReceberRemetida, obj.getMatriculaPeriodoVencimentoVOs(), listaControleRemessaContaReceber, configuracaoFinanceiro, usuario);
				// Voltar Vinculo do controle remessa conta receber com a conta a receber.
//				getFacadeFactory().getContaReceberFacade().realizaVinculoContaReceberComControleRemessaContaReceber(obj.getMatriculaPeriodoVencimentoVOs(), usuario);
//				getFacadeFactory().getContaReceberFacade().realizaVinculoContaReceberConvenioComControleRemessaContaReceber(obj.getCodigo(), usuario);
//				Collections.sort(obj.getMatriculaPeriodoVencimentoVOs(), OrdenarMatriculaPeriodoVencimentoEnum.DATA_VENCIMENTO_AND_TIPO_ORIGEM.asc());
				//Ordenacao.ordenarLista(obj.getMatriculaPeriodoVencimentoVOs(), "dataVencimento");
			} else {
				gravarMatriculaPeriodoTurmaDisciplinaAcordoSituacaoAcademica(matriculaVO, obj, configuracaoFinanceiro, usuario);
				atualizarSituacaoTransferenciaMatrizCurricularQuandoMigrandoDisciplinaCursandoPorCorrespodencia(obj, usuario);
			}
//			realizarExecucaoRegrasContaIntegracaoPorMatricula(matriculaVO, obj, usuario, true);
		} catch (Exception e) { 
			if (e.getMessage().contains("(Competência Fechada)")) {
				// Se tivemos um erro de bloqueio de competencia (seja na conta a receber ou outra entidade. Iremos replicar esse
				// bloqueio para a MatriculaPeriodoVO. Assim, o usuário poderá visualizar o botao de liberacao de competencia fechada (FechamentoMes)
				// e seguir o fluxo posteriormente.
				ConsistirException cEx = (ConsistirException)e;
				obj.forcarControleBloqueioCompetencia(e.getMessage(), cEx.getObjetoOrigem().getFechamentoMesVOBloqueio(), cEx.getObjetoOrigem().getFechamentoMesVOBloqueio().getDataBloqueioVerificada());
			}
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void verificarEExcluirRestituicoesContaAReceberRelativasAConveniosExcluidosMatriculaPeriodo(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodo, UsuarioVO usuario) throws Exception {
		for (ConvenioVO convenio : matriculaPeriodo.getListaConvenioRemoverContaPagarRestituicaoAluno()) {
			Integer convenioRemover = convenio.getCodigo();
			// Excluindo as contas a pagar (restituiï¿½ï¿½es) que ainda existam,
			// relacionadas ao convenio
			// excluï¿½do
			getFacadeFactory().getContaPagarFacade().excluirContasPagarMatriculaPeriodoConvenio(matricula.getMatricula(), matriculaPeriodo.getCodigo(), convenioRemover, usuario);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarReconheceuDivida(MatriculaVO matriculaVO) throws Exception {
		for (MatriculaPeriodoVO matriculaPeriodoVO : matriculaVO.getMatriculaPeriodoVOs()) {
			// if (matriculaPeriodoVO.getPossuiDivida()) {
			String sql = "UPDATE MatriculaPeriodo set reconheceuDivida=?, carneEntregue=? WHERE ((codigo = ?))";
			getConexao().getJdbcTemplate().update(sql, new Object[] { matriculaPeriodoVO.getReconheceuDivida(), matriculaPeriodoVO.getCarneEntregue(), matriculaPeriodoVO.getCodigo() });
			// }
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarPeriodoLetivo(Integer periodoLetivo, Integer matriculaPeriodo) throws Exception {
		String sql = "UPDATE MatriculaPeriodo set periodoLetivoMatricula=? WHERE ((codigo = ?))";
		getConexao().getJdbcTemplate().update(sql, new Object[] { periodoLetivo, matriculaPeriodo });
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarCondicaoPagamentoPlanoFinanceiroCurso(Integer condicaoPagamentoPlanoFinanceiroCursoVO, Integer planoFinanceiroCurso, Integer codigoContratoMatricula, Integer matriculaPeriodo, UsuarioVO usuario) throws Exception {
		String sql = "UPDATE MatriculaPeriodo set condicaoPagamentoPlanoFinanceiroCurso=?, planofinanceirocurso = ?,  contratoMatricula=? WHERE ((codigo = ?))"+adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql, new Object[] { condicaoPagamentoPlanoFinanceiroCursoVO, planoFinanceiroCurso, codigoContratoMatricula, matriculaPeriodo });
	}	

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoFinanceiraMatriculaPeriodo(Integer matriculaPeriodo, String situacao) throws Exception {
		String sql = "UPDATE MatriculaPeriodo set situacao=? WHERE ((codigo = ?))";
		getConexao().getJdbcTemplate().update(sql, new Object[] { situacao, matriculaPeriodo });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoFinanceiraMatriculaPeriodoProcessandoAtivacaoDaMesma(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		String sql = "UPDATE MatriculaPeriodo set situacao=?, situacaoMatriculaPeriodo=? WHERE ((codigo = ?))";
		getConexao().getJdbcTemplate().update(sql, new Object[] { matriculaPeriodoVO.getSituacao(), matriculaPeriodoVO.getSituacaoMatriculaPeriodo(), matriculaPeriodoVO.getCodigo() });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoMatriculaPeriodoComUsuarioResponsavel(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		String sql = "UPDATE MatriculaPeriodo set situacao=?, situacaoMatriculaPeriodo=?, usuarioResponsavelConfirmacaoOuCancelamentoPreMatricula=? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql, new Object[] { matriculaPeriodoVO.getSituacao(), matriculaPeriodoVO.getSituacaoMatriculaPeriodo(), usuario.getCodigo(), matriculaPeriodoVO.getCodigo() });
	}

//	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
//	public void gerarMatriculaInclusaoForaPrazoLista(MatriculaVO matricula, List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaAdicionadaVOs, List<MatriculaPeriodoVO> lista, InclusaoHistoricoForaPrazoVO inclusaoHistoricoForaPrazoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
//		MatriculaPeriodoVO mat = new MatriculaPeriodoVO();
//		for (MatriculaPeriodoVO matPer : lista) {
//			// mat.setInclusaoForaPrazo(Boolean.TRUE);
//			alterarMatriculaForaPrazo(matPer, matricula, null, configuracaoFinanceiroVO, usuario);
//			mat = matPer;
//		}
//		getFacadeFactory().getInclusaoHistoricoForaPrazoFacade().incluir(inclusaoHistoricoForaPrazoVO, lista);
//		if (mat.getInclusaoForaPrazo() && (!configuracaoFinanceiroVO.getUtilizaPlanoFinanceiroInclusao()) || mat.getReposicao() && !configuracaoFinanceiroVO.getUtilizaPlanoFinanceiroReposicao()) {
//			gerarContarReceberInclusaoForaPrazo(matricula, mat, listaDisciplinaAdicionadaVOs, mat.getNumParcelasInclusaoForaPrazo(), mat.getValorTotalParcelaInclusaoForaPrazo(), inclusaoHistoricoForaPrazoVO, null, configuracaoFinanceiroVO, usuario);
//		} else if (configuracaoFinanceiroVO.getUtilizaPlanoFinanceiroReposicao() || configuracaoFinanceiroVO.getUtilizaPlanoFinanceiroInclusao()) {
//			gerarContarReceberAPartirPlanoFinanceiroReposicao(matricula, mat, inclusaoHistoricoForaPrazoVO, null, configuracaoFinanceiroVO, usuario);
//		}
//
//	}

	public void gerarMatriculaInclusaoForaPrazo(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		try {
			// List listaDisciplinasComVagasUltrapassadas =
			// getFacadeFactory().getMatriculaPeriodoFacade().verificarExistenciaVagasMaximaTurmaDisciplina(matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs());
			// List listaDisciplinasSemVagas =
			// getFacadeFactory().getMatriculaPeriodoFacade().verificarExistenciaVagasTurmaDisciplina(matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs());
			// if (listaDisciplinasComVagasUltrapassadas.isEmpty() &&
			// listaDisciplinasSemVagas.isEmpty()) {
			matriculaPeriodo.setInclusaoForaPrazo(Boolean.TRUE);
			alterarMatriculaForaPrazo(matriculaPeriodo, matricula, null, configuracaoFinanceiroVO, matricula.getGradeCurricularAtual(), usuario);
			// }
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirMatriculaPeriodoTurmaDisciplina(boolean incluindaPeloPagamentoRequerimento, InclusaoHistoricoForaPrazoVO inclusaoHistoricoForaPrazoVO, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinaVOs, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, GradeCurricularVO gradeCurricularVO, UsuarioVO usuarioVO) throws Exception {
		TurmaVO turma = null;
		for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : listaMatriculaPeriodoTurmaDisciplinaVOs) {
			if (turma == null) {
				turma = matriculaPeriodoTurmaDisciplinaVO.getTurma();
			}
			getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().incluir(matriculaPeriodoTurmaDisciplinaVO.getMatriculaObjetoVO(), matriculaPeriodoTurmaDisciplinaVO.getMatriculaPeriodoObjetoVO(), matriculaPeriodoTurmaDisciplinaVO, configuracaoFinanceiroVO, gradeCurricularVO, usuarioVO);
		}
		if(!incluindaPeloPagamentoRequerimento) {
		if (matriculaPeriodoVO.getInclusaoForaPrazo() && (!configuracaoFinanceiroVO.getUtilizaPlanoFinanceiroInclusao()) || matriculaPeriodoVO.getReposicao() && !configuracaoFinanceiroVO.getUtilizaPlanoFinanceiroReposicao()) {
			gerarContarReceberInclusaoForaPrazo(matriculaVO, matriculaPeriodoVO, listaMatriculaPeriodoTurmaDisciplinaVOs, matriculaPeriodoVO.getNumParcelasInclusaoForaPrazo(), matriculaPeriodoVO.getValorTotalParcelaInclusaoForaPrazo(), inclusaoHistoricoForaPrazoVO, turma, configuracaoFinanceiroVO, usuarioVO);
		} else if (configuracaoFinanceiroVO.getUtilizaPlanoFinanceiroReposicao() || configuracaoFinanceiroVO.getUtilizaPlanoFinanceiroInclusao()) {
			gerarContarReceberAPartirPlanoFinanceiroReposicao(matriculaVO, matriculaPeriodoVO, inclusaoHistoricoForaPrazoVO, turma, configuracaoFinanceiroVO, usuarioVO);
		}
		}
		
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)	
	public void gerarInclusaoForaPrazo(boolean incluindaPeloPagamentoRequerimento,InclusaoHistoricoForaPrazoVO inclusaoHistoricoForaPrazoVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinaVOs, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, GradeCurricularVO gradeCurricularVO, UsuarioVO usuarioVO) throws Exception {
		getFacadeFactory().getInclusaoHistoricoForaPrazoFacade().incluir(inclusaoHistoricoForaPrazoVO);
		incluirMatriculaPeriodoTurmaDisciplina(incluindaPeloPagamentoRequerimento, inclusaoHistoricoForaPrazoVO, matriculaVO, matriculaPeriodoVO, listaMatriculaPeriodoTurmaDisciplinaVOs, configuracaoFinanceiroVO, gradeCurricularVO, usuarioVO);

	}

	/**
	 * Operação Responsável por alterar no BD os dados de um objeto da classe
	 * <code>MatriculaPeriodoVO</code>. Sempre utiliza a chave primária da
	 * classe como atributo para localização do registro a ser alterado.
	 * Primeiramente valida os dados (<code>validarDados</code>) do objeto.
	 * Verifica a conexão com o banco de dados e a permissão do usuário para
	 * realizar esta operação na entidade. Isto, através da operação
	 * <code>alterar</code> da superclasse.
	 * 
	 * @param obj
	 *            Objeto da classe <code>MatriculaPeriodoVO</code> que será
	 *            alterada no banco de dados.
	 * @exception Execption
	 *                Caso haja problemas de conexão, restrição de acesso ou
	 *                validação de dados.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarMatriculaForaPrazo(final MatriculaPeriodoVO obj, MatriculaVO matriculaVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, GradeCurricularVO gradeCurricularVO, UsuarioVO usuario) throws Exception {
		final String sql = "UPDATE MatriculaPeriodo set data=?, situacao=?, matricula=?, gradeCurricular=?, periodoLetivoMatricula = ?, responsavelRenovacaoMatricula=?, turma=?, " + "responsavelLiberacaoMatricula=?, dataLiberacaoMatricula=?, responsavelEmissaoBoletoMatricula = ?, dataEmissaoBoletoMatricula = ?, contaReceber = ?, nrDocumento = ?, " + "unidadeEnsinoCurso = ?, turmaPeriodo =?, semestre=?, ano=?, responsavelMatriculaForaPrazo=?, situacaoMatriculaPeriodo=?, processoMatricula=?, transferenciaEntrada=?, " + "contratoMatricula=?, planoFinanceiroCurso=?, condicaoPagamentoPlanoFinanceiroCurso=?, nrDisciplinasIncluidas=?, nrDisciplinasExcluidas=?, contratoFiador=?, reconheceuDivida=?, carneEntregue=?, matriculaEspecial=?, categoriaCondicaoPagamento=?  WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
				sqlAlterar.setDate(1, Uteis.getDataJDBC(obj.getData()));
				sqlAlterar.setString(2, obj.getSituacao());
				sqlAlterar.setString(3, obj.getMatricula());
				if (obj.getGradeCurricular().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(4, obj.getGradeCurricular().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(4, 0);
				}
				if (obj.getPeridoLetivo().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(5, obj.getPeridoLetivo().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(5, 0);
				}
				if (obj.getResponsavelRenovacaoMatricula().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(6, obj.getResponsavelRenovacaoMatricula().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(6, 0);
				}
				if (obj.getTurma().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(7, obj.getTurma().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(7, 0);
				}
				if (obj.getResponsavelLiberacaoMatricula().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(8, obj.getResponsavelLiberacaoMatricula().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(8, 0);
				}
				sqlAlterar.setDate(9, Uteis.getDataJDBC(obj.getDataLiberacaoMatricula()));
				if (obj.getResponsavelEmissaoBoletoMatricula().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(10, obj.getResponsavelEmissaoBoletoMatricula().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(10, 0);
				}
				sqlAlterar.setDate(11, Uteis.getDataJDBC(obj.getDataEmissaoBoletoMatricula()));
				sqlAlterar.setNull(12, 0);
				sqlAlterar.setString(13, obj.getNrDocumento());
				if (obj.getUnidadeEnsinoCurso().intValue() != 0) {
					sqlAlterar.setInt(14, obj.getUnidadeEnsinoCurso().intValue());
				} else {
					sqlAlterar.setNull(14, 0);
				}
				if (obj.getTurmaPeriodo().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(15, obj.getTurmaPeriodo().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(15, 0);
				}
				sqlAlterar.setString(16, obj.getSemestre());
				sqlAlterar.setString(17, obj.getAno());
				if (obj.getResponsavelMatriculaForaPrazo().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(18, obj.getResponsavelMatriculaForaPrazo().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(18, 0);
				}
				sqlAlterar.setString(19, obj.getSituacaoMatriculaPeriodo());
				if (obj.getProcessoMatricula().intValue() != 0) {
					sqlAlterar.setInt(20, obj.getProcessoMatricula().intValue());
				} else {
					sqlAlterar.setNull(20, 0);
				}
				if (obj.getTranferenciaEntrada().intValue() != 0) {
					sqlAlterar.setInt(21, obj.getTranferenciaEntrada().intValue());
				} else {
					sqlAlterar.setNull(21, 0);
				}
				if (obj.getContratoMatricula().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(22, obj.getContratoMatricula().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(22, 0);
				}
				if (obj.getPlanoFinanceiroCurso().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(23, obj.getPlanoFinanceiroCurso().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(23, 0);
				}
				if (obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(24, obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(24, 0);
				}
				sqlAlterar.setInt(25, obj.getNrDisciplinasIncluidas());
				sqlAlterar.setInt(26, obj.getNrDisciplinasExcluidas());
				if (obj.getContratoMatricula().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(27, obj.getContratoMatricula().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(27, 0);
				}
				sqlAlterar.setBoolean(28, obj.getReconheceuDivida());
				sqlAlterar.setBoolean(29, obj.getCarneEntregue());
				sqlAlterar.setBoolean(30, obj.getMatriculaEspecial());
				sqlAlterar.setString(31, obj.getCategoriaCondicaoPagamento());
				sqlAlterar.setInt(32, obj.getCodigo().intValue());
				return sqlAlterar;
			}
		});
		getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().incluirMatriculaPeriodosForaPrazo(obj.getCodigo(), obj.getMatricula(), obj.getMatriculaPeriodoTumaDisciplinaVOs(), configuracaoFinanceiroVO, gradeCurricularVO, usuario);
		getFacadeFactory().getPreMatriculaPeriodoTurmaDisciplinaFacade().incluirPreMatriculaPeriodosForaPrazo(obj.getCodigo(), obj.getMatricula(), obj.getPreMatriculaPeriodoTurmaDisciplinaVOs());
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerarContarReceberInclusaoForaPrazo(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodo, List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaAdicionadaVOs, Integer numParcelas, Double valorTotalParcela, InclusaoHistoricoForaPrazoVO inclusao, TurmaVO turma, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		try {
			valorTotalParcela = Uteis.arrendondarForcando2CadasDecimais(valorTotalParcela) - Uteis.arrendondarForcando2CadasDecimais(matriculaPeriodo.getDescontoReposicao());
			if (Uteis.isAtributoPreenchido(valorTotalParcela)) {
				int j = Uteis.getDateSemHora(matriculaPeriodo.getDiaVencimentoInclusaoForaPrazo()).compareTo(Uteis.getDateSemHora(new Date()));
				if (j == -1) {
					throw new ConsistirException("A data de vencimento não pode ser inferior a data atual.");
				}
				Date dataVencimento = matriculaPeriodo.getDiaVencimentoInclusaoForaPrazo();

				ContaCorrenteVO contaCorrente = new ContaCorrenteVO();
				// Verifico se a Turma que estão sendo incluida possui conta
				// corrente
				// Para que issso acontece so pode ter um obj na lista Obs:
				// feito
				// para atender o cliente LS.
				if (configuracaoFinanceiroVO.getUsarContaCorrenteTurmaIncluida() && listaDisciplinaAdicionadaVOs != null) {
					int tamanhoListaDisciplinaAdicionada = 0;
					tamanhoListaDisciplinaAdicionada = listaDisciplinaAdicionadaVOs.size();
					if (tamanhoListaDisciplinaAdicionada == 1) {
						for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : listaDisciplinaAdicionadaVOs) {
							if (!matriculaPeriodoTurmaDisciplinaVO.getTurma().getContaCorrente().getCodigo().equals(0)) {
								contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(matriculaPeriodoTurmaDisciplinaVO.getTurma().getContaCorrente().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
							}
						}
					}
				}
				if (contaCorrente.getCodigo().equals(0)) {
					if (!matriculaPeriodo.getTurma().getContaCorrente().getCodigo().equals(0)) {
						contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(matriculaPeriodo.getTurma().getContaCorrente().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
					} else if (!matricula.getUnidadeEnsino().getContaCorrentePadraoMensalidade().equals(0)) {
						contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(matricula.getUnidadeEnsino().getContaCorrentePadraoMensalidade(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
					} else {
						contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(configuracaoFinanceiroVO.getContaCorrentePadraoMensalidade(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
					}
				}
				String ultimaParcelaInclusao = getFacadeFactory().getContaReceberFacade().consultarUltimaParcelaInclusaoDisciplinaForaPrazo(matricula.getMatricula(), matriculaPeriodo.getCodigo(), usuario);
				String partePrefixoParcela = "IN";
				if (!ultimaParcelaInclusao.equals("")) {
					ultimaParcelaInclusao = ultimaParcelaInclusao.substring(ultimaParcelaInclusao.indexOf("N") + 1, ultimaParcelaInclusao.length());
					partePrefixoParcela += String.valueOf(Integer.parseInt(ultimaParcelaInclusao) + 1);
				} else {
					partePrefixoParcela = "IN1";
				}
				if (inclusao == null) {
					inclusao = new InclusaoHistoricoForaPrazoVO();
					inclusao.setCodigo(matriculaPeriodo.getCodigo());
				}
				for (int i = 1; i <= numParcelas; i++) {
					if (i != 1) {
						dataVencimento = Uteis.getDataFutura(matriculaPeriodo.getDiaVencimentoInclusaoForaPrazo(), GregorianCalendar.MONTH, i - 1);
						if (!matriculaPeriodo.getMatriculaVO().getMatricula().equals("")) {
							getFacadeFactory().getContaReceberFacade().criarContaReceberInclusaoForaPrazo(matriculaPeriodo.getMatriculaVO(), null, matricula.getAluno(), matricula.getUnidadeEnsino(), contaCorrente, inclusao.getCodigo(), "IRE", dataVencimento, dataVencimento, valorTotalParcela, configuracaoFinanceiroVO.getCentroReceitaReposicaoPadrao().getCodigo(), i, numParcelas, "ME", partePrefixoParcela, turma, configuracaoFinanceiroVO, usuario, matriculaPeriodo.getCodigo());
						} else {
							getFacadeFactory().getContaReceberFacade().criarContaReceberInclusaoForaPrazo(null, null, matricula.getAluno(), matricula.getUnidadeEnsino(), contaCorrente, inclusao.getCodigo(), "IRE", dataVencimento, dataVencimento, valorTotalParcela, configuracaoFinanceiroVO.getCentroReceitaReposicaoPadrao().getCodigo(), i, numParcelas, "ME", partePrefixoParcela, turma, configuracaoFinanceiroVO, usuario, matriculaPeriodo.getCodigo());
						}
					} else {
						// ContaReceberVO primeiraParcela = new
						// ContaReceberVO();
						if (!matriculaPeriodo.getMatriculaVO().getMatricula().equals("")) {
							getFacadeFactory().getContaReceberFacade().criarContaReceberInclusaoForaPrazo(matriculaPeriodo.getMatriculaVO(), null, matricula.getAluno(), matricula.getUnidadeEnsino(), contaCorrente, inclusao.getCodigo(), "IRE", dataVencimento, dataVencimento, valorTotalParcela, configuracaoFinanceiroVO.getCentroReceitaReposicaoPadrao().getCodigo(), i, numParcelas, "ME", partePrefixoParcela, turma, configuracaoFinanceiroVO, usuario, matriculaPeriodo.getCodigo());
						} else {
							getFacadeFactory().getContaReceberFacade().criarContaReceberInclusaoForaPrazo(null, null, matricula.getAluno(), matricula.getUnidadeEnsino(), contaCorrente, inclusao.getCodigo(), "IRE", dataVencimento, dataVencimento, valorTotalParcela, configuracaoFinanceiroVO.getCentroReceitaReposicaoPadrao().getCodigo(), i, numParcelas, "ME", partePrefixoParcela, turma, configuracaoFinanceiroVO, usuario, matriculaPeriodo.getCodigo());
						}
					}
				}

				partePrefixoParcela = null;
			}
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerarContarReceberReposicaoDisciplina(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodo, Integer numParcelas, TurmaVO turma, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		try {

			matriculaPeriodo.setPlanoDescontoInclusaoDisciplinaVO(getFacadeFactory().getPlanoDescontoInclusaoDisciplinaFacade().consultarPorChavePrimaria(matriculaPeriodo.getPlanoDescontoInclusaoDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
			Double valorReposicao = matriculaPeriodo.getPlanoDescontoInclusaoDisciplinaVO().getValor();
			Double valorDesconto = matriculaPeriodo.getDescontoReposicao();
			Double valorTotalParcela = 0.0;
			valorTotalParcela = valorReposicao - valorDesconto;

			int j = Uteis.getDateSemHora(matriculaPeriodo.getDiaVencimentoInclusaoForaPrazo()).compareTo(Uteis.getDateSemHora(new Date()));
			if (j == -1) {
				throw new ConsistirException("A data de vencimento não pode ser inferior a data atual.");
			}
			Date dataVencimento = matriculaPeriodo.getDiaVencimentoInclusaoForaPrazo();

			ContaCorrenteVO contaCorrente = new ContaCorrenteVO();
			contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(configuracaoFinanceiroVO.getContaCorrentePadraoMensalidade(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			String ultimaParcelaInclusao = getFacadeFactory().getContaReceberFacade().consultarUltimaParcelaReposicaoDisciplina(matricula.getMatricula(), matriculaPeriodo.getCodigo(), usuario);
			String partePrefixoParcela = "RP";
			if (!ultimaParcelaInclusao.equals("")) {
				ultimaParcelaInclusao = ultimaParcelaInclusao.substring(ultimaParcelaInclusao.indexOf("P") + 1, ultimaParcelaInclusao.length());
				partePrefixoParcela += String.valueOf(Integer.parseInt(ultimaParcelaInclusao) + 1);
			} else {
				partePrefixoParcela = "RP1";
			}

			if (!matriculaPeriodo.getMatriculaVO().getMatricula().equals("")) {
				getFacadeFactory().getContaReceberFacade().criarContaReceberInclusaoForaPrazo(matriculaPeriodo.getMatriculaVO(), null, matricula.getAluno(), matricula.getUnidadeEnsino(), contaCorrente, matriculaPeriodo.getCodigo(), "OUT", dataVencimento, dataVencimento, valorTotalParcela, configuracaoFinanceiroVO.getCentroReceitaMensalidadePadrao().getCodigo(), 1, numParcelas, "ME", partePrefixoParcela, turma, configuracaoFinanceiroVO, usuario, matriculaPeriodo.getCodigo());
			} else {
				getFacadeFactory().getContaReceberFacade().criarContaReceberInclusaoForaPrazo(null, null, matricula.getAluno(), matricula.getUnidadeEnsino(), contaCorrente, matriculaPeriodo.getCodigo(), "OUT", dataVencimento, dataVencimento, valorTotalParcela, configuracaoFinanceiroVO.getCentroReceitaMensalidadePadrao().getCodigo(), 1, numParcelas, "ME", partePrefixoParcela, turma, configuracaoFinanceiroVO, usuario, matriculaPeriodo.getCodigo());
			}
			partePrefixoParcela = null;
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerarContarReceberAPartirPlanoFinanceiroReposicao(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodo, InclusaoHistoricoForaPrazoVO inclusao, TurmaVO turma, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		if (matriculaPeriodo.getPlanoFinanceiroReposicaoVO().getCodigo().intValue() == 0) {
			throw new ConsistirException("Selecione o plano financeiro inclusão/reposição ( Dados gerais ).");
		}
		getFacadeFactory().getPlanoFinanceiroReposicaoFacade().carregarDados(matriculaPeriodo.getPlanoFinanceiroReposicaoVO(), NivelMontarDados.TODOS, usuario);
		Integer numParcelas = matriculaPeriodo.getPlanoFinanceiroReposicaoVO().getQtdeParcela();
		Double valorTotalParcela = matriculaPeriodo.getPlanoFinanceiroReposicaoVO().getValor() - matriculaPeriodo.getDescontoReposicao();

		int j = Uteis.getDateSemHora(matriculaPeriodo.getDiaVencimentoInclusaoForaPrazo()).compareTo(Uteis.getDateSemHora(new Date()));
		if (j == -1) {
			throw new ConsistirException("A data de vencimento não pode ser inferior a data atual.");
		}
		Date dataVencimento = matriculaPeriodo.getDiaVencimentoInclusaoForaPrazo();
		ContaCorrenteVO contaCorrente = new ContaCorrenteVO();
		if (!matriculaPeriodo.getTurma().getContaCorrente().getCodigo().equals(0)) {
			contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(matriculaPeriodo.getTurma().getContaCorrente().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		} else if (!matricula.getUnidadeEnsino().getContaCorrentePadraoMensalidade().equals(0)) {
			contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(matricula.getUnidadeEnsino().getContaCorrentePadraoMensalidade(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		} else {
			contaCorrente = getFacadeFactory().getContaCorrenteFacade().consultarPorChavePrimaria(configuracaoFinanceiroVO.getContaCorrentePadraoMensalidade(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		}
		String partePrefixoParcela = "";
		if (matriculaPeriodo.getInclusaoForaPrazo()) {
			String ultimaParcelaInclusao = getFacadeFactory().getContaReceberFacade().consultarUltimaParcelaInclusaoDisciplinaForaPrazo(matricula.getMatricula(), matriculaPeriodo.getCodigo(), usuario);
			partePrefixoParcela = "IN";
			if (!ultimaParcelaInclusao.equals("")) {
				ultimaParcelaInclusao = ultimaParcelaInclusao.substring(ultimaParcelaInclusao.indexOf("N") + 1, ultimaParcelaInclusao.length());
				partePrefixoParcela += String.valueOf(Integer.parseInt(ultimaParcelaInclusao) + 1);
			} else {
				partePrefixoParcela = "IN1";
			}
		} else {
			String ultimaParcelaInclusao = getFacadeFactory().getContaReceberFacade().consultarUltimaParcelaReposicaoDisciplina(matricula.getMatricula(), matriculaPeriodo.getCodigo(), usuario);
			partePrefixoParcela = "RP";
			if (!ultimaParcelaInclusao.equals("")) {
				ultimaParcelaInclusao = ultimaParcelaInclusao.substring(ultimaParcelaInclusao.indexOf("P") + 1, ultimaParcelaInclusao.length());
				partePrefixoParcela += String.valueOf(Integer.parseInt(ultimaParcelaInclusao) + 1);
			} else {
				partePrefixoParcela = "RP1";
			}
		}
		for (int i = 1; i <= numParcelas; i++) {
			if (i != 1) {
				dataVencimento = Uteis.getDataFutura(matriculaPeriodo.getDiaVencimentoInclusaoForaPrazo(), GregorianCalendar.MONTH, i - 1);
				if (!matriculaPeriodo.getMatriculaVO().getMatricula().equals("")) {
					getFacadeFactory().getContaReceberFacade().criarContaReceberInclusaoForaPrazo(matriculaPeriodo.getMatriculaVO(), null, matricula.getAluno(), matricula.getUnidadeEnsino(), contaCorrente, inclusao.getCodigo(), "IRE", dataVencimento, dataVencimento, valorTotalParcela, configuracaoFinanceiroVO.getCentroReceitaReposicaoPadrao().getCodigo(), i, numParcelas, "ME", partePrefixoParcela, turma, configuracaoFinanceiroVO, usuario, matriculaPeriodo.getCodigo());
				} else {
					getFacadeFactory().getContaReceberFacade().criarContaReceberInclusaoForaPrazo(null, null, matricula.getAluno(), matricula.getUnidadeEnsino(), contaCorrente, inclusao.getCodigo(), "IRE", dataVencimento, dataVencimento, valorTotalParcela, configuracaoFinanceiroVO.getCentroReceitaReposicaoPadrao().getCodigo(), i, numParcelas, "ME", partePrefixoParcela, turma, configuracaoFinanceiroVO, usuario, matriculaPeriodo.getCodigo());
				}
			} else {
				if (!matriculaPeriodo.getMatriculaVO().getMatricula().equals("")) {
					getFacadeFactory().getContaReceberFacade().criarContaReceberInclusaoForaPrazo(matriculaPeriodo.getMatriculaVO(), null, matricula.getAluno(), matricula.getUnidadeEnsino(), contaCorrente, inclusao.getCodigo(), "IRE", dataVencimento, dataVencimento, valorTotalParcela, configuracaoFinanceiroVO.getCentroReceitaReposicaoPadrao().getCodigo(), i, numParcelas, "ME", partePrefixoParcela, turma, configuracaoFinanceiroVO, usuario, matriculaPeriodo.getCodigo());
				} else {
					getFacadeFactory().getContaReceberFacade().criarContaReceberInclusaoForaPrazo(null, null, matricula.getAluno(), matricula.getUnidadeEnsino(), contaCorrente, inclusao.getCodigo(), "IRE", dataVencimento, dataVencimento, valorTotalParcela, configuracaoFinanceiroVO.getCentroReceitaReposicaoPadrao().getCodigo(), i, numParcelas, "ME", partePrefixoParcela, turma, configuracaoFinanceiroVO, usuario, matriculaPeriodo.getCodigo());
				}
			}
		}
		partePrefixoParcela = null;
	}

	/**
	 * Metodo retorna uma lista de MatriculaPeridoTurmaDisciplinaVO que não o nr
	 * de vagas já ultrapassaram o limite disponivel de vagas tanto de vagas
	 * normais como o nr maximo de vagas
	 * 
	 * @param lista
	 *            = Lista de MatriculaPeridoTurmaDisciplinaVO
	 * @return
	 * @throws java.lang.Exception
	 */
	public List verificarExistenciaVagasTurmaDisciplina(List lista, UsuarioVO usuario) throws Exception {
		List listaRetorno = new ArrayList(0);
		Iterator i = lista.iterator();
		while (i.hasNext()) {
			MatriculaPeriodoTurmaDisciplinaVO obj = (MatriculaPeriodoTurmaDisciplinaVO) i.next();
			if (obj.getCodigo().intValue() == 0) {
				TurmaDisciplinaVO turmaDisciplina = getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarExistenciaVagaTurmaDisciplina(obj.getTurma().getCodigo(), obj.getDisciplina().getCodigo(), obj.getTurma().getNrMaximoMatricula(), usuario);
				if (turmaDisciplina.getCodigo().intValue() == 0) {
					listaRetorno.add(obj);
				}
			}
		}
		return listaRetorno;
	}

	/**
	 * Metodo retorna uma lista de MatriculaPeridoTurmaDisciplinaVO que não o nr
	 * de vagas já ultrapassaram o limite disponivel de vagas mas não
	 * ultrapassaram o limite máximo exigindo Assim senha de autorizaï¿½ï¿½o
	 * para matricula
	 * 
	 * @param lista
	 *            = Lista de MatriculaPeridoTurmaDisciplinaVO
	 * @return
	 * @throws java.lang.Exception
	 */
	public List verificarExistenciaVagasMaximaTurmaDisciplina(List lista, UsuarioVO usuario) throws Exception {
		List listaRetorno = new ArrayList(0);
		Iterator i = lista.iterator();
		while (i.hasNext()) {
			MatriculaPeriodoTurmaDisciplinaVO obj = (MatriculaPeriodoTurmaDisciplinaVO) i.next();
			if (obj.getCodigo().intValue() == 0) {
				TurmaDisciplinaVO turmaDisciplina = getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarExistenciaVagaTurmaDisciplina(obj.getTurma().getCodigo(), obj.getDisciplina().getCodigo(), obj.getTurma().getNrMaximoMatricula(), usuario);
				if (turmaDisciplina.getCodigo().intValue() != 0 && turmaDisciplina.getNrAlunosMatriculados() >= turmaDisciplina.getNrVagasMatricula()) {
					listaRetorno.add(obj);
				}
			}
		}
		return listaRetorno;
	}

//	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
//	public void incluirExcluirDisciplina(final MatriculaPeriodoVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
//		try {
//			MatriculaPeriodo.alterar(getIdEntidade());
//			final String sql = "UPDATE MatriculaPeriodo set data=?, situacao=?, matricula=?, gradeCurricular=?, periodoLetivoMatricula = ?, responsavelRenovacaoMatricula=?, turma=?, " + "responsavelLiberacaoMatricula=?, dataLiberacaoMatricula=?, responsavelEmissaoBoletoMatricula = ?, dataEmissaoBoletoMatricula = ?, contaReceber = ?, nrDocumento = ?, " + "unidadeEnsinoCurso = ?, turmaPeriodo =?, semestre=?, ano=?, responsavelMatriculaForaPrazo=?, situacaoMatriculaPeriodo=?, processoMatricula=?, transferenciaEntrada=?, " + "matriculaPeriodoPreMatricula=?, carneEntregue=?, matriculaEspecial=? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
//			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
//
//				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
//					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
//					sqlAlterar.setDate(1, Uteis.getDataJDBC(obj.getData()));
//					sqlAlterar.setString(2, obj.getSituacao());
//					sqlAlterar.setString(3, obj.getMatricula());
//					sqlAlterar.setInt(4, obj.getGradeCurricular().getCodigo().intValue());
//					sqlAlterar.setInt(5, obj.getPeridoLetivo().getCodigo().intValue());
//					sqlAlterar.setInt(6, obj.getResponsavelRenovacaoMatricula().getCodigo().intValue());
//					if (obj.getTurma().getCodigo().intValue() != 0) {
//						sqlAlterar.setInt(7, obj.getTurma().getCodigo().intValue());
//					} else {
//						sqlAlterar.setNull(7, 0);
//					}
//					if (obj.getResponsavelLiberacaoMatricula().getCodigo().intValue() != 0) {
//						sqlAlterar.setInt(8, obj.getResponsavelLiberacaoMatricula().getCodigo().intValue());
//					} else {
//						sqlAlterar.setNull(8, 0);
//					}
//					sqlAlterar.setDate(9, Uteis.getDataJDBC(obj.getDataLiberacaoMatricula()));
//					if (obj.getResponsavelEmissaoBoletoMatricula().getCodigo().intValue() != 0) {
//						sqlAlterar.setInt(10, obj.getResponsavelEmissaoBoletoMatricula().getCodigo().intValue());
//					} else {
//						sqlAlterar.setNull(10, 0);
//					}
//					sqlAlterar.setDate(11, Uteis.getDataJDBC(obj.getDataEmissaoBoletoMatricula()));
//					// if (obj.getContaReceber().intValue() != 0) {
//					// sqlAlterar.setInt(12, obj.getContaReceber().intValue());
//					// } else {
//					// sqlAlterar.setNull(12, 0);
//					// }
//					sqlAlterar.setNull(12, 0);
//					sqlAlterar.setString(13, obj.getNrDocumento());
//					sqlAlterar.setInt(14, obj.getUnidadeEnsinoCurso().intValue());
//					if (obj.getTurmaPeriodo().getCodigo().intValue() != 0) {
//						sqlAlterar.setInt(15, obj.getTurmaPeriodo().getCodigo().intValue());
//					} else {
//						sqlAlterar.setNull(15, 0);
//					}
//					sqlAlterar.setString(16, obj.getSemestre());
//					sqlAlterar.setString(17, obj.getAno());
//					if (obj.getResponsavelMatriculaForaPrazo().getCodigo().intValue() != 0) {
//						sqlAlterar.setInt(18, obj.getResponsavelMatriculaForaPrazo().getCodigo().intValue());
//					} else {
//						sqlAlterar.setNull(18, 0);
//					}
//					sqlAlterar.setString(19, obj.getSituacaoMatriculaPeriodo());
//					sqlAlterar.setInt(20, obj.getProcessoMatricula().intValue());
//					sqlAlterar.setInt(21, obj.getTranferenciaEntrada().intValue());
//					if (obj.getMatriculaPeriodoPreMatricula().getCodigo().intValue() != 0) {
//						sqlAlterar.setInt(22, obj.getMatriculaPeriodoPreMatricula().getCodigo().intValue());
//					} else {
//						sqlAlterar.setNull(22, 0);
//					}
//					sqlAlterar.setBoolean(23, obj.getCarneEntregue());
//					sqlAlterar.setBoolean(24, obj.getMatriculaEspecial());
//					sqlAlterar.setInt(25, obj.getCodigo().intValue());
//					return sqlAlterar;
//				}
//			});
//			getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().alterarMatriculaPeriodos(obj.getCodigo(), obj.getMatricula(), obj.getMatriculaPeriodoTumaDisciplinaVOs(), configuracaoFinanceiroVO, usuario);
//		} catch (Exception e) {
//			throw e;
//		}
//	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoMatriculaPeriodo(final MatriculaPeriodoVO obj, OrigemFechamentoMatriculaPeriodoEnum origemFechamentoMatriculaPeriodoEnum, Integer codigoOrigemFechamentoMatriculaPeriodo, Date dataFechamentoMatriculaPeriodo) throws Exception {
		if (origemFechamentoMatriculaPeriodoEnum == null || OrigemFechamentoMatriculaPeriodoEnum.NAO_FECHADO.equals(origemFechamentoMatriculaPeriodoEnum)) {
			obj.setDataFechamentoMatriculaPeriodo(null);
		} else {
			obj.setDataFechamentoMatriculaPeriodo(dataFechamentoMatriculaPeriodo);
		}
		obj.setOrigemFechamentoMatriculaPeriodo(origemFechamentoMatriculaPeriodoEnum);
		obj.setCodigoOrigemFechamentoMatriculaPeriodo(codigoOrigemFechamentoMatriculaPeriodo);
		final String sql = "UPDATE MatriculaPeriodo set  turma=?, turmaPeriodo =?, situacaoMatriculaPeriodo=?, dataFechamentoMatriculaPeriodo=?, origemFechamentoMatriculaPeriodo=?, codigoOrigemFechamentoMatriculaPeriodo=?, alunoTransferidoUnidade=?  WHERE ((codigo = ?))";
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
				if (obj.getTurma().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(1, obj.getTurma().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(1, 0);
				}

				if (obj.getTurmaPeriodo().getCodigo().intValue() != 0) {
					sqlAlterar.setInt(2, obj.getTurmaPeriodo().getCodigo().intValue());
				} else {
					sqlAlterar.setNull(2, 0);
				}
				sqlAlterar.setString(3, obj.getSituacaoMatriculaPeriodo());
				if (obj.getDataFechamentoMatriculaPeriodo() == null) {
					sqlAlterar.setNull(4, 0);
				} else {
					sqlAlterar.setTimestamp(4, Uteis.getDataJDBCTimestamp(obj.getDataFechamentoMatriculaPeriodo()));
				}
				if (obj.getOrigemFechamentoMatriculaPeriodo() != null) {
					sqlAlterar.setString(5, obj.getOrigemFechamentoMatriculaPeriodo().toString());
				} else {
					sqlAlterar.setNull(5, 0);
				}
				if (obj.getCodigoOrigemFechamentoMatriculaPeriodo() != null) {
					sqlAlterar.setInt(6, obj.getCodigoOrigemFechamentoMatriculaPeriodo());
				} else {
					sqlAlterar.setNull(6, 0);
				}
				sqlAlterar.setBoolean(7, obj.getAlunoTransferidoUnidade());
				sqlAlterar.setInt(8, obj.getCodigo().intValue());
				return sqlAlterar;
			}
		});

	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoMatriculaPeriodoPorCodigo(final Integer matriculaPeriodo, final String situacaoMatriculaPeriodo, final OrigemFechamentoMatriculaPeriodoEnum origemFechamentoMatriculaPeriodoEnum, final Integer codigoOrigemFechamentoMatriculaPeriodo, final Boolean alunoTransferidoUnidade, Date dataFechamentoMatriculaPeriodo) throws Exception {
		try {
			final String sql = "UPDATE MatriculaPeriodo set  situacaoMatriculaPeriodo=?, dataFechamentoMatriculaPeriodo=?, origemFechamentoMatriculaPeriodo=?, codigoOrigemFechamentoMatriculaPeriodo=?, alunoTransferidoUnidade=?  WHERE ((codigo = ?))";
			final Date dataFechamentoMP = origemFechamentoMatriculaPeriodoEnum == null || OrigemFechamentoMatriculaPeriodoEnum.NAO_FECHADO.equals(origemFechamentoMatriculaPeriodoEnum) ? null : dataFechamentoMatriculaPeriodo;
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
					sqlAlterar.setString(1, situacaoMatriculaPeriodo.toUpperCase());
					if (dataFechamentoMP == null) {
						sqlAlterar.setNull(2, 0);
					} else {
						sqlAlterar.setTimestamp(2, Uteis.getDataJDBCTimestamp(dataFechamentoMP));
					}
					if (origemFechamentoMatriculaPeriodoEnum != null) {
						sqlAlterar.setString(3, origemFechamentoMatriculaPeriodoEnum.toString());
					} else {
						sqlAlterar.setNull(3, 0);
					}
					if (codigoOrigemFechamentoMatriculaPeriodo != null) {
						sqlAlterar.setInt(4, codigoOrigemFechamentoMatriculaPeriodo.intValue());
					} else {
						sqlAlterar.setNull(4, 0);
					}
					sqlAlterar.setBoolean(5, alunoTransferidoUnidade);
					sqlAlterar.setInt(6, matriculaPeriodo.intValue());
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			if (e.getMessage().contains("check_matriculaperiodo_ano_semestre_matricula")) {
				throw new Exception(UteisJSF.internacionalizar("msg_ErroGravarMatriculaPeriodoDuplicadaCursoSemestral"));
			}
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void inicializarDadosAnoSemestreMatricula(MatriculaPeriodoVO obj, ProcessoMatriculaCalendarioVO processoMatricula, Boolean forcarInicializacao) throws Exception {
		/**
		 * As linhas abaixo foram comentadas pois ao repassar pela matricula
		 * alterando o processo de matricula cujo o ano e semestre seja
		 * diferente o sistema não estava alterando esta informação na matricula
		 * periodo e nem na matricula periodo turma disciplina.
		 */
		// Boolean inicializarAnoSemestre = forcarInicializacao;
		// if ((!forcarInicializacao)
		// && ((obj.getAno() == null || obj.getAno().equals("")) ||
		// (obj.getSemestre() == null || obj.getSemestre().equals("")))) {
		// inicializarAnoSemestre = true;
		// }
		// if (inicializarAnoSemestre) {
		if (processoMatricula == null || processoMatricula.isNovoObj()) {
			return;
		}
		obj.setAno(processoMatricula.getPeriodoLetivoAtivolUnidadeEnsinoCursoVO().getAnoReferenciaPeriodoLetivo());
		obj.setSemestre(processoMatricula.getPeriodoLetivoAtivolUnidadeEnsinoCursoVO().getSemestreReferenciaPeriodoLetivo());
		// }
		// Refletindo sitaï¿½ï¿½o da matricula periodo para os objetos
		// MatriculaPeriodoTurmaDisciplinaVO
		for (MatriculaPeriodoTurmaDisciplinaVO objMatDis : obj.getMatriculaPeriodoTumaDisciplinaVOs()) {
			objMatDis.setAno(obj.getAno());
			objMatDis.setSemestre(obj.getSemestre());
			
		}
	}

	public void incluirDadosAnoSemestreMatricula(MatriculaPeriodoVO obj, Integer periodoLetivoAtivo) throws Exception {
		// PeriodoLetivoAtivoUnidadeEnsinoCursoVO periodoAtivo = new
		// PeriodoLetivoAtivoUnidadeEnsinoCurso().consultarPorChavePrimaria(periodoLetivoAtivo,
		// Uteis.NIVELMONTARDADOS_DADOSBASICOS);
		// if (periodoAtivo.getCodigo().intValue() == 0) {
		// throw new
		// Exception("Não existe um periodo letivo ativo para este Curso, Turno e Unidade de Ensino.");
		// }
		// obj.setAno(periodoAtivo.getAnoReferenciaPeriodoLetivo());
		// obj.setSemestre(periodoAtivo.getSemestreReferenciaPeriodoLetivo());
	}

	/**
	 * Operação Responsável por excluir no BD um objeto da classe
	 * <code>MatriculaPeriodoVO</code>. Sempre localiza o registro a ser
	 * excluï¿½do através da chave primária da entidade. Primeiramente verifica
	 * a conexão com o banco de dados e a permissão do usuário para realizar
	 * esta operação na entidade. Isto, através da operação <code>excluir</code>
	 * da superclasse.
	 * 
	 * @param obj
	 *            Objeto da classe <code>MatriculaPeriodoVO</code> que será
	 *            removido no banco de dados.
	 * @exception Execption
	 *                Caso haja problemas de conexão ou restrição de acesso.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluir(MatriculaPeriodoVO obj, UsuarioVO usuario) throws Exception {
		MatriculaPeriodo.excluir(getIdEntidade());
		String sql = "DELETE FROM MatriculaPeriodo WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql, new Object[] { obj.getCodigo() });
		if (obj.getSituacaoMatriculaPeriodo().equals("AT")) {
			getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().excluirMatriculaPeriodoTurmaDisciplinas(obj.getCodigo(), obj.getMatriculaPeriodoTumaDisciplinaVOs(), usuario);
		}
		getFacadeFactory().getPreMatriculaPeriodoTurmaDisciplinaFacade().excluirPreMatriculaPeriodoTurmaDisciplinas(obj.getCodigo(), obj.getPreMatriculaPeriodoTurmaDisciplinaVOs());
	}

	public List<MatriculaPeriodoVO> consultarPorAnoSemestreUnidadeEnsino(String ano, String semestre, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "select matriculaperiodo.* " + "from matriculaperiodo inner join unidadeensinocurso on unidadeensinocurso.codigo = matriculaperiodo.unidadeensinocurso " + "where ano = '" + ano + "' and semestre = '" + semestre + "' and unidadeensino = " + unidadeEnsino;
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);

	}

	public List consultarPorCursoTurmaAnoSemestre(Integer curso, Integer turma, String ano, String semestre, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "";
		sqlStr += "SELECT DISTINCT MatriculaPeriodo.* FROM MatriculaPeriodo, Matricula WHERE Matricula.matricula = MatriculaPeriodo.matricula AND Matricula.curso = " + curso + " ";
		if (turma != 0) {
			sqlStr += "AND MatriculaPeriodo.turma = " + turma + " ";
		}
		if (!ano.equals("")) {
			sqlStr += "AND MatriculaPeriodo.ano = '" + ano + "' ";
		}
		if (!semestre.equals("")) {
			sqlStr += "AND MatriculaPeriodo.semestre = '" + semestre + "' ";
		}
		sqlStr += "ORDER BY MatriculaPeriodo.matricula";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List consultarPorCursoTurmaAnoSemestreBasica(Integer curso, Integer turma, Integer disciplina, String ano, String semestre, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "";
		sqlStr += "SELECT DISTINCT matriculaPeriodo.codigo AS matriculaPeriodo_codigo, matriculaPeriodo.ano AS ano, matriculaPeriodo.semestre AS semestre, " + "turma.codigo AS codigoTurma, turma.identificadorturma AS idTurma, pessoa.nome AS nomeAluno, matricula.matricula AS matricula, " + "curso.codigo AS codigoCurso, curso.nome AS nomeCurso, curso.niveleducacional AS niveleducacional, pessoa.dataNasc AS dataNasc, unidadeEnsino.codigo AS codigoUnidade, " + "unidadeEnsino.nome AS nomeUnidade, turno.codigo AS codigoTurno, turno.nome AS nomeTurno, pessoa.codigo AS codigoPessoa, periodoletivo.descricao AS periodoLetivoDescricao, " + "periodoletivo.codigo AS periodoLetivoCodigo, turno.codigo AS codigoTurno, turno.nome AS nomeTurno, pessoa.codigo AS codigoPessoa, pessoa.rg AS rg, periodoletivo.descricao AS periodo " + "FROM MatriculaPeriodo " + "INNER JOIN matricula ON matricula.matricula = matriculaPeriodo.matricula " + "INNER JOIN pessoa ON matricula.aluno = pessoa.codigo "
				+ "INNER JOIN curso ON matricula.curso = curso.codigo " + "INNER JOIN unidadeEnsino ON matricula.unidadeEnsino = unidadeEnsino.codigo " + "INNER JOIN matriculaPeriodoTurmaDisciplina mptd ON mptd.matriculaperiodo = matriculaperiodo.codigo  " + "INNER JOIN turma ON turma.codigo = matriculaPeriodo.turma " + "INNER JOIN turno ON turma.turno = turno.codigo " + "INNER JOIN periodoletivo ON turma.periodoletivo = periodoletivo.codigo " + "WHERE Matricula.matricula = MatriculaPeriodo.matricula AND Matricula.curso = " + curso + " ";
		if (turma != 0) {
			sqlStr += "AND mptd.turma = " + turma + " ";
		}
		if (disciplina != 0) {
			sqlStr += "AND mptd.disciplina = " + disciplina + " ";
		}
		if (!ano.equals("")) {
			sqlStr += "AND MatriculaPeriodo.ano = '" + ano + "' ";
		}
		if (!semestre.equals("")) {
			sqlStr += "AND MatriculaPeriodo.semestre = '" + semestre + "' ";
		}
		sqlStr += "AND matricula.situacao = 'AT' ";
		sqlStr += "ORDER BY pessoa.nome, matricula.matricula";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsultaCursoTurmaAnoSemestreBasica(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List<MatriculaPeriodoVO> montarDadosConsultaCursoTurmaAnoSemestreBasica(SqlRowSet tabelaResultado, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			vetResultado.add(montarDadosCursoTurmaAnoSemestreBasica(tabelaResultado, obj, nivelMontarDados, configuracaoFinanceiroVO, usuario));
		}
		return vetResultado;
	}

	public MatriculaPeriodoVO montarDadosCursoTurmaAnoSemestreBasica(SqlRowSet dadosSQL, MatriculaPeriodoVO obj, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		obj.setCodigo(dadosSQL.getInt("matriculaPeriodo_codigo"));
		obj.setAno(dadosSQL.getString("ano"));
		obj.setSemestre(dadosSQL.getString("semestre"));
		obj.getPeridoLetivo().setCodigo(dadosSQL.getInt("periodoLetivoCodigo"));
		obj.getPeridoLetivo().setDescricao(dadosSQL.getString("periodoLetivoDescricao"));
		obj.getTurma().setCodigo(dadosSQL.getInt("codigoTurma"));
		obj.getTurma().setIdentificadorTurma(dadosSQL.getString("idTurma"));
		obj.getMatriculaVO().getAluno().setCodigo(dadosSQL.getInt("codigoPessoa"));
		obj.getMatriculaVO().getAluno().setNome(dadosSQL.getString("nomeAluno"));
		obj.getMatriculaVO().getAluno().setDataNasc(dadosSQL.getDate("dataNasc"));
		obj.getMatriculaVO().getAluno().setRG(dadosSQL.getString("rg"));
		obj.setMatricula(dadosSQL.getString("matricula"));
		obj.getMatriculaVO().setMatricula(dadosSQL.getString("matricula"));
		obj.getMatriculaVO().getCurso().setCodigo(dadosSQL.getInt("codigoCurso"));
		obj.getMatriculaVO().getCurso().setNome(dadosSQL.getString("nomeCurso"));
		obj.getMatriculaVO().getCurso().setNivelEducacional(dadosSQL.getString("niveleducacional"));
		obj.getMatriculaVO().getUnidadeEnsino().setCodigo(dadosSQL.getInt("codigoUnidade"));
		obj.getMatriculaVO().getUnidadeEnsino().setNome(dadosSQL.getString("nomeUnidade"));
		obj.getTurma().getTurno().setCodigo(dadosSQL.getInt("codigoTurno"));
		obj.getTurma().getTurno().setNome(dadosSQL.getString("nomeTurno"));
		obj.setSelecionarMatriculaPeriodoRenovar(Boolean.FALSE);
		return obj;
	}

	public List consultarAlunosParticipamBancoCurriculoPorNome(String nomeAluno, UsuarioVO usuario) throws Exception {
		String sqlStr = "";
		sqlStr += "SELECT DISTINCT matriculaPeriodo.turma AS codigoTurma,matricula.aluno AS codigoAluno, turma.identificadorturma AS turma, pessoa.nome AS aluno " + ", (select count(codigo) from candidatosvagas where candidatosvagas.pessoa = pessoa.codigo) as  qtdvagas " + "FROM  matriculaPeriodo " + "INNER JOIN matricula ON matriculaPeriodo.matricula = matricula.matricula " + "INNER JOIN turma ON matriculaPeriodo.turma = turma.codigo " + "INNER JOIN pessoa ON matricula.aluno = pessoa.codigo " + "WHERE upper (sem_acentos(pessoa.nome)) ilike  (sem_acentos('" + nomeAluno + "%')) " + "AND pessoa.aluno = true " + "AND pessoa.participabancocurriculum = true ";
		sqlStr += "ORDER BY pessoa.nome ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List objs = new ArrayList(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			obj.getTurma().setIdentificadorTurma(tabelaResultado.getString("turma"));
			obj.getTurma().setCodigo(tabelaResultado.getInt("codigoTurma"));
			obj.getMatriculaVO().getAluno().setNome(tabelaResultado.getString("aluno"));
			obj.getMatriculaVO().getAluno().setCodigo(tabelaResultado.getInt("codigoAluno"));
			obj.getMatriculaVO().getAluno().setQtdVagasCandidatou(tabelaResultado.getInt("qtdvagas"));
			objs.add(obj);
		}
		return objs;
	}

	public List consultarAlunosParticipamBancoCurriculoPorTurma(String identificadorTurma, UsuarioVO usuario) throws Exception {
		String sqlStr = "";
		sqlStr += "SELECT DISTINCT matriculaPeriodo.turma AS codigoTurma, matricula.aluno AS codigoAluno, turma.identificadorturma AS turma, pessoa.nome AS aluno " + "FROM  matriculaPeriodo " + "INNER JOIN matricula ON matriculaPeriodo.matricula = matricula.matricula " + "INNER JOIN turma ON matriculaPeriodo.turma = turma.codigo " + "INNER JOIN pessoa ON matricula.aluno = pessoa.codigo " + "WHERE turma.identificadorturma ilike  '" + identificadorTurma + "%' " + "AND pessoa.aluno = true " + "AND pessoa.participabancocurriculum = true ";
		sqlStr += "ORDER BY pessoa.nome ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List objs = new ArrayList(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			obj.getTurma().setIdentificadorTurma(tabelaResultado.getString("turma"));
			obj.getTurma().setCodigo(tabelaResultado.getInt("codigoTurma"));
			obj.getMatriculaVO().getAluno().setNome(tabelaResultado.getString("aluno"));
			obj.getMatriculaVO().getAluno().setCodigo(tabelaResultado.getInt("codigoAluno"));
			objs.add(obj);
		}
		return objs;
	}

	public List consultarAlunosParticipamBancoCurriculoSelecionadosPorTurma(String identificadorTurma, UsuarioVO usuario) throws Exception {
		String sqlStr = "";
		sqlStr += "SELECT DISTINCT matriculaPeriodo.turma AS codigoTurma, matricula.aluno AS codigoAluno, turma.identificadorturma AS turma, pessoa.nome AS aluno " + "FROM  matriculaPeriodo " + "INNER JOIN matricula ON matriculaPeriodo.matricula = matricula.matricula " + "INNER JOIN turma ON matriculaPeriodo.turma = turma.codigo " + "INNER JOIN pessoa ON matricula.aluno = pessoa.codigo " + "INNER JOIN candidatosvagas on candidatosvagas.pessoa = pessoa.codigo " + "WHERE turma.identificadorturma ilike  '" + identificadorTurma + "%' " + "AND pessoa.aluno = true " + "AND pessoa.participabancocurriculum = true " + "and situacaoreferentevaga ilike 'PROCESSO_SELETIVO' ";
		sqlStr += "ORDER BY pessoa.nome ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List objs = new ArrayList(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			obj.getTurma().setIdentificadorTurma(tabelaResultado.getString("turma"));
			obj.getTurma().setCodigo(tabelaResultado.getInt("codigoTurma"));
			obj.getMatriculaVO().getAluno().setNome(tabelaResultado.getString("aluno"));
			obj.getMatriculaVO().getAluno().setCodigo(tabelaResultado.getInt("codigoAluno"));
			objs.add(obj);
		}
		return objs;
	}

	public List consultarAlunosParticipamBancoCurriculoContratadosPorTurma(String identificadorTurma, UsuarioVO usuario) throws Exception {
		String sqlStr = "";
		sqlStr += "SELECT DISTINCT matriculaPeriodo.turma AS codigoTurma, matricula.aluno AS codigoAluno, turma.identificadorturma AS turma, pessoa.nome AS aluno " + "FROM  matriculaPeriodo " + "INNER JOIN matricula ON matriculaPeriodo.matricula = matricula.matricula " + "INNER JOIN turma ON matriculaPeriodo.turma = turma.codigo " + "INNER JOIN pessoa ON matricula.aluno = pessoa.codigo " + "INNER JOIN candidatosvagas on candidatosvagas.pessoa = pessoa.codigo " + "WHERE turma.identificadorturma ilike  '" + identificadorTurma + "%' " + "AND pessoa.aluno = true " + "AND pessoa.participabancocurriculum = true " + "and situacaoreferentevaga ilike 'SELECIONADO' ";
		sqlStr += "ORDER BY pessoa.nome ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		List objs = new ArrayList(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			obj.getTurma().setIdentificadorTurma(tabelaResultado.getString("turma"));
			obj.getTurma().setCodigo(tabelaResultado.getInt("codigoTurma"));
			obj.getMatriculaVO().getAluno().setNome(tabelaResultado.getString("aluno"));
			obj.getMatriculaVO().getAluno().setCodigo(tabelaResultado.getInt("codigoAluno"));
			objs.add(obj);
		}
		return objs;
	}

	public MatriculaPeriodoVO consultarPorTurmaCursoAnoSemestre(Integer turma, Integer curso, String ano, String semestre, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "";
		sqlStr += "SELECT DISTINCT MatriculaPeriodo.* FROM MatriculaPeriodo, Matricula WHERE Matricula.matricula = MatriculaPeriodo.matricula AND Matricula.curso = " + curso + " ";
		if (turma != 0) {
			sqlStr += "AND MatriculaPeriodo.turma = " + turma + " ";
		}
		if (!ano.equals("")) {
			sqlStr += "AND MatriculaPeriodo.ano = '" + ano + "' ";
		}
		if (!semestre.equals("")) {
			sqlStr += "AND MatriculaPeriodo.semestre = '" + semestre + "' ";
		}
		sqlStr += "ORDER BY MatriculaPeriodo.matricula";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (!tabelaResultado.next()) {
			throw new ConsistirException("Dados Não Encontrados.");
		}
		MatriculaPeriodoVO obj = null;
		return (montarDados(tabelaResultado, obj, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List consultarPorMatriculaMatricula(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT MatriculaPeriodo.* FROM MatriculaPeriodo, Matricula WHERE MatriculaPeriodo.matricula = Matricula.matricula and Matricula.matricula like('" + valorConsulta + "%') ORDER BY Matricula.matricula, MatriculaPeriodo.ano, MatriculaPeriodo.semestre";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public Integer consultaNrMatriculaPeriodo(String matricula, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sqlStr = new StringBuilder()
				.append(" select count(MatriculaPeriodo.codigo) as nrMatriculaPeriodo from MatriculaPeriodo ")
				.append(" WHERE MatriculaPeriodo.matricula like(?) ");
				SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), matricula);
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("nrMatriculaPeriodo");
		}
		return 0;
	}

	public List<MatriculaPeriodoVO> consultaRapidaBasicaUltimaMatriculaPeriodoPorGradeCurricularAtualTransferenciaMatrizCurricular(Integer matrizCurricular, Integer unidadeEnsino, Integer nrPeriodoLetivoInicial, Integer nrPeriodoLetivoFinal, String situacaoMatricula, Integer turma, String ano, String semestre, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE matricula.gradeCurricularAtual = ").append(matrizCurricular);
		if (situacaoMatricula.equals("TO")) {
			sqlStr.append(" AND matricula.situacao in ('AT', 'PR', 'TR')");
		} else {
			sqlStr.append(" AND matricula.situacao = '").append(situacaoMatricula).append("'");
		}
		sqlStr.append(" AND Matricula.UnidadeEnsino = ").append(unidadeEnsino);
		if (Uteis.isAtributoPreenchido(nrPeriodoLetivoInicial)) {
			sqlStr.append(" AND PeriodoLetivo.periodoLetivo >= ").append(nrPeriodoLetivoInicial);
		}
		if (Uteis.isAtributoPreenchido(nrPeriodoLetivoFinal)) {
			sqlStr.append(" AND PeriodoLetivo.periodoLetivo <= ").append(nrPeriodoLetivoFinal);
		}
		if (Uteis.isAtributoPreenchido(turma)) {
			sqlStr.append(" AND matriculaPeriodo.turma = ").append(turma);
		}
		sqlStr.append(" and MatriculaPeriodo.codigo IN (");
		sqlStr.append("select mp.codigo  from matriculaperiodo mp ");
		sqlStr.append("where mp.matricula = matricula.matricula ");
		sqlStr.append("and mp.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append("order by (mp.ano || '/' || mp.semestre) desc, case when mp.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, mp.codigo desc limit 1) ");
		sqlStr.append("ORDER BY (MatriculaPeriodo.ano||'/'|| MatriculaPeriodo.semestre) desc, periodoletivo.periodoletivo desc, pessoa.nome");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	public List<MatriculaPeriodoVO> consultaRapidaPorMatricula(String matricula, Integer unidadeEnsino, boolean controlarAcesso, DataModelo dataModelo, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (MatriculaPeriodo.matricula = ?) ");
		if (Uteis.isAtributoPreenchido(unidadeEnsino)) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		sqlStr.append(" ORDER BY matricula, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc ");
		if (Uteis.isAtributoPreenchido(dataModelo.getLimitePorPagina())) {
			sqlStr.append(" LIMIT ").append(dataModelo.getLimitePorPagina()).append(" OFFSET ").append(dataModelo.getOffset());
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), matricula);
		if (tabelaResultado.next()) {
			dataModelo.setTotalRegistrosEncontrados((tabelaResultado.getInt("totalRegistroConsulta")));
		}
		tabelaResultado.beforeFirst();
		return montarDadosConsultaBasica(tabelaResultado);
	}

	public List<MatriculaPeriodoVO> consultaRapidaMatriculaPeriodoAtivaSemMatriculaPeriodoVencimento(String parcela, String semestre, String ano, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE MatriculaPeriodo.semestre = '").append(semestre).append("' AND ");
		sqlStr.append("       MatriculaPeriodo.ano = '").append(ano).append("' AND ");
		sqlStr.append("       MatriculaPeriodo.situacaoMatriculaPeriodo = 'AT' AND ");
		sqlStr.append("       matricula.situacao <> 'CA' AND matricula.situacao <> 'TR AND ");
		sqlStr.append("       (MatriculaPeriodo.codigo not in ( ");
		sqlStr.append("         select MatriculaPeriodo from MatriculaPeriodoVencimento ");
		sqlStr.append("                    WHERE (parcela = '").append(parcela).append("'))");
		sqlStr.append("                       )");
		sqlStr.append(" ORDER BY MatriculaPeriodo.unidadeEnsinoCurso, MatriculaPeriodo.processoMatricula");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	public List<MatriculaPeriodoVO> consultaRapidaPorUnidadeCursoTurmaAlunoEntreDatasSituacaoParaSetransp(Integer unidadeEnsino, Integer curso, Integer turma, String aluno, Date dataInicio, Date dataFim, String situacao, String ano, String semestre, String tipoFiltroPeriodicidade) throws Exception {
		StringBuilder sqlStr = new StringBuilder("select p.codigo, p.idalunoinep, p.nome as nomepessoa, p.datanasc, m.matricula, p.endereco, p.complemento, ");
		sqlStr.append("p.setor, p.numero, c.nome as nomecidade from matriculaperiodo mp inner join matricula m on mp.matricula = m.matricula ");
		sqlStr.append("inner join pessoa p on m.aluno = p.codigo left join cidade c on p.cidade = c.codigo where ");
		if (Uteis.isAtributoPreenchido(unidadeEnsino)) {
			sqlStr.append("m.unidadeensino = ").append(unidadeEnsino).append(" and ");
		} else if (Uteis.isAtributoPreenchido(curso)) {
			sqlStr.append("m.curso = ").append(curso.intValue()).append(" and ");
		} else if (Uteis.isAtributoPreenchido(turma)) {
			sqlStr.append("mp.turma = ").append(turma.intValue()).append(" and ");
		} else if (Uteis.isAtributoPreenchido(aluno)) {
			sqlStr.append("m.matricula = '").append(aluno).append("' and ");
		}
		if (tipoFiltroPeriodicidade.equals("AN")) {
			if (Uteis.isAtributoPreenchido(ano)) {
				sqlStr.append(" mp.ano = '").append(ano).append("' and ");
			}
		} else if (tipoFiltroPeriodicidade.equals("IN")) {
			if (dataInicio != null) {
				sqlStr.append(" mp.data >= '").append(dataInicio).append("' and ");
			}
			if (dataFim != null) {
				sqlStr.append(" mp.data <= '").append(dataFim).append("' and ");
			}
		} else if (tipoFiltroPeriodicidade.equals("SE")) {
			if (Uteis.isAtributoPreenchido(ano)) {
				sqlStr.append(" mp.ano = '").append(ano).append("' and ");
			}
			if (Uteis.isAtributoPreenchido(semestre)) {
				sqlStr.append(" mp.semestre = '").append(semestre).append("' and ");
			}
		}
		sqlStr.append(" mp.situacaomatriculaperiodo = '").append(situacao).append("' and m.situacao = '").append(situacao).append("' ");
		sqlStr.append(" order by p.idalunoinep, p.nome");
		try {
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			return montarDadosConsultaSetransp(tabelaResultado);
		} catch (Exception e) {
			throw e;
		} finally {
			sqlStr = null;
		}
	}

	private List<MatriculaPeriodoVO> montarDadosConsultaSetransp(SqlRowSet tabelaResultado) throws Exception {
		List<MatriculaPeriodoVO> matriculaPeriodoVOs = new ArrayList<MatriculaPeriodoVO>(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO matriculaPeriodoVO = new MatriculaPeriodoVO();
			matriculaPeriodoVO.getMatriculaVO().getAluno().setIdAlunoInep(tabelaResultado.getString("idAlunoInep"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setNome(tabelaResultado.getString("nomePessoa"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setDataNasc(tabelaResultado.getDate("dataNasc"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setEndereco(tabelaResultado.getString("endereco"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setComplemento(tabelaResultado.getString("complemento"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setSetor(tabelaResultado.getString("setor"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setNumero(tabelaResultado.getString("numero"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().getCidade().setNome(tabelaResultado.getString("nomeCidade"));
			matriculaPeriodoVO.getMatriculaVO().setMatricula(tabelaResultado.getString("matricula"));
			List<FiliacaoVO> lista = getFacadeFactory().getFiliacaoFacade().consultarPorCodigoPessoaTipo(tabelaResultado.getInt("codigo"), "MA", false, null);
			if (!lista.isEmpty()) {
				matriculaPeriodoVO.getMatriculaVO().getAluno().setFiliacaoVOs(lista);
			}
			try {
				matriculaPeriodoVOs.add(matriculaPeriodoVO);
			} finally {
				matriculaPeriodoVO = null;
			}
		}
		return matriculaPeriodoVOs;
	}

	public List<MatriculaPeriodoVO> consultaRapidaPorUnidadeCursoTurmaAlunoEntreDatasSituacao(Integer unidadeEnsino, Integer curso, Integer turma, String aluno, Date dataInicio, Date dataFim, String situacao, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		String filtro = "";
		sqlStr.append("WHERE ");
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append("matricula.unidadeEnsino = ").append(unidadeEnsino).append(" ");
			filtro = "AND";
		}
		if (curso != null && curso != 0) {
			sqlStr.append("matricula.curso = ").append(curso.intValue()).append(" ");
			filtro = "AND";
		}
		if (turma != null && turma != 0) {
			sqlStr.append("matriculaperiodo.turma = ").append(turma.intValue()).append(" ");
			filtro = "AND";
		}
		if (aluno != null && !aluno.equals("")) {
			sqlStr.append("matriculaperiodo.matricula = '").append(aluno).append("' ");
			filtro = "AND";
		}
		if (dataInicio != null) {
			sqlStr.append(filtro).append(" matriculaperiodo.data >= '").append(dataInicio).append("' ");
			filtro = "AND";
		}
		if (dataFim != null) {
			sqlStr.append(filtro).append(" matriculaperiodo.data <= '").append(dataFim).append("' ");
			filtro = "AND";
		}
		if (situacao != null && !situacao.equals("")) {
			sqlStr.append(filtro).append(" matriculaperiodo.situacaomatriculaperiodo = '").append(situacao).append("'");
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		return montarDadosConsultaBasica(tabelaResultado);
	}
	
	public Integer consultaQuantidadeAlunoPorTurmaTurmaSituacaoMatriculaPeriodoESituacao(RenovacaoMatriculaTurmaVO renovacaoMatriculaTurmaVO, boolean controlarReprovacaoPeriodoLetivo,   Integer numeroDisciplinaConsiderarReprovadoPeriodoLetivo, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sb = new StringBuilder(" select t.totalRegistroConsulta from ( ");
		sb.append(getSQLPadraoConsultaBasica());
		sb.append(" left join planofinanceiroaluno on planofinanceiroaluno.matriculaperiodo = matriculaperiodo.codigo  ");
		sb.append(" where 1=1  ");
		realizarMontagemFiltroTurmaRenovacao(renovacaoMatriculaTurmaVO, controlarReprovacaoPeriodoLetivo, numeroDisciplinaConsiderarReprovadoPeriodoLetivo, sb);
		sb.append(" ) as t limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("totalRegistroConsulta");
		}
		return 0;
	}

	/**
	 * Método utilizado na consulta de alunos para renovação de matrícula por
	 * turma, respeitando as situaï¿½ï¿½es da matricula Período e que não sejam
	 * pendente financeiramente Integer turma, String ano, String semestre,
	 * String situacao, String pendenciaFinanceira, String aprovadoSemestre,
	 * Integer numeroDisciplinaConsiderarReprovadoPeriodoLetivo
	 */

	public List<MatriculaPeriodoVO> consultaRapidaPorTurmaTurmaSituacaoMatriculaPeriodoESituacao(RenovacaoMatriculaTurmaVO renovacaoMatriculaTurmaVO, boolean controlarReprovacaoPeriodoLetivo,   Integer numeroDisciplinaConsiderarReprovadoPeriodoLetivo, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sqlStr = new StringBuilder(getSQLPadraoConsultaBasica());
		sqlStr.append(" left join planofinanceiroaluno on planofinanceiroaluno.matriculaperiodo = matriculaperiodo.codigo  ");
		sqlStr.append(" where 1=1  ");
		realizarMontagemFiltroTurmaRenovacao(renovacaoMatriculaTurmaVO, controlarReprovacaoPeriodoLetivo, numeroDisciplinaConsiderarReprovadoPeriodoLetivo, sqlStr);
		sqlStr.append(" order by Pessoa.nome ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasicaEspecificoRenovacaoPorTurma(tabelaResultado, renovacaoMatriculaTurmaVO.getAprovadoSemestre(), configuracaoFinanceiro, usuario);
	}

	private void realizarMontagemFiltroTurmaRenovacao(RenovacaoMatriculaTurmaVO renovacaoMatriculaTurmaVO, boolean controlarReprovacaoPeriodoLetivo, Integer numeroDisciplinaConsiderarReprovadoPeriodoLetivo, StringBuilder sqlStr) {
		//sqlStr.append(" and  matricula.matricula = '1401844.34'");
		sqlStr.append(" and  matricula.situacao = 'AT'");
		
		sqlStr.append(" AND matriculaperiodo.situacaomatriculaperiodo not in('PC', 'IN', 'TR', 'CA', 'AC', 'PR', 'TS', 'TI', 'FO')");
		
		if(Uteis.isAtributoPreenchido(renovacaoMatriculaTurmaVO.getUnidadeEnsinoVO().getCodigo())) {
			sqlStr.append(" and matricula.unidadeensino = ").append(renovacaoMatriculaTurmaVO.getUnidadeEnsinoVO().getCodigo()).append(" ");	
		}
		
		if(Uteis.isAtributoPreenchido(renovacaoMatriculaTurmaVO.getCursoVO().getCodigo())) {
			sqlStr.append(" and matricula.curso = ").append(renovacaoMatriculaTurmaVO.getCursoVO().getCodigo()).append(" ");	
		}
		
		if(Uteis.isAtributoPreenchido(renovacaoMatriculaTurmaVO.getTurmaVO().getCodigo())) {
			sqlStr.append(" and matriculaperiodo.turma = ").append(renovacaoMatriculaTurmaVO.getTurmaVO().getCodigo()).append(" ");	
		}
		
		if(Uteis.isAtributoPreenchido(renovacaoMatriculaTurmaVO.getGradeCurricularAtual().getCodigo())) {
			sqlStr.append(" and matricula.gradecurricularatual = ").append(renovacaoMatriculaTurmaVO.getGradeCurricularAtual().getCodigo());	
		}
		
//		if (renovacaoMatriculaTurmaVO.getPlanoFinanceiroCursoAtual().getCodigo() > 0) {
//			sqlStr.append(" and matriculaperiodo.planofinanceirocurso = ").append(renovacaoMatriculaTurmaVO.getPlanoFinanceiroCursoAtual().getCodigo());
//		}
//		
//		if (renovacaoMatriculaTurmaVO.getCondicaoPagamentoPlanoFinanceiroCursoAtual().getCodigo() > 0) {
//			sqlStr.append(" and matriculaperiodo.condicaoPagamentoPlanoFinanceiroCurso = ").append(renovacaoMatriculaTurmaVO.getCondicaoPagamentoPlanoFinanceiroCursoAtual().getCodigo());
//		}
		
		if (!Uteis.isAtributoPreenchido(renovacaoMatriculaTurmaVO.getTurmaVO()) && renovacaoMatriculaTurmaVO.getPeriodoLetivoRenovar().getCodigo() > 0) {
			sqlStr.append(" and periodoLetivo.periodoletivo = ").append(renovacaoMatriculaTurmaVO.getPeriodoLetivoRenovar().getPeriodoLetivo()-1);
		}
		
		if (renovacaoMatriculaTurmaVO.getRenovarApenasAlunosRenovacaoAutomatica()) {
			sqlStr.append(" and Pessoa.renovacaoAutomatica = true ");
		}
		
		if (!renovacaoMatriculaTurmaVO.getAno().isEmpty()) {
			sqlStr.append(" AND matriculaPeriodo.ano = '").append(renovacaoMatriculaTurmaVO.getAno()).append("' ");
		}
		if (!renovacaoMatriculaTurmaVO.getSemestre().isEmpty()) {
			sqlStr.append(" AND matriculaPeriodo.semestre = '").append(renovacaoMatriculaTurmaVO.getSemestre()).append("' ");
		}
		if(Uteis.isAtributoPreenchido(renovacaoMatriculaTurmaVO.getProcessoMatriculaRenovar())) {
			sqlStr.append(" AND exists (select processomatriculaunidadeensino.codigo from processomatriculaunidadeensino where processomatriculaunidadeensino.unidadeensino =  matricula.unidadeensino and processomatriculaunidadeensino.processomatricula = ").append(renovacaoMatriculaTurmaVO.getProcessoMatriculaRenovar().getCodigo()).append(" ) ");
			sqlStr.append(" AND exists (select processomatriculacalendario.curso from processomatriculacalendario where processomatriculacalendario.processomatricula = ").append(renovacaoMatriculaTurmaVO.getProcessoMatriculaRenovar().getCodigo()).append(" and processomatriculacalendario.curso = matricula.curso and processomatriculacalendario.turno = matricula.turno ) ");
		}
		sqlStr.append(" AND matriculaPeriodo.matricula not in (select mp.matricula from matriculaperiodo mp where ");
		sqlStr.append(" mp.matricula = matricula.matricula and mp.situacaomatriculaperiodo != 'PC' ");
		if (!renovacaoMatriculaTurmaVO.getAno().isEmpty() && (renovacaoMatriculaTurmaVO.getSemestre().isEmpty() || renovacaoMatriculaTurmaVO.getSemestre().equals("2"))) {
			sqlStr.append(" and mp.ano = '").append(Integer.valueOf(renovacaoMatriculaTurmaVO.getAno()) + 1).append("' ");
		} else if (!renovacaoMatriculaTurmaVO.getAno().isEmpty()) {
			sqlStr.append(" and mp.ano = '").append(renovacaoMatriculaTurmaVO.getAno()).append("' ");
		}
		if (renovacaoMatriculaTurmaVO.getSemestre().equals("2")) {
			sqlStr.append(" and mp.semestre = '1' ");
		}
		if (renovacaoMatriculaTurmaVO.getSemestre().equals("1")) {
			sqlStr.append(" and mp.semestre = '2' ");
		}
		sqlStr.append(") ");

		if (controlarReprovacaoPeriodoLetivo) {
			sqlStr.append(" and matricula.matricula not in(");
			sqlStr.append(" select distinct historico.matricula from historico ");
			sqlStr.append(" inner join matriculaperiodo mp on mp.matricula = historico.matricula and mp.codigo = historico.matriculaperiodo ");
			sqlStr.append(" WHERE mp.codigo = matriculaperiodo.codigo ");
			sqlStr.append(" and historico.matrizcurricular = ").append(renovacaoMatriculaTurmaVO.getGradeCurricularAtual().getCodigo());
			sqlStr.append(" and historico.situacao in ('RE', 'RF', 'RP') ");
			sqlStr.append(" and (historico.historicoPorEquivalencia is null or historicoPorEquivalencia = false) ");
			sqlStr.append(" and (historico.historicoDisciplinaFazParteComposicao is null or historicoDisciplinaFazParteComposicao = false) ");
			if (!renovacaoMatriculaTurmaVO.getAno().equals("")) {
				sqlStr.append(" AND historico.anohistorico = '").append(renovacaoMatriculaTurmaVO.getAno()).append("' ");
			}
			if (!renovacaoMatriculaTurmaVO.getSemestre().equals("")) {
				sqlStr.append(" AND historico.semestrehistorico = '").append(renovacaoMatriculaTurmaVO.getSemestre()).append("' ");
			}
			sqlStr.append(" group by historico.matricula ");
			sqlStr.append(" HAVING count(historico.codigo) >= ").append(numeroDisciplinaConsiderarReprovadoPeriodoLetivo);
			sqlStr.append(") ");
		}
	}

	public List<MatriculaPeriodoVO> consultaRapidaMatriculaPeriodoAtivaSemCondicaoPagamentoPlanoFinanceiro(UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" inner join gradecurricular on gradecurricular.codigo = matriculaperiodo.gradecurricular ");
		sqlStr.append(" where condicaopagamentoplanofinanceirocurso is null and situacaomatriculaperiodo = 'AT' ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	public List consultarPorNomePessoa(String valorConsulta, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT MatriculaPeriodo.* FROM MatriculaPeriodo, Matricula, Pessoa WHERE MatriculaPeriodo.matricula = Matricula.matricula ";
		if (unidadeEnsino != 0) {
			sqlStr += "and matricula.unidadeEnsino = " + unidadeEnsino.intValue() + " ";
		}
		sqlStr += " and matricula.aluno = pessoa.codigo and sem_acentos(pessoa.nome) ilike('" + valorConsulta + "%') ORDER BY MatriculaPeriodo.matricula, MatriculaPeriodo.ano, MatriculaPeriodo.semestre";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

    public List<MatriculaPeriodoVO> consultaRapidaPorNomePessoa(String nomePessoa, Integer unidadeEnsino, boolean controlarAcesso, String situacao, String ano, String semestre, UsuarioVO usuario,DataModelo dataModelo) throws Exception {
    	  ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
          StringBuffer sqlStr = getSQLPadraoConsultaBasica();
          sqlStr.append(" WHERE sem_acentos(Pessoa.nome) ilike sem_acentos(?) ");
          if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
              sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
          }
          if ((situacao != null) && (!situacao.equals("")) && (!situacao.equals("TO"))) {
              sqlStr.append(" AND (Matricula.situacao = '").append(situacao).append("') ");
          }
          if (ano != null && !ano.equals("")) {
          	sqlStr.append(" AND (MatriculaPeriodo.ano = '").append(ano).append("') ");
          }
          if (semestre != null && !semestre.equals("")) {
          	sqlStr.append(" AND (MatriculaPeriodo.semestre = '").append(semestre).append("') ");
          }        
          sqlStr.append(" ORDER BY Pessoa.nome, MatriculaPeriodo.data desc, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc");
  		if (Uteis.isAtributoPreenchido(dataModelo.getLimitePorPagina())) {
  			sqlStr.append(" LIMIT ").append(dataModelo.getLimitePorPagina()).append(" OFFSET ").append(dataModelo.getOffset());
  		}
          SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[]{Uteis.removerAcentuacao(nomePessoa.toLowerCase().trim()) + "%"});
  		 
  		if (tabelaResultado.next()) {
  			dataModelo.setTotalRegistrosEncontrados((tabelaResultado.getInt("totalRegistroConsulta")));
  		}
  		tabelaResultado.beforeFirst();
          return montarDadosConsultaBasica(tabelaResultado);
    }
    
    @Override
    public List<MatriculaPeriodoVO> consultaRapidaPorRegistroAcademicoPessoa(String nomePessoa, Integer unidadeEnsino, boolean controlarAcesso, String situacao, String ano, String semestre, UsuarioVO usuario,DataModelo dataModelo) throws Exception {
  	  ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
        StringBuffer sqlStr = getSQLPadraoConsultaBasica();
        sqlStr.append(" WHERE sem_acentos(Pessoa.registroAcademico) ilike sem_acentos(?) ");
        if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
            sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
        }
        if ((situacao != null) && (!situacao.equals("")) && (!situacao.equals("TO"))) {
            sqlStr.append(" AND (Matricula.situacao = '").append(situacao).append("') ");
        }
        if (ano != null && !ano.equals("")) {
        	sqlStr.append(" AND (MatriculaPeriodo.ano = '").append(ano).append("') ");
        }
        if (semestre != null && !semestre.equals("")) {
        	sqlStr.append(" AND (MatriculaPeriodo.semestre = '").append(semestre).append("') ");
        }        
        sqlStr.append(" ORDER BY Pessoa.nome, MatriculaPeriodo.data desc, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc");
		if (Uteis.isAtributoPreenchido(dataModelo.getLimitePorPagina())) {
			sqlStr.append(" LIMIT ").append(dataModelo.getLimitePorPagina()).append(" OFFSET ").append(dataModelo.getOffset());
		}
        SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[]{Uteis.removerAcentuacao(nomePessoa.toLowerCase().trim()) + "%"});
		 
		if (tabelaResultado.next()) {
			dataModelo.setTotalRegistrosEncontrados((tabelaResultado.getInt("totalRegistroConsulta")));
		}
		tabelaResultado.beforeFirst();
        return montarDadosConsultaBasica(tabelaResultado);
  }

	public List consultarPorNomeCurso(String valorConsulta, Integer unidadeEnsino, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT MatriculaPeriodo.* FROM MatriculaPeriodo, Matricula, Pessoa, Curso WHERE MatriculaPeriodo.matricula = Matricula.matricula and matricula.curso = curso.codigo and matricula.aluno = pessoa.codigo";
		if (unidadeEnsino != 0) {
			sqlStr += "and matricula.unidadeEnsino = " + unidadeEnsino.intValue() + " ";
		}
		sqlStr += " and curso.nome ilike('" + valorConsulta + "%') ORDER BY MatriculaPeriodo.matricula, MatriculaPeriodo.ano, MatriculaPeriodo.semestre";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

    public List<MatriculaPeriodoVO> consultaRapidaPorNomeCursoTurnoSituacao(String nomeCurso, Integer unidadeEnsino, Integer turno, String situacao, String ano, String semestre, boolean controlarAcesso, UsuarioVO usuario,DataModelo dataModelo) throws Exception {
    	ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
        StringBuffer sqlStr = getSQLPadraoConsultaBasica();
        sqlStr.append(" WHERE (sem_acentos(Curso.nome) ilike(sem_acentos(?))) ");
        if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
            sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
        }
        if ((turno != null) && (turno.intValue() != 0)) {
            sqlStr.append(" AND (Matricula.turno = ").append(turno.intValue()).append(") ");
        }
        if ((situacao != null) && (!situacao.equals("")) && (!situacao.equals("TO"))) {
            // Filtro de matriculas ativas (somente as ativas ou todas)
            if (situacao.equals("PR")) {
                sqlStr.append(" AND (MatriculaPeriodo.situacaoMatriculaPeriodo = '").append(situacao).append("') ");
            } else {
                sqlStr.append(" AND (MatriculaPeriodo.situacaoMatriculaPeriodo = '").append(situacao).append("') ");
                sqlStr.append(" AND (Matricula.situacao = '").append(situacao).append("') ");
            }
        }
        if (ano != null && !ano.equals("")) {
        	sqlStr.append(" AND (MatriculaPeriodo.ano = '").append(ano).append("') ");
        }
        if (semestre != null && !semestre.equals("")) {
        	sqlStr.append(" AND (MatriculaPeriodo.semestre = '").append(semestre).append("') ");
        }        
        sqlStr.append(" ORDER BY Curso.nome, Pessoa.nome, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc ");
		if (Uteis.isAtributoPreenchido(dataModelo.getLimitePorPagina())) {
			sqlStr.append(" LIMIT ").append(dataModelo.getLimitePorPagina()).append(" OFFSET ").append(dataModelo.getOffset());
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), nomeCurso + PERCENT);
		if (tabelaResultado.next()) {
			dataModelo.setTotalRegistrosEncontrados((tabelaResultado.getInt("totalRegistroConsulta")));
		}
		tabelaResultado.beforeFirst();
        return montarDadosConsultaBasica(tabelaResultado);
    }

    public List<MatriculaPeriodoVO> consultaRapidaPorIdentificadorTurmaSituacaoMatriculaPeriodo(String identificadorTurma, Integer unidadeEnsino, String situacao, String ano, String semestre, boolean controlarAcesso, UsuarioVO usuario,DataModelo dataModelo) throws Exception {
    	ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
        StringBuffer sqlStr = getSQLPadraoConsultaBasica();
        sqlStr.append(" WHERE (Turma.identificadorTurma = ?) ");
        if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
            sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
        }
        if ((situacao != null) && (!situacao.equals("")) && (!situacao.equals("TO"))) {
            sqlStr.append(" AND (Matricula.situacao = '").append(situacao).append("') ");
        }
        if (ano != null && !ano.equals("")) {
        	sqlStr.append(" AND (MatriculaPeriodo.ano = '").append(ano).append("') ");
        }
        if (semestre != null && !semestre.equals("")) {
        	sqlStr.append(" AND (MatriculaPeriodo.semestre = '").append(semestre).append("') ");
        }
        sqlStr.append(" ORDER BY Turma.identificadorTurma, Pessoa.nome, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc ");
		if (Uteis.isAtributoPreenchido(dataModelo.getLimitePorPagina())) {
			sqlStr.append(" LIMIT ").append(dataModelo.getLimitePorPagina()).append(" OFFSET ").append(dataModelo.getOffset());
		}
        SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), identificadorTurma);
    	if (tabelaResultado.next()) {
			dataModelo.setTotalRegistrosEncontrados((tabelaResultado.getInt("totalRegistroConsulta")));
		}
		tabelaResultado.beforeFirst();
        return montarDadosConsultaBasica(tabelaResultado);
    }

	public List consultaRapidaPorNomeCurso(String nomeCurso, Integer unidadeEnsino, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (Curso.nome ilike('").append(nomeCurso.toLowerCase()).append("%')) ");
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		sqlStr.append(" ORDER BY Curso.nome, Pessoa.nome, MatriculaPeriodo.codigo ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	public List consultaRapidaPorNomeCursoAnoSemestre(String nomeCurso, Integer unidadeEnsino, String ano, String semestre, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (sem_acentos(Curso.nome) ilike sem_acentos('").append(Uteis.removerAcentuacao(nomeCurso.toLowerCase())).append("%')) ");
		sqlStr.append(" AND MatriculaPeriodo.ano = '").append(ano).append("' AND MatriculaPeriodo.semestre = '").append(semestre).append("' ");
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		sqlStr.append(" ORDER BY Curso.nome, Pessoa.nome, MatriculaPeriodo.codigo ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	public List<MatriculaPeriodoVO> consultaRapidaPorCursoGradeCurricularPeriodoLetivoTurmaAnoSemestre(Integer codCurso, Integer gradeCurricular, Integer periodoLetivo, Integer turma, String ano, String semestre, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaMinima();
		sqlStr.append("WHERE curso.codigo = ").append(codCurso);
		sqlStr.append(" AND matriculaperiodo.gradeCurricular = ").append(gradeCurricular);
		if ((periodoLetivo != null) && (periodoLetivo != 0)) {
			sqlStr.append(" AND matriculaperiodo.periodoLetivoMatricula = ").append(periodoLetivo);
		}
		if ((turma != null) && (turma != 0)) {
			sqlStr.append(" AND turma.codigo = ").append(turma).append(" ");
		}
		if (!ano.equals("")) {
			sqlStr.append("AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sqlStr.append("AND matriculaperiodo.semestre = '").append(semestre).append("' ");
		}
		sqlStr.append("AND matricula.situacao = 'AT'");
		sqlStr.append("ORDER BY pessoa.nome");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			montarDadosMinimos(obj, tabelaResultado);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<MatriculaPeriodoVO> consultaRapidaPorData(Date prmIni, Date prmFim, Integer unidadeEnsino, boolean controlarAcesso, UsuarioVO usuario,DataModelo dataModelo) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (MatriculaPeriodo.data between '").append(Uteis.getDataJDBC(prmIni)).append("' AND '").append(Uteis.getDataJDBC(prmFim)).append("')");
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		sqlStr.append(" ORDER BY MatriculaPeriodo.data, Pessoa.nome ");
		if (Uteis.isAtributoPreenchido(dataModelo.getLimitePorPagina())) {
			sqlStr.append(" LIMIT ").append(dataModelo.getLimitePorPagina()).append(" OFFSET ").append(dataModelo.getOffset());
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			dataModelo.setTotalRegistrosEncontrados((tabelaResultado.getInt("totalRegistroConsulta")));
		}
		tabelaResultado.beforeFirst();
		return montarDadosConsultaBasica(tabelaResultado);
	}

	public MatriculaPeriodoVO consultaRapidaPorMatriculaSemestreAno(String matricula, String semestre, String ano, boolean retornarExcecao, boolean controlarAcesso, Optional<Date> dataInicio, Optional<Date> dataFim, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		List<String> parametros = new ArrayList<>();
		sqlStr.append(" WHERE matricula.matricula = ? ");
		parametros.add(matricula);
		if (Uteis.isAtributoPreenchido(ano)) {
			sqlStr.append("AND matriculaperiodo.ano = ? ");
			parametros.add(ano);
		}
		if (Uteis.isAtributoPreenchido(semestre)) {
			sqlStr.append("AND matriculaperiodo.semestre = ? ");
			parametros.add(semestre);
		}
		dataInicio.ifPresent(dt -> sqlStr.append(" AND matriculaperiodo.data >= '").append(dt).append("' "));
		dataFim.ifPresent(dt -> sqlStr.append(" AND matriculaperiodo.data <= '").append(dt).append("' "));
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), parametros.toArray());
		MatriculaPeriodoVO matriculaPeriodoVO = new MatriculaPeriodoVO();
		if (!tabelaResultado.next()) {
			if(retornarExcecao){
				throw new Exception("Aluno não matriculado nesse ano e semestre.");
			}else{
				return matriculaPeriodoVO;
			}
		}
		montarDadosBasico(matriculaPeriodoVO, tabelaResultado);
		return matriculaPeriodoVO;
	}

	public Integer consultaRapidaPorCodigoMatPer_CodigoAlternativoGeracaoBoletoSicoob(Integer codigo) throws Exception {
		StringBuffer sqlStr = new StringBuffer();
		sqlStr.append(" select sequencialcodmatperalternativoboleto from matriculaperiodo WHERE codigo = ").append(codigo).append(" ");
		return getConexao().getJdbcTemplate().queryForInt(sqlStr.toString());
	}

	public MatriculaPeriodoVO consultaRapidaPorMatriculaSemestreAnoSemExcecao(String matricula, String semestre, String ano, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE matricula.matricula = '").append(matricula).append("' and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		if (!ano.equals("")) {
			sqlStr.append("AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sqlStr.append("AND matriculaperiodo.semestre = '").append(semestre).append("' ");
		}
		sqlStr.append("order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, PeriodoLetivo.PeriodoLetivo desc, matriculaperiodo.codigo desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO matriculaPeriodoVO = new MatriculaPeriodoVO();
		if (!tabelaResultado.next()) {
			return new MatriculaPeriodoVO();
		}
		montarDadosBasico(matriculaPeriodoVO, tabelaResultado);
		return matriculaPeriodoVO;
	}

	public MatriculaPeriodoVO consultaRapidaPorMatriculaNrPeriodoLetivo(String matricula, Integer periodoLetivo, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" where matriculaperiodo.matricula = '").append(matricula).append("' and periodoletivo.periodoletivo = ").append(periodoLetivo).append(" limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO matriculaPeriodoVO = new MatriculaPeriodoVO();
		if (!tabelaResultado.next()) {
			return new MatriculaPeriodoVO();
		}
		montarDadosBasico(matriculaPeriodoVO, tabelaResultado);
		return matriculaPeriodoVO;
	}

	public MatriculaPeriodoVO consultaRapidaPorMatriculaTurma(String matricula, Integer turma, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" where matriculaperiodo.matricula = '").append(matricula).append("' and matriculaPeriodo.turma = ").append(turma).append(" limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO matriculaPeriodoVO = new MatriculaPeriodoVO();
		if (!tabelaResultado.next()) {
			return new MatriculaPeriodoVO();
		}
		montarDadosBasico(matriculaPeriodoVO, tabelaResultado);
		return matriculaPeriodoVO;
	}

	public MatriculaPeriodoVO consultaRapidaPorHistoricoDadosGradeCurricular(Integer historico, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sb = new StringBuilder();
		sb.append("SELECT matriculaPeriodo.codigo, matriculaPeriodo.turma, matriculaPeriodo.periodoletivomatricula as periodoletivomatricula, gradeCurricular.codigo AS \"gradeCurricular.codigo\", ");
		sb.append(" gradeCurricular.nome AS \"gradeCurricular.nome\" ");
		sb.append(" FROM matriculaPeriodo ");
		sb.append(" INNER JOIN historico ON historico.matriculaPeriodo = matriculaPeriodo.codigo ");
		sb.append(" INNER JOIN gradeCurricular ON gradeCurricular.codigo = matriculaPeriodo.gradeCurricular ");
		sb.append(" WHERE historico.codigo = ").append(historico);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getGradeCurricular().setCodigo(tabelaResultado.getInt("gradeCurricular.codigo"));
			obj.getGradeCurricular().setNome(tabelaResultado.getString("gradeCurricular.nome"));
			obj.getTurma().setCodigo(tabelaResultado.getInt("turma"));
			obj.getPeridoLetivo().setCodigo(tabelaResultado.getInt("periodoletivomatricula"));
			return obj;
		}
		return obj;
	}

	public MatriculaPeriodoVO consultaRapidaMatriculaPeriodoUnica(String matricula, Integer unidadeEnsino, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (MatriculaPeriodo.matricula like('").append(matricula).append("%')) ");
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		sqlStr.append(" AND situacaomatriculaperiodo <> 'PC' ORDER BY matricula, MatriculaPeriodo.codigo ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO matriculaPeriodoVO = new MatriculaPeriodoVO();
		if (!tabelaResultado.next()) {
			return new MatriculaPeriodoVO();
		}
		montarDadosBasico(matriculaPeriodoVO, tabelaResultado);
		return matriculaPeriodoVO;
	}

	public List<MatriculaPeriodoVO> consultaRapidaMatriculaPeriodoUnicaPorTurma(List<MatriculaVO> listaMatriculaVO, Integer unidadeEnsino, Integer turma, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE MatriculaPeriodo.turma = ").append(turma).append(" ");
		if (listaMatriculaVO != null && !listaMatriculaVO.isEmpty()) {
			sqlStr.append(" AND MatriculaPeriodo.matricula in ( ");
			for (MatriculaVO matriculaVO : listaMatriculaVO) {
				sqlStr.append("'").append(matriculaVO.getMatricula()).append("' ");
				if (!matriculaVO.getMatricula().equals(listaMatriculaVO.get(listaMatriculaVO.size() - 1).getMatricula())) {
					sqlStr.append(", ");
				} else {
					sqlStr.append(") ");
				}
			}
		}
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		sqlStr.append(" AND situacaomatriculaperiodo <> 'PC' ORDER BY matricula, MatriculaPeriodo.codigo ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO obj = null;
		while (tabelaResultado.next()) {
			obj = new MatriculaPeriodoVO();
			montarDadosBasico(obj, tabelaResultado);
			vetResultado.add(obj);
		}
		return vetResultado;
	}
	
	public List<MatriculaPeriodoVO> consultaRapidaMatriculaPeriodoUnicaParaReposicaoAlunoTurma(Integer unidadeEnsino, Integer turma, boolean isAlunoQueEstaoFazendoReposicaoNessaTurma, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" inner join matriculaperiodoturmadisciplina on matriculaperiodoturmadisciplina.matriculaperiodo = matriculaperiodo.codigo ");
		sqlStr.append( "where  matriculaperiodo.turma != matriculaperiodoturmadisciplina.turma ");
		if(isAlunoQueEstaoFazendoReposicaoNessaTurma){
			sqlStr.append(" and matriculaperiodoturmadisciplina.turma = ").append(turma).append(" ");	
		}else{
			sqlStr.append(" and MatriculaPeriodo.turma = ").append(turma).append(" ");
		}
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" and matricula.unidadeEnsino=").append(unidadeEnsino);
		}
		sqlStr.append(" AND situacaomatriculaperiodo <> 'PC' ORDER BY matricula, MatriculaPeriodo.codigo ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO obj = null;
		while (tabelaResultado.next()) {
			obj = new MatriculaPeriodoVO();
			montarDadosBasico(obj, tabelaResultado);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<MatriculaPeriodoVO> consultaRapidaMatriculaPeriodoUnicaPorTurmaSituacao(TurmaVO turma, List<TurmaDisciplinaVO> listaTurmaDisciplinaVO, List<String> listaMensagemErro, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE matriculaPeriodo.turma = ").append(turma.getCodigo());
		if ( Uteis.isAtributoPreenchido(turma.getUnidadeEnsino().getCodigo())) {
			sqlStr.append(" AND matricula.unidadeensino = ").append(turma.getUnidadeEnsino().getCodigo());
		}
		sqlStr.append(" AND matricula.situacao = 'AT' AND matriculaPeriodo.situacaoMatriculaPeriodo in ('AT', 'PR') ");
		sqlStr.append(" AND matriculaPeriodo.matricula in( ");
		sqlStr.append("select mtd.matricula from ( ");
		sqlStr.append("select t.matricula, g.disciplina from ( ");
		sqlStr.append("select distinct mp.matricula from matriculaperiodo mp ");
		sqlStr.append("where mp.turma = ").append(turma.getCodigo()).append(") as t ");
		sqlStr.append(",(select distinct disciplina from turmadisciplina ");
		sqlStr.append("where turma = ").append(turma.getCodigo()).append(") as g) as mtd ");
		sqlStr.append("where mtd.matricula || mtd.disciplina not in ( ");
		sqlStr.append("select historico.matricula || historico.disciplina from historico ");
		sqlStr.append("WHERE historico.matricula in (");
		sqlStr.append("SELECT MatriculaPeriodo.matricula ");
		sqlStr.append("FROM MatriculaPeriodo ");
		sqlStr.append("INNER JOIN Matricula ON (MatriculaPeriodo.matricula = Matricula.matricula) ");
		sqlStr.append("where MatriculaPeriodo.turma = ").append(turma.getCodigo()).append(" ");
		if (turma.getUnidadeEnsino().getCodigo() != null && turma.getUnidadeEnsino().getCodigo().intValue() != 0) {
			sqlStr.append(" AND matricula.unidadeensino = ").append(turma.getUnidadeEnsino().getCodigo());
		}
		sqlStr.append(") ");
		if (!listaTurmaDisciplinaVO.isEmpty()) {
			sqlStr.append(" AND historico.disciplina in ( ");
			for (TurmaDisciplinaVO turmaDisciplinaVO : listaTurmaDisciplinaVO) {
				sqlStr.append(turmaDisciplinaVO.getDisciplina().getCodigo());
				if (!turmaDisciplinaVO.getDisciplina().getCodigo().equals(listaTurmaDisciplinaVO.get(listaTurmaDisciplinaVO.size() - 1).getDisciplina().getCodigo())) {
					sqlStr.append(", ");
				} else {
					sqlStr.append(") ");
				}
			}
			sqlStr.append(" AND historico.situacao not in('AP', 'AA', 'CC', 'CH') )");
		} else {
			sqlStr.append(" ) ");
		}
		sqlStr.append(") ORDER BY pessoa.nome ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO obj = null;
		while (tabelaResultado.next()) {
			Boolean erro = Boolean.FALSE;
			obj = new MatriculaPeriodoVO();
			montarDadosBasico(obj, tabelaResultado);
			if (!Uteis.isAtributoPreenchido(obj.getMatriculaVO().getGradeCurricularAtual())) {
				listaMensagemErro.add("Grade curricular atual do aluno de matrícula (" + obj.getMatriculaVO().getMatricula() + ") não foi encontrada.");
				erro = Boolean.TRUE;
			} else if (Uteis.isAtributoPreenchido(obj.getMatriculaVO().getGradeCurricularAtual()) && (!obj.getMatriculaVO().getGradeCurricularAtual().getCodigo().equals(turma.getGradeCurricularVO().getCodigo()))) {
				listaMensagemErro.add("Grade curricular atual do aluno (" + obj.getMatriculaVO().getGradeCurricularAtual().getCodigo() + " - " + obj.getMatriculaVO().getGradeCurricularAtual().getNome() +") de matrícula (" + obj.getMatriculaVO().getMatricula() + ") não é compatível a grade da turma (" + turma.getGradeCurricularVO().getCodigo() + " - " + turma.getGradeCurricularVO().getNome() + ").");
				erro = Boolean.TRUE;
			}
			if (!erro) {
				vetResultado.add(obj);
			}
		}
		return vetResultado;
	}

	public List<MatriculaPeriodoVO> consultaRapidaMatriculaNrPeriodoLetivo(String matricula, Integer periodoLetivo, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" where matriculaperiodo.matricula = '").append(matricula).append("' and periodoletivo.periodoletivo = ").append(periodoLetivo);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO obj = null;
		while (tabelaResultado.next()) {
			obj = new MatriculaPeriodoVO();
			montarDadosBasico(obj, tabelaResultado);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List consultarPorMatriculaMatriculaSemestreAno(String valorConsulta, String semestre, String ano, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT MatriculaPeriodo.* FROM MatriculaPeriodo, Matricula WHERE MatriculaPeriodo.matricula = Matricula.matricula and Matricula.matricula like('" + valorConsulta + "') and MatriculaPeriodo.semestre = '" + semestre + "' and MatriculaPeriodo.ano = '" + ano + "' order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public List<MatriculaPeriodoVO> executarEfetivacaoMatriculasPeriodoPreMatriculadas(List<MatriculaPeriodoVO> listaPreMatriculados, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		Iterator<MatriculaPeriodoVO> i = listaPreMatriculados.iterator();
		while (i.hasNext()) {
			MatriculaPeriodoVO m = i.next();
			if (m.getSelecionarMatriculaPeriodoRenovar()) {
				try {
					m.setApresentarSituacao(true);
					this.validarMatriculaPeriodoPodeSerAtivada(m.getMatriculaVO(), m, configuracaoFinanceiro, usuario);
					getFacadeFactory().getMatriculaFacade().alterarSituacaoMatriculaVOParaAtivada(m.getMatriculaVO(), m, usuario, configuracaoFinanceiro);
				} catch (Exception e) {
					m.setErro(true);
					m.setMensagemErro(e.getMessage());
					throw e;
				}
			}
		}
		return listaPreMatriculados;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void executarValidacaoParaEfetivarMatriculasPeriodoPreMatriculadas(List<MatriculaPeriodoVO> listaPreMatriculados, ConfiguracaoFinanceiroVO configuracaoFinanceiro, ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO, UsuarioVO usuario) throws Exception {
		if (!Uteis.isAtributoPreenchido(listaPreMatriculados) || listaPreMatriculados.stream().noneMatch(MatriculaPeriodoVO::getSelecionarMatriculaPeriodoRenovar)) {
			throw new Exception("Deve ser selecionado ao menos um aluno para realizar a operação!");
		}
		executarEfetivacaoMatriculasPeriodoPreMatriculadas(listaPreMatriculados, configuracaoFinanceiro, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public MatriculaPeriodoVO efetivarMatriculaPeriodoPreMatriculada(MatriculaPeriodoVO m, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario, boolean realizandoRecebimento) throws Exception {
		try {
			m.setApresentarSituacao(true);
			if (!realizandoRecebimento) {
				this.validarMatriculaPeriodoPodeSerAtivada(m.getMatriculaVO(), m, configuracaoFinanceiro, usuario);
			}
			getFacadeFactory().getMatriculaFacade().alterarSituacaoMatriculaVOParaAtivada(m.getMatriculaVO(), m, usuario, configuracaoFinanceiro);
			getFacadeFactory().getMatriculaFacade().incluirLogPreMatricula(m.getMatriculaVO(), m, "Ativação pré-Matrícula", usuario);
		} catch (Exception e) {
			m.setErro(true);
			m.setMensagemErro(e.getMessage());
			throw e;
		}
		return m;
	}

	@Override
	public List<MatriculaPeriodoVO> consultarPorUndiadeEnsinoProcessoMatriculaCursoTurnoTurmaSituacaoMatricula(String matricula, Integer unidadeEnsino, Integer procMatricula, Integer curso, Integer turno, Integer turma, String situacao, boolean somenteParcelaMatricula, String situacaoPreMatricula, boolean ocorreuPrimeiraAula, Boolean trazerPreMatriculasCanceladas, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("select distinct matriculaperiodo.codigo, matriculaperiodo.situacaomatriculaperiodo, matriculaperiodo.situacao, matricula.consultor, periodoletivo.descricao as \"descricao\", matricula.tranferenciaentrada  as matricula_tranferenciaentrada, ");
		sb.append(" matricula.unidadeEnsino, matricula.matricula, pessoa.codigo AS \"pessoa.codigo\", pessoa.nome AS \"pessoa.nome\", pessoa.email \"pessoa.email\", pessoa.celular as \"pessoa.celular\", curso.codigo AS \"curso.codigo\", curso.nome AS \"curso.nome\", matricula.bloqueioPorSolicitacaoLiberacaoMatricula, ");
		sb.append(" matriculaperiodo.ano, matriculaperiodo.semestre ");
		sb.append(" from matriculaperiodo ");
		sb.append(" inner join unidadeEnsinoCurso on unidadeensinocurso.codigo = matriculaperiodo.unidadeensinocurso ");
		sb.append(" inner join matricula on matricula.matricula = matriculaperiodo.matricula ");
		sb.append(" inner join curso on curso.codigo = matricula.curso ");
		sb.append(" inner join pessoa on pessoa.codigo = matricula.aluno ");
		sb.append(" inner join turma on turma.codigo = matriculaperiodo.turma ");
		sb.append(" inner join periodoletivo on matriculaperiodo.periodoletivomatricula = periodoletivo.codigo ");
		if (ocorreuPrimeiraAula) {
			sb.append(" inner join horarioturma on horarioturma.turma = turma.codigo ");
			sb.append(" inner join horarioturmadia on horarioturmadia.horarioturma = horarioturma.codigo ");
		}
		sb.append(" left join matriculaperiodovencimento on matriculaperiodovencimento.matriculaperiodo = matriculaperiodo.codigo ");
		if (trazerPreMatriculasCanceladas) {
			sb.append(" where matriculaPeriodo.situacaoMatriculaPeriodo = 'PC' ");
		} else {
			sb.append(" where matriculaPeriodo.situacaoMatriculaPeriodo in ('PR','PC') ");
		}
		sb.append(" and matricula.situacao in ('AT') ");
		if (unidadeEnsino != null && !unidadeEnsino.equals(0)) {
			sb.append(" and unidadeensinocurso.unidadeEnsino = ").append(unidadeEnsino);
		}
		if (curso != null && curso.intValue() != 0) {
			sb.append(" and unidadeEnsinoCurso.curso = ").append(curso.intValue());
		}
		if (turma != null && turma.intValue() != 0) {
			sb.append(" and turma.codigo = ").append(turma.intValue());
		}
		if (turno != null && turno.intValue() != 0) {
			sb.append(" and turma.turno = ").append(turno.intValue());
		}
		if(Uteis.isAtributoPreenchido(matricula)) {
			sb.append(" and matriculaperiodo.matricula = '").append(matricula).append("' ");
		}
		if (situacao != null && !situacao.equals("todos")) {
			if (situacao.equals("GP")) {
				sb.append(" and matriculaPeriodoVencimento.situacao = '").append(situacao).append("' ");
			} else {
				sb.append(" and matriculaPeriodoVencimento.situacao <> 'GP' ");
			}
		}
		if (ocorreuPrimeiraAula) {
			sb.append(" and horarioturmadia.data <= current_date ");
		}
		if (Uteis.isAtributoPreenchido(procMatricula) && !Uteis.isAtributoPreenchido(matricula)) {
			sb.append("and matriculaperiodo.processomatricula = ").append(procMatricula);
		}
		sb.append(" Order by pessoa.nome, matricula.matricula");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		return montarDadosConsultaConfirmacaoPreMatricula(tabelaResultado, configuracaoFinanceiroVO, usuario);
	}

	public List<MatriculaPeriodoVO> montarDadosConsultaConfirmacaoPreMatricula(SqlRowSet tabelaResultado, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO obj = null;
		while (tabelaResultado.next()) {
			vetResultado.add(montarDadosConfirmacaoPreMatricula(tabelaResultado, obj, configuracaoFinanceiroVO, usuario));
		}
		return vetResultado;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.SUPPORTS)
	public MatriculaPeriodoVO montarDadosConfirmacaoPreMatricula(SqlRowSet dadosSQL, MatriculaPeriodoVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) {
		obj = new MatriculaPeriodoVO();
		obj.setCodigo(dadosSQL.getInt("codigo"));
		obj.setAno(dadosSQL.getString("ano"));
		obj.setSemestre(dadosSQL.getString("semestre"));
		obj.setSituacaoMatriculaPeriodo(dadosSQL.getString("situacaoMatriculaPeriodo"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.getMatriculaVO().setMatricula(dadosSQL.getString("matricula"));
		obj.setMatricula(dadosSQL.getString("matricula"));
		obj.getMatriculaVO().getAluno().setCodigo(dadosSQL.getInt("pessoa.codigo"));
		obj.getMatriculaVO().getAluno().setNome(dadosSQL.getString("pessoa.nome"));
		obj.getMatriculaVO().getAluno().setEmail(dadosSQL.getString("pessoa.email"));
		obj.getMatriculaVO().getAluno().setCelular(dadosSQL.getString("pessoa.celular"));
		obj.getMatriculaVO().getCurso().setCodigo(dadosSQL.getInt("curso.codigo"));
		obj.getMatriculaVO().getCurso().setNome(dadosSQL.getString("curso.nome"));
		obj.getMatriculaVO().getUnidadeEnsino().setCodigo(dadosSQL.getInt("unidadeEnsino"));
		obj.getMatriculaVO().getConsultor().setCodigo(dadosSQL.getInt("consultor"));
		obj.getMatriculaVO().getTransferenciaEntrada().setCodigo(dadosSQL.getInt("matricula_tranferenciaentrada"));
		obj.getPeridoLetivo().setDescricao(dadosSQL.getString("descricao"));
		obj.getMatriculaVO().setBloqueioPorSolicitacaoLiberacaoMatricula(dadosSQL.getBoolean("bloqueioPorSolicitacaoLiberacaoMatricula"));
		return obj;
	}

	public List consultarPorUnidadeEnsino_ProcMatricula_Matricula_Situacao(Integer unidadeEnsino, Integer procMatricula, Integer curso, Integer turno, Integer turma, String situacao, String matricula, boolean somenteParcelaMatricula, String situacaoPreMatricula, boolean ocorreuPrimeiraAula, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "select distinct (matriculaPeriodo.*) from matriculaPeriodo, unidadeEnsinoCurso, turma, matriculaPeriodoVencimento, matricula, horarioturmadia, horarioturma " + " where matriculaPeriodo.unidadeEnsinoCurso = unidadeEnsinoCurso.codigo " + " and matriculaPeriodo.matricula = matricula.matricula " + " and horarioturma.turma = matriculaperiodo.turma and horarioturmadia.horarioturma = horarioturma.codigo " + " and matriculaPeriodo.situacaoMatriculaPeriodo = 'PR' " + " and matricula.situacao = 'AT' ";
		if (unidadeEnsino != null && unidadeEnsino.intValue() != 0) {
			sqlStr += " and unidadeEnsinoCurso.unidadeEnsino = " + unidadeEnsino.intValue();
		}
		if (procMatricula != null && procMatricula.intValue() != 0) {
			sqlStr += " and matriculaPeriodo.processomatricula = " + procMatricula.intValue();
		}
		if (matricula != null && !matricula.equals("")) {
			sqlStr += " and matriculaPeriodo.matricula = '" + matricula + "' ";
		}
		if (curso != null && curso.intValue() != 0) {
			sqlStr += " and unidadeEnsinoCurso.curso = " + curso.intValue();
		}
		sqlStr += " and matriculaPeriodo.turma = turma.codigo ";
		if (turma != null && turma.intValue() != 0) {
			sqlStr += " and turma.codigo = " + turma.intValue();
		}
		if (turno != null && turno.intValue() != 0) {
			sqlStr += " and turma.turno = " + turno.intValue();
		}
		sqlStr += " and matriculaPeriodoVencimento.matriculaPeriodo = matriculaPeriodo.codigo ";
		if (somenteParcelaMatricula) {
			sqlStr += " and matriculaPeriodoVencimento.parcela = 'MA' ";
		}
		// se o usuario passar como parametro a situacao como TODOS nao
		// entrarï¿½
		// na condição, porem caso o usuário deseje filtrar por tipo, vira como
		// parametros os valores GP, GE ou NG.
		if (situacao != null && !situacao.equals("todos")) {
			if (situacao.equals("GP")) {
				sqlStr += " and matriculaPeriodoVencimento.situacao = '" + situacao + "' ";
			} else {
				sqlStr += " and matriculaPeriodoVencimento.situacao <> 'GP' ";
			}
		}
		if (ocorreuPrimeiraAula) {
			sqlStr += " and horarioturmadia.data <= current_date ";
		}
		sqlStr += " Order by matriculaPeriodo.matricula ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	/**
	 * Responsável por realizar uma consulta de <code>MatriculaPeriodo</code>
	 * através do valor do atributo <code>matricula</code> da classe
	 * <code>Matricula</code> Faz uso da operação
	 * <code>montarDadosConsulta</code> que realiza o trabalho de prerarar o
	 * List resultante.
	 * 
	 * @return List Contendo vï¿½rios objetos da classe
	 *         <code>MatriculaPeriodoVO</code> resultantes da consulta.
	 * @exception Execption
	 *                Caso haja problemas de conexão ou restrição de acesso.
	 */
	public MatriculaPeriodoVO consultarPorMatricula(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = ? ");
		sqlStr.append(" and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { valorConsulta });
		if (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			montarDadosCompleto(obj, tabelaResultado, configuracaoFinanceiroVO, usuario);
			return obj;
		}
		return null;
	}

	public Boolean consultarSeExisteMatriculaPeriodoVinculadaAGradeCurricular(Integer gradeCurricular, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM MatriculaPeriodo WHERE gradeCurricular = ? limit 1";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr, new Object[] { gradeCurricular });
		return tabelaResultado.next();
	}

	public MatriculaPeriodoVO consultarPorMatriculaPeriodoLetivoSemestreAno(String matricula, Integer periodoLetivo, String semestre, String ano, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '").append(matricula).append("'");
		if (Uteis.isAtributoPreenchido(periodoLetivo)) {
			sqlStr.append(" AND MatriculaPeriodo.periodoLetivoMatricula = ").append(periodoLetivo);
		}
		if (Uteis.isAtributoPreenchido(ano)) {
			sqlStr.append(" AND MatriculaPeriodo.ano = '").append(ano).append("' ");
		}
		if (Uteis.isAtributoPreenchido(semestre)) {
			sqlStr.append(" AND MatriculaPeriodo.semestre = '").append(semestre).append("'");
		}
		sqlStr.append(" and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO obj = null;
		if (tabelaResultado.next()) {
			obj = new MatriculaPeriodoVO();
			montarDadosCompleto(obj, tabelaResultado, configuracaoFinanceiroVO, usuario);
		}
		return null;
	}

	public MatriculaPeriodoVO consultarPorMatriculaPeriodoLetivoMatricula(String matricula, Integer periodoLetivo, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = ? and MatriculaPeriodo.periodoLetivoMatricula = ? ");
		sqlStr.append(" and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { matricula, periodoLetivo });
		MatriculaPeriodoVO obj = null;
		if (tabelaResultado.next()) {
			obj = new MatriculaPeriodoVO();
			montarDadosCompleto(obj, tabelaResultado, configuracaoFinanceiroVO, usuario);
		}
		return obj;
	}

	public MatriculaPeriodoVO consultarPorMatriculaSemestreAno(String matricula, String semestre, String ano, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = ? and MatriculaPeriodo.semestre = ? and MatriculaPeriodo.ano = ? ");
		sqlStr.append(" and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		if (semestre == null) {
			semestre = "";
		}
		if (ano == null) {
			ano = "";
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { matricula, semestre, ano });
		MatriculaPeriodoVO obj = null;
		if (tabelaResultado.next()) {
			obj = new MatriculaPeriodoVO();
			montarDadosCompleto(obj, tabelaResultado, configuracaoFinanceiroVO, usuario);
		}
		return obj;
	}

	public List<MatriculaPeriodoVO> consultarUltimaMatriculaPeriodoPorMatricula(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVO> matriculaPeriodoVOs = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO matriculaPeriodoVO = consultaUltimaMatriculaPeriodoPorMatricula(valorConsulta, controlarAcesso, nivelMontarDados, configuracaoFinanceiroVO, usuario);
		if (Uteis.isAtributoPreenchido(matriculaPeriodoVO)) {
			matriculaPeriodoVOs.add(matriculaPeriodoVO);
		}
		return matriculaPeriodoVOs;
	}

	public MatriculaPeriodoVO consultaUltimaMatriculaPeriodoPorMatricula(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '").append(valorConsulta).append("' and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO vetResultado = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			montarDadosCompleto(vetResultado, tabelaResultado, configuracaoFinanceiroVO, usuario);
		}
		return vetResultado;
	}

	public MatriculaPeriodoVO consultaUltimaMatriculaPeriodoPorMatriculaTrancamentoMatricula(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '").append(valorConsulta).append("' and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO vetResultado = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			montarDadosCompleto(vetResultado, tabelaResultado, configuracaoFinanceiroVO, usuario);
		}
		return vetResultado;
	}

	public MatriculaPeriodoVO consultaUltimaMatriculaPeriodoPorMatriculaConsultaBasica(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = ? and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, PeriodoLetivo.PeriodoLetivo desc, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), valorConsulta);
		MatriculaPeriodoVO vetResultado = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			montarDadosBasico(vetResultado, tabelaResultado);
		}
		return vetResultado;
	}

	public Boolean verificarMatriculaDeCalouro(String valorConsulta, Integer codigoMatriculaPeriodoAtual, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		int nrMatriculaPeriodoParametro = 0;
		if (Uteis.isAtributoPreenchido(codigoMatriculaPeriodoAtual)) {
			// Se o codigo esta preenchido é por que estou editando uma matriculaperiodo, assim, para considerarmos
			// o aluno como caloudo, temos que uma unica matriculaPeriodoGrava
			nrMatriculaPeriodoParametro = 1;
		}
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" SELECT COUNT(codigo) as nrMatriculaPeriodo FROM matriculaPeriodo ");
		sqlStr.append(" WHERE matricula = '").append(valorConsulta).append("' ");
		sqlStr.append(" and ((situacaoMatriculaPeriodo = 'PR') or (situacaoMatriculaPeriodo = 'AT') or (situacaoMatriculaPeriodo = 'FI') or (situacaoMatriculaPeriodo = 'TR'))");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			int nrMatriculasPeriodos = tabelaResultado.getInt("nrMatriculaPeriodo");
			if (nrMatriculasPeriodos > nrMatriculaPeriodoParametro) {
				return false;
			}
		}
		return true;
	}

	public Boolean verificarMatriculaDeVeterano(String valorConsulta, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" SELECT COUNT(codigo) as nrMatriculaPeriodo FROM matriculaPeriodo ");
		sqlStr.append(" WHERE matricula = '").append(valorConsulta).append("' ");
		sqlStr.append(" and ((situacaoMatriculaPeriodo = 'PR') or (situacaoMatriculaPeriodo = 'AT') or (situacaoMatriculaPeriodo = 'FI'))");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			int nrMatriculasPeriodos = tabelaResultado.getInt("nrMatriculaPeriodo");
			if (nrMatriculasPeriodos > 1) {
				return true;
			}
		}
		return false;
	}

	/**
	 * Retorna a matriculaPeriodo com periodoLetivo mais avancado da
	 * gradeCurricular Isto pode ser necessário, pois muitas vezes o aluno ï¿½
	 * matriculado em periodos posteriores e, depois, matriculado em Períodos
	 * anteriores. Desta maneira, temos que a última matricula Período, não
	 * reflete o periodoLetivo mais avancado que o aluno já estudou.
	 */
	public MatriculaPeriodoVO consultaRapidaBasicaMatriculaPeriodoMaiorPeriodoLetivoPorMatricula(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '").append(valorConsulta).append("' and situacaoMatriculaPeriodo <> 'PC' ");
		sqlStr.append(" order by  (MatriculaPeriodo.ano||'/'||MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end,  periodoletivo.periodoletivo desc, MatriculaPeriodo.codigo desc");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO vetResultado = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			montarDadosBasico(vetResultado, tabelaResultado);
		}
		return vetResultado;
	}

	public MatriculaPeriodoVO consultaRapidaBasicaUltimaMatriculaPeriodoPorMatricula(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		return consultaUltimaMatriculaPeriodoPorMatriculaConsultaBasica(valorConsulta, controlarAcesso, nivelMontarDados, null, usuario);
	}

	public MatriculaPeriodoVO consultaRapidaBasicaUltimaMatriculaPeriodoPorMatriculaOrdenandoPorAnoSemestrePeriodoLetivo(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		return consultaUltimaMatriculaPeriodoPorMatriculaConsultaBasica(valorConsulta, controlarAcesso, nivelMontarDados, null, usuario);
	}

	public MatriculaPeriodoVO consultaRapidaBasicaUltimaMatriculaPeriodoAtivaPorMatricula(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '").append(valorConsulta).append("' AND MatriculaPeriodo.situacaomatriculaperiodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano||'/'||MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, MatriculaPeriodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO vetResultado = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			montarDadosBasico(vetResultado, tabelaResultado);
		}
		return vetResultado;
	}

	public MatriculaPeriodoVO consultaRapidaBasicaPrimeiraMatriculaPeriodoPorMatricula(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '").append(valorConsulta).append("' AND MatriculaPeriodo.situacaomatriculaperiodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano||'/'||MatriculaPeriodo.semestre) asc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, PeriodoLetivo.periodoLetivo, MatriculaPeriodo.codigo ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO vetResultado = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			montarDadosBasico(vetResultado, tabelaResultado);
		}
		return vetResultado;
	}

	public MatriculaPeriodoVO consultaRapidaBasicaMatriculaPeriodoPorMatriculaAnoSemestre(String valorConsulta, String ano, String semestre, Integer turma, String nivelEducacional, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario, String situacaoMatricula) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '");
		sqlStr.append(valorConsulta.toString());
		sqlStr.append("'");
		if (ano != null && !ano.trim().isEmpty()) {
			sqlStr.append(" and MatriculaPeriodo.ano = '");
			sqlStr.append(ano.toString());
			sqlStr.append("'");
		}
		if (semestre != null && !semestre.trim().isEmpty()) {
			sqlStr.append(" and MatriculaPeriodo.semestre = '");
			sqlStr.append(semestre.toString());
			sqlStr.append("'");
		}
		if (Uteis.isAtributoPreenchido(turma)) {
			sqlStr.append(" and matriculaPeriodo.turma = ");
			sqlStr.append(turma.intValue());
		}
		if (!situacaoMatricula.equals("")) {
			if (situacaoMatricula.equals("ativo")) {
				if (!nivelEducacional.equals("PO")) {
					sqlStr.append("AND matriculaPeriodo.situacaoMatriculaPeriodo = 'AT' ");
				}
			} else if (situacaoMatricula.endsWith("inativo")) {
				if (!nivelEducacional.equals("PO")) {
					// sqlStr.append("AND matriculaPeriodo.situacaoMatriculaPeriodo <> 'AT' ");
					sqlStr.append("AND matriculaPeriodo.situacaoMatriculaPeriodo not in ('AT', 'PC') ");
				}
			}
		}
		// sqlStr.append(" AND (matricula.situacao <> 'CA')  ");
		sqlStr.append(" AND matricula.situacao not in ('CA', 'AC', 'TR', 'TS', 'TI', 'PC') ");
		sqlStr.append(" order by (MatriculaPeriodo.ano||'/'||MatriculaPeriodo.semestre) asc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, PeriodoLetivo.periodoLetivo desc, MatriculaPeriodo.codigo desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO vetResultado = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			montarDadosBasico(vetResultado, tabelaResultado);
		}
		return vetResultado;
	}

	public MatriculaPeriodoVO consultarRapidaPorMatriculaPeriodoLetivoMatricula(String matricula, Integer periodoLetivo, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = ? and PeriodoLetivo.periodoLetivo = ? and matriculaperiodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano||'/'||MatriculaPeriodo.semestre) asc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, PeriodoLetivo.periodoLetivo desc, MatriculaPeriodo.codigo desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { matricula, periodoLetivo });
		if (!tabelaResultado.next()) {
			return null;
		}
		MatriculaPeriodoVO vetResultado = new MatriculaPeriodoVO();
		montarDadosBasico(vetResultado, tabelaResultado);
		return vetResultado;
	}

	public MatriculaPeriodoVO consultarUltimaMatriculaPeriodoAtivaPorMatricula(String matricula, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		MatriculaPeriodoVO obj = consultaRapidaBasicaUltimaMatriculaPeriodoAtivaPorMatricula(matricula, controlarAcesso, nivelMontarDados, usuario);
		if (!Uteis.isAtributoPreenchido(obj)) {
			throw new ConsistirException("Não existe nenhuma matrícula periodo ativa para a matricula: " + matricula + ".");
		}
		return obj;
	}

	public MatriculaPeriodoVO consultarUltimaMatriculaPeriodoPorMatriculaAnoSemestre(String matricula, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		MatriculaPeriodoVO matriculaPeriodoVO = consultaUltimaMatriculaPeriodoPorMatricula(matricula, controlarAcesso, nivelMontarDados, configuracaoFinanceiroVO, usuario);
		if (!Uteis.isAtributoPreenchido(matriculaPeriodoVO)) {
			throw new ConsistirException("Não existe nenhuma matrícula periodo para a matricula: " + matricula + ".");
		}
		return matriculaPeriodoVO;
	}

	public List<MatriculaPeriodoVO> consultarMatriculaPeriodoPorMatriculaSituacoes(String matricula, String situacoes, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '" + matricula + "' and matriculaperiodo.situacaomatriculaperiodo in (" + situacoes + ") ORDER BY (MatriculaPeriodo.ano||'/'||matriculaperiodo.semestre) desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			montarDadosCompleto(obj, tabelaResultado, configuracaoFinanceiroVO, usuario);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public MatriculaPeriodoVO consultarUltimaMatriculaPeriodoAtivaPorMatriculaSemExcecao(String matricula, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		return consultaRapidaBasicaUltimaMatriculaPeriodoAtivaPorMatricula(matricula, controlarAcesso, nivelMontarDados, usuario);
	}

	public MatriculaPeriodoVO consultarUltimaMatriculaPeriodoAtivaOuTrancadaPorMatriculaSemExcecao(String matricula, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT MatriculaPeriodo.* FROM  MatriculaPeriodo WHERE MatriculaPeriodo.matricula = '" + matricula + "' and (matriculaperiodo.situacaomatriculaperiodo = 'AT' or matriculaperiodo.situacaomatriculaperiodo = 'TR') ORDER BY (MatriculaPeriodo.ano||'/'||matriculaperiodo.semestre) desc limit 1";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (!tabelaResultado.next()) {
			return new MatriculaPeriodoVO();
		}
		return montarDados(tabelaResultado, new MatriculaPeriodoVO(), nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	@Override
	public MatriculaPeriodoVO consultarUltimaMatriculaPeriodoPorMatriculaSituacoes(String matricula, String situacoes, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '" + matricula + "' and matriculaperiodo.situacaomatriculaperiodo in (" + situacoes + ") ORDER BY (MatriculaPeriodo.ano||'/'||matriculaperiodo.semestre) desc limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			montarDadosCompleto(obj, tabelaResultado, configuracaoFinanceiroVO, usuario);
		}
		return obj;
	}

	public List consultaMatriculaPeriodoUnidadeEnsinoCurso(Integer unidadeEnsinoCurso, String semestre, String ano, String situacaoMatriculaPeriodo, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM MatriculaPeriodo WHERE unidadeEnsinoCurso = " + unidadeEnsinoCurso.intValue() + " and semestre = '" + semestre + "' and ano = '" + ano + "' and situacaoMatriculaPeriodo = '" + situacaoMatriculaPeriodo + "' order by codigo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public List consultarMatriculaSuspensaParaSerListadaParaCancelamento(List<UnidadeEnsinoVO> listaUnidadeEnsino, String matricula, Integer curso, Integer turma, Integer nrdiaslistarmatriculapendenciadocumentosparacancelamento, int nivelMontarDados, UsuarioVO usuario, String tipoSuspensaoMatricula, String situacaoSolicitacao, Boolean permitirVisualizarSolicitacaoSuspensaoMatriculaPendenciaFinanceira, Boolean permitirLiberarSolicitacaoSuspensaoMatriculaPendenciaFinanceira, Boolean permitirVisualizarSolicitacaoSuspensaoMatriculaPendenciaAcademica, Boolean permitirLiberarSolicitacaoSuspensaoMatriculaPendenciaAcademica, Boolean permitirUsuarioVisualizarApenasSuasSolicitacoes, Boolean permitirVisualizarPendenciasDeferidasIndeferidasOutrosUsuariosMesmaUnidade) throws Exception {
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" where 1 = 1 ");

		/*if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append(" and matricula.unidadeEnsino = ").append(unidadeEnsino);
				
		}*/
		sqlStr.append(" and ").append(realizarGeracaoWhereUnidadeEnsinoSelecionada(listaUnidadeEnsino, "matricula.unidadeEnsino"));	
		
		sqlStr.append(" and matriculaperiodo.codigo = (select mp.codigo from matriculaperiodo mp where mp.matricula = matricula.matricula order by (mp.ano||'/'||mp.semestre) desc, case when mp.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, mp.codigo desc limit 1 ) ");
		if (nrdiaslistarmatriculapendenciadocumentosparacancelamento != null && nrdiaslistarmatriculapendenciadocumentosparacancelamento != 0) {
			sqlStr.append(" and matricula.matricula in ( ");
			sqlStr.append(" SELECT matricula  from ( ");
			sqlStr.append(" SELECT matricula, ('").append(Uteis.getDataJDBC(new Date())).append("' - (case when databasesuspensao is null then matricula.data else databasesuspensao end ) ) as diasPassados from matricula where matriculasuspensa  = true and matricula.situacao = 'AT' ");
			/*if (unidadeEnsino != null && unidadeEnsino != 0) {
				sqlStr.append(" and matricula.unidadeEnsino = ").append(unidadeEnsino);
			}*/
			sqlStr.append(" and ").append(realizarGeracaoWhereUnidadeEnsinoSelecionada(listaUnidadeEnsino, "matricula.unidadeEnsino"));	
			if (matricula != null && !matricula.equals("")) {
				sqlStr.append(" and matricula.matricula = '").append(matricula).append("' ");
			}
			if (curso != null && curso != 0) {
				sqlStr.append(" and matricula.curso = ").append(curso);
			}
			if (turma != null && turma != 0) {
				sqlStr.append(" and matriculaperiodo.turma = ").append(turma);
			}
			sqlStr.append("  ) as tabela where tabela.diasPassados  >  '").append(nrdiaslistarmatriculapendenciadocumentosparacancelamento).append(" days'::INTERVAL ");
			sqlStr.append(" ) ");
		}
		if (matricula != null && !matricula.equals("")) {
			sqlStr.append(" and matricula.matricula = '").append(matricula).append("' ");
		}
		if (curso != null && curso != 0) {
			sqlStr.append(" and matricula.curso = ").append(curso);
		}
		if (turma != null && turma != 0) {
			sqlStr.append(" and matriculaperiodo.turma = ").append(turma);
		}
		if(tipoSuspensaoMatricula != null && !tipoSuspensaoMatricula.equals("")) {
			if(tipoSuspensaoMatricula.equals("pendenciaSolicitacao")) {
				
				sqlStr.append(" and matriculaperiodo.codigo = (select distinct mp.codigo ");
				sqlStr.append(" from matriculaperiodo as mp ");
				sqlStr.append(" inner join pendenciaLiberacaoMatricula on pendenciaLiberacaoMatricula.matricula=mp.matricula ");
				sqlStr.append(" where mp.matricula = matriculaperiodo.matricula ");
				
				if(!permitirUsuarioVisualizarApenasSuasSolicitacoes) {
					if((permitirVisualizarSolicitacaoSuspensaoMatriculaPendenciaFinanceira || permitirLiberarSolicitacaoSuspensaoMatriculaPendenciaFinanceira) && (permitirVisualizarSolicitacaoSuspensaoMatriculaPendenciaAcademica || permitirLiberarSolicitacaoSuspensaoMatriculaPendenciaAcademica)) {
	
						sqlStr.append(" and (motivosolicitacao = 'SOLICITAR_APROVACAO_LIBERACAO_FINANCEIRA' or motivosolicitacao = 'SOLICITAR_LIBERACAO_MATRICULA_APOS_X_MODULOS') ");
					}
					else if(permitirVisualizarSolicitacaoSuspensaoMatriculaPendenciaFinanceira || permitirLiberarSolicitacaoSuspensaoMatriculaPendenciaFinanceira) {
						sqlStr.append(" and motivosolicitacao = 'SOLICITAR_APROVACAO_LIBERACAO_FINANCEIRA' ");
					}
					else if(permitirVisualizarSolicitacaoSuspensaoMatriculaPendenciaAcademica || permitirLiberarSolicitacaoSuspensaoMatriculaPendenciaAcademica) {
		
						sqlStr.append(" and motivosolicitacao = 'SOLICITAR_LIBERACAO_MATRICULA_APOS_X_MODULOS' ");
					}
				}
				if(situacaoSolicitacao != null && !situacaoSolicitacao.equals("")) {
					if(situacaoSolicitacao.equals("deferido")) {						
						sqlStr.append(" and matricula.matriculasuspensa = false ");
						sqlStr.append(" and matricula.situacao = 'AT'");
						sqlStr.append(" and bloqueioPorSolicitacaoLiberacaoMatricula is false ");
						sqlStr.append(" and pendenciaLiberacaoMatricula.situacao = '").append(SituacaoPendenciaLiberacaoMatriculaEnum.DEFERIDO).append("'");
						if(!permitirVisualizarPendenciasDeferidasIndeferidasOutrosUsuariosMesmaUnidade && !permitirUsuarioVisualizarApenasSuasSolicitacoes) {
							sqlStr.append(" and pendenciaLiberacaoMatricula.usuariodeferimento = ").append(usuario.getCodigo());
						}
						if(permitirUsuarioVisualizarApenasSuasSolicitacoes) {
							sqlStr.append(" and pendenciaLiberacaoMatricula.usuariosolicitacao = ").append(usuario.getCodigo());
						}			
						
					}
					else if(situacaoSolicitacao.equals("indeferido")){
						sqlStr.append(" and matricula.matriculasuspensa = true ");
						sqlStr.append(" and bloqueioPorSolicitacaoLiberacaoMatricula is true ");
						sqlStr.append(" and pendenciaLiberacaoMatricula.situacao = '").append(SituacaoPendenciaLiberacaoMatriculaEnum.INDEFERIDO).append("'");
						if(!permitirVisualizarPendenciasDeferidasIndeferidasOutrosUsuariosMesmaUnidade && !permitirUsuarioVisualizarApenasSuasSolicitacoes) {
							sqlStr.append(" and pendenciaLiberacaoMatricula.usuarioindeferimento = ").append(usuario.getCodigo());
						}
						if(permitirUsuarioVisualizarApenasSuasSolicitacoes) {
							sqlStr.append(" and pendenciaLiberacaoMatricula.usuariosolicitacao = ").append(usuario.getCodigo());
						}	
					}
					else {
						sqlStr.append(" and matricula.situacao = 'AT'");
						sqlStr.append(" and bloqueioPorSolicitacaoLiberacaoMatricula is true ");
						sqlStr.append(" and pendenciaLiberacaoMatricula.situacao = '").append(SituacaoPendenciaLiberacaoMatriculaEnum.PENDENTE).append("'");
						sqlStr.append(" and pendenciaLiberacaoMatricula.usuariodeferimento is null and pendenciaLiberacaoMatricula.usuarioindeferimento is null");
						if(permitirUsuarioVisualizarApenasSuasSolicitacoes) {
							sqlStr.append(" and pendenciaLiberacaoMatricula.usuariosolicitacao = ").append(usuario.getCodigo());
						}	
					}					
				}
				sqlStr.append(")");
			}
			else {
				sqlStr.append(" and matricula.matriculasuspensa = true ");
				sqlStr.append(" and matricula.situacao = 'AT'");
				sqlStr.append(" and bloqueioPorSolicitacaoLiberacaoMatricula is false");
			}
		}
		sqlStr.append("  order by matricula.data desc ");
//		System.out.println(sqlStr.toString());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	public List consultarMatriculaSerasa(Integer unidadeEnsino, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" where matricula.matriculaserasa = true");
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append(" and matricula.unidadeEnsino = ").append(unidadeEnsino);
		}
		sqlStr.append("  order by matricula.data desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	public List consultarMatriculaSerasaPagaramParcela(Integer unidadeEnsino, int nivelMontarDados, UsuarioVO usuario) throws Exception {

		StringBuffer sqlStr = new StringBuffer();
		sqlStr.append("SELECT distinct MatriculaPeriodo.situacao, MatriculaPeriodo.matricula, ");
		sqlStr.append("       Matricula.matricula as \"Matricula.matricula\", Matricula.data as \"Matricula.data\",");
		sqlStr.append("       Matricula.situacao as \"Matricula.situacao\", Matricula.situacaoFinanceira as \"Matricula.situacaoFinanceira\", Matricula.alunoConcluiuDisciplinasRegulares as \"Matricula.alunoConcluiuDisciplinasRegulares\",");
		sqlStr.append("       Pessoa.nome as \"Pessoa.nome\", Pessoa.cpf as \"Pessoa.cpf\", ");
		sqlStr.append("       Curso.nome as \"Curso.nome\", Curso.codigo as \"Curso.codigo\", Curso.nivelEducacional as \"Curso.nivelEducacional\", ");
		sqlStr.append("       UnidadeEnsino.codigo as \"UnidadeEnsino.codigo\", UnidadeEnsino.nome as \"UnidadeEnsino.nome\", ");
		sqlStr.append("       Turma.codigo as \"Turma.codigo\", Turma.identificadorTurma as \"Turma.identificadorTurma\" ");
		sqlStr.append(" from contarecebernegociacaorecebimento   ");
		sqlStr.append("      inner join contareceber on contareceber.codigo = contarecebernegociacaorecebimento.contareceber ");
		sqlStr.append("      inner join negociacaorecebimento on negociacaorecebimento.codigo = contarecebernegociacaorecebimento.negociacaorecebimento ");
		sqlStr.append("      inner join matricula on contareceber.matriculaaluno = matricula.matricula ");
		sqlStr.append("      inner join matriculaperiodo on matriculaperiodo.matricula = matricula.matricula ");
		sqlStr.append("      INNER JOIN Pessoa ON (Matricula.aluno = pessoa.codigo) ");
		sqlStr.append("      INNER JOIN UnidadeEnsino ON (Matricula.unidadeEnsino = unidadeEnsino.codigo) ");
		sqlStr.append("      INNER JOIN Curso ON (Matricula.curso = curso.codigo) ");
		sqlStr.append("      INNER JOIN PeriodoLetivo ON (MatriculaPeriodo.periodoLetivoMatricula = PeriodoLetivo.codigo) ");
		sqlStr.append("      INNER JOIN turma ON matriculaperiodo.turma = turma.codigo  ");
		sqlStr.append(" where matricula.matriculaserasa = true and (negociacaorecebimento.data between matricula.dataAlteracaoMatriculaSerasa and '" + Uteis.getDataJDBCTimestamp(Uteis.getDateTime(new Date(), 00, 00, 00)) + "') ");
		// sqlStr.append(" and (matricula.matriculaVerificadaSerasa = false or matricula.matriculaVerificadaSerasa is null ) ");
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append(" and matricula.unidadeEnsino = ").append(unidadeEnsino);
		}
		sqlStr.append("  order by matricula.data desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			montarDadosMinimos2(obj, tabelaResultado);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List consultaRapidaPorUnidadeEnsinoCursoAnoSemestreSituacao(Integer unidadeEnsinoCurso, String semestre, String ano, Integer turma, String situacao, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE matriculaPeriodo.unidadeEnsinoCurso = ").append(unidadeEnsinoCurso).append(" AND matriculaPeriodo.semestre = '").append(semestre).append("' AND matriculaPeriodo.ano = '").append(ano).append("' AND matriculaPeriodo.situacaoMatriculaPeriodo = '").append(situacao).append("' ");
		if (turma != 0) {
			sqlStr.append("AND matriculaPeriodo.turma = ").append(turma).append(" ");
		}
		sqlStr.append(" ORDER BY codigo");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	public List<MatriculaPeriodoVO> consultaRapidaPorUnidadeEnsinoCursoTurmaPeriodoLetivoAtivoSituacao(Integer curso, Integer turno,  List<UnidadeEnsinoVO> unidadeEnsinoVOs, Integer periodoLetivoAtivoUnidadeEnsinoCurso, Integer turma, String situacao, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" INNER JOIN processoMatriculaCalendario pmc ON  pmc.processoMatricula = MatriculaPeriodo.processoMatricula and pmc.curso = uec.curso and pmc.turno = uec.turno ");
		sqlStr.append(" WHERE ");
		if(Uteis.isAtributoPreenchido(curso)){			
			sqlStr.append("uec.curso = ").append(curso);
		}
		if(Uteis.isAtributoPreenchido(turno)){			
		sqlStr.append(" and uec.turno = ").append(turno).append(" and ");
		}
		if(Uteis.isAtributoPreenchido(unidadeEnsinoVOs) && unidadeEnsinoVOs.stream().anyMatch(u -> u.getFiltrarUnidadeEnsino())) {
			sqlStr.append(realizarGeracaoWhereUnidadeEnsinoSelecionada(unidadeEnsinoVOs, "uec.unidadeEnsino"));
		}
		sqlStr.append(" AND matriculaPeriodo.situacaoMatriculaPeriodo = '").append(situacao).append("' ");
		if (turma != 0) {
			sqlStr.append(" AND matriculaPeriodo.turma = ").append(turma).append(" ");
		}
		if (periodoLetivoAtivoUnidadeEnsinoCurso != 0) {
			sqlStr.append(" AND pmc.periodoLetivoAtivoUnidadeEnsinoCurso = ").append(periodoLetivoAtivoUnidadeEnsinoCurso);
		}
		sqlStr.append(" ORDER BY codigo");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	/**
	 * Responsável por realizar uma consulta de <code>MatriculaPeriodo</code>
	 * através do valor do atributo <code>Date data</code>. Retorna os objetos
	 * com valores pertecentes ao Período informado por parâmetro. Faz uso da
	 * operação <code>montarDadosConsulta</code> que realiza o trabalho de
	 * prerarar o List resultante.
	 * 
	 * @param controlarAcesso
	 *            Indica se a aplicação deverï¿½ verificar se o usuário possui
	 *            permissão para esta consulta ou não.
	 * @return List Contendo vï¿½rios objetos da classe
	 *         <code>MatriculaPeriodoVO</code> resultantes da consulta.
	 * @exception Exception
	 *                Caso haja problemas de conexão ou restrição de acesso.
	 */
	public List consultarPorData(Date prmIni, Date prmFim, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM MatriculaPeriodo WHERE ((data >= '" + Uteis.getDataJDBC(prmIni) + "') and (data <= '" + Uteis.getDataJDBC(prmFim) + "')) ORDER BY data";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	/**
	 * Responsável por realizar uma consulta de <code>MatriculaPeriodo</code>
	 * através do valor do atributo <code>Integer codigo</code>. Retorna os
	 * objetos com valores iguais ou superiores ao parâmetro fornecido. Faz uso
	 * da operação <code>montarDadosConsulta</code> que realiza o trabalho de
	 * prerarar o List resultante.
	 * 
	 * @param controlarAcesso
	 *            Indica se a aplicação deverï¿½ verificar se o usuário possui
	 *            permissão para esta consulta ou não.
	 * @return List Contendo vï¿½rios objetos da classe
	 *         <code>MatriculaPeriodoVO</code> resultantes da consulta.
	 * @exception Exception
	 *                Caso haja problemas de conexão ou restrição de acesso.
	 */
	public List consultarPorCodigo(Integer valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM MatriculaPeriodo WHERE codigo >= " + valorConsulta.intValue() + " ORDER BY codigo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public String consultarSituacaoAcademicaMatriculaPeriodo(Integer codigo) throws Exception {
		String sqlStr = "SELECT situacaoMatriculaPeriodo FROM MatriculaPeriodo WHERE codigo = " + codigo.intValue();
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return tabelaResultado.getString("situacaoMatriculaPeriodo");
		}
		return "";
	}

	public String consultarSituacaoFinanceiraMatriculaPeriodo(Integer codigo) throws Exception {
		String sqlStr = "SELECT situacao FROM MatriculaPeriodo WHERE codigo = " + codigo.intValue();
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return tabelaResultado.getString("situacao");
		}
		return "";
	}

	public MatriculaPeriodoVO consultarPorCodigoSemestreAno(Integer valorConsulta, String ano, String semestre, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM MatriculaPeriodo WHERE codigo = " + valorConsulta.intValue() + " and semestre = " + semestre + " and ano = " + ano + " ORDER BY codigo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (!tabelaResultado.next()) {
			return null;
		}
		MatriculaPeriodoVO obj = null;
		return (montarDados(tabelaResultado, obj, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public MatriculaPeriodoVO consultarPorCodigoTranferenciaEntrada(Integer valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT * FROM MatriculaPeriodo WHERE tranferenciaEntrada = " + valorConsulta.intValue() + " ORDER BY codigo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (!tabelaResultado.next()) {
			return null;
		}
		MatriculaPeriodoVO obj = null;
		return (montarDados(tabelaResultado, obj, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	// public List consultarPorCodigoProcessoMatricula(Integer
	// processoMatricula, boolean controlarAcesso, int nivelMontarDados) throws
	// Exception {
	// String sqlStr =
	// "SELECT * FROM MatriculaPeriodo WHERE processoMatricula = " +
	// processoMatricula.intValue() + " ORDER BY codigo";
	// SqlRowSet tabelaResultado =
	// getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
	// List<MatriculaPeriodoVO> vetResultado = new
	// ArrayList<MatriculaPeriodoVO>(0);
	// while (tabelaResultado.next()) {
	// vetResultado.add(new MatriculaPeriodoVO());
	// }
	// return vetResultado;
	// }

	public Boolean consultarPorCodigoProcessoMatriculaUnidadeEnsinoCurso(Integer processoMatricula, Integer curso, Integer turno) throws Exception {
		String sqlStr = "SELECT MatriculaPeriodo.codigo FROM MatriculaPeriodo inner join unidadeEnsinoCurso on unidadeEnsinoCurso.codigo = MatriculaPeriodo.unidadeEnsinoCurso  WHERE MatriculaPeriodo.processoMatricula = " + processoMatricula + " and unidadeEnsinoCurso.curso = " + curso + " and unidadeEnsinoCurso.turno = "+turno+" limit 1";
		return getConexao().getJdbcTemplate().queryForRowSet(sqlStr).next();
	}

	public Boolean verificaPossuiMatriculaPreMatricula(String matricula) throws Exception {
		String sqlStr = "SELECT codigo FROM MatriculaPeriodo WHERE situacaomatriculaperiodo = 'PR' and matricula = '" + matricula + "' ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		while (tabelaResultado.next()) {
			return true;
		}
		return false;
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.SUPPORTS)
	public Integer consultarQuantidadeAlunoMatriculadoTurmaPorSituacao(Integer codigoTurma, Integer unidadeEnsino ,boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder(" Select count (distinct(matriculaperiodo.matricula)) as qtd from matriculaperiodo ");
		sqlStr.append(" inner join matricula ON (matriculaperiodo.matricula = matricula.matricula) ");
		sqlStr.append(" where matriculaperiodo.turma =").append(codigoTurma);
		sqlStr.append(" and matricula.unidadeEnsino=").append(unidadeEnsino);
		sqlStr.append(" and matriculaperiodo.situacaomatriculaperiodo <> 'PC'  ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("qtd");
		}
		return 0;
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.SUPPORTS)
	public Integer consultarQuantidadeAlunoEmReposicaoPorTurma(Integer codigoTurma, boolean isAlunoQueEstaoFazendoReposicaoNessaTurma, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder(" ");
		sqlStr.append(" Select count (distinct(matriculaperiodo.matricula)) as qtd from matriculaperiodo");
		sqlStr.append(" inner join matricula ON (matriculaperiodo.matricula = matricula.matricula) ");
		sqlStr.append(" inner join matriculaperiodoturmadisciplina on matriculaperiodoturmadisciplina.matriculaperiodo = matriculaperiodo.codigo ");
		sqlStr.append( "where  matriculaperiodo.turma != matriculaperiodoturmadisciplina.turma ");
		if(isAlunoQueEstaoFazendoReposicaoNessaTurma){
			sqlStr.append(" and matriculaperiodoturmadisciplina.turma = ").append(codigoTurma).append(" ");	
		}else{
			sqlStr.append(" and matriculaperiodo.turma = ").append(codigoTurma).append(" ");
		}
		sqlStr.append(" and matriculaperiodo.situacaomatriculaperiodo <> 'PC'  ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("qtd");
		}
		return 0;
	}
	
	public Integer consultarQuantidadeAlunoMatriculadoTurma(Integer codigoTurma, Integer processoMatricula, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "Select count (matricula) as qtd from matriculaperiodo where matriculaperiodo.situacaomatriculaperiodo in ('AT', 'PR') and matriculaperiodo.turma=" + codigoTurma;
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("qtd");
		}
		return 0;
	}

	public Integer consultarQuantidadeAlunoMatriculadoPeriodoAtivo(String nivelEducacional, Integer unidadeEnsino, Integer curso, Integer disciplina, Integer turma, UsuarioVO usuario) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("SELECT COUNT(matriculaPeriodo.codigo) AS qtde FROM matriculaPeriodo ");
		sb.append(" INNER JOIN matricula ON matricula.matricula = matriculaPeriodo.matricula ");
		sb.append(" INNER JOIN curso ON curso.codigo = matricula.curso ");
		sb.append(" INNER JOIN matriculaPeriodoTurmaDisciplina mptd ON mptd.matriculaPeriodo = matriculaPeriodo.codigo ");
		sb.append(" WHERE (matriculaPeriodo.situacaoMatriculaPeriodo = 'AT' OR matriculaPeriodo.situacaoMatriculaPeriodo = 'CO') ");
		sb.append(" AND curso.nivelEducacional = '");
		sb.append(nivelEducacional.toUpperCase());
		sb.append("' AND matricula.unidadeEnsino = ");
		sb.append(unidadeEnsino.intValue());
		sb.append(" AND matricula.curso = ");
		sb.append(curso.intValue());
		sb.append(" AND matriculaPeriodo.turma = ");
		sb.append(turma.intValue());
		sb.append(" AND mptd.disciplina = ");
		sb.append(disciplina.intValue());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt(1);
		}
		return 0;
	}

	public Integer consultarQuantidadeAlunoPreMatriculadoPeriodoAtivo(String nivelEducacional, Integer unidadeEnsino, Integer curso, Integer disciplina, Integer turma, UsuarioVO usuario) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("SELECT COUNT(matriculaPeriodo.codigo) AS qtde FROM matriculaPeriodo ");
		sb.append(" INNER JOIN matricula ON matricula.matricula = matriculaPeriodo.matricula ");
		sb.append(" INNER JOIN curso ON curso.codigo = matricula.curso ");
		sb.append(" INNER JOIN matriculaPeriodoTurmaDisciplina mptd ON mptd.matriculaPeriodo = matriculaPeriodo.codigo ");
		sb.append(" WHERE (matriculaPeriodo.situacaoMatriculaPeriodo = 'PR') ");
		sb.append(" AND curso.nivelEducacional = '");
		sb.append(nivelEducacional.toUpperCase());
		sb.append("' AND matricula.unidadeEnsino = ");
		sb.append(unidadeEnsino.intValue());
		sb.append(" AND matricula.curso = ");
		sb.append(curso.intValue());
		sb.append(" AND matriculaPeriodo.turma = ");
		sb.append(turma.intValue());
		sb.append(" AND mptd.disciplina = ");
		sb.append(disciplina.intValue());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt(1);
		}
		return 0;
	}

	public Integer consultarQuantidadeParcelaContratoMatriculaNaoControlada(Integer matriculaperiodo, String matricula, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select count(matriculaperiodovencimento.codigo) from matriculaperiodovencimento ");
		sqlStr.append(" inner join matriculaperiodo on matriculaperiodo.codigo = matriculaperiodovencimento.matriculaperiodo ");
		sqlStr.append(" where matriculaperiodo.matricula = '");
		sqlStr.append(matricula);
		sqlStr.append("' and matriculaperiodo.codigo = ");
		sqlStr.append(matriculaperiodo);
		sqlStr.append(" and parcela != 'MA'");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt(1);
		}
		return 0;
	}

	/**
	 * Responsável por montar os dados de vï¿½rios objetos, resultantes de uma
	 * consulta ao banco de dados (<code>ResultSet</code>). Faz uso da operação
	 * <code>montarDados</code> que realiza o trabalho para um objeto por vez.
	 * 
	 * @return List Contendo vï¿½rios objetos da classe
	 *         <code>MatriculaPeriodoVO</code> resultantes da consulta.
	 */
	public List<MatriculaPeriodoVO> montarDadosConsulta(SqlRowSet tabelaResultado, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO obj = null;
		while (tabelaResultado.next()) {
			vetResultado.add(montarDados(tabelaResultado, obj, nivelMontarDados, configuracaoFinanceiroVO, usuario));
		}
		return vetResultado;
	}

	/**
	 * Responsável por montar os dados resultantes de uma consulta ao banco de
	 * dados (<code>ResultSet</code>) em um objeto da classe
	 * <code>MatriculaPeriodoVO</code>.
	 * 
	 * @return O objeto da classe <code>MatriculaPeriodoVO</code> com os dados
	 *         devidamente montados.
	 * @deprecated na versao 5.0 utilizar o carregarDados
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.SUPPORTS)
	public MatriculaPeriodoVO montarDados(SqlRowSet dadosSQL, MatriculaPeriodoVO obj, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		// //System.out.println(">> Montar dados(MatriculaPeriodo) - " + new
		// Date());
		obj = new MatriculaPeriodoVO();
		obj.setCodigo(dadosSQL.getInt("codigo"));
		obj.setProcessoMatricula((dadosSQL.getInt("processoMatricula")));
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_COMBOBOX) {
			return obj;
		}
		obj.setData(dadosSQL.getDate("data"));
		obj.setDataVencimentoMatriculaEspecifico(dadosSQL.getDate("dataVencimentoMatriculaEspecifico"));
		obj.setDataBaseGeracaoParcelas(dadosSQL.getDate("databasegeracaoparcelas"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setSituacaoMatriculaPeriodo(dadosSQL.getString("situacaoMatriculaPeriodo"));
		obj.setSemestre(dadosSQL.getString("semestre"));
		obj.setAno(dadosSQL.getString("ano"));
		obj.setMatricula(dadosSQL.getString("matricula"));
		obj.getGradeCurricular().setCodigo(dadosSQL.getInt("gradeCurricular"));
		obj.getPeridoLetivo().setCodigo(dadosSQL.getInt("periodoLetivoMatricula"));
		obj.getResponsavelRenovacaoMatricula().setCodigo((dadosSQL.getInt("responsavelRenovacaoMatricula")));
		obj.getResponsavelMatriculaForaPrazo().setCodigo((dadosSQL.getInt("responsavelMatriculaForaPrazo")));
		obj.getTurma().setCodigo((dadosSQL.getInt("turma")));
		obj.getTurmaPeriodo().setCodigo((dadosSQL.getInt("turmaPeriodo")));
		obj.setDataLiberacaoMatricula(dadosSQL.getDate("dataLiberacaoMatricula"));
		obj.setDataEmissaoBoletoMatricula(dadosSQL.getDate("dataEmissaoBoletoMatricula"));
		obj.getResponsavelLiberacaoMatricula().setCodigo((dadosSQL.getInt("responsavelLiberacaoMatricula")));
		obj.getResponsavelEmissaoBoletoMatricula().setCodigo((dadosSQL.getInt("responsavelEmissaoBoletoMatricula")));
		// obj.setContaReceber((dadosSQL.getInt("contaReceber")));
		obj.setUnidadeEnsinoCurso((dadosSQL.getInt("unidadeEnsinoCurso")));
		obj.getContratoMatricula().setCodigo((dadosSQL.getInt("contratoMatricula")));
		obj.getContratoFiador().setCodigo((dadosSQL.getInt("contratoFiador")));

		obj.getContratoExtensao().setCodigo((dadosSQL.getInt("contratoExtensao")));

		obj.setNrDocumento(dadosSQL.getString("nrDocumento"));
		obj.setProcessoMatricula((dadosSQL.getInt("processoMatricula")));
		obj.getPlanoFinanceiroCurso().setCodigo((dadosSQL.getInt("planoFinanceiroCurso")));
		obj.getCondicaoPagamentoPlanoFinanceiroCurso().setCodigo((dadosSQL.getInt("condicaoPagamentoPlanoFinanceiroCurso")));
		obj.getMatriculaPeriodoPreMatricula().setCodigo((dadosSQL.getInt("matriculaPeriodoPreMatricula")));
		obj.setFinanceiroManual(dadosSQL.getBoolean("financeiroManual"));
		obj.setNrDisciplinasIncluidas(dadosSQL.getInt("nrDisciplinasIncluidas"));
		obj.setNrDisciplinasExcluidas(dadosSQL.getInt("nrDisciplinasExcluidas"));
		obj.setReconheceuDivida(dadosSQL.getBoolean("reconheceuDivida"));
		obj.setCarneEntregue(dadosSQL.getBoolean("carneEntregue"));
		obj.setAlunoTransferidoUnidade(dadosSQL.getBoolean("alunoTransferidoUnidade"));

		obj.setBolsista(dadosSQL.getBoolean("bolsista"));

		obj.setNovoObj(Boolean.FALSE);
		obj.getMatriculaVO().setMatricula(obj.getMatricula());
		getFacadeFactory().getMatriculaFacade().carregarDados(obj.getMatriculaVO(), usuario);
		// montarDadosMatricula(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS);
		montarDadosPeriodoLetivoMatricula(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_DADOSMINIMOS) {
			montarDadosTurma(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
			return obj;
		}
		montarDadosGradeCurricular(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario); // lento...
		montarDadosContratoMatricula(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarDadosContratoFiador(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);

		montarDadosContratoExtensao(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);

		montarDadosPlanoFinanceiroCurso(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		montarCondicaoPagamentoPlanoFinanceiroCurso(obj, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);

		// montarDadosProcessoMatriculaCalendarioVO(obj, nivelMontarDados,
		// usuario);
		montarDadosProcessoMatriculaCalendarioVO(obj.getMatriculaVO(), obj, NivelMontarDados.NAO_INICIALIZADO, usuario);
		if (nivelMontarDados == Uteis.NIVELMONTARDADOS_DADOSBASICOS) {
			return obj;
		}

		montarDadosMatriculaPeriodoTurmaDisciplinaDeAcordoSituacaoAcademica(obj);
//		obj.setMatriculaPeriodoVencimentoVOs(MatriculaPeriodoVencimento.consultarMatriculaPeriodoVencimentoVOs(obj, false, Uteis.NIVELMONTARDADOS_DADOSCONSULTARTODOS, configuracaoFinanceiroVO, usuario));
		montarDadosResponsavelLiberacaoMatricula(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS);
		montarDadosResponsavelEmissaoBoletoMatricula(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
		montarDadosResponsavelRenovacaoMatricula(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
		montarDadosTurma(obj, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
		return obj;
	}

	public static void montarDadosMatricula(MatriculaPeriodoVO obj, Integer nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (!obj.getMatricula().equals("")) {
			obj.setMatriculaVO(getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(obj.getMatricula(), 0, NivelMontarDados.getEnum(nivelMontarDados), usuario));
		}
	}

//	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
//	public void transferirDisciplinasPreMatriculaParaMatriculaAtiva(MatriculaPeriodoVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
//		List turmaDisciplinaVOsTransferir = PreMatriculaPeriodoTurmaDisciplina.consultarPreMatriculaPeriodoTurmaDisciplinas(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
//
//		if (!turmaDisciplinaVOsTransferir.isEmpty()) {
//			getFacadeFactory().getPreMatriculaPeriodoTurmaDisciplinaFacade().excluirPreMatriculaPeriodoTurmaDisciplinas(obj.getCodigo(), turmaDisciplinaVOsTransferir);
//			obj.setMatriculaPeriodoTumaDisciplinaVOs(turmaDisciplinaVOsTransferir);
//			Iterator i = obj.getMatriculaPeriodoTumaDisciplinaVOs().iterator();
//			while (i.hasNext()) {
//				MatriculaPeriodoTurmaDisciplinaVO matTurmaDisc = (MatriculaPeriodoTurmaDisciplinaVO) i.next();
//				matTurmaDisc.setCodigo(0);
//				matTurmaDisc.setNovoObj(Boolean.TRUE);
//				matTurmaDisc.setSemestre(obj.getSemestre());
//				matTurmaDisc.setAno(obj.getAno());
//			}
//			getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().alterarMatriculaPeriodos(obj.getCodigo(), obj.getMatricula(), obj.getMatriculaPeriodoTumaDisciplinaVOs(), configuracaoFinanceiroVO, usuario);
//		}
//	}

	public static void montarDadosMatriculaPeriodoTurmaDisciplinaDeAcordoSituacaoAcademica(MatriculaPeriodoVO obj) throws Exception {
		obj.setMatriculaPeriodoTumaDisciplinaVOs(getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarMatriculaPeriodoTurmaDisciplinas(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSENTIDADESUBORDINADAS, null));
		if ((obj.isSituacaoPreMatricula()) && (obj.getMatriculaPeriodoTumaDisciplinaVOs().isEmpty())) {
			obj.setMatriculaPeriodoTumaDisciplinaVOs(PreMatriculaPeriodoTurmaDisciplina.consultarPreMatriculaPeriodoTurmaDisciplinas(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSENTIDADESUBORDINADAS, null));
		}
		for(MatriculaPeriodoTurmaDisciplinaVO mptd : obj.getMatriculaPeriodoTumaDisciplinaVOs()) {
			mptd.setMatriculaObjetoVO(obj.getMatriculaVO());
			mptd.setMatriculaPeriodoObjetoVO(obj);
	}
	}

	public static void montarDadosResponsavelLiberacaoMatricula(MatriculaPeriodoVO obj, int nivelMontarDados) throws Exception {
		if (obj.getResponsavelLiberacaoMatricula().getCodigo().intValue() == 0) {
			obj.setResponsavelLiberacaoMatricula(new UsuarioVO());
			return;
		}
		obj.setResponsavelLiberacaoMatricula(getFacadeFactory().getUsuarioFacade().consultarPorChavePrimaria(obj.getResponsavelLiberacaoMatricula().getCodigo(), nivelMontarDados, null));
	}

	public static void montarDadosResponsavelMatriculaForaPrazo(MatriculaPeriodoVO obj, int nivelMontarDados) throws Exception {
		if (obj.getResponsavelMatriculaForaPrazo().getCodigo().intValue() == 0) {
			obj.setResponsavelMatriculaForaPrazo(new UsuarioVO());
			return;
		}
		obj.setResponsavelMatriculaForaPrazo(getFacadeFactory().getUsuarioFacade().consultarPorChavePrimaria(obj.getResponsavelMatriculaForaPrazo().getCodigo(), nivelMontarDados, null));
	}

	public static void montarDadosResponsavelEmissaoBoletoMatricula(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getResponsavelEmissaoBoletoMatricula().getCodigo().intValue() == 0) {
			obj.setResponsavelEmissaoBoletoMatricula(new UsuarioVO());
			return;
		}
		obj.setResponsavelEmissaoBoletoMatricula(getFacadeFactory().getUsuarioFacade().consultarPorChavePrimaria(obj.getResponsavelEmissaoBoletoMatricula().getCodigo(), nivelMontarDados, usuario));
	}

	/**
	 * Operação Responsável por montar os dados de um objeto da classe
	 * <code>TurmaVO</code> relacionado ao objeto
	 * <code>MatriculaPeriodoVO</code>. Faz uso da chave primária da classe
	 * <code>TurmaVO</code> para realizar a consulta.
	 * 
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 * @deprecated 21-09-2010
	 */
	public static void montarDadosTurma(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getTurma().getCodigo().intValue() == 0) {
			obj.setTurma(new TurmaVO());
			return;
		}
		obj.setTurma(getFacadeFactory().getTurmaFacade().consultarPorChavePrimaria(obj.getTurma().getCodigo(), nivelMontarDados, usuario));
	}

	public static void montarDadosTurma(MatriculaPeriodoVO obj, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getTurma().getCodigo().intValue() == 0) {
			obj.setTurma(new TurmaVO());
			return;
		}
		if (obj.getTurma().getIsDadosDevemSerCarregados(nivelMontarDados)) {
			getFacadeFactory().getTurmaFacade().carregarDados(obj.getTurma(), NivelMontarDados.TODOS, usuario);
			obj.getTurma().setNivelMontarDados(NivelMontarDados.TODOS);
		}
	}

	/**
	 * Operação Responsável por montar os dados de um objeto da classe
	 * <code>PessoaVO</code> relacionado ao objeto
	 * <code>MatriculaPeriodoVO</code>. Faz uso da chave primária da classe
	 * <code>PessoaVO</code> para realizar a consulta.
	 * 
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 */
	public static void montarDadosResponsavelRenovacaoMatricula(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getResponsavelRenovacaoMatricula().getCodigo().intValue() == 0) {
			obj.setResponsavelRenovacaoMatricula(new UsuarioVO());
			return;
		}
		obj.setResponsavelRenovacaoMatricula(getFacadeFactory().getUsuarioFacade().consultarPorChavePrimaria(obj.getResponsavelRenovacaoMatricula().getCodigo(), nivelMontarDados, usuario));
	}

	/**
	 * Operação Responsável por montar os dados de um objeto da classe
	 * <code>PeriodoLetivoVO</code> relacionado ao objeto
	 * <code>MatriculaPeriodoVO</code>. Faz uso da chave primária da classe
	 * <code>PeriodoLetivoVO</code> para realizar a consulta.
	 * 
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 * @deprecated em 06.09.2010 - utilizar Método com mesmo nome, com parâmetro
	 *             NivelMontarDados
	 */
	public static void montarDadosPeriodoLetivoMatricula(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getPeridoLetivo().getCodigo().intValue() == 0) {
			obj.setPeridoLetivo(new PeriodoLetivoVO());
			return;
		}
		// if (!obj.getPeridoLetivo().getIsNivelMontarDadosTodos()) {
		obj.setPeridoLetivo(getFacadeFactory().getPeriodoLetivoFacade().consultarPorChavePrimaria(obj.getPeridoLetivo().getCodigo(), nivelMontarDados, usuario));
		obj.getPeridoLetivo().setNivelMontarDados(NivelMontarDados.TODOS);
		// }
	}

	public static void montarDadosPeriodoLetivoMatricula(MatriculaPeriodoVO obj, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getPeridoLetivo().getCodigo().intValue() == 0) {
			obj.setPeridoLetivo(new PeriodoLetivoVO());
			return;
		}
		if (nivelMontarDados.equals(NivelMontarDados.BASICO)) {
			obj.setPeridoLetivo(getFacadeFactory().getPeriodoLetivoFacade().consultarPorChavePrimaria(obj.getPeridoLetivo().getCodigo(), Uteis.NIVELMONTARDADOS_COMBOBOX, usuario));
		} else {
			obj.setPeridoLetivo(getFacadeFactory().getPeriodoLetivoFacade().consultarPorChavePrimaria(obj.getPeridoLetivo().getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, usuario));
		}
	}

	/**
	 * Operação Responsável por montar os dados de um objeto da classe
	 * <code>PeriodoLetivoVO</code> relacionado ao objeto
	 * <code>MatriculaPeriodoVO</code>. Faz uso da chave primária da classe
	 * <code>PeriodoLetivoVO</code> para realizar a consulta.
	 * 
	 * @deprecated Em 06/09/2010 - utilizar Método com mesmo nome, mas parâmetro
	 *             enum -> NivelMontarDados
	 * @param obj
	 *            Objeto no qual será montado os dados consultados.
	 */
	public static void montarDadosGradeCurricular(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getGradeCurricular().getCodigo().intValue() == 0) {
			obj.setGradeCurricular(new GradeCurricularVO());
			return;
		}
		if (!obj.getGradeCurricular().getIsNivelMontarDadosTodos()) {
			obj.setGradeCurricular(getFacadeFactory().getGradeCurricularFacade().consultarPorChavePrimaria(obj.getGradeCurricular().getCodigo(), nivelMontarDados, usuario));
			obj.getGradeCurricular().setNivelMontarDados(NivelMontarDados.TODOS);
		}
	}

	public static void montarDadosGradeCurricular(MatriculaPeriodoVO obj, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getGradeCurricular().getCodigo().intValue() == 0) {
			obj.setGradeCurricular(new GradeCurricularVO());
			return;
		}
		if (obj.getGradeCurricular().getIsDadosDevemSerCarregados(nivelMontarDados)) {
			obj.setGradeCurricular(getFacadeFactory().getGradeCurricularFacade().consultarPorChavePrimaria(obj.getGradeCurricular().getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, usuario));
			obj.getGradeCurricular().setNivelMontarDados(NivelMontarDados.TODOS);
		}
	}

	/**
	 * @deprecated 22-09-2010
	 * @param obj
	 * @param nivelMontarDados
	 * @throws Exception
	 */
	public static void montarDadosCondicaoPagamentoPlanoFinanceiroCurso(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo().intValue() == 0) {
			obj.setCondicaoPagamentoPlanoFinanceiroCurso(new CondicaoPagamentoPlanoFinanceiroCursoVO());
			return;
		}
		obj.setCondicaoPagamentoPlanoFinanceiroCurso(getFacadeFactory().getCondicaoPagamentoPlanoFinanceiroCursoFacade().consultarPorChavePrimaria(obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
	}

	public static void montarDadosCondicaoPagamentoPlanoFinanceiroCurso(MatriculaPeriodoVO obj, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo().intValue() == 0) {
			obj.setCondicaoPagamentoPlanoFinanceiroCurso(new CondicaoPagamentoPlanoFinanceiroCursoVO());
			return;
		}
		if (obj.getCondicaoPagamentoPlanoFinanceiroCurso().getIsDadosDevemSerCarregados(nivelMontarDados)) {
			obj.setCondicaoPagamentoPlanoFinanceiroCurso(getFacadeFactory().getCondicaoPagamentoPlanoFinanceiroCursoFacade().consultarPorChavePrimaria(obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
			obj.getCondicaoPagamentoPlanoFinanceiroCurso().setNivelMontarDados(NivelMontarDados.TODOS);
		}
	}

	public static void montarDadosConfiguracaoFinanceiro(MatriculaPeriodoVO obj, Integer unidadeEnsinoMatricula, UsuarioVO usuario) throws Exception {
		if (!obj.getConfiguracaoFinanceiro().getIsNivelMontarDadosTodos()) {
			ConfiguracaoFinanceiroVO conf = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_DADOSBASICOS, unidadeEnsinoMatricula, usuario);
			conf.setNivelMontarDados(NivelMontarDados.TODOS);
			obj.setConfiguracaoFinanceiro(conf);
		}
	}

	/**
	 * @deprecated Em 06.09.2010 - utilizar Método de mesmo nome, com o
	 *             parâmetro enum - NivelMontarDados
	 * @param obj
	 * @param nivelMontarDados
	 * @throws Exception
	 */
	public static void montarDadosPlanoFinanceiroCurso(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getPlanoFinanceiroCurso().getCodigo().intValue() == 0) {
			obj.setPlanoFinanceiroCurso(new PlanoFinanceiroCursoVO());
			return;
		}
		if (!obj.getPlanoFinanceiroCurso().getIsNivelMontarDadosTodos()) {
			obj.setPlanoFinanceiroCurso(getFacadeFactory().getPlanoFinanceiroCursoFacade().consultarPorChavePrimaria(obj.getPlanoFinanceiroCurso().getCodigo(), "", Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario));
			obj.setNivelMontarDados(NivelMontarDados.TODOS);
		}
	}

	public static void montarDadosPlanoFinanceiroCurso(MatriculaPeriodoVO obj, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getPlanoFinanceiroCurso().getCodigo().intValue() == 0) {
			obj.setPlanoFinanceiroCurso(new PlanoFinanceiroCursoVO());
			return;
		}
		if (obj.getPlanoFinanceiroCurso().getIsDadosDevemSerCarregados(nivelMontarDados)) {
			obj.setPlanoFinanceiroCurso(getFacadeFactory().getPlanoFinanceiroCursoFacade().consultarPorChavePrimaria(obj.getPlanoFinanceiroCurso().getCodigo(), "", Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario));
			obj.setNivelMontarDados(NivelMontarDados.TODOS);
		}
	}

	/**
	 * @deprecated em 06.09.2010 - utilizar Método de mesmo nome, com parâmetro
	 *             enum - NivelMontarDados
	 * @param matriculaVO
	 * @param obj
	 * @param nivelMontarDados
	 * @throws Exception
	 */
	public void montarDadosProcessoMatriculaCalendarioVO(MatriculaVO matriculaVO, MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getProcessoMatricula().intValue() == 0) {
			obj.setProcessoMatriculaCalendarioVO(new ProcessoMatriculaCalendarioVO());
			return;
		}
		if (!obj.getUnidadeEnsinoCursoVO().getIsNivelMontarDadosTodos()) {
			UnidadeEnsinoCursoVO unidadeCursoVO = getFacadeFactory().getUnidadeEnsinoCursoFacade().consultaRapidaPorCursoUnidadeTurno(matriculaVO.getCurso().getCodigo(), matriculaVO.getUnidadeEnsino().getCodigo(), matriculaVO.getTurno().getCodigo(), usuario);
			unidadeCursoVO.setNivelMontarDados(NivelMontarDados.TODOS);
			obj.setUnidadeEnsinoCursoVO(unidadeCursoVO);
			obj.setUnidadeEnsinoCurso(unidadeCursoVO.getCodigo());
		}
		if (!obj.getProcessoMatriculaCalendarioVO().getIsNivelMontarDadosTodos()) {
			obj.setProcessoMatriculaCalendarioVO(getFacadeFactory().getProcessoMatriculaCalendarioFacade().consultarPorChavePrimaria(obj.getUnidadeEnsinoCursoVO().getCurso().getCodigo(), obj.getUnidadeEnsinoCursoVO().getTurno().getCodigo(), obj.getProcessoMatricula(), nivelMontarDados, usuario));
			obj.getProcessoMatriculaCalendarioVO().setNivelMontarDados(NivelMontarDados.TODOS);
		}
	}

	public void montarDadosProcessoMatriculaCalendarioVO(MatriculaVO matriculaVO, MatriculaPeriodoVO obj, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getProcessoMatricula().intValue() == 0) {
			obj.setProcessoMatriculaCalendarioVO(new ProcessoMatriculaCalendarioVO());
			return;
		}
		if (obj.getUnidadeEnsinoCursoVO().getIsDadosDevemSerCarregados(nivelMontarDados)) {
			UnidadeEnsinoCursoVO unidadeCursoVO = null;
			TurnoVO turnoVO = null;
			if (!obj.getCodigo().equals(0)) {
				turnoVO = getFacadeFactory().getTurnoFacade().consultarTurnoPorMatriculaPeriodoUnidadeEnsinoCurso(obj.getCodigo(), false, Uteis.NIVELMONTARDADOS_COMBOBOX, usuario);
			}
			if (turnoVO != null && !turnoVO.getCodigo().equals(0)) {
				unidadeCursoVO = getFacadeFactory().getUnidadeEnsinoCursoFacade().consultaRapidaPorCursoUnidadeTurno(matriculaVO.getCurso().getCodigo(), matriculaVO.getUnidadeEnsino().getCodigo(), turnoVO.getCodigo(), usuario);
			} else {
				unidadeCursoVO = getFacadeFactory().getUnidadeEnsinoCursoFacade().consultaRapidaPorCursoUnidadeTurno(matriculaVO.getCurso().getCodigo(), matriculaVO.getUnidadeEnsino().getCodigo(), matriculaVO.getTurno().getCodigo(), usuario);
			}
			unidadeCursoVO.setNivelMontarDados(NivelMontarDados.TODOS);
			obj.setUnidadeEnsinoCursoVO(unidadeCursoVO);
			obj.setUnidadeEnsinoCurso(unidadeCursoVO.getCodigo());
		}
		if (obj.getProcessoMatriculaCalendarioVO().getIsDadosDevemSerCarregados(nivelMontarDados)) {
			obj.setProcessoMatriculaCalendarioVO(getFacadeFactory().getProcessoMatriculaCalendarioFacade().consultarPorChavePrimaria(obj.getUnidadeEnsinoCursoVO().getCurso().getCodigo(), obj.getUnidadeEnsinoCursoVO().getTurno().getCodigo(), obj.getProcessoMatricula(), Uteis.NIVELMONTARDADOS_TODOS, usuario));
			obj.getProcessoMatriculaCalendarioVO().setNivelMontarDados(NivelMontarDados.TODOS);
			obj.getProcessoMatriculaCalendarioVO().setNovoObj(false);
		}
	}

	/**
	 * @deprecated em 06.09.2010 - utilizar Método de mesmo nome, com parâmetro
	 *             enum - NivelMontarDados
	 * @param obj
	 * @param nivelMontarDados
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void montarDadosProcessoMatriculaCalendarioVO(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO = new ProcessoMatriculaCalendarioVO();
		try {
			if (obj.getProcessoMatricula().intValue() == 0) {
				obj.setProcessoMatriculaCalendarioVO(new ProcessoMatriculaCalendarioVO());
				return;
			}
			if (!obj.getProcessoMatriculaCalendarioVO().getIsNivelMontarDadosTodos()) {
				// MatriculaVO matriculaVO =
				// getFacadeFactory().getMatriculaFacade().consultarPorChavePrimaria(obj.getMatricula(),
				// 0, Uteis.NIVELMONTARDADOS_DADOSBASICOS);
				UnidadeEnsinoCursoVO unidadeCursoVO = getFacadeFactory().getUnidadeEnsinoCursoFacade().consultarPorChavePrimaria(obj.getMatriculaVO().getCurso().getCodigo(), obj.getMatriculaVO().getUnidadeEnsino().getCodigo(), obj.getMatriculaVO().getTurno().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);

				processoMatriculaCalendarioVO = getFacadeFactory().getProcessoMatriculaCalendarioFacade().consultarPorChavePrimaria(unidadeCursoVO.getCurso().getCodigo(), unidadeCursoVO.getTurno().getCodigo(), obj.getProcessoMatricula(), nivelMontarDados, usuario);
				obj.setProcessoMatriculaCalendarioVO(processoMatriculaCalendarioVO);

				obj.getProcessoMatriculaCalendarioVO().setNivelMontarDados(NivelMontarDados.TODOS);
			}
		} catch (Exception e) {
			throw e;
		} finally {
			processoMatriculaCalendarioVO = null;
		}
	}

	public void montarDadosProcessoMatriculaCalendarioVO(MatriculaPeriodoVO obj, NivelMontarDados nivelMontarDados, UsuarioVO usuario) throws Exception {
		try {
			if (obj.getProcessoMatricula().intValue() == 0) {
				obj.setProcessoMatriculaCalendarioVO(new ProcessoMatriculaCalendarioVO());
				return;
			}
			if (obj.getProcessoMatriculaCalendarioVO().getIsDadosDevemSerCarregados(nivelMontarDados)) {
				UnidadeEnsinoCursoVO unidadeCursoVO = getFacadeFactory().getUnidadeEnsinoCursoFacade().consultarPorChavePrimaria(obj.getMatriculaVO().getCurso().getCodigo(), obj.getMatriculaVO().getUnidadeEnsino().getCodigo(), obj.getMatriculaVO().getTurno().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
				obj.setProcessoMatriculaCalendarioVO(getFacadeFactory().getProcessoMatriculaCalendarioFacade().consultarPorChavePrimaria(unidadeCursoVO.getCurso().getCodigo(), unidadeCursoVO.getTurno().getCodigo(), obj.getProcessoMatricula(), Uteis.NIVELMONTARDADOS_TODOS, usuario));
				obj.getProcessoMatriculaCalendarioVO().setNivelMontarDados(NivelMontarDados.TODOS);
			}
		} catch (Exception e) {
			throw e;
		}
	}

	public static void montarCondicaoPagamentoPlanoFinanceiroCurso(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo().intValue() == 0) {
			obj.setCondicaoPagamentoPlanoFinanceiroCurso(new CondicaoPagamentoPlanoFinanceiroCursoVO());
			return;
		}
		obj.setCondicaoPagamentoPlanoFinanceiroCurso(getFacadeFactory().getCondicaoPagamentoPlanoFinanceiroCursoFacade().consultarPorChavePrimaria(obj.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
	}

	public static void montarDadosContratoMatricula(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getContratoMatricula().getCodigo().intValue() == 0) {
			obj.setContratoMatricula(new TextoPadraoVO());
			return;
		}
		obj.setContratoMatricula(getFacadeFactory().getTextoPadraoFacade().consultarPorChavePrimaria(obj.getContratoMatricula().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
	}

	public static void montarDadosContratoFiador(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getContratoFiador().getCodigo().intValue() == 0) {
			obj.setContratoFiador(new TextoPadraoVO());
			return;
		}
		obj.setContratoFiador(getFacadeFactory().getTextoPadraoFacade().consultarPorChavePrimaria(obj.getContratoFiador().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
	}

	public static void montarDadosContratoExtensao(MatriculaPeriodoVO obj, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		if (obj.getContratoExtensao().getCodigo().intValue() == 0) {
			obj.setContratoExtensao(new TextoPadraoVO());
			return;
		}
		obj.setContratoExtensao(getFacadeFactory().getTextoPadraoFacade().consultarPorChavePrimaria(obj.getContratoExtensao().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
	}

	/**
	 * Operação Responsável por excluir todos os objetos da
	 * <code>MatriculaPeriodoVO</code> no BD. Faz uso da operação
	 * <code>excluir</code> disponï¿½vel na classe <code>MatriculaPeriodo</code>
	 * .
	 * 
	 * @param <code>matricula</code> campo chave para Exclusão dos objetos no
	 *        BD.
	 * @exception Exception
	 *                Erro de conexão com o BD ou restrição de acesso a esta
	 *                operação.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirMatriculaPeriodos(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		MatriculaPeriodo.excluir(getIdEntidade());
		getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().excluirMatriculaPeriodoTurmaDisciplinasPorMatricula(matricula, configuracaoFinanceiroVO, usuario);
		String sql = "DELETE FROM MatriculaPeriodo WHERE (matricula = ?)" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario);
		getConexao().getJdbcTemplate().update(sql, new Object[] { matricula });
	}

	/**
	 * Operação Responsável por alterar todos os objetos da
	 * <code>MatriculaPeriodoVO</code> contidos em um Hashtable no BD. Faz uso
	 * da operação <code>excluirMatriculaPeriodos</code> e
	 * <code>incluirMatriculaPeriodos</code> disponíveis na classe
	 * <code>MatriculaPeriodo</code>.
	 * 
	 * @param objetos
	 *            List com os objetos a serem alterados ou incluï¿½dos no BD.
	 * @exception Exception
	 *                Erro de conexão com o BD ou restrição de acesso a esta
	 *                operação.
	 */
	// public void alterarMatriculaPeriodos(MatriculaVO matricula,
	// ProcessoMatriculaCalendarioVO processoMatriculaCalendario,
	// CondicaoPagamentoPlanoFinanceiroCursoVO condicao) throws Exception {
	// excluirMatriculaPeriodos(matricula.getMatricula());
	// incluirMatriculaPeriodos(matricula, processoMatriculaCalendario,
	// condicao);
	// }
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarMatriculaPeriodos(MatriculaVO matricula, ProcessoMatriculaCalendarioVO processoMatriculaCalendario, CondicaoPagamentoPlanoFinanceiroCursoVO condicao, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		// excluirMatriculaPeriodos(matricula);
		incluirMatriculaPeriodosSemExcluir(matricula, processoMatriculaCalendario, configuracaoFinanceiro, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarMatriculaPeriodoVOEspecifico(MatriculaPeriodoVO obj, MatriculaVO matricula, ProcessoMatriculaCalendarioVO processoMatriculaCalendario, CondicaoPagamentoPlanoFinanceiroCursoVO condicao, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		if (obj.getCodigo().equals(0)) {
			incluir(obj, matricula, processoMatriculaCalendario, configuracaoFinanceiro, usuario);

			// getFacadeFactory().getGestaoEnvioMensagemAutomaticaFacade().executarEnvioMensagemRenovacaoMatricula(matricula,
			// usuario);
		} else {
			alterar(obj, matricula, processoMatriculaCalendario, configuracaoFinanceiro, usuario);
		}
	}

	/**
	 * Método Responsável por alterar o Periodo Letivo ativo, referente a
	 * matricula. Vale ressaltar que esta rotina não gera alterações em Períodos
	 * inavitos ou concluídos, pois não existem razões para que os mesmos sejam
	 * alterados dentro de um fluxo normal de processamento.
	 * 
	 * @param matricula
	 * @param processoMatriculaCalendario
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirMatriculaPeriodosSemExcluir(MatriculaVO matricula, ProcessoMatriculaCalendarioVO processoMatriculaCalendario, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		Iterator e = matricula.getMatriculaPeriodoVOs().iterator();
		while (e.hasNext()) {
			MatriculaPeriodoVO obj = (MatriculaPeriodoVO) e.next();
			if ((obj.getCodigo().intValue() != 0) && (!obj.getSituacaoMatriculaPeriodo().equals("FI"))) {
				// So alterar matricula periodo que estiver ativa, ou pendente
				// financeiramente.
				// Caso a matrícula estaja finalizada então a mesma não será
				// mais alterada, a não que
				// ser que seja por Métodos especï¿½ficos para isto.
				alterar(obj, matricula, processoMatriculaCalendario, configuracaoFinanceiro, usuario);
			} else {
				obj.setMatricula(matricula.getMatricula());
				obj.setMatriculaPeriodoTumaDisciplinaVOs(new ArrayList(0));
				if (processoMatriculaCalendario.getProcessoMatricula().intValue() != 0) {
					obj.setProcessoMatricula(processoMatriculaCalendario.getProcessoMatricula());
				}
				incluir(obj, matricula, processoMatriculaCalendario, configuracaoFinanceiro, usuario);
				if (Uteis.isAtributoPreenchido(obj.getTranferenciaEntrada())) {
					criarHistoricoTransferenciaEntrada(obj, configuracaoFinanceiro, usuario);
				}
				adicionarMatriculaPeriodoTurmaDisciplina(obj.getMatricula(), matricula.getTransferenciaEntrada().getCodigo(), obj, configuracaoFinanceiro, usuario);
				getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().incluirMatriculaPeriodoTurmaDisciplinas(obj.getCodigo(), obj.getMatricula(), obj.getMatriculaPeriodoTumaDisciplinaVOs(), configuracaoFinanceiro, matricula.getGradeCurricularAtual(), usuario);
			}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void criarHistoricoTransferenciaEntrada(MatriculaPeriodoVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		TransferenciaEntradaVO transferenciaEntradaVO = getFacadeFactory().getTransferenciaEntradaFacade().consultarPorChavePrimaria(obj.getTranferenciaEntrada(), Uteis.NIVELMONTARDADOS_TODOS, configuracaoFinanceiroVO, usuario);
		getFacadeFactory().getTransferenciaEntradaFacade().criarHistoricoTransferenciaEntrada(transferenciaEntradaVO, usuario, true);		
		getFacadeFactory().getTransferenciaEntradaFacade().alterarSituacao(obj.getTranferenciaEntrada(), "EF");
	}

	/**
	 * Operação Responsável por incluir objetos da
	 * <code>MatriculaPeriodoVO</code> no BD. Garantindo o relacionamento com a
	 * entidade principal <code>academico.Matricula</code> através do atributo
	 * de vínculo.
	 * 
	 * @param objetos
	 *            List contendo os objetos a serem gravados no BD da classe.
	 * @exception Exception
	 *                Erro de conexão com o BD ou restrição de acesso a esta
	 *                operação.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirMatriculaPeriodos(MatriculaVO matricula, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, CondicaoPagamentoPlanoFinanceiroCursoVO condicao, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		Iterator e = matricula.getMatriculaPeriodoVOs().iterator();
		while (e.hasNext()) {
			MatriculaPeriodoVO obj = (MatriculaPeriodoVO) e.next();
			obj.setMatricula(matricula.getMatricula());
			if (processoMatriculaCalendarioVO.getProcessoMatricula().intValue() != 0) {
				obj.setProcessoMatricula(processoMatriculaCalendarioVO.getProcessoMatricula());
			}

			incluir(obj, matricula, processoMatriculaCalendarioVO, configuracaoFinanceiro, usuario);
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirMatriculaPeriodoVOEspecifico(MatriculaPeriodoVO obj, MatriculaVO matricula, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, CondicaoPagamentoPlanoFinanceiroCursoVO condicao, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		obj.setMatricula(matricula.getMatricula());
		if (processoMatriculaCalendarioVO.getProcessoMatricula().intValue() != 0) {
			obj.setProcessoMatricula(processoMatriculaCalendarioVO.getProcessoMatricula());
		}
		incluir(obj, matricula, processoMatriculaCalendarioVO, configuracaoFinanceiro, usuario);
	}

	public void inicializarMatriculaPeriodoTurmaDisciplinaGradeCurso(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario, List<GradeDisciplinaCompostaVO> gradeDisciplinaCompostaVOs, Boolean considerarVagaReposicao, Boolean liberarRealizarMatriculaDisciplinaPreRequisito) throws Exception {
		
		if (matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().isEmpty()
				|| (matriculaVO.getCurso().getConfiguracaoAcademico().isHabilitarInclusaoDisciplinaDependenciaPrimeiroDepoisRegulares() && matriculaPeriodoVO.getIsNovaMatriculaPeriodo())) {
			// Se a lista estão vazia, então o sistema irá tentar gerar
			// automaticamente
			// a lista de disciplinas para o aluno. Isto com base na turma que
			// estão
			// selecionada na primeira aba. Lembrando, que uma turma possui
			// disciplinas
			// específicas, definidas para a mesma, que muitas vezes nao são as
			// mesmas
			// da grade (ou seja, podem conter menos disciplinas que na grade).
			matriculaPeriodoVO.setMatriculaVO(matriculaVO);
			obterListaMatriculaPeriodoTurmaDisciplinaVO(matriculaPeriodoVO, matriculaVO, usuario, gradeDisciplinaCompostaVOs, considerarVagaReposicao, liberarRealizarMatriculaDisciplinaPreRequisito);
		}
	}

	/**
	 * VOLTARPARACONCLUIR
	 * 
	 * @param disciplinaVerificar
	 * @param matriculaPeriodo
	 * @return
	 * @throws Exception
	 * @deprecated versão 5.0 - Preferivel utilizar o Método com mesmo nome, que
	 *             tem como parametro a MatriculaComHistoricoAlunoVO, que já
	 *             possui todos os históricos consultados, evitando vï¿½rias
	 *             novas consultas ao BD.
	 */
	public Boolean verificarAlunoAprovadoTodosPreRequisitos(DisciplinaVO disciplinaVerificar, MatriculaPeriodoVO matriculaPeriodo) throws Exception {
		// getFacadeFactory().getDisciplinaFacade().consultarDisciplinasPreRequisitoNaoCumpridasDaGrade(matriculaPeriodo.getMatricula(),
		// , Integer.SIZE, true, nivelMontarDados);
		// PeriodoLetivoVO periodoLetivo =
		// matriculaPeriodo.getGradeCurricular().consultarObjPeriodoLetivoVOPorCodigo(matriculaPeriodo.getPeridoLetivo().getCodigo());
		// Iterator i = listaPreRequisitos.iterator();
		// while (i.hasNext()) {
		// DisciplinaPreRequisitoVO obj = (DisciplinaPreRequisitoVO) i.next();
		// List hist = consultarHistoricoAlunoDisciplina(matricula,
		// obj.getCodigo());
		// if (hist.isEmpty()) {
		// return false;
		// }
		// }
		return true;
	}

	/**
	 * Método Responsável por gerar as MatriculaPeriodoTurmaDisciplinaVO para as
	 * disciplinas de uma disciplina composta. Versão 5.0
	 * 
	 * @param novaMatriculaPeriodoTurmaDisciplina
	 * @param matriculaPeriodoVO
	 * @return
	 * @throws Exception
	 */
	public List<MatriculaPeriodoTurmaDisciplinaVO> gerarEAdicionarMatriculaPeriodoTurmaDisciplinaVOParaDisciplinasComposicao(MatriculaPeriodoTurmaDisciplinaVO novaMatriculaPeriodoTurmaDisciplina, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, UsuarioVO usuario, List<GradeDisciplinaCompostaVO> gradeDisciplinaCompostaVOs) throws Exception {
		if (!novaMatriculaPeriodoTurmaDisciplina.getDisciplinaComposta() || (TipoControleComposicaoEnum.ESTUDAR_QUANTIDADE_MAXIMA_COMPOSTA.equals(novaMatriculaPeriodoTurmaDisciplina.getGradeDisciplinaVO().getTipoControleComposicao()) && !Uteis.isAtributoPreenchido(gradeDisciplinaCompostaVOs))) {
			return null;
		}
		// obtendo os detalhes das disciplinas que fazem parte da composicao.
		// abaixo vamos obter a lista de disciplinas que fazer parte da
		// composticao. Vale ressaltar que o código abaixo já estão
		// observando se a disciplina em questãoo vem de um grupo de optativa ou
		// ï¿½ de uma gradedisciplina recular.
		// Com relação a equivalencia isto indifere, pois ao cursar uma
		// disciplina por equivalencia, as regras da disciplina equivalente
		// já são refletidas automaticamente pelo Método abaixo. Ou seja, mesma
		// que seja uma disciplina equivalente (de outro curso)
		// se ela for de um grupo de optativa, isto estarï¿½ definido nos
		// atributos referentes a grupo de optativa e o Método abaixo irá
		// perceber isto.
		if (!Uteis.isAtributoPreenchido(gradeDisciplinaCompostaVOs)) {
			if (novaMatriculaPeriodoTurmaDisciplina.getDisciplinaReferenteAUmGrupoOptativa()) {
				gradeDisciplinaCompostaVOs = getFacadeFactory().getGradeDisciplinaCompostaFacade().consultarPorGrupoOptativaDisciplina(novaMatriculaPeriodoTurmaDisciplina.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, usuario);
			} else {
				gradeDisciplinaCompostaVOs = getFacadeFactory().getGradeDisciplinaCompostaFacade().consultarPorGradeDisciplina(novaMatriculaPeriodoTurmaDisciplina.getGradeDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, usuario);
			}
		}
		if (gradeDisciplinaCompostaVOs.isEmpty()) {
			throw new Exception("estão sendo incluída uma disciplina composta (" + novaMatriculaPeriodoTurmaDisciplina.getDisciplina().getCodigo() + " - " + novaMatriculaPeriodoTurmaDisciplina.getDisciplina().getNome() + "), contudo a Composição da mesma não foi defenida na Matriz Curricular correspondente da turma: " + novaMatriculaPeriodoTurmaDisciplina.getTurma().getIdentificadorTurma());
		}
		List<MatriculaPeriodoTurmaDisciplinaVO> matriculaPeriodoTurmaDisciplinaVOs = new ArrayList<MatriculaPeriodoTurmaDisciplinaVO>(0);
		for (GradeDisciplinaCompostaVO gradeDisciplinaCompostaVO : gradeDisciplinaCompostaVOs) {
			MatriculaPeriodoTurmaDisciplinaVO novaMatriculaPeriodoTurmaDisciplinaComposicao = gerarMatriculaPeriodoTurmaDisciplinaVOValidado(null, false, // indica
																																							// se
																																							// a
																																							// disciplina
																																							// será
																																							// cursada
																																							// por
																																							// meio
																																							// de
																																							// um
																																							// mapa
																																							// de
																																							// equivalencia
					null, // nao podem ser cursadas por equivalencia, pois sao
							// composicoes de uma disciplina principal
					null, // nao podem ser cursadas por equivalencia, pois sao
							// composicoes de uma disciplina principal
					false, // nao tratamos a mesma como um GrupoOptativa, pois
							// trata-se de uma composticao
					null, // nao tratamos a mesma como um GrupoOptativa, pois
							// trata-se de uma composticao
					novaMatriculaPeriodoTurmaDisciplina.getDisciplinaEmRegimeEspecial(), true, // true
																								// para
																								// indicar
																								// que
																								// ï¿½
																								// uma
																								// disciplina
																								// de
																								// uma
																								// composicao
					gradeDisciplinaCompostaVO, // dados da disciplina da
												// composicao (codigo da
												// disciplina, carga horaria,
												// cfg e agins)
					gradeDisciplinaCompostaVO.getModalidadeDisciplina(), matriculaPeriodoVO, matriculaVO, novaMatriculaPeriodoTurmaDisciplina.getTurma(), novaMatriculaPeriodoTurmaDisciplina.getTurmaPratica(), novaMatriculaPeriodoTurmaDisciplina.getTurmaTeorica(), usuario);
			realizarVerificacaoExistenciaAulaProgramada(matriculaVO, matriculaPeriodoVO, novaMatriculaPeriodoTurmaDisciplinaComposicao);
			matriculaPeriodoTurmaDisciplinaVOs.add(novaMatriculaPeriodoTurmaDisciplinaComposicao);			
		}
		for(MatriculaPeriodoTurmaDisciplinaVO mptd:matriculaPeriodoTurmaDisciplinaVOs){
			matriculaPeriodoVO.adicionarObjMatriculaPeriodoTurmaDisciplinaVOs(mptd);
		}
		return matriculaPeriodoTurmaDisciplinaVOs;
		//Uteis.liberarListaMemoria(matriculaPeriodoTurmaDisciplinaVOs);
	}

	/**
	 * Método Responsável por definir se um disciplina que estão sendo incluída,
	 * trata-se de uma inclusão ou não. Caso seja uma inclusao, existem
	 * controles que podem impedir que a mesma seja incluída, por ultrapassar o
	 * limite configurado para o curso (configuraAcademica).
	 * 
	 * @param matriculaPeriodoVO
	 * @param matriculaVO
	 * @param matricaPeriodoTurmaDisciplina
	 * @param usuario
	 * @return
	 * @throws Exception
	 */
	public boolean verificarDisciplinaMatriculaPeriodoTurmaDisciplinaEUmaInclusao(MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matricula, MatriculaPeriodoTurmaDisciplinaVO matricaPeriodoTurmaDisciplina, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoTurmaDisciplinaVO> gradePadraoCalculadaAluno = obterListaMatriculaPeriodoTurmaDisciplinaVOPeriodoLetivoTurmaIndependenteAluno(matriculaPeriodo, matricula, usuario);
		boolean incluida = true;
		for (MatriculaPeriodoTurmaDisciplinaVO padrao : gradePadraoCalculadaAluno) {
			if (padrao.getDisciplina().getCodigo().equals(matricaPeriodoTurmaDisciplina.getDisciplina().getCodigo())) {
				incluida = false;
			}
		}
		return incluida;
	}
	
	@Override
	public void validarDisciplinaIncluidasPodeSerAdicionadaMatriculaPeriodoConformeLimiteMinimoPeriodoLetivo(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO,  UsuarioVO usuario)  {
		if (matriculaVO.getCurso().getConfiguracaoAcademico().getTipoControleInclusaoDisciplinaPorNrMaxCreditoOuCH().equals("CR") &&
				matriculaPeriodoVO.getPeriodoLetivo().getNumeroMinimoCreditoAlunoPodeCursar() != 0 &&	
				matriculaPeriodoVO.getPeriodoLetivo().getNumeroMinimoCreditoAlunoPodeCursar() > matriculaPeriodoVO.getTotalCreditoAlunoMatriculaPeriodo()) {
			throw new StreamSeiException("O total de créditos de disciplinas incluídas nesse Período Letivo é menor que o Número Mínimo de Créditos Exigidos na Matriz Curricular.");
		} else if (matriculaVO.getCurso().getConfiguracaoAcademico().getTipoControleInclusaoDisciplinaPorNrMaxCreditoOuCH().equals("CH") &&
					matriculaPeriodoVO.getPeriodoLetivo().getNumeroMinimoCargaHorariaAlunoPodeCursar() !=0  &&
					matriculaPeriodoVO.getPeriodoLetivo().getNumeroMinimoCargaHorariaAlunoPodeCursar() > matriculaPeriodoVO.getTotalCargaHorariaAlunoMatriculaPeriodo()) {
			throw new StreamSeiException("O total de carga horária de disciplinas incluídas nesse Período Letivo é menor que a Carga Horária Mínima Exigida na Matriz Curricular.");
		}
	}

	/*
	 * Método Responsável por validar se um disciplina do tipo Incluida, pode
	 * ser incluida a matricula periodo ou não. Este Método trabalha em
	 * conformidade com uma configuracao no academico que pode limitar o
	 * nï¿½mero de disciplinas incluidas em um periodo, com base em um limite
	 * estabelecido para o periodo letivo e com base no saldo de disciplinas que
	 * o aluno deve em periodo anteriores. Este método não aplica esta validação
	 * caso a disciplina seja incluída por meio da tela INCLUSAO / EXCLUSAO
	 * disciplina fora do prazo.
	 */
	public void validarDisciplinaDoTipoIncluidaPodeSerAdicionadaMatriculaPeriodoConformeLimiteMaxPeriodoLetivo(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, MatriculaPeriodoTurmaDisciplinaVO matricaPeriodoTurmaDisciplina, UsuarioVO usuario) throws Exception {
		if (matriculaPeriodoVO.getUsuarioLiberouIncluaoDisciplinaAcimaLimiteMaxPeriodoLetivo()  || matricaPeriodoTurmaDisciplina.getDisciplinaFazParteComposicao()) {
			return;
		}
		ConfiguracaoAcademicoVO configuracaoAcademicoVO = matriculaVO.getCurso().getConfiguracaoAcademico();
		if (matricaPeriodoTurmaDisciplina.getInclusaoForaPrazo()) {
			// este método não deve validar caso a disciplina incluída trata-se
			// de uma
			// disciplina incluída fora do prazo. Este tela deve ser utilizada
			// internamente
			// para gestão de disciplinas do aluno (fora do prazo) que são
			// geralmente regime de
			// exceção
			return;
		}

		if (configuracaoAcademicoVO.getControlarInclusaoDisciplinaPorNrMaxCreditoOuCH()) {
				/**
				 * Com base na Configuração Academica o controle da carga horária máxima cursada por periodo deve ser validada independentemente da disciplina ser uma inclusão
				 */
				//boolean disciplinaIncluidaPeloAluno = verificarDisciplinaMatriculaPeriodoTurmaDisciplinaEUmaInclusao(matriculaPeriodoVO, matriculaVO, matricaPeriodoTurmaDisciplina, usuario);
			
				// Consulta o PeridoLetivo para que possa montar os dados para
				// realização do cálculo do saldo disponível para inclusão de
				// disciplinas.
				matriculaPeriodoVO.setPeridoLetivo(getFacadeFactory().getPeriodoLetivoFacade().consultarPorChavePrimaria(matriculaPeriodoVO.getPeriodoLetivo().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
				// Realiza o cálculo e atualiza os valores dos atributos
				// responsáveis pelo controle do saldo da carga horária e do
				// saldo de crédito disponível.
				
				atualizarNrDisciplinasIncluidasExcluidas(matriculaPeriodoVO, matriculaVO, usuario);
				

				int cargaHorariaDisciplina = matricaPeriodoTurmaDisciplina.getCargaHorariaDisciplina();
				int creditoDisciplina = matricaPeriodoTurmaDisciplina.getCreditosDisciplina();

				if (configuracaoAcademicoVO.getTipoControleInclusaoDisciplinaPorNrMaxCreditoOuCH().equals("CR")) {
					// controlar por credito
					if (creditoDisciplina > matriculaPeriodoVO.getSaldoCreditoDisponivelInclusaoDisplinas() && matriculaPeriodoVO.getPeriodoLetivo().getNumeroMaximoCreditoAlunoPodeCursar() > 0) {
						StringBuilder msg = new StringBuilder();
						msg.append("Não foi possível adicionar esta disciplina pois ultrapassa-se o limite máximo de créditos para inclusão de disciplinas do Período letivo. ");
						msg.append("Saldo restante de crédito disponível para inclusão de novas disciplinas: ").append(matriculaPeriodoVO.getSaldoCreditoDisponivelInclusaoDisplinas()).append(". ");
						// if
						// (configuracaoAcademicoVO.getAcumularCreditosOuCHPeriodosAnterioresNaoCumpridos())
						// {
						// msg.append("Crï¿½ditos pendentes de Períodos anteriores que podem ser incluï¿½dos: ").append(matriculaPeriodoVO.getTotalCreditoPendenteAlunoAtePeriodoAnterior());
						// }
						msg.append("Créditos desta disciplina: ").append(creditoDisciplina).append(". ");
						throw new Exception(msg.toString());
					}
				} else {
					// controlar por carga horaria
					if (cargaHorariaDisciplina > matriculaPeriodoVO.getSaldoCHDisponivelInclusaoDisplinas() && matriculaPeriodoVO.getPeriodoLetivo().getNumeroMaximoCargaHorariaAlunoPodeCursar() > 0) {
						StringBuilder msg = new StringBuilder();
						msg.append("Não foi possível adicionar esta disciplina pois ultrapassa-se o limite máximo de carga horária para inclusão de disciplinas do Período letivo. ");
						msg.append("Saldo restante de carga horária disponível para inclusão de novas disciplinas: ").append(matriculaPeriodoVO.getSaldoCHDisponivelInclusaoDisplinas()).append(". ");
						// if
						// (configuracaoAcademicoVO.getAcumularCreditosOuCHPeriodosAnterioresNaoCumpridos())
						// {
						// msg.append("Carga horï¿½ria pendente de Períodos anteriores que podem ser incluídas: ").append(matriculaPeriodoVO.getTotalCHPendenteAlunoAtePeriodoAnterior());
						// }
						msg.append("Carga horária desta disciplina: ").append(cargaHorariaDisciplina).append(". ");
						throw new Exception(msg.toString());
					}
				}
			
		}
	}

	public void validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, Boolean liberarRealizarMatriculaDisciplinaPreRequisito, MatriculaPeriodoTurmaDisciplinaVO matricaPeriodoTurmaDisciplina, UsuarioVO usuario, Boolean realizandoRecebimento) throws Exception {
		if (realizandoRecebimento) {
			validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(matriculaPeriodoVO, matriculaVO, liberarRealizarMatriculaDisciplinaPreRequisito, true, matricaPeriodoTurmaDisciplina, usuario);
		} else {
			validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(matriculaPeriodoVO, matriculaVO, liberarRealizarMatriculaDisciplinaPreRequisito, false, matricaPeriodoTurmaDisciplina, usuario);
		}
	}
	
	/*
	 * Método Responsável por fazer as validações necessórias para adicionar
	 * MatriculaPeriodoTurmaDisciplina para um determinado aluno. Verificando se
	 * o mesmo já estão cursando a disciplina, se o mesmo já foi aprovado na
	 * mesma, se já cumpriu os pré-requesitos da mesma.
	 */
	public void validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, Boolean liberarRealizarMatriculaDisciplinaPreRequisito, 
			Boolean ignorarValidacaoAlunoJaEstaCursandoDisciplina,
	        // liberado
            // via
            // senha
            // pelo
            // usuário
            // que
            // estão
            // renovando...
            MatriculaPeriodoTurmaDisciplinaVO matricaPeriodoTurmaDisciplina, UsuarioVO usuario) throws Exception {
        // Obtendo a configuracao em nï¿½vel de curso - pois trata-se da
        // configuracao academico Padrão do curso
        ConfiguracaoAcademicoVO configuracaoAcademicoVO = matriculaVO.getCurso().getConfiguracaoAcademico();
//      Foi retirado do if a validação de nova matricula e se a renovação está ativa pois independente se é ou não uma nova matrícula ou uma renovação não pode ser ignorado a regra da pré-matricula 
		if (!liberarRealizarMatriculaDisciplinaPreRequisito) {
			// Adicionada regra para validar pré-requisito de disciplina que faz parte de uma composição, visto que, é possível selecionar a filha que poderá ser estudada conforme configurado.
			if (matricaPeriodoTurmaDisciplina.getDisciplinaFazParteComposicao()) {
				if (matricaPeriodoTurmaDisciplina.getGradeDisciplinaCompostaVO().getGradeDisciplina().getValidarPreRequisitoDisciplinaFazParteComposicao()) {
					validarDadosDisciplinaEPreRequisito(matricaPeriodoTurmaDisciplina.getDisciplina(), matriculaVO, matriculaPeriodoVO, configuracaoAcademicoVO.getLiberarPreRequisitoDisciplinaConcomitancia(), matricaPeriodoTurmaDisciplina.getMapaEquivalenciaDisciplinaVOIncluir(), usuario);
				}
			} else {
				validarDadosDisciplinaEPreRequisito(matricaPeriodoTurmaDisciplina.getDisciplina(), matriculaVO, matriculaPeriodoVO, configuracaoAcademicoVO.getLiberarPreRequisitoDisciplinaConcomitancia(), matricaPeriodoTurmaDisciplina.getMapaEquivalenciaDisciplinaVOIncluir(), usuario);
			}
		}
      
//      if ((!permitirCursarDisciplinaEPreRequisitoConcomitantemente) && (!matriculaVO.getMatricula().equals("")) && (!liberarRealizarMatriculaDisciplinaPreRequisito) && (!matriculaPeriodoVO.getSituacaoPreMatricula())) {
//      	validarDadosDisciplinaEPreRequisito(matricaPeriodoTurmaDisciplina.getDisciplina(), matriculaVO, matriculaPeriodoVO, matricaPeriodoTurmaDisciplina.getTurma().getPeridoLetivo().getCodigo(), permitirCursarDisciplinaEPreRequisitoConcomitantemente, usuario);
//      }
      
//        if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getIsValorPorDisciplina()) {
            //getFacadeFactory().getCondicaoPlanoFinanceiroCursoTurmaFacade().consultarValorCondicaoPlanoFinanceiroCursoTurma(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo(), matricaPeriodoTurmaDisciplina.getDisciplina().getCodigo(), usuario);
//        }

        MatriculaComHistoricoAlunoVO matriculaComHistorico = matriculaVO.getMatriculaComHistoricoAlunoVO();
        
//        HistoricoVO histReprovado = (HistoricoVO) matriculaComHistorico.getGradeCurricularComHistoricoAlunoVO().verificarAlunoReprovadoDisciplina(matricaPeriodoTurmaDisciplina.getDisciplina().getCodigo());
        HistoricoVO hist = matriculaComHistorico.getGradeCurricularComHistoricoAlunoVO().verificarAlunoAprovadoDisciplina(matricaPeriodoTurmaDisciplina.getDisciplina().getCodigo());
        if (hist != null && !matriculaPeriodoVO.getVerificarHistoricoDesistiuEquivalencia(hist)) {
            throw new Exception("O aluno (" + hist.getMatricula().getMatricula() + ") já está aprovado nesta disciplina ("+ hist.getDisciplina().getCodigo() + " - " + hist.getDisciplina().getNome() + "). Ano/Semestre Cursou Disciplina: " + hist.getAnoHistorico() + "/" + hist.getSemestreHistorico());
        }
        if (!ignorarValidacaoAlunoJaEstaCursandoDisciplina) {
        	hist = matriculaComHistorico.getGradeCurricularComHistoricoAlunoVO().verificarAlunoCursandoDisciplina(matricaPeriodoTurmaDisciplina.getDisciplina().getCodigo());
        	if (hist != null) {
        		throw new Exception("O Aluno " + matricaPeriodoTurmaDisciplina.getMatriculaObjetoVO().getAluno().getNome() + " já está cursando a disciplina " + hist.getDisciplina().getNome() + " por isto a mesma não poderá ser incluída novamente.");
        	}
        }
        validarDisciplinaDoTipoIncluidaPodeSerAdicionadaMatriculaPeriodoConformeLimiteMaxPeriodoLetivo(matriculaPeriodoVO, matriculaVO, matricaPeriodoTurmaDisciplina, usuario);
    }

	/*
	 * Adicionar MatriculaPeriodoTurmaDisciplinaVO a partir de um
	 * TurmaDisciplinaVO. Este Método considera que os dados da Turma estãoo
	 * carregados (inclusive com os dados da TurmaDisciplina - fkï¿½s para
	 * configuracao, gradeDisciplina, gradeGrupoOptativadisciplina) Este Método
	 * considera que MatriculaComHistoricoAlunoVO tambem deve estar montado.
	 * Dados da MatriculaPeriodoTurmaDisciplinaVO também precisam estar
	 * preenchidos, considerando, possível variacoes como: disciplina
	 * equivalente, disciplina composta, disciplina grupo optativas ... O mesmo
	 * irá adicionar o obj matricaPeriodoTurmaDisciplina e fazer todas as
	 * validacoes necessarias Desenvolvido conforme Versão 5.0
	 */
	public void adicionarEValidarMatriculaPeriodoTurmaDisciplinaVO(MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matricula, Boolean liberarRealizarMatriculaDisciplinaPreRequisito, // liberado
			// via
			// senha
			// pelo
			// usuário
			// que
			// estão
			// renovando...
			TurmaVO turma, TurmaDisciplinaVO obj, List<HorarioAlunoTurnoVO> horarioAlunoTurnoVOs, Boolean considerarVagaReposicao, UsuarioVO usuario) throws Exception {
		MatriculaPeriodoTurmaDisciplinaVO novoObj = gerarMatriculaPeriodoTurmaDisciplinaVOValidado(obj.getGradeDisciplinaVO(), false, // indica
				// se
				// a
				// disciplina
				// será
				// cursada
				// por
				// meio
				// de
				// um
				// mapa
				// de
				// equivalencia
				null, // indica a qual mapa de equivalencia de disciplina estão
				// sendo criado o objeto
				null, // indica a qual disciplina do mapa de equivalencia o
				// aluno irá cursar nesta
				// MatriculaPeriodoTurmaDisciplina
				obj.getDisciplinaReferenteAUmGrupoOptativa(), obj.getGradeCurricularGrupoOptativaDisciplinaVO(), false, // indica
				// que
				// o
				// aluno
				// foi
				// liberado
				// para
				// estudar
				// a
				// disciplina,
				// mesmo
				// com
				// choque
				// de
				// horário
				// com
				// outras
				// disciplinas
				// de
				// sua
				// turma
				false, // se a principal, trata-se de uma composicao, o metodo
				// que adiciona a MatriculaPEriodoTurmaDisciplina irá
				// tratar esta situacao
				null, obj.getModalidadeDisciplina(), matriculaPeriodo, matricula, turma, null, null, usuario);
		adicionarEValidarMatriculaPeriodoTurmaDisciplinaVO(matriculaPeriodo, matricula, liberarRealizarMatriculaDisciplinaPreRequisito, novoObj, horarioAlunoTurnoVOs, considerarVagaReposicao, usuario);
	}

	/*
	 * Verifica se uma determinada disciplina pode ser cursada em Regime
	 * Especial. Para isto duas verificaï¿½ï¿½es precisam ser realizadas, pelo
	 * conceito de Regime Especial. Primeiro, ï¿½ verificar se o nrDisciplinas
	 * que estãoo sendo cursadas pelo aluno periodo nao ultrapassa o limite
	 * definido na configuracao do sistema. Segundo, ï¿½ para o aluno cursar uma
	 * disciplina em Regime Especial ele precisa já ter cursado a disciplina no
	 * passado e ter reprovado na mesma.
	 */
	public void verificarDisciplinaPodeSerEstudaEmRegimeEspecial(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, MatriculaPeriodoTurmaDisciplinaVO matricaPeriodoTurmaDisciplina, UsuarioVO usuario) throws Exception {
		ConfiguracaoAcademicoVO cfg = matriculaVO.getCurso().getConfiguracaoAcademico();
		if (!cfg.getPermitirInclusaoDiscipDependenciaComChoqueHorario()) {
			throw new Exception("A configuração acadêmica deste curso não permite a inclusão de disciplinas em Regime Especial (Com Choque de horário).");
		}
		int qtdDisciplinasRegimeEspecial = 0;
		for (MatriculaPeriodoTurmaDisciplinaVO objs : matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()) {
			if (objs.getDisciplinaEmRegimeEspecial()) {
				qtdDisciplinasRegimeEspecial += 1;
			}
		}
		if (qtdDisciplinasRegimeEspecial >= cfg.getQtdPermitirInclusaoDiscipDependenciaComChoqueHorario()) {
			throw new Exception("Pode-se incluir no máximo " + cfg.getQtdPermitirInclusaoDiscipDependenciaComChoqueHorario() + " disciplina(s) em Regime Especial. já foi atingido este limite de disciplinas que podem ser estudas em Regime Especial (Com Choque de horário).");
		}
		// Verificando se o aluno já foi reprovado nesta disciplina, alguma vez.
		DisciplinaVO disciplinaCandidataParaRegimeEspecial = matricaPeriodoTurmaDisciplina.getDisciplina();
		List<HistoricoVO> historicosReprovacao = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().verificarAlunoReprovadoDisciplina(disciplinaCandidataParaRegimeEspecial.getCodigo());
		if ((historicosReprovacao == null) || (historicosReprovacao.isEmpty())) {
			throw new Exception("Este aluno não estão de dependência desta disciplina, portanto não pode incluí-la em Regime Especial (Com Choque de horário). Este recurso é válido somente para disciplinas que o aluno tenha sido reprovado na mesma no passado.");
		}
		if (cfg.getPermitirInclusaoComChoqueHorDiscipNaoReprovadasPorFalta()) {
			// se true ï¿½ por que só permite-se incluir com choque de horario
			// se
			// o aluno
			// ja foi reprovado no passado.-
			Boolean reprovadoPorNota = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().verificarAlunoJaCursouDisciplinaEEstaReprovadoPorNota(disciplinaCandidataParaRegimeEspecial.getCodigo());
			if (!reprovadoPorNota) {
				throw new Exception("Para incluir esta disciplina em Regime Especial, o aluno precisaria ter sido reprovado na mesma por NOTA (não pode ser por FALTA ou ABANDONO). Portanto esta disciplina não pode ser incluída em Regime Especial (Com Choque de horário).");
			}
		}

	}

	/*
	 * Adicionar MatriculaPeriodoTurmaDisciplinaVO recebendo este com os dados
	 * já montados. Este Método considera que os dados da Turma estãoo
	 * carregados (inclusive com os dados da TurmaDisciplina - fkï¿½s para
	 * configuracao, gradeDisciplina, gradeGrupoOptativadisciplina) Este Método
	 * considera que MatriculaComHistoricoAlunoVO tambem deve estar montado.
	 * Dados da MatriculaPeriodoTurmaDisciplinaVO também precisam estar
	 * preenchidos, considerando, possível variacoes como: disciplina
	 * equivalente, disciplina composta, disciplina grupo optativas ... O mesmo
	 * irá adicionar o obj matricaPeriodoTurmaDisciplina e fazer todas as
	 * validacoes necessarias Desenvolvido conforme Versão 5.0
	 */
	public void adicionarEValidarMatriculaPeriodoTurmaDisciplinaVO(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, Boolean liberarRealizarMatriculaDisciplinaPreRequisito, // liberado
			// via
			// senha
			// pelo
			// usuário
			// que
			// estão
			// renovando...
			MatriculaPeriodoTurmaDisciplinaVO matricaPeriodoTurmaDisciplina, List<HorarioAlunoTurnoVO> horarioAlunoTurnoVOs, Boolean considerarVagaReposicao, UsuarioVO usuario) throws Exception {
		if (matricaPeriodoTurmaDisciplina.getDisciplinaEmRegimeEspecial()) {
			verificarDisciplinaPodeSerEstudaEmRegimeEspecial(matriculaPeriodoVO, matriculaVO, matricaPeriodoTurmaDisciplina, usuario);
		} else {
			executarVerificarSeHaIncompatibilidadeHorarioDeDisciplinas(matriculaPeriodoVO, matricaPeriodoTurmaDisciplina, horarioAlunoTurnoVOs, matriculaVO.getCurso().getConfiguracaoAcademico().getValidarChoqueHorarioOutraMatriculaAluno(), usuario);
		}
		// se chegarmos aqui aqui ï¿½ por que o aluno não estão aprovado nem
		// cursando a disciplina em outros periodos, logo a
		// mesma pode ser adicionada. Para isto vamos gerar uma nova versão da
		// MatriculaPeriodoTurmaDisciplina com os dados
		// já validados e organizados - do ponto de vista de disciplinas
		// equivalentes, disciplinas de grupo de optativas e regulares.
		// por default geramos a MatriculaPeriodoTurmaDisciplina para a
		// disciplina principal da composicao. Logo abaixo, iremos tratar o
		// aspecto da composicao
		MatriculaPeriodoTurmaDisciplinaVO novaMatriculaPeriodoTurmaDisciplina = gerarMatriculaPeriodoTurmaDisciplinaVOValidado(matricaPeriodoTurmaDisciplina.getGradeDisciplinaVO(), matricaPeriodoTurmaDisciplina.getDisciplinaPorEquivalencia(), matricaPeriodoTurmaDisciplina.getMapaEquivalenciaDisciplinaVOIncluir(), matricaPeriodoTurmaDisciplina.getMapaEquivalenciaDisciplinaCursada(), matricaPeriodoTurmaDisciplina.getDisciplinaReferenteAUmGrupoOptativa(), matricaPeriodoTurmaDisciplina.getGradeCurricularGrupoOptativaDisciplinaVO(), matricaPeriodoTurmaDisciplina.getDisciplinaEmRegimeEspecial(), matricaPeriodoTurmaDisciplina.getDisciplinaFazParteComposicao(), matricaPeriodoTurmaDisciplina.getGradeDisciplinaCompostaVO(), matricaPeriodoTurmaDisciplina.getModalidadeDisciplina(), matriculaPeriodoVO, matriculaVO, matricaPeriodoTurmaDisciplina.getTurma(), matricaPeriodoTurmaDisciplina.getTurmaPratica(), matricaPeriodoTurmaDisciplina.getTurmaTeorica(), usuario);
		validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(matriculaPeriodoVO, matriculaVO, liberarRealizarMatriculaDisciplinaPreRequisito, matricaPeriodoTurmaDisciplina.getIgnorarValidacaoDisciplinaSendoCursadaAluno(), novaMatriculaPeriodoTurmaDisciplina, usuario);

		// Uma vez gerado a novaMatriculaPeriodoTurmaDisciplina temos que
		// verificar se a disciplina efetivada para que
		// o aluno estudar, trata-se de uma disciplina composta. Lembrando que
		// ela pode vir de um GrupoOptativa, de uma mapa de equivalencia, ou
		// ser, uma disciplina regular.
		// Caso seja, composta, temos que gerar novas
		// matriculasPeriodoTurmaDisciplina, somentes para as disciplinas que
		// fazer parte da composicao

		if (novaMatriculaPeriodoTurmaDisciplina.getDisciplinaComposta()) {
			gerarEAdicionarMatriculaPeriodoTurmaDisciplinaVOParaDisciplinasComposicao(novaMatriculaPeriodoTurmaDisciplina, matriculaPeriodoVO, matriculaVO, usuario, null);
		}
		matriculaPeriodoVO.adicionarObjMatriculaPeriodoTurmaDisciplinaVOs(novaMatriculaPeriodoTurmaDisciplina);
		realizarSugestaoTurmaPraticaTeorica(matriculaPeriodoVO, matriculaVO.getCurso().getConfiguracaoAcademico(), horarioAlunoTurnoVOs, considerarVagaReposicao, usuario);
		getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().atualizarNrAlunosMatriculadosTurmaDisciplina(matriculaPeriodoVO, novaMatriculaPeriodoTurmaDisciplina, novaMatriculaPeriodoTurmaDisciplina.getDisciplina(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), true, considerarVagaReposicao);
		if(matricaPeriodoTurmaDisciplina.getDisciplinaFazParteComposicao()){
			if(Uteis.isAtributoPreenchido(novaMatriculaPeriodoTurmaDisciplina.getTurmaPratica().getCodigo())){
				matricaPeriodoTurmaDisciplina.getTurmaPratica().setNrVagas(novaMatriculaPeriodoTurmaDisciplina.getTurmaPratica().getNrVagas());
				matricaPeriodoTurmaDisciplina.getTurmaPratica().setNrMaximoMatricula(novaMatriculaPeriodoTurmaDisciplina.getTurmaPratica().getNrMaximoMatricula());
				matricaPeriodoTurmaDisciplina.setNrAlunosMatriculadosTurmaPratica(novaMatriculaPeriodoTurmaDisciplina.getNrAlunosMatriculadosTurmaPratica());
				matricaPeriodoTurmaDisciplina.setNrVagasDisponiveisTurmaPratica(novaMatriculaPeriodoTurmaDisciplina.getNrVagasDisponiveisTurmaPratica());
				matricaPeriodoTurmaDisciplina.setTurmaPratica(novaMatriculaPeriodoTurmaDisciplina.getTurmaPratica());
			}
			if(Uteis.isAtributoPreenchido(novaMatriculaPeriodoTurmaDisciplina.getTurmaTeorica().getCodigo())){    			
				matricaPeriodoTurmaDisciplina.getTurmaTeorica().setNrVagas(novaMatriculaPeriodoTurmaDisciplina.getTurmaTeorica().getNrVagas());
				matricaPeriodoTurmaDisciplina.getTurmaTeorica().setNrMaximoMatricula(novaMatriculaPeriodoTurmaDisciplina.getTurmaTeorica().getNrMaximoMatricula());
				matricaPeriodoTurmaDisciplina.setNrAlunosMatriculadosTurmaTeorica(novaMatriculaPeriodoTurmaDisciplina.getNrAlunosMatriculadosTurmaTeorica());
				matricaPeriodoTurmaDisciplina.setNrVagasDisponiveisTurmaTeorica(novaMatriculaPeriodoTurmaDisciplina.getNrVagasDisponiveisTurmaTeorica());
				matricaPeriodoTurmaDisciplina.setTurmaTeorica(novaMatriculaPeriodoTurmaDisciplina.getTurmaTeorica());
			}
			matricaPeriodoTurmaDisciplina.getTurma().setNrVagas(novaMatriculaPeriodoTurmaDisciplina.getTurma().getNrVagas());
			matricaPeriodoTurmaDisciplina.getTurma().setNrMaximoMatricula(novaMatriculaPeriodoTurmaDisciplina.getTurma().getNrMaximoMatricula());
			matricaPeriodoTurmaDisciplina.setNrAlunosMatriculados(novaMatriculaPeriodoTurmaDisciplina.getNrAlunosMatriculados());
			matricaPeriodoTurmaDisciplina.setNrVagasDisponiveis(novaMatriculaPeriodoTurmaDisciplina.getNrVagasDisponiveis());
			realizarDefinicaoNumeroVagaDisciplinaCompostaComLimitacaoDisciplina(matriculaPeriodoVO, novaMatriculaPeriodoTurmaDisciplina);
		}
		atualizarNrDisciplinasIncluidasExcluidas(matriculaPeriodoVO, matriculaVO, usuario);
		verificarDisciplinaAdicionadaEqualizaAlgumaDisciplinaCursandoPorCorrespodenciaPendente(novaMatriculaPeriodoTurmaDisciplina, matriculaPeriodoVO, matriculaVO, usuario);
	}

	/**
	 * Método Responsável por validar se todas as
	 * matriculasPeriodoTurmaDisciplina possuem vagas disponiveis em suas
	 * respectivas turmas para realização desta matrícula.
	 * 
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @param usuario
	 * @throws Exception
	 */
	public void validarDisponibilidadeVagasMatriculaPeriodoTurmaDisciplina(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, Boolean considerarVagaReposicao, UsuarioVO usuario) throws Exception {
		if (!matriculaPeriodoVO.getExisteNovaMatriculaPeriodoTurmaDisciplina()) {
			// so todas as disciplinas estãoo sendo editadas, e nenhum nova
			// disciplina foi
			// informada. Entao nao ha vagas para serem controladas. Contudo, se
			// alguma
			// disciplina estão sendo incluida, então temos que verificar a
			// validação
			return;
		}
		StringBuilder msgErro = new StringBuilder();
		int contadorDisciplinasComProblemas = 0; // colocar no maximo trï¿½s
													// disicplinas na msg, senao
													// nao cabe na tela
		msgErro.append("Não possível confirmar esta Matrícula/renovação. Existem disciplinas adicionadas para esta matrícula/renovação que não possuem disponibilidade de vagas em suas respectivas turmas. Disciplinas que não possuem vagas disponíveis [");
		for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplina : matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()) {
			MatriculaPeriodoTurmaDisciplinaVO disciplinaMae =  null;
			if(matriculaPeriodoTurmaDisciplina.getDisciplinaFazParteComposicao()){
				disciplinaMae = getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().realizarObtencaoDisciplinaCompostaComBaseDisciplinaFilhaComposicao(matriculaPeriodoVO, matriculaPeriodoTurmaDisciplina);
			}
			if(!matriculaPeriodoTurmaDisciplina.getLiberadaSemDisponibilidadeVagas() && (matriculaPeriodoTurmaDisciplina.getCodigo().equals(0) 
					|| (!matriculaPeriodoTurmaDisciplina.getCodigo().equals(0) && matriculaPeriodoTurmaDisciplina.isAlterandoSubturmaPraticaTeorica()))
					&& (!matriculaPeriodoTurmaDisciplina.getDisciplinaFazParteComposicao()
							|| (matriculaPeriodoTurmaDisciplina.getDisciplinaFazParteComposicao()
							&& disciplinaMae != null && disciplinaMae.getGradeDisciplinaVO().getTipoControleComposicao().equals(TipoControleComposicaoEnum.ESTUDAR_QUANTIDADE_MAXIMA_COMPOSTA)))){
				getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().atualizarNrAlunosMatriculadosTurmaDisciplina(matriculaPeriodoVO, matriculaPeriodoTurmaDisciplina, matriculaPeriodoTurmaDisciplina.getDisciplina(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), true, considerarVagaReposicao);
			}
			if ((!matriculaPeriodoTurmaDisciplina.getDisciplinaFazParteComposicao() || (matriculaPeriodoTurmaDisciplina.getDisciplinaFazParteComposicao()
					&& disciplinaMae != null && disciplinaMae.getGradeDisciplinaVO().getTipoControleComposicao().equals(TipoControleComposicaoEnum.ESTUDAR_QUANTIDADE_MAXIMA_COMPOSTA))) 
					&& matriculaPeriodoTurmaDisciplina.getPossuiRestricaoComRelacaoDisponibilidadeVaga()) {
				if (contadorDisciplinasComProblemas <= 3) {
					if (contadorDisciplinasComProblemas >= 1) {
						msgErro.append(", ");
					}
					msgErro.append(matriculaPeriodoTurmaDisciplina.getDisciplina().getNome());
				}
				contadorDisciplinasComProblemas++;
			}
		}
		msgErro.append("].");
		if (contadorDisciplinasComProblemas > 0) {
			throw new Exception(msgErro.toString());
		}
	}

	public void removerMatriculaPeriodoTurmaDisciplinaQueFoiRemovidaTemporariamente(DisciplinaVO disciplinaVO, TurmaVO turmaVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinaRemovidaTemporariamenteVOs) {
		int index = 0;
		for (Iterator iterator = listaMatriculaPeriodoTurmaDisciplinaRemovidaTemporariamenteVOs.iterator(); iterator.hasNext();) {
			MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO = (MatriculaPeriodoTurmaDisciplinaVO) iterator.next();
			if (matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo().equals(disciplinaVO.getCodigo()) && matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo().equals(turmaVO.getCodigo())) {
				listaMatriculaPeriodoTurmaDisciplinaRemovidaTemporariamenteVOs.remove(index);
				return;
			}
			index++;
		}
	}

	/***
	 * Método Responsável por eliminar os horarioturmadiaitem e horarioturma dia
	 * que nao possuem aula
	 * 
	 * @param horarioTurmaOficial
	 * @param matriculaPeriodoVO
	 */
	// public void
	// executarEliminarHorarioTurmaDiaDeDiasNaoPossuemAula(HorarioTurmaVO
	// horarioTurmaOficial, MatriculaPeriodoVO matriculaPeriodoVO){
	// // Horarios da turma oficial incluindos os horarios de disciplinas que
	// esse aluno nao possui aula, nos quais irei excluir
	// for (int iTurma1 = 0; iTurma1 <
	// horarioTurmaOficial.getHorarioTurmaDiaVOs().size(); iTurma1++) {
	// int countDisciplinas = 0;
	// for (int iTurma2 = 0; iTurma2 <
	// matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().size();
	// iTurma2++) {
	// for (int jTurma1 = 0; jTurma1 <
	// horarioTurmaOficial.getHorarioTurmaDiaVOs().get(iTurma1).getHorarioTurmaDiaItemVOs().size();
	// jTurma1++) {
	//
	//
	// int codigoDisciplinaDaTurmaOficial =
	// horarioTurmaOficial.getHorarioTurmaDiaVOs().get(iTurma2).getCodigoDisciplina(horarioTurmaOficial.getHorarioTurmaDiaVOs().get(iTurma2).getHorarioTurmaDiaItemVOs().get(jTurma1).getNrAula());
	// int codigoTurmaOficial =
	// horarioTurmaOficial.getTurma().getCodigo().intValue();
	// if ((codigoDisciplinaDaTurmaOficial ==
	// matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().get(iTurma2).getDisciplina().getCodigo().intValue())
	// && (codigoTurmaOficial ==
	// (matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().get(iTurma2).getTurma().getCodigo().intValue())))
	// {
	// countDisciplinas++;
	// }
	// }
	// }
	// if (countDisciplinas == 0) {
	// horarioTurmaOficial.getHorarioTurmaDiaVOs().get(iTurma1).getHorarioTurmaDiaItemVOs().remove(jTurma1);
	// }
	// }
	// }
	/***
	 * verifico se a aula (ou seja disciplina na turma ) ï¿½ uma disciplina que
	 * o aluno possui aula ( ou seja, se estão na grade das disciplinas que ele
	 * irá fazer)
	 * 
	 * @param matriculaPeriodoComAsDisciplinasQueAlunoCursa
	 * @param disciplinaASerVerificada
	 * @param turmaASerVerificada
	 * @return
	 */
	public boolean executarVerificarSeAlunoCursaDisciplina(MatriculaPeriodoVO matriculaPeriodoComAsDisciplinasQueAlunoCursa, DisciplinaVO disciplinaASerVerificada, TurmaVO turmaASerVerificada) {

		for (MatriculaPeriodoTurmaDisciplinaVO mtpd : matriculaPeriodoComAsDisciplinasQueAlunoCursa.getMatriculaPeriodoTumaDisciplinaVOs()) {
			if (mtpd.getTurma().getCodigo().intValue() == turmaASerVerificada.getCodigo().intValue()) {
				if (mtpd.getDisciplina().getCodigo().intValue() == disciplinaASerVerificada.getCodigo().intValue()) {
					return true;
				}
			}
		}
		return false;
	}

	/**
	 * Criado para manter compatibilidade com Método oficial abaixo.
	 * 
	 * @param matriculaPeriodo
	 * @param turmaInclusao
	 * @param disciplinaInclusao
	 * @param usuario
	 * @throws Exception
	 */
	public void executarVerificarSeHaIncompatibilidadeHorarioDeDisciplinas(MatriculaPeriodoVO matriculaPeriodo, TurmaVO turmaInclusao, DisciplinaVO disciplinaInclusao, List<HorarioAlunoTurnoVO> horarioAlunoTurnoVOs, Boolean validarChoqueHorarioOutraMatricula,  UsuarioVO usuario) throws Exception {
		MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO = new MatriculaPeriodoTurmaDisciplinaVO();
		if (turmaInclusao.getSubturma() && turmaInclusao.getTipoSubTurma().equals(TipoSubTurmaEnum.PRATICA)) {
			matriculaPeriodoTurmaDisciplinaVO.setTurmaPratica(turmaInclusao);
		} else if (turmaInclusao.getSubturma() && turmaInclusao.getTipoSubTurma().equals(TipoSubTurmaEnum.TEORICA)) {
			matriculaPeriodoTurmaDisciplinaVO.setTurmaTeorica(turmaInclusao);
		} else {
			matriculaPeriodoTurmaDisciplinaVO.setTurma(turmaInclusao);
		}
		matriculaPeriodoTurmaDisciplinaVO.setDisciplina(disciplinaInclusao);
		executarVerificarSeHaIncompatibilidadeHorarioDeDisciplinas(matriculaPeriodo, matriculaPeriodoTurmaDisciplinaVO, horarioAlunoTurnoVOs,  validarChoqueHorarioOutraMatricula, usuario);
	}

	/***
	 * Verifica se na programacao de aula existe algum horário de aula de outra
	 * disciplina ï¿½ o mesmo horário da disciplina a ser incluída para o aluno.
	 * 
	 * @param matriculaPeriodo
	 * @param turmaInclusao
	 * @param disciplinaInclusao
	 * @throws Exception
	 * 
	 */
	@Override
	public void executarVerificarSeHaIncompatibilidadeHorarioDeDisciplinas(MatriculaPeriodoVO matriculaPeriodo, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO, List<HorarioAlunoTurnoVO> horarioAlunoTurnoVOs, Boolean validarChoqueHorarioOutraMatricula, UsuarioVO usuario) throws Exception {
		try {
			List<MatriculaPeriodoTurmaDisciplinaVO> matriculaPeriodoTurmaDisciplinaVOs = new ArrayList<MatriculaPeriodoTurmaDisciplinaVO>(0);
			matriculaPeriodoTurmaDisciplinaVOs.addAll(matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs());
			int index = 0;
			for(MatriculaPeriodoTurmaDisciplinaVO mp: matriculaPeriodoTurmaDisciplinaVOs){
				if(mp.getDisciplina().getCodigo().equals(matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo())){
					matriculaPeriodoTurmaDisciplinaVOs.remove(index);					
					break;
				}
				index++;
			}
			if (matriculaPeriodoTurmaDisciplinaVO.getDisciplinaPorEquivalencia()) {
				getFacadeFactory().getHorarioAlunoFacade().realizarVerificaoChoqueHorarioPorMatriculaPeriodoTurmaDisciplinaVOs(matriculaPeriodo, horarioAlunoTurnoVOs, matriculaPeriodoTurmaDisciplinaVOs, matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getMapaEquivalenciaDisciplinaCursada().getDisciplinaVO().getCodigo(), usuario, true, validarChoqueHorarioOutraMatricula);
			} else {
				getFacadeFactory().getHorarioAlunoFacade().realizarVerificaoChoqueHorarioPorMatriculaPeriodoTurmaDisciplinaVOs(matriculaPeriodo, horarioAlunoTurnoVOs, matriculaPeriodoTurmaDisciplinaVOs, matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getTurmaPratica().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getTurmaTeorica().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo(), usuario, true, validarChoqueHorarioOutraMatricula);
			}
		} catch (Exception e) {
			if (e instanceof ConsistirException && ((ConsistirException) e).getReferenteChoqueHorario()) {
				matriculaPeriodoTurmaDisciplinaVO.setDescricaoChoqueHorarioDisciplina(e.getMessage());
			}
			throw e;
		}

		// List<HorarioTurmaVO> horarioTurmaOficial =
		// getFacadeFactory().getHorarioTurmaFacade().consultarPorIdentificadorTurmaTurmaMontagemCompleta(matriculaPeriodo.getTurma().getIdentificadorTurma(),
		// matriculaPeriodo.getTurma().getUnidadeEnsino().getCodigo(),
		// matriculaPeriodo.getSemestre(), matriculaPeriodo.getAno(), false,
		// Uteis.NIVELMONTARDADOS_TODOS);
		// DisciplinaVO disciplinaInclusao =
		// matriculaPeriodoTurmaDisciplinaVO.getDisciplina();
		// TurmaVO turmaInclusao = matriculaPeriodoTurmaDisciplinaVO.getTurma();
		// List<HorarioTurmaVO> horarioTurmaDisciplinaASerIncluida =
		// getFacadeFactory().getHorarioTurmaFacade().consultarPorTurmaDisciplinaAnoSemestre(turmaInclusao.getCodigo(),
		// disciplinaInclusao.getCodigo(), matriculaPeriodo.getAno(),
		// matriculaPeriodo.getSemestre(), Uteis.NIVELMONTARDADOS_TODOS,
		// usuario);
		//
		// List<HorarioTurmaVO> listaHorarioTurmaOficial = new
		// ArrayList<HorarioTurmaVO>(0);
		// Set<Integer> listaTurmasJaBuscouHorarioTurma = new
		// HashSet<Integer>(0);
		//
		// // Pegando os horarioturma da de cada disciplina da grade atual
		// for (MatriculaPeriodoTurmaDisciplinaVO disciplinaDaGradeAlunoCursa :
		// matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs()) {
		// if
		// (!listaTurmasJaBuscouHorarioTurma.contains(disciplinaDaGradeAlunoCursa.getTurma().getCodigo().intValue()))
		// {
		// List<HorarioTurmaVO> horarioTurmaDisciplinaAlunoCursa =
		// getFacadeFactory().getHorarioTurmaFacade().consultarPorTurmaDisciplinaAnoSemestre(disciplinaDaGradeAlunoCursa.getTurma().getCodigo(),
		// disciplinaDaGradeAlunoCursa.getDisciplina().getCodigo(),
		// matriculaPeriodo.getAno(), matriculaPeriodo.getSemestre(),
		// Uteis.NIVELMONTARDADOS_TODOS, usuario);
		// if (!horarioTurmaDisciplinaAlunoCursa.isEmpty()) {
		// listaTurmasJaBuscouHorarioTurma.add(disciplinaDaGradeAlunoCursa.getTurma().getCodigo().intValue());
		// listaHorarioTurmaOficial.addAll(horarioTurmaDisciplinaAlunoCursa);
		// }
		// }
		// }
		//
		// // Percorrer a lista dos horarios da turma q ele deseja adicionar
		// for (HorarioTurmaVO htDisciplinaASerIncluida :
		// horarioTurmaDisciplinaASerIncluida) {
		// // percorro os dias da aula da disciplina que a pessoa quer incluir
		// for (HorarioTurmaDiaVO htDiaDisciplinaASerIncluidaVO :
		// htDisciplinaASerIncluida.getHorarioTurmaDiaVOs()) {
		// // percorro as aulas que a pessoa quer incluir
		// for (HorarioTurmaDiaItemVO htItemDisciplinaASerIncluidaVO :
		// htDiaDisciplinaASerIncluidaVO.getHorarioTurmaDiaItemVOs()) {
		// // verifico se a aula ï¿½ da disciplina que a pessoa quer
		// // incluir
		// if
		// (htItemDisciplinaASerIncluidaVO.getDisciplinaVO().getCodigo().intValue()
		// == disciplinaInclusao.getCodigo().intValue()) {
		// // percorro os horarios das turmas que o aluno cursa
		// for (HorarioTurmaVO horarioTurmaDaGrade : listaHorarioTurmaOficial) {
		// // percorro os dias de cada disciplina que a pessoa
		// // tem aula
		// for (HorarioTurmaDiaVO horarioTurmaDiaGrade :
		// horarioTurmaDaGrade.getHorarioTurmaDiaVOs()) {
		//
		// int horaInicioDisciplinaASerIncluida = 0;
		// int horaFinalDisciplinaASerIncluida = 0;
		// int horaInicioDisciplinaTurma = 0;
		// int horaFinalDisciplinaTurma = 0;
		// // percorro as aulas que a turma possui
		// for (HorarioTurmaDiaItemVO horarioTurmaDiaItemGrade :
		// horarioTurmaDiaGrade.getHorarioTurmaDiaItemVOs()) {
		// // verifico se a aula corrente ï¿½ da
		// // disciplina que o aluno tem aula
		// if (executarVerificarSeAlunoCursaDisciplina(matriculaPeriodo,
		// horarioTurmaDiaItemGrade.getDisciplinaVO(),
		// horarioTurmaDaGrade.getTurma())) {
		// // verifico se o dia da aula da
		// // disciplina que eu vou incluir ï¿½ o
		// // mesmo da turma que ele cursa
		// if
		// (htDiaDisciplinaASerIncluidaVO.getData().compareTo(horarioTurmaDiaGrade.getData())
		// == 0) {
		// if
		// (htDisciplinaASerIncluida.getTurno().getCodigo().equals(horarioTurmaDaGrade.getTurno().getCodigo()))
		// {
		// if
		// (htItemDisciplinaASerIncluidaVO.getNrAula().equals(horarioTurmaDiaItemGrade.getNrAula()))
		// {
		// DisciplinaVO disciplina1 =
		// getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(horarioTurmaDiaItemGrade.getDisciplinaVO().getCodigo(),
		// Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		// DisciplinaVO disciplina2 =
		// getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(htItemDisciplinaASerIncluidaVO.getDisciplinaVO().getCodigo(),
		// Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		//
		// String msgErro = " O horário da disciplina '" + disciplina1.getNome()
		// + "' ï¿½ o mesmo horário da disciplina '" + disciplina2.getNome() +
		// "' na turma '" + turmaInclusao.getIdentificadorTurma() + "'. ";
		// ConsistirException horarioException = new
		// ConsistirException(msgErro);
		// matriculaPeriodoTurmaDisciplinaVO.setDescricaoChoqueHorarioDisciplina(msgErro);
		// horarioException.setReferenteChoqueHorario(Boolean.TRUE);
		// throw horarioException;
		// }
		// } else {
		// if (horarioTurmaDaGrade.getTurno().getIsHorarioFixo()) {
		// if (horarioTurmaDiaItemGrade.getNrAula() == 1) {
		// horaInicioDisciplinaTurma =
		// (Uteis.getHoraDaString(horarioTurmaDaGrade.getTurno().getHoraInicio())
		// * 60) +
		// Uteis.getMinutosDaString(horarioTurmaDaGrade.getTurno().getHoraInicio());
		// horaFinalDisciplinaTurma = horaInicioDisciplinaTurma +
		// horarioTurmaDaGrade.getTurno().getDuracaoAula();
		// } else {
		// horaInicioDisciplinaTurma =
		// ((Uteis.getHoraDaString(horarioTurmaDaGrade.getTurno().getHoraInicio())
		// * 60) +
		// (Uteis.getMinutosDaString(horarioTurmaDaGrade.getTurno().getHoraInicio())))
		// + (horarioTurmaDaGrade.getTurno().getDuracaoAula() *
		// (horarioTurmaDiaItemGrade.getNrAula() - 1));
		// if (horaInicioDisciplinaTurma ==
		// ((Uteis.getHoraDaString(horarioTurmaDaGrade.getTurno().getInicioIntervalo())
		// * 60) +
		// Uteis.getMinutosDaString(horarioTurmaDaGrade.getTurno().getInicioIntervalo())))
		// {
		// horaInicioDisciplinaTurma = horaInicioDisciplinaTurma +
		// horarioTurmaDaGrade.getTurno().getDuracaoIntervalo();
		// }
		// horaFinalDisciplinaTurma = horaInicioDisciplinaTurma +
		// horarioTurmaDaGrade.getTurno().getDuracaoAula();
		// }
		// } else {
		// DiaSemana diaSemana =
		// Uteis.getDiaSemanaEnum(htDiaDisciplinaASerIncluidaVO.getData());
		// switch (diaSemana) {
		// case SEGUNGA:
		// for (TurnoHorarioVO horarioSegunda :
		// horarioTurmaDaGrade.getTurno().getTurnoHorarioSegunda()) {
		// if
		// (horarioTurmaDiaItemGrade.getNrAula().equals(horarioSegunda.getNumeroAula()))
		// {
		// horaInicioDisciplinaTurma =
		// (((Uteis.getHoraDaString(horarioSegunda.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioSegunda.getHorarioInicioAula())));
		// horaFinalDisciplinaTurma =
		// (Uteis.getHoraDaString(horarioSegunda.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioSegunda.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case TERCA:
		// for (TurnoHorarioVO horarioTerca :
		// horarioTurmaDaGrade.getTurno().getTurnoHorarioTerca()) {
		//
		// if
		// (horarioTurmaDiaItemGrade.getNrAula().equals(horarioTerca.getNumeroAula()))
		// {
		// horaInicioDisciplinaTurma =
		// (((Uteis.getHoraDaString(horarioTerca.getHorarioInicioAula()) * 60) +
		// Uteis.getMinutosDaString(horarioTerca.getHorarioInicioAula())));
		// horaFinalDisciplinaTurma =
		// (Uteis.getHoraDaString(horarioTerca.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioTerca.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case QUARTA:
		// for (TurnoHorarioVO horarioQuarta :
		// horarioTurmaDaGrade.getTurno().getTurnoHorarioQuarta()) {
		// if
		// (horarioTurmaDiaItemGrade.getNrAula().equals(horarioQuarta.getNumeroAula()))
		// {
		// horaInicioDisciplinaTurma =
		// (((Uteis.getHoraDaString(horarioQuarta.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioQuarta.getHorarioInicioAula())));
		// horaFinalDisciplinaTurma =
		// (Uteis.getHoraDaString(horarioQuarta.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioQuarta.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case QUINTA:
		// for (TurnoHorarioVO horarioQuinta :
		// horarioTurmaDaGrade.getTurno().getTurnoHorarioQuinta()) {
		// if
		// (horarioTurmaDiaItemGrade.getNrAula().equals(horarioQuinta.getNumeroAula()))
		// {
		// horaInicioDisciplinaTurma =
		// (((Uteis.getHoraDaString(horarioQuinta.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioQuinta.getHorarioInicioAula())));
		// horaFinalDisciplinaTurma =
		// (Uteis.getHoraDaString(horarioQuinta.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioQuinta.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case SEXTA:
		// for (TurnoHorarioVO horarioSextat :
		// horarioTurmaDaGrade.getTurno().getTurnoHorarioSexta()) {
		// if
		// (horarioTurmaDiaItemGrade.getNrAula().equals(horarioSextat.getNumeroAula()))
		// {
		// horaInicioDisciplinaTurma =
		// (((Uteis.getHoraDaString(horarioSextat.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioSextat.getHorarioInicioAula())));
		// horaFinalDisciplinaTurma =
		// (Uteis.getHoraDaString(horarioSextat.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioSextat.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case SABADO:
		// for (TurnoHorarioVO horarioSabado :
		// horarioTurmaDaGrade.getTurno().getTurnoHorarioSabado()) {
		// if
		// (horarioTurmaDiaItemGrade.getNrAula().equals(horarioSabado.getNumeroAula()))
		// {
		// horaInicioDisciplinaTurma =
		// (((Uteis.getHoraDaString(horarioSabado.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioSabado.getHorarioInicioAula())));
		// horaFinalDisciplinaTurma =
		// (Uteis.getHoraDaString(horarioSabado.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioSabado.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case DOMINGO:
		// for (TurnoHorarioVO horarioDomingo :
		// horarioTurmaDaGrade.getTurno().getTurnoHorarioDomingo()) {
		// if
		// (horarioTurmaDiaItemGrade.getNrAula().equals(horarioDomingo.getNumeroAula()))
		// {
		// horaInicioDisciplinaTurma =
		// (((Uteis.getHoraDaString(horarioDomingo.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioDomingo.getHorarioInicioAula())));
		// horaFinalDisciplinaTurma =
		// (Uteis.getHoraDaString(horarioDomingo.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioDomingo.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// default:
		// break;
		// }
		// }
		// if (htDisciplinaASerIncluida.getTurno().getIsHorarioFixo()) {
		// // Verificando o horario de
		// // aula
		// // da pessoa
		// if (htItemDisciplinaASerIncluidaVO.getNrAula() == 1) {
		// horaInicioDisciplinaASerIncluida =
		// (Uteis.getHoraDaString(htDisciplinaASerIncluida.getTurno().getHoraInicio())
		// * 60) +
		// Uteis.getMinutosDaString(htDisciplinaASerIncluida.getTurno().getHoraInicio());
		// horaFinalDisciplinaASerIncluida = horaInicioDisciplinaASerIncluida +
		// htDisciplinaASerIncluida.getTurno().getDuracaoAula();
		// } else {
		// horaInicioDisciplinaASerIncluida =
		// (((Uteis.getHoraDaString(htDisciplinaASerIncluida.getTurno().getHoraInicio())
		// * 60) +
		// Uteis.getMinutosDaString(htDisciplinaASerIncluida.getTurno().getHoraInicio()))
		// + (htDisciplinaASerIncluida.getTurno().getDuracaoAula() *
		// (htItemDisciplinaASerIncluidaVO.getNrAula() - 1)));
		// if (horaInicioDisciplinaASerIncluida ==
		// ((Uteis.getHoraDaString(htDisciplinaASerIncluida.getTurno().getInicioIntervalo())
		// * 60) +
		// Uteis.getMinutosDaString(htDisciplinaASerIncluida.getTurno().getInicioIntervalo())))
		// {
		// horaInicioDisciplinaASerIncluida = horaInicioDisciplinaASerIncluida +
		// htDisciplinaASerIncluida.getTurno().getDuracaoIntervalo();
		// }
		// horaFinalDisciplinaASerIncluida = horaInicioDisciplinaASerIncluida +
		// htDisciplinaASerIncluida.getTurno().getDuracaoAula();
		// }
		// } else {
		// DiaSemana diaSemana =
		// Uteis.getDiaSemanaEnum(htDiaDisciplinaASerIncluidaVO.getData());
		// switch (diaSemana) {
		// case SEGUNGA:
		// for (TurnoHorarioVO horarioSegunda :
		// htDisciplinaASerIncluida.getTurno().getTurnoHorarioSegunda()) {
		// if
		// (htItemDisciplinaASerIncluidaVO.getNrAula().equals(horarioSegunda.getNumeroAula()))
		// {
		// horaInicioDisciplinaASerIncluida =
		// (((Uteis.getHoraDaString(horarioSegunda.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioSegunda.getHorarioInicioAula())));
		// horaFinalDisciplinaASerIncluida =
		// (Uteis.getHoraDaString(horarioSegunda.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioSegunda.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case TERCA:
		// for (TurnoHorarioVO horarioTerca :
		// htDisciplinaASerIncluida.getTurno().getTurnoHorarioTerca()) {
		// if
		// (htItemDisciplinaASerIncluidaVO.getNrAula().equals(horarioTerca.getNumeroAula()))
		// {
		// horaInicioDisciplinaASerIncluida =
		// (((Uteis.getHoraDaString(horarioTerca.getHorarioInicioAula()) * 60) +
		// Uteis.getMinutosDaString(horarioTerca.getHorarioInicioAula())));
		// horaFinalDisciplinaASerIncluida =
		// (Uteis.getHoraDaString(horarioTerca.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioTerca.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case QUARTA:
		// for (TurnoHorarioVO horarioQuarta :
		// htDisciplinaASerIncluida.getTurno().getTurnoHorarioQuarta()) {
		// if
		// (htItemDisciplinaASerIncluidaVO.getNrAula().equals(horarioQuarta.getNumeroAula()))
		// {
		// horaInicioDisciplinaASerIncluida =
		// (((Uteis.getHoraDaString(horarioQuarta.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioQuarta.getHorarioInicioAula())));
		// horaFinalDisciplinaASerIncluida =
		// (Uteis.getHoraDaString(horarioQuarta.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioQuarta.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case QUINTA:
		// for (TurnoHorarioVO horarioQuinta :
		// htDisciplinaASerIncluida.getTurno().getTurnoHorarioQuinta()) {
		// if
		// (htItemDisciplinaASerIncluidaVO.getNrAula().equals(horarioQuinta.getNumeroAula()))
		// {
		// horaInicioDisciplinaASerIncluida =
		// (((Uteis.getHoraDaString(horarioQuinta.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioQuinta.getHorarioInicioAula())));
		// horaFinalDisciplinaASerIncluida =
		// (Uteis.getHoraDaString(horarioQuinta.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioQuinta.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case SEXTA:
		// for (TurnoHorarioVO horarioSextat :
		// htDisciplinaASerIncluida.getTurno().getTurnoHorarioSexta()) {
		// if
		// (htItemDisciplinaASerIncluidaVO.getNrAula().equals(horarioSextat.getNumeroAula()))
		// {
		// horaInicioDisciplinaASerIncluida =
		// (((Uteis.getHoraDaString(horarioSextat.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioSextat.getHorarioInicioAula())));
		// horaFinalDisciplinaASerIncluida =
		// (Uteis.getHoraDaString(horarioSextat.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioSextat.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case SABADO:
		// for (TurnoHorarioVO horarioSabado :
		// htDisciplinaASerIncluida.getTurno().getTurnoHorarioSabado()) {
		// if
		// (htItemDisciplinaASerIncluidaVO.getNrAula().equals(horarioSabado.getNumeroAula()))
		// {
		// horaInicioDisciplinaASerIncluida =
		// (((Uteis.getHoraDaString(horarioSabado.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioSabado.getHorarioInicioAula())));
		// horaFinalDisciplinaASerIncluida =
		// (Uteis.getHoraDaString(horarioSabado.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioSabado.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		// case DOMINGO:
		// for (TurnoHorarioVO horarioDomingo :
		// htDisciplinaASerIncluida.getTurno().getTurnoHorarioDomingo()) {
		// if
		// (htItemDisciplinaASerIncluidaVO.getNrAula().equals(horarioDomingo.getNumeroAula()))
		// {
		// horaInicioDisciplinaASerIncluida =
		// (((Uteis.getHoraDaString(horarioDomingo.getHorarioInicioAula()) * 60)
		// + Uteis.getMinutosDaString(horarioDomingo.getHorarioInicioAula())));
		// horaFinalDisciplinaASerIncluida =
		// (Uteis.getHoraDaString(horarioDomingo.getHorarioFinalAula()) * 60) +
		// Uteis.getMinutosDaString(horarioDomingo.getHorarioFinalAula());
		// break;
		// }
		// }
		// break;
		//
		// default:
		// break;
		// }
		//
		// }
		// try {
		// validarDadosChoqueDisciplina(horaInicioDisciplinaASerIncluida,
		// horaInicioDisciplinaTurma, horaFinalDisciplinaTurma,
		// horaFinalDisciplinaASerIncluida, horarioTurmaDiaItemGrade,
		// htItemDisciplinaASerIncluidaVO, turmaInclusao, usuario);
		// } catch (Exception e) {
		// matriculaPeriodoTurmaDisciplinaVO.setDescricaoChoqueHorarioDisciplina(e.getMessage());
		// throw e;
		// }
		// }
		// }
		// }
		// }
		// }
		// }
		// }
		// }
		// }
		// }
		// // Limpando da memï¿½ria
		// horarioTurmaDisciplinaASerIncluida = null;
		// listaHorarioTurmaOficial = null;
		// listaTurmasJaBuscouHorarioTurma = null;
	}

	public void validarDadosChoqueDisciplina(int horaInicioDisciplinaASerIncluida, int horaInicioDisciplinaTurma, int horaFinalDisciplinaTurma, int horaFinalDisciplinaASerIncluida, HorarioTurmaDiaItemVO horarioTurmaDiaItemGrade, HorarioTurmaDiaItemVO htItemDisciplinaASerIncluidaVO, TurmaVO turmaInclusao, UsuarioVO usuario) throws Exception {
		if (horaInicioDisciplinaASerIncluida == horaInicioDisciplinaTurma) {
			DisciplinaVO disciplina1 = getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(horarioTurmaDiaItemGrade.getDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			DisciplinaVO disciplina2 = getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(htItemDisciplinaASerIncluidaVO.getDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			String msgErro = " O horário da disciplina '" + disciplina1.getNome() + "' é o mesmo horário da disciplina '" + disciplina2.getNome() + "' na turma '" + turmaInclusao.getIdentificadorTurma() + "' ";
			ConsistirException horarioException = new ConsistirException(msgErro);
			horarioException.setReferenteChoqueHorario(Boolean.TRUE);
			throw horarioException;
		} else {
			if ((horaInicioDisciplinaASerIncluida > horaInicioDisciplinaTurma) && (horaInicioDisciplinaASerIncluida < horaFinalDisciplinaTurma)) {
				DisciplinaVO disciplina1 = getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(horarioTurmaDiaItemGrade.getDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				DisciplinaVO disciplina2 = getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(htItemDisciplinaASerIncluidaVO.getDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				String msgErro = " O horário da disciplina '" + disciplina1.getNome() + "' é o mesmo horário da disciplina '" + disciplina2.getNome() + "' na turma '" + turmaInclusao.getIdentificadorTurma() + "' ";
				ConsistirException horarioException = new ConsistirException(msgErro);
				horarioException.setReferenteChoqueHorario(Boolean.TRUE);
				throw horarioException;
			} else {
				if ((horaInicioDisciplinaTurma > horaInicioDisciplinaASerIncluida) && (horaInicioDisciplinaTurma < horaFinalDisciplinaASerIncluida)) {
					DisciplinaVO disciplina1 = getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(horarioTurmaDiaItemGrade.getDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
					DisciplinaVO disciplina2 = getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(htItemDisciplinaASerIncluidaVO.getDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
					String msgErro = " O horário da disciplina '" + disciplina1.getNome() + "' é o mesmo horário da disciplina '" + disciplina2.getNome() + "' na turma '" + turmaInclusao.getIdentificadorTurma() + "' ";
					ConsistirException horarioException = new ConsistirException(msgErro);
					horarioException.setReferenteChoqueHorario(Boolean.TRUE);
					throw horarioException;
				} else {
					if ((horaFinalDisciplinaASerIncluida > horaInicioDisciplinaTurma) && (horaFinalDisciplinaASerIncluida < horaFinalDisciplinaTurma)) {
						DisciplinaVO disciplina1 = getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(horarioTurmaDiaItemGrade.getDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
						DisciplinaVO disciplina2 = getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(htItemDisciplinaASerIncluidaVO.getDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
						String msgErro = " O horário da disciplina '" + disciplina1.getNome() + "' é o mesmo horário da disciplina '" + disciplina2.getNome() + "' na turma '" + turmaInclusao.getIdentificadorTurma() + "' ";
						ConsistirException horarioException = new ConsistirException(msgErro);
						horarioException.setReferenteChoqueHorario(Boolean.TRUE);
						throw horarioException;
					} else {
						if ((horaFinalDisciplinaTurma > horaInicioDisciplinaASerIncluida) && (horaFinalDisciplinaTurma < horaFinalDisciplinaASerIncluida)) {
							DisciplinaVO disciplina1 = getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(horarioTurmaDiaItemGrade.getDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
							DisciplinaVO disciplina2 = getFacadeFactory().getDisciplinaFacade().consultarPorChavePrimaria(htItemDisciplinaASerIncluidaVO.getDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
							String msgErro = " O horário da disciplina '" + disciplina1.getNome() + "' é o mesmo horário da disciplina '" + disciplina2.getNome() + "' na turma '" + turmaInclusao.getIdentificadorTurma() + "' ";
							ConsistirException horarioException = new ConsistirException(msgErro);
							horarioException.setReferenteChoqueHorario(Boolean.TRUE);
							throw horarioException;
						}
					}
				}
			}
		}
	}

	/**
	 * Este Método basicamente gera uma lista de objetos
	 * MatriculaPeriodoTurmaDisciplina que um aluno deveria cursar como Padrão,
	 * independente dele já ter cursado X disciplinas. A mesma ï¿½ utilizada
	 * para definir quais disciplinas um aluno ideal teria que cursar ou para se
	 * calcular o valor Padrão que um aluno teria que pagar, sem considerar
	 * nenhum tipo de disciplina incluída, excluï¿½da ou já cursada. Basicamente
	 * o que ela fez e gerar esta lista com base nas disciplinas que estãoo
	 * programadas para a turma de referencia da matrícula.
	 * 
	 * @param matriculaPeriodo
	 * @return
	 * @throws Exception
	 */
	public List<MatriculaPeriodoTurmaDisciplinaVO> obterListaMatriculaPeriodoTurmaDisciplinaVOPeriodoLetivoTurmaIndependenteAluno(MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matricula, UsuarioVO usuario) throws Exception {
		montarDadosTurma(matriculaPeriodo, NivelMontarDados.TODOS, usuario);
		List<MatriculaPeriodoTurmaDisciplinaVO> listaResultado = new ArrayList<MatriculaPeriodoTurmaDisciplinaVO>(0);

		// PROCESSANDO LISTA DE DISCIPLINAS PADROES DA TURMA (DO PERIODO LETIVO
		// DA TURMA)
		List<TurmaDisciplinaVO> disciplinasTurma = matriculaPeriodo.getTurma().getTurmaDisciplinaVOs();
		Iterator i = disciplinasTurma.iterator();
		while (i.hasNext()) {
			TurmaDisciplinaVO obj = (TurmaDisciplinaVO) i.next();
			inicializarDadosAnoSemestreMatricula(matriculaPeriodo, matriculaPeriodo.getProcessoMatriculaCalendarioVO(), false);
			MatriculaPeriodoTurmaDisciplinaVO novoObj = gerarMatriculaPeriodoTurmaDisciplinaVOValidado(obj.getGradeDisciplinaVO(), false, // indica
					// se
					// a
					// disciplina
					// será
					// cursada
					// por
					// meio
					// de
					// um
					// mapa
					// de
					// equivalencia
					null, // indica a qual mapa de equivalencia de disciplina
					// estão sendo criado o objeto
					null, // indica a qual disciplina do mapa de equivalencia o
					// aluno irá cursar nesta
					// MatriculaPeriodoTurmaDisciplina
					obj.getDisciplinaReferenteAUmGrupoOptativa(), obj.getGradeCurricularGrupoOptativaDisciplinaVO(), false, false, // por
					// default
					// geramos
					// a
					// MatriculaPeriodoTurmaDisciplina
					// para
					// a
					// disciplina
					// principal
					// da
					// composicao.
					// Logo
					// abaixo,
					// iremos
					// tratar
					// o
					// aspecto
					// da
					// composicao
					null, obj.getModalidadeDisciplina(), matriculaPeriodo, matricula, matriculaPeriodo.getTurma(), null, null, usuario);
			listaResultado.add(novoObj);
		}

		// PROCESSANDO LISTA DE DISCIPLINAS PROGRAMADAS PARA INCLUIR
		// AUTOMATICAMENTE NA TURMA (DO PERIODO LETIVO DA TURMA)
		List<TurmaDisciplinaInclusaoSugeridaVO> disciplinasSugeridasInclusaoTurma = getFacadeFactory().getTurmaDisciplinaInclusaoSugeridaInterfaceFacade().consultaRapidaPorTurma(matriculaPeriodo.getTurma().getCodigo(), usuario);
		matriculaPeriodo.getTurma().setTurmaDisciplinaInclusaoSugeridaVOs(disciplinasSugeridasInclusaoTurma);
		Iterator j = disciplinasSugeridasInclusaoTurma.iterator();
		while (j.hasNext()) {
			TurmaDisciplinaInclusaoSugeridaVO turmaInclusaoSugeridaVO = (TurmaDisciplinaInclusaoSugeridaVO) j.next();
			TurmaDisciplinaVO obj = getFacadeFactory().getTurmaDisciplinaFacade().consultarPorChavePrimaria(turmaInclusaoSugeridaVO.getTurmaDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			TurmaVO turmaIncluir = obj.getTurmaDescricaoVO();
			turmaIncluir.getTurmaDisciplinaVOs().add(obj);
			// como este obj (TurmaDisciplinaVO) pertence a turma que esta
			// setada no objeto
			// obj.getTurmaDescricaoVO(), entao vamos seta-lo na lista de
			// turmaDisciplina da mesma,
			// para que validacoes realizadas no metodo abaixo funcionem de
			// forma correta. Evitando
			// que todos as disciplinas desta turma sejam carregadas novamente.
			MatriculaPeriodoTurmaDisciplinaVO novoObj = gerarMatriculaPeriodoTurmaDisciplinaVOValidado(obj.getGradeDisciplinaVO(), false, // indica
					// se
					// a
					// disciplina
					// será
					// cursada
					// por
					// meio
					// de
					// um
					// mapa
					// de
					// equivalencia
					null, // indica a qual mapa de equivalencia de disciplina
					// estão sendo criado o objeto
					null, // indica a qual disciplina do mapa de equivalencia o
					// aluno irá cursar nesta
					// MatriculaPeriodoTurmaDisciplina
					obj.getDisciplinaReferenteAUmGrupoOptativa(), obj.getGradeCurricularGrupoOptativaDisciplinaVO(), false, // indica
					// que
					// o
					// aluno
					// foi
					// liberado
					// para
					// estudar
					// a
					// disciplina,
					// mesmo
					// com
					// choque
					// de
					// horário
					// com
					// outras
					// disciplinas
					// de
					// sua
					// turma
					false, // se a principal, trata-se de uma composicao, o
					// metodo que adiciona a
					// MatriculaPEriodoTurmaDisciplina irá tratar esta
					// situacao
					null, obj.getModalidadeDisciplina(), matriculaPeriodo, matricula, turmaIncluir, null, null, usuario);
			listaResultado.add(novoObj);
		}

		return listaResultado;
	}
	
	/**
	* Método utilizado quando o usuario está editando a matriculaPeriodo,
    * partindo da tela de transferencia de matriz, com objetivo de redefinir as matriculaPeriodoTurmaDisciplina
	* para eliminiar disciplinas que estejam sendo cursadas por correspodencia. Assim o mesmo, poderá
	* já lotar (colocar o aluno) na turma da nova matriz de imediato. Neste caso, nao iremos tentar inferir novas
	* disciplinas que o aluna possa estudar. Somente iremos, processar as matriculaPeriodoTurmaDisciplina que já 
	* existiam e vamos alterar as mesmas conforme os novos dados informados pelo usuário: NOVA MATRIZ (já definida na 
	* transferencia), NOVO TURNO (que pode ser modificado na tela de transferencia) e NOVA TURMA (informada na Aba Basico).
	 * @author Otimize - 4 de out de 2016 
	 * @param matriculaPeriodo
	 * @param matricula
	 * @param usuario
	 * @param gradeDisciplinaCompostaVOs
	 * @throws Exception
	 */	
	public void obterListaMatriculaPeriodoTurmaDisciplinaEliminandoCursandoPorCorrespondencia(MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matricula, UsuarioVO usuario, List<GradeDisciplinaCompostaVO> gradeDisciplinaCompostaVOs, Boolean considerarVagaReposicao) throws Exception {
		matriculaPeriodo.getTransferenciaMatrizCurricularMatriculaVO().getListaHistoricosAprovadosManterSemVinculoMatriculaPeriodoTurmaDiscipina().clear();
		int k = matriculaPeriodo.getTransferenciaMatrizCurricularMatriculaVO().getListaDisciplinasPorCorrespondencia().size() - 1;
		while (k >= 0) { 
			MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaAtual = matriculaPeriodo.getTransferenciaMatrizCurricularMatriculaVO().getListaDisciplinasPorCorrespondencia().get(k);
			Integer disciplinaManter = matriculaPeriodoTurmaDisciplinaAtual.getDisciplina().getCodigo();
			Integer cargaHorariaManter = matriculaPeriodoTurmaDisciplinaAtual.getCargaHoraria();
			
			// Primeiramente, vamos verificar se MatriculaPeriodoTurmaDisciplinaVO que pegamos já está com seu histórico (disciplina) aprovada. Neste caso,
			// este historico aprovado já foi aproveitado de alguma forma na transferencia de matriz curricular.
			// iremos adotar a estratégia de remover a MatriculaPeriodoTurmaDisciplinaVO e manter o histórico. Caso contrario teríamos dois problemas:
			// 1) os dados da MatriculaPeriodoTurmaDisciplinaVO ficariam inconsistentes pois sao de uma matriz curricular antiga, o que iria impactar em relatorios
			//    e outras ferramentas de gestao. Como o histórico está aprovado, teoricamente temos pouco chance do mesmo ter que ser modificado novamente.
			// 2) se ele fosse mantido, o usuário poderia alterá-lo de alguma forma implicando em modificação de uma nota já fechada.
	        HistoricoVO hist = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().verificarAlunoAprovadoDisciplina(disciplinaManter);
	        if (hist != null) {
	        	// se o aluno já está aprovado nesta disciplina, vamos adicionar o historico de aprovacao para lista que será processada no momento de persistir
	        	// a matriculaPeriodo do aluno.
	        	matriculaPeriodo.getTransferenciaMatrizCurricularMatriculaVO().getListaHistoricosAprovadosManterSemVinculoMatriculaPeriodoTurmaDiscipina().add(hist);
        		matriculaPeriodo.getTransferenciaMatrizCurricularMatriculaVO().getListaDisciplinasPorCorrespondencia().remove(k);
	        } else {
	        	if (matriculaPeriodoTurmaDisciplinaAtual.getDisciplinaForaGrade()) {
	        		// se trata-se de uma matriculaPeriodoTurmaDisciplinaAtual foraDaGrade, significa que o usuario poderá continuar cursando ela normalemente.
	        		// inclusive, pode ser uma caso de disciplina fora da grade gerada na transferencia, com intuito do usuario estudar uma disciplina X para pagar
	        		// uma disciplina Y da grade, via mapa de equivalencia.
	        		matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs().add(matriculaPeriodoTurmaDisciplinaAtual);
	        		matriculaPeriodo.getTransferenciaMatrizCurricularMatriculaVO().getListaDisciplinasPorCorrespondencia().remove(k);
	        	} else {
	        		// Caso entremos aqui, o que temos que fazer é inferir novos dados a MatriculaPeriodoTurmaDisciplina, pois iremos buscar 
	        		// modificar a MatriculaPeriodoTurmaDisciplina para uma disciplina identica, mas na NOVA MATRIZ / NOVA TURMA.

	        		// vamos percorrer a nova turma com intuiro de derivar as novas turmas /
	        		for (TurmaDisciplinaVO turmaDisciplinaVO : matriculaPeriodo.getTurma().getTurmaDisciplinaVOs()) {
	        			if ((turmaDisciplinaVO.getDisciplina().getCodigo().equals(disciplinaManter)) &&
	        					(turmaDisciplinaVO.getCargaHoraria().equals(cargaHorariaManter))) {

	        				if (turmaDisciplinaVO.getGradeDisciplinaVO().getCodigo() > 0) {
	        					turmaDisciplinaVO.setGradeDisciplinaVO(getFacadeFactory().getGradeDisciplinaFacade().consultarPorChavePrimaria(turmaDisciplinaVO.getGradeDisciplinaVO().getCodigo(), usuario));
	        				}
	        				if (turmaDisciplinaVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo() > 0) {
	        					turmaDisciplinaVO.setGradeCurricularGrupoOptativaDisciplinaVO(getFacadeFactory().getGradeCurricularGrupoOptativaDisciplinaFacade().consultarPorChavePrimaria(turmaDisciplinaVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), usuario));
	        				}

	        				MatriculaPeriodoTurmaDisciplinaVO novoObj = gerarMatriculaPeriodoTurmaDisciplinaVOValidado(turmaDisciplinaVO.getGradeDisciplinaVO(), false,
	        						// indica a disciplina será cursada por meio de um mapa de
	        						// equivalencia
	        						null, // indica a qual mapa de equivalencia de disciplina
	        						// estão sendo criado o objeto
	        						null, // indica a qual disciplina do mapa de equivalencia o
	        						// aluno irá cursar nesta
	        						// MatriculaPeriodoTurmaDisciplina
	        						turmaDisciplinaVO.getDisciplinaReferenteAUmGrupoOptativa(), turmaDisciplinaVO.getGradeCurricularGrupoOptativaDisciplinaVO(), false,
	        						// indica que o aluno foi liberado para estudar a
	        						// disciplina, mesmo com choque de horário com outras
	        						// disciplinas de sua turma
	        						false, // se a principal, trata-se de uma composicao, o
	        						// metodo que adiciona a
	        						// MatriculaPEriodoTurmaDisciplina irá tratar esta
	        						// situacao
	        						null, turmaDisciplinaVO.getModalidadeDisciplina(), matriculaPeriodo, matricula, matriculaPeriodo.getTurma(), null, null, usuario);							

	        				boolean novaMatriculaPeriodoTurmaDisciplinaAdicionada = false;
	        				try {
	        					validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(matriculaPeriodo, matricula, false, true, novoObj, usuario);
	        					realizarVerificacaoExistenciaAulaProgramada(matricula, matriculaPeriodo, novoObj);
	        					if (matriculaPeriodo.getCondicaoPagamentoPlanoFinanceiroCurso().getIsValorPorDisciplina()) {
	        						try {
	        							getFacadeFactory().getCondicaoPlanoFinanceiroCursoTurmaFacade().consultarValorCondicaoPlanoFinanceiroCursoTurma(matriculaPeriodo.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo(), novoObj.getDisciplina().getCodigo(), usuario);
	        						} catch (Exception e) {
	        						}
	        					}
	        					// atualizar as variáveis com o numero de vadas disponíveis e o
	        					// numero de alunos matriculados
	        					// assim, poderá ser realizado o controle de disponibilida de
	        					// vagas em cada turmaDisciplina
	        					if (novoObj.getDisciplinaComposta()) {
	        						List<GradeDisciplinaCompostaVO> gradeDisciplinaCompostaGerarVOs = new ArrayList<GradeDisciplinaCompostaVO>(0);
	        						if (Uteis.isAtributoPreenchido(gradeDisciplinaCompostaVOs)) {
	        							for (GradeDisciplinaCompostaVO gdcVO : gradeDisciplinaCompostaVOs) {
	        								if (gdcVO.getGradeDisciplina().getCodigo().equals(novoObj.getGradeDisciplinaVO().getCodigo())) {
	        									gradeDisciplinaCompostaGerarVOs.add(gdcVO);
	        								}
	        							}
	        						}
	        						List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinaVOComposicao = gerarEAdicionarMatriculaPeriodoTurmaDisciplinaVOParaDisciplinasComposicao(novoObj, matriculaPeriodo, matricula, usuario, gradeDisciplinaCompostaGerarVOs);

	        						for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVOComposicao : listaMatriculaPeriodoTurmaDisciplinaVOComposicao) {
	        							// Como geramos MatriculaPeriodoTurmaDisciplinaVO para a composicao da disciplina. Temos que verificar se já nao há um historico no qual o aluno esteja cursando 
	        							// por correspodencia, relativa a esta disciplina da composicao. 
	        							HistoricoVO historicoAnteriorDisciplinaComposicao = getFacadeFactory().getHistoricoFacade().consultarPorMatriula_Disciplina_Semestre_Ano(matricula.getMatricula(), matriculaPeriodoTurmaDisciplinaVOComposicao.getDisciplina().getCodigo(), matriculaPeriodo.getAno(), matriculaPeriodo.getSemestre(), false, Uteis.NIVELMONTARDADOS_TODOS, matriculaPeriodo.getConfiguracaoFinanceiro(), usuario);
	        							matriculaPeriodoTurmaDisciplinaVOComposicao.setHistoricoAnteriorDisciplinaMigrarNotas(historicoAnteriorDisciplinaComposicao);
	        						}

	        					}				
	        					getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().atualizarNrAlunosMatriculadosTurmaDisciplina(matriculaPeriodo, novoObj, novoObj.getDisciplina(), matriculaPeriodo.getAno(), matriculaPeriodo.getSemestre(), true, considerarVagaReposicao);

	        					// Obtendo historico anterior (cursando por correspondecia) para que possamos manter em ele em memoria, para posteriormente
	        					// aproveitar todas as notas que já tenham sido lançadas para o aluno. Isto é importante, pois um novo histórico será gerado
	        					// para o aluno nesta disciplina. E o historico que existia será removido, pois o mesmo nao poderá ser mantido mais vinculado
	        					// à matriz antiga - haja vista, que a correspodencia será removida.
	        					HistoricoVO historicoAnteriorDisciplina = getFacadeFactory().getHistoricoFacade().consultarPorMatriculaPeriodoTurmaDisciplina(matriculaPeriodoTurmaDisciplinaAtual.getCodigo(), false, false, usuario);
	        					novoObj.setHistoricoAnteriorDisciplinaMigrarNotas(historicoAnteriorDisciplina);

	        					matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs().add(novoObj);
	        					novaMatriculaPeriodoTurmaDisciplinaAdicionada = true;
	        				} catch (Exception e) {
	        					// se der alguma exception É por que o obj nao pode ser
	        					// adicionado para o aluno seja, por que o aluno ja foi aprovado, ou nao atendeu aos
	        					// pre-requesitos.
	        				}

	        				// Removendo objeto matriculaPeriodoTurmaDisciplina da lista getListaDisciplinasPorCorrespondencia, uma vez que a mesma foi resolvida
	        				// por este algoritmo. Ou seja, a mesma já foi encontrada na NOVA MATRIZ / TURMA e assim o aluno deixará de cursar por correspondencia.
	        				// Desta maneira, no final deste método, teremos somente as matriculaPeriodoTurmaDisciplina pendentes de solução pelo usuário.
	        				if (novaMatriculaPeriodoTurmaDisciplinaAdicionada) {
	        					matriculaPeriodo.getTransferenciaMatrizCurricularMatriculaVO().getListaDisciplinasPorCorrespondencia().remove(k);
	        					break;
	        				}
	        			}
	        		}
	        	}
	        }
			k = k - 1;
		}
	}
	
	/**
	 * Método que gerar lista MatriculaPeriodoTurmaDisciplina de um aluno para
	 * uma turma setada na MatriculaPeriodo ï¿½ importante que os dados desta
	 * turma já estejam devidamente carregados quando este Método for chamado.
	 * 
	 * @param matriculaPeriodo
	 * @param usuario
	 * @return
	 * @throws Exception
	 */
	public void obterListaMatriculaPeriodoTurmaDisciplinaVO(MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matricula, UsuarioVO usuario, List<GradeDisciplinaCompostaVO> gradeDisciplinaCompostaVOs, Boolean considerarVagaReposicao, Boolean liberarRealizarMatriculaDisciplinaPreRequisito) throws Exception {
		inicializarDadosAnoSemestreMatricula(matriculaPeriodo, matriculaPeriodo.getProcessoMatriculaCalendarioVO(), false);
		// List<MatriculaPeriodoTurmaDisciplinaVO> listaResultado = new
		// ArrayList<MatriculaPeriodoTurmaDisciplinaVO>(0);

		if (matriculaPeriodo.getTransferenciaMatrizCurricularMatriculaVO() != null) {
			obterListaMatriculaPeriodoTurmaDisciplinaEliminandoCursandoPorCorrespondencia(matriculaPeriodo, matricula, usuario, gradeDisciplinaCompostaVOs, considerarVagaReposicao);
			return;
		}
		
		// PROCESSANDO LISTA DE DISCIPLINAS PADROES DA TURMA (DO PERIODO LETIVO
		// DA TURMA)
		List<TurmaDisciplinaVO> disciplinasTurma = new ArrayList<TurmaDisciplinaVO>(0);
		disciplinasTurma.addAll(matriculaPeriodo.getTurma().getTurmaDisciplinaVOs());
		Iterator i = disciplinasTurma.iterator();
		q:
		while (i.hasNext()) {
			TurmaDisciplinaVO obj = (TurmaDisciplinaVO) i.next();
			if (obj.getGradeDisciplinaVO().getCodigo() > 0) {
				obj.setGradeDisciplinaVO(getFacadeFactory().getGradeDisciplinaFacade().consultarPorChavePrimaria(obj.getGradeDisciplinaVO().getCodigo(), usuario));
			}
			if (obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo() > 0) {
				obj.setGradeCurricularGrupoOptativaDisciplinaVO(getFacadeFactory().getGradeCurricularGrupoOptativaDisciplinaFacade().consultarPorChavePrimaria(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), usuario));
				if(!matricula.getCurso().getConfiguracaoAcademico().getIncluirAutomaticamenteDisciplinaGrupoOptativa()){
					continue q;
				}
			}
			MatriculaPeriodoTurmaDisciplinaVO novoObj = gerarMatriculaPeriodoTurmaDisciplinaVOValidado(obj.getGradeDisciplinaVO(), false,
			// indica a disciplina será cursada por meio de um mapa de
			// equivalencia
					null, // indica a qual mapa de equivalencia de disciplina
							// estão sendo criado o objeto
					null, // indica a qual disciplina do mapa de equivalencia o
							// aluno irá cursar nesta
							// MatriculaPeriodoTurmaDisciplina
					obj.getDisciplinaReferenteAUmGrupoOptativa(), obj.getGradeCurricularGrupoOptativaDisciplinaVO(), false,
					// indica que o aluno foi liberado para estudar a
					// disciplina, mesmo com choque de horário com outras
					// disciplinas de sua turma
					false, // se a principal, trata-se de uma composicao, o
							// metodo que adiciona a
							// MatriculaPEriodoTurmaDisciplina irá tratar esta
							// situacao
					null, obj.getModalidadeDisciplina(), matriculaPeriodo, matricula, matriculaPeriodo.getTurma(), null, null, usuario);
			try {
				if (usuario.getIsApresentarVisaoAluno() || usuario.getIsApresentarVisaoPais()) {
					validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(matriculaPeriodo, matricula, liberarRealizarMatriculaDisciplinaPreRequisito, false, novoObj, usuario);	
				} else {					
					validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(matriculaPeriodo, matricula, false, false, novoObj, usuario);
				}
				
				realizarVerificacaoExistenciaAulaProgramada(matricula, matriculaPeriodo, novoObj);
				if (matriculaPeriodo.getCondicaoPagamentoPlanoFinanceiroCurso().getIsValorPorDisciplina()) {
					try {
						getFacadeFactory().getCondicaoPlanoFinanceiroCursoTurmaFacade().consultarValorCondicaoPlanoFinanceiroCursoTurma(matriculaPeriodo.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo(), obj.getDisciplina().getCodigo(), usuario);
					} catch (Exception e) {
					}
				}
				// atualizar as variï¿½veis com o numero de vadas disponivel e o
				// numero de alunos matriculados
				// assim, poderá ser realizado o controle de disponibilida de
				// vagas em cada turmaDisciplina
				if (novoObj.getDisciplinaComposta()) {
					List<GradeDisciplinaCompostaVO> gradeDisciplinaCompostaGerarVOs = new ArrayList<GradeDisciplinaCompostaVO>(0);
					if (Uteis.isAtributoPreenchido(gradeDisciplinaCompostaVOs)) {
						for (GradeDisciplinaCompostaVO gdcVO : gradeDisciplinaCompostaVOs) {
							if (gdcVO.getGradeDisciplina().getCodigo().equals(obj.getGradeDisciplinaVO().getCodigo())) {
								gradeDisciplinaCompostaGerarVOs.add(gdcVO);
							}
						}
					}
					gerarEAdicionarMatriculaPeriodoTurmaDisciplinaVOParaDisciplinasComposicao(novoObj, matriculaPeriodo, matricula, usuario, gradeDisciplinaCompostaGerarVOs);
				}				
				getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().atualizarNrAlunosMatriculadosTurmaDisciplina(matriculaPeriodo, novoObj, novoObj.getDisciplina(), matriculaPeriodo.getAno(), matriculaPeriodo.getSemestre(), true, considerarVagaReposicao);
				matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs().add(novoObj);
			} catch (Exception e) {
				// se der alguma exception ï¿½ por que o obj nao pode ser
				// adicionado para o aluno
				// seja, por que o aluno ja foi aprovado, ou nao atendeu aos
				// pre-requesitos.
			}
		}

		// PROCESSANDO LISTA DE DISCIPLINAS PROGRAMADAS PARA INCLUIR
		// AUTOMATICAMENTE NA TURMA (DO PERIODO LETIVO DA TURMA)
		List<TurmaDisciplinaInclusaoSugeridaVO> disciplinasSugeridasInclusaoTurma = getFacadeFactory().getTurmaDisciplinaInclusaoSugeridaInterfaceFacade().consultaRapidaPorTurma(matriculaPeriodo.getTurma().getCodigo(), usuario);
		matriculaPeriodo.getTurma().setTurmaDisciplinaInclusaoSugeridaVOs(disciplinasSugeridasInclusaoTurma);
		List<HorarioAlunoTurnoVO> horarioAlunoTurnoVOs = new ArrayList<HorarioAlunoTurnoVO>(0);
		if (!disciplinasSugeridasInclusaoTurma.isEmpty()) {
			horarioAlunoTurnoVOs = (getFacadeFactory().getHorarioAlunoFacade().consultarHorarioAlunoPorMatriculaPeriodoDisciplina(matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs(), usuario));
		}
		Map<Integer, TurmaVO> turmaInclusaoSugerida = new HashMap<Integer, TurmaVO>(0);
		Iterator j = disciplinasSugeridasInclusaoTurma.iterator();
		q:
		while (j.hasNext()) {

			TurmaDisciplinaInclusaoSugeridaVO turmaInclusaoSugeridaVO = (TurmaDisciplinaInclusaoSugeridaVO) j.next();
			TurmaDisciplinaVO obj = getFacadeFactory().getTurmaDisciplinaFacade().consultarPorChavePrimaria(turmaInclusaoSugeridaVO.getTurmaDisciplinaVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			if(Uteis.isAtributoPreenchido(obj.getGradeDisciplinaVO())){
				obj.setGradeDisciplinaVO(getFacadeFactory().getGradeDisciplinaFacade().consultarPorChavePrimaria(obj.getGradeDisciplinaVO().getCodigo(), usuario));
			}
			if(Uteis.isAtributoPreenchido(obj.getGradeCurricularGrupoOptativaDisciplinaVO())){
				obj.setGradeCurricularGrupoOptativaDisciplinaVO(getFacadeFactory().getGradeCurricularGrupoOptativaDisciplinaFacade().consultarPorChavePrimaria(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), usuario));
			}
			TurmaVO turmaIncluir = null;
			if (!turmaInclusaoSugerida.containsKey(obj.getTurmaDescricaoVO().getCodigo())) {
				turmaInclusaoSugerida.put(obj.getTurmaDescricaoVO().getCodigo(), getFacadeFactory().getTurmaFacade().consultarPorChavePrimaria(obj.getTurmaDescricaoVO().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario));
			}
			turmaIncluir = turmaInclusaoSugerida.get(obj.getTurmaDescricaoVO().getCodigo());
			if (turmaIncluir.getSituacao().equals("AB")) {
				if(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo() > 0 && !matricula.getCurso().getConfiguracaoAcademico().getIncluirAutomaticamenteDisciplinaGrupoOptativa()){
					continue q;
				}
			obj.setTurmaDescricaoVO(turmaIncluir);
			turmaIncluir.getTurmaDisciplinaVOs().add(obj);
			// como este obj (TurmaDisciplinaVO) pertence a turma que esta
			// setada no objeto
			// obj.getTurmaDescricaoVO(), entao vamos seta-lo na lista de
			// turmaDisciplina da mesma,
			// para que validacoes realizadas no metodo abaixo funcionem de
			// forma correta. Evitando
			// que todos as disciplinas desta turma sejam carregadas novamente.
			MatriculaPeriodoTurmaDisciplinaVO novoObj = gerarMatriculaPeriodoTurmaDisciplinaVOValidado(obj.getGradeDisciplinaVO(), false, // indica
					// se a disciplina será cursada por meio de um mapa de
					// equivalencia
					null, // indica a qual mapa de equivalencia de disciplina
					// estão sendo criado o objeto
					null, // indica a qual disciplina do mapa de equivalencia o
					// aluno irá cursar nesta
					// MatriculaPeriodoTurmaDisciplina
					obj.getDisciplinaReferenteAUmGrupoOptativa(), obj.getGradeCurricularGrupoOptativaDisciplinaVO(), false, // indica
					// que o aluno foi liberado para estudar a disciplina, mesmo
					// com
					// choque de horário com outras disciplinas de sua turma
					false, // se a principal, trata-se de uma composicao, o
					// metodo que adiciona a
					// MatriculaPEriodoTurmaDisciplina irá tratar esta
					// situacao
					null, obj.getModalidadeDisciplina(), matriculaPeriodo, matricula, turmaIncluir, null, null, usuario);
			try {
				validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(matriculaPeriodo, matricula, false, false, novoObj, usuario);
				realizarVerificacaoExistenciaAulaProgramada(matricula, matriculaPeriodo, novoObj);
//				executarVerificarSeHaIncompatibilidadeHorarioDeDisciplinas(matriculaPeriodo, novoObj, horarioAlunoTurnoVOs, matricula.getCurso().getConfiguracaoAcademico().getValidarChoqueHorarioOutraMatriculaAluno(), usuario);

//				if (matriculaPeriodo.getCondicaoPagamentoPlanoFinanceiroCurso().getIsValorPorDisciplina()) {
//					try {
//						getFacadeFactory().getCondicaoPlanoFinanceiroCursoTurmaFacade().consultarValorCondicaoPlanoFinanceiroCursoTurma(matriculaPeriodo.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo(), obj.getDisciplina().getCodigo(), usuario);
//					} catch (Exception e) {
//					}
//				}
				// atualizar as variï¿½veis com o numero de vadas disponivel e o
				// numero de alunos matriculados
				// assim, poderá ser realizado o controle de disponibilida de
				// vagas em cada turmaDisciplina
				if (novoObj.getDisciplinaComposta()) {
					List<GradeDisciplinaCompostaVO> gradeDisciplinaCompostaGerarVOs = new ArrayList<GradeDisciplinaCompostaVO>(0);
					if (Uteis.isAtributoPreenchido(gradeDisciplinaCompostaVOs)) {
						for (GradeDisciplinaCompostaVO gdcVO : gradeDisciplinaCompostaVOs) {
							if (gdcVO.getGradeDisciplina().getCodigo().equals(obj.getGradeDisciplinaVO().getCodigo())) {
								gradeDisciplinaCompostaGerarVOs.add(gdcVO);
							}
						}
					}
					gerarEAdicionarMatriculaPeriodoTurmaDisciplinaVOParaDisciplinasComposicao(novoObj, matriculaPeriodo, matricula, usuario, gradeDisciplinaCompostaGerarVOs);
				}
				getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().atualizarNrAlunosMatriculadosTurmaDisciplina(matriculaPeriodo, novoObj, novoObj.getDisciplina(), matriculaPeriodo.getAno(), matriculaPeriodo.getSemestre(), true, considerarVagaReposicao);
				matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs().add(novoObj);
			} catch (Exception e) {
			}
			}
		}
		// return listaResultado;
	}

	public boolean verificarAlunoJaAprovadoNaDisciplina_Cursando(MatriculaPeriodoVO mat, GradeDisciplinaVO grade, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<HistoricoVO> lista = getFacadeFactory().getHistoricoFacade().consultarPorMatriculaDisciplinaAprovado_Cursando(mat.getMatricula(), grade.getDisciplina().getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		if (lista.isEmpty()) {
			return false;
		} else {
			return true;
		}
	}

	// public void adicionarMatriculaPeriodoTurmaDisciplinaObjEspecifico(String
	// matricula, Integer transferencia, MatriculaPeriodoVO matriculaPeriodo,
	// MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO,
	// UsuarioVO usuario) throws Exception {
	// matriculaPeriodoTurmaDisciplinaVO.setAno(matriculaPeriodo.getAno());
	// matriculaPeriodoTurmaDisciplinaVO.setSemestre(matriculaPeriodo.getSemestre());
	// matriculaPeriodo.adicionarObjMatriculaPeriodoVOs(matriculaPeriodoTurmaDisciplinaVO);
	// atualizarNrDisciplinasIncluidasExcluidas(matriculaPeriodo, usuario);
	// }
	//
	@Override
	public void removerMatriculaPeriodoTurmaDisciplinaObjEspecifico(MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matricula, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO, UsuarioVO usuario) throws Exception {
		matriculaPeriodo.excluirObjMatriculaPeriodoVOs(matriculaPeriodoTurmaDisciplinaVO);
		if (matriculaPeriodoTurmaDisciplinaVO.getDisciplinaEquivale()) {
			boolean possuiOutraEquivalenciaIncluida = false;
			for (MatriculaPeriodoTurmaDisciplinaVO mp : matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs()) {
				if (mp.getDisciplinaEquivale() && matriculaPeriodoTurmaDisciplinaVO.getMapaEquivalenciaDisciplinaVOIncluir().getCodigo().equals(mp.getMapaEquivalenciaDisciplinaVOIncluir().getCodigo())) {
					possuiOutraEquivalenciaIncluida = true;
					break;
				}
			}
			Boolean possuiOutraEquivalenciaAprovadaOuReprovada = possuiOutraEquivalenciaAprovadaOuReprovada(matricula, matriculaPeriodoTurmaDisciplinaVO.getMapaEquivalenciaDisciplinaVOIncluir(), usuario);
			if (possuiOutraEquivalenciaIncluida == false && !possuiOutraEquivalenciaAprovadaOuReprovada) {
				for (MapaEquivalenciaDisciplinaMatrizCurricularVO disciplinaMatriz : matriculaPeriodoTurmaDisciplinaVO.getMapaEquivalenciaDisciplinaVOIncluir().getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {
					if (!matriculaPeriodoTurmaDisciplinaVO.getDisciplinaReferenteAUmGrupoOptativa()) {
						List<PeriodoLetivoComHistoricoAlunoVO> periodoLetivoComHistoricoAlunoVOs = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getPeriodoLetivoComHistoricoAlunoVOs();
						for (PeriodoLetivoComHistoricoAlunoVO periodoLetivoComHistoricoAlunoVO : periodoLetivoComHistoricoAlunoVOs) {
							for (GradeDisciplinaComHistoricoAlunoVO gradeDisciplinaComHistoricoAlunoVO : periodoLetivoComHistoricoAlunoVO.getGradeDisciplinaComHistoricoAlunoVOs()) {
								if (gradeDisciplinaComHistoricoAlunoVO.getGradeDisciplinaVO().getDisciplina().getCodigo().equals(disciplinaMatriz.getDisciplinaVO().getCodigo())) {
									gradeDisciplinaComHistoricoAlunoVO.getGradeDisciplinaVO().setJaIncluidaRenovacao(false);
									gradeDisciplinaComHistoricoAlunoVO.getGradeDisciplinaVO().setGradeDisciplinaOfertada(true);
									for (Iterator<HistoricoVO> iterator = periodoLetivoComHistoricoAlunoVO.getHistoricosDisciplinasAlunoCursandoPeriodoLetivo().iterator(); iterator.hasNext();) {
										HistoricoVO historicoVO = iterator.next();
										if (historicoVO.getGradeDisciplinaVO().getCodigo().equals(gradeDisciplinaComHistoricoAlunoVO.getGradeDisciplinaVO().getCodigo())) {
											periodoLetivoComHistoricoAlunoVO.getDisciplinasPendentesAlunoPeriodoLetivo().add(gradeDisciplinaComHistoricoAlunoVO.getGradeDisciplinaVO());
											iterator.remove();
											break;
										}
									}
									for (Iterator<HistoricoVO> iterator = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getHistoricosDisciplinasAlunoCursandoGradeCurricular().iterator(); iterator.hasNext();) {
										HistoricoVO historicoVO = iterator.next();
										if (historicoVO.getGradeDisciplinaVO().getCodigo().equals(gradeDisciplinaComHistoricoAlunoVO.getGradeDisciplinaVO().getCodigo())) {
											iterator.remove();
											break;
										}
									}

									break;
								}
							}
						}
					} else {
						List<PeriodoLetivoComHistoricoAlunoVO> periodoLetivoComHistoricoAlunoVOs = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getPeriodoLetivoComHistoricoAlunoVOs();
						for (PeriodoLetivoComHistoricoAlunoVO periodoLetivoComHistoricoAlunoVO : periodoLetivoComHistoricoAlunoVOs) {
							for (GradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO obj : periodoLetivoComHistoricoAlunoVO.getGradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO()) {
								if (obj.getGradeCurricularGrupoOptativaDisciplinaVO().getDisciplina().getCodigo().equals(disciplinaMatriz.getDisciplinaVO().getCodigo())) {
									for (Iterator<HistoricoVO> iterator = periodoLetivoComHistoricoAlunoVO.getHistoricosDisciplinasAlunoCursandoPeriodoLetivo().iterator(); iterator.hasNext();) {
										HistoricoVO historicoVO = iterator.next();
										if (historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo().equals(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo())) {
											iterator.remove();
											break;
										}

									}
									for (Iterator<HistoricoVO> iterator = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getHistoricosDisciplinasAlunoCursandoGradeCurricular().iterator(); iterator.hasNext();) {
										HistoricoVO historicoVO = iterator.next();
										if (historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo().equals(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo())) {
											iterator.remove();
											break;
										}
									}
									break;
								}
							}
						}
					}

				}

			}
		}
		atualizarNrDisciplinasIncluidasExcluidas(matriculaPeriodo, matricula, usuario);
		realizarDefinicaoNumeroVagaDisciplinaCompostaComLimitacaoDisciplina(matriculaPeriodo, matriculaPeriodoTurmaDisciplinaVO);
	}
	
	public Boolean possuiOutraEquivalenciaAprovadaOuReprovada(MatriculaVO matricula, MapaEquivalenciaDisciplinaVO mapaEquivalenciaDisciplinaVO, UsuarioVO usuarioVO) {
		List<HistoricoVO> listaHistoricoAprovadoVOs = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getHistoricosDisciplinasAprovadasAlunoGradeCurricular();
		for (HistoricoVO historicoAprovadoVO : listaHistoricoAprovadoVOs) {
			if (historicoAprovadoVO.getMapaEquivalenciaDisciplina().getCodigo().equals(mapaEquivalenciaDisciplinaVO.getCodigo())) {
				return true;
			}
		}
		List<HistoricoVO> listaHistoricoReprovadoVOs = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getHistoricosDisciplinasAlunoReprovouGradeCurricular();
		for (HistoricoVO historicoReprovadoVO : listaHistoricoReprovadoVOs) {
			if (historicoReprovadoVO.getMapaEquivalenciaDisciplina().getCodigo().equals(mapaEquivalenciaDisciplinaVO.getCodigo())) {
				return true;
			}
		}
		return false;
	}

	/**
	 * @deprecated versao 5.0 ï¿½ feita para transferencia mais ainda nao trata
	 *             questãoes de mapa de equivalencia e grupo de optativas
	 */
	public void adicionarMatriculaPeriodoTurmaDisciplina(String matricula, Integer transferencia, MatriculaPeriodoVO matriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		matriculaPeriodo.setPeridoLetivo(getFacadeFactory().getPeriodoLetivoFacade().consultarPorChavePrimaria(matriculaPeriodo.getPeridoLetivo().getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, usuario));
		getFacadeFactory().getTurmaFacade().carregarDados(matriculaPeriodo.getTurma(), NivelMontarDados.TODOS, usuario);
		Iterator i = matriculaPeriodo.getPeridoLetivo().getGradeDisciplinaVOs().iterator();
		while (i.hasNext()) {
			GradeDisciplinaVO obj = (GradeDisciplinaVO) i.next();
			if (!verificarAlunoAprovadoDisciplina(obj.getDisciplina().getCodigo(), transferencia, matricula, matriculaPeriodo, configuracaoFinanceiroVO, usuario)) {
				if (!matriculaPeriodo.getPeridoLetivo().getPrimeiro()) {
					Boolean aprovado = verificarAlunoAprovadoTodosPreRequisitos(obj.getDisciplinaRequisitoVOs(), matricula, configuracaoFinanceiroVO, usuario);
					if (aprovado) {
						criarMatriculaPeriodoTurmaDisciplina(obj, matriculaPeriodo, matriculaPeriodo.getMatriculaVO(), matriculaPeriodo.getTurma(), matriculaPeriodo.getTurma().getNrVagas(), usuario);
					}
				} else {
					criarMatriculaPeriodoTurmaDisciplina(obj, matriculaPeriodo, matriculaPeriodo.getMatriculaVO(), matriculaPeriodo.getTurma(), matriculaPeriodo.getTurma().getNrVagas(), usuario);
				}
			}
		}
		atualizarNrDisciplinasIncluidasExcluidas(matriculaPeriodo, matriculaPeriodo.getMatriculaVO(), usuario);
	}

	public List<MatriculaPeriodoTurmaDisciplinaVO> obterListaDisciplinasGradePadraoAlunoForamExcluidasComRelacaoGradeModificada(List<MatriculaPeriodoTurmaDisciplinaVO> gradePadraoCalculadaAluno, List<MatriculaPeriodoTurmaDisciplinaVO> gradeModificadaAluno) {
		List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinasExcluidas = new ArrayList<MatriculaPeriodoTurmaDisciplinaVO>(0);
		Iterator i = gradePadraoCalculadaAluno.iterator();
		while (i.hasNext()) {
			MatriculaPeriodoTurmaDisciplinaVO disciplinaPadrao = (MatriculaPeriodoTurmaDisciplinaVO) i.next();
			// for (MatriculaPeriodoTurmaDisciplinaVO disciplinaPadrao :
			// gradePadraoCalculadaAluno) {
			// verificar disciplina por disciplina se a mesma continua na grade
			// modificada, caso contrario
			// a mesma e considerada como excluida
			Boolean disciplinaExcluida = true;
			Iterator j = gradeModificadaAluno.iterator();
			while (j.hasNext()) {
				MatriculaPeriodoTurmaDisciplinaVO disciplinaModificada = (MatriculaPeriodoTurmaDisciplinaVO) j.next();
				// }
				// for (MatriculaPeriodoTurmaDisciplinaVO disciplinaModificada :
				// gradeModificadaAluno) {
				if (disciplinaPadrao.getDisciplina().getCodigo().equals(disciplinaModificada.getDisciplina().getCodigo())) {
					disciplinaExcluida = false;
					break;
				}
				if (disciplinaModificada.getDisciplinaEquivale()) {
					// caso a discilpina que estão na grade do aluno, seja uma
					// disciplina equivalente (pois nao havia
					// vaga na disciplina original, por exemplo), então devemos
					// verificar se a disciplinaModificada,
					// não se equivale a disciplina equivalnete da grade do
					// aluno. Para não contï¿½-la como excluï¿½da de forma
					// equivocada.
					if (disciplinaModificada.getDisciplinaEquivalente().getCodigo().equals(disciplinaPadrao.getDisciplina().getCodigo())) {
						disciplinaExcluida = false;
						break;
					}
				}
				if (disciplinaModificada.getInclusaoForaPrazo() && ((disciplinaPadrao.getDisciplina().getCodigo().equals(disciplinaModificada.getDisciplina().getCodigo())) || ((disciplinaModificada.getDisciplinaEquivale()) && disciplinaModificada.getDisciplinaEquivalente().getCodigo().equals(disciplinaPadrao.getDisciplina().getCodigo())))) {
					disciplinaExcluida = false;
					break;
				}
			}
			if (disciplinaExcluida) {
				listaDisciplinasExcluidas.add(disciplinaPadrao);
			}
		}
		return listaDisciplinasExcluidas;
	}

	/**
	 * Método Responsável por identificar o nï¿½mero de disciplinas que foram
	 * excluï¿½das, considerando a grade Padrão do curso do aluno e a grade com
	 * a qual o aluno efetivamente estão sendo matriculado. Um detalhe
	 * importante desta rotina, refere-se a disciplinas equivalentes. Ou seja,
	 * caso uma disciplina equivalente X esteja na grade do aluno, então a
	 * disciplina a qual esta disciplina X equivale, caso Y, por exemplo, não
	 * poderá ser contada como excluï¿½da. Isto ï¿½ ï¿½bvio pois a disciplina Y
	 * estão sendo "cursada" pelo aluno de forma indireta, por meio da
	 * disciplina, equivalente X.
	 * 
	 * @param gradePadraoCalculadaAluno
	 * @param gradeModificadaAluno
	 * @return
	 */
	public Integer verificarQuantasDisciplinasGradePadraoAlunoForamExcluidasComRelacaoGradeModificada(List<MatriculaPeriodoTurmaDisciplinaVO> gradePadraoCalculadaAluno, List<MatriculaPeriodoTurmaDisciplinaVO> gradeModificadaAluno) {
		List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinasExcluidas = obterListaDisciplinasGradePadraoAlunoForamExcluidasComRelacaoGradeModificada(gradePadraoCalculadaAluno, gradeModificadaAluno);
		return listaDisciplinasExcluidas.size();
	}

	/**
	 * Método Responsável por verificar se um aluno já reprovou em uma
	 * determinada disciplina. Caso o mesmo tenha sido prevado então a
	 * matriculaPeriodoTurmaDisciplina será marcada como de dependencia. Este
	 * controle poderá ser util pois a insituicao podera cobrar um valor
	 * diferenciado para disciplina caso a mesma seja de inclusao.
	 */
	@Override
	public void verificarAlunoDependenciaDisciplinaComBaseEmHistoricosAnteriores(MatriculaPeriodoTurmaDisciplinaVO disciplinaIncluida, MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodoVO) {
		disciplinaIncluida.setDisciplinaDependencia(Boolean.FALSE);
		if (disciplinaIncluida.getDisciplinaEquivale()) {
			for (MapaEquivalenciaDisciplinaMatrizCurricularVO mapaEquivalenciaDisciplinaMatriz : disciplinaIncluida.getMapaEquivalenciaDisciplinaVOIncluir().getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {
				for(PeriodoLetivoVO periodoLetivoVO2 : matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPeriodoLetivosVOs()) {
					for(GradeDisciplinaVO gradeDisciplinaVO : periodoLetivoVO2.getGradeDisciplinaVOs()) {
						if(gradeDisciplinaVO.getDisciplina().getCodigo().equals(mapaEquivalenciaDisciplinaMatriz.getDisciplinaVO().getCodigo()) && 
								periodoLetivoVO2.getPeriodoLetivo() < matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo()) {
							disciplinaIncluida.setDisciplinaDependencia(Boolean.TRUE);
							return;
						}
					}
				}
				
			}
		} else {
			// Verificando se o aluno já foi reprovado nesta disciplina, alguma vez.
			disciplinaIncluida.setDisciplinaDependencia((!disciplinaIncluida.getDisciplinaComposta() && !disciplinaIncluida.getDisciplinaFazParteComposicao() &&  !disciplinaIncluida.getDisciplinaReferenteAUmGrupoOptativa() && matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo() > disciplinaIncluida.getGradeDisciplinaVO().getPeriodoLetivoVO().getPeriodoLetivo()) || (matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo().equals(disciplinaIncluida.getGradeDisciplinaVO().getPeriodoLetivoVO().getPeriodoLetivo()) && matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO()
				.getHistoricosDisciplinasAlunoReprovouGradeCurricular().stream().anyMatch(h -> h.getDisciplina().getCodigo().equals(disciplinaIncluida.getDisciplina().getCodigo()))));
		}
	}

	/**
	 * Determinar a quantidade de disciplinas incluidas na matriculaPeriodo do
	 * aluno, com base no que foi originalmente programado para a turma/grade do
	 * mesmo.
	 * 
	 * @param matriculaPeriodo
	 * @param gradePadraoCalculadaAluno
	 * @param gradeModificadaAluno
	 * @return
	 */
	public Integer verificarQuantasDisciplinasGradeModificadaNaoFazemParteGradePadrao(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodo, List<MatriculaPeriodoTurmaDisciplinaVO> gradePadraoCalculadaAluno, List<MatriculaPeriodoTurmaDisciplinaVO> gradeModificadaAluno) {
		int totalCHDisciplinasIncluidas = 0;
		int totalCreditosDisciplinasIncluidas = 0;

		Integer contador = 0;
		Iterator i = gradeModificadaAluno.iterator();
		matriculaPeriodo.setNrDisciplinasIncluidasInclusaoForaPrazo(0);
		matriculaPeriodo.setTotalCHDisciplinasIncluidasInclusaoForaPrazo(0);
		matriculaPeriodo.setTotalCreditosDisciplinasIncluidasInclusaoForaPrazo(0);
		while (i.hasNext()) {
			MatriculaPeriodoTurmaDisciplinaVO disciplinaModificada = (MatriculaPeriodoTurmaDisciplinaVO) i.next();
			// for (MatriculaPeriodoTurmaDisciplinaVO disciplinaModificada :
			// gradeModificadaAluno) {
			// verificar disciplina por disciplina se a mesma faz parte da grade
			// padrao
			// caso contrï¿½rio a mesma ï¿½ considerada como incluída.
			Boolean disciplinaIncluida = true;
			Iterator j = gradePadraoCalculadaAluno.iterator();
			while (j.hasNext()) {
				MatriculaPeriodoTurmaDisciplinaVO disciplinaPadrao = (MatriculaPeriodoTurmaDisciplinaVO) j.next();
				// for (MatriculaPeriodoTurmaDisciplinaVO disciplinaPadrao :
				// gradePadraoCalculadaAluno) {
				if (disciplinaModificada.getDisciplinaFazParteComposicao()) {
					disciplinaIncluida = false;
					break;
				}
				if (disciplinaPadrao.getDisciplina().getCodigo().equals(disciplinaModificada.getDisciplina().getCodigo())) {
					disciplinaIncluida = false;
					break;
				}
				// A PARTIR DA VERSA0 5.0 PASSOU A UTILIZAR MAPA DE
				// EQUIVALENCIA, LOGO VAMOS
				// QUE CONSIDERAR QUALQUER DISCIPLINA INCLUIDA POR EQUIVALENCIA,
				// COMO INCLUIDA.
				// if (disciplinaModificada.getDisciplinaEquivale()) {
				// caso a discilpina que estão na grade do aluno, seja uma
				// disciplina equivalente (pois nao havia
				// vaga na disciplina original, por exemplo), então devemos
				// verificar se a disciplina a qual a equivalente
				// se equivala, estão na grade do aluno. Caso sim, então ï¿½ por
				// que a mesma não ï¿½ incluída, simplesmente,
				// o aluno trocou a disciplina titular por uma equivalente, e
				// não por uma disciplina adicional.
				// if
				// (disciplinaModificada.getDisciplinaEquivalente().getCodigo().equals(disciplinaPadrao.getDisciplina().getCodigo()))
				// {
				// disciplinaIncluida = false;
				// break;
				// }
				// }
				// if (disciplinaModificada.getInclusaoForaPrazo()) {
				// // &&
				// ((disciplinaPadrao.getDisciplina().getCodigo().equals(disciplinaModificada.getDisciplina().getCodigo()))
				// // || ((disciplinaModificada.getDisciplinaEquivale()) &&
				// disciplinaModificada.getDisciplinaEquivalente().getCodigo().equals(disciplinaPadrao.getDisciplina().getCodigo()))))
				// {
				// disciplinaIncluida = false;
				// break;
				// }
			}
			if (disciplinaIncluida) {
				disciplinaModificada.setDisciplinaIncluida(true);
				if (disciplinaModificada.getInclusaoForaPrazo()) {
					matriculaPeriodo.setNrDisciplinasIncluidasInclusaoForaPrazo(matriculaPeriodo.getNrDisciplinasIncluidasInclusaoForaPrazo() + 1);
					matriculaPeriodo.setTotalCHDisciplinasIncluidasInclusaoForaPrazo(matriculaPeriodo.getTotalCHDisciplinasIncluidasInclusaoForaPrazo() + disciplinaModificada.getCargaHorariaDisciplina());
					matriculaPeriodo.setTotalCreditosDisciplinasIncluidasInclusaoForaPrazo(matriculaPeriodo.getTotalCreditosDisciplinasIncluidasInclusaoForaPrazo() + disciplinaModificada.getCreditosDisciplina());
				} else {
					contador++;
					totalCHDisciplinasIncluidas += disciplinaModificada.getCargaHorariaDisciplina();
					totalCreditosDisciplinasIncluidas += disciplinaModificada.getCreditosDisciplina();
				}
				// sempre que uma disciplina for definida como incluida,
				// precisamos verificar
				// se trata-se de uma disciplina de dependencia (que o aluno já
				// a cursou alguma vez).
				// esta informacao ï¿½ importante para definirmos
				verificarDisciplinaAlunoAdaptacao(disciplinaModificada, matricula, matriculaPeriodo);
			} else {
				disciplinaModificada.setDisciplinaIncluida(false);
			}
			verificarAlunoDependenciaDisciplinaComBaseEmHistoricosAnteriores(disciplinaModificada, matricula, matriculaPeriodo);
		}
		matriculaPeriodo.setTotalCHDisciplinasIncluidas(totalCHDisciplinasIncluidas);
		matriculaPeriodo.setTotalCreditosDisciplinasIncluidas(totalCreditosDisciplinasIncluidas);

		return contador;
	}

	/**
	 * Método Responsável por calcular e atualizar em MatriculaPeriodoVO todas
	 * as variï¿½veis de controle do total de carga horaria/creditos Padrão da
	 * turma que o aluno estão se matriculando/renovando. A mesma calcula o
	 * total de carga horaria e creditos programado para o periodo/turma do
	 * aluno (com base na lista disciplinasPadraoPeriodoLetivoTurma);
	 * 
	 * @param disciplinasPadraoPeriodoLetivoTurma
	 */
	public void executarCalculoAtualizarTotaisCargaHorariaCreditoProgramadoParaTurmaPeriodoLetivo(MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoTurmaDisciplinaVO> disciplinasPadraoPeriodoLetivoTurma) {
		Integer totalCargaHoraria = 0;
		Integer totalCredito = 0;
		for (MatriculaPeriodoTurmaDisciplinaVO obj : disciplinasPadraoPeriodoLetivoTurma) {
			if (!obj.getDisciplinaFazParteComposicao() && !obj.getInclusaoForaPrazo()) {
				if (obj.getDisciplinaReferenteAUmGrupoOptativa()) {
					totalCargaHoraria += obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria();
					totalCredito += obj.getGradeCurricularGrupoOptativaDisciplinaVO().getNrCreditos();
				} else {
					totalCargaHoraria += obj.getGradeDisciplinaVO().getCargaHoraria();
					totalCredito += obj.getGradeDisciplinaVO().getNrCreditos();
				}

			}
		}
		matriculaPeriodoVO.setTotalCargaHorariaPadraoMatriculaPeriodo(totalCargaHoraria);
		matriculaPeriodoVO.setTotalCreditoPadraoMatriculaPeriodo(totalCredito);
	}

	/**
	 * Método Responsável por calcular e atualizar em MatriculaPeriodoVO todas
	 * as variï¿½veis de controle do total de carga horaria/creditos ao aluno. A
	 * mesma calcula o total de carga horaria e creditos com base nas
	 * disciplinas já incluídas para o aluno na renovação.
	 */
	public void executarCalculoAtualizarTotaisCargaHorariaCreditoMatriculaPeriodoAluno(MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoTurmaDisciplinaVO> disciplinasAluno) throws Exception {
		try {
			Integer totalCargaHoraria = 0;
			Integer totalCredito = 0;
			Integer nrCreditoDiscplinasOptativas = 0;
			Integer nrCargaHorariaDiscplinasOptativas = 0;
			matriculaPeriodoVO.setTotalCargaHorariaAlunoMatriculaPeriodoInclusaoForaPrazo(0);
			matriculaPeriodoVO.setTotalCreditoAlunoMatriculaPeriodoInclusaoForaPrazo(0);
			matriculaPeriodoVO.setNrCargaHorariaDiscplinasOptativasInclusaoForaPrazo(0);
			matriculaPeriodoVO.setNrCreditoDiscplinasOptativasInclusaoForaPrazo(0);
			for (MatriculaPeriodoTurmaDisciplinaVO obj : disciplinasAluno) {
				if (!obj.getDisciplinaFazParteComposicao() && !obj.getInclusaoForaPrazo()) {
					if (obj.getDisciplinaReferenteAUmGrupoOptativa()) {
						totalCargaHoraria += obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria();
						totalCredito += obj.getGradeCurricularGrupoOptativaDisciplinaVO().getNrCreditos();
						nrCargaHorariaDiscplinasOptativas += obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria();
						nrCreditoDiscplinasOptativas += obj.getGradeCurricularGrupoOptativaDisciplinaVO().getNrCreditos();
					} else {
						totalCargaHoraria += obj.getGradeDisciplinaVO().getCargaHoraria();
						totalCredito += obj.getGradeDisciplinaVO().getNrCreditos();
						if (obj.getGradeDisciplinaVO().getIsDisciplinaOptativa()) {
							nrCargaHorariaDiscplinasOptativas += obj.getGradeDisciplinaVO().getCargaHoraria();
							nrCreditoDiscplinasOptativas += obj.getGradeDisciplinaVO().getNrCreditos();
						}
					}
				} else if (!obj.getDisciplinaFazParteComposicao() && obj.getInclusaoForaPrazo()) {
					if (obj.getDisciplinaReferenteAUmGrupoOptativa()) {
						matriculaPeriodoVO.setTotalCargaHorariaAlunoMatriculaPeriodoInclusaoForaPrazo(matriculaPeriodoVO.getTotalCargaHorariaAlunoMatriculaPeriodoInclusaoForaPrazo() + obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria());
						matriculaPeriodoVO.setTotalCreditoAlunoMatriculaPeriodoInclusaoForaPrazo(matriculaPeriodoVO.getTotalCreditoAlunoMatriculaPeriodoInclusaoForaPrazo() + obj.getGradeCurricularGrupoOptativaDisciplinaVO().getNrCreditos());
						matriculaPeriodoVO.setNrCargaHorariaDiscplinasOptativasInclusaoForaPrazo(matriculaPeriodoVO.getNrCargaHorariaDiscplinasOptativasInclusaoForaPrazo() + obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria());
						matriculaPeriodoVO.setNrCreditoDiscplinasOptativasInclusaoForaPrazo(matriculaPeriodoVO.getNrCreditoDiscplinasOptativasInclusaoForaPrazo() + obj.getGradeCurricularGrupoOptativaDisciplinaVO().getNrCreditos());
					} else {
						matriculaPeriodoVO.setTotalCargaHorariaAlunoMatriculaPeriodoInclusaoForaPrazo(matriculaPeriodoVO.getTotalCargaHorariaAlunoMatriculaPeriodoInclusaoForaPrazo() + obj.getGradeDisciplinaVO().getCargaHoraria());
						matriculaPeriodoVO.setTotalCreditoAlunoMatriculaPeriodoInclusaoForaPrazo(matriculaPeriodoVO.getTotalCreditoAlunoMatriculaPeriodoInclusaoForaPrazo() + obj.getGradeDisciplinaVO().getNrCreditos());
						if (obj.getGradeDisciplinaVO().getIsDisciplinaOptativa()) {
							matriculaPeriodoVO.setNrCargaHorariaDiscplinasOptativasInclusaoForaPrazo(matriculaPeriodoVO.getNrCargaHorariaDiscplinasOptativasInclusaoForaPrazo() + obj.getGradeDisciplinaVO().getCargaHoraria());
							matriculaPeriodoVO.setNrCreditoDiscplinasOptativasInclusaoForaPrazo(matriculaPeriodoVO.getNrCreditoDiscplinasOptativasInclusaoForaPrazo() + obj.getGradeDisciplinaVO().getNrCreditos());
						}
					}
				}
			}
			matriculaPeriodoVO.setTotalCargaHorariaAlunoMatriculaPeriodo(totalCargaHoraria);
			matriculaPeriodoVO.setTotalCreditoAlunoMatriculaPeriodo(totalCredito);
			matriculaPeriodoVO.setNrCargaHorariaDiscplinasOptativas(nrCargaHorariaDiscplinasOptativas);
			matriculaPeriodoVO.setNrCreditoDiscplinasOptativas(nrCreditoDiscplinasOptativas);
		} catch (Exception e) {
			throw e;
		}
	}

	/**
	 * Método Responsável por calcular o total de carga horaria / crï¿½ditos das
	 * disciplinas regulares e optativas com base na Lista de
	 * MatriculaPeriodoTurmaDisciplinaVO informada como parametro.
	 */
	public List<MatriculaPeriodoTurmaDisciplinaVO> executarObterListaDisciplinasExcluidasGradeAluno(MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matricula, UsuarioVO usuario) {
		try {
			List<MatriculaPeriodoTurmaDisciplinaVO> gradePadraoCalculadaAluno = obterListaMatriculaPeriodoTurmaDisciplinaVOPeriodoLetivoTurmaIndependenteAluno(matriculaPeriodo, matricula, usuario);
			List<MatriculaPeriodoTurmaDisciplinaVO> gradeModificadaAluno = matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs();
			return obterListaDisciplinasGradePadraoAlunoForamExcluidasComRelacaoGradeModificada(gradePadraoCalculadaAluno, gradeModificadaAluno);
		} catch (Exception e) {
			return new ArrayList<MatriculaPeriodoTurmaDisciplinaVO>(0);
		}
	}

	public void atualizarNrDisciplinasIncluidasExcluidas(MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matricula, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoTurmaDisciplinaVO> gradePadraoCalculadaAluno = obterListaMatriculaPeriodoTurmaDisciplinaVOPeriodoLetivoTurmaIndependenteAluno(matriculaPeriodo, matricula, usuario);
		executarCalculoAtualizarTotaisCargaHorariaCreditoProgramadoParaTurmaPeriodoLetivo(matriculaPeriodo, gradePadraoCalculadaAluno);

		List<MatriculaPeriodoTurmaDisciplinaVO> gradeModificadaAluno = matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs();
		executarCalculoAtualizarTotaisCargaHorariaCreditoMatriculaPeriodoAluno(matriculaPeriodo, gradeModificadaAluno);

		Integer nrDisciplinasExcluidas = verificarQuantasDisciplinasGradePadraoAlunoForamExcluidasComRelacaoGradeModificada(gradePadraoCalculadaAluno, gradeModificadaAluno);
		matriculaPeriodo.setNrDisciplinasExcluidas(nrDisciplinasExcluidas);

		Integer nrDisciplinasIncluidas = verificarQuantasDisciplinasGradeModificadaNaoFazemParteGradePadrao(matricula, matriculaPeriodo, gradePadraoCalculadaAluno, gradeModificadaAluno);
		matriculaPeriodo.setNrDisciplinasIncluidas(nrDisciplinasIncluidas);

		int periodoAnterior = matriculaPeriodo.getPeriodoLetivo().getPeriodoLetivo() - 1;
		if (periodoAnterior < 0) {
			periodoAnterior = 0;
		}

		// TOTAIS RELATIVOS AS DISCIPLINAS REGULARES
		Integer totalCHPendenteAlunoAtePeriodoAnterior = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().calcularTotalCargaHorariaCreditoPendenteAlunoAteDeterminadoPeriodoMatrizCurricular(periodoAnterior, true, "CH");
		Integer totalCreditoPendenteAlunoAtePeriodoAnterior = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().calcularTotalCargaHorariaCreditoPendenteAlunoAteDeterminadoPeriodoMatrizCurricular(periodoAnterior, true, "CR");
		matriculaPeriodo.setTotalCHPendenteAlunoAtePeriodoAnterior(totalCHPendenteAlunoAtePeriodoAnterior);
		matriculaPeriodo.setTotalCreditoPendenteAlunoAtePeriodoAnterior(totalCreditoPendenteAlunoAtePeriodoAnterior);
		matriculaPeriodo.setTotalCHIncluidoAlunoDisciplinasAtePeriodoAnterior(matriculaPeriodo.calcularCargaHorariaDisciplinasPeriodosAnterioresAdicionadasParaMatriculaPeriodo(matricula));
		matriculaPeriodo.setTotalCreditoIncluidoAlunoDisciplinasAtePeriodoAnterior(matriculaPeriodo.calcularCreditosDisciplinasPeriodosAnterioresAdicionadasParaMatriculaPeriodo());
		matriculaPeriodo.setNrDisciplinasIncluidasPeriodosAnteriores(matriculaPeriodo.calcularNrDisciplinasPendentesPeriodosAnterioresAdicionadasParaMatriculaPeriodo(matricula.getCurso().getConfiguracaoAcademico().getConsiderarRegularAlunoDependenciaOptativa()));
		if(matricula.getCurso().getConfiguracaoAcademico().getControlarInclusaoDisciplinaPorNrMaxCreditoOuCH() 
    			&& matricula.getCurso().getConfiguracaoAcademico().getTipoControleInclusaoDisciplinaPorNrMaxCreditoOuCH().equals("CH")){
			matriculaPeriodo.setTipoContabilizacaoDisciplinaDependencia(TipoContabilizacaoDisciplinaDependenciaEnum.CARGA_HORARIA);
    	}else if(matricula.getCurso().getConfiguracaoAcademico().getControlarInclusaoDisciplinaPorNrMaxCreditoOuCH() 
    			&& matricula.getCurso().getConfiguracaoAcademico().getTipoControleInclusaoDisciplinaPorNrMaxCreditoOuCH().equals("CR")){
    		matriculaPeriodo.setTipoContabilizacaoDisciplinaDependencia(TipoContabilizacaoDisciplinaDependenciaEnum.CREDITO);
    	}else if(!matricula.getCurso().getConfiguracaoAcademico().getControlarInclusaoDisciplinaPorNrMaxCreditoOuCH() ){
    		matriculaPeriodo.setTipoContabilizacaoDisciplinaDependencia(TipoContabilizacaoDisciplinaDependenciaEnum.QTDE_DISCIPLINA);
    	}
		// TOTAIS RELATIVOS AS DISCIPLINAS DE GRUPO DE OPTATIVAS
		matriculaPeriodo.setTotalCHPendenteAlunoGrupoOptativaAtePeriodoAnterior(matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().calcularTotalCargaHorariaPendenteAlunoGrupoOptativaAteDeterminadoPeriodoMatrizCurricular(matriculaPeriodo.getPeriodoLetivo().getPeriodoLetivo() - 1, true));
		matriculaPeriodo.setTotalCHIncluidoAlunoGrupoOptativaAtePeriodoAnterior(matriculaPeriodo.calcularCargaHorariaGrupoOptativaPeriodosAnterioresAdicionadasParaMatriculaPeriodo());

		// TOTAIS DO PERIODO LETIVO EM RENOVACAO
		matriculaPeriodo.setNrCreditosDisciplinasGrupoOptativaPeriodoLetivoMatriculaPeriodo(matriculaPeriodo.calcularNrCreditosDisciplinasGrupoOptativaPeriodoLetivoMatriculaPeriodo());
		matriculaPeriodo.setCargaHorariaDisciplinasGrupoOptativaPeriodoLetivoMatriculaPeriodo(matriculaPeriodo.calcularCargaHorariaDisciplinasGrupoOptativaPeriodoLetivoMatriculaPeriodo());

		ConfiguracaoAcademicoVO cfg = matricula.getCurso().getConfiguracaoAcademico();
		int totalPermitidoIncluirCH = matriculaPeriodo.getPeriodoLetivo().getNumeroMaximoCargaHorariaAlunoPodeCursar();
		int totalPermitidoIncluirCredito = matriculaPeriodo.getPeriodoLetivo().getNumeroMaximoCreditoAlunoPodeCursar();
		if (cfg.getAcumularCreditosOuCHPeriodosAnterioresNaoCumpridos()) {
			totalPermitidoIncluirCH += totalCHPendenteAlunoAtePeriodoAnterior;
			totalPermitidoIncluirCredito += totalCreditoPendenteAlunoAtePeriodoAnterior;
		}
		int saldoCH = totalPermitidoIncluirCH - matriculaPeriodo.getTotalCargaHorariaAlunoMatriculaPeriodo();
		if (saldoCH < 0) {
			saldoCH = 0;
		}
		int saldoCredito = totalPermitidoIncluirCredito - matriculaPeriodo.getTotalCreditoAlunoMatriculaPeriodo();
		if (saldoCredito < 0) {
			saldoCredito = 0;
		}
		matriculaPeriodo.setSaldoCHDisponivelInclusaoDisplinas(saldoCH);
		matriculaPeriodo.setSaldoCreditoDisponivelInclusaoDisplinas(saldoCredito);

	}

	public void atualizarNrDisciplinasIncluidas(MatriculaPeriodoVO matriculaPeriodo) {
		Iterator i = matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs().iterator();
		int cont = 0;
		while (i.hasNext()) {
			MatriculaPeriodoTurmaDisciplinaVO objExistente = (MatriculaPeriodoTurmaDisciplinaVO) i.next();
			if (objExistente.getDisciplinaIncluida()) {
				cont++;
			}
		}
		matriculaPeriodo.setNrDisciplinasIncluidas(cont);
	}

	public void inicializarDadosBasicosMatriculaPeriodoTurmaDisciplinaVO(MatriculaPeriodoVO matriculaPeriodo, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTumaDisciplina, ModalidadeDisciplinaEnum modalidadeDisciplinaEnum, TurmaVO turma, TurmaVO turmaPratica, TurmaVO turmaTeorica) throws Exception {
		matriculaPeriodoTumaDisciplina.setTurma(turma.clone());
		matriculaPeriodoTumaDisciplina.setTurmaPratica(turmaPratica != null ? turmaPratica.clone() : null);
		matriculaPeriodoTumaDisciplina.setTurmaTeorica(turmaTeorica != null ? turmaTeorica.clone() : null);
		if (Uteis.isAtributoPreenchido(turmaPratica) || Uteis.isAtributoPreenchido(turmaTeorica)) {
			matriculaPeriodoTumaDisciplina.setSugestaoTurmaPraticaTeoricaRealizada(true);
		}
		matriculaPeriodoTumaDisciplina.setMatriculaPeriodo(matriculaPeriodo.getCodigo());
		matriculaPeriodoTumaDisciplina.setAno(matriculaPeriodo.getAno());
		matriculaPeriodoTumaDisciplina.setSemestre(matriculaPeriodo.getSemestre());
		matriculaPeriodoTumaDisciplina.setMatricula(matriculaPeriodo.getMatricula());
		if (modalidadeDisciplinaEnum == null) {
			modalidadeDisciplinaEnum = ModalidadeDisciplinaEnum.PRESENCIAL;// getFacadeFactory().getTurmaDisciplinaFacade().consultarModalidadeDisciplinaPorTurmaEDisciplina(turma.getCodigo(),
			// disciplinaVO.getCodigo());
		}
		if (modalidadeDisciplinaEnum.equals(ModalidadeDisciplinaEnum.AMBAS)) {
			matriculaPeriodoTumaDisciplina.setModalidadeDisciplina(ModalidadeDisciplinaEnum.PRESENCIAL);
			matriculaPeriodoTumaDisciplina.setPermiteEscolherModalidade(true);
		} else {
			matriculaPeriodoTumaDisciplina.setModalidadeDisciplina(modalidadeDisciplinaEnum);
			matriculaPeriodoTumaDisciplina.setPermiteEscolherModalidade(false);
		}
	}

	/**
	 * Método oficial para gerar MatriculaPeriodoTurmaDisciplina na versão 5.0
	 * já gerenciando aspectos relativos a mapa de equivalencia, grupo
	 * optativas, e disciplina composta. O mesmo gera um ï¿½nico objeto para
	 * MatriculaPeriodoTurmaDisciplina
	 * 
	 * @param disciplinaVO
	 * @param gradeDisciplinaVO
	 * @param disciplinaPorEquivalencia
	 * @param mapaEquivalenciaDisciplina
	 *            - Indica se a disciplina será cursada por meio de uma mapa de
	 *            equivalencia
	 * @param mapaEquivalenciaDisciplinaCursada
	 *            - Indica qual mapa de equivalencia de disciplina estão sendo
	 *            criado o objeto
	 * @param disciplinaReferenteAUmGrupoOptativa
	 *            - indica se a disciplina que estão sendo adicionado tem a
	 *            origem de um grupo de optativas
	 * @param gradeCurricularGrupoOptativaDisciplinaVO
	 * @param modalidadeDisciplinaEnum
	 * @param matriculaPeriodo
	 * @param turma
	 * @param nrVagas
	 * @return
	 * @throws Exception
	 */
	public MatriculaPeriodoTurmaDisciplinaVO gerarMatriculaPeriodoTurmaDisciplinaVOValidado(GradeDisciplinaVO gradeDisciplinaVO, Boolean disciplinaPorEquivalencia, MapaEquivalenciaDisciplinaVO mapaEquivalenciaDisciplina, MapaEquivalenciaDisciplinaCursadaVO mapaEquivalenciaDisciplinaCursada, Boolean disciplinaReferenteAUmGrupoOptativa, GradeCurricularGrupoOptativaDisciplinaVO gradeCurricularGrupoOptativaDisciplinaVO, Boolean disciplinaEmRegimeEspecial, Boolean disciplinaDeUmaComposicao, GradeDisciplinaCompostaVO disciplinaCompostaVO, ModalidadeDisciplinaEnum modalidadeDisciplinaEnum, MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matricula, TurmaVO turma, TurmaVO turmaPratica, TurmaVO turmaTeorica, UsuarioVO usuario) throws Exception {

		MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTumaDisciplina = new MatriculaPeriodoTurmaDisciplinaVO();
		inicializarDadosBasicosMatriculaPeriodoTurmaDisciplinaVO(matriculaPeriodo, matriculaPeriodoTumaDisciplina, modalidadeDisciplinaEnum, turma, turmaPratica, turmaTeorica);
		matriculaPeriodoTumaDisciplina.setDisciplinaEmRegimeEspecial(disciplinaEmRegimeEspecial);
		if ((!disciplinaPorEquivalencia) && (!disciplinaDeUmaComposicao)) {
			// Por Padrão assumimos a disciplina que estão na grade, contudo,
			// caso seja uma equivalente, ou uma composta,
			// a disciplina pode ser alterada.
			matriculaPeriodoTumaDisciplina.setDisciplina(gradeDisciplinaVO.getDisciplina());
			matriculaPeriodoTumaDisciplina.setDisciplinaOptativa(gradeDisciplinaVO.getIsDisciplinaOptativa());
			matriculaPeriodoTumaDisciplina.setGradeDisciplinaVO(gradeDisciplinaVO);
			TurmaDisciplinaVO turmaDisciplina = null;
			if(turma.getTurmaDisciplinaVOs().stream().anyMatch(t -> t.getDisciplina().getCodigo().equals(matriculaPeriodoTumaDisciplina.getDisciplina().getCodigo()))) {
				turmaDisciplina = turma.getTurmaDisciplinaVOs().stream().filter(t -> t.getDisciplina().getCodigo().equals(matriculaPeriodoTumaDisciplina.getDisciplina().getCodigo())).findFirst().get();
			}else {
				turmaDisciplina = getFacadeFactory().getTurmaDisciplinaFacade().consultarPorTurmaDisciplina(turma.getCodigo(), matriculaPeriodoTumaDisciplina.getDisciplina().getCodigo(), false, null);
				if(Uteis.isAtributoPreenchido(turmaDisciplina)) {
					turma.getTurmaDisciplinaVOs().add(turmaDisciplina);
				}
			}
			matriculaPeriodoTumaDisciplina.setModalidadeDisciplina(turmaDisciplina.getModalidadeDisciplina());
		}

		if (disciplinaPorEquivalencia) {
			// Se a disciplina estão sendo cursada por equivalencia, então a
			// disciplina que será
			// cursada na MatriculaPeriodoTurmaDisciplina será a disciplina
			// escolhida pelo usuário no
			// Mapa de Equivalencia configurado para a matriz. Esta disciplina
			// sempre estarï¿½ definida como
			// a disciplina que será cursada.
			if ((!Uteis.isAtributoPreenchido(mapaEquivalenciaDisciplinaCursada.getCodigo())) || (!Uteis.isAtributoPreenchido(mapaEquivalenciaDisciplina.getCodigo()))) {
				throw new Exception("Disciplina sendo incluída por Equivalência, contudo, não existe uma Mapa de Equivalência definido.");
			}
			matriculaPeriodoTumaDisciplina.setDisciplina(mapaEquivalenciaDisciplinaCursada.getDisciplinaVO());
			matriculaPeriodoTumaDisciplina.setDisciplinaOptativa(false);
			matriculaPeriodoTumaDisciplina.setDisciplinaEquivale(true);
			matriculaPeriodoTumaDisciplina.setDisciplinaPorEquivalencia(false);
			matriculaPeriodoTumaDisciplina.setMapaEquivalenciaDisciplinaVOIncluir(mapaEquivalenciaDisciplina);
			matriculaPeriodoTumaDisciplina.setMapaEquivalenciaDisciplinaCursada(mapaEquivalenciaDisciplinaCursada);
			
			Integer numeroAgrupamentoEquivalenciaDisciplina =  getFacadeFactory().getHistoricoFacade().consultarUltimoNumeroAgrupamentoEquivalenciaDisciplina(matricula.getMatricula(), mapaEquivalenciaDisciplina.getCodigo());
			if(numeroAgrupamentoEquivalenciaDisciplina == 0){
				numeroAgrupamentoEquivalenciaDisciplina = 1;
			}
			matriculaPeriodoTumaDisciplina.setNumeroAgrupamentoEquivalenciaDisciplina(numeroAgrupamentoEquivalenciaDisciplina);
			TurmaDisciplinaVO turmaDisciplinaVO = null;
			if(turma.getTurmaDisciplinaVOs().stream().anyMatch(t -> t.getDisciplina().getCodigo().equals(matriculaPeriodoTumaDisciplina.getDisciplina().getCodigo()))) {
				turmaDisciplinaVO = turma.getTurmaDisciplinaVOs().stream().filter(t -> t.getDisciplina().getCodigo().equals(matriculaPeriodoTumaDisciplina.getDisciplina().getCodigo())).findFirst().get();
			}else {
				turmaDisciplinaVO = getFacadeFactory().getTurmaDisciplinaFacade().consultarPorTurmaDisciplina(turma.getCodigo(), mapaEquivalenciaDisciplinaCursada.getDisciplinaVO().getCodigo(), false, null);
				if(Uteis.isAtributoPreenchido(turmaDisciplinaVO)) {
					turma.getTurmaDisciplinaVOs().add(turmaDisciplinaVO);
				}
			}
			matriculaPeriodoTumaDisciplina.setModalidadeDisciplina(turmaDisciplinaVO.getModalidadeDisciplina());
			// Como o aluno estão estudando por equivalencia, temos que adotar
			// as
			// regras (configuracao)
			// e o tipo de disciplina (GradeDisciplinVO ou
			// GradeCurricularGrupoOptativaDisciplinaVO) desta turma alvo.
			if (turmaDisciplinaVO.getDisciplinaReferenteAUmGrupoOptativa()) {
				matriculaPeriodoTumaDisciplina.setDisciplinaReferenteAUmGrupoOptativa(true);
				if (turmaDisciplinaVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo() > 0) {
					matriculaPeriodoTumaDisciplina.setGradeCurricularGrupoOptativaDisciplinaVO(getFacadeFactory().getGradeCurricularGrupoOptativaDisciplinaFacade().consultarPorChavePrimaria(turmaDisciplinaVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), null));
				}
			} else {
				matriculaPeriodoTumaDisciplina.setDisciplinaReferenteAUmGrupoOptativa(false);
				if (turmaDisciplinaVO.getGradeDisciplinaVO().getCodigo() > 0) {
					matriculaPeriodoTumaDisciplina.setGradeDisciplinaVO(getFacadeFactory().getGradeDisciplinaFacade().consultarPorChavePrimaria(turmaDisciplinaVO.getGradeDisciplinaVO().getCodigo(), null));
				}
			}
		} else {
			// Caso contrï¿½rio temos que tratar se uma disciplina de uma
			// composicao (Faz parte de uma composicao).
			if (disciplinaDeUmaComposicao) {
				// Se a disciplina que estão sendo adicionada ï¿½ de uma
				// composicao
				// (faz parte de uma composta)
				// então temos que definir como disciplina a ser estudada pelo
				// aluno, a disciplina da composicao
				// fornecida como parametro. Lembrando, que uma disciplina de
				// uma composicao nunca poderá ser
				// uma GrupoOptativa, pois informa-se manualmente as disciplinas
				// da composicao. Ou seja, uma disciplina
				// de um grupoOptativa poderá ser composta, mas a disciplina que
				// faz parte de uma composicao nunca
				// poderá ser de grupoOptativa.
				if (disciplinaCompostaVO.getNovoObj()) {
					throw new Exception("Disciplina sendo incluída como parte de uma Composição (Disciplina Composta), contudo, não existe uma Disciplina Composta definida.");
				}
				matriculaPeriodoTumaDisciplina.setDisciplina(disciplinaCompostaVO.getDisciplina());
				matriculaPeriodoTumaDisciplina.setDisciplinaFazParteComposicao(disciplinaDeUmaComposicao);
				matriculaPeriodoTumaDisciplina.setDisciplinaOptativa(false);
				matriculaPeriodoTumaDisciplina.setGradeDisciplinaCompostaVO(disciplinaCompostaVO);
				matriculaPeriodoTumaDisciplina.setGradeDisciplinaVO(null);
				matriculaPeriodoTumaDisciplina.setGradeCurricularGrupoOptativaDisciplinaVO(disciplinaCompostaVO.getGradeCurricularGrupoOptativaDisciplina());
					TurmaDisciplinaVO turmaDisciplinaVO = getFacadeFactory().getTurmaDisciplinaFacade().consultarPorTurmaDisciplina(turma.getCodigo(), disciplinaCompostaVO.getDisciplinaMaeComposicao().getCodigo(), false, null);
				matriculaPeriodoTumaDisciplina.setModalidadeDisciplina(turmaDisciplinaVO.getModalidadeDisciplina());
			} else {
				// TRATANDO QUANDO REFERE-SE A DISCIPLINA DE UMA GRUPO DE
				// OPTATIVA
				if (disciplinaReferenteAUmGrupoOptativa) {
					matriculaPeriodoTumaDisciplina.setDisciplinaReferenteAUmGrupoOptativa(true);
					// Se for por equivalencia, então os dados referentes a
					// equivalencia já foi gravado.
					// Mesmo que este equivalencia esteja sendo cursada para
					// fechar um mapa de equivalencia
					// que cubra (referencie) uma disciplina de um grupo de
					// optativa da matriz, isto será resolvido
					// por meio dos históricos que seráo gerenciados quando o
					// mapa de equivalencia for atendido.
					if (gradeCurricularGrupoOptativaDisciplinaVO.getCodigo().equals(0)) {
						throw new Exception("Disciplina sendo incluída de um Grupo de Eletivas, contudo, não existe uma Grupo de Eletivas definido.");
					}
					matriculaPeriodoTumaDisciplina.setDisciplinaOptativa(true);
					matriculaPeriodoTumaDisciplina.setGradeCurricularGrupoOptativaDisciplinaVO(gradeCurricularGrupoOptativaDisciplinaVO);
					matriculaPeriodoTumaDisciplina.setDisciplina(gradeCurricularGrupoOptativaDisciplinaVO.getDisciplina());
				}
			}
		}
		verificarDisciplinaAlunoAdaptacao(matriculaPeriodoTumaDisciplina, matricula, matriculaPeriodo);
		verificarAlunoDependenciaDisciplinaComBaseEmHistoricosAnteriores(matriculaPeriodoTumaDisciplina, matricula, matriculaPeriodo);
		realizarVerificacaoPermissaoExclusaoDisciplina(matricula, matriculaPeriodo, matriculaPeriodoTumaDisciplina, usuario);
		
		matriculaPeriodoTumaDisciplina.setConfiguracaoAcademicoVO(getFacadeFactory().getConfiguracaoAcademicoFacade().realizarDefinicaoConfiguracaoAcademicaVincularHistoricoAluno(matricula.getCurso(), 
				matriculaPeriodoTumaDisciplina.getGradeDisciplinaVO(), matriculaPeriodoTumaDisciplina.getGradeCurricularGrupoOptativaDisciplinaVO(), 
				matriculaPeriodoTumaDisciplina.getGradeDisciplinaCompostaVO(), matriculaPeriodoTumaDisciplina.getTurma(), matriculaPeriodoTumaDisciplina.getAno(), matriculaPeriodoTumaDisciplina.getSemestre(), usuario));
		return matriculaPeriodoTumaDisciplina;
	}

	/**
	 * Criar uma MatriculaPeriodoTurmaDisciplina com base na GradeDisciplinaVO,
	 * ignorando aspectos como GrupoOptativas e as afins.
	 * 
	 * @param obj
	 * @param matriculaPeriodo
	 * @param matricula
	 * @param turma
	 * @param nrVagas
	 * @throws Exception
	 * @deprecated depreciado na versao 5.0
	 */
	public void criarMatriculaPeriodoTurmaDisciplina(GradeDisciplinaVO obj, MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matricula, TurmaVO turma, Integer nrVagas, UsuarioVO usuario) throws Exception {
		MatriculaPeriodoTurmaDisciplinaVO novoObj = gerarMatriculaPeriodoTurmaDisciplinaVOValidado(obj, false, // indica
				// se
				// a
				// disciplina
				// será
				// cursada
				// por
				// meio
				// de
				// um
				// mapa
				// de
				// equivalencia
				null, // indica a qual mapa de equivalencia de disciplina estão
				// sendo criado o objeto
				null, // indica a qual disciplina do mapa de equivalencia o
				// aluno irá cursar nesta
				// MatriculaPeriodoTurmaDisciplina
				false, null, false, // indica que o aluno foi liberado para
				// estudar a disciplina, mesmo com choque de
				// horário com outras disciplinas de sua
				// turma
				false, // se a principal, trata-se de uma composicao, o metodo
				// que adiciona a MatriculaPEriodoTurmaDisciplina irá
				// tratar esta situacao
				null, obj.getModalidadeDisciplina(), matriculaPeriodo, matricula, matriculaPeriodo.getTurma(), null, null, usuario);
		try {
			validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(matriculaPeriodo, matricula, false, false, novoObj, usuario);			
			matriculaPeriodo.getMatriculaPeriodoTumaDisciplinaVOs().add(novoObj);
		} catch (Exception e) {
		}
	}

	public Boolean verificarAlunoAprovadoDisciplina(Integer disciplina, Integer transferencia, String matricula, MatriculaPeriodoVO matriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List obj = new ArrayList(0);
		if (transferencia == 0) {
			obj = consultarHistoricoAlunoDisciplina(matricula, disciplina, configuracaoFinanceiroVO, usuario);
		} else {
			obj = getFacadeFactory().getHistoricoFacade().consultarPorMatriculaDisciplinaAproveitamento(matricula, disciplina, "AP", false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
			if (obj.isEmpty()) {
				obj = getFacadeFactory().getTransferenciaEntradaDisciplinasAproveitadasFacade().consultarPorDisciplinaETransferencia(disciplina, transferencia, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			}
		}
		if (obj.isEmpty()) {
			return false;
		}
		return true;
	}

	public Boolean verificarAlunoAprovadoTodosPreRequisitos(List listaPreRequisitos, String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		Iterator i = listaPreRequisitos.iterator();
		while (i.hasNext()) {
			DisciplinaPreRequisitoVO obj = (DisciplinaPreRequisitoVO) i.next();
			List hist = consultarHistoricoAlunoDisciplina(matricula, obj.getCodigo(), configuracaoFinanceiroVO, usuario);
			if (hist.isEmpty()) {
				return false;
			}
		}
		return true;
	}

	public List consultarHistoricoAlunoDisciplina(String matricula, Integer disciplina, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		// List hist =
		// getFacade().getHistorico().consultarPorMatriculaDisciplinaSituacao(matricula,
		// disciplina, "AP", false, Uteis.NIVELMONTARDADOS_DADOSBASICOS);
		List hist = getFacadeFactory().getHistoricoFacade().consultarPorMatriculaDisciplinasAprovadas(matricula, disciplina, false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		return hist;
	}

	/**
	 * Operação Responsável por consultar todos os
	 * <code>MatriculaPeriodoVO</code> relacionados a um objeto da classe
	 * <code>academico.Matricula</code>.
	 * 
	 * @param matricula
	 *            Atributo de <code>academico.Matricula</code> a ser utilizado
	 *            para localizar os objetos da classe
	 *            <code>MatriculaPeriodoVO</code>.
	 * @return List Contendo todos os objetos da classe
	 *         <code>MatriculaPeriodoVO</code> resultantes da consulta.
	 * @exception Exception
	 *                Erro de conexão com o BD ou restrição de acesso a esta
	 *                operação.
	 */
	public List consultarMatriculaPeriodos(String matricula, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		MatriculaPeriodo.consultar(getIdEntidade(), controlarAcesso, usuario);
		List objetos = new ArrayList(0);
		String sql = "SELECT * FROM MatriculaPeriodo WHERE matricula = ? ORDER BY codigo";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql, new Object[] { matricula });
		MatriculaPeriodoVO obj = null;
		while (tabelaResultado.next()) {
			objetos.add(montarDados(tabelaResultado, obj, nivelMontarDados, configuracaoFinanceiroVO, usuario));
		}
		return objetos;
	}
	
	public List<MatriculaPeriodoVO> consultarMatriculaPeriodosComContrato(String matricula, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario, Boolean trazerApenasUltimoContratoMatricula) throws Exception {
		MatriculaPeriodo.consultar(getIdEntidade(), controlarAcesso, usuario);
		List<MatriculaPeriodoVO> objetos = new ArrayList<>(0);
		StringBuilder sql = new StringBuilder("");
		sql.append(" select MatriculaPeriodo.situacaomatriculaperiodo, MatriculaPeriodo.situacao, MatriculaPeriodo.codigo, MatriculaPeriodo.ano, MatriculaPeriodo.semestre, MatriculaPeriodo.matricula, MatriculaPeriodo.turma, ");
		sql.append(" COALESCE(MatriculaPeriodo.contratoMatricula, curso.textopadraocontratomatriculacalouro) contratomatricula, ");
		sql.append(" COALESCE(MatriculaPeriodo.contratofiador, planofinanceirocurso.textopadraocontratofiador) contratofiador, ");
		sql.append(" (MatriculaPeriodo.contratoMatricula is null and curso.textopadraocontratomatriculacalouro is not null) gravarContratoMatricula, ");
		sql.append(" (MatriculaPeriodo.contratoFiador is null and planofinanceirocurso.textopadraocontratofiador is not null) gravarContratoFiador,  ");
		sql.append(" textopadraomatricula.descricao as textopadraomatricula, ");
		sql.append(" textopadraofiador.descricao as textopadraofiador, ");
		sql.append(" textopadraomatricula.tipo as textopadraomatricula_tipo, ");
		sql.append(" textopadraofiador.tipo as textopadraofiador_tipo, matricula.bloqueioPorSolicitacaoLiberacaoMatricula ");
		sql.append(" from MatriculaPeriodo ");	
		sql.append(" inner join matricula on MatriculaPeriodo.matricula = matricula.matricula ");
		sql.append(" inner join curso on matricula.curso = curso.codigo ");
		sql.append(" inner join turma on MatriculaPeriodo.turma = turma.codigo ");
		sql.append(" inner join unidadeensinocurso on MatriculaPeriodo.unidadeensinocurso = unidadeensinocurso.codigo ");
		sql.append(" left join planofinanceirocurso on planofinanceirocurso.codigo =  case when MatriculaPeriodo.planofinanceirocurso is not null then MatriculaPeriodo.planofinanceirocurso ");
		sql.append(" else case when turma.planofinanceirocurso is not null then turma.planofinanceirocurso else unidadeensinocurso.planofinanceirocurso end end ");
		sql.append(" left join textopadrao as textopadraomatricula on textopadraomatricula.codigo = COALESCE(MatriculaPeriodo.contratoMatricula, curso.textopadraocontratomatriculacalouro) ");
		sql.append(" left join textopadrao as textopadraofiador on textopadraofiador.codigo = COALESCE(MatriculaPeriodo.contratofiador, planofinanceirocurso.textopadraocontratofiador) ");
		sql.append(" where matriculaperiodo.situacaomatriculaperiodo != 'PC' ");
		sql.append(" and MatriculaPeriodo.matricula = ?  ");		
		sql.append(" order by MatriculaPeriodo.ano, MatriculaPeriodo.semestre, MatriculaPeriodo.codigo limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), new Object[] { matricula });
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO matriculaPeriodoVO = new MatriculaPeriodoVO();
			matriculaPeriodoVO.setCodigo(tabelaResultado.getInt("codigo"));
			matriculaPeriodoVO.setSituacaoMatriculaPeriodo(tabelaResultado.getString("situacaomatriculaperiodo"));
			matriculaPeriodoVO.setSituacao(tabelaResultado.getString("situacao"));
			matriculaPeriodoVO.setMatricula(tabelaResultado.getString("matricula"));
			matriculaPeriodoVO.getMatriculaVO().setMatricula(tabelaResultado.getString("matricula"));
			matriculaPeriodoVO.setAno(tabelaResultado.getString("ano"));
			matriculaPeriodoVO.setSemestre(tabelaResultado.getString("semestre"));
			matriculaPeriodoVO.getContratoMatricula().setCodigo(tabelaResultado.getInt("contratoMatricula"));
			matriculaPeriodoVO.getContratoMatricula().setDescricao(tabelaResultado.getString("textopadraomatricula"));
			matriculaPeriodoVO.getContratoMatricula().setTipo(tabelaResultado.getString("textopadraomatricula_tipo"));
			matriculaPeriodoVO.getContratoFiador().setCodigo(tabelaResultado.getInt("contratoFiador"));
			matriculaPeriodoVO.getContratoFiador().setDescricao(tabelaResultado.getString("textopadraofiador"));
			matriculaPeriodoVO.getContratoFiador().setTipo(tabelaResultado.getString("textopadraofiador_tipo"));
			matriculaPeriodoVO.setGravarContratoFiador(tabelaResultado.getBoolean("gravarContratoFiador"));
			matriculaPeriodoVO.setGravarContratoMatricula(tabelaResultado.getBoolean("gravarContratoMatricula"));
			matriculaPeriodoVO.getTurma().setCodigo(tabelaResultado.getInt("turma"));
			matriculaPeriodoVO.getMatriculaVO().setBloqueioPorSolicitacaoLiberacaoMatricula(tabelaResultado.getBoolean("bloqueioPorSolicitacaoLiberacaoMatricula"));
			matriculaPeriodoVO.setNovoObj(false);
			objetos.add(matriculaPeriodoVO);
		}
		return objetos;
	}

	/**
	 * Operação Responsável por localizar um objeto da classe
	 * <code>MatriculaPeriodoVO</code> através de sua chave primária.
	 * 
	 * @exception Exception
	 *                Caso haja problemas de conexão ou localização do objeto
	 *                procurado.
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public MatriculaPeriodoVO consultarPorChavePrimaria(Integer codigoPrm, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		String sqlStr = "SELECT * FROM MatriculaPeriodo WHERE codigo = ?";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr, new Object[] { codigoPrm });
		boolean teste = tabelaResultado.next();
		if (!teste) {
			throw new ConsistirException("Dados Não Encontrados (Matrícula Período) - " + codigoPrm);
		}
		MatriculaPeriodoVO obj = null;
		return (montarDados(tabelaResultado, obj, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public MatriculaPeriodoVO consultarPorCodigo(Integer codigoPrm, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		String sqlStr = "SELECT * FROM MatriculaPeriodo WHERE codigo = ?";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr, new Object[] { codigoPrm });
		if (!tabelaResultado.next()) {
			return new MatriculaPeriodoVO();
		}
		MatriculaPeriodoVO obj = null;
		return (montarDados(tabelaResultado, obj, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List<MatriculaPeriodoVO> consultarPorUnidadeCursoTurmaAlunoEntreDatasSituacao(Integer unidadeEnsino, Integer curso, Integer turma, String aluno, Date dataInicio, Date dataFim, String situacao, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		String filtro = "";
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT * FROM matriculaperiodo ");
		sqlStr.append("INNER JOIN turma ON matriculaperiodo.turma = turma.codigo ");
		sqlStr.append("INNER JOIN curso ON turma.curso = curso.codigo ");
		sqlStr.append("INNER JOIN unidadeensino ON turma.unidadeensino = unidadeensino.codigo WHERE ");
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append("unidadeEnsino = ").append(unidadeEnsino).append(" ");
			filtro = "AND";
		}
		if (curso != null && curso != 0) {
			sqlStr.append("curso = ").append(curso.intValue()).append(" ");
			filtro = "AND";
		}
		if (turma != null && turma != 0) {
			sqlStr.append("turma = ").append(turma.intValue()).append(" ");
			filtro = "AND";
		}
		if (aluno != null && !aluno.equals("")) {
			sqlStr.append("matricula = '").append(aluno).append("' ");
			filtro = "AND";
		}
		if (dataInicio != null) {
			sqlStr.append(filtro).append(" matriculaperiodo.data >= '").append(dataInicio).append("' ");
			filtro = "AND";
		}
		if (dataFim != null) {
			sqlStr.append(filtro).append(" matriculaperiodo.data <= '").append(dataFim).append("' ");
			filtro = "AND";
		}
		if (situacao != null && !situacao.equals("")) {
			sqlStr.append(filtro).append(" matriculaperiodo.situacaomatriculaperiodo = '").append(situacao).append("'");
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List<MatriculaPeriodoVO> consultarPorUnidadeCursoTurmaAluno(Integer unidadeEnsino, Integer curso, Integer turma, String aluno, boolean bloqueioFinanceiro, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT * FROM matriculaperiodo ");
		sqlStr.append("INNER JOIN turma ON matriculaperiodo.turma = turma.codigo ");
		sqlStr.append("INNER JOIN curso ON turma.curso = curso.codigo ");
		sqlStr.append("INNER JOIN unidadeensino ON turma.unidadeensino = unidadeensino.codigo WHERE ");
		if (unidadeEnsino != null && unidadeEnsino != 0) {
			sqlStr.append("unidadeEnsino = ").append(unidadeEnsino).append(" ");
		}
		if (curso != null && curso != 0) {
			sqlStr.append("curso = ").append(curso.intValue()).append(" ");
		}
		if (turma != null && turma != 0) {
			sqlStr.append("turma = ").append(turma.intValue()).append(" ");
		}
		if (aluno != null && !aluno.equals("")) {
			sqlStr.append("matricula = '").append(aluno).append("' ");
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			return null;
		}
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	public List<MatriculaPeriodoVO> consultarPorNomeCursoNomeTurmaAnoSemestre(String nomeCurso, String nomeTurma, String ano, String semestre, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT * FROM matriculaperiodo ");
		sqlStr.append("INNER JOIN turma ON matriculaperiodo.turma = turma.codigo ");
		sqlStr.append("INNER JOIN curso ON turma.curso = curso.codigo ");
		sqlStr.append("WHERE curso.nome = '").append(nomeCurso).append("' AND turma.identificadorTurma = '").append(nomeTurma).append("' ");
		if (!ano.equals("")) {
			sqlStr.append("AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sqlStr.append("AND matriculaperiodo.semestre = '").append(semestre).append("' ");
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsulta(tabelaResultado, nivelMontarDados, configuracaoFinanceiroVO, usuario));
	}

	/**
	 * Operação reponsóvel por retornar o identificador desta classe. Este
	 * identificar ï¿½ utilizado para verificar as permissóes de acesso as
	 * operações desta classe.
	 */
	public static String getIdEntidade() {
		return MatriculaPeriodo.idEntidade;
	}

	/**
	 * Operação reponsóvel por definir um novo valor para o identificador desta
	 * classe. Esta alteração deve ser possível, pois, uma mesma classe de
	 * negócio pode ser utilizada com objetivos distintos. Assim ao se verificar
	 * que Como o controle de acesso ï¿½ realizado com base neste identificador,
	 */
	public void setIdEntidade(String idEntidade) {
		MatriculaPeriodo.idEntidade = idEntidade;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void emitirBoletoMatricula(MatriculaPeriodoVO obj, UsuarioVO usuarioResponsavel, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		ControleAcesso.verificarPermissaoUsuarioFuncionalidade("Matricula_EmitirBoletoMatricula", usuarioResponsavel);
		obj.setDataEmissaoBoletoMatricula(new Date());
		obj.setResponsavelEmissaoBoletoMatricula(usuarioResponsavel);
		getFacadeFactory().getContaReceberFacade().validarDadosParaImpressaoBoletos(TipoBoletoBancario.MATRICULA, usuarioResponsavel, configuracaoFinanceiroVO);

		String sql = "UPDATE MatriculaPeriodo set dataEmissaoBoletoMatricula=?, responsavelEmissaoBoletoMatricula=? WHERE ((codigo = ?))" + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioResponsavel);
		getConexao().getJdbcTemplate().update(sql, new Object[] { Uteis.getDataJDBC(obj.getDataEmissaoBoletoMatricula()), obj.getResponsavelEmissaoBoletoMatricula().getCodigo(), obj.getCodigo() });

		getFacadeFactory().getContaReceberFacade().alterarBooleanEmissaoBoletoRealizada(obj.getMatriculaPeriodoVencimentoReferenteMatricula().getContaReceber().getCodigo(), true, usuarioResponsavel);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void excluirContaReceberGeradasParaMatricula(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		getFacadeFactory().getContaReceberFacade().excluirContasReceberTipoOrigemCodigoOrigem("MAT", matriculaPeriodoVO.getCodigo(), "AR", !matriculaPeriodoVO.verificarBloqueioCompetenciaFoiLiberado(), usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void excluirContaReceberGeradasParaMensalidade(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		getFacadeFactory().getContaReceberFacade().excluirContasReceberTipoOrigemCodigoOrigem("MEN", matriculaPeriodoVO.getCodigo(), "AR", !matriculaPeriodoVO.verificarBloqueioCompetenciaFoiLiberado(), usuario);
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void excluirContaReceberGeradasParaMaterialDidatico(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		getFacadeFactory().getContaReceberFacade().excluirContasReceberTipoOrigemCodigoOrigem(TipoOrigemContaReceber.MATERIAL_DIDATICO.getValor(), matriculaPeriodoVO.getCodigo(), "AR", !matriculaPeriodoVO.verificarBloqueioCompetenciaFoiLiberado(), usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	private void excluirContaReceberGeradasParaConvenios(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		getFacadeFactory().getContaReceberFacade().excluirContasReceberTipoOrigemCodigoOrigem("BCC", matriculaPeriodoVO.getCodigo(), "AR", !matriculaPeriodoVO.verificarBloqueioCompetenciaFoiLiberado(), usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void inicializarPlanoFinanceiroAlunoMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, PlanoFinanceiroAlunoVO planoFinanceiroAlunoVO, boolean forcaTrocaContrato, UsuarioVO usuario) throws Exception {
		MatriculaPeriodo.montarDadosPlanoFinanceiroCurso(matriculaPeriodoVO, NivelMontarDados.TODOS, usuario);
		MatriculaPeriodo.montarDadosCondicaoPagamentoPlanoFinanceiroCurso(matriculaPeriodoVO, NivelMontarDados.TODOS, usuario);
		matriculaVO.getPlanoFinanceiroAluno().setDescontoProgressivoMatricula(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getDescontoProgressivoPadraoMatricula());
		matriculaVO.getPlanoFinanceiroAluno().setDescontoProgressivo(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getDescontoProgressivoPadrao());
		matriculaVO.getPlanoFinanceiroAluno().setDescontoProgressivoPrimeiraParcela(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getDescontoProgressivoPrimeiraParcela());
		if (matriculaVO.getPlanoFinanceiroAluno().getJustificativa().equals("")) {
			matriculaVO.getPlanoFinanceiroAluno().setJustificativa("Desconto Progressivo Padrão do Curso");
		}
		matriculaVO.getPlanoFinanceiroAluno().setPlanoFinanceiroCursoVO(matriculaPeriodoVO.getPlanoFinanceiroCurso());
		matriculaVO.getPlanoFinanceiroAluno().setResponsavel(usuario);
		// matriculaVO.getPlanoFinanceiroAluno().setDescontoProgressivo(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getDescontoProgressivoPadrao());
		matriculaVO.getPlanoFinanceiroAluno().setCondicaoPagamentoPlanoFinanceiroCursoVO(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso());
		// matriculaPeriodoVO.setContratoMatricula(matriculaPeriodoVO.getPlanoFinanceiroCurso().getTextoPadraoContratoMatricula());
		getFacadeFactory().getMatriculaFacade().inicializarTextoContratoPlanoFinanceiroAluno(matriculaVO, matriculaPeriodoVO, forcaTrocaContrato, usuario);
		//matriculaPeriodoVO.setContratoFiador(matriculaPeriodoVO.getPlanoFinanceiroCurso().getTextoPadraoContratoFiador());

		if ((matriculaVO.getMatriculaJaRegistrada()) && (!matriculaVO.getPlanoFinanceiroAluno().getCodigo().equals(0))) {
			if (matriculaVO.getMatriculaJaRegistrada() && matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getZerarValorDescontoPlanoFinanceiroAluno() && matriculaPeriodoVO.getCodigo().equals(0)) {
				matriculaVO.getPlanoFinanceiroAluno().setPercDescontoMatricula(0.0);
				matriculaVO.getPlanoFinanceiroAluno().setPercDescontoParcela(0.0);
				matriculaVO.getPlanoFinanceiroAluno().setValorDescontoMatricula(0.0);
				matriculaVO.getPlanoFinanceiroAluno().setValorDescontoParcela(0.0);
				/*
				 * O Rodrigo Jayme Wind comentou este porque os descontos
				 * progressivos da condição de pagamento do plano financeiro do
				 * curso setados nas linhas 7438, 7439 e 7440 estavam sendo
				 * zeradas abaixo, portanto não estavam sendo aplicados os
				 * decontos nas parcelas da nova matricula Período, acredito que
				 * o procedimento de zerar os descontos só deveriam ser
				 * aplicados para descontos da instituição, convênios e
				 * descontos do aluno.
				 */
				// matriculaVO.getPlanoFinanceiroAluno().setDescontoProgressivoMatricula(new
				// DescontoProgressivoVO());
				// matriculaVO.getPlanoFinanceiroAluno().setDescontoProgressivo(new
				// DescontoProgressivoVO());
				// matriculaVO.getPlanoFinanceiroAluno().setDescontoProgressivoPrimeiraParcela(new
				// DescontoProgressivoVO());
				/**
				 * Este foi comentado pois não estava zerando os decontos de
				 * convenio
				 */
				// getFacadeFactory().getPlanoFinanceiroAlunoFacade().excluirObjItemPlanoFinanceiroPlanoDescontoAlunoVOs(matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs());
				matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs().clear();
			} else if (matriculaVO.getMatriculaJaRegistrada() && !matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getZerarValorDescontoPlanoFinanceiroAluno() && matriculaPeriodoVO.getCodigo().equals(0)) {
				getFacadeFactory().getPlanoFinanceiroAlunoFacade().excluirObjItemPlanoFinanceiroAlunoConfiguradoRemoverRenovacao(matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs());
				
			}
			if (!matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getCondicaoPagamentoPlanoDescontoVOs().isEmpty() && matriculaPeriodoVO.getCodigo().equals(0)) {
				if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getUtilizarDescInstituicaoPlanoFinanceiroCursoConfiguracaoAtual()) {
					if (!matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs().isEmpty()) {
						getFacadeFactory().getPlanoFinanceiroAlunoFacade().excluirObjItemPlanoFinanceiroPlanoDescontoAlunoVOs(matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs());
					}
					for (CondicaoPagamentoPlanoDescontoVO condicaoPagamentoPlanoDescontoVO : matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getCondicaoPagamentoPlanoDescontoVOs()) {
						ItemPlanoFinanceiroAlunoVO itemPlanoAluno = new ItemPlanoFinanceiroAlunoVO();
						itemPlanoAluno.setTipoItemPlanoFinanceiro("PD");
						itemPlanoAluno.setPlanoDesconto(condicaoPagamentoPlanoDescontoVO.getPlanoDescontoVO());						
						getFacadeFactory().getPlanoFinanceiroAlunoFacade().adicionarObjItemPlanoFinanceiroAlunoVOs(matriculaVO.getPlanoFinanceiroAluno(), itemPlanoAluno);
					}
				}
				if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getUtilizarOrdemDescontoConfiguracaoFinanceira()) {
					definirOrdemDescontoConfiguracaoFinanceira(matriculaVO, matriculaPeriodoVO, usuario);
				}
			}

			if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getAcrescentarDescInstPlanoFinanCursoRenovAlemExistPlanoFinanAluno() && !matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getUtilizarDescInstituicaoPlanoFinanceiroCursoConfiguracaoAtual()) {

				if (!matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getCondicaoPagamentoPlanoDescontoVOs().isEmpty() && matriculaPeriodoVO.getCodigo().equals(0)) {
					for (CondicaoPagamentoPlanoDescontoVO condicaoPagamentoPlanoDescontoVO : matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getCondicaoPagamentoPlanoDescontoVOs()) {
						ItemPlanoFinanceiroAlunoVO itemPlanoAluno = new ItemPlanoFinanceiroAlunoVO();
						itemPlanoAluno.setTipoItemPlanoFinanceiro("PD");
						itemPlanoAluno.setPlanoDesconto(condicaoPagamentoPlanoDescontoVO.getPlanoDescontoVO());						
						getFacadeFactory().getPlanoFinanceiroAlunoFacade().adicionarObjItemPlanoFinanceiroAlunoVOs(matriculaVO.getPlanoFinanceiroAluno(), itemPlanoAluno);
					}

				}
			}
			return;
		}

		/**
		 * Alterado para que seja definido a ordem dos descontos quando for uma
		 * nova matrícula período.
		 */
		if (matriculaPeriodoVO.getCodigo().equals(0)) {
			if (!matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getCondicaoPagamentoPlanoDescontoVOs().isEmpty()) {
				for (CondicaoPagamentoPlanoDescontoVO condicaoPagamentoPlanoDescontoVO : matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getCondicaoPagamentoPlanoDescontoVOs()) {
					ItemPlanoFinanceiroAlunoVO itemPlanoAluno = new ItemPlanoFinanceiroAlunoVO();
					itemPlanoAluno.setTipoItemPlanoFinanceiro("PD");
					itemPlanoAluno.setPlanoDesconto(condicaoPagamentoPlanoDescontoVO.getPlanoDescontoVO());					
					getFacadeFactory().getPlanoFinanceiroAlunoFacade().adicionarObjItemPlanoFinanceiroAlunoVOs(matriculaVO.getPlanoFinanceiroAluno(), itemPlanoAluno);
				}
			}
			definirOrdemDescontoConfiguracaoFinanceira(matriculaVO, matriculaPeriodoVO, usuario);
		}

		// TODO (SEI CA37.1) Adicionado para garantir que a matrícula
		// periodo no
		// plano financeiro do aluno seja sempre diferente.
		matriculaVO.getPlanoFinanceiroAluno().setMatriculaPeriodo(matriculaPeriodoVO.getCodigo());

	}

	private void definirOrdemDescontoConfiguracaoFinanceira(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		montarDadosConfiguracaoFinanceiro(matriculaPeriodoVO, matriculaVO.getUnidadeEnsino().getCodigo(), usuario);
		matriculaVO.getPlanoFinanceiroAluno().setOrdemConvenio(matriculaPeriodoVO.getConfiguracaoFinanceiro().getOrdemConvenio());
		matriculaVO.getPlanoFinanceiroAluno().setOrdemConvenioValorCheio(matriculaPeriodoVO.getConfiguracaoFinanceiro().getOrdemConvenioValorCheio());
		matriculaVO.getPlanoFinanceiroAluno().setOrdemDescontoAluno(matriculaPeriodoVO.getConfiguracaoFinanceiro().getOrdemDescontoAluno());
		matriculaVO.getPlanoFinanceiroAluno().setOrdemDescontoAlunoValorCheio(matriculaPeriodoVO.getConfiguracaoFinanceiro().getOrdemDescontoAlunoValorCheio());
		matriculaVO.getPlanoFinanceiroAluno().setOrdemDescontoProgressivo(matriculaPeriodoVO.getConfiguracaoFinanceiro().getOrdemDescontoProgressivo());
		matriculaVO.getPlanoFinanceiroAluno().setOrdemDescontoProgressivoValorCheio(matriculaPeriodoVO.getConfiguracaoFinanceiro().getOrdemDescontoProgressivoValorCheio());
		matriculaVO.getPlanoFinanceiroAluno().setOrdemPlanoDesconto(matriculaPeriodoVO.getConfiguracaoFinanceiro().getOrdemPlanoDesconto());
		matriculaVO.getPlanoFinanceiroAluno().setOrdemPlanoDescontoValorCheio(matriculaPeriodoVO.getConfiguracaoFinanceiro().getOrdemPlanoDescontoValorCheio());
	}

	public void inicializarDescontoProgressivoPadraoMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO) throws Exception {
		if ((matriculaPeriodoVO == null) || (matriculaVO == null)) {
			throw new Exception("Dados da matrícula não disponíveis para determinar Desconto Progressivo Padrão!");
		}
		// ConfiguracaoFinanceiroVO configuracaoFinanceiro =
		// getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarConfiguracaoASerUsada(Uteis.NIVELMONTARDADOS_DADOSBASICOS,
		// usuario, null);
		DescontoProgressivoVO descontoProgressivo = null;
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getDescontoProgressivoPadrao().getCodigo().intValue() != 0) {
			descontoProgressivo = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getDescontoProgressivoPadrao();
		} else if (configuracaoFinanceiroVO.getDescontoProgressivoPadrao().getCodigo().intValue() != 0) {
			descontoProgressivo = configuracaoFinanceiroVO.getDescontoProgressivoPadrao();
		}
		matriculaVO.getPlanoFinanceiroAluno().setDescontoProgressivo(descontoProgressivo);
	}

	/**
	 * Método Responsável por determinar se estamos tratanto de uma
	 * pré-matricula ou de uma matrícula de fato. A pré-matrícula ocorre quando
	 * estamos matriculando um aluno, em periodo letivo futuro, isto, enquanto
	 * atualmente estão rolando outro Período letivo. Por exemplo, estamos no
	 * meio do Período letivo 1/2010 e estamos registrando uma matrícula periodo
	 * para 2/2010. Neste caso, estamos fazendo uma pré-matrícula. Outro aspecto
	 * importante a ser considerado, refere-se ao tipo de curso. Cursos de
	 * pï¿½s-graduaï¿½ï¿½o, por exemplo, não estãoo vinculados a calendï¿½rios
	 * letivos fixos- cada turma tem um inï¿½cio e um termï¿½no variï¿½vel, não
	 * podendo ser caracterizado por um processo especï¿½fico.
	 */
	public void definirSituacaoMatriculaPeriodoComBaseProcesso(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		matriculaPeriodoVO.getProcessoMatriculaVO().setCodigo(matriculaPeriodoVO.getProcessoMatricula());
		if (!matriculaPeriodoVO.getProcessoMatriculaVO().getNivelMontarDados().equals(NivelMontarDados.BASICO) && !matriculaPeriodoVO.getProcessoMatriculaVO().getNivelMontarDados().equals(NivelMontarDados.TODOS)) {
			matriculaPeriodoVO.setProcessoMatriculaVO(getFacadeFactory().getProcessoMatriculaFacade().consultarPorChavePrimaria(matriculaPeriodoVO.getProcessoMatricula(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
			matriculaPeriodoVO.getProcessoMatriculaVO().setNivelMontarDados(NivelMontarDados.BASICO);
		}
		if (Uteis.isAtributoPreenchido(matriculaPeriodoVO) && matriculaPeriodoVO.getProcessoMatriculaVO().getSituacao().equals("PR") && matriculaPeriodoVO.getSituacaoMatriculaPeriodo().equals("AT")
				&& ((Uteis.isAtributoPreenchido(matriculaVO.getMatricula()) && verificarMatriculaDeCalouro(matriculaVO.getMatricula(), matriculaPeriodoVO.getCodigo(), Boolean.FALSE, usuario)) || (!Uteis.isAtributoPreenchido(matriculaVO.getMatricula())))
				&& (!Uteis.isAtributoPreenchido(matriculaVO.getTransferenciaEntrada()))
				&& ((Uteis.isAtributoPreenchido(matriculaVO.getMatricula()) && !realizarValidacaoRegraAtivacaoMatriculaPorEntregaDocumentoEContratoMatricula(matriculaVO.getMatricula(), usuario)) || (!Uteis.isAtributoPreenchido(matriculaVO.getMatricula())))) {
			matriculaPeriodoVO.setSituacaoMatriculaPeriodo("PR");
		} else if (matriculaPeriodoVO.getProcessoMatriculaVO().getSituacao().equals("PR") && matriculaPeriodoVO.getSituacao().equals("PF")) {
			matriculaPeriodoVO.setSituacaoMatriculaPeriodo("PR");
		} else {
			matriculaPeriodoVO.setSituacaoMatriculaPeriodo("AT");
		}
		if ((matriculaPeriodoVO.isSituacaoAtiva()) && (matriculaVO.getSituacao().equals("PR"))) {
			matriculaVO.setSituacao("AT");
		}
	}

	public void validarMatriculaPeriodoPodeSerAtivada(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
//		if (matriculaPeriodoVO.isSituacaoAtiva()) {
//			throw new Exception("Esta matrícula já estão ativa, portanto não pode ser ativada novamente.");
//		}
		if ((!matriculaVO.getSituacao().equals("AT")) && (!matriculaVO.getSituacao().equals("PR"))) {
			throw new Exception("A matrícula " + matriculaVO.getMatricula() + " estão em uma situação " + matriculaVO.getSituacao_Apresentar() + " que não permite Ativação.");
		}
		// if (!matriculaVO.getCurso().utilizaProcessoMatriculaCalendario()) {
		// if ((!matriculaPeriodoVO.getTurma().getCodigo().equals(0)) &&
		// (matriculaPeriodoVO.getTurma().getTurmaPreMatricula())) {
		// throw new Exception("A matrícula " + matriculaVO.getMatricula() +
		// " não pode ser ativada, pois estão vinculada a uma turma que estão definida para receber somente pré-matrículas. Altere o cadastro de turma antes de tentar ativar a matrícula.");
		// }
		// }
		// } else {
		// ProcessoMatriculaVO processo =
		// getFacadeFactory().getProcessoMatriculaFacade().consultarPorChavePrimaria(matriculaPeriodoVO.getProcessoMatricula(),
		// Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario);
		// if (processo.getSituacao().equals("PR")) {
		// throw new Exception("A matrícula " + matriculaVO.getMatricula() +
		// " não pode ser ativada, pois o Processo de Matrícula (" +
		// processo.getDescricao() +
		// ") ainda estão registrado com a situação pré-matrícula.");
		// }
		// }

		// List contaReceberVencidas =
		// getFacadeFactory().getContaReceberFacade().consultarPorAlunoEMatriculaContasReceberVencidas(matriculaVO.getAluno().getCodigo(),
		// matriculaVO.getMatricula(), Uteis.NIVELMONTARDADOS_DADOSBASICOS,
		// configuracaoFinanceiro, usuario);
		// if (!contaReceberVencidas.isEmpty()) {
		// boolean
		// possuiDebitosDeMatriculaPeriodoDiferentesAoQueEstaSendoAtivado =
		// false;
		// Iterator i = contaReceberVencidas.iterator();
		// while (i.hasNext()) {
		// ContaReceberVO conta = (ContaReceberVO) i.next();
		// if
		// (!conta.getCodOrigem().equals(String.valueOf(matriculaPeriodoVO.getCodigo())))
		// {
		// possuiDebitosDeMatriculaPeriodoDiferentesAoQueEstaSendoAtivado =
		// true;
		// }
		// }
		// if (possuiDebitosDeMatriculaPeriodoDiferentesAoQueEstaSendoAtivado) {
		// throw new Exception("A matrícula " + matriculaVO.getMatricula() +
		// " não pode ser ativada, pois o aluno possui pendï¿½ncias financeiras (contas a receber vencidas).");
		// }
		// }

	}

	public MatriculaPeriodoVO obterNovoMatriculaPeriodoBaseadoUltimoPeriodoLetivo(MatriculaVO matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		MatriculaPeriodoVO novo = new MatriculaPeriodoVO();
		if ((matricula == null) || (matricula.getMatriculaPeriodoVOs().isEmpty())) {
			return novo;
		}
		MatriculaPeriodoVO ultimoPeriodoLetivo = matricula.getUltimoMatriculaPeriodoVO();
		if (ultimoPeriodoLetivo != null && ultimoPeriodoLetivo.getCodigo() != 0) {
			getFacadeFactory().getMatriculaPeriodoFacade().carregarDados(ultimoPeriodoLetivo, NivelMontarDados.TODOS, configuracaoFinanceiroVO, usuario);
//			novo.setContratoMatricula(ultimoPeriodoLetivo.getContratoMatricula());
//			novo.setContratoFiador(ultimoPeriodoLetivo.getContratoFiador());
//			novo.setContratoExtensao(ultimoPeriodoLetivo.getContratoExtensao());
			novo.setPlanoFinanceiroCurso(ultimoPeriodoLetivo.getPlanoFinanceiroCurso());
			// novo.setGradeCurricular(ultimoPeriodoLetivo.getGradeCurricular());
			novo.setGradeCurricular(matricula.getGradeCurricularAtual());
			novo.setConfiguracaoFinanceiro(ultimoPeriodoLetivo.getConfiguracaoFinanceiro());
			novo.setMatricula(ultimoPeriodoLetivo.getMatricula());
			novo.setUnidadeEnsinoCurso(ultimoPeriodoLetivo.getUnidadeEnsinoCurso());
			novo.setValorBaseDescontoConvenioMatricula(ultimoPeriodoLetivo.getValorBaseDescontoConvenioMatricula());
			novo.setValorBaseDescontoConvenioMensalidade(ultimoPeriodoLetivo.getValorBaseDescontoConvenioMensalidade());
			novo.setValorDescontoMatricula(ultimoPeriodoLetivo.getValorDescontoMatricula());
			novo.setValorDescontoMensalidade(ultimoPeriodoLetivo.getValorDescontoMensalidade());
			novo.setValorDescontoInstituicaoMatricula(ultimoPeriodoLetivo.getValorDescontoInstituicaoMatricula());
			novo.setValorDescontoInstituicaoMensalidade(ultimoPeriodoLetivo.getValorDescontoInstituicaoMensalidade());
			novo.setValorDescontoConvenioMatricula(ultimoPeriodoLetivo.getValorDescontoConvenioMatricula());
			novo.setValorDescontoConvenioMensalidade(ultimoPeriodoLetivo.getValorDescontoConvenioMensalidade());
			if (configuracaoFinanceiroVO.getRealizarMatriculaComFinanceiroManualAtivo()) {
				novo.setFinanceiroManual(configuracaoFinanceiroVO.getRealizarMatriculaComFinanceiroManualAtivo());
			}
			// Integer nrUltimoPeriodo =
			// ultimoPeriodoLetivo.getNrPeriodoLetivo();
			// montarDadosGradeCurricular(novo, NivelMontarDados.BASICO,
			// usuario);
			// Integer nrPeriodosLetivos =
			// novo.getGradeCurricular().getUltimoPeriodoLetivoGrade().getPeriodoLetivo();
			// if (nrUltimoPeriodo < nrPeriodosLetivos) {
			//
			// if (matricula.getCurso().getConfiguracaoAcademico().getCodigo() >
			// 0) {
			// matricula.getCurso().setConfiguracaoAcademico(getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(matricula.getCurso().getConfiguracaoAcademico().getCodigo(),
			// usuario));
			// }
			// if (matricula.getCurso().getConfiguracaoAcademico().getCodigo() >
			// 0
			// &&
			// matricula.getCurso().getConfiguracaoAcademico().getNumeroDisciplinaConsiderarReprovadoPeriodoLetivo()
			// > 0
			// &&
			// !matricula.getCurso().getConfiguracaoAcademico().getPermiteEvoluirPeriodoLetivoCasoReprovado()
			// &&
			// getFacadeFactory().getHistoricoFacade().consultaNumeroDisciplinasReprovadasAlunoMaiorPermitido(ultimoPeriodoLetivo.getCodigo(),
			// matricula.getMatricula(),
			// ultimoPeriodoLetivo.getPeridoLetivo().getPeriodoLetivo(),
			// matricula.getCurso().getConfiguracaoAcademico().getNumeroDisciplinaConsiderarReprovadoPeriodoLetivo(),
			// usuario)) {
			// //nrUltimoPeriodo = nrPeriodosLetivos;
			// } else {
			// nrUltimoPeriodo++;
			// }
			// } else {
			// nrUltimoPeriodo = nrPeriodosLetivos; // ultimo periodo...
			// }
			// PeriodoLetivoVO periodoLetivoAdotar =
			// novo.getGradeCurricular().consultarObjPeriodoLetivoVO(nrUltimoPeriodo);
			// novo.setPeridoLetivo(periodoLetivoAdotar);
		}
		return novo;
	}

	/**
	 * 
	 * @param matricula
	 * @param matriculaPeriodoVO
	 * @param usuario
	 * @deprecated - utilizar novo Método a partir da versão 5.0 -
	 *             obterListaPeriodosLetivosValidosParaRenovacaoMatriculaInicializandoPeriodoLetivoPadrao
	 */
	public void definirPeriodoLetivoNovaMatriculaAluno(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		montarDadosGradeCurricular(matriculaPeriodoVO, NivelMontarDados.FORCAR_RECARGATODOSOSDADOS, usuario);
		matriculaPeriodoVO.setPeridoLetivo(matriculaPeriodoVO.getGradeCurricular().getPrimeiroPeriodoLetivoGrade());
	}

	/**
	 * @param obj
	 * @throws ConsistirException
	 * @throws Exception
	 */
	public void validarJaExisteMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO obj, UsuarioVO usuario) throws ConsistirException, Exception {
		List<MatriculaPeriodoVO> listaMatriculaPeriodosExistentes = matriculaVO.getMatriculaPeriodoVOs();
		// matriculaVO.getCurso().setConfiguracaoAcademico(getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPorChavePrimaria(matriculaVO.getCurso().getConfiguracaoAcademico().getCodigo(),
		// usuario));
		boolean novoMatriculaPeriodo = false;
		if (obj.getCodigo().equals(0)) {
			novoMatriculaPeriodo = true;
		} else {
			// Se não ï¿½ nova, ï¿½ por que trata-se de uma alteração. Como não
			// ï¿½
			// possível
			// alterar o Período letivo de matriculaperiodo, não existe a
			// possibilidade
			// do usuario de registrar uma matriculaperiodo pré-existente, como
			// um
			// outro periodo letivo no qual o aluno já foi matriculado.
			return;
		}
		boolean matriculaUltimoPeriodo = false;
		// montarDadosGradeCurricular(obj, NivelMontarDados.TODOS, usuario);
		PeriodoLetivoVO ultimoPeriodo = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getUltimoPeriodoLetivoGrade();
		if (obj.getPeridoLetivo().getCodigo().equals(ultimoPeriodo.getCodigo())) {
			matriculaUltimoPeriodo = true;
		}

		// MatriculaPeriodoVO registroMatriculaNoMesmoPeriodoPreExistente =
		// null;
		// MatriculaPeriodoVO
		// registroMatriculaNoMesmoPeriodoPreExistentePreMatricula = null;
		Integer codigoUltimaMatriculaPeriodo = 0;
		if (listaMatriculaPeriodosExistentes.size() > 0) {
			codigoUltimaMatriculaPeriodo = listaMatriculaPeriodosExistentes.get(listaMatriculaPeriodosExistentes.size() - 1).getCodigo();
		}
		// Verificar se o aluno já foi matrícula neste mesmo Período letivo
		Boolean jaExisteOutraMatriculaPeriodoParaOPeriodoLetivoAtual = false;
		for (MatriculaPeriodoVO matriculaPeriodoAntigas : listaMatriculaPeriodosExistentes) {
			if (matriculaPeriodoAntigas.getPeridoLetivo().getPeriodoLetivo().equals(obj.getPeridoLetivo().getPeriodoLetivo()) && matriculaPeriodoAntigas.getSituacaoMatriculaPeriodo().equals("AT")) {
				jaExisteOutraMatriculaPeriodoParaOPeriodoLetivoAtual = true;
			}
		}
		// Verificar se o aluno estão avanï¿½ando de Período letivo
		Boolean alunoEstaAvancandoDePeriodoLetivo = false;
		if (obj.getPeridoLetivo().getPeriodoLetivo().compareTo(ultimoPeriodo.getPeriodoLetivo()) > 0) {
			alunoEstaAvancandoDePeriodoLetivo = true;
		}
		MatriculaPeriodoVO ultimaMatriculaPeriodoVO = matriculaVO.getUltimoMatriculaPeriodoVO();
		if (obj.getPeridoLetivo().getPeriodoLetivo().compareTo(ultimaMatriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo()) > 0) {
			alunoEstaAvancandoDePeriodoLetivo = true;
		}
		// Verificar se ï¿½ para realizar o controle se a Matricula Pode avancar
		// para o proximo periodo letivo
		// em decorrencia de disciplinas reprovadas.
		Boolean alunoAptoParaAvancarProximoPeriodoLetivoComBaseDisciplinasReprovadas = getFacadeFactory().getMatriculaFacade().executarValidarMatriculaAptaAvancarPeriodoLetivo(matriculaVO, codigoUltimaMatriculaPeriodo, obj.getPeridoLetivo(), usuario);
		if ((alunoEstaAvancandoDePeriodoLetivo) && (!alunoAptoParaAvancarProximoPeriodoLetivoComBaseDisciplinasReprovadas) && !matriculaVO.getLiberarMatriculaTodosPeriodos()) {
			throw new Exception("Aluno não pode avançar de periodo letivo, pois ultrapassou o limite de disciplinas que podem ser reprovadas em um Período letivo.");
		}

		if ((jaExisteOutraMatriculaPeriodoParaOPeriodoLetivoAtual) && (alunoAptoParaAvancarProximoPeriodoLetivoComBaseDisciplinasReprovadas) && (!matriculaUltimoPeriodo)) {
			throw new Exception("já existe uma renovação realizada neste periodo letivo para este aluno. Informe outro periodo letivo para continuar com esta renovação.");
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarMatriculaPeriodoFinanceiroManual(MatriculaPeriodoVO matriculaPeriodoVo, Integer responsavel, Boolean financeiroManual) throws Exception {
		String sql = "UPDATE MatriculaPeriodo set financeiroManual=?, responsavelAtivacaoFinanceiroManual = ?, dataAtivacaoFinanceiroManual=?  WHERE ((codigo = ?))";
		getConexao().getJdbcTemplate().update(sql, new Object[] { financeiroManual, responsavel, new Date(), matriculaPeriodoVo.getCodigo() });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void mudarMatriculaPeridoFinanceiroParaManual(MatriculaPeriodoVO matriculaPeriodoVo, Integer responsavel) throws Exception {
		if (!matriculaPeriodoVo.getFinanceiroManual()) {
			alterarMatriculaPeriodoFinanceiroManual(matriculaPeriodoVo, responsavel, true);
		}
	}

	public Boolean getPermitirGerarContaReceber(MatriculaPeriodoVO matriculaPeriodoVo) throws Exception {
		if (!matriculaPeriodoVo.getFinanceiroManual()) {
			// "VC" - Gerar as Parcelas somente apï¿½s o Pagto da Matrícula
			// "AM" - Gerar Todas as Parcelas no Ato da Matrícula
			// "FC" - Gerar as Parcelas Mï¿½s a Mï¿½s
			if ((matriculaPeriodoVo.getPlanoFinanceiroCurso().getModeloGeracaoParcelas().equals("VC") && matriculaPeriodoVo.getMatriculaJaPaga()) || (matriculaPeriodoVo.getPlanoFinanceiroCurso().getModeloGeracaoParcelas().equals("AM")) || (matriculaPeriodoVo.getPlanoFinanceiroCurso().getModeloGeracaoParcelas().equals("FC"))) {
				return true;
			} else {
				return false;
			}
		} else {
			return false;
		}
	}

	public Boolean verificarMatriculaPeriodoPossuiContasReceberParaGerar(Integer codMatriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List matriculaPeriodoVencimentoVOs = getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarMatriculaPeriodoVencimentoVOsSituacao(codMatriculaPeriodo, "NG", false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, configuracaoFinanceiroVO, usuario);
		if (!matriculaPeriodoVencimentoVOs.isEmpty()) {
			return true;
		} else {
			return false;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void executarFinalizarMatriculaPeriodo(MatriculaPeriodoVO matriculaPeriodoVO, OrigemFechamentoMatriculaPeriodoEnum origemFechamentoMatriculaPeriodoEnum, Integer codigoOrigemFechamentoMatriculaPeriodo) throws Exception {
		try {
			// matriculaPeriodoVO.getTurma().setCodigo(0);
			matriculaPeriodoVO.setSituacaoMatriculaPeriodo("FI");
			getFacadeFactory().getMatriculaPeriodoFacade().alterarSituacaoMatriculaPeriodo(matriculaPeriodoVO, origemFechamentoMatriculaPeriodoEnum, codigoOrigemFechamentoMatriculaPeriodo, new Date());
			// List matriculaPeriodoTurmaVO =
			// getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarMatriculaPeriodoTurmaDisciplinas(matriculaPeriodoVO.getCodigo(),
			// false, Uteis.NIVELMONTARDADOS_DADOSBASICOS);
			// getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().retirarReservaTurmaDisciplina(matriculaPeriodoTurmaVO);
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void executarFinalizarMatriculaPeriodoTrancamento(MatriculaPeriodoVO matriculaPeriodoVO, OrigemFechamentoMatriculaPeriodoEnum origemFechamentoMatriculaPeriodoEnum, Integer codigoOrigemFechamentoMatriculaPeriodo, UsuarioVO usuario) throws Exception {
		try {
			// matriculaPeriodoVO.getTurma().setCodigo(0);
			matriculaPeriodoVO.setSituacaoMatriculaPeriodo("FI");
			getFacadeFactory().getMatriculaPeriodoFacade().alterarSituacaoMatriculaPeriodo(matriculaPeriodoVO, origemFechamentoMatriculaPeriodoEnum, codigoOrigemFechamentoMatriculaPeriodo, new Date());
			List matriculaPeriodoTurmaVO = getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarMatriculaPeriodoTurmaDisciplinas(matriculaPeriodoVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().retirarReservaTurmaDisciplina(matriculaPeriodoTurmaVO, usuario);
		} catch (Exception e) {
			throw e;
		}
	}

	public void verificarPreRequisitoDisciplina(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, Boolean permitirUsuaroRealizarMatriculaComDisciplinaPreRequisito, UsuarioVO usuario) throws Exception {
		if (!matriculaVO.getMatricula().equals("")) {
			Boolean permiteCursarDisciplinaEPreRequisito = getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPermissaoCursarDisciplinaPreRequisito(matriculaVO.getCurso().getConfiguracaoAcademico().getCodigo(), usuario);
			if (!permiteCursarDisciplinaEPreRequisito && !permitirUsuaroRealizarMatriculaComDisciplinaPreRequisito) {
				verificarDisciplinasPreRequisitoNaoCumpridasDaGrade(matriculaPeriodoVO, usuario);
				executarVerificacaoPermiteCursarDisciplinaEPreRequisito(permiteCursarDisciplinaEPreRequisito, matriculaPeriodoVO, matriculaVO, usuario);
			}
		}
	}

	public void verificarDisciplinasPreRequisitoNaoCumpridasDaGrade(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinas = matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs();
		for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : listaMatriculaPeriodoTurmaDisciplinas) {
			List<DisciplinaVO> listaDisciplinasPreRequisitosVOs = new ArrayList<DisciplinaVO>(0);
			listaDisciplinasPreRequisitosVOs = getFacadeFactory().getDisciplinaFacade().consultarDisciplinasPreRequisitoNaoCumpridasConsiderandoMapaEquivalenciaDisciplina(matriculaPeriodoTurmaDisciplinaVO.getDisciplina(), 
					matriculaPeriodoVO.getMatricula(), matriculaPeriodoVO.getGradeCurricular().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getMapaEquivalenciaDisciplinaVOIncluir(), usuario);
			if (Uteis.isAtributoPreenchido(listaDisciplinasPreRequisitosVOs)) {
				matriculaPeriodoTurmaDisciplinaVO.setDisciplinasPreRequisito(true);
				matriculaPeriodoTurmaDisciplinaVO.setListaDisciplinasPreRequisitos(new ArrayList<>(0));
			}
			for (DisciplinaVO disciplinaVO : listaDisciplinasPreRequisitosVOs) {
				DisciplinaVO disciplinaVO2 = getFacadeFactory().getDisciplinaFacade().consultarPeriodoLetivoDisciplinaPreRequisito(matriculaPeriodoVO.getGradeCurricular().getCodigo(), disciplinaVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				if (Uteis.isAtributoPreenchido(disciplinaVO2)) {
					matriculaPeriodoTurmaDisciplinaVO.getListaDisciplinasPreRequisitos().add(disciplinaVO2);
				}
			}
		}
		matriculaPeriodoVO.setMatriculaPeriodoTumaDisciplinaVOs(listaMatriculaPeriodoTurmaDisciplinas);
	}

	public void validarDadosDisciplinaEPreRequisito(DisciplinaVO disciplinaVO, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception {
		Boolean liberarPreRequisitoDisciplinaConcomitante = getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPermissaoPreRequisitoDisciplinaConcomitante(matriculaVO.getCurso().getConfiguracaoAcademico().getCodigo(), usuarioVO);
		validarDadosDisciplinaEPreRequisito(disciplinaVO, matriculaVO, matriculaPeriodoVO, liberarPreRequisitoDisciplinaConcomitante, null, usuarioVO);
	}

	public void validarDadosDisciplinaEPreRequisito(DisciplinaVO disciplinaVO, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, Boolean liberarPreRequisitoDisciplinaConcomitante, MapaEquivalenciaDisciplinaVO mapaEquivalenciaDisciplinaVO, UsuarioVO usuarioVO) throws Exception {
//		try {
//			matriculaPeriodoVO.setMensagemAvisoUsuario(new ConsistirException(""));
//			List<DisciplinaVO> listaDisciplinasPreRequisitosVOs = getFacadeFactory().getDisciplinaFacade().consultarDisciplinasPreRequisitoNaoCumpridasConsiderandoMapaEquivalenciaDisciplina(disciplinaVO, matriculaVO.getMatricula(), matriculaVO.getGradeCurricularAtual().getCodigo(), mapaEquivalenciaDisciplinaVO, usuarioVO);
//			if (Uteis.isAtributoPreenchido(listaDisciplinasPreRequisitosVOs)) {
//				if (liberarPreRequisitoDisciplinaConcomitante) {
//					for (DisciplinaVO disciplinaPreRequisito : listaDisciplinasPreRequisitosVOs) {
//						if (validarPreRequisitosDisciplinas(matriculaVO, disciplinaPreRequisito, matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs(), mapaEquivalenciaDisciplinaVO)) {
//							matriculaPeriodoVO.getMensagemAvisoUsuario().adicionarListaMensagemErro("A disciplina " + disciplinaVO.getNome().toUpperCase() + " não foi adicionada pois existem pré-requisitos não cursados. " + listaDisciplinasPreRequisitosVOs.toString() + "");
//							throw new Exception("Essa disciplina possui pré-requisitos não cumpridos pelo aluno, por isso não pode ser incluída. Pré-requisitos pendentes: " + listaDisciplinasPreRequisitosVOs.toString() + ".");
//						}
//					}
//				} else {
//					matriculaPeriodoVO.getMensagemAvisoUsuario().adicionarListaMensagemErro("A disciplina " + disciplinaVO.getNome().toUpperCase() + " não foi adicionada pois existem pré-requisitos não cursados. " + listaDisciplinasPreRequisitosVOs.toString() + "");
//					throw new Exception("Essa disciplina possui pré-requisitos não cumpridos pelo aluno, por isso não pode ser incluída. Pré-requisitos pendentes: " + listaDisciplinasPreRequisitosVOs.toString() + ".");
//				}
//			}
//		} catch (Exception e) {
//			ConsistirException horarioException = new ConsistirException(e.getMessage());
//			horarioException.setReferentePreRequisito(true);
//			throw horarioException;
//		}
	}

	public void executarVerificacaoPermiteCursarDisciplinaEPreRequisito(Boolean permiteCursarDisciplinaEPreRequisito, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinaVO = new ArrayList(0);
		listaMatriculaPeriodoTurmaDisciplinaVO.addAll(matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs());
		if (permiteCursarDisciplinaEPreRequisito) {
			return;
		}
		for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : listaMatriculaPeriodoTurmaDisciplinaVO) {
			if (matriculaPeriodoTurmaDisciplinaVO.getLiberarInclusaoDisciplinaPreRequisito()) {
				continue;
			}
			if (Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getListaDisciplinasPreRequisitos())) {
				if (getFacadeFactory().getConfiguracaoAcademicoFacade().consultarPermissaoPreRequisitoDisciplinaConcomitante(matriculaVO.getCurso().getConfiguracaoAcademico().getCodigo(), usuario)) {
					for (DisciplinaVO disciplinaPreRequisito : matriculaPeriodoTurmaDisciplinaVO.getListaDisciplinasPreRequisitos()) {
						if (validarPreRequisitosDisciplinas(matriculaVO, disciplinaPreRequisito, listaMatriculaPeriodoTurmaDisciplinaVO, matriculaPeriodoTurmaDisciplinaVO.getMapaEquivalenciaDisciplinaVOIncluir())) {
							throw mensagemErroTratadaDisciplinaPreRequisito(matriculaPeriodoTurmaDisciplinaVO);
						}
					}
				} else {
					throw mensagemErroTratadaDisciplinaPreRequisito(matriculaPeriodoTurmaDisciplinaVO);
				}
			}
		}

		// if (permiteCursarDisciplinaEPreRequisito) {
		// for (MatriculaPeriodoTurmaDisciplinaVO
		// matriculaPeriodoTurmaDisciplinaVO :
		// listaMatriculaPeriodoTurmaDisciplinaVO) {
		// List<DisciplinaVO> disciplinasPreRequisito =
		// matriculaPeriodoTurmaDisciplinaVO.getListaDisciplinasPreRequisitos();
		// if (!disciplinasPreRequisito.isEmpty()) {
		// listaDisciplinasPreRequisitos.addAll(disciplinasPreRequisito);
		// }
		// }
		// if (!listaDisciplinasPreRequisitos.isEmpty()) {
		// for (DisciplinaVO disciplinaPreRequisito :
		// listaDisciplinasPreRequisitos) {
		// controleDisciplinas = 0;
		// for (MatriculaPeriodoTurmaDisciplinaVO
		// matriculaPeriodoTurmaDisciplinaVoPreRequisito :
		// listaMatriculaPeriodoTurmaDisciplinaVO) {
		// if
		// (matriculaPeriodoTurmaDisciplinaVoPreRequisito.getDisciplina().getCodigo().intValue()
		// == disciplinaPreRequisito.getCodigo().intValue()) {
		// break;
		// }
		// controleDisciplinas++;
		// if (controleDisciplinas ==
		// listaMatriculaPeriodoTurmaDisciplinaVO.size()) {
		// throw new
		// ConsistirException("Algumas Disciplinas possuem pré-requisitos pendentes!");
		// }
		// }
		// }
		// }
		// } else {
		// for (MatriculaPeriodoTurmaDisciplinaVO
		// matriculaPeriodoTurmaDisciplinaVO :
		// listaMatriculaPeriodoTurmaDisciplinaVO) {
		// if (matriculaPeriodoTurmaDisciplinaVO.getDisciplinasPreRequisito()) {
		// throw new
		// ConsistirException("Algumas Disciplinas possuem pré-requisitos pendentes!");
		// }
		// }
		// }
	}

	public void verificarDisciplinasAprovadasDaGrade(MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinas = matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs();
		for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : listaMatriculaPeriodoTurmaDisciplinas) {
			if (matriculaPeriodoTurmaDisciplinaVO.getDisciplinaAprovada()) {
				throw new ConsistirException("Algumas Disciplinas já foram cursadas e aprovadas!");
			}
		}
	}

	public List<MatriculaPeriodoVO> montarDadosConsultaBasica(SqlRowSet tabelaResultado) throws Exception {
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			montarDadosBasico(obj, tabelaResultado);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<MatriculaPeriodoVO> montarDadosConsultaBasicaEspecificoRenovacaoPorTurma(SqlRowSet tabelaResultado, String aprovadosSemestre, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			montarDadosBasico(obj, tabelaResultado);
			if (aprovadosSemestre.equals("somenteapro")) {
				if (!verificarDisciplinasPendentes(obj.getMatricula(), configuracaoFinanceiro, usuario)) {
					vetResultado.add(obj);
				}
			} else {
				vetResultado.add(obj);
			}
		}
		return vetResultado;
	}

	public boolean verificarDisciplinasPendentes(String matricula, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		List<DisciplinaVO> listaDisciplinasGrade = getFacadeFactory().getDisciplinaFacade().consultarDisciplinasDaGradeCurricularCursoPorMatriculaTipoDisciplina(matricula, "OB", "LG", false, Uteis.NIVELMONTARDADOS_PROCESSAMENTO, usuario);
		List<HistoricoVO> listaDisciplinaHistorico = getFacadeFactory().getHistoricoFacade().consultarDisciplinasDoHistoricoPorMatriculaTipoDisciplinaSituacao(matricula, "'AP', 'AA', 'CC', 'CH', 'IS', 'AB', 'AE'", "OB", "LG", false, Uteis.NIVELMONTARDADOS_PROCESSAMENTO, configuracaoFinanceiroVO, usuario);

		boolean disciplinaAchada = false;

		for (DisciplinaVO disciplina : listaDisciplinasGrade) {
			for (HistoricoVO historico : listaDisciplinaHistorico) {
				if (Uteis.isAtributoPreenchido(historico.getDisciplina().getCodigo()) && historico.getDisciplina().getCodigo().intValue() == disciplina.getCodigo().intValue()) {
					disciplinaAchada = true;
					break;
				}
			}
			if (!disciplinaAchada) {
				return true;
			} else {
				disciplinaAchada = false;
			}
		}
		return false;
	}

	private SqlRowSet consultaRapidaPorChavePrimariaDadosBasicos(Integer codigo, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (MatriculaPeriodo.codigo=").append(codigo).append(")");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			throw new ConsistirException("Dados Não Encontrados.");
		}
		return tabelaResultado;
	}

	private SqlRowSet consultaRapidaPorChavePrimariaDadosCompletos(Integer codigo, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE (MatriculaPeriodo.codigo= ").append(codigo).append(")");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			throw new ConsistirException("Dados Não Encontrados (Matricula Período).");
		}
		return tabelaResultado;
	}

	public void carregarDados(MatriculaPeriodoVO obj, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		carregarDados((MatriculaPeriodoVO) obj, NivelMontarDados.BASICO, configuracaoFinanceiroVO, usuario);
	}

	
	public void carregarDados(MatriculaPeriodoVO obj, NivelMontarDados nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		SqlRowSet resultado = null;
		if (obj.getIsDadosBasicosDevemSerCarregados(nivelMontarDados)) {
			resultado = consultaRapidaPorChavePrimariaDadosBasicos(obj.getCodigo(), usuario);
			montarDadosBasico(obj, resultado);
		}
		if (obj.getIsDadosCompletosDevemSerCarregados(nivelMontarDados)) {
			resultado = consultaRapidaPorChavePrimariaDadosCompletos(obj.getCodigo(), usuario);
			montarDadosCompleto(obj, resultado, configuracaoFinanceiroVO, usuario);
		}
	}

	public MatriculaPeriodoVO consultarMatriculaPorCpfAlunoTurma(String cpf, Integer turma, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder("SELECT matricula.matricula, matriculaperiodo.codigo FROM matricula ")
			.append("INNER JOIN pessoa ON matricula.aluno = pessoa.codigo ")
			.append("INNER JOIN matriculaperiodo ON matriculaperiodo.matricula = matricula.matricula ")
			.append("WHERE matriculaperiodo.turma = ? ")
			.append("AND regexp_replace(pessoa.cpf, '\\D', '', 'g') = ? ")
			.append("ORDER BY matriculaperiodo.codigo LIMIT 1 ");		
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] {turma, Uteis.retirarMascaraCPF(cpf)});
		MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			obj.getMatriculaVO().setMatricula(tabelaResultado.getString("matricula"));
			obj.setCodigo(tabelaResultado.getInt("codigo"));
		}
		return obj;
	}

	public void carregarDadosConsultorUsuarioResp(MatriculaVO matri, MatriculaPeriodoVO obj, UsuarioVO usuario) throws Exception {
		if (Uteis.isAtributoPreenchido(obj.getCodigo())) {
			StringBuffer sqlStr = new StringBuffer();
			sqlStr.append(" select usuario.nome as responsavelrenovacaomatricula , pessoa.nome as consultor, pessoa.rg as rgConsultor  from matriculaperiodo ");
			sqlStr.append("       inner join matricula on matricula.matricula = matriculaperiodo.matricula ");
			sqlStr.append("       left join usuario on usuario.codigo = matriculaperiodo.responsavelrenovacaomatricula  ");
			sqlStr.append("       left join funcionario on funcionario.codigo = matricula.consultor ");
			sqlStr.append("       left join pessoa on pessoa.codigo = funcionario.pessoa ");
			sqlStr.append(" WHERE (MatriculaPeriodo.codigo=").append(obj.getCodigo()).append(")");
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			if (!tabelaResultado.next()) {
				throw new ConsistirException("Dados Não Encontrados (Consultor / Responsável).");
			}
			matri.getConsultor().getPessoa().setNome(tabelaResultado.getString("consultor"));
			matri.getConsultor().getPessoa().setRG(tabelaResultado.getString("rgConsultor"));			
			obj.getResponsavelRenovacaoMatricula().setNome(tabelaResultado.getString("responsavelrenovacaomatricula"));
		}
	}
	
	private StringBuffer getSQLPadraoConsultaMinima() {
		StringBuffer str = new StringBuffer();
		str.append("SELECT distinct MatriculaPeriodo.situacao, MatriculaPeriodo.matricula, ");
		str.append("       Matricula.matricula as \"Matricula.matricula\", ");
		str.append("       Matricula.situacao as \"Matricula.situacao\", Matricula.situacaoFinanceira as \"Matricula.situacaoFinanceira\", Matricula.alunoConcluiuDisciplinasRegulares as \"Matricula.alunoConcluiuDisciplinasRegulares\",");
		str.append("       Pessoa.nome as \"Pessoa.nome\", Pessoa.cpf as \"Pessoa.cpf\", ");
		str.append("       Curso.nome as \"Curso.nome\", Curso.codigo as \"Curso.codigo\", Curso.nivelEducacional as \"Curso.nivelEducacional\", ");
		str.append("       UnidadeEnsino.codigo as \"UnidadeEnsino.codigo\", UnidadeEnsino.nome as \"UnidadeEnsino.nome\" ");
		str.append(" FROM MatriculaPeriodo ");
		str.append("      INNER JOIN Matricula ON (MatriculaPeriodo.matricula = Matricula.matricula) ");
		str.append("      INNER JOIN Pessoa ON (Matricula.aluno = pessoa.codigo) ");
		str.append("      INNER JOIN UnidadeEnsino ON (Matricula.unidadeEnsino = unidadeEnsino.codigo) ");
		str.append("      INNER JOIN Curso ON (Matricula.curso = curso.codigo) ");
		str.append("      INNER JOIN PeriodoLetivo ON (MatriculaPeriodo.periodoLetivoMatricula = PeriodoLetivo.codigo) ");
		str.append("      INNER JOIN turma ON matriculaperiodo.turma = turma.codigo  ");
		return str;
	}

	private StringBuffer getSQLPadraoConsultaMinima2() {
		StringBuffer str = new StringBuffer();
		str.append("SELECT distinct MatriculaPeriodo.situacao, MatriculaPeriodo.matricula, ");
		str.append("       Matricula.matricula as \"Matricula.matricula\", Matricula.data as \"Matricula.data\",");
		str.append("       Matricula.situacao as \"Matricula.situacao\", Matricula.situacaoFinanceira as \"Matricula.situacaoFinanceira\", Matricula.alunoConcluiuDisciplinasRegulares as \"Matricula.alunoConcluiuDisciplinasRegulares\",");
		str.append("       Pessoa.nome as \"Pessoa.nome\", Pessoa.cpf as \"Pessoa.cpf\", ");
		str.append("       Curso.nome as \"Curso.nome\", Curso.codigo as \"Curso.codigo\", Curso.nivelEducacional as \"Curso.nivelEducacional\", ");
		str.append("       UnidadeEnsino.codigo as \"UnidadeEnsino.codigo\", UnidadeEnsino.nome as \"UnidadeEnsino.nome\", ");
		str.append("       Turma.codigo as \"Turma.codigo\", Turma.identificadorTurma as \"Turma.identificadorTurma\" ");
		str.append(" FROM MatriculaPeriodo ");
		str.append("      INNER JOIN Matricula ON (MatriculaPeriodo.matricula = Matricula.matricula) ");
		str.append("      INNER JOIN Pessoa ON (Matricula.aluno = pessoa.codigo) ");
		str.append("      INNER JOIN UnidadeEnsino ON (Matricula.unidadeEnsino = unidadeEnsino.codigo) ");
		str.append("      INNER JOIN Curso ON (Matricula.curso = curso.codigo) ");
		str.append("      INNER JOIN PeriodoLetivo ON (MatriculaPeriodo.periodoLetivoMatricula = PeriodoLetivo.codigo) ");
		str.append("      INNER JOIN turma ON matriculaperiodo.turma = turma.codigo  ");
		return str;
	}

	private StringBuffer getSQLPadraoConsultaBasica() {
		StringBuffer str = new StringBuffer();
		str.append("SELECT COUNT(*) OVER() as totalRegistroConsulta,MatriculaPeriodo.codigo, MatriculaPeriodo.data, MatriculaPeriodo.dataVencimentoMatriculaEspecifico, MatriculaPeriodo.dataBaseGeracaoParcelas, MatriculaPeriodo.situacao, MatriculaPeriodo.matricula, MatriculaPeriodo.alunoTransferidoUnidade, matriculaPeriodo.financeiroManual, matriculaPeriodo.transferenciaEntrada ,  ");
		str.append("       MatriculaPeriodo.situacaoMatriculaPeriodo, MatriculaPeriodo.semestre, MatriculaPeriodo.ano, MatriculaPeriodo.carneEntregue, matriculaPeriodo.responsavelrenovacaomatricula,  ");
		str.append("       MatriculaPeriodo.unidadeEnsinoCurso, MatriculaPeriodo.processoMatricula, MatriculaPeriodo.gradecurricular, GradeCurricular.nome AS \"gradeCurricular.nome\", MatriculaPeriodo.bolsista, ");
		str.append("       MatriculaPeriodo.turma, Turma.identificadorturma as \"turma.identificadorturma\", Turma.observacao as \"turma.observacao\", ");
		str.append("       MatriculaPeriodo.matriculaEspecial, MatriculaPeriodo.planofinanceirocurso, MatriculaPeriodo.condicaoPagamentoplanofinanceirocurso, planofinanceirocurso.descricao as \"planofinanceirocurso.descricao\", MatriculaPeriodo.motivoliberacaopgtomatricula, ");
		str.append("       MatriculaPeriodo.periodoLetivoMatricula, PeriodoLetivo.descricao as \"PeriodoLetivo.descricao\", PeriodoLetivo.periodoLetivo as \"PeriodoLetivo.periodoLetivo\",  ");
		str.append("       Matricula.matricula as \"Matricula.matricula\", Matricula.gradeCurricularAtual as \"Matricula.gradeCurricularAtual\", Matricula.data as \"Matricula.data\", Matricula.matriculaSuspensa as \"Matricula.matriculaSuspensa\", Matricula.updated as \"Matricula.updated\", ");
		str.append("       Matricula.turno as \"Matricula.turno\", Turno.nome as \"Turno.nome\", ");
		str.append("       Matricula.situacao as \"Matricula.situacao\", Matricula.situacaoFinanceira as \"Matricula.situacaoFinanceira\", Matricula.alunoConcluiuDisciplinasRegulares as \"Matricula.alunoConcluiuDisciplinasRegulares\",");
		str.append("       Pessoa.nome as \"Pessoa.nome\", Pessoa.codigo as \"Pessoa.codigo\", Pessoa.cpf as \"Pessoa.cpf\",  Pessoa.registroAcademico as \"Pessoa.registroAcademico\" ,");
		str.append("       Curso.nome as \"Curso.nome\", Curso.codigo as \"Curso.codigo\", Curso.nivelEducacional as \"Curso.nivelEducacional\", ");
		str.append("       UnidadeEnsino.codigo as \"UnidadeEnsino.codigo\", UnidadeEnsino.nome as \"UnidadeEnsino.nome\", Matricula.naoEnviarMensagemCobranca as \"Matricula.naoEnviarMensagemCobranca\", ");
		str.append("       turnoPeriodo.codigo AS \"turnoPeriodo.codigo\", turnoPeriodo.nome AS \"turnoPeriodo.nome\", ");
		str.append("       gradeCurricularAtual.codigo AS \"gradeCurricularAtual.codigo\", gradeCurricularAtual.nome AS \"gradeCurricularAtual.nome\",gradeCurricularAtual.considerarperiodotrancadoparajubilamento AS \"gradeCurricularAtual.considerarperiodotrancadoparajubilamento\", ");
		str.append("       ProcessoMatricula.codigo AS \"ProcessoMatricula.codigo\", ProcessoMatricula.descricao AS \"ProcessoMatricula.descricao\", ");
		str.append("       condicaopagamentoplanofinanceirocurso.descricao AS \"condicaopagamentoplanofinanceirocurso.descricao\", matricula.canceladofinanceiro, MatriculaPeriodo.categoriaCondicaoPagamento, ");
		str.append("       uec.codigo AS \"uec.codigo\", uec.unidadeEnsino AS \"uec.unidadeEnsino\", uec.curso AS \"uec.curso\",  Matricula.bloqueioPorSolicitacaoLiberacaoMatricula as \"Matricula.bloqueioPorSolicitacaoLiberacaoMatricula\", Matricula.motivoMatriculaBloqueada as \"Matricula.motivoMatriculaBloqueada\",  ");
		str.append(" 	   (SELECT mp.codigo FROM matriculaperiodo as mp WHERE mp.matricula = matricula.matricula ORDER BY mp.ano || '/' || mp.semestre DESC, mp.codigo DESC LIMIT 1) as ultimaMatriculaPeriodo, ");
		str.append(" 	   exists (select pendenciaLiberacaoMatricula.codigo from pendenciaLiberacaoMatricula where pendenciaLiberacaoMatricula.matricula = matricula.matricula AND pendenciaLiberacaoMatricula.situacao = 'PENDENTE' limit 1 ) as existePendenciaLiberacao ");
		str.append("       FROM MatriculaPeriodo ");
		str.append("      INNER JOIN Matricula ON (MatriculaPeriodo.matricula = Matricula.matricula) ");

		str.append("      INNER JOIN Pessoa ON (Matricula.aluno = pessoa.codigo) ");
		str.append("      INNER JOIN UnidadeEnsino ON (Matricula.unidadeEnsino = unidadeEnsino.codigo) ");
		str.append("      INNER JOIN Curso ON (Matricula.curso = curso.codigo) ");
		str.append("      INNER JOIN PeriodoLetivo ON (MatriculaPeriodo.periodoLetivoMatricula = PeriodoLetivo.codigo) ");
		str.append("      INNER JOIN GradeCurricular ON (MatriculaPeriodo.gradecurricular = GradeCurricular.codigo) ");
		str.append("      INNER JOIN GradeCurricular as gradeCurricularAtual ON (gradeCurricularAtual.codigo = Matricula.gradeCurricularAtual) ");
		str.append("      LEFT JOIN turma ON matriculaperiodo.turma = turma.codigo  ");
		str.append("      INNER JOIN Turno ON matricula.turno = turno.codigo  ");
		str.append("      LEFT JOIN planofinanceirocurso ON matriculaperiodo.planofinanceirocurso = planofinanceirocurso.codigo  ");
		str.append("      LEFT JOIN condicaopagamentoplanofinanceirocurso ON matriculaperiodo.condicaopagamentoplanofinanceirocurso = condicaopagamentoplanofinanceirocurso.codigo  ");
		str.append("      INNER JOIN unidadeEnsinoCurso uec ON uec.codigo = matriculaperiodo.unidadeEnsinoCurso");
		str.append("      INNER JOIN Turno turnoPeriodo ON turnoPeriodo.codigo = uec.turno ");
		str.append("      LEFT JOIN ProcessoMatricula ON ProcessoMatricula.codigo = MatriculaPeriodo.processoMatricula ");
		//str.append("      LEFT JOIN pendenciaLiberacaoMatricula  ON pendenciaLiberacaoMatricula.matricula = Matricula.matricula ");
		return str;
	}

	private StringBuffer getSQLPadraoConsultaCompleta() {
		StringBuffer str = new StringBuffer();
		str.append("SELECT MatriculaPeriodo.*, Turma.identificadorturma as \"turma.identificadorturma\",  Turma.observacao as \"turma.observacao\", turma.planoFinanceiroCurso as \"turma.planoFinanceiroCurso\", ");
		str.append("       Matricula.matricula as \"Matricula.matricula\", Matricula.gradeCurricularAtual as \"Matricula.gradeCurricularAtual\", Matricula.data as \"Matricula.data\", Matricula.updated as \"Matricula.updated\", ");
		str.append("       Matricula.situacao as \"Matricula.situacao\", Matricula.situacaoFinanceira as \"Matricula.situacaoFinanceira\", Matricula.alunoConcluiuDisciplinasRegulares as \"Matricula.alunoConcluiuDisciplinasRegulares\",");
		str.append("       PeriodoLetivo.descricao as \"PeriodoLetivo.descricao\", PeriodoLetivo.periodoLetivo as \"PeriodoLetivo.periodoLetivo\", Pessoa.nome as \"Pessoa.nome\", ");
		str.append("	   Pessoa.codigo as \"Pessoa.codigo\", Pessoa.cpf as \"Pessoa.cpf\", Curso.nome as \"Curso.nome\", Curso.codigo as \"Curso.codigo\", ");
		str.append("	   Curso.nivelEducacional as \"Curso.nivelEducacional\", Curso.nrRegistroInterno as \"Curso.nrRegistroInterno\", Curso.dataCriacao as \"Curso.dataCriacao\", ");
		str.append("	   UnidadeEnsino.codigo as \"UnidadeEnsino.codigo\", UnidadeEnsino.nome as \"UnidadeEnsino.nome\", ");
		str.append("	   Turma.identificadorturma as \"turma.identificadorturma\", Turma.dataBaseGeracaoParcelas as \"turma.dataBaseGeracaoParcelas\", periodoletivo.gradecurricular as \"periodoletivo.gradecurricular\",  Turma.categoriaCondicaoPagamento as \"turma.categoriaCondicaoPagamento\"");
		str.append(" FROM MatriculaPeriodo ");
		str.append("      inner JOIN Matricula ON (MatriculaPeriodo.matricula = Matricula.matricula) ");
		str.append("      inner JOIN Pessoa ON (Matricula.aluno = pessoa.codigo) ");
		str.append("      inner JOIN UnidadeEnsino ON (Matricula.unidadeEnsino = unidadeEnsino.codigo) ");
		str.append("      inner JOIN Curso ON (Matricula.curso = curso.codigo) ");
		str.append("      LEFT JOIN PeriodoLetivo ON (MatriculaPeriodo.periodoletivomatricula = PeriodoLetivo.codigo) ");
		str.append("      LEFT JOIN turma ON matriculaperiodo.turma = turma.codigo  ");
		str.append("      LEFT JOIN planofinanceirocurso ON matriculaperiodo.planofinanceirocurso = planofinanceirocurso.codigo  ");
		return str;
	}

	/**
	 * Consulta que espera um ResultSet com os campos mï¿½nimos para uma
	 * consulta rï¿½pida e intelegente. Desta maneira, a mesma será sempre capaz
	 * de montar os atributos básicos do objeto e alguns atributos relacionados
	 * de relevï¿½ncia para o contexto da aplicação.
	 * 
	 * @param obj
	 * @throws Exception
	 */
	public static void montarDadosBasico(MatriculaPeriodoVO obj, SqlRowSet dadosSQL) throws Exception {
		obj.setCodigo((dadosSQL.getInt("codigo")));
		obj.setData(dadosSQL.getDate("data"));
		obj.setDataVencimentoMatriculaEspecifico(dadosSQL.getDate("dataVencimentoMatriculaEspecifico"));
		obj.setDataBaseGeracaoParcelas(dadosSQL.getDate("dataBaseGeracaoParcelas"));
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setSituacaoMatriculaPeriodo(dadosSQL.getString("situacaoMatriculaPeriodo"));
		obj.setSemestre(dadosSQL.getString("semestre"));
		obj.setAno(dadosSQL.getString("ano"));
		obj.setMatriculaEspecial(dadosSQL.getBoolean("matriculaEspecial"));
		obj.setMatricula(dadosSQL.getString("matricula"));
		obj.setUnidadeEnsinoCurso(dadosSQL.getInt("unidadeEnsinoCurso"));
		obj.setProcessoMatricula(dadosSQL.getInt("processoMatricula"));
		obj.getGradeCurricular().setCodigo(dadosSQL.getInt("gradecurricular"));
		obj.getGradeCurricular().setNome(dadosSQL.getString("gradeCurricular.nome"));
		obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
		obj.getPlanoFinanceiroCurso().setCodigo(dadosSQL.getInt("planofinanceirocurso"));
		obj.getCondicaoPagamentoPlanoFinanceiroCurso().setCodigo(dadosSQL.getInt("condicaoPagamentoplanofinanceirocurso"));
		obj.getCondicaoPagamentoPlanoFinanceiroCurso().setDescricao(dadosSQL.getString("condicaoPagamentoplanofinanceirocurso.descricao"));
		obj.setCategoriaCondicaoPagamento(dadosSQL.getString("categoriaCondicaoPagamento"));
		obj.setCarneEntregue(dadosSQL.getBoolean("carneEntregue"));
		obj.setAlunoTransferidoUnidade(dadosSQL.getBoolean("alunoTransferidoUnidade"));
		obj.setMotivoLiberacaoPgtoMatricula(dadosSQL.getString("motivoliberacaopgtomatricula"));
		obj.setTranferenciaEntrada(dadosSQL.getInt("transferenciaEntrada"));		
		obj.setBolsista(dadosSQL.getBoolean("bolsista"));
		obj.setFinanceiroManual(dadosSQL.getBoolean("financeiroManual"));
		
		obj.setNovoObj(false);
		obj.setNivelMontarDados(NivelMontarDados.BASICO);

		// Turma
		obj.getTurma().setCodigo(dadosSQL.getInt("turma"));
		obj.getTurma().setIdentificadorTurma(dadosSQL.getString("turma.identificadorturma"));
		obj.getTurma().setObservacao(dadosSQL.getString("turma.observacao"));
		// PlanoFinanceiroCurso
		obj.getPlanoFinanceiroCurso().setDescricao(dadosSQL.getString("planofinanceirocurso.descricao"));
		// Periodo Letivo
		obj.getPeridoLetivo().setCodigo(dadosSQL.getInt("periodoLetivoMatricula"));
		obj.getPeridoLetivo().setDescricao(dadosSQL.getString("PeriodoLetivo.descricao"));
		obj.getPeridoLetivo().setPeriodoLetivo(dadosSQL.getInt("PeriodoLetivo.periodoletivo"));
		// Dados Processo Matrícula
		obj.getProcessoMatriculaVO().setCodigo(dadosSQL.getInt("ProcessoMatricula.codigo"));
		obj.getProcessoMatriculaVO().setDescricao(dadosSQL.getString("ProcessoMatricula.descricao"));
		// Dados da Matrícula
		obj.getMatriculaVO().setMatricula(dadosSQL.getString("Matricula.matricula"));

		GradeCurricularVO gradeCurricularAtual = new GradeCurricularVO();
		gradeCurricularAtual.setCodigo(dadosSQL.getInt("Matricula.gradeCurricularAtual"));
		obj.getMatriculaVO().setGradeCurricularAtual(gradeCurricularAtual);
		obj.getMatriculaVO().getGradeCurricularAtual().setCodigo(dadosSQL.getInt("gradecurricularatual.codigo"));
		obj.getMatriculaVO().getGradeCurricularAtual().setNome(dadosSQL.getString("gradeCurricularatual.nome"));
        obj.getMatriculaVO().getGradeCurricularAtual().setConsiderarPeriodoTrancadoParaJubilamento(dadosSQL.getBoolean("gradeCurricularAtual.considerarPeriodoTrancadoParaJubilamento"));
		obj.getMatriculaVO().setData(dadosSQL.getDate("Matricula.data"));
		obj.getMatriculaVO().setMatriculaSuspensa(dadosSQL.getBoolean("Matricula.matriculaSuspensa"));
		obj.getMatriculaVO().setSituacao(dadosSQL.getString("Matricula.situacao"));
		obj.getMatriculaVO().setSituacaoFinanceira(dadosSQL.getString("Matricula.situacaoFinanceira"));
		obj.getMatriculaVO().setAlunoConcluiuDisciplinasRegulares(dadosSQL.getBoolean("Matricula.alunoConcluiuDisciplinasRegulares"));
		obj.getMatriculaVO().setUpdated(dadosSQL.getTimestamp("Matricula.updated"));
		obj.getMatriculaVO().setNaoEnviarMensagemCobranca(dadosSQL.getBoolean("Matricula.naoEnviarMensagemCobranca"));
		obj.getMatriculaVO().setCanceladoFinanceiro(dadosSQL.getBoolean("canceladoFinanceiro"));
		// Dados do Turno
		obj.getMatriculaVO().getTurno().setCodigo(dadosSQL.getInt("Matricula.turno"));
		obj.getMatriculaVO().getTurno().setNome(dadosSQL.getString("Turno.nome"));
		// Dados do Aluno
		obj.getMatriculaVO().getAluno().setCodigo(dadosSQL.getInt("Pessoa.codigo"));
		obj.getMatriculaVO().getAluno().setNome(dadosSQL.getString("Pessoa.nome"));
		obj.getMatriculaVO().getAluno().setCPF(dadosSQL.getString("Pessoa.cpf"));
		obj.getMatriculaVO().getAluno().setRegistroAcademico(dadosSQL.getString("Pessoa.registroAcademico"));
		obj.getMatriculaVO().getAluno().setNivelMontarDados(NivelMontarDados.BASICO);
		// Dados do Curso
		obj.getMatriculaVO().getCurso().setCodigo(dadosSQL.getInt("Curso.codigo"));
		obj.getMatriculaVO().getCurso().setNome(dadosSQL.getString("Curso.nome"));
		obj.getMatriculaVO().getCurso().setNivelEducacional(dadosSQL.getString("Curso.nivelEducacional"));
		obj.getMatriculaVO().getCurso().setNivelMontarDados(NivelMontarDados.BASICO);
		// Dados da Unidade
		obj.getMatriculaVO().getUnidadeEnsino().setCodigo(dadosSQL.getInt("UnidadeEnsino.codigo"));
		obj.getMatriculaVO().getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
		obj.getMatriculaVO().getUnidadeEnsino().setNivelMontarDados(NivelMontarDados.BASICO);
		obj.setUnidadeEnsinoCurso(dadosSQL.getInt("unidadeEnsinoCurso"));
		obj.getUnidadeEnsinoCursoVO().setCodigo(dadosSQL.getInt("uec.codigo"));		
		obj.getUnidadeEnsinoCursoVO().getCurso().setCodigo(dadosSQL.getInt("uec.curso"));
		obj.getUnidadeEnsinoCursoVO().getTurno().setCodigo(dadosSQL.getInt("turnoPeriodo.codigo"));
		obj.getUnidadeEnsinoCursoVO().getTurno().setNome(dadosSQL.getString("turnoPeriodo.nome"));
		obj.getResponsavelRenovacaoMatricula().setCodigo(dadosSQL.getInt("responsavelrenovacaomatricula"));
		obj.setUltimaMatriculaPeriodoAluno(dadosSQL.getInt("ultimaMatriculaPeriodo") == dadosSQL.getInt("codigo"));
		if(dadosSQL.getBoolean("existePendenciaLiberacao")) {
			obj.getMatriculaVO().setPendenciaLiberacaoMatriculaVOs(getFacadeFactory().getPendenciaLiberacaoMatriculaInterfaceFacade().consultarPorMatricula(obj.getMatricula()));
			obj.getMatriculaVO().getPendenciaLiberacaoMatriculaVOs().stream().forEach(plMatricula ->{
			if(plMatricula.getMotivoSolicitacao().equals(MotivoSolicitacaoLiberacaoMatriculaEnum.SOLICITAR_LIBERACAO_MATRICULA_APOS_X_MODULOS)) {
				obj.getMatriculaVO().setBloqueioPorSolicitacaoLiberacaoMatriculaPendenciaAcademica(Boolean.TRUE);
			}
			else if(plMatricula.getMotivoSolicitacao().equals(MotivoSolicitacaoLiberacaoMatriculaEnum.SOLICITAR_APROVACAO_LIBERACAO_FINANCEIRA)) {
				obj.getMatriculaVO().setBloqueioPorSolicitacaoLiberacaoMatriculaPendenciaFinanceira(Boolean.TRUE);
			}
		});
		}
		obj.getMatriculaVO().setBloqueioPorSolicitacaoLiberacaoMatricula(dadosSQL.getBoolean("Matricula.bloqueioPorSolicitacaoLiberacaoMatricula"));
		obj.getMatriculaVO().setMotivoMatriculaBloqueada(dadosSQL.getString("Matricula.motivoMatriculaBloqueada"));
		
	}

	public static void montarDadosMinimos(MatriculaPeriodoVO obj, SqlRowSet dadosSQL) throws Exception {
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setMatricula(dadosSQL.getString("matricula"));

		obj.setNovoObj(false);
		obj.setNivelMontarDados(NivelMontarDados.BASICO);

		// Dados da Matrícula
		obj.getMatriculaVO().setMatricula(dadosSQL.getString("Matricula.matricula"));
		obj.getMatriculaVO().setSituacao(dadosSQL.getString("Matricula.situacao"));
		obj.getMatriculaVO().setSituacaoFinanceira(dadosSQL.getString("Matricula.situacaoFinanceira"));
		obj.getMatriculaVO().setAlunoConcluiuDisciplinasRegulares(dadosSQL.getBoolean("Matricula.alunoConcluiuDisciplinasRegulares"));
		// Dados do Aluno
		obj.getMatriculaVO().getAluno().setNome(dadosSQL.getString("Pessoa.nome"));
		obj.getMatriculaVO().getAluno().setCPF(dadosSQL.getString("Pessoa.cpf"));
		obj.getMatriculaVO().getAluno().setNivelMontarDados(NivelMontarDados.BASICO);
		// Dados do Curso
		obj.getMatriculaVO().getCurso().setCodigo(dadosSQL.getInt("Curso.codigo"));
		obj.getMatriculaVO().getCurso().setNome(dadosSQL.getString("Curso.nome"));
		obj.getMatriculaVO().getCurso().setNivelEducacional(dadosSQL.getString("Curso.nivelEducacional"));
		obj.getMatriculaVO().getCurso().setNivelMontarDados(NivelMontarDados.BASICO);
		// Dados da Unidade
		obj.getMatriculaVO().getUnidadeEnsino().setCodigo(dadosSQL.getInt("UnidadeEnsino.codigo"));
		obj.getMatriculaVO().getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
		obj.getMatriculaVO().getUnidadeEnsino().setNivelMontarDados(NivelMontarDados.BASICO);
	}

	public static void montarDadosMinimos2(MatriculaPeriodoVO obj, SqlRowSet dadosSQL) throws Exception {
		obj.setSituacao(dadosSQL.getString("situacao"));
		obj.setMatricula(dadosSQL.getString("matricula"));

		obj.setNovoObj(false);
		obj.setNivelMontarDados(NivelMontarDados.BASICO);

		// Dados da Matrícula
		obj.getMatriculaVO().setMatricula(dadosSQL.getString("Matricula.matricula"));
		obj.getMatriculaVO().setSituacao(dadosSQL.getString("Matricula.situacao"));
		obj.getMatriculaVO().setSituacaoFinanceira(dadosSQL.getString("Matricula.situacaoFinanceira"));
		obj.getMatriculaVO().setAlunoConcluiuDisciplinasRegulares(dadosSQL.getBoolean("Matricula.alunoConcluiuDisciplinasRegulares"));
		obj.getMatriculaVO().setData(dadosSQL.getDate("Matricula.data"));
		// Dados do Aluno
		obj.getMatriculaVO().getAluno().setNome(dadosSQL.getString("Pessoa.nome"));
		obj.getMatriculaVO().getAluno().setCPF(dadosSQL.getString("Pessoa.cpf"));
		obj.getMatriculaVO().getAluno().setNivelMontarDados(NivelMontarDados.BASICO);
		// Dados do Curso
		obj.getMatriculaVO().getCurso().setCodigo(dadosSQL.getInt("Curso.codigo"));
		obj.getMatriculaVO().getCurso().setNome(dadosSQL.getString("Curso.nome"));
		obj.getMatriculaVO().getCurso().setNivelEducacional(dadosSQL.getString("Curso.nivelEducacional"));
		obj.getMatriculaVO().getCurso().setNivelMontarDados(NivelMontarDados.BASICO);
		// Dados da Unidade
		obj.getMatriculaVO().getUnidadeEnsino().setCodigo(dadosSQL.getInt("UnidadeEnsino.codigo"));
		obj.getMatriculaVO().getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
		obj.getMatriculaVO().getUnidadeEnsino().setNivelMontarDados(NivelMontarDados.BASICO);
		// Dados da Turma
		obj.getTurma().setCodigo(dadosSQL.getInt("Turma.codigo"));
		obj.getTurma().setIdentificadorTurma(dadosSQL.getString("Turma.identificadorTurma"));

	}

	/**
	 * Consulta que espera um ResultSet com todos os campos e dados de objetos
	 * relacionados, Para reconstituir o objeto por completo, de uma determinada
	 * entidade.
	 * 
	 * @param obj
	 * @throws Exception
	 */
	public static void montarDadosCompleto(MatriculaPeriodoVO obj, SqlRowSet dadosSQL, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		try {
			if (obj == null) {
				obj = new MatriculaPeriodoVO();
			}
			obj.setCodigo((dadosSQL.getInt("codigo")));
			obj.setData(dadosSQL.getDate("data"));
			obj.setDataVencimentoMatriculaEspecifico(dadosSQL.getDate("dataVencimentoMatriculaEspecifico"));
			obj.setDataBaseGeracaoParcelas(dadosSQL.getDate("dataBaseGeracaoParcelas"));
			obj.setSituacao(dadosSQL.getString("situacao"));
			obj.setSituacaoMatriculaPeriodo(dadosSQL.getString("situacaoMatriculaPeriodo"));
			obj.setMatriculaEspecial(dadosSQL.getBoolean("matriculaEspecial"));
			obj.setSemestre(dadosSQL.getString("semestre"));
			obj.setAno(dadosSQL.getString("ano"));
			obj.setMatricula(dadosSQL.getString("matricula"));
			obj.getGradeCurricular().setCodigo(dadosSQL.getInt("gradeCurricular"));
			obj.getResponsavelRenovacaoMatricula().setCodigo((dadosSQL.getInt("responsavelRenovacaoMatricula")));
			obj.getResponsavelMatriculaForaPrazo().setCodigo((dadosSQL.getInt("responsavelMatriculaForaPrazo")));
			obj.getTurma().setCodigo((dadosSQL.getInt("turma")));
			obj.getTurmaPeriodo().setCodigo((dadosSQL.getInt("turmaPeriodo")));
			obj.setDataLiberacaoMatricula(dadosSQL.getDate("dataLiberacaoMatricula"));
			obj.setDataEmissaoBoletoMatricula(dadosSQL.getDate("dataEmissaoBoletoMatricula"));
			obj.getResponsavelLiberacaoMatricula().setCodigo((dadosSQL.getInt("responsavelLiberacaoMatricula")));
			obj.getResponsavelEmissaoBoletoMatricula().setCodigo((dadosSQL.getInt("responsavelEmissaoBoletoMatricula")));
			obj.setUnidadeEnsinoCurso((dadosSQL.getInt("unidadeEnsinoCurso")));
			obj.getUnidadeEnsinoCursoVO().setCodigo((dadosSQL.getInt("unidadeEnsinoCurso")));
			obj.getContratoMatricula().setCodigo((dadosSQL.getInt("contratoMatricula")));
			obj.getContratoFiador().setCodigo((dadosSQL.getInt("contratoFiador")));
			obj.getContratoExtensao().setCodigo((dadosSQL.getInt("contratoExtensao")));

			obj.setNrDocumento(dadosSQL.getString("nrDocumento"));
			
			obj.setProcessoMatricula((dadosSQL.getInt("processoMatricula")));
			obj.getProcessoMatriculaVO().setCodigo((dadosSQL.getInt("processoMatricula")));
			
			obj.getPlanoFinanceiroCurso().setCodigo((dadosSQL.getInt("planoFinanceiroCurso")));
			obj.getCondicaoPagamentoPlanoFinanceiroCurso().setCodigo((dadosSQL.getInt("condicaoPagamentoPlanoFinanceiroCurso")));
			obj.setCategoriaCondicaoPagamento(dadosSQL.getString("categoriaCondicaoPagamento"));
			obj.getMatriculaPeriodoPreMatricula().setCodigo((dadosSQL.getInt("matriculaPeriodoPreMatricula")));
			obj.setFinanceiroManual(dadosSQL.getBoolean("financeiroManual"));
			obj.setNrDisciplinasIncluidas(dadosSQL.getInt("nrDisciplinasIncluidas"));
			obj.setNrDisciplinasExcluidas(dadosSQL.getInt("nrDisciplinasExcluidas"));
			obj.setReconheceuDivida(dadosSQL.getBoolean("reconheceuDivida"));
			obj.setCarneEntregue(dadosSQL.getBoolean("carneEntregue"));
			obj.setAlunoTransferidoUnidade(dadosSQL.getBoolean("alunoTransferidoUnidade"));
			obj.setBolsista(dadosSQL.getBoolean("bolsista"));
			obj.setAceitouTermoContratoRenovacaoOnline(dadosSQL.getBoolean("aceitoutermocontratorenovacaoonline"));
			obj.setDataAceitouTermoContratoRenovacaoOnline(dadosSQL.getTimestamp("dataAceitouTermoContratoRenovacaoOnline"));

			obj.setMotivoLiberacaoPgtoMatricula(dadosSQL.getString("motivoliberacaopgtomatricula"));

			obj.setNovoObj(Boolean.FALSE);
			obj.setNivelMontarDados(NivelMontarDados.TODOS);

			// Turma
			obj.getTurma().setIdentificadorTurma(dadosSQL.getString("turma.identificadorturma"));
			obj.getTurma().setDataBaseGeracaoParcelas(dadosSQL.getDate("turma.dataBaseGeracaoParcelas"));
			obj.getTurma().setObservacao(dadosSQL.getString("turma.observacao"));
			obj.getTurma().getPlanoFinanceiroCurso().setCodigo(dadosSQL.getInt("turma.planoFinanceiroCurso"));
			// Periodo Letivo
			obj.getPeridoLetivo().setCodigo(dadosSQL.getInt("periodoLetivoMatricula"));
			obj.getPeridoLetivo().setDescricao(dadosSQL.getString("PeriodoLetivo.descricao"));
			obj.getPeridoLetivo().setPeriodoLetivo(dadosSQL.getInt("PeriodoLetivo.periodoLetivo"));
			obj.getPeridoLetivo().setGradeCurricular(dadosSQL.getInt("periodoletivo.gradecurricular"));

			// Dados da Matrícula
			obj.getMatriculaVO().setMatricula(dadosSQL.getString("matricula"));

			GradeCurricularVO gradeCurricularAtual = new GradeCurricularVO();
			gradeCurricularAtual.setCodigo(dadosSQL.getInt("Matricula.gradeCurricularAtual"));
			obj.getMatriculaVO().setGradeCurricularAtual(gradeCurricularAtual);

			obj.getMatriculaVO().setData(dadosSQL.getDate("Matricula.data"));
			obj.getMatriculaVO().setSituacao(dadosSQL.getString("Matricula.situacao"));
			obj.getMatriculaVO().setSituacaoFinanceira(dadosSQL.getString("Matricula.situacaoFinanceira"));
			obj.getMatriculaVO().setAlunoConcluiuDisciplinasRegulares(dadosSQL.getBoolean("Matricula.alunoConcluiuDisciplinasRegulares"));
			obj.getMatriculaVO().setUpdated(dadosSQL.getTimestamp("Matricula.updated"));
			// Dados do Aluno
			obj.getMatriculaVO().getAluno().setCodigo(dadosSQL.getInt("Pessoa.codigo"));
			obj.getMatriculaVO().getAluno().setNome(dadosSQL.getString("Pessoa.nome"));
			obj.getMatriculaVO().getAluno().setCPF(dadosSQL.getString("Pessoa.cpf"));
			obj.getMatriculaVO().getAluno().setNivelMontarDados(NivelMontarDados.BASICO);
			// Dados do Curso
			obj.getMatriculaVO().getCurso().setCodigo(dadosSQL.getInt("Curso.codigo"));
			obj.getMatriculaVO().getCurso().setNome(dadosSQL.getString("Curso.nome"));
			obj.getMatriculaVO().getCurso().setNivelEducacional(dadosSQL.getString("Curso.nivelEducacional"));
			obj.getMatriculaVO().getCurso().setNrRegistroInterno(dadosSQL.getString("Curso.nrRegistroInterno"));
			obj.getMatriculaVO().getCurso().setDataCriacao(dadosSQL.getDate("Curso.dataCriacao"));
			obj.getMatriculaVO().getCurso().setNivelMontarDados(NivelMontarDados.BASICO);
			// Dados da Unidade
			obj.getMatriculaVO().getUnidadeEnsino().setCodigo(dadosSQL.getInt("UnidadeEnsino.codigo"));
			obj.getMatriculaVO().getUnidadeEnsino().setNome(dadosSQL.getString("UnidadeEnsino.nome"));
			obj.getMatriculaVO().getUnidadeEnsino().setNivelMontarDados(NivelMontarDados.BASICO);
			// Matricula Periodo VencimentosVOs
			carregarDadosMatriculaPeriodoVencimentoVOs(obj, configuracaoFinanceiroVO, usuario);
			// Matricula Turma Disciplina VOs.
			montarDadosMatriculaPeriodoTurmaDisciplinaDeAcordoSituacaoAcademica(obj);
			if (!Uteis.isAtributoPreenchido(obj.getGradeCurricular())) {
				obj.setGradeCurricular(getFacadeFactory().getGradeCurricularFacade().consultarGradeCurricularDaUltimaMatriculaPeriodo(obj.getMatricula(), false, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario));
			} else {
				obj.setGradeCurricular(getFacadeFactory().getGradeCurricularFacade().consultarPorChavePrimaria(obj.getGradeCurricular().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuario));
			}
		} catch (Exception e) {
			obj.setNivelMontarDados(NivelMontarDados.NAO_INICIALIZADO);
			throw e;
		}
	}

	/**
	 * PONTODELENTIDAO Rotina reponsóvel por realizar todas as validações
	 * necessárias, para que uma matrícula / renovação possa ser realizada.
	 * 
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @throws Exception
	 */
	public void validarMatriculaPeriodoPodeSerRealizada(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		MatriculaVO.validarDados(matriculaVO);
		montarDadosProcessoMatriculaCalendarioVO(matriculaVO, matriculaPeriodoVO, NivelMontarDados.TODOS, usuario);
		MatriculaPeriodoVO.validarProcessoMatriculaCalendario(matriculaVO, matriculaPeriodoVO, isPermitirMatriculaForaPrazo(usuario));
		MatriculaPeriodoVO.validarDados(matriculaPeriodoVO);
		TurmaVO turma = matriculaPeriodoVO.getTurma();
		if (!matriculaPeriodoVO.getTurma().getIsNivelMontarDadosTodos()) {
			getFacadeFactory().getTurmaFacade().carregarDados(turma, NivelMontarDados.TODOS, usuario);
			turma.setNivelMontarDados(NivelMontarDados.TODOS);
			matriculaPeriodoVO.setTurma(turma);
		}
		if (!matriculaVO.getAlunoAbandonouCurso()) {
			validarJaExisteMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, usuario);
		}
	}

	public void validarMatriculaPeriodoPodeSerRealizadaSemValidarDataMatriculaCalendario(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		MatriculaVO.validarDados(matriculaVO);
		montarDadosProcessoMatriculaCalendarioVO(matriculaVO, matriculaPeriodoVO, NivelMontarDados.TODOS, usuario);
		MatriculaPeriodoVO.validarProcessoMatricula(matriculaVO, matriculaPeriodoVO);
		MatriculaPeriodoVO.validarDados(matriculaPeriodoVO);
		TurmaVO turma = matriculaPeriodoVO.getTurma();
		if (!matriculaPeriodoVO.getTurma().getIsNivelMontarDadosTodos()) {
			getFacadeFactory().getTurmaFacade().carregarDados(turma, NivelMontarDados.TODOS, usuario);
			turma.setNivelMontarDados(NivelMontarDados.TODOS);
			matriculaPeriodoVO.setTurma(turma);
		}
//		Integer nrMatricula = getFacadeFactory().getMatriculaPeriodoFacade().consultarQuantidadeAlunoMatriculadoTurma(turma.getCodigo().intValue(), matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getProcessoMatricula(), false, usuario);
//		MatriculaPeriodoVO.validarVagaNaTurma(matriculaPeriodoVO, nrMatricula, turma);
		// TODO (SEI CA44.1) Se o aluno trancou o curso alguma vez, essa
		// verificaï¿½ï¿½o não irá ser feita.
		if (!matriculaVO.getAlunoAbandonouCurso()) {
			validarJaExisteMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, usuario);
		}
	}

	public PeriodoLetivoVO executarObterProximoPeriodoLetivoRenovacaoMatricula(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		return null;
	}

	public PeriodoLetivoVO executarObterPeriodoLetivoAnteriorAoPeriodoLetivoMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		Integer codigoAtual = matriculaPeriodoVO.getPeridoLetivo().getCodigo();
		PeriodoLetivoVO anterior = null;
		Iterator i = matriculaPeriodoVO.getGradeCurricular().getPeriodoLetivosVOs().iterator();
		while (i.hasNext()) {
			PeriodoLetivoVO periodo = (PeriodoLetivoVO) i.next();
			if (periodo.getCodigo().equals(codigoAtual)) {
				if((!Uteis.isAtributoPreenchido(matriculaPeriodoVO) 
						&& !matriculaVO.getMatriculaPeriodoVOs().isEmpty() 
						&& matriculaVO.getMatriculaPeriodoVOs().get(matriculaVO.getMatriculaPeriodoVOs().size()-1).getPeriodoLetivo().getPeriodoLetivo().equals(matriculaPeriodoVO.getPeridoLetivo().getPeriodoLetivo()))
						|| (Uteis.isAtributoPreenchido(matriculaPeriodoVO) 
							&& !matriculaVO.getMatriculaPeriodoVOs().isEmpty()
							&& matriculaVO.getMatriculaPeriodoVOs().size() >= 2 
							&& matriculaVO.getMatriculaPeriodoVOs().get(matriculaVO.getMatriculaPeriodoVOs().size()-2).getPeriodoLetivo().getPeriodoLetivo().equals(matriculaPeriodoVO.getPeridoLetivo().getPeriodoLetivo()))) {
					anterior = periodo;
				}					
				break;
			}
			anterior = periodo;
		}
		if (anterior == null) {
			// Se entrar aqui ï¿½ por que nao tem anterior,
			// logo trata-se de uma matriculaperiodo de primeiro
			// periodo.
			return matriculaPeriodoVO.getPeridoLetivo();
		}
		return anterior;
	}
	

	public void inicializarDadosDefinirDisciplinasMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario, List<GradeDisciplinaCompostaVO> gradeDisciplinaCompostaVOs, Boolean considerarVagaReposicao, Boolean liberarRealizarMatriculaDisciplinaPreRequisito) throws Exception {
		// Vamos garantir que a grade do curso estão carregada de forma completa
		// Este Método já ï¿½ intelegente para nao montar os dados mais de uma
		// vez
		montarDadosProcessoMatriculaCalendarioVO(matriculaVO, matriculaPeriodoVO, NivelMontarDados.TODOS, usuario);

		List<HistoricoVO> listaDisciplinasJaCursadasAluno = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getHistoricosDisciplinasAprovadasAlunoGradeCurricular();

		// Indica que aluno ï¿½ proveniente de transferencia de entrada e
		// deve-se
		// verificar as disciplinas aproveitadas
		if (matriculaVO.getTransferenciaEntrada() != null && !matriculaVO.getTransferenciaEntrada().getCodigo().equals(0)) {
			List<HistoricoVO> historicoVOs = getFacadeFactory().getTransferenciaEntradaFacade().criarHistoricoTransferenciaEntrada(matriculaVO.getTransferenciaEntrada(), usuario, false);
			listaDisciplinasJaCursadasAluno.addAll(historicoVOs);
		}else if(matriculaVO.getMatriculaOnlineProcSeletivo()) {
		    List<HistoricoVO> historicos =	getFacadeFactory().getMatriculaFacade().realizarCriacaoHistoricoApartirDisciplinasAprovadasMesmaGradeCurricularMatriculaOnline(matriculaVO.getMatricula() ,matriculaVO.getAluno().getCodigo() ,matriculaVO.getGradeCurricularAtual().getCodigo(), matriculaPeriodoVO.getTurma() ,null  ,NivelMontarDados.TODOS , usuario);
		    matriculaVO.setListaProcessoSeletivoDisciplinasAproveitadas(historicos);
 		}
		
		matriculaPeriodoVO.setListaDisciplinasPeriodoLetivoAlunoJaAprovado(listaDisciplinasJaCursadasAluno);
		inicializarMatriculaPeriodoTurmaDisciplinaGradeCurso(matriculaVO, matriculaPeriodoVO, usuario, gradeDisciplinaCompostaVOs, considerarVagaReposicao, liberarRealizarMatriculaDisciplinaPreRequisito);
		//Univesp nao usa renovaao Pratica Teorica
		//realizarSugestaoTurmaPraticaTeorica(matriculaPeriodoVO, matriculaVO.getCurso().getConfiguracaoAcademico(), null, considerarVagaReposicao, usuario);
//		for(MatriculaPeriodoTurmaDisciplinaVO mptd : matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()){
//			realizarDefinicaoNumeroVagaDisciplinaCompostaComLimitacaoDisciplina(matriculaPeriodoVO, mptd);
//		}
		if(!matriculaVO.getMatriculaOnlineExterna()) {
			atualizarNrDisciplinasIncluidasExcluidas(matriculaPeriodoVO, matriculaVO, usuario);
		}
	}
	
	
	
	public void realizarVerificacaoDeDistribuicaoDisciplinaDependenciaAutomatica(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, List<GradeDisciplinaVO> listaDisciplinasPeriodoLetivoAlunoPendente,  boolean liberadoInclusaoTurmaOutroUnidadeEnsino, boolean liberadoInclusaoTurmaOutroCurso, boolean liberadoInclusaoTurmaOutroMatrizCurricular,  boolean permitirRealizarMatriculaDisciplinaPreRequisito, List<HorarioAlunoTurnoVO> horarioAlunoTurnoVOs, UsuarioVO usuario) throws Exception {
        getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoDeDistribuicaoDisciplinaDependenciaAutomatica"+ matriculaVO.getMatricula());
        // Vamos garantir que a grade do curso estão carregada de forma completa
		// Este Método já ï¿½ intelegente para nao montar os dados mais de uma vez
		montarDadosProcessoMatriculaCalendarioVO(matriculaVO, matriculaPeriodoVO, NivelMontarDados.TODOS, usuario);
		getFacadeFactory().getMatriculaPeriodoFacade().atualizarNrDisciplinasIncluidasExcluidas(matriculaPeriodoVO, matriculaVO, usuario);
		ConfiguracaoAcademicoVO cfg = matriculaVO.getCurso().getConfiguracaoAcademico();
		if(cfg.getHabilitarControleInclusaoObrigatoriaDisciplinaDependencia() && cfg.isHabilitarDistribuicaoDisciplinaDependenciaAutomatica()) {
			for (GradeDisciplinaVO gdPendente : listaDisciplinasPeriodoLetivoAlunoPendente) {
				if(gdPendente.getDisciplina().getClassificacaoDisciplina().isTcc() && matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPercentualPermitirIniciarTcc() > 0
						&& matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getPercentualIntegralizacaoPorCargaHoraria() < matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPercentualPermitirIniciarTcc()) {
					gdPendente.setGradeDisciplinaOfertada(false);
					continue;
				}
				/**
				 * caso o "numeroMaximoCargaHorariaAlunoPodeCursar" não estejá informado vai ser entendido que pode adicionar
				 * "infinitamente" quantas disciplinas que quiser
				 * 
				 * @author Felipi Alves
				 */
				if(matriculaPeriodoVO.getSaldoCHDisponivelInclusaoDisplinas() <= 0 && Uteis.isAtributoPreenchido(matriculaPeriodoVO.getPeriodoLetivo().getNumeroMaximoCargaHorariaAlunoPodeCursar())) {
					break;
				}
				Integer unidadeEnsinoFiltro = liberadoInclusaoTurmaOutroUnidadeEnsino ? 0 : matriculaVO.getUnidadeEnsino().getCodigo();
				Integer cursoFiltro = liberadoInclusaoTurmaOutroCurso ? 0 : matriculaVO.getCurso().getCodigo();
				Integer matrizCurricularFiltro = liberadoInclusaoTurmaOutroMatrizCurricular ? 0 : matriculaVO.getGradeCurricularAtual().getCodigo();


                getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoDeDistribuicaoDisciplinaDependenciaAutomatica1"+ matriculaVO.getMatricula());
				Boolean apresentarRenovacaoOnline = !gdPendente.getPeriodoLetivoVO().getPeriodoLetivo().equals(matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo());			
			
				if(matriculaPeriodoVO.verificarDisciplinaEstaRegistradaMatriculaPeriodoParaSerCursadaComoEquivalencia(gdPendente.getDisciplina(),matriculaVO)) {
					continue;
				}				
				if(matriculaPeriodoVO.verificarAlunoEstaAprovadoDisciplinaNaGradeAntigaReferenteAtransferenciaInternaMatricula(gdPendente.getDisciplina(),matriculaVO)) {
					continue;
				}	
				if ((matriculaPeriodoVO.getTipoContabilizacaoDisciplinaDependencia().equals(TipoContabilizacaoDisciplinaDependenciaEnum.CREDITO) && matriculaPeriodoVO.getPeriodoLetivo().getNumeroMaximoCreditoAlunoPodeCursar() > 0 && (gdPendente.getNrCreditos() > matriculaPeriodoVO.getSaldoCreditoDisponivelInclusaoDisplinas() || matriculaPeriodoVO.getSaldoCreditoDisponivelInclusaoDisplinas().equals(0)))
						|| (matriculaPeriodoVO.getTipoContabilizacaoDisciplinaDependencia().equals(TipoContabilizacaoDisciplinaDependenciaEnum.CARGA_HORARIA) && matriculaPeriodoVO.getPeriodoLetivo().getNumeroMaximoCargaHorariaAlunoPodeCursar() > 0 && (gdPendente.getCargaHoraria() > matriculaPeriodoVO.getSaldoCHDisponivelInclusaoDisplinas() || matriculaPeriodoVO.getSaldoCHDisponivelInclusaoDisplinas().equals(0)))) {
					gdPendente.setGradeDisciplinaOfertada(getFacadeFactory().getTurmaFacade().consultaSeExisteTurmaPorDisciplinaPorUnidadeEnsinoPorCursoPorMatrizCurricularPorSituacao(gdPendente.getDisciplina().getCodigo(), gdPendente.getCargaHoraria(), unidadeEnsinoFiltro, "AB", false, cursoFiltro, matrizCurricularFiltro, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), true, false, false, false, false, usuario, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(),apresentarRenovacaoOnline, matriculaVO));
					if(!gdPendente.isGradeDisciplinaOfertada() && gdPendente.getPeriodoLetivoVO().getPeriodoLetivo() <= matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo()) {
                        getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoDeDistribuicaoDisciplinaDependenciaAutomatica2"+ matriculaVO.getMatricula());
						realizarVerificacaoInclusaoDisciplinaPorEquivalencia( matriculaVO,  matriculaPeriodoVO, gdPendente, liberadoInclusaoTurmaOutroUnidadeEnsino,  liberadoInclusaoTurmaOutroCurso,  liberadoInclusaoTurmaOutroMatrizCurricular,   permitirRealizarMatriculaDisciplinaPreRequisito,  horarioAlunoTurnoVOs,apresentarRenovacaoOnline, usuario);
					}
				}else {
                    getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoDeDistribuicaoDisciplinaDependenciaAutomatica3"+ matriculaVO.getMatricula());
					List<TurmaVO> listaTurmaOfertada = getFacadeFactory().getTurmaFacade().consultaTurmaPorDisciplinaPorUnidadeEnsinoPorCursoPorMatrizCurricularPorSituacao(gdPendente.getDisciplina().getCodigo(), gdPendente.getCargaHoraria(), unidadeEnsinoFiltro, "AB", false, cursoFiltro, matrizCurricularFiltro, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), true, false, false, false, false, usuario, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(),apresentarRenovacaoOnline, matriculaVO);
					if (!listaTurmaOfertada.isEmpty()) {
						gdPendente.setGradeDisciplinaOfertada(true);
						Optional<TurmaVO> optionalTurma = listaTurmaOfertada.stream().filter(p -> p.getCodigo().equals(matriculaPeriodoVO.getTurma().getCodigo())).findFirst();
						if(!optionalTurma.isPresent()) {
							optionalTurma = listaTurmaOfertada.stream().filter(p -> p.getUnidadeEnsino().getCodigo().equals(matriculaVO.getUnidadeEnsino().getCodigo()) && p.getCurso().getCodigo().equals(matriculaVO.getCurso().getCodigo()) && p.getGradeCurricularVO().getCodigo().equals(matriculaVO.getGradeCurricularAtual().getCodigo())).findFirst();
							if(!optionalTurma.isPresent()) {
								optionalTurma = listaTurmaOfertada.stream().filter(p -> p.getUnidadeEnsino().getCodigo().equals(matriculaVO.getUnidadeEnsino().getCodigo()) && p.getCurso().getCodigo().equals(matriculaVO.getCurso().getCodigo())).findFirst();
								if(!optionalTurma.isPresent()) {
									optionalTurma = listaTurmaOfertada.stream().filter(p -> p.getUnidadeEnsino().getCodigo().equals(matriculaVO.getUnidadeEnsino().getCodigo())).findFirst();
									if(!optionalTurma.isPresent()) {
										optionalTurma = listaTurmaOfertada.stream().filter(p -> p.getCurso().getCodigo().equals(matriculaVO.getCurso().getCodigo())).findFirst();
									}
								}
							}
						}
						if (gdPendente.getPeriodoLetivoVO().getPeriodoLetivo() <= matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo()) {
							TurmaVO turmaSelecionada = optionalTurma.isPresent() ? optionalTurma.get() : listaTurmaOfertada.get(0);
							MatriculaPeriodoTurmaDisciplinaVO novoObj = new MatriculaPeriodoTurmaDisciplinaVO();
							novoObj.setDisciplina(gdPendente.getDisciplina());
							novoObj.setGradeDisciplinaVO(gdPendente);
							novoObj.setGradeCurricularGrupoOptativaDisciplinaVO(new GradeCurricularGrupoOptativaDisciplinaVO());
							novoObj.setTurmaPratica(null);
							novoObj.setTurmaTeorica(null);
							novoObj.setSugestaoTurmaPraticaTeoricaRealizada(false);
							novoObj.setDescricaoChoqueHorarioDisciplina("");
							getFacadeFactory().getTurmaFacade().carregarDados(turmaSelecionada, NivelMontarDados.BASICO, usuario);
							novoObj.setTurma(turmaSelecionada);
							novoObj.setModalidadeDisciplina(ModalidadeDisciplinaEnum.ON_LINE);
							getFacadeFactory().getMatriculaPeriodoFacade().adicionarEValidarMatriculaPeriodoTurmaDisciplinaVO(matriculaPeriodoVO, matriculaVO, permitirRealizarMatriculaDisciplinaPreRequisito, novoObj, horarioAlunoTurnoVOs, false, usuario);
						}
                        getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoDeDistribuicaoDisciplinaDependenciaAutomatica4"+ matriculaVO.getMatricula());
					}else {
						if (gdPendente.getPeriodoLetivoVO().getPeriodoLetivo() <= matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo()) {
							realizarVerificacaoInclusaoDisciplinaPorEquivalencia( matriculaVO,  matriculaPeriodoVO, gdPendente,   liberadoInclusaoTurmaOutroUnidadeEnsino,  liberadoInclusaoTurmaOutroCurso,  liberadoInclusaoTurmaOutroMatrizCurricular,   permitirRealizarMatriculaDisciplinaPreRequisito,  horarioAlunoTurnoVOs, apresentarRenovacaoOnline, usuario);
						}
					}
                    getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoDeDistribuicaoDisciplinaDependenciaAutomatica5"+ matriculaVO.getMatricula());
				}
			}
		}else {
			listaDisciplinasPeriodoLetivoAlunoPendente.stream().forEach(p-> p.setGradeDisciplinaOfertada(true));
		}
	}
	
	
	/**
	 * et Rotina Responsável por realizar todos os cálculos envolvendo a
	 * matrícula e o valor das mensalidades de uma determinada matrícula. Esta
	 * rotina trabalha com o princï¿½pio de que todos os dados necessários para
	 * definição deste valores já estãoo devidamente inicializados em
	 * MatriculaPeriodoVO. A mesma pode ser chamada diversas vezes, para obter
	 * novos resultados no cálculo, basta alterar os dados de parâmetro deste
	 * objeto.
	 * 
	 * @throws Exception
	 */
	public void realizarCalculoValorMatriculaEMensalidade(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaEstimadaAluno = matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs();
		executarRealizarCalculoValorMatricula(matriculaVO, matriculaPeriodoVO, listaDisciplinaEstimadaAluno, usuario);
		executarRealizarCalculoValorMensalidade(matriculaVO, matriculaPeriodoVO, listaDisciplinaEstimadaAluno, usuario);
		executarRealizarCalculoValorMaterialDidatico(matriculaVO, matriculaPeriodoVO, listaDisciplinaEstimadaAluno, usuario);
	}

	/**
	 * Resposavel por calcular o valor de uma disciplina, com base no
	 * tipoCobranca, que pode ser "VF" -VALOR FIXO ou "VC" - VALOR POR CREDITO
	 * ou "VH" - VALOR POR HORA
	 */
	public Double calcularValorDisciplinaEspecificaIncluida(String tipoCobranca, Double valorCobrar, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO) {
		Double valorDisciplina = 0.0;
		if (tipoCobranca == null || tipoCobranca.equals("")) {
			tipoCobranca = "VF";
		}
		if (tipoCobranca.equals("VF")) {
			valorDisciplina = valorCobrar;
		}
		if (tipoCobranca.equals("VC")) {
			Double nrCreditoFinanceiro = matriculaPeriodoTurmaDisciplinaVO.getCreditosFinanceirosDisciplina();
			valorDisciplina = Uteis.arrendondarForcando2CadasDecimais(nrCreditoFinanceiro * valorCobrar);
		}
		if (tipoCobranca.equals("VH")) {
			Integer nrHoras = matriculaPeriodoTurmaDisciplinaVO.getCargaHorariaDisciplina();
			valorDisciplina = Uteis.arrendondarForcando2CadasDecimais(nrHoras * valorCobrar);
		}
		return valorDisciplina;
	}

	/**
	 * Método Responsável por calcular o desconto que uma determinada disciplina
	 * da matriz (nao incluida) terï¿½ quando a mesma for cursada na modalidade
	 * EAD Método da versao 5.0 com politica especifica para area de EAD.
	 * EXISTEM ALGUNS TIPOS DE DESCONTOS: "PE" - "% sobre Valor Disciplina" -
	 * NAO IMPLEMENTADO AINDA - TERIA QUE DEDUZIA UM VALOR POR DISCIPLINA. "VF"
	 * - VALOR DESCONTO FIXO SOBRE CADA DISCIPLINA "VC" - VALOR DESCONTO POR
	 * CREDITO DA DISCIPLINA "VH" - VALOR DESCONTO POR HORA DA DISCIPLINA
	 */
	private Double calcularValorDescontoDisciplinasMatrizEstudasEAD(CondicaoPagamentoPlanoFinanceiroCursoVO condicaoPgto, MatriculaPeriodoVO matriculaPeriodoVO, Double valorCheioMatriculaMensalidade, Boolean calcularValorDisciplinaComBaseEmCreditos) throws Exception {
		Double totalDescontoDisciplinasEAD = 0.0;
		if (!condicaoPgto.getUtilizarPoliticaDescontoDiscipRegularFeitasViaEAD()) {
			// se opcao esta desmarcar, nao temos que fazer este tipo de
			// calculo.
			return totalDescontoDisciplinasEAD;
		}

		for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()) {

			if ((!matriculaPeriodoTurmaDisciplinaVO.getDisciplinaIncluida()) && (!matriculaPeriodoTurmaDisciplinaVO.getDisciplinaFazParteComposicao()) && // se
					// disciplina
					// e
					// parte
					// de
					// uma
					// composicao,
					// o
					// alnuo
					// paga
					// pela
					// mae
					(!matriculaPeriodoTurmaDisciplinaVO.getInclusaoForaPrazo()) && // se
					// foi
					// incluida
					// fora
					// do
					// prazo
					// o
					// aluno
					// nao
					// paga
					// por
					// ela
					// aqui
					(matriculaPeriodoTurmaDisciplinaVO.getModalidadeDisciplina().equals(ModalidadeDisciplinaEnum.ON_LINE))) { // somente
				// para
				// regulares
				// NA
				// MODALIDADE
				// EAD,
				// pois
				// disciplinas
				// incluidas,
				// possuem
				// cfg
				// prérpia
				String tipoDesconto = condicaoPgto.getTipoDescontoDisciplinaRegularEAD();
				Double valorDescontoDisciplina = 0.0;
				if (tipoDesconto.equals("PE")) {
					if (!calcularValorDisciplinaComBaseEmCreditos) {
						Double valorPorHoraDisciplinaCalculoPercentual = Uteis.arrendondarForcando2CadasDecimais(valorCheioMatriculaMensalidade / matriculaPeriodoVO.getTotalCargaHorariaAlunoMatriculaPeriodo());
						Double valorBaseCalculoDisciplina = valorPorHoraDisciplinaCalculoPercentual * matriculaPeriodoTurmaDisciplinaVO.getCargaHorariaDisciplina();
						valorDescontoDisciplina = Uteis.arrendondarForcando2CadasDecimais(valorBaseCalculoDisciplina * (condicaoPgto.getValorDescontoDisciplinaRegularEAD() / 100));
					} else {
						Double valorPorCredito = condicaoPgto.getValorUnitarioCredito();
						Double valorBaseCalculoDisciplina = valorPorCredito * matriculaPeriodoTurmaDisciplinaVO.getCreditosFinanceirosDisciplina();
						valorDescontoDisciplina = Uteis.arrendondarForcando2CadasDecimais(valorBaseCalculoDisciplina * (condicaoPgto.getValorDescontoDisciplinaRegularEAD() / 100));
					}
				}
				if (tipoDesconto.equals("VF")) {
					valorDescontoDisciplina = Uteis.arrendondarForcando2CadasDecimais(condicaoPgto.getValorDescontoDisciplinaRegularEAD());
				}
				if (tipoDesconto.equals("VC")) {
					Double valorDescontoPorCredito = condicaoPgto.getValorDescontoDisciplinaRegularEAD();
					Double nrCreditos = matriculaPeriodoTurmaDisciplinaVO.getCreditosFinanceirosDisciplina();
					valorDescontoDisciplina = Uteis.arrendondarForcando2CadasDecimais(nrCreditos * valorDescontoPorCredito);
				}
				if (tipoDesconto.equals("VH")) {
					Double valorDescontoPorHora = condicaoPgto.getValorDescontoDisciplinaRegularEAD();
					Integer nrHoras = matriculaPeriodoTurmaDisciplinaVO.getCargaHorariaDisciplina();
					valorDescontoDisciplina = Uteis.arrendondarForcando2CadasDecimais(nrHoras * valorDescontoPorHora);
				}
				totalDescontoDisciplinasEAD += valorDescontoDisciplina;
			}
		}
		return Uteis.arrendondarForcando2CadasDecimais(totalDescontoDisciplinasEAD);
	}

	/**
	 * Método criado na versao 5.0 que ï¿½ capaz de calcular um valor por
	 * disciplina incluida, conforme um tipo de calculo, modalidade de estudo e
	 * outros parametros informados na condicao de pagamento.
	 * 
	 * @param condicaoPgto
	 * @param matriculaPeriodoVO
	 * @return
	 * @throws Exception
	 */
	private Double calcularValorDisciplinasIncluidasConformeCondicaoPgto(CondicaoPagamentoPlanoFinanceiroCursoVO condicaoPgto, MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		// Double valorAdicionalDisciplinasIncluidas =
		// Uteis.arrendondarForcando2CadasDecimais(matriculaPeriodoVO.getNrDisciplinasIncluidas()
		// *
		// matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorFixoDisciplinaIncluida());
		Double totalDisciplinasIncluidas = 0.0;

		for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()) {
			if ((matriculaPeriodoTurmaDisciplinaVO.getDisciplinaIncluida()) && (!matriculaPeriodoTurmaDisciplinaVO.getDisciplinaFazParteComposicao()) && // se
					// disciplina e parte de uma composicao, o alnuo paga pela
					// mae
					(!matriculaPeriodoTurmaDisciplinaVO.getInclusaoForaPrazo())) { // se
				// foi
				// incluida
				// fora
				// do
				// prazo
				// o
				// aluno
				// nao
				// paga
				// por
				// ela
				// aqui

				if (matriculaPeriodoTurmaDisciplinaVO.getDisciplinaDependencia()) {
					// pode haver uma polï¿½tica especial para disciplinas de
					// dependencia (que podem
					// ter um valor reduzido ou zerado.
					String tipoCobranca = condicaoPgto.getTipoCobrancaInclusaoDisciplinaDependencia();
					Double valorCobrar = condicaoPgto.getValorDisciplinaIncluidaDependencia();
					if (matriculaPeriodoTurmaDisciplinaVO.getModalidadeDisciplina().equals(ModalidadeDisciplinaEnum.ON_LINE)) {
						valorCobrar = condicaoPgto.getValorDisciplinaIncluidaDependenciaEAD();
					}
					Double valorDisciplina = calcularValorDisciplinaEspecificaIncluida(tipoCobranca, valorCobrar, matriculaPeriodoTurmaDisciplinaVO);
					totalDisciplinasIncluidas += valorDisciplina;
				} else {
					// se entrar aqui aplica-se politica de disciplina incluida
					// regular
					// pode haver uma polï¿½tica especial para disciplinas de
					// dependencia (que podem
					// ter um valor reduzido ou zerado.
					String tipoCobranca = condicaoPgto.getTipoCobrancaInclusaoDisciplinaRegular();
					Double valorCobrar = condicaoPgto.getValorFixoDisciplinaIncluida();
					if (matriculaPeriodoTurmaDisciplinaVO.getModalidadeDisciplina().equals(ModalidadeDisciplinaEnum.ON_LINE)) {
						valorCobrar = condicaoPgto.getValorFixoDisciplinaIncluidaEAD();
					}
					Double valorDisciplina = calcularValorDisciplinaEspecificaIncluida(tipoCobranca, valorCobrar, matriculaPeriodoTurmaDisciplinaVO);
					totalDisciplinasIncluidas += valorDisciplina;
				}
			}
		}
		return Uteis.arrendondarForcando2CadasDecimais(totalDisciplinasIncluidas);
	}

	public Double calcularValorDisciplinaEspecificaExcluida(String tipoCobranca, Double valorCobrar, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO) {
		Double valorDisciplina = 0.0;
		if (tipoCobranca == null || tipoCobranca.equals("")) {
			tipoCobranca = "VF";
		}
		if (tipoCobranca.equals("VF")) {
			valorDisciplina = valorCobrar;
		}
		if (tipoCobranca.equals("VC")) {
			Double nrCreditoFinanceiro = matriculaPeriodoTurmaDisciplinaVO.getCreditosFinanceirosDisciplina();
			valorDisciplina = Uteis.arrendondarForcando2CadasDecimais(nrCreditoFinanceiro * valorCobrar);
		}
		if (tipoCobranca.equals("VH")) {
			Integer nrHoras = matriculaPeriodoTurmaDisciplinaVO.getCargaHorariaDisciplina();
			valorDisciplina = Uteis.arrendondarForcando2CadasDecimais(nrHoras * valorCobrar);
		}
		return valorDisciplina;
	}

	/**
	 * Método Responsável por cacular o valor a ser descontado em funï¿½ï¿½o das
	 * disciplinas excluï¿½das
	 * 
	 * @param condicaoPgto
	 * @param matriculaPeriodoVO
	 * @return
	 * @throws Exception
	 */
	private Double calcularValorDescontoDisciplinasExcluidas(CondicaoPagamentoPlanoFinanceiroCursoVO condicaoPgto, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, UsuarioVO usuario) throws Exception {
		Double totalDisciplinasExcluidas = 0.0;
		List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinasExcluidas = executarObterListaDisciplinasExcluidasGradeAluno(matriculaPeriodoVO, matriculaVO, usuario);
		for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : listaDisciplinasExcluidas) {
			if ((!matriculaPeriodoTurmaDisciplinaVO.getDisciplinaFazParteComposicao()) && // se
					// disciplina
					// e
					// parte
					// de
					// uma
					// composicao,
					// o
					// alnuo
					// paga
					// pela
					// mae
					(!matriculaPeriodoTurmaDisciplinaVO.getInclusaoForaPrazo())) { // se
				// foi
				// incluida
				// fora
				// do
				// prazo
				// o
				// aluno
				// nao
				// paga
				// por
				// ela
				// aqui
				String tipoCalculo = condicaoPgto.getTipoCobrancaExclusaoDisciplinaRegular();
				Double valorDesconto = condicaoPgto.getValorDescontoDisciplinaExcluida();
				if (matriculaPeriodoTurmaDisciplinaVO.getModalidadeDisciplina().equals(ModalidadeDisciplinaEnum.ON_LINE)) {
					if(condicaoPgto.getTipoCalculoParcela().equals("VC")) {
						valorDesconto = condicaoPgto.getValorDescontoDisciplinaRegularEAD();
					} else if(condicaoPgto.getTipoCalculoParcela().equals("VF")) {
						valorDesconto = condicaoPgto.getValorFixoDisciplinaExcluidaEAD();
					}
				}
				Double valorDescontoDisciplina = calcularValorDisciplinaEspecificaExcluida(tipoCalculo, valorDesconto, matriculaPeriodoTurmaDisciplinaVO);
				totalDisciplinasExcluidas += valorDescontoDisciplina;
			}
		}
		return Uteis.arrendondarForcando2CadasDecimais(totalDisciplinasExcluidas);
	}

	/**
	 * Rotina Responsável por calcular somente o valor da matrícula. com base
	 * nas condicoes de pagamento.
	 * 
	 * @throws Exception
	 */
	private void executarRealizarCalculoValorMatricula(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaEstimadaAluno, UsuarioVO usuario) throws Exception {
		// matriculaPeriodoVO.setPlanoFinanceiroCurso(getFacadeFactory().getPlanoFinanceiroCursoFacade().consultarPorChavePrimaria(matriculaPeriodoVO.getPlanoFinanceiroCurso().getCodigo(),
		// "AT", Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario));
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoControlarMatricula()) {
			matriculaPeriodoVO.setValorMatriculaCheio(0.0);
			matriculaPeriodoVO.setValorFinalMatricula(0.0);
			return;
		}
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().utilizaValorMatriculaMensalidadeFixo()) {
			if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getUtilizarValorMatriculaFixo()) {
				matriculaPeriodoVO.setValorMatriculaCheio(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMatricula());
				matriculaPeriodoVO.calcularValorMatricula(matriculaPeriodoVO.getValorMatriculaCheio(), matriculaPeriodoVO.getValorDescontoMatricula());
			} else {
				Double valorAdicionalDisciplinasIncluidas = calcularValorDisciplinasIncluidasConformeCondicaoPgto(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO);

				Double valorDescontoDisciplinaMatrizCursadasEAD = calcularValorDescontoDisciplinasMatrizEstudasEAD(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO, matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMatricula(), false);

				Double valorDescontoDisciplinasRemovidas = calcularValorDescontoDisciplinasExcluidas(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO, matriculaVO, usuario);

				Double valorFinal = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMatricula() + valorAdicionalDisciplinasIncluidas - valorDescontoDisciplinasRemovidas - valorDescontoDisciplinaMatrizCursadasEAD;
				if (valorFinal < matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMinimoParcelaSistemaPorCredito()) {
					valorFinal = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMinimoParcelaSistemaPorCredito();
				}
				if (!matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoControlarMatricula()) {
					if (valorFinal <= 0) {
						throw new Exception("O plano financeiro deste curso estão com problemas de configuração. Foi verificado que a taxa de matrícula está com valor zero(0), altere o plano financeiro ou procure o departamento financeiro.");
					}
				}
				matriculaPeriodoVO.setValorMatriculaCheio(Uteis.arrendondarForcando2CadasDecimais(valorFinal));
				matriculaPeriodoVO.calcularValorMatricula(matriculaPeriodoVO.getValorMatriculaCheio(), matriculaPeriodoVO.getValorDescontoMatricula());
			}
			return;
		}
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().utilizaValorMatriculaMensalidadeBaseadoNrCreditos()) {
			if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getUtilizarValorMatriculaFixo()) {
				matriculaPeriodoVO.setValorMatriculaCheio(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMatriculaSistemaPorCredito());
			} else {
				Double valorMatriculaDisciplinasPorCredito = calcularValorMatriculaMensalidadeComBaseNrCreditosDisciplinas(matriculaPeriodoVO, listaDisciplinaEstimadaAluno);
				matriculaPeriodoVO.setValorMatriculaCheio(valorMatriculaDisciplinasPorCredito);
			}
			matriculaPeriodoVO.calcularValorMatricula(matriculaPeriodoVO.getValorMatriculaCheio(), matriculaPeriodoVO.getValorDescontoMatricula());
			return;
		}
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().utilizaValorMatriculaMensalidadeBaseadoFormaCalculo()) {
			if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getUtilizarValorMatriculaFixo()) {
				matriculaPeriodoVO.setValorMatriculaCheio(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMatriculaSistemaPorCredito());
			} else {
				matriculaPeriodoVO.setValorMatriculaCheio(calcularValorMatriculaMensalidadeComFormaCalculo(matriculaPeriodoVO, matriculaVO, listaDisciplinaEstimadaAluno, usuario));
			}
			matriculaPeriodoVO.calcularValorMatricula(matriculaPeriodoVO.getValorMatriculaCheio(), matriculaPeriodoVO.getValorDescontoMatricula());
			return;
		}
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getIsValorPorDisciplina()) {
			if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoControlarMatricula()) {
				matriculaPeriodoVO.setValorMatriculaCheio(0.0);
				return;
			}
			if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getUtilizarValorMatriculaFixo()) {
				matriculaPeriodoVO.setValorMatriculaCheio(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMatricula());
			} else {
				matriculaPeriodoVO.setValorMatriculaCheio(calcularValorMatriculaMensalidadeComBaseValorPorDisciplina(matriculaPeriodoVO, listaDisciplinaEstimadaAluno, usuario));
			}
			matriculaPeriodoVO.calcularValorMatricula(matriculaPeriodoVO.getValorMatriculaCheio(), matriculaPeriodoVO.getValorDescontoMatricula());
			return;
		}
	}

	/**
	 * Rotina Responsável por calcular somente o valor das mensalidades.
	 * 
	 * @throws Exception
	 */
	private void executarRealizarCalculoValorMensalidade(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaEstimadaAluno, UsuarioVO usuario) throws Exception {
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().utilizaValorMatriculaMensalidadeFixo()) {
			
			Double valorAdicionalDisciplinasIncluidas = calcularValorDisciplinasIncluidasConformeCondicaoPgto(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO);

			Double valorDescontoDisciplinaMatrizCursadasEAD = calcularValorDescontoDisciplinasMatrizEstudasEAD(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO, matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMatricula(), false);

			Double valorDescontoDisciplinasRemovidas = calcularValorDescontoDisciplinasExcluidas(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO, matriculaVO, usuario);

			Double valorFinal = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorParcela() + valorAdicionalDisciplinasIncluidas - valorDescontoDisciplinaMatrizCursadasEAD - valorDescontoDisciplinasRemovidas;
			if (valorFinal < matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMinimoParcelaSistemaPorCredito()) {
				valorFinal = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMinimoParcelaSistemaPorCredito();
			}
			if (valorFinal.equals(0.0) && !matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNaoControlarValorParcela()) {
				throw new Exception("O plano financeiro deste curso estão com problemas de configuração. Foi gerada uma taxa de matrícula com o valor zero(0).");
			} else if (valorFinal < 0) {
				throw new Exception("O plano financeiro deste curso estão com problemas de configuração. Foi gerada uma taxa de matrícula com o valor menor que zero(0).");
			}
			matriculaPeriodoVO.setValorMensalidadeCheio(Uteis.arrendondarForcando2CadasDecimais(valorFinal));
			matriculaPeriodoVO.calcularValorMensalidade(matriculaPeriodoVO.getValorMensalidadeCheio(), matriculaPeriodoVO.getValorDescontoMensalidade());
			return;
		}
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().utilizaValorMatriculaMensalidadeBaseadoNrCreditos()) {
			matriculaPeriodoVO.setValorMensalidadeCheio(calcularValorMatriculaMensalidadeComBaseNrCreditosDisciplinas(matriculaPeriodoVO, listaDisciplinaEstimadaAluno));
			matriculaPeriodoVO.calcularValorMensalidade(matriculaPeriodoVO.getValorMensalidadeCheio(), matriculaPeriodoVO.getValorDescontoMensalidade());
			return;
		}
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().utilizaValorMatriculaMensalidadeBaseadoFormaCalculo()) {
			matriculaPeriodoVO.setValorMensalidadeCheio(calcularValorMatriculaMensalidadeComFormaCalculo(matriculaPeriodoVO, matriculaVO, listaDisciplinaEstimadaAluno, usuario));
			matriculaPeriodoVO.calcularValorMensalidade(matriculaPeriodoVO.getValorMensalidadeCheio(), matriculaPeriodoVO.getValorDescontoMensalidade());
			return;
		}
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getIsValorPorDisciplina()) {
			matriculaPeriodoVO.setValorMensalidadeCheio(calcularValorMatriculaMensalidadeComBaseValorPorDisciplina(matriculaPeriodoVO, listaDisciplinaEstimadaAluno, usuario));
			matriculaPeriodoVO.calcularValorMensalidade(matriculaPeriodoVO.getValorMensalidadeCheio(), matriculaPeriodoVO.getValorDescontoMensalidade());
			return;
		}
	}

	/**
	 * Método alterado na versão 5.0 para poder cobrar um valor por disciplina
	 * incluida, com diferenciacao do valor cobrado das disciplinas regulares.
	 * Assim, como poder estabeler um valor diferenciado para disciplinas de
	 * dependencia e para modalidade.
	 * 
	 * @param matriculaPeriodoVO
	 * @param listaDisciplinaEstimadaAluno
	 * @return
	 */
	private Double calcularValorMatriculaMensalidadeComBaseNrCreditosDisciplinas(MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaEstimadaAluno) throws Exception {
		Double valorUnitarioCredito = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorUnitarioCredito();
		Double totalCreditos = 0.0;
		Iterator i = listaDisciplinaEstimadaAluno.iterator();
		while (i.hasNext()) {
			MatriculaPeriodoTurmaDisciplinaVO matTurmaDisciplina = (MatriculaPeriodoTurmaDisciplinaVO) i.next();
			if ((!matTurmaDisciplina.getDisciplinaFazParteComposicao()) && (!matTurmaDisciplina.getDisciplinaIncluida())) { // este
				// parte
				// calcula
				// o
				// valor
				// para
				// as
				// disciplinas
				// regulares
				// (nao
				// incluidas).
				// Incluidas
				// sao
				// tratadas
				// abaixo
				// em
				// Método
				// especï¿½fico
				totalCreditos = totalCreditos + matTurmaDisciplina.getCreditosFinanceirosDisciplina();
			}
		}
		Double valorMatriculaCredito = Uteis.arredondar((totalCreditos * valorUnitarioCredito), 2, 0);
		Double valorAdicionalDisciplinasIncluidas = calcularValorDisciplinasIncluidasConformeCondicaoPgto(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO);
		Double valorDescontoDisciplinaMatrizCursadasEAD = calcularValorDescontoDisciplinasMatrizEstudasEAD(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO, matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMatricula(), true);
		valorMatriculaCredito += valorAdicionalDisciplinasIncluidas - valorDescontoDisciplinaMatrizCursadasEAD;
		if (valorMatriculaCredito <= matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMinimoParcelaSistemaPorCredito()) {
			valorMatriculaCredito = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMinimoParcelaSistemaPorCredito();
		}
		return valorMatriculaCredito;
	}

	private Boolean verificarCondicacaoPagamentoPermiteGerarDescontoRelativoCHAlunoInferiorCargaCHTurmaPeriodo(MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaEstimadaAluno) throws Exception {
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getGerarDescontoPorDiscipliaExcluidas()) {
			Boolean somenteUltimoPeriodo = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getGerarDescontoPorDisciplinExcluidasSomenteUltimoPeriodo();
			if ((somenteUltimoPeriodo) && (!matriculaPeriodoVO.getIsUltimoPeriodoLetivo())) {
				return false;
			}
			// E por que o desconto deve ser gerado para todos os periodos (e
			// nao somente para ultimo)
			// ou o aluno nao esta no ultimo periodo, o que tambem implica que
			// ate aqui o mesmo pode
			// obter o desconto.
			if ((somenteUltimoPeriodo) && (matriculaPeriodoVO.getIsUltimoPeriodoLetivo())) {
				// Caso seja somente para o ultimo periodo e o aluno esta no
				// ultimo temos,
				// ainda temos que verificar o nr maximo de disciplina que ele
				// pode estar cursando para
				// gerar o desconto.
				Integer nrMaxDisciplinaLiberarDesc = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNumeroMaximoDisciplinaCursarParaGerarDescontos();
				// Integer nrDisciplinasAluno =
				// listaDisciplinaEstimadaAluno.size();
				Integer nrDisciplinasAluno = 0;
				for (MatriculaPeriodoTurmaDisciplinaVO matTurmaDisciplina : listaDisciplinaEstimadaAluno) {
					if (!matTurmaDisciplina.getDisciplinaFazParteComposicao() && !matTurmaDisciplina.getInclusaoForaPrazo()) {
						nrDisciplinasAluno++;
					}
				}
				if (nrDisciplinasAluno > nrMaxDisciplinaLiberarDesc) {
					return false;
				}
			}
			return true;
		}
		return false;
	}

	private Double calcularValorMatriculaMensalidadeComBaseValorPorDisciplina(MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaEstimadaAluno, UsuarioVO usuario) throws Exception {
		Double valorMensalidadeAluno = 0.0;
		for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : listaDisciplinaEstimadaAluno) {
			valorMensalidadeAluno += getFacadeFactory().getCondicaoPlanoFinanceiroCursoTurmaFacade().consultarValorCondicaoPlanoFinanceiroCursoTurma(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo(), usuario);
		}
		return valorMensalidadeAluno / matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNrParcelasPeriodo();
	}

	private Double calcularValorMatriculaMensalidadeComFormaCalculo(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaVO matriculaVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaEstimadaAluno, UsuarioVO usuario) throws Exception {
		Double valorMensalidadeBase = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getVariavel1();
		List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaPadraoTurmaPeriodoLetivo = obterListaMatriculaPeriodoTurmaDisciplinaVOPeriodoLetivoTurmaIndependenteAluno(matriculaPeriodoVO, matriculaVO, usuario);

		executarCalculoAtualizarTotaisCargaHorariaCreditoProgramadoParaTurmaPeriodoLetivo(matriculaPeriodoVO, listaDisciplinaPadraoTurmaPeriodoLetivo);
		executarCalculoAtualizarTotaisCargaHorariaCreditoMatriculaPeriodoAluno(matriculaPeriodoVO, listaDisciplinaEstimadaAluno);

		Integer cargaHorariaPeriodoLetivo = matriculaPeriodoVO.getTotalCargaHorariaPadraoMatriculaPeriodo();
		Integer cargaHorariaAluno = matriculaPeriodoVO.getTotalCargaHorariaAlunoMatriculaPeriodo();

		Integer cargaHorariaAplicarFormulaParaCalculo = cargaHorariaAluno;
		if (cargaHorariaAluno < cargaHorariaPeriodoLetivo) {
			// Como a carga horaria do aluno ï¿½ menor que a carga horï¿½ria do
			// periodo letivo, então,
			// temos que isto irá gerar um desconto para o aluno na mensalidade.
			// Portanto, ï¿½
			// necessario verificar na condicao de pagamento do curso, se este
			// desconto deve
			// ou nao ser concedido para o aluno em questao. Caso contrï¿½io, o
			// valor a ser cobrado,
			// deve ser o valor Padrão do curso, ou seja, valor calculado com
			// base na carga horaria da
			// turma/periodo
			if (!verificarCondicacaoPagamentoPermiteGerarDescontoRelativoCHAlunoInferiorCargaCHTurmaPeriodo(matriculaPeriodoVO, listaDisciplinaEstimadaAluno)) {
				cargaHorariaAplicarFormulaParaCalculo = cargaHorariaPeriodoLetivo;
			}
		}

		// Temos que aplicar uma formula de calculo para calcular o valor da
		// hora da disciplina.
		// O objetivo e processar uma formula similar e listada abaixo.
		// ((VM * CHPH)/CHD);
		matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().setUtilizarVariavel1(Boolean.TRUE);
		matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().setTituloVariavel1("VM");
		matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().setUtilizarVariavel2(Boolean.TRUE);
		matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().setTituloVariavel2("CHPL");
		matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().setUtilizarVariavel3(Boolean.TRUE);
		matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().setTituloVariavel3("CHD");
		Double valorMensalidadeAluno = 0.0;
		if (cargaHorariaPeriodoLetivo == 0) {
			throw new Exception("Não foi possível determinar a carga horário do Período letivo do curso/turma. Verifique se as disciplinas estãoo registradas na turma do aluno e se a matriz curricular do curso estão correta.");
		}
		if (!valorMensalidadeBase.equals(0.0)) {
			valorMensalidadeAluno = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().realizarCalculoFormulaSubstituindoVariaveisPorValores(valorMensalidadeBase, new Double(cargaHorariaPeriodoLetivo), new Double(cargaHorariaAplicarFormulaParaCalculo));
		}
		return valorMensalidadeAluno;
	}
	
	
	private void executarRealizarCalculoValorMaterialDidatico(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaDisciplinaEstimadaAluno, UsuarioVO usuario) throws Exception {
		if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isGerarParcelaMaterialDidatico()) {
			matriculaPeriodoVO.setValorMaterialDidaticoCheio(Uteis.arrendondarForcando2CadasDecimais(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorPorParcelaMaterialDidatico()));
			matriculaPeriodoVO.calcularValorMaterialDidatico(matriculaPeriodoVO.getValorMaterialDidaticoCheio(), matriculaPeriodoVO.getValorDescontoMaterialDidatico());
			//Metodo comentando pois a regra nao deveria validar se no plano financeiro do aluno e por credito ou fixo o material didatico não segue essa regra.
			/*if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().utilizaValorMatriculaMensalidadeFixo()) {
				Double valorAdicionalDisciplinasIncluidas = calcularValorDisciplinasIncluidasConformeCondicaoPgto(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO);

				Double valorDescontoDisciplinaMatrizCursadasEAD = calcularValorDescontoDisciplinasMatrizEstudasEAD(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO, matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorMatricula(), false);

				Double valorDescontoDisciplinasRemovidas = calcularValorDescontoDisciplinasExcluidas(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO, matriculaVO, usuario);

				Double valorFinal = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getValorPorParcelaMaterialDidatico();
				matriculaPeriodoVO.setValorMaterialDidaticoCheio(Uteis.arrendondarForcando2CadasDecimais(valorFinal));
				matriculaPeriodoVO.calcularValorMaterialDidatico(matriculaPeriodoVO.getValorMaterialDidaticoCheio(), matriculaPeriodoVO.getValorDescontoMaterialDidatico());
				return;
			}
			
			if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().utilizaValorMatriculaMensalidadeBaseadoNrCreditos()) {
				matriculaPeriodoVO.setValorMaterialDidaticoCheio(calcularValorMatriculaMensalidadeComBaseNrCreditosDisciplinas(matriculaPeriodoVO, listaDisciplinaEstimadaAluno));
				matriculaPeriodoVO.calcularValorMaterialDidatico(matriculaPeriodoVO.getValorMaterialDidaticoCheio(), matriculaPeriodoVO.getValorDescontoMaterialDidatico());
				return;
			}
			if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().utilizaValorMatriculaMensalidadeBaseadoFormaCalculo()) {
				matriculaPeriodoVO.setValorMaterialDidaticoCheio(calcularValorMatriculaMensalidadeComFormaCalculo(matriculaPeriodoVO, matriculaVO, listaDisciplinaEstimadaAluno, usuario));
				matriculaPeriodoVO.calcularValorMaterialDidatico(matriculaPeriodoVO.getValorMaterialDidaticoCheio(), matriculaPeriodoVO.getValorDescontoMaterialDidatico());
				return;
			}
			if (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getIsValorPorDisciplina()) {
				matriculaPeriodoVO.setValorMaterialDidaticoCheio(calcularValorMatriculaMensalidadeComBaseValorPorDisciplina(matriculaPeriodoVO, listaDisciplinaEstimadaAluno, usuario));
				matriculaPeriodoVO.calcularValorMaterialDidatico(matriculaPeriodoVO.getValorMaterialDidaticoCheio(), matriculaPeriodoVO.getValorDescontoMaterialDidatico());
				return;
			}*/
		}
	}
	

	public static void carregarDadosMatriculaPeriodoVencimentoVOs(MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
//		matriculaPeriodoVO.setMatriculaPeriodoVencimentoVOs(MatriculaPeriodoVencimento.consultarMatriculaPeriodoVencimentoVOs(matriculaPeriodoVO, false, Uteis.NIVELMONTARDADOS_DADOSCONSULTARTODOS, configuracaoFinanceiroVO, usuario));
	}

	// public void verificarAlunoJaAprovadoNaDisciplina(MatriculaPeriodoVO
	// mattriculaPeriodoVO, DisciplinaVO disciplinaVO) throws Exception {
	// mattriculaPeriodoVO.
	// List<HistoricoVO> lista =
	// getFacadeFactory().getHistoricoFacade().consultarPorMatricula(mat.getMatricula(),
	// OrdemHistoricoDisciplina.ANO_SEMESTRE.getValor(), false,
	// Uteis.NIVELMONTARDADOS_DADOSBASICOS);
	// for (HistoricoVO obj : lista) {
	// if (obj.getDisciplina().getCodigo().intValue() ==
	// grade.getDisciplina().getCodigo().intValue()) {
	// if (obj.getSituacao().equals("AA") || obj.getSituacao().equals("AP")) {
	// throw new Exception("Aluno já aprovado nessa disciplina.");
	// }
	// }
	// }
	// }
	public MatriculaPeriodoVO consultaRapidaFichaAlunoPorMatriculaPeriodo(MatriculaPeriodoVO obj, Integer matriculaPeriodo) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		// Dados da MatriculaPeriodo
		sqlStr.append("select distinct MatriculaPeriodo.codigo, MatriculaPeriodo.situacaoMatriculaPeriodo, MatriculaPeriodo.ano, MatriculaPeriodo.semestre, MatriculaPeriodo.data, MatriculaPeriodo.dataVencimentoMatriculaEspecifico,  MatriculaPeriodo.carneEntregue, ");
		sqlStr.append("PeriodoLetivo.codigo AS \"PeriodoLetivo.codigo\", PeriodoLetivo.descricao AS \"PeriodoLetivo.descricao\" ");
		sqlStr.append(" from MatriculaPeriodo");
		sqlStr.append(" LEFT JOIN PeriodoLetivo on PeriodoLetivo.codigo = MatriculaPeriodo.periodoLetivoMatricula ");
		sqlStr.append("WHERE matriculaPeriodo.codigo = '");
		sqlStr.append(matriculaPeriodo);
		sqlStr.append("'");
		sqlStr.append(" ORDER BY periodoLetivo.descricao");

		// }

		// sqlStr.append("select distinct MatriculaPeriodo.codigo, MatriculaPeriodo.situacaoMatriculaPeriodo, MatriculaPeriodo.ano, MatriculaPeriodo.semestre, MatriculaPeriodo.data, ");
		// //Dados do Periodo Letivo
		// sqlStr.append("PeriodoLetivo.codigo AS \"PeriodoLetivo.codigo\", PeriodoLetivo.descricao AS \"PeriodoLetivo.descricao\", ");
		// //Dados da Turma
		// sqlStr.append("Turma.codigo AS \"Turma.codigo\", Turma.identificadorTurma AS \"Turma.identificadorTurma\", ");
		// //Dados da Disciplina
		// sqlStr.append("Disciplina.codigo AS \"Disciplina.codigo\", disciplina.nome AS \"Disciplina.nome\", disciplina.cargaHoraria AS \"Disciplina.cargaHoraria\", ");
		// //Dados da Matricula Periodo Turma Disciplin
		// sqlStr.append("mptd.codigo AS \"MatriculaPeriodoTurmaDisciplina.codigo\", ");
		// //Dados da Disciplina Equivalente
		// sqlStr.append(" historico.codigo AS \"historico.codigo\", historico.situacao AS \"historico.situacao\", historico.mediaFinal AS \"mediaFinal\", historico.freguencia AS \"historico.frequencia\" ");
		//
		// sqlStr.append("from MatriculaPeriodo ");
		// sqlStr.append("LEFT JOIN PeriodoLetivo on PeriodoLetivo.codigo = MatriculaPeriodo.periodoLetivoMatricula ");
		// sqlStr.append("LEFT JOIN MatriculaPeriodoTurmaDisciplina mptd on mptd.matriculaPeriodo = MatriculaPeriodo.codigo ");
		// sqlStr.append("LEFT JOIN Turma on turma.codigo = mptd.turma ");
		// sqlStr.append("LEFT JOIN Disciplina on disciplina.codigo = mptd.disciplina ");
		// sqlStr.append("LEFT JOIN Historico on historico.disciplina = disciplina.codigo ");
		// sqlStr.append("WHERE matriculaPeriodo.codigo = '");
		// sqlStr.append(matriculaPeriodo);
		// sqlStr.append("'");
		// sqlStr.append(" ORDER BY periodoLetivo.descricao");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		tabelaResultado.next();
		return montarDadosAcademicoFichaAluno(obj, tabelaResultado);
	}

	private static MatriculaPeriodoVO montarDadosAcademicoFichaAluno(MatriculaPeriodoVO obj, SqlRowSet dadosSQL) throws Exception {
		// Dados da Matrícula Periodo
		obj.setCodigo(dadosSQL.getInt("codigo"));
		obj.setSituacaoMatriculaPeriodo(dadosSQL.getString("situacaoMatriculaPeriodo"));
		obj.setAno(dadosSQL.getString("ano"));
		obj.setSemestre(dadosSQL.getString("semestre"));
		obj.setData(dadosSQL.getDate("data"));
		obj.setDataVencimentoMatriculaEspecifico(dadosSQL.getDate("dataVencimentoMatriculaEspecifico"));
		obj.setCarneEntregue(dadosSQL.getBoolean("carneEntregue"));
		// Dados do Perido Letivo
		obj.getPeridoLetivo().setCodigo(dadosSQL.getInt("PeriodoLetivo.codigo"));
		obj.getPeridoLetivo().setDescricao(dadosSQL.getString("PeriodoLetivo.descricao"));

		// MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmadisciplinaVO =
		// null;
		// do {
		// matriculaPeriodoTurmadisciplinaVO = new
		// MatriculaPeriodoTurmaDisciplinaVO();
		// matriculaPeriodoTurmadisciplinaVO.setCodigo(dadosSQL.getInt("MatriculaPeriodoTurmaDisciplina.codigo"));
		// if (matriculaPeriodoTurmadisciplinaVO.getCodigo() == null ||
		// matriculaPeriodoTurmadisciplinaVO.getCodigo().equals(0)) {
		// continue;
		// }
		// matriculaPeriodoTurmadisciplinaVO.getTurma().setCodigo(dadosSQL.getInt("Turma.codigo"));
		// matriculaPeriodoTurmadisciplinaVO.getTurma().setIdentificadorTurma(dadosSQL.getString("Turma.identificadorTurma"));
		// matriculaPeriodoTurmadisciplinaVO.getDisciplina().setCodigo(dadosSQL.getInt("Disciplina.codigo"));
		// matriculaPeriodoTurmadisciplinaVO.getDisciplina().setNome(dadosSQL.getString("Disciplina.nome"));
		// matriculaPeriodoTurmadisciplinaVO.getDisciplina().setCargaHoraria(dadosSQL.getInt("Disciplina.cargaHoraria"));
		//
		// obj.getMatriculaPeriodoTumaDisciplinaVOs().add(matriculaPeriodoTurmadisciplinaVO);
		// } while (dadosSQL.next());

		return obj;
	}

	public void processarRotinaSetarCondicaoPagamentoAluno(UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVO> lista = consultaRapidaMatriculaPeriodoAtivaSemCondicaoPagamentoPlanoFinanceiro(usuario);
		for (MatriculaPeriodoVO p : lista) {
			GradeCurricularVO grade = getFacadeFactory().getGradeCurricularFacade().consultarPorChavePrimaria(p.getGradeCurricular().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			boolean doisanos = false;
			// verifica se ï¿½ dois anos ou dois anos e meio
			if ((grade.getNome().indexOf("30") != -1) || (grade.getNome().indexOf("2 anos e meio") != -1)) {
				doisanos = false;
			} else {
				doisanos = true;
			}
			// consulta unidade ensino curso e obtem o codigo
			// planofinanceirocurso
			UnidadeEnsinoCursoVO uniCur = getFacadeFactory().getUnidadeEnsinoCursoFacade().consultarPorChavePrimaria(p.getUnidadeEnsinoCurso(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			// obter as condicoes do plano financeiro do curso.
			// e verificar qual a condicao utilizar, baseado em ser 2 anos ou
			// 2,5 anos
			List<CondicaoPagamentoPlanoFinanceiroCursoVO> listaCond = getFacadeFactory().getCondicaoPagamentoPlanoFinanceiroCursoFacade().consultarPorCodigoPlanoFinanceiroCurso(uniCur.getPlanoFinanceiroCurso().getCodigo(), "", false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
			if (!listaCond.isEmpty()) {
				if (listaCond.size() > 1) {
					for (CondicaoPagamentoPlanoFinanceiroCursoVO condicao : listaCond) {
						if (condicao.getDescricao().indexOf("2,5") != -1) {
							if (!doisanos) {
								// alterar a matriculaperiodo do aluno.
								alterarMatriculaPeriodoSetandoCondicaoPagamentoAluno(p.getMatricula(), condicao.getCodigo());
							}
						} else {
							if (doisanos) {
								// alterar a matriculaperiodo do aluno.
								alterarMatriculaPeriodoSetandoCondicaoPagamentoAluno(p.getMatricula(), condicao.getCodigo());
							}
						}
					}
				} else {
					CondicaoPagamentoPlanoFinanceiroCursoVO condicao = listaCond.get(0);
					alterarMatriculaPeriodoSetandoCondicaoPagamentoAluno(p.getMatricula(), condicao.getCodigo());
				}
			}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarMatriculaPeriodoSetandoCondicaoPagamentoAluno(final String matricula, final Integer condicaoPagamento) throws Exception {
		final String sql = "UPDATE MatriculaPeriodo set condicaopagamentoplanofinanceirocurso=? WHERE matricula = ? and situacaoMatriculaPeriodo = 'AT'";

		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
				sqlAlterar.setInt(1, condicaoPagamento);
				sqlAlterar.setString(2, matricula);
				return sqlAlterar;
			}
		});

	}

	public List consultarTodosFeriados(UsuarioVO usuario) throws Exception {
		return getFacadeFactory().getFeriadoFacade().consultarTodosFeriados(false, Uteis.NIVELMONTARDADOS_TODOS, usuario);
	}

	/**
	 * Método que monta a data de vencimento de uma matricula periodo
	 * vencimento. Esse Método verifica no calendï¿½rio do processo de matrícula
	 * qual a data de vencimento da 1ï¿½ mensalidade. Com base nessa data ele
	 * gera a data de vencimento das mensalidades, considerando feriados, finais
	 * de semana e o ultimo dia de cada mï¿½s.
	 * 
	 * @since 14-01-2011 Não verifica mais feriados nem finais de semana.
	 * 
	 * @param nrMensalidade
	 * @param dataMatricula
	 * @param processoMatriculaCalendarioVO
	 * @return
	 * @throws Exception
	 */
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Date montarDataVencimento(Integer nrMensalidade, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		String diaVencimento = String.valueOf(matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDiaVencimentoPrimeiraMensalidade());
		Integer anoVencimento = (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getAnoVencimentoPrimeiraMensalidade());
		Integer mesVencimento = (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getMesVencimentoPrimeiraMensalidade());
		String dataFinal = "";
		
		if (!Uteis.isAtributoPreenchido(matriculaPeriodoVO.getTurma().getCodigo())) {
			TurmaVO turmaVO = getFacadeFactory().getTurmaFacade().consultarTurmaDoAlunoPorMatriculaPeriodo(matriculaPeriodoVO.getCodigo(), Uteis.NIVELMONTARDADOS_COMBOBOX, usuario);
			matriculaPeriodoVO.getTurma().setCodigo(turmaVO.getCodigo());
		}
		
		List listaFeriadoVOs = consultarTodosFeriados(usuario);
		if (nrMensalidade.intValue() == 1) {
			if (!matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getMesDataBaseGeracaoParcelas()) {
				if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getMesSubsequenteMatricula()) {
					Date dataVctoMatricula = matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDataVencimentoMatricula();
					if (!matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().isEmpty()) {
						for (MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO : matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()) {
							if (matriculaPeriodoVencimentoVO.getVencimentoReferenteMatricula()) {
								dataVctoMatricula = matriculaPeriodoVencimentoVO.getDataVencimento();
								break;
							}
						}
					} else {
						if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getDataVencimentoMatriculaEspecifico())) {
							dataVctoMatricula = matriculaPeriodoVO.getDataVencimentoMatriculaEspecifico();
						}else if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getUsarDataVencimentoDataMatricula()) {
							if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getQtdeDiasAvancarDataVencimentoMatricula() > 0) {
								dataVctoMatricula = (Uteis.obterDataAvancada(matriculaPeriodoVO.getData(), matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getQtdeDiasAvancarDataVencimentoMatricula()));
							} else {
								dataVctoMatricula = (matriculaPeriodoVO.getData());
							}
						} 
					}
					 
					Date novaDataFinal = montarDadosDataVencimentoMesSubsequenteMatricula(nrMensalidade, diaVencimento, dataVctoMatricula, listaFeriadoVOs);
					if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getDataBaseGeracaoParcelas())){
						return matriculaPeriodoVO.getDataBaseGeracaoParcelas();
					}
					return novaDataFinal;
				} else {
					if(diaVencimento == null || mesVencimento == null || anoVencimento == null) {
						throw new Exception("Não foi encontrado no CONTROLE GERAÇÃO DE PARCELAS as informações para compor a data base de vencimento das parcelas do aluno.");
					}
					dataFinal = diaVencimento + "/" + String.valueOf(mesVencimento) + "/" + String.valueOf(anoVencimento);
					Date novaDataFinal = Uteis.getDataConsiderandoUltimoDiaDoMes(dataFinal);
					if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getDataBaseGeracaoParcelas())){
						return matriculaPeriodoVO.getDataBaseGeracaoParcelas();
					}
					return novaDataFinal;
				}
			} else {
				if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getDataBaseGeracaoParcelas())){
					return matriculaPeriodoVO.getDataBaseGeracaoParcelas();
				}
				if (!Uteis.isAtributoPreenchido(matriculaPeriodoVO.getTurma().getDataBaseGeracaoParcelas()) ) {
					getFacadeFactory().getTurmaFacade().carregarDados(matriculaPeriodoVO.getTurma(), usuario);
				}
				return matriculaPeriodoVO.getTurma().getDataBaseGeracaoParcelas();
			}
		} else {
			if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getMesDataBaseGeracaoParcelas()) {
				nrMensalidade--;
				getFacadeFactory().getTurmaFacade().carregarDados(matriculaPeriodoVO.getTurma(), usuario);
				Date dataVctoMatricula = null;
				if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getDataBaseGeracaoParcelas())){
					diaVencimento =  String.valueOf(UteisData.getDiaMesData(matriculaPeriodoVO.getDataBaseGeracaoParcelas()));
					dataVctoMatricula = matriculaPeriodoVO.getDataBaseGeracaoParcelas();					
				}else if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getTurma().getDataBaseGeracaoParcelas())) {
					dataVctoMatricula = matriculaPeriodoVO.getTurma().getDataBaseGeracaoParcelas();
					diaVencimento = String.valueOf(Uteis.getDiaMesData(matriculaPeriodoVO.getTurma().getDataBaseGeracaoParcelas()));
				}else if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDiaVencimentoPrimeiraMensalidade())) {
					diaVencimento =  matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDiaVencimentoPrimeiraMensalidade().toString();
					if (!matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().isEmpty()) {
						for (MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO : matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()) {
							if (matriculaPeriodoVencimentoVO.getVencimentoReferenteMatricula()) {
								dataVctoMatricula = matriculaPeriodoVencimentoVO.getDataVencimento();
								break;
							}
						}
					} else {
						if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getDataVencimentoMatriculaEspecifico())) {
							dataVctoMatricula = matriculaPeriodoVO.getDataVencimentoMatriculaEspecifico();
						}else  if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getUsarDataVencimentoDataMatricula()) {
							if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getQtdeDiasAvancarDataVencimentoMatricula() > 0) {
								dataVctoMatricula = (Uteis.obterDataAvancada(matriculaPeriodoVO.getData(), matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getQtdeDiasAvancarDataVencimentoMatricula()));
							} else {
								dataVctoMatricula = (matriculaPeriodoVO.getData());
							}
						} 
					}					
				}else {
					throw new Exception("Não foi encontrado no CONTROLE GERAÇÃO DE PARCELAS as informações para compor a data base de vencimento das parcelas do aluno.");
				}
				if (!Uteis.isAtributoPreenchido(dataVctoMatricula)) {
					throw new Exception("Não foi encontrado no CONTROLE GERAÇÃO DE PARCELAS as informações para compor a data base de vencimento das parcelas do aluno.");
				}
				
				return montarDadosDataVencimentoMesSubsequenteMatricula(nrMensalidade, diaVencimento, dataVctoMatricula, listaFeriadoVOs);
			} else if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getMesSubsequenteMatricula()) {
				Date dataVctoMatricula = matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDataVencimentoMatricula();
				if (!matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().isEmpty()) {
					for (MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO : matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()) {
						if (matriculaPeriodoVencimentoVO.getVencimentoReferenteMatricula()) {
							dataVctoMatricula = matriculaPeriodoVencimentoVO.getDataVencimento();
							break;
						}
					}
				} else {
					if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getDataVencimentoMatriculaEspecifico())) {
						dataVctoMatricula = matriculaPeriodoVO.getDataVencimentoMatriculaEspecifico();
					}else if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getUsarDataVencimentoDataMatricula()) {
						if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getQtdeDiasAvancarDataVencimentoMatricula() > 0) {
							dataVctoMatricula = (Uteis.obterDataAvancada(matriculaPeriodoVO.getData(), matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getQtdeDiasAvancarDataVencimentoMatricula()));
						} else {
							dataVctoMatricula = (matriculaPeriodoVO.getData());
						}
					} 
				}
				Date dataBaseVencimentoParcelas = montarDadosDataVencimentoMesSubsequenteMatricula(1, diaVencimento, dataVctoMatricula, listaFeriadoVOs);
				if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getDataBaseGeracaoParcelas())){
					diaVencimento =  String.valueOf(UteisData.getDiaMesData(matriculaPeriodoVO.getDataBaseGeracaoParcelas()));
					dataVctoMatricula = matriculaPeriodoVO.getDataBaseGeracaoParcelas();
					nrMensalidade--;
				}
				Date novaDataFinal = montarDadosDataVencimentoMesSubsequenteMatricula(nrMensalidade, diaVencimento, dataVctoMatricula, listaFeriadoVOs);
				return novaDataFinal;
			} else {
				dataFinal = diaVencimento + "/" + String.valueOf(mesVencimento) + "/" + String.valueOf(anoVencimento);
				Date dataBaseVencimentoParcelas = Uteis.getDataConsiderandoUltimoDiaDoMes(dataFinal);
				if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getDataBaseGeracaoParcelas())){
					diaVencimento =  String.valueOf(UteisData.getDiaMesData(matriculaPeriodoVO.getDataBaseGeracaoParcelas()));
					mesVencimento =  UteisData.getMesData(matriculaPeriodoVO.getDataBaseGeracaoParcelas());
					anoVencimento =  UteisData.getAnoData(matriculaPeriodoVO.getDataBaseGeracaoParcelas());
//					nrMensalidade--;
				}
				mesVencimento = mesVencimento + nrMensalidade - 1;
				if (mesVencimento > 12) {
					anoVencimento = anoVencimento + new Integer(1);
					mesVencimento = mesVencimento - 12;
				}
				dataFinal = diaVencimento + "/" + String.valueOf(mesVencimento) + "/" + String.valueOf(anoVencimento);
				Date novaDataFinal = Uteis.getDataConsiderandoUltimoDiaDoMes(dataFinal);
				return novaDataFinal;
			}
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Date montarDataCompetencia(Integer nrMensalidade, Date dataVencimento, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception {
		if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getConsiderarCompetenciaVctoMensalidade()) {
			return Uteis.getDataPrimeiroDiaMes(dataVencimento);
		} else {
			String diaVencimento = "01";
			Integer anoVencimento = (Uteis.getAnoData(matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDataCompetenciaMensalidade()));
			Integer mesVencimento = (Uteis.getMesData(matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getDataCompetenciaMensalidade()));
			String dataFinal = "";
			List listaFeriadoVOs = consultarTodosFeriados(usuario);
			if (nrMensalidade.intValue() == 1) {
				if (!matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getMesDataBaseGeracaoParcelas()) {
					dataFinal = diaVencimento + "/" + String.valueOf(mesVencimento) + "/" + String.valueOf(anoVencimento);
					Date novaDataFinal = Uteis.getDataPrimeiroDiaMes(Uteis.getDataConsiderandoUltimoDiaDoMes(dataFinal));
					return novaDataFinal;
				} else {
					return Uteis.getDataPrimeiroDiaMes(matriculaPeriodoVO.getTurma().getDataBaseGeracaoParcelas());
				}
			} else {
				if (matriculaPeriodoVO.getProcessoMatriculaCalendarioVO().getMesDataBaseGeracaoParcelas()) {
					getFacadeFactory().getTurmaFacade().carregarDados(matriculaPeriodoVO.getTurma(), usuario);
					Date novaDataFinal = montarDadosDataVencimentoDataBaseGeracaoParcelas(nrMensalidade, String.valueOf(Uteis.getDiaMesData(matriculaPeriodoVO.getTurma().getDataBaseGeracaoParcelas())), matriculaPeriodoVO.getTurma().getDataBaseGeracaoParcelas(), listaFeriadoVOs);
					return Uteis.getDataPrimeiroDiaMes(novaDataFinal);
				} else {
					mesVencimento = mesVencimento + nrMensalidade - 1;
					if (mesVencimento > 12) {
						anoVencimento = anoVencimento + new Integer(1);
						mesVencimento = mesVencimento - 12;
					}
					dataFinal = diaVencimento + "/" + String.valueOf(mesVencimento) + "/" + String.valueOf(anoVencimento);
					Date novaDataFinal = Uteis.getDataConsiderandoUltimoDiaDoMes(dataFinal);
					return Uteis.getDataPrimeiroDiaMes(novaDataFinal);
				}
			}
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Date montarDadosDataVencimentoMesSubsequenteMatricula(Integer nrMensalidade, String diaVencimento, Date dataMatricula, List listaFeriadoVOs) throws Exception {
		String dataFinal = "";
		Integer mesVencimentoSubsequenteMatricula = Uteis.getMesDataVencimento(dataMatricula);
		Integer anoVencimentoSubsequenteMatricula = Uteis.getAnoData(dataMatricula);
		if (Uteis.getMesData(dataMatricula) == 12) {
			anoVencimentoSubsequenteMatricula++;
		}
		if (nrMensalidade.intValue() == 1) {
			dataFinal = diaVencimento + "/" + String.valueOf(mesVencimentoSubsequenteMatricula) + "/" + String.valueOf(anoVencimentoSubsequenteMatricula);
			// Date novaDataFinal =
			// getNextWorkingDay(Uteis.getDataConsiderandoUltimoDiaDoMes(dataFinal),
			// listaFeriadoVOs);
			Date novaDataFinal = Uteis.getDataConsiderandoUltimoDiaDoMes(dataFinal);
			// String novaDataFinal =
			// consultarDiaUtilSemanaGerarVencimento(dataFinal, diaVencimento,
			// mesVencimentoSubsequenteMatricula,
			// anoVencimentoSubsequenteMatricula);
			return novaDataFinal;
		} else {
			mesVencimentoSubsequenteMatricula = mesVencimentoSubsequenteMatricula + nrMensalidade - 1;
			if (mesVencimentoSubsequenteMatricula > 12) {
				anoVencimentoSubsequenteMatricula = anoVencimentoSubsequenteMatricula + new Integer(1);
				mesVencimentoSubsequenteMatricula = mesVencimentoSubsequenteMatricula - 12;
			}
			dataFinal = diaVencimento + "/" + String.valueOf(mesVencimentoSubsequenteMatricula) + "/" + String.valueOf(anoVencimentoSubsequenteMatricula);
			// Date novaDataFinal =
			// getNextWorkingDay(Uteis.getDataConsiderandoUltimoDiaDoMes(dataFinal),
			// listaFeriadoVOs);
			Date novaDataFinal = Uteis.getDataConsiderandoUltimoDiaDoMes(dataFinal);
			// String novaDataFinal =
			// consultarDiaUtilSemanaGerarVencimento(dataFinal, diaVencimento,
			// mesVencimentoSubsequenteMatricula,
			// anoVencimentoSubsequenteMatricula);
			return novaDataFinal;
		}
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public Date montarDadosDataVencimentoDataBaseGeracaoParcelas(Integer nrMensalidade, String diaVencimento, Date dataMatricula, List listaFeriadoVOs) throws Exception {
		String dataFinal = "";
		Integer mesPrimeiraMensalidade = Uteis.getMesDataVencimento(dataMatricula) - 1;
		if (Uteis.getMesDataVencimento(dataMatricula) == 1) {
			mesPrimeiraMensalidade = 13 - 1;
		}
		Integer anoVencimentoSubsequenteMatricula = Uteis.getAnoData(dataMatricula);
		mesPrimeiraMensalidade = mesPrimeiraMensalidade + nrMensalidade - 1;
		if (mesPrimeiraMensalidade > 12) {
			anoVencimentoSubsequenteMatricula = anoVencimentoSubsequenteMatricula + new Integer(1);
			mesPrimeiraMensalidade = mesPrimeiraMensalidade - 12;
		}
		dataFinal = diaVencimento + "/" + String.valueOf(mesPrimeiraMensalidade) + "/" + String.valueOf(anoVencimentoSubsequenteMatricula);
		Date novaDataFinal = Uteis.getDataConsiderandoUltimoDiaDoMes(dataFinal);
		return novaDataFinal;
	}

	@SuppressWarnings("static-access")
	public Date getNextWorkingDay(Date aDate, List<FeriadoVO> listaFeriadoVOs) {
		Date dataIncremental = aDate;
		Date dataAuxIncremental = aDate;
		while (!isWorkingDay(dataAuxIncremental, listaFeriadoVOs)) {
			dataAuxIncremental = new Date(dataAuxIncremental.getTime() + ONE_DAY);
		}
		Calendar cal1 = new GregorianCalendar();
		cal1.setTime(dataAuxIncremental);
		Calendar cal2 = new GregorianCalendar();
		cal2.setTime(dataIncremental);
		if (cal1.get(cal1.MONTH) != cal2.get(cal2.MONTH)) {
			Date dataRetroativo = aDate;
			while (!isWorkingDay(dataRetroativo, listaFeriadoVOs)) {
				dataRetroativo = new Date(dataRetroativo.getTime() - ONE_DAY);
			}
			return dataRetroativo;
		} else {
			dataIncremental = dataAuxIncremental;
			return dataIncremental;
		}
	}

	public boolean isWorkingDay(Date date, List<FeriadoVO> listaFeriadoVOs) {
		if (!Uteis.isWorkingWeekDay(date)) {
			return false;
		}

		for (FeriadoVO holiday : listaFeriadoVOs) {
			if (holiday.isHoliday(date)) {
				return false;
			}
		}

		return true;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarUnidadeEnsinoCursoETurma(Integer codigoMatriculaPeriodo, Integer codigoTurma, Integer codigoUnidadeEnsinoCurso) throws Exception {
		String sqlStr = "UPDATE matriculaperiodo SET unidadeensinocurso = ?, turma = ? WHERE codigo = ?";
		getConexao().getJdbcTemplate().update(sqlStr, new Object[] { codigoUnidadeEnsinoCurso, codigoTurma, codigoMatriculaPeriodo });
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarPlanoFinanceiroCursoECondicaoPagamentoDaMatricula(Integer codigoMatriculaPeriodo, Integer codigoPlanoFinanceiroCurso, Integer condicaoPagamento) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("UPDATE matriculaperiodo SET planofinanceirocurso = ").append(codigoPlanoFinanceiroCurso).append(" ");
		if (condicaoPagamento != 0) {
			sqlStr.append(", condicaopagamentoplanofinanceirocurso = ").append(condicaoPagamento).append(" ");
		}
		sqlStr.append("WHERE codigo = ").append(codigoMatriculaPeriodo).append(" ");
		getConexao().getJdbcTemplate().update(sqlStr.toString());
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarContaReceberMatriculaPeriodo(Integer codigoMatriculaPeriodo) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("UPDATE matriculaperiodo SET contaReceber = null ");
		sqlStr.append(" WHERE codigo = ").append(codigoMatriculaPeriodo).append(" ");
		getConexao().getJdbcTemplate().update(sqlStr.toString());
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void atualizarDataBaseGeracaoParcelaMatriculaPeriodo(Integer codigoMatriculaPeriodo, Date dataBaseGeracaoParcelas) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		if (Uteis.isAtributoPreenchido(dataBaseGeracaoParcelas)) {
			sqlStr.append("UPDATE matriculaperiodo SET dataBaseGeracaoParcelas = '").append(Uteis.getDataJDBC(dataBaseGeracaoParcelas)).append("' ");
		} else {
			sqlStr.append("UPDATE matriculaperiodo SET dataBaseGeracaoParcelas = null ");
		}
		sqlStr.append(" WHERE codigo = ").append(codigoMatriculaPeriodo).append(" ");
		getConexao().getJdbcTemplate().update(sqlStr.toString());
	}

	public List<MatriculaPeriodoVO> consultarPorContaReceberMatriculaPeriodo(Integer contaReceber, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT * FROM matriculaperiodo ");
		sqlStr.append(" where contareceber = ").append(contaReceber.intValue()).append(" ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return (montarDadosConsulta(tabelaResultado, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, configuracaoFinanceiroVO, usuario));
	}

	public void validarDadosRenovacaoProcessoMatriculaPeriodoLetivo(MatriculaVO matriculaVO, MatriculaPeriodoVO obj, UsuarioVO usuario, ConfiguracaoGeralSistemaVO conf) throws Exception {
		consultarPorMatriculaPeriodoLetivoProcessoMatricula(matriculaVO.getMatricula(), obj.getProcessoMatricula(), obj.getCodigo(), usuario);
		if (conf != null) {
			if (conf.getPermiteRenovarAlunoPreMatriculadoParaNovaMatriculaPreMatricula()) {
				if (obj.getSituacaoPreMatricula()) {
					consultarPorMatriculaPeriodoSeExisteOutraMatriculaPreMatriculaAluno(matriculaVO.getMatricula(), usuario);
				}
			}
		}
	}

	public void consultarPorMatriculaPeriodoLetivoProcessoMatricula(String matricula, Integer processoMatricula, Integer codigoMatriculaPeriodoIgnorar, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select matriculaPeriodo.codigo from matriculaPeriodo ");
		sqlStr.append("inner join processoMatricula on processoMatricula.codigo = matriculaPeriodo.processoMatricula ");
		sqlStr.append("where matricula = '");
		sqlStr.append(matricula);
		sqlStr.append("' and processoMatricula = ");
		sqlStr.append(processoMatricula);
		if(Uteis.isAtributoPreenchido(codigoMatriculaPeriodoIgnorar)) {
			sqlStr.append(" and matriculaPeriodo.codigo != ").append(codigoMatriculaPeriodoIgnorar);
		}
		sqlStr.append(" and matriculaPeriodo.situacaomatriculaperiodo not in ('PC', 'TR') ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			throw new Exception("PROCESSO matrícula já utilizado para essa matrícula, por favor, escolha outro PROCESSO matrícula. ");

		}
	}

	public void consultarPorMatriculaPeriodoSeExisteOutraMatriculaPreMatriculaAluno(String matricula, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select matriculaPeriodo.codigo from matriculaPeriodo ");
		sqlStr.append("where matricula = '");
		sqlStr.append(matricula);
		sqlStr.append("' ");
		sqlStr.append(" and matriculaPeriodo.situacaomatriculaperiodo = 'PR' ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			throw new Exception("EXISTE UMA matrícula COM situação pré-matrícula para esse aluno, assim não ï¿½ permitido realizar uma nova pré-matrícula. ");
		}
	}

	public void consultarPorMatriculaPeriodoLetivoAtivoAnoSemestre(String matricula, String ano, String semestre, Integer codigoDesconsiderar, UsuarioVO usuario) throws Exception {
		// ControleAcesso.consultar(getIdEntidade(), false, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT matriculaPeriodo.codigo FROM matriculaPeriodo ");
		sqlStr.append("WHERE matricula = '");
		sqlStr.append(matricula);
		sqlStr.append("' ");
		if(Uteis.isAtributoPreenchido(codigoDesconsiderar)) {
			sqlStr.append(" AND matriculaPeriodo.codigo != ").append(codigoDesconsiderar);
		}
		sqlStr.append(" AND (matriculaPeriodo.situacaomatriculaperiodo = 'AT' OR matriculaPeriodo.situacaomatriculaperiodo = 'PR' OR matriculaPeriodo.situacaomatriculaperiodo = 'FI') ");
		sqlStr.append(" AND matriculaPeriodo.ano = '" + ano + "' AND matriculaPeriodo.semestre = '" + semestre + "'; ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			throw new Exception("já existe uma matrícula ativa ou pré-matrícula ou finalizada para esse aluno, nesse curso e nesse ano/semestre!");
		}
	}

	public Boolean consultarSeAlunoPossuiMaisDeUmaMatriculaPeriodoAtiva(String matricula) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT CASE WHEN COUNT(codigo) > 1 THEN true ELSE false END FROM matriculaperiodo WHERE matricula = ? AND situacaomatriculaperiodo = 'AT' ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { matricula });
		tabelaResultado.next();
		return tabelaResultado.getBoolean("case");
	}

	public Boolean consultarExistenciaMatriculaPeriodoAtivaPorSituacao(String matricula, Integer matriculaPeriodo, String situacao) throws Exception {
		String sqlStr = "SELECT CASE WHEN COUNT(codigo) > 0 THEN true ELSE false END AS existe FROM matriculaperiodo WHERE matricula = ? AND situacaomatriculaperiodo = ? and codigo <> ? ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { matricula, situacao, matriculaPeriodo });
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("existe");
		}
		return false;
	}

	public Boolean consultarExistenciaMatriculaPeriodoPorSituacao(String matricula, String situacao) throws Exception {
		String sqlStr = "SELECT CASE WHEN COUNT(codigo) > 0 THEN true ELSE false END AS existe FROM matriculaperiodo WHERE matricula = ? AND situacaomatriculaperiodo = ?";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { matricula, situacao });
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("existe");
		}
		return false;
	}

	public Boolean consultarAlunoBolsistaUltimaMatriculaPeriodo(String matricula) throws Exception {
		String sqlStr = "select bolsista from matriculaperiodo where matricula = ? order by data desc limit 1";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { matricula });
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("bolsista");
		}
		return false;
	}

	public Boolean consultarExistenciaMaisDeUmaMatriculaPeriodo(String matricula) throws Exception {
		String sqlStr = "SELECT CASE WHEN COUNT(codigo) > 1 THEN true ELSE false END AS existe FROM matriculaperiodo WHERE matricula = ? ";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { matricula });
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("existe");
		}
		return false;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void executarCancelamentoPreMatricula(MatriculaPeriodoVO matriculaPeriodo, Integer usuaroLogado, List<MatriculaPeriodoVO> listaAlunosPreMatriculados, UsuarioVO usuario) throws Exception {
		getFacadeFactory().getControleRemessaContaReceberFacade().removerVinculoContaReceber(matriculaPeriodo.getCodigo(), usuario);
		ContaReceberVO contaReceber = getFacadeFactory().getContaReceberFacade().consultarContaReceberReferentePreMatriculaPorMatriculaPerido(matriculaPeriodo.getCodigo());
		getFacadeFactory().getMatriculaPeriodoVencimentoFacade().excluirContaReceber(contaReceber.getCodigo(), usuario);
		getFacadeFactory().getMapaPendenciasControleCobrancaFacade().excluirPorMatriculaPeriodoContasNaoPagasENaoNegociadas(matriculaPeriodo.getCodigo(), usuario);
		if (contaReceber.getSituacao().equals("AR")) { // A RECEBER
			getFacadeFactory().getContaReceberFacade().excluir(contaReceber, usuario);
		}
		getFacadeFactory().getMatriculaPeriodoVencimentoFacade().excluirPorMatriculaPeriodoContaReceberNaoPagaNaoNegociada(matriculaPeriodo.getCodigo(), usuario);
		getFacadeFactory().getContaReceberFacade().excluirPorMatriculaPeriodoNaoRecebidaNaoNegociada(matriculaPeriodo.getCodigo(), usuario);
		if(!matriculaPeriodo.getCalouro()) {			
			matriculaPeriodo.setSituacaoMatriculaPeriodo(SituacaoMatriculaPeriodo.PREMATRICULA_CANCELADA.getValor());
			getFacadeFactory().getHistoricoFacade().excluirPorMatriculaPeriodo(matriculaPeriodo.getCodigo(), null, false, usuario);
			getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().excluirComBaseNaMatriculaPeriodo(matriculaPeriodo.getCodigo(), usuario);
		}
		matriculaPeriodo.setDataFechamentoMatriculaPeriodo(new Date());
		matriculaPeriodo.setOrigemFechamentoMatriculaPeriodo(OrigemFechamentoMatriculaPeriodoEnum.CANCELAMENTO);
		matriculaPeriodo.setCodigoOrigemFechamentoMatriculaPeriodo(null);
		matriculaPeriodo.setUsuarioResponsavelConfirmacaoOuCancelamentoPreMatricula(usuaroLogado);	
		if(matriculaPeriodo.getCalouro()) {
			CancelamentoVO cancelamentoVO =  new CancelamentoVO();
			cancelamentoVO.setMatricula(matriculaPeriodo.getMatriculaVO());
			cancelamentoVO.setData(new Date());
			cancelamentoVO.setDescricao("Cancelamento de calouro pelo recurso de cancelamento de pré-matrícula.");
			cancelamentoVO.setJustificativa("Matrícula cancelada por não cumprimento das regras de matrícula de calouro.");
			cancelamentoVO.setMotivoCancelamentoTrancamento(getAplicacaoControle().getConfiguracaoGeralSistemaVO(matriculaPeriodo.getMatriculaVO().getUnidadeEnsino().getCodigo(), usuario).getMotivoPadraoCancelamentoPreMatriculaCalouro());
			cancelamentoVO.setSituacao(SituacaoRequerimento.FINALIZADO_DEFERIDO.getValor());
			cancelamentoVO.getResponsavelAutorizacao().setCodigo(usuario.getCodigo());
			getFacadeFactory().getCancelamentoFacade().incluir(cancelamentoVO, getAplicacaoControle().getConfiguracaoGeralSistemaVO(matriculaPeriodo.getMatriculaVO().getUnidadeEnsino().getCodigo(), usuario), getAplicacaoControle().getConfiguracaoFinanceiroPrevilegiandoUnidadeEnsino(usuaroLogado), usuario, false);
			matriculaPeriodo.setSituacaoMatriculaPeriodo(SituacaoMatriculaPeriodo.CANCELADA.getValor());
			
		}else {
			alterarSituacaoMatriculaPeriodo(matriculaPeriodo ,usuario);
		}
		getFacadeFactory().getMatriculaFacade().incluirLogPreMatricula(matriculaPeriodo.getMatriculaVO(), matriculaPeriodo, "Cancelar pré-Matrícula", usuario);
		getFacadeFactory().getGestaoEnvioMensagemAutomaticaFacade().enviarMensagemCancelamentoPreMatricula(matriculaPeriodo.getMatriculaVO(), matriculaPeriodo, usuario);
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoMatriculaPeriodo(final MatriculaPeriodoVO obj ,UsuarioVO usuario) throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append(" UPDATE MatriculaPeriodo set  situacaoMatriculaPeriodo=?, dataFechamentoMatriculaPeriodo=?, origemFechamentoMatriculaPeriodo=?, codigoOrigemFechamentoMatriculaPeriodo=?, usuarioResponsavelConfirmacaoOuCancelamentoPreMatricula=?  WHERE ((codigo = ?)) ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuario));
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql.toString());
				sqlAlterar.setString(1, obj.getSituacaoMatriculaPeriodo());
				sqlAlterar.setTimestamp(2, Uteis.getDataJDBCTimestamp(obj.getDataFechamentoMatriculaPeriodo()));
				sqlAlterar.setString(3, obj.getOrigemFechamentoMatriculaPeriodo().toString());
				if (obj.getCodigoOrigemFechamentoMatriculaPeriodo() != null) {
					sqlAlterar.setInt(4, obj.getCodigoOrigemFechamentoMatriculaPeriodo());
				} else {
					sqlAlterar.setNull(4, 0);
				}
				if (obj.getUsuarioResponsavelConfirmacaoOuCancelamentoPreMatricula() != null) {
					sqlAlterar.setInt(5, obj.getUsuarioResponsavelConfirmacaoOuCancelamentoPreMatricula());
				} else {
					sqlAlterar.setNull(5, 0);
				}
				sqlAlterar.setInt(6, obj.getCodigo().intValue());
				return sqlAlterar;
			}
		});

	}

	
	/**
	 * Método Responsável por obter a contaReceber com o convênio
	 * correspondente, que deverï¿½ utilizada como base a geração da parcela do
	 * convênio, correspodente a esta parcela. O mesmo GERA uma conta a receber
	 * correspondente a esta parcela (mas sem persistir a mesma), com todos os
	 * descontos, planos e convênios do aluno de forma a garantir que a parcela
	 * do convênio seja gerada de forma correta. Haja, vista, que todos estes
	 * itens podem interferir no valor final do convênio, dependendo da
	 * configuração do convênio. Neste caso, iremos chamar o Método que gera a
	 * conta receber, para simular exatamente como seria esta parcela seria,
	 * caso não a mesma não estivesse quitada.
	 */
	public ContaReceberVO gerarContaReceberSimulandoConvenioAdicionadoMatriculaAluno(MatriculaPeriodoVencimentoVO vctoGerar, ConfiguracaoFinanceiroVO configFinan, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO,  UsuarioVO usuarioVO) throws Exception {
		// Se chegarmos aqui ï¿½ por que teremos que criar uma conta a receber
		// simulando
		// a parcela origem (da matrícula / mensalidade) com os convenios do
		// aluno e outros possível
		// variaï¿½ï¿½es. Esta conta simulada, não será persistida. A mesma será
		// utilizada somente para
		// obtermos o valor correto do convênio, para esta parcela, que deverï¿½
		// ser gerado.
		getFacadeFactory().getUnidadeEnsinoFacade().carregarDados(matriculaVO.getUnidadeEnsino(), NivelMontarDados.BASICO, usuarioVO);
		ContaReceberVO contaReceberSimulada = null;
		if (vctoGerar.getParcelaReferenteMatricula()) {
			// TRATANDO QUANDO FOR UMA PARCELA DE matrícula
			// GERA-SE A CONTA A RECEBER DE matrícula IGUAL AO Método ORIGINAL,
			// CHAMADO PARA ESTE FIM
			// NO MOMEMNTO DE GERAR A PARCELA DA matrícula. ASSIM TEREMOS O
			// VALOR DO CONVENIO ATUALIZADO
			// PARA GERACAO DAS PARCELAS FILHAS
			MatriculaPeriodoVencimentoVO vctoGerarBase = (MatriculaPeriodoVencimentoVO) vctoGerar.clone();
			// Aqui clonamos o vctoGerar e zeramos o valor total do desconto,
			// registrado no mesmo.
			// Isto por que ao gerar a conta a receber este total já ï¿½
			// atualizado. Se o mesmo não
			// zerado aqui, gera-se um acumulo de desconto no Método
			// criarContaReceberMensalidadeBaseadoMatriculaPeriodoVencimento
			vctoGerarBase.setValorDesconto(0.0);
			contaReceberSimulada = matriculaPeriodoVO.criarContaReceberMatriculaBaseadoMatriculaPeriodoVencimento(matriculaVO, matriculaPeriodoVO, vctoGerarBase, false, configFinan, true, usuarioVO);
		} else {
			// TRATANDO QUANDO FOR UMA PARCELA DE MENSALIDADE
			// GERA-SE A CONTA A RECEBER DE MENSALIDADE IGUAL AO Método
			// ORIGINAL, CHAMADO PARA ESTE FIM
			// NO MOMEMNTO DE GERAR A PARCELA DA MENSALIDADE. ASSIM TEREMOS O
			// VALOR DO CONVENIO ATUALIZADO
			// PARA GERACAO DAS PARCELAS FILHAS

			MatriculaPeriodoVencimentoVO vctoGerarBase = (MatriculaPeriodoVencimentoVO) vctoGerar.clone();
			// Aqui clonamos o vctoGerar e zeramos o valor total do desconto,
			// registrado no mesmo.
			// Isto por que ao gerar a conta a receber este total já ï¿½
			// atualizado. Se o mesmo não
			// zerado aqui, gera-se um acumulo de desconto no Método
			// criarContaReceberMensalidadeBaseadoMatriculaPeriodoVencimento
			vctoGerarBase.setValorDesconto(0.0);
			contaReceberSimulada = matriculaPeriodoVO.criarContaReceberMensalidadeBaseadoMatriculaPeriodoVencimento(matriculaVO, matriculaPeriodoVO, vctoGerarBase, configFinan, true, usuarioVO);
		}
		return contaReceberSimulada;
		// REMOVIDO POR EDIGAR VERSAO 5.1 O Método ABAIXO FALHAVA QUANDO A CONTA
		// A RECEBER já ESTAVA QUITADA. ASSIM, PASSAMOS A ADOTAR A POLï¿½TICA DE
		// GERAR
		// A PARCELA NOVAMENTE (SEJA A DE MATRICULA OU DE MENSALIDADE) POIS
		// TEREMOS
		// A EXATA REALIZADA NO MOMENTO DE CRIAR A CONTA A RECEBER DE
		// matrícula/MENSALIDADE.
		// Não TENDO INTERFERENCIAS COMO, POR EXEMPLO, SE ESTAS CONTAS FOREM
		// BAIXADAS, RENEGOCIAS
		// OU TIVEREM SEUS VALORES MODIFICADOS EM FUNï¿½ï¿½O DA PERDA DE
		// DESCONTOS COM DATA LIMITE
		// DE aplicação.
		// ContaReceberVO contaReceberVO = new ContaReceberVO();
		// contaReceberVO.setCodigo(vctoGerar.getContaReceber().getCodigo());
		// getFacadeFactory().getContaReceberFacade().carregarDados(contaReceberVO,
		// NivelMontarDados.TODOS, configFinan, usuarioVO);
		// if (contaReceberVO.getSituacaoAReceber()) {
		// // Se a conta atual estão como A Receber, então ï¿½ por que a mesma
		// // pode ser alterada pelos Métodos anteriores a este, no sentido,
		// // de acrescentar ï¿½ mesma os convênios (que por alguma razï¿½o
		// tenham sido)
		// // adicionadas ï¿½ matrícula do aluno. Logo, este Método, não precisa
		// fazer
		// // alï¿½m de considerar os dados do convï¿½ncio que já vï¿½o estar
		// calculados no
		// // na conta a receber.
		// //contaReceberVO.adicionarListaPlanoDescontoContaReceberVOComBaseItensPlanoDescontoMatricula(matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs());
		// List planoDescontosContaReceber =
		// getFacadeFactory().getPlanoDescontoContaReceberFacade().consultarPorContaReceber(contaReceberVO.getCodigo(),
		// true, Uteis.NIVELMONTARDADOS_TODOS, usuarioVO);
		// contaReceberVO.setPlanoDescontoContaReceberVOs(planoDescontosContaReceber);
		// contaReceberVO.atualizarSituacaoContaReceberDeAcordoComDescontos(configFinan,
		// matriculaPeriodoVO.getData());
		// return contaReceberVO;
		// }
	}

	@Override
	public List<ContaReceberVO> criarContaReceberBolsaCusteadaMensalidade(ConfiguracaoFinanceiroVO configFinan, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO vctoGerar, UsuarioVO usuarioVO) throws Exception {
		List listaMensalidadesBolsaCusteada = new ArrayList(0);
		if(vctoGerar.getTipoOrigemMatriculaPeriodoVencimento().isMaterialDidatico() && !matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isAplicarDescontoMaterialDidaticoDescontoConvenio()){
			return listaMensalidadesBolsaCusteada;
		}		
		ContaReceberVO contaReceberRegeradaComValorConvenio = gerarContaReceberSimulandoConvenioAdicionadoMatriculaAluno(vctoGerar, configFinan, matriculaVO, matriculaPeriodoVO, usuarioVO);
		if(vctoGerar.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)  || vctoGerar.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA)) {
			MatriculaPeriodoVencimentoVO vctoGerarTemp = matriculaPeriodoVO.obterMatriculaPeriodoVencimentoCorrespondente(vctoGerar);
			if(vctoGerarTemp == null) {
				vctoGerarTemp = vctoGerar;
			}
			for(PlanoDescontoContaReceberVO planoDescontoContaReceberVO: vctoGerarTemp.getContaReceber().getPlanoDescontoContaReceberVOs()){
				if(planoDescontoContaReceberVO.getIsConvenio() && planoDescontoContaReceberVO.getRegerarConta()) {
					matriculaPeriodoVO.setValorMensalidadeBolsaCusteada(planoDescontoContaReceberVO.getValorUtilizadoRecebimento()); 
					validarValorAndDataVencimentoMensalidadeConvenio(configFinan, matriculaVO, matriculaPeriodoVO, vctoGerar, usuarioVO, listaMensalidadesBolsaCusteada, matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO.getPlanoFinanceiroCurso(), planoDescontoContaReceberVO.getConvenio());
					matriculaPeriodoVO.setValorMensalidadeBolsaCusteada(0.0); 
				}
			}
		}else {
			for (ItemPlanoFinanceiroAlunoVO obj :  matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()) {
				if (obj.getTipoPlanoFinanceiroConvenio() && 
						(!vctoGerar.getTipoOrigemMatriculaPeriodoVencimento().isMaterialDidatico() || 
						 (vctoGerar.getTipoOrigemMatriculaPeriodoVencimento().isMaterialDidatico() && obj.getConvenio().getParceiro().isCusteaParcelasMaterialDidatico()))) {
					if (obj.getRegerarConta()) {
						Uteis.checkState(contaReceberRegeradaComValorConvenio == null, "Ocorreu um erro ao tentar gerar a parcela de Mensalidade do convênio " + obj.getConvenio().getDescricao() + " desta Matrícula. Procure o administador do sistema. "); 
						boolean localizouConvenioContaReceber = false;
						for (PlanoDescontoContaReceberVO planoDesconto : contaReceberRegeradaComValorConvenio.getPlanoDescontoContaReceberVOs()) {
							if ((planoDesconto.getIsConvenio()) && (planoDesconto.getConvenio().getCodigo().equals(obj.getConvenio().getCodigo()))) {
								matriculaPeriodoVO.setValorMensalidadeBolsaCusteada(planoDesconto.getValorUtilizadoRecebimento());
								localizouConvenioContaReceber = true;
								break;
							}
						}
						Uteis.checkState(!localizouConvenioContaReceber && vctoGerar.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade(), "Ocorreu um erro ao tentar gerar a parcela de Mensalidade do convênio " + obj.getConvenio().getDescricao() + " desta Matrícula " + matriculaVO.getMatricula() + ". Não foi encontrado o convênio na Conta Receber. Procure o administador do sistema.");
						Uteis.checkState(!localizouConvenioContaReceber && vctoGerar.getTipoOrigemMatriculaPeriodoVencimento().isMaterialDidatico(), "Ocorreu um erro ao tentar gerar a parcela de Material Didáticodo convênio " + obj.getConvenio().getDescricao() + " desta Matrícula " + matriculaVO.getMatricula() + ". Não foi encontrado o convênio na Conta Receber. Procure o administador do sistema.");
						validarValorAndDataVencimentoMensalidadeConvenio(configFinan, matriculaVO, matriculaPeriodoVO, vctoGerar, usuarioVO, listaMensalidadesBolsaCusteada, matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso(), matriculaPeriodoVO.getPlanoFinanceiroCurso(), obj.getConvenio());
						matriculaPeriodoVO.setValorMensalidadeBolsaCusteada(0.0);
					}
				}
			}		
		}
		return listaMensalidadesBolsaCusteada;
	}

	private void validarValorAndDataVencimentoMensalidadeConvenio(ConfiguracaoFinanceiroVO configFinan, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO vctoGerar, UsuarioVO usuarioVO, List listaMensalidadesBolsaCusteada, CondicaoPagamentoPlanoFinanceiroCursoVO condicao, PlanoFinanceiroCursoVO planoCursoVO, ConvenioVO convenio) throws Exception {
		if (matriculaPeriodoVO.getValorMensalidadeBolsaCusteada() > 0.0) {
			Double valorConvenioMensalidade = matriculaPeriodoVO.getValorMensalidadeBolsaCusteada();
			if (convenio.getTipoBolsaCusteadaParceiroParcela().equals("VA")) {
				valorConvenioMensalidade = convenio.getBolsaCusteadaParceiroParcela();
			}
			if(valorConvenioMensalidade > 0.0){
			ContaReceberVO contaReceberGeradaMensalidade = montarMensalidadeBolsaCusteada(planoCursoVO, configFinan, matriculaVO, matriculaPeriodoVO, vctoGerar, valorConvenioMensalidade, 0.0, 0, convenio.getCodigo(), 0.0, 0.0, condicao, convenio.getParceiro(), usuarioVO);
			if (!convenio.getCentroReceitaMensalidade().getCodigo().equals(0)) {
				// Se no convenio foi informando um centro de
				// receita especial para a parcela do convenio,
				// referente ï¿½ mensalidade, então temos que
				// setï¿½-lo na contaRecever Gerada. Recurso criado
				// na versão 5.0.1 para permitir que todas as contas
				// a receber de um determinado convenio
				// possam ser vinculada a um determinado convênio.
				contaReceberGeradaMensalidade.setCentroReceita(convenio.getCentroReceitaMensalidade());
			}
			if (convenio.getDiaBaseRecebimentoParceiro() != 0) {
				Date novaDataVcto = obterProximaDataVctoComDiaConvenio(contaReceberGeradaMensalidade.getDataVencimento(), convenio.getDiaBaseRecebimentoParceiro());
				contaReceberGeradaMensalidade.setDataVencimento(novaDataVcto);
			}
			boolean atualizouDataVctoContaReceberParaNaoGerarVencida = false;
			if (convenio.getGerarParcelasConvenioVencidasComDataAtaulizadaParaMesAtual()) {
				// Recurso criado na versão 5.0.1, no qual impedi
				// que uma parcela de convenio seja
				// gerada vencida. Ou seja, caso a data de vcto da
				// mesma esteja ultrapassada com relação
				// a data atual, então a mesma ï¿½ atualizada para a
				// préxima competencia (mï¿½s). Isto irá
				// impedir que uma parcela a receber seja gerada em
				// competencia que já tenha sido
				// contabilmente fechada.
				if (contaReceberGeradaMensalidade.getDataVencimento().before(new Date())) {
					// Se entrarmos aqui ï¿½ por que a conta estão
					// vencida com relação a data
					// de hoje. Logo, teremos que atualizar seu
					// vencimento.
					Date novaDataVctoMatricula = obterProximaDataMantendoDiaVencimentoDataBase(contaReceberGeradaMensalidade.getDataVencimento());
					contaReceberGeradaMensalidade.setDataVencimento(novaDataVctoMatricula);
					contaReceberGeradaMensalidade.setDataCompetencia(novaDataVctoMatricula);
					atualizouDataVctoContaReceberParaNaoGerarVencida = true;
				}
			}
			if(!convenio.getGerarRestituicaoAlunoValorJaPagoRelativoAoConvenio() && matriculaPeriodoVO.getContaPagarRestituicaoVO().getValor()>0 && vctoGerar.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)){
				boolean desconsiderarDescontoConvenio = true;
				for (PlanoDescontoContaReceberVO planoContaReceber : vctoGerar.getContaReceber().getPlanoDescontoContaReceberVOs()) {
					if(planoContaReceber.getConvenio().getCodigo().equals(convenio.getCodigo())){
						desconsiderarDescontoConvenio =  false;
					}
				}
				if(desconsiderarDescontoConvenio){
					matriculaPeriodoVO.getContaPagarRestituicaoVO().setValor(matriculaPeriodoVO.getContaPagarRestituicaoVO().getValor() - valorConvenioMensalidade);
				}
			}
			listaMensalidadesBolsaCusteada.add(contaReceberGeradaMensalidade);
			}
		}
	}	

	public ContaReceberVO montarMensalidadeBolsaCusteada(PlanoFinanceiroCursoVO planoCursoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiro, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO vctoGerar, Double valor, Double desconto, Integer descontoProgressivo, Integer convenio, Double descontoFaculdade, Double descontoConvenio, CondicaoPagamentoPlanoFinanceiroCursoVO condicao, ParceiroVO parceiroVO, UsuarioVO usuarioVO) throws Exception {
		ContaReceberVO obj = new ContaReceberVO();
		obj.verificarEReplicarLiberacaoBloqueioEntidadePrincipal(matriculaPeriodoVO);
		int indice = vctoGerar.getParcela().indexOf("/");		
		String nrMensalidadeStr = "";
		String descricao = "";
		if(vctoGerar.getTipoOrigemMatriculaPeriodoVencimento().isMaterialDidatico()){
			descricao = ("Bolsa Custeada referente ao Material de Didático do curso " + matriculaVO.getCurso().getNome().toUpperCase() + ", Período " + matriculaVO.getTurno().getNome().toUpperCase() + " referente ao aluno " + matriculaVO.getAluno().getNome());
		}else{
			descricao = ("Bolsa Custeada referente a Parcela do curso " + matriculaVO.getCurso().getNome().toUpperCase() + ", Período " + matriculaVO.getTurno().getNome().toUpperCase() + " referente ao aluno " + matriculaVO.getAluno().getNome());
		}
		if (indice > 0) {
			nrMensalidadeStr = vctoGerar.getParcela().substring(0, indice);
		} else if (indice < 0) {
			nrMensalidadeStr = vctoGerar.getParcela();
			if (vctoGerar.getParcela().contains("EX")) {
				Integer nrParcelas = getFacadeFactory().getContaReceberFacade().consultarQuantidadeContasRecebidasPorMatricula(matriculaPeriodoVO.getMatricula());
				nrMensalidadeStr = nrParcelas.toString();
			}
		}
		int nrMensalidade = Integer.valueOf(nrMensalidadeStr);
		if(vctoGerar.getTipoOrigemMatriculaPeriodoVencimento().isMensalidade()
				&& !vctoGerar.getParcela().contains("EX")
				&& condicao.isGerarParcelaMaterialDidatico() 
				&& condicao.getTipoGeracaoMaterialDidatico().isAntesParcelaAcademico()){
			nrMensalidade = nrMensalidade + condicao.getQuantidadeParcelasMaterialDidatico().intValue();			
		}		
		String nrDoc = ((String.valueOf(matriculaVO.getUnidadeEnsino().getCodigo()) + "." + matriculaPeriodoVO.getCodigo() + "." + nrMensalidade));
		Date dataVencimento = montarDataVencimento(nrMensalidade, matriculaPeriodoVO, usuarioVO);
		if(vctoGerar.getTipoOrigemMatriculaPeriodoVencimento().isMaterialDidatico() && condicao.isControlaDiaBaseVencimentoParcelaMaterialDidatico()){
			dataVencimento = Uteis.getDataVencimentoPadrao(condicao.getDiaBaseVencimentoParcelaOutraUnidade().intValue(), dataVencimento, 0);
		}
		Date dataCompetencia = montarDataCompetencia(nrMensalidade, dataVencimento, matriculaPeriodoVO, usuarioVO);
		Integer contaCorrente = matriculaPeriodoVO.obterContaCorrentePadraoParaContaReceberParcela(matriculaVO, matriculaPeriodoVO, vctoGerar, configuracaoFinanceiro);
		Integer centroReceita = matriculaPeriodoVO.obterCentroReceitaPadraoParaContaReceberParcela(matriculaVO, matriculaPeriodoVO, vctoGerar, configuracaoFinanceiro);
		
		obj = matriculaPeriodoVO.montarDadosContaReceber(centroReceita, contaCorrente, "BCC", matriculaVO, nrDoc, descricao, vctoGerar.getParcelaCusteadaConvenio(condicao.getNrParcelasPeriodo(), condicao.getQuantidadeParcelasMaterialDidatico().intValue()), valor, "VA", desconto, 0.0, dataVencimento, dataCompetencia, descontoProgressivo, convenio, descontoFaculdade, descontoConvenio, matriculaPeriodoVO.getCodigo(), parceiroVO, matriculaVO.getPlanoFinanceiroAluno().getOrdemConvenio(), matriculaVO.getPlanoFinanceiroAluno().getOrdemConvenioValorCheio(), matriculaVO.getPlanoFinanceiroAluno().getOrdemDescontoAluno(), matriculaVO.getPlanoFinanceiroAluno().getOrdemDescontoAlunoValorCheio(), matriculaVO.getPlanoFinanceiroAluno().getOrdemDescontoProgressivo(), matriculaVO.getPlanoFinanceiroAluno().getOrdemDescontoProgressivoValorCheio(), matriculaVO.getPlanoFinanceiroAluno().getOrdemPlanoDesconto(), matriculaVO.getPlanoFinanceiroAluno().getOrdemPlanoDescontoValorCheio(), 0.0, false, 0.0);
		if(vctoGerar.getTipoOrigemMatriculaPeriodoVencimento().isMaterialDidatico() && Uteis.isAtributoPreenchido(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getUnidadeEnsinoFinanceira())){
			obj.setUnidadeEnsinoFinanceira(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getUnidadeEnsinoFinanceira());
        }else{
        	obj.setUnidadeEnsinoFinanceira(obj.getUnidadeEnsino());
        }
		return obj;

	}

	/**
	 * Método verifica se a conta de convênio para uma determinada parcela
	 * existe, e se ela estão paga. Ao verificar ele retorna uma booleano
	 * mostrando se essa conta de convênio deve ser gerada ou não.
	 * 
	 * @param mpvctoVO
	 * @exception Exception
	 * @return Boolean
	 */
	public Boolean realizarVerificacaoConvenioPago(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO mpvctoVO) throws Exception {
		Boolean regerarConta = Boolean.FALSE;
		String nrParcelaTemp = "";
		q:
		for (ItemPlanoFinanceiroAlunoVO ipfaVO : matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()) {
			if (ipfaVO.getTipoItemPlanoFinanceiro().equals("CO")) {
				StringBuilder sqlStr = new StringBuilder("SELECT CASE WHEN cr.situacao = 'AR' THEN true ELSE false END FROM contareceber cr ");
				sqlStr.append("WHERE cr.matriculaaluno = '").append(matriculaVO.getMatricula()).append("' ");
				if (!mpvctoVO.getVencimentoReferenteMatricula() && mpvctoVO.getParcela().contains("/")) {
					nrParcelaTemp = mpvctoVO.getParcelaCusteadaConvenio(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNrParcelasPeriodo(),matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getQuantidadeParcelasMaterialDidatico().intValue());
					sqlStr.append("AND cr.parcela ilike('%/%') AND  substring(cr.parcela, 0, position('/' in cr.parcela)) = '").append(nrParcelaTemp.substring(0, nrParcelaTemp.indexOf("/"))).append("' ");
				}else if (!mpvctoVO.getVencimentoReferenteMatricula() && !mpvctoVO.getParcela().contains("/")) {
					sqlStr.append("AND cr.parcela = '").append(mpvctoVO.getParcela()).append("' ");
				
				} else {
					sqlStr.append("AND cr.parcela in ('Matrícula', 'MA', 'MAT', 'Matricula', 'MATRICULA', 'MATRÍCULA') ");
				}
				Date novaDataVcto = mpvctoVO.getDataVencimento();
				if (ipfaVO.getConvenio().getDiaBaseRecebimentoParceiro() != 0) {
					novaDataVcto = obterProximaDataVctoComDiaConvenio(mpvctoVO.getDataVencimento(), ipfaVO.getConvenio().getDiaBaseRecebimentoParceiro());
				}
				sqlStr.append(" AND cr.matriculaperiodo = ").append(mpvctoVO.getMatriculaPeriodo()).append(" ");
				sqlStr.append(" AND cr.tipoorigem = 'BCC' AND cr.convenio = ").append(ipfaVO.getConvenio().getCodigo());
				// sqlStr.append("  AND cr.datavencimento = '").append(Uteis.getDataJDBC(novaDataVcto)).append("' ");
				SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
				if (!tabelaResultado.next()) {
					if((mpvctoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA) 
							|| mpvctoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA)) 
							&& !ipfaVO.getConvenio().getGerarRestituicaoAlunoValorJaPagoRelativoAoConvenio()){
						for(PlanoDescontoContaReceberVO planoDescontoContaReceberVO: mpvctoVO.getContaReceber().getPlanoDescontoContaReceberVOs()){							
							if(planoDescontoContaReceberVO.getIsConvenio() 
									&& planoDescontoContaReceberVO.getConvenio().getCodigo().equals(ipfaVO.getConvenio().getCodigo())){
								ipfaVO.setRegerarConta(Boolean.TRUE);
								regerarConta = Boolean.TRUE;
								continue q;
							}
						}
						ipfaVO.setRegerarConta(Boolean.FALSE);					
					}else{
						ipfaVO.setRegerarConta(Boolean.TRUE);
						regerarConta = Boolean.TRUE;
					}
				} else {
					if((mpvctoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA) 
							|| mpvctoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA)) 
							&& !ipfaVO.getConvenio().getGerarRestituicaoAlunoValorJaPagoRelativoAoConvenio()){
						for(PlanoDescontoContaReceberVO planoDescontoContaReceberVO: mpvctoVO.getContaReceber().getPlanoDescontoContaReceberVOs()){							
							if(planoDescontoContaReceberVO.getIsConvenio() 
									&& planoDescontoContaReceberVO.getConvenio().getCodigo().equals(ipfaVO.getConvenio().getCodigo())){
								ipfaVO.setRegerarConta(tabelaResultado.getBoolean("case"));
								if(!regerarConta){
									regerarConta = tabelaResultado.getBoolean("case");
								}
								continue q;
							}
						}
						ipfaVO.setRegerarConta(Boolean.FALSE);						
					}else{
						ipfaVO.setRegerarConta(tabelaResultado.getBoolean("case"));
						if(!regerarConta){
							regerarConta = tabelaResultado.getBoolean("case");
						}
					}
				}
			}
		}
		return regerarConta;
	}

	/**
	 * Método verifica se a conta de convênio para uma determinada parcela
	 * existe, e se ela estão paga. Ao verificar ele retorna uma booleano
	 * mostrando se essa conta de convênio deve ser gerada ou não.
	 * 
	 * @param mpvctoVO
	 * @exception Exception
	 * @return Boolean
	 */
	public Boolean realizarVerificacaoConvenioNaoPagoParaNovaGeracao(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO mpvctoVO) throws Exception {
		Boolean existeParcelaConvenioAberta= null;
		MatriculaPeriodoVencimentoVO mpvctoTemp = matriculaPeriodoVO.obterMatriculaPeriodoVencimentoCorrespondente(mpvctoVO);
		if(mpvctoTemp == null) {
			mpvctoTemp = mpvctoVO;
		}
		if(mpvctoTemp.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA) 
				|| mpvctoTemp.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA)) {
			for(PlanoDescontoContaReceberVO planoDescontoContaReceberVO: mpvctoTemp.getContaReceber().getPlanoDescontoContaReceberVOs()){
				if(planoDescontoContaReceberVO.getIsConvenio()) {
					existeParcelaConvenioAberta = consultarSeExisteParcelaConvenioParceiroEmAberta(matriculaVO, matriculaPeriodoVO, mpvctoTemp, planoDescontoContaReceberVO.getConvenio());
					planoDescontoContaReceberVO.setRegerarConta(validarSeConvenioDeveSerRegerado(existeParcelaConvenioAberta, mpvctoTemp, planoDescontoContaReceberVO.getConvenio()));
				}
			}
			return mpvctoTemp.getContaReceber().getPlanoDescontoContaReceberVOs().stream().anyMatch(p-> p.getRegerarConta());
		}else {
			Boolean regerarConvenio = false;
			for (ItemPlanoFinanceiroAlunoVO ipfaVO : matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()) {
				if (ipfaVO.getTipoPlanoFinanceiroConvenio()) {				
					existeParcelaConvenioAberta = consultarSeExisteParcelaConvenioParceiroEmAberta(matriculaVO, matriculaPeriodoVO, mpvctoTemp, ipfaVO.getConvenio());				
					if(validarSeConvenioDeveSerRegerado(existeParcelaConvenioAberta, mpvctoTemp, ipfaVO.getConvenio())) {
						ipfaVO.setRegerarConta(true);
						regerarConvenio = true;
					}else {
						ipfaVO.setRegerarConta(false);
					}				
				}
			}	
			//return matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs().stream().anyMatch(p-> p.getRegerarConta()) nao posso utilizar essa linha na regra pois o valor default do regerarconta e true. Pedro Andrade 24/06/2020
			return regerarConvenio;
		}
	}
	
	public Boolean  validarSeConvenioDeveSerRegerado(Boolean existeParcelaConvenioAberta, MatriculaPeriodoVencimentoVO mpvctoTemp, ConvenioVO convenio) throws Exception {
		if(existeParcelaConvenioAberta == null) {
			return Boolean.TRUE;
		}else if (!existeParcelaConvenioAberta) {
			return Boolean.FALSE;		
		}else if ((!Uteis.isAtributoPreenchido(mpvctoTemp.getContaReceber()) || (Uteis.isAtributoPreenchido(mpvctoTemp.getContaReceber()) && !getFacadeFactory().getContaReceberFacade().consultarExistenciaContaReceberRecebidaNegociadaPorCodigo(mpvctoTemp.getContaReceber().getCodigo())))){
			if(!convenio.getGerarRestituicaoAlunoValorJaPagoRelativoAoConvenio()){
				for(PlanoDescontoContaReceberVO planoDescontoContaReceberVO: mpvctoTemp.getContaReceber().getPlanoDescontoContaReceberVOs()){							
					if(planoDescontoContaReceberVO.getIsConvenio() && planoDescontoContaReceberVO.getConvenio().getCodigo().equals(convenio.getCodigo())){
						return Boolean.TRUE;
					}
				}	
				return Boolean.FALSE;	
			}else{
				return Boolean.TRUE;
			}
		}else {
			return Boolean.FALSE; 	
		}
	}

	private Boolean consultarSeExisteParcelaConvenioParceiroEmAberta(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO mpvctoVO, ConvenioVO convenioVO) throws Exception {
		String nrParcelaTemp;
		StringBuilder sqlStr = new StringBuilder("SELECT CASE WHEN contareceber.situacao = 'AR' THEN true ELSE false END FROM contareceber  ");
		sqlStr.append("WHERE contareceber.matriculaaluno = '").append(matriculaVO.getMatricula()).append("' ");
		if (!mpvctoVO.getVencimentoReferenteMatricula() && mpvctoVO.getParcela().contains("/")) {
			nrParcelaTemp = mpvctoVO.getParcelaCusteadaConvenio(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getNrParcelasPeriodo(),matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getQuantidadeParcelasMaterialDidatico().intValue());
			sqlStr.append("AND  substring(contareceber.parcela, 0, position('/' in contareceber.parcela)) = '").append(nrParcelaTemp.substring(0, nrParcelaTemp.indexOf("/"))).append("' ");
		}else if (!mpvctoVO.getVencimentoReferenteMatricula() && !mpvctoVO.getParcela().contains("/")) {
			sqlStr.append("AND contareceber.parcela = '").append(mpvctoVO.getParcela()).append("' ");
		} else {
			sqlStr.append("AND contareceber.parcela in ('Matrícula', 'MA', 'MAT', 'Matricula', 'MATRICULA', 'MATRÍCULA') ");
		}
		/*Date novaDataVcto = mpvctoVO.getDataVencimento();
		if (convenioVO.getDiaBaseRecebimentoParceiro() != 0) {
			novaDataVcto = obterProximaDataVctoComDiaConvenio(mpvctoVO.getDataVencimento(), convenioVO.getDiaBaseRecebimentoParceiro());
		}
		sqlStr.append("  AND cr.datavencimento = '").append(Uteis.getDataJDBC(novaDataVcto)).append("' ");*/
		sqlStr.append(" AND contareceber.matriculaperiodo = ").append(mpvctoVO.getMatriculaPeriodo()).append(" ");
		sqlStr.append("  AND contareceber.tipoorigem = 'BCC' AND contareceber.convenio = ").append(convenioVO.getCodigo());
		
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return tabelaResultado.next() ? tabelaResultado.getBoolean("case") : null;
	}

	public List<CondicaoPagamentoPlanoFinanceiroCursoVO> executarMontagemComboCondicaoPagamentoPlanoFinanceiroCurso(Integer planoFinanceiroCurso, Integer condicaoPagamentoPlanoFinanceiroCurso, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception {
		List<CondicaoPagamentoPlanoFinanceiroCursoVO> resultadoConsulta = new ArrayList<CondicaoPagamentoPlanoFinanceiroCursoVO>(0);
		if ((planoFinanceiroCurso == null) || (planoFinanceiroCurso.equals(0))) {
			return resultadoConsulta;
		}
		List<CondicaoPagamentoPlanoFinanceiroCursoVO> listaTodasCondicaoPagamentoVOs = new ArrayList<CondicaoPagamentoPlanoFinanceiroCursoVO>(0);
		listaTodasCondicaoPagamentoVOs = getFacadeFactory().getCondicaoPagamentoPlanoFinanceiroCursoFacade().consultarPorCodigoPlanoFinanceiroCurso(planoFinanceiroCurso, "", false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);

		for (CondicaoPagamentoPlanoFinanceiroCursoVO obj : listaTodasCondicaoPagamentoVOs) {
			if (obj.getCodigo().equals(condicaoPagamentoPlanoFinanceiroCurso)) {
				resultadoConsulta.add(obj);
			} else {
				Boolean alunoVeterano = !matriculaPeriodoVO.getCalouro();
				Boolean logadoVisaoAlunoOuPais = ((Uteis.isAtributoPreenchido(usuarioVO)) && (usuarioVO.getVisaoLogar().equals("aluno") || usuarioVO.getVisaoLogar().equals("pais")) && context().getExternalContext().getSessionMap().get("VisaoAlunoControle") != null);
				Boolean logadoVisaoProfessor = ((Uteis.isAtributoPreenchido(usuarioVO)) && (usuarioVO.getVisaoLogar().equals("professor")) && context().getExternalContext().getSessionMap().get("VisaoProfessorControle") != null);
				Boolean logadoVisaoCoordenador = ((Uteis.isAtributoPreenchido(usuarioVO)) && (usuarioVO.getVisaoLogar().equals("coordenador")) && context().getExternalContext().getSessionMap().get("VisaoCoordenadorControle") != null);
				Boolean apresentarVisaoAdministrativa = ((Uteis.isAtributoPreenchido(usuarioVO)) && (usuarioVO.getIsApresentarVisaoAdministrativa()));

				if (
						(obj.getSituacao().equals("AT")) 
						&& (obj.getAplicavelParaDeterminadaFormaIngresso(matriculaVO.getFormaIngresso())) 
						&& (obj.getAplicavelParaDeterminadaSemestreAnoIngresso(matriculaVO.getSemestreIngresso(), matriculaVO.getAnoIngresso())) 
						&& (obj.getAplicavelParaDeterminadaSemestreAnoRenovacao(alunoVeterano, matriculaPeriodoVO.getSemestre(), matriculaPeriodoVO.getAno())) 
						&& (obj.getAplicavelParaTipoMatricula(matriculaPeriodoVO.getMatriculaEspecial())) 
						&& (((obj.getAplicavelParaVisaoUsuario(logadoVisaoAlunoOuPais)) && (logadoVisaoAlunoOuPais || apresentarVisaoAdministrativa))
					 || obj.getAplicavelParaMatriculaOnlineExterna(matriculaVO) || obj.getAplicavelParaMatriculaOnlineProfessor(logadoVisaoProfessor) || obj.getAplicavelParaMatriculaOnlineCoordenador(logadoVisaoCoordenador))) {
					
					resultadoConsulta.add(obj);
				}
			}
		}
		return resultadoConsulta;
	}
	
	
	/**
	 * Monta a combo de condicao de pagamento considerando as RGN do plano financeiro e da condicao de pagamento
	 * 
	 * @param planoFinanceiroCurso
	 * @param condicaoPagamentoPlanoFinanceiroCurso
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @param usuarioVO
	 * @return
	 * @throws Exception
	 */
	public List<CondicaoPagamentoPlanoFinanceiroCursoVO> executarMontagemComboCondicaoPagamentoPlanoFinanceiroCurso(Integer planoFinanceiroCurso, String categoria, MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception {
		List<CondicaoPagamentoPlanoFinanceiroCursoVO> resultadoConsulta = new ArrayList<CondicaoPagamentoPlanoFinanceiroCursoVO>(0);
		if ((planoFinanceiroCurso == null) || (planoFinanceiroCurso.equals(0))) {
			return resultadoConsulta;
		}
		List<CondicaoPagamentoPlanoFinanceiroCursoVO> listaTodasCondicaoPagamentoVOs = new ArrayList<CondicaoPagamentoPlanoFinanceiroCursoVO>(0);
		listaTodasCondicaoPagamentoVOs = getFacadeFactory().getCondicaoPagamentoPlanoFinanceiroCursoFacade().consultarPorCodigoPlanoFinanceiroCursoECategoria(planoFinanceiroCurso, categoria, "AT", false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);

		String semestre = !matriculaVO.getSemestreIngresso().isEmpty() ? matriculaVO.getSemestreIngresso() : matriculaPeriodoVO.getSemestre();
		String ano = !matriculaVO.getAnoIngresso().isEmpty() ? matriculaVO.getAnoIngresso() : matriculaPeriodoVO.getAno();

		Boolean logadoVisaoAlunoOuPais = ((Uteis.isAtributoPreenchido(usuarioVO)) && (usuarioVO.getVisaoLogar().equals("aluno") || usuarioVO.getVisaoLogar().equals("pais")) && context().getExternalContext().getSessionMap().get("VisaoAlunoControle") != null);
		Boolean logadoVisaoProfessor = ((Uteis.isAtributoPreenchido(usuarioVO)) && (usuarioVO.getVisaoLogar().equals("professor")) && context().getExternalContext().getSessionMap().get("VisaoProfessorControle") != null);
		Boolean logadoVisaoCoordenador = ((Uteis.isAtributoPreenchido(usuarioVO)) && (usuarioVO.getVisaoLogar().equals("coordenador")) && context().getExternalContext().getSessionMap().get("VisaoCoordenadorControle") != null);
		Boolean apresentarVisaoAdministrativa = ((Uteis.isAtributoPreenchido(usuarioVO)) && (usuarioVO.getIsApresentarVisaoAdministrativa()));
		boolean existeCondicaoMP =  false;
		
		for (CondicaoPagamentoPlanoFinanceiroCursoVO obj : listaTodasCondicaoPagamentoVOs) {

			if ((obj.getSituacao().equals("AT")) 
					&& (obj.getAplicavelParaDeterminadaFormaIngresso(matriculaVO.getFormaIngresso())) 
					&& (obj.getAplicavelParaDeterminadaSemestreAnoIngresso(semestre, ano)) 
					&& (obj.getAplicavelParaTipoMatricula(matriculaPeriodoVO.getMatriculaEspecial())) 
					&& (((obj.getAplicavelParaVisaoUsuario(logadoVisaoAlunoOuPais)) && (logadoVisaoAlunoOuPais || apresentarVisaoAdministrativa))
				 || obj.getAplicavelParaMatriculaOnlineExterna(matriculaVO) || obj.getAplicavelParaMatriculaOnlineProfessor(logadoVisaoProfessor) || obj.getAplicavelParaMatriculaOnlineCoordenador(logadoVisaoCoordenador))) {
				
				resultadoConsulta.add(obj);
				if(obj.getCodigo().equals(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getCodigo())) {
					existeCondicaoMP =  true;
				}
			}
			
		}
		if(!existeCondicaoMP && Uteis.isAtributoPreenchido(matriculaPeriodoVO)  && 
				Uteis.isAtributoPreenchido(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso())) {
			resultadoConsulta.add((CondicaoPagamentoPlanoFinanceiroCursoVO) Uteis.clonar(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso()));
		}
		return resultadoConsulta;
	}

	
	public List executarValidacaoParaCancelarMatriculasPeriodoPreMatriculadas(List listaPreMatriculados, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVO> listaMatriculaPeriodoQueNaoPodemSeremCanceladas = new ArrayList<MatriculaPeriodoVO>(0);
		Iterator i = listaPreMatriculados.iterator();
		boolean entrou = false;
		while (i.hasNext()) {
			MatriculaPeriodoVO m = (MatriculaPeriodoVO) i.next();
			if (m.getSelecionarMatriculaPeriodoRenovar()) {
				entrou = true;
				try {
					boolean existeContaReceberRecebidaOuNegociada = getFacadeFactory().getContaReceberFacade().consultarExistenciaContaReceberRecebidaOuNegociadaPorMatriculaPeriodo(m.getCodigo());
					if (existeContaReceberRecebidaOuNegociada) {
						listaMatriculaPeriodoQueNaoPodemSeremCanceladas.add(m);
					}
				} catch (Exception e) {
					throw e;
				}
			}
		}
		if (!entrou) {
			throw new Exception("Deve ser selecionado ao menos um aluno para realizar a operação!");
		}
		if (listaMatriculaPeriodoQueNaoPodemSeremCanceladas.isEmpty()) {
			executarCancelamentoMatriculasPeriodoPreMatriculadas(listaPreMatriculados, configuracaoFinanceiro, usuario);
		}
		return listaMatriculaPeriodoQueNaoPodemSeremCanceladas;
	}

	
	public List executarCancelamentoMatriculasPeriodoPreMatriculadas(List listaPreMatriculados, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		Iterator i = listaPreMatriculados.iterator();
		while (i.hasNext()) {
			MatriculaPeriodoVO m = (MatriculaPeriodoVO) i.next();
			if (m.getSelecionarMatriculaPeriodoRenovar()) {
				try {
					boolean existeContaReceberRecebidaOuNegociada = getFacadeFactory().getContaReceberFacade().consultarExistenciaContaReceberRecebidaOuNegociadaPorMatriculaPeriodo(m.getCodigo());
					if (!existeContaReceberRecebidaOuNegociada) {
						executarCancelamentoPreMatricula(m, usuario.getCodigo(), new ArrayList(0), usuario);
						m.setApresentarSituacao(true);
					} else {
						m.setApresentarSituacao(true);
						m.setErro(true);
						m.setMensagemErro(UteisJSF.internacionalizar("msg_ConfirmacaoPreMatricula_preMatriculaComParcelaPaga"));
					}
				} catch (Exception e) {
					m.setErro(true);
					m.setMensagemErro(e.getMessage());
				}
			}
		}
		return listaPreMatriculados;
	}

	private Integer verificarSeContaASerGeradaPossuiConvenioComDescontoDeAntecipacaoAluno(MatriculaVO matriculaVO, String tipoParcela) throws Exception {
		for (ItemPlanoFinanceiroAlunoVO obj : matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()) {
			if (obj.getTipoItemPlanoFinanceiro().equals("CO")) {
				if (tipoParcela.equals("Matrícula")) {
					if (obj.getConvenio().getBolsaCusteadaParceiroMatricula().doubleValue() != 0.0) {
						if (obj.getConvenio().getPossuiDescontoAntecipacao()) {
							if (obj.getConvenio().getAplicarDescontoProgressivoMatricula()) {
								return obj.getConvenio().getDescontoProgressivoAluno().getCodigo();
							} else {
								return 0;
							}
						}
					}
				} else if (tipoParcela.equals("Mensalidade")) {
					if (obj.getConvenio().getBolsaCusteadaParceiroParcela().doubleValue() != 0.0) {
						if (obj.getConvenio().getPossuiDescontoAntecipacao()) {
							return obj.getConvenio().getDescontoProgressivoAluno().getCodigo();
						}
					}
				}
			}
		}
		return 0;
	}

	private Integer verificarSeContaASerGeradaPossuiConvenioComDescontoDeAntecipacaoParceiro(MatriculaVO matriculaVO, Integer codigoConvenio, String tipoParcela) throws Exception {
		for (ItemPlanoFinanceiroAlunoVO obj : matriculaVO.getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()) {
			if (obj.getTipoItemPlanoFinanceiro().equals("CO")) {
				if (tipoParcela.equals("Matrícula")) {
					if (obj.getConvenio().getBolsaCusteadaParceiroMatricula().doubleValue() != 0.0) {
						if (obj.getConvenio().getPossuiDescontoAntecipacao() && (obj.getConvenio().getCodigo().equals(codigoConvenio))) {
							if (obj.getConvenio().getAplicarDescontoProgressivoMatriculaParceiro()) {
								return obj.getConvenio().getDescontoProgressivoParceiro().getCodigo();
							} else {
								return 0;
							}
						}
					}
				} else if (tipoParcela.equals("Mensalidade")) {
					if (obj.getConvenio().getBolsaCusteadaParceiroParcela().doubleValue() != 0.0) {
						if (obj.getConvenio().getPossuiDescontoAntecipacao() && (obj.getConvenio().getCodigo().equals(codigoConvenio))) {
							return obj.getConvenio().getDescontoProgressivoParceiro().getCodigo();
						}
					}
				}
			}
		}
		return 0;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void excluirComBaseNaMatricula(String matricula, ConfiguracaoFinanceiroVO confFinanVO, UsuarioVO usuarioLogado) throws Exception {
		StringBuilder sqlStr = new StringBuilder("DELETE FROM matriculaperiodo WHERE matricula = '").append(matricula).append("' ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioLogado));
		try {
			getConexao().getJdbcTemplate().update(sqlStr.toString());
		} finally {
			sqlStr = null;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void liberarContasTransferenciaUnidade(MatriculaVO matriculaVoNova, MatriculaPeriodoVO matriculaPeriodoVoOrigem, MatriculaPeriodoVO matriculaPeriodoVoDestino, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, UsuarioVO usuarioResponsavel, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		Integer qtdeContasMatriculaOrigem = null;
		try {
			qtdeContasMatriculaOrigem = getFacadeFactory().getContaReceberFacade().consultarQtdeContasComBaseNaDataVencimento(matriculaPeriodoVoOrigem.getMatriculaVO().getMatricula(), "AL", "Matrícula", true);
			inicializarDadosParaProcessarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVoNova, matriculaPeriodoVoDestino, processoMatriculaCalendarioVO, usuario, configuracaoFinanceiro);
			if (qtdeContasMatriculaOrigem > 0) {
				liberarContasMensalidadesTransferenciaUnidade(qtdeContasMatriculaOrigem, matriculaVoNova, matriculaPeriodoVoOrigem, matriculaPeriodoVoDestino, usuarioResponsavel, configuracaoFinanceiro, usuario);
			}
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void liberarContaMatriculaTransferenciaUnidade(Integer qtdeContasMatriculaOrigem, MatriculaVO matriculaVoNova, MatriculaPeriodoVO matriculaPeriodoVoOrigem, MatriculaPeriodoVO matriculaPeriodoVoDestino, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, UsuarioVO usuarioResponsavel, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		SituacaoVencimentoMatriculaPeriodo situacaoVencimento = null;
		situacaoVencimento = matriculaPeriodoVoDestino.obterSituacaoParcelasReferenteMatricula();
		if (!situacaoVencimento.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) {
			if (situacaoVencimento.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA)) {
				MatriculaPeriodoVencimentoVO parcelaMatricula = gerarVencimentoMatricula(matriculaPeriodoVoDestino, matriculaPeriodoVoDestino.getProcessoMatriculaCalendarioVO().getDataVencimentoMatricula());
				gerarLiberacaoPagamentoMatricula_CriandoContaReceber(matriculaVoNova, matriculaPeriodoVoDestino, parcelaMatricula, configuracaoFinanceiro, usuario);
				matriculaPeriodoVoDestino.alterarSituacaoVencimentoRelativoMatricula(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA);
				getFacadeFactory().getMatriculaPeriodoVencimentoFacade().incluir(parcelaMatricula, usuario);
			}
			if (situacaoVencimento.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA)) {
				alterarContaReceberLiberandoPagamentoMatricula(matriculaVoNova, matriculaPeriodoVoDestino, configuracaoFinanceiro, usuario);
				matriculaPeriodoVoDestino.alterarSituacaoVencimentoRelativoMatricula(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA);
				getFacadeFactory().getMatriculaPeriodoVencimentoFacade().alterar(matriculaPeriodoVoDestino.getMatriculaPeriodoVencimentoReferenteMatricula(), false, null);
			}
		}
		matriculaPeriodoVoDestino.setDataLiberacaoMatricula(new Date());
		matriculaPeriodoVoDestino.setResponsavelLiberacaoMatricula(usuarioResponsavel);
		matriculaPeriodoVoDestino.setSituacao("AT");
		alterarMatriculaPeriodoLiberandoPagamentoMatricula(matriculaPeriodoVoDestino);
		matriculaVoNova.setSituacaoFinanceira("QU");
		getFacadeFactory().getMatriculaFacade().alterarSituacaoFinanceiraMatricula(matriculaVoNova.getMatricula(), matriculaVoNova.getSituacaoFinanceira());
		processarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVoNova, matriculaPeriodoVoDestino, matriculaPeriodoVoDestino.getProcessoMatriculaCalendarioVO(), null, null, configuracaoFinanceiro, usuario, false);

	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void liberarContasMensalidadesTransferenciaUnidade(Integer qtdeContasMatriculaOrigem, MatriculaVO matriculaVoNova, MatriculaPeriodoVO matriculaPeriodoVoOrigem, MatriculaPeriodoVO matriculaPeriodoVoDestino, UsuarioVO usuarioResponsavel, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		SituacaoVencimentoMatriculaPeriodo situacaoVencimento = null;
		Integer qtdeContas = qtdeContasMatriculaOrigem;
		try {
			Collections.sort(matriculaPeriodoVoDestino.getMatriculaPeriodoVencimentoVOs(), new Uteis.OrdenaListaMatriculaPeriodoVencimentoVOPorDataVencimento());
			Integer i = 0;
			for (i = 0; i < qtdeContas; i++) {
				if ((matriculaPeriodoVoDestino.getMatriculaPeriodoVencimentoVOs().size()) != i) {
					if (!matriculaPeriodoVoDestino.getMatriculaPeriodoVencimentoVOs().get(i).getParcela().equals("MA")) {
						situacaoVencimento = matriculaPeriodoVoDestino.getMatriculaPeriodoVencimentoVOs().get(i).getSituacao();
						if (!situacaoVencimento.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA)) {
							if (situacaoVencimento.equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA)) {
								alterarContaReceberLiberandoPagamentoParcela(matriculaVoNova, matriculaPeriodoVoDestino, matriculaPeriodoVoDestino.getMatriculaPeriodoVencimentoVOs().get(i).getParcela(), "Isenï¿½ï¿½o de pagamento, transferï¿½ncia da Matrícula " + matriculaPeriodoVoOrigem.getMatriculaVO().getMatricula() + " Unidade: " + matriculaPeriodoVoOrigem.getMatriculaVO().getUnidadeEnsino().getNome() + " para a Matrícula " + matriculaVoNova.getMatricula() + " Unidade: " + matriculaVoNova.getUnidadeEnsino().getNome(), configuracaoFinanceiro, usuario);
								matriculaPeriodoVoDestino.getMatriculaPeriodoVencimentoVOs().get(i).setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA);
								getFacadeFactory().getMatriculaPeriodoVencimentoFacade().alterar(matriculaPeriodoVoDestino.getMatriculaPeriodoVencimentoVOs().get(i), false, null);
							}
						}
					} else {
						qtdeContas++;
					}
				} else {
					break;
				}
			}
		} catch (Exception e) {
			throw e;
		}
	}

	public Boolean consultarExistenciaMatriculaPeriodoPorProcessoMatriculaSituacao(Integer processoMatricula, String situacao) throws Exception {
		StringBuilder sqlStr = new StringBuilder("SELECT CASE WHEN COUNT(codigo) > 0 THEN true ELSE false END AS existe FROM matriculaperiodo mp ");
		sqlStr.append(" WHERE mp.matricula IN( SELECT mp2.matricula FROM matriculaperiodo mp2 ");
		sqlStr.append(" WHERE mp2.processomatricula = ? ) AND mp.situacaoMatriculaPeriodo = ? LIMIT 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { processoMatricula, situacao });
		if (tabelaResultado.next()) {
			return tabelaResultado.getBoolean("existe");
		}
		return false;
	}

	public Integer consultarQuantidadeAlunosMatriculadosProcessoMatricula(Integer processoMatricula) throws Exception {
		StringBuilder sqlStr = new StringBuilder("SELECT COUNT(codigo) AS quantidadeAlunos FROM matriculaperiodo mp ");
		sqlStr.append(" WHERE mp.processomatricula = ? ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { processoMatricula });
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("quantidadeAlunos");
		}
		return 0;
	}

	public List<MatriculaPeriodoVO> consultaRapidaPorProcessoMatricula(Integer processoMatricula, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" where matriculaperiodo.processoMatricula = ").append(processoMatricula).append(" ");
		sqlStr.append(" AND matricula.situacao = 'AT' ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO obj = null;
		while (tabelaResultado.next()) {
			obj = new MatriculaPeriodoVO();
			montarDadosBasico(obj, tabelaResultado);
			vetResultado.add(obj);
		}
		return vetResultado;
	}

	public List<MatriculaPeriodoVO> consultaPreMatriculaParaExclusao() throws Exception {
		StringBuffer sqlStr = new StringBuffer();
		sqlStr.append("select distinct matriculaperiodo.* from matriculaperiodo ");
		sqlStr.append("inner join matricula on matricula.matricula = matriculaperiodo.matricula ");
		sqlStr.append("inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino ");
		sqlStr.append("inner join configuracaogeralsistema on configuracaogeralsistema.configuracoes = unidadeensino.configuracoes ");
		sqlStr.append("inner join planofinanceiroaluno on planofinanceiroaluno.matriculaperiodo = matriculaperiodo.codigo ");
		sqlStr.append("inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = planofinanceiroaluno.condicaopagamentoplanofinanceirocurso ");
		sqlStr.append("inner join contareceber on matriculaperiodo.codigo = contareceber.matriculaperiodo ");
		sqlStr.append("and contareceber.codigo = (select cr.codigo from contareceber cr where matriculaperiodo.codigo = cr.matriculaperiodo and ((condicaopagamentoplanofinanceirocurso.naocontrolarmatricula and cr.tipoorigem = 'MEN') or (condicaopagamentoplanofinanceirocurso.naocontrolarmatricula = false and cr.tipoorigem = 'MAT')) order by cr.datavencimento limit 1) ");
		sqlStr.append("where configuracaogeralsistema.diaspararemoverprematricula > 0 ");
		sqlStr.append("and matriculaperiodo.situacaomatriculaperiodo = 'PR' ");
		sqlStr.append("and contareceber.datavencimento <= current_date - configuracaogeralsistema.diaspararemoverprematricula ");
		sqlStr.append("and matriculaperiodo.codigo not in ( ");
		sqlStr.append("select distinct cr.matriculaperiodo from contareceber cr ");
		sqlStr.append("where cr.situacao in ('RE', 'NE') ");
		sqlStr.append("and cr.matriculaperiodo = matriculaperiodo.codigo)");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsulta(tabelaResultado, Uteis.NIVELMONTARDADOS_DADOSMINIMOS, null, null);
	}

	public void consultaRapidaPorTurmaMatriculaDocumentoPendente(DataModelo controleConsultaOtimizado, Integer unidadeEnsino, Integer turma, String matricula, Boolean trazerDocumentosIndeferidos , Boolean trazerDocumentosDeferidos, Boolean trazerDocumentosPendentes, Integer chamada, ProcSeletivoVO procSeletivoVO, String nivelEducacional, UsuarioVO usuarioVO) throws Exception {
		StringBuffer sqlStr = new StringBuffer();		
		sqlStr.append(" select distinct COUNT(*) OVER() as totalRegistroConsulta,  matriculaperiodo.*, turma.identificadorturma, pessoa.nome, pessoa.rg, matricula.bolsasAuxilios, matricula.autodeclaracaoPretoPardoIndigena, matricula.normasMatricula , matricula.escolaPublica from matricula ");		
		sqlStr.append(" inner join pessoa on pessoa.codigo = matricula.aluno ");
		sqlStr.append(" inner join curso on curso.codigo = matricula.curso ");
		sqlStr.append(" inner join matriculaperiodo on matriculaperiodo.matricula = matricula.matricula ");
		sqlStr.append(" and  matriculaperiodo.codigo = (select mp.codigo from matriculaperiodo mp where mp.matricula = matricula.matricula "); 
		sqlStr.append(" order by (mp.ano || '/' || mp.semestre) desc, case when mp.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, mp.codigo desc limit 1 )");
		sqlStr.append(" inner join turma on matriculaperiodo.turma = turma.codigo ");		
		if((Uteis.isAtributoPreenchido(chamada) && chamada > 0) || Uteis.isAtributoPreenchido(procSeletivoVO)) {
			sqlStr.append(" inner join inscricao on inscricao.codigo = matricula.inscricao ");
		}
		sqlStr.append(" where exists (select documetacaomatricula.codigo from documetacaomatricula ");		
		if(Uteis.isAtributoPreenchido(unidadeEnsino) && (!Uteis.isAtributoPreenchido(turma) && !Uteis.isAtributoPreenchido(matricula))) {
			sqlStr.append("  left join arquivo on arquivo.codigo = documetacaomatricula.arquivo ");
			sqlStr.append("  and  case when exists (select d.codigo from documetacaomatricula d where d.arquivo  is not null and d.arquivo = arquivo.codigo and d.entregue =  false and d.codigo != documetacaomatricula.codigo) then ");
			sqlStr.append("  Matricula.Matricula = (select mt.matricula from matricula mt where pessoa.codigo =  mt.aluno order by mt.data asc limit 1) ");
			sqlStr.append("  else true end ");
		}
		sqlStr.append(" where documetacaomatricula.matricula = matricula.matricula and  ((COALESCE(documetacaomatricula.arquivoaprovadopelodep, FALSE) = false and documetacaomatricula.arquivo is not null and documetacaomatricula.arquivo <> 0 and (documetacaomatricula.respnegardocdep is null or documetacaomatricula.respnegardocdep = 0)) ");
		if(trazerDocumentosIndeferidos) {
			sqlStr.append(" or (COALESCE(documetacaomatricula.arquivoaprovadopelodep, FALSE) = false and (documetacaomatricula.respnegardocdep is not null and documetacaomatricula.respnegardocdep > 0)) ");
		}
		if(trazerDocumentosDeferidos) {
			sqlStr.append(" or (documetacaomatricula.arquivoaprovadopelodep = true and documetacaomatricula.entregue = true) ");
		}
		if(trazerDocumentosPendentes) {
			sqlStr.append(" or (documetacaomatricula.entregue = false and documetacaomatricula.arquivo is null ) ");
		}
		if(controleConsultaOtimizado.getDataIni() != null || controleConsultaOtimizado.getDataFim() != null) {			
			sqlStr.append(" and ").append(realizarGeracaoWherePeriodo(controleConsultaOtimizado.getDataIni(), controleConsultaOtimizado.getDataFim(), "documetacaomatricula.dataEntrega", false));
			
		}
		sqlStr.append(" ) limit 1) ");
		
		if (unidadeEnsino != 0) {
			sqlStr.append(" and matricula.unidadeensino = ").append(unidadeEnsino);
		}
		if (turma != 0) {
			sqlStr.append(" and matriculaperiodo.turma = ").append(turma);
		}
		if (!matricula.equals("")) {
			sqlStr.append(" and matricula.matricula = '").append(matricula).append("'");
		}
		if((Uteis.isAtributoPreenchido(chamada) && chamada > 0) ) {
			sqlStr.append("  and inscricao.chamada = ").append(chamada);
		}
		if(Uteis.isAtributoPreenchido(procSeletivoVO)) {
			sqlStr.append("  and inscricao.procSeletivo = ").append(procSeletivoVO.getCodigo());
		}
		if(Uteis.isAtributoPreenchido(nivelEducacional)) {
			sqlStr.append("  and curso.nivelEducacional = '").append(nivelEducacional).append("' ");
		}
        sqlStr.append(" order by pessoa.nome ");        
        sqlStr.append(" limit ").append(controleConsultaOtimizado.getLimitePorPagina()).append(" offset ").append(controleConsultaOtimizado.getOffset());
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			controleConsultaOtimizado.setTotalRegistrosEncontrados((tabelaResultado.getInt("totalRegistroConsulta")));
		}else {
			controleConsultaOtimizado.setTotalRegistrosEncontrados(0);
		}
		tabelaResultado.beforeFirst();
		List<MatriculaPeriodoVO> vetResultado = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO obj = null;
		while (tabelaResultado.next()) {
			obj = new MatriculaPeriodoVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			carregarDados(obj, NivelMontarDados.BASICO, null, usuarioVO);
			obj.getMatriculaVO().setNormasMatricula(tabelaResultado.getBoolean("normasMatricula"));
			obj.getMatriculaVO().setBolsasAuxilios(tabelaResultado.getBoolean("bolsasAuxilios"));
			obj.getMatriculaVO().setEscolaPublica(tabelaResultado.getBoolean("escolaPublica"));
			obj.getMatriculaVO().setAutodeclaracaoPretoPardoIndigena(tabelaResultado.getBoolean("autodeclaracaoPretoPardoIndigena"));
			obj.getMatriculaVO().getAluno().setRG(tabelaResultado.getString("rg"));
			// obj = montarDados(tabelaResultado, obj,
			// Uteis.NIVELMONTARDADOS_DADOSMINIMOS, null, null);
			vetResultado.add(obj);
		}
		controleConsultaOtimizado.setListaConsulta(vetResultado);
	}

	public Integer consultarQuantidadeAlunosAtivos() throws Exception {
		String sql = "select count(matricula.aluno) as qtdAlunosAtivos from matricula inner join pessoa on pessoa.codigo = matricula.aluno where situacao = 'AT' and participabancocurriculum = true";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql);
		if (!tabelaResultado.next()) {
			return 0;
		}
		return (tabelaResultado.getInt("qtdAlunosAtivos"));
	}

	public void removerMatriculaPeriodoTurmaDisciplinaComposta(List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinaVOs, MatriculaPeriodoTurmaDisciplinaVO obj, UsuarioVO usuario) throws Exception {
		if (obj.getDisciplinaComposta()) {
			if (obj.getDisciplinaReferenteAUmGrupoOptativa()) {
				// montando dados da GradeCurricularGrupoOptativaDisciplinaVO,
				// inclusive com as composicoes da mesma.
				GradeCurricularGrupoOptativaDisciplinaVO gradeCurricularGrupoOptativaDisciplinaVO = getFacadeFactory().getGradeCurricularGrupoOptativaDisciplinaFacade().consultarPorChavePrimaria(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), usuario);
				obj.setGradeCurricularGrupoOptativaDisciplinaVO(gradeCurricularGrupoOptativaDisciplinaVO);
			} else {
				// montando dados da gradeDisciplina, inclusive com as
				// composicoes da mesma.
				GradeDisciplinaVO gradeDisciplinaVO = getFacadeFactory().getGradeDisciplinaFacade().consultarPorChavePrimaria(obj.getGradeDisciplinaVO().getCodigo(), usuario);
				obj.setGradeDisciplinaVO(gradeDisciplinaVO);
			}

			List<GradeDisciplinaCompostaVO> listaDisciplinaCompostaVOs = obj.getGradeDisciplinaCompostaVOs();
			for (GradeDisciplinaCompostaVO disciplinaCompostaVO : listaDisciplinaCompostaVOs) {
				int index = 0;
				for (MatriculaPeriodoTurmaDisciplinaVO mptdVO : listaMatriculaPeriodoTurmaDisciplinaVOs) {
					if (mptdVO.getDisciplina().getCodigo().equals(disciplinaCompostaVO.getDisciplina().getCodigo())) {
						listaMatriculaPeriodoTurmaDisciplinaVOs.remove(index);
						break;
					}
					index++;
				}
			}
		}
	}

	public MatriculaPeriodoVO consultaRapidaPorMatriculaAnoSemestre(String matricula, String semestre, String ano, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE matricula.matricula = '").append(matricula).append("' ");
		if (!ano.equals("")) {
			sqlStr.append("AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sqlStr.append("AND matriculaperiodo.semestre = '").append(semestre).append("' ");
		}
		sqlStr.append(" and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, PeriodoLetivo.PeriodoLetivo desc, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO matriculaPeriodoVO = new MatriculaPeriodoVO();
		if (!tabelaResultado.next()) {
			return new MatriculaPeriodoVO();
		}
		montarDadosBasico(matriculaPeriodoVO, tabelaResultado);
		return matriculaPeriodoVO;
	}

	public MatriculaPeriodoVO consultarUltimaMatriculaPeriodoPorMatriculaConclusaoCurso(String matricula, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder("SELECT MatriculaPeriodo.* FROM  MatriculaPeriodo ");
		sqlStr.append(" INNER JOIN matricula ON matricula.matricula = matriculaperiodo.matricula WHERE MatriculaPeriodo.matricula = '" + matricula + "' ");
		sqlStr.append(" AND Matricula.situacao not in ('CA', 'TR', 'CF') ");
		sqlStr.append(" and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, PeriodoLetivo.PeriodoLetivo desc, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (!tabelaResultado.next()) {
			throw new ConsistirException("Não é possível retirar declaração de conclusão de curso para a matrícula: " + matricula + ", pois ela se encontra cancelada ou trancada.");
		}
		return montarDados(tabelaResultado, new MatriculaPeriodoVO(), nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public Boolean consultarAlunoAtivoPorRegistroAula(Integer registroAula, Integer turma, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("select distinct matriculaperiodo.matricula from matriculaperiodo ");
		sb.append(" inner join frequenciaaula on frequenciaaula.matricula = matriculaperiodo.matricula ");
		sb.append(" inner join registroaula on registroaula.codigo = frequenciaaula.registroaula ");
		sb.append(" left join matriculaperiodoturmadisciplina mptd on mptd.matricula = matriculaperiodo.matricula ");
		sb.append(" where (mptd.turma = registroaula.turma or mptd.turma in (select distinct turma from turmaagrupada where turmaorigem = ").append(turma).append("))");
		sb.append(" and matriculaperiodo.situacaomatriculaperiodo = 'AT' ");
		sb.append(" and registroaula.codigo = ").append(registroAula).append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		return tabelaResultado.next();
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void verificarGradeAlunosMatriculadosTurma(Integer codGrade, Integer periodoLetivo, Integer codTurma, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append(" select codigo from matriculaperiodo ");
		sb.append(" where turma = ").append(codTurma);
		sb.append(" and gradecurricular <> ").append(codGrade);
		sb.append(" and periodoletivomatricula <> ").append(periodoLetivo);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		while (tabelaResultado.next()) {
			alterarPeriodoLetivoGradeCurricular(tabelaResultado.getInt("codigo"), periodoLetivo, codGrade);
		}
	}

	public Boolean consultarExistenciaMatriculaPeriodoPorMatriculaAnoSemestre(String matricula, String ano, String semestre, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("select codigo from matriculaPeriodo where matricula = '").append(matricula).append("' ");
		if (!ano.equals("")) {
			sb.append(" and ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sb.append(" and semestre = '").append(semestre).append("' ");
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		return tabelaResultado.next();
	}

	public void validarDadosExistenciaMatriculaPeriodo(String matricula, String ano, String semestre, UsuarioVO usuarioVO) throws Exception {
		Boolean existeMatriculaPeriodo = consultarExistenciaMatriculaPeriodoPorMatriculaAnoSemestre(matricula, ano, semestre, usuarioVO);
		if (!existeMatriculaPeriodo) {
			if (!ano.equals("") && !semestre.equals("")) {
				throw new Exception("Não foi encontrado uma Matrícula Período para a matrícula, ano e semestre informado");
			} else {
				throw new Exception("Não foi encontrado uma Matrícula Período para essa matrícula");
			}
		}
	}

	@Override
	public List<String> consultarAnosMatriculaPeriodo() throws Exception {
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet("select ano from matriculaperiodo where ano is not null and ano != '' group by ano order by ano desc ");
		List<String> anos = new ArrayList<String>(0);
		while (rs.next()) {
			anos.add(rs.getString("ano"));
		}
		return anos;
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	@Override
	public void realizarRegistroNotificacaoAbandonoCurso(Integer matriculaPeriodo) throws Exception {
		getConexao().getJdbcTemplate().update("UPDATE matriculaperiodo set dataNotificacaoAbandonoCurso = current_timestamp where codigo = " + matriculaPeriodo);
	}

	@Override
	public List<MatriculaPeriodoVO> consultarMatriculaPeriodoNotificacaoAbandonoCurso() throws Exception {
		StringBuilder sql = new StringBuilder("");
		sql.append(" select matricula.matricula, unidadeensino.nome as unidadeensino, curso.nome as curso, turno.nome as turno, matriculaperiodo.codigo, pessoa.codigo as aluno, pessoa.nome, pessoa.email, unidadeensino.codigo as \"unidadeensino.codigo\" ");
		sql.append(" from matricula ");
		sql.append(" inner join curso on curso.codigo = matricula.curso and curso.niveleducacional = 'SU' ");
		sql.append(" inner join turno on turno.codigo = matricula.turno  ");
		sql.append(" inner join pessoa on pessoa.codigo = matricula.aluno ");
		sql.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino ");
		sql.append(" inner join configuracaogeralsistema on configuracaogeralsistema.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select codigo from configuracoes  where padrao = true limit 1) end ) ");
		sql.append(" and qtdeDiaNotificarAbandonoCurso > 0 ");
		sql.append(" inner join matriculaperiodo on matriculaperiodo.matricula = matricula.matricula ");
		sql.append(" and matriculaperiodo.codigo in (select codigo from matriculaperiodo mp  ");
		sql.append(" where mp.matricula = matricula.matricula and mp.situacaomatriculaperiodo != 'PC' order by (ano|| '/'|| semestre) desc, data desc limit 1) ");
		sql.append(" and matriculaperiodo.situacaomatriculaperiodo in ('AT', 'FI') and matriculaperiodo.dataNotificacaoAbandonoCurso is null ");
		sql.append(" inner join unidadeensinocurso on unidadeensinocurso.unidadeensino = unidadeensino.codigo and unidadeensinocurso.curso = curso.codigo ");
		sql.append(" and unidadeensinocurso.turno = turno.codigo ");
		sql.append(" inner join periodoletivoativounidadeensinocurso on periodoletivoativounidadeensinocurso.anoreferenciaperiodoletivo  = matriculaperiodo.ano ");
		sql.append(" and periodoletivoativounidadeensinocurso.semestrereferenciaperiodoletivo = matriculaperiodo.semestre and periodoletivoativounidadeensinocurso.unidadeensinocurso = unidadeensinocurso.codigo ");
		sql.append(" and periodoletivoativounidadeensinocurso.situacao = 'IN' and periodoletivoativounidadeensinocurso.datafechamento + (qtdeDiaNotificarAbandonoCurso::VARCHAR||' days')::INTERVAL <= current_date ");

		sql.append(" where (select count(distinct disciplina.codigo) from historico ");
		sql.append(" inner join disciplina on disciplina.codigo = historico.disciplina ");
		sql.append(" where disciplina.tipoDisciplina in ('OB', 'LG')   ");
		sql.append(" and historico.matricula = matricula.matricula  ");
		sql.append(" and historico.situacao in ('AA', 'AP','CS', 'CC') ) ");
		sql.append(" < (select count(distinct disciplina.codigo) from gradecurricular ");
		sql.append(" INNER JOIN periodoletivo AS pr ON gradecurricular.codigo = pr.gradecurricular ");
		sql.append(" INNER join gradedisciplina AS grDisc on grDisc.periodoletivo = pr.codigo   ");
		sql.append(" INNER join disciplina on grDisc.disciplina = disciplina.codigo   ");
		sql.append(" where gradecurricular.codigo =  matriculaperiodo.gradecurricular   ");
		sql.append(" and disciplina.tipoDisciplina in ('OB', 'LG')  ");
		sql.append(" ) ");

		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosNotificacaoAbandonoCurso(rs);
	}

	private List<MatriculaPeriodoVO> montarDadosNotificacaoAbandonoCurso(SqlRowSet rs) throws Exception {
		List<MatriculaPeriodoVO> matriculaPeriodoVOs = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO matriculaPeriodoVO = null;
		while (rs.next()) {
			matriculaPeriodoVO = new MatriculaPeriodoVO();
			matriculaPeriodoVO.setCodigo(rs.getInt("codigo"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setCodigo(rs.getInt("aluno"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setEmail(rs.getString("email"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setNome(rs.getString("nome"));
			matriculaPeriodoVO.getMatriculaVO().setMatricula(rs.getString("matricula"));
			matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().setNome(rs.getString("unidadeEnsino"));
			matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().setCodigo(rs.getInt("unidadeensino.codigo"));
			matriculaPeriodoVO.getMatriculaVO().getCurso().setNome(rs.getString("curso"));
			matriculaPeriodoVO.getMatriculaVO().getTurno().setNome(rs.getString("turno"));
			matriculaPeriodoVOs.add(matriculaPeriodoVO);
		}
		return matriculaPeriodoVOs;
	}

	@Override
	public void realizarRegistroAbandonoCurso() throws Exception {
		Map<Integer, ConfiguracaoGeralSistemaVO> configuracaoGeralSistemaVOs = new HashMap<Integer, ConfiguracaoGeralSistemaVO>(0);
		Map<Integer, ConfiguracaoFinanceiroVO> configuracaoFinanceiroVOs = new HashMap<Integer, ConfiguracaoFinanceiroVO>(0);
		List<MatriculaPeriodoVO> matriculaPeriodoVOs = null;
		try {
			matriculaPeriodoVOs = consultarMatriculaPeriodoAptoRegistrarAbandonoCurso();
			for (MatriculaPeriodoVO matriculaPeriodoVO : matriculaPeriodoVOs) {
				try {
					TrancamentoVO trancamentoVO = new TrancamentoVO();
					trancamentoVO.setJustificativa("Abandono de Curso automático");
					trancamentoVO.setData(new Date());
					trancamentoVO.setDescricao("Abandono de Curso automático");
					getFacadeFactory().getMatriculaFacade().carregarDados(matriculaPeriodoVO.getMatriculaVO(), null);
					trancamentoVO.setMatricula(matriculaPeriodoVO.getMatriculaVO());
//					trancamentoVO.setTrancamentoRelativoAbondonoCurso(true);
					trancamentoVO.setSituacao("EX");

					ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO = null;
					if (configuracaoGeralSistemaVOs.containsKey(matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().getCodigo())) {
						configuracaoGeralSistemaVO = configuracaoGeralSistemaVOs.get(matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().getCodigo());
					} else {
						configuracaoGeralSistemaVO = getFacadeFactory().getConfiguracaoGeralSistemaFacade().consultarConfiguracaoASerUsadaUnidadEnsino(matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, null);
						configuracaoGeralSistemaVOs.put(matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().getCodigo(), configuracaoGeralSistemaVO);
					}
					ConfiguracaoFinanceiroVO configuracaoFinanceiroVO = null;
					if (configuracaoFinanceiroVOs.containsKey(matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().getCodigo())) {
						configuracaoFinanceiroVO = configuracaoFinanceiroVOs.get(matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().getCodigo());
					} else {
						configuracaoFinanceiroVO = getFacadeFactory().getConfiguracaoFinanceiroFacade().consultarPorUnidadeEnsino(matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, null);
						configuracaoFinanceiroVOs.put(matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().getCodigo(), configuracaoFinanceiroVO);
					}
					trancamentoVO.setMotivoCancelamentoTrancamento(configuracaoGeralSistemaVO.getMotivoPadraoAbandonoCurso());
					getFacadeFactory().getTrancamentoFacade().incluirEDeferirRequerimento(trancamentoVO, configuracaoGeralSistemaVO, configuracaoFinanceiroVO, null, false);
					getFacadeFactory().getGestaoEnvioMensagemAutomaticaFacade().executarEnvioMensagemRegistroAbandonoCurso(matriculaPeriodoVO);
				} catch (Exception e) {
				}
			}
		} catch (Exception e) {
			throw e;
		} finally {
			configuracaoGeralSistemaVOs.clear();
			configuracaoFinanceiroVOs.clear();
			configuracaoGeralSistemaVOs = null;
			configuracaoFinanceiroVOs = null;
			Uteis.liberarListaMemoria(matriculaPeriodoVOs);

		}

	}

	@Override
	public List<MatriculaPeriodoVO> consultarMatriculaPeriodoAptoRegistrarAbandonoCurso() throws Exception {
		StringBuilder sql = new StringBuilder("");
		sql.append(" select matricula.matricula, unidadeensino.nome as unidadeensino, curso.nome as curso, turno.nome as turno, matriculaperiodo.codigo, pessoa.codigo as aluno, pessoa.nome, pessoa.email ");
		sql.append(" from matricula ");
		sql.append(" inner join curso on curso.codigo = matricula.curso and curso.niveleducacional = 'SU' ");
		sql.append(" inner join turno on turno.codigo = matricula.turno  ");
		sql.append(" inner join pessoa on pessoa.codigo = matricula.aluno ");
		sql.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino ");
		sql.append(" inner join configuracaogeralsistema on configuracaogeralsistema.configuracoes = (case when unidadeensino.configuracoes is not null then unidadeensino.configuracoes else (select codigo from configuracoes  where padrao = true limit 1) end ) ");
		sql.append(" and qtdeDiaRegistrarAbandonoCurso > 0 ");
		sql.append(" inner join matriculaperiodo on matriculaperiodo.matricula = matricula.matricula ");
		sql.append(" and matriculaperiodo.codigo in (select codigo from matriculaperiodo mp  ");
		sql.append(" where mp.matricula = matricula.matricula and mp.situacaomatriculaperiodo != 'PC' order by (ano|| '/'|| semestre) desc, data desc limit 1) ");
		sql.append(" and matriculaperiodo.situacaomatriculaperiodo in ('AT', 'FI') ");
		sql.append(" inner join unidadeensinocurso on unidadeensinocurso.unidadeensino = unidadeensino.codigo and unidadeensinocurso.curso = curso.codigo ");
		sql.append(" and unidadeensinocurso.turno = turno.codigo ");
		sql.append(" inner join periodoletivoativounidadeensinocurso on periodoletivoativounidadeensinocurso.anoreferenciaperiodoletivo  = matriculaperiodo.ano ");
		sql.append(" and periodoletivoativounidadeensinocurso.semestrereferenciaperiodoletivo = matriculaperiodo.semestre and periodoletivoativounidadeensinocurso.unidadeensinocurso = unidadeensinocurso.codigo ");
		sql.append(" and periodoletivoativounidadeensinocurso.situacao = 'IN' and periodoletivoativounidadeensinocurso.datafechamento + (qtdeDiaRegistrarAbandonoCurso::VARCHAR||' days')::INTERVAL <= current_date ");

		sql.append(" where (select count(distinct disciplina.codigo) from historico ");
		sql.append(" inner join disciplina on disciplina.codigo = historico.disciplina ");
		sql.append(" where disciplina.tipoDisciplina in ('OB', 'LG')   ");
		sql.append(" and historico.matricula = matricula.matricula  ");
		sql.append(" and historico.situacao in ('AA', 'AP','CS', 'CC') ) ");
		sql.append(" < (select count(distinct disciplina.codigo) from gradecurricular ");
		sql.append(" INNER JOIN periodoletivo AS pr ON gradecurricular.codigo = pr.gradecurricular ");
		sql.append(" INNER join gradedisciplina AS grDisc on grDisc.periodoletivo = pr.codigo   ");
		sql.append(" INNER join disciplina on grDisc.disciplina = disciplina.codigo   ");
		sql.append(" where gradecurricular.codigo =  matriculaperiodo.gradecurricular   ");
		sql.append(" and disciplina.tipoDisciplina in ('OB', 'LG')  ");
		sql.append(" ) ");

		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		return montarDadosNotificacaoAbandonoCurso(rs);
	}

	@Override
	public List<MatriculaPeriodoVO> consultarAnoSemstrePeriodoLetivoMatriculaPeriodoPorMatriucla(String matricula, Integer periodoLetivo, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append(" select matriculaperiodo.codigo, ano, semestre, periodoletivo.periodoletivo, situacaomatriculaperiodo from matriculaperiodo ");
		sb.append(" inner join periodoletivo on periodoletivo.codigo = matriculaperiodo.periodoletivomatricula ");
		sb.append(" where matricula = '").append(matricula).append("' ");
		if (periodoLetivo != null && periodoLetivo > 0) {
			sb.append(" and periodoletivo.codigo = ").append(periodoLetivo);
		}
		sb.append(" order by ano, semestre, periodoletivo.periodoletivo");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<MatriculaPeriodoVO> listaMatriculaPeriodoVOs = new ArrayList<MatriculaPeriodoVO>(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setAno(tabelaResultado.getString("ano"));
			obj.setSemestre(tabelaResultado.getString("semestre"));
			obj.getPeridoLetivo().setPeriodoLetivo(tabelaResultado.getInt("periodoLetivo"));
			obj.setSituacaoMatriculaPeriodo(tabelaResultado.getString("situacaomatriculaperiodo"));
			listaMatriculaPeriodoVOs.add(obj);
		}
		return listaMatriculaPeriodoVOs;
	}

	public MatriculaPeriodoVO consultarAnoSemestreMatriculaPeriodoPorCodigo(Integer matriculaPeriodo, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("select codigo, ano, semestre from matriculaPeriodo where codigo = ").append(matriculaPeriodo);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setAno(tabelaResultado.getString("ano"));
			obj.setSemestre(tabelaResultado.getString("semestre"));
		}
		return obj;
	}

	@Override
	public MatriculaPeriodoVO consultaRapidaBasicaUltimaMatriculaPeriodoAptaEmprestimoBiblioteca(String matricula, String situacoes, boolean controlarAcesso, int nivelMontarDados, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append("WHERE MatriculaPeriodo.matricula = '").append(matricula).append("' and MatriculaPeriodo.situacaomatriculaperiodo not in ("+situacoes+") ");
		sqlStr.append("and ((").append("case when curso.periodicidade = 'SE' then ");
		sqlStr.append("matriculaperiodo.ano = '").append(Uteis.getAnoDataAtual()).append("' ");
		sqlStr.append("and matriculaperiodo.semestre = '").append(Uteis.getSemestreAtual()).append("' ");
		sqlStr.append("when curso.periodicidade = 'AN' then ");
		sqlStr.append("matriculaperiodo.ano = '").append(Uteis.getAnoDataAtual()).append("' ");
		sqlStr.append("else true end) ");
		
		sqlStr.append(" or (select pl.dataFimPeriodoLetivo from periodoletivoativounidadeensinocurso pl ");
		sqlStr.append(" inner join processomatriculacalendario pmc on pmc.periodoletivoativounidadeensinocurso = pl.codigo ");
		sqlStr.append(" inner join matriculaperiodo mp on mp.processomatricula = pmc.processomatricula ");
		sqlStr.append(" where mp.matricula = '").append(matricula).append("' ");
		sqlStr.append(" and mp.situacaomatriculaperiodo in('AT', 'FI') ");
		sqlStr.append(" and mp.unidadeEnsinoCurso = pl.unidadeEnsinoCurso ");
		sqlStr.append(" order by (mp.ano||'/'||mp.semestre) desc, case when mp.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, mp.codigo desc limit 1 ");
		sqlStr.append(" ) >= current_date ");
		sqlStr.append(")  ");
		sqlStr.append(" and matricula.situacao = 'AT' ");
		sqlStr.append("order by (MatriculaPeriodo.ano||'/'|| MatriculaPeriodo.semestre) desc, periodoletivo.periodoletivo desc, MatriculaPeriodo.codigo desc ");
		sqlStr.append("limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO vetResultado = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			montarDadosBasico(vetResultado, tabelaResultado);
		}
		return vetResultado;
	}

	@Override
	public MatriculaPeriodoVO consultarUltimaMatriculaPeriodoAtivaPreMatriculaPorMatricula(String matricula, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "SELECT MatriculaPeriodo.* FROM  MatriculaPeriodo WHERE MatriculaPeriodo.matricula = '" + matricula + "' and (matriculaperiodo.situacaomatriculaperiodo = 'AT' or matriculaperiodo.situacaomatriculaperiodo = 'PR') ORDER BY (MatriculaPeriodo.ano||'/'||matriculaperiodo.semestre) desc limit 1";
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (!tabelaResultado.next()) {
			throw new ConsistirException("Não existe nenhuma matrícula periodo ativa para a matricula: " + matricula + ".");
		}
		return montarDados(tabelaResultado, new MatriculaPeriodoVO(), nivelMontarDados, configuracaoFinanceiroVO, usuario);
	}

	public void adicionarPeriodoLetivoListaPeriodoLetivoValido(List<PeriodoLetivoVO> listaPeriodosLetivosParaComboBox, PeriodoLetivoVO periodoAdicionar) {
		for (PeriodoLetivoVO periodoExiste : listaPeriodosLetivosParaComboBox) {
			if (periodoExiste.getCodigo().equals(periodoAdicionar.getCodigo())) {
				// se o Período já existe, não pode ser adicionado em
				// duplicidade.
				return;
			}
		}
		listaPeriodosLetivosParaComboBox.add(periodoAdicionar);
	}

	/**
	 * Método Responsável por montar a lista de periodos letivos validos para
	 * renovacao/matricula de um aluno no SEI. Adicionalmente, ele já
	 * inicializar o periodo Letivo da MatricualPeriodo fornecida, caso o mesmo
	 * não tenha sido informado ainda. Este Método considera controles de
	 * evolucao academica do aluno, obrigatoridade de fazer um periodo letivo
	 * novamente e itens relacionados a definição do periodo letivo. Caso
	 * existem restrições com relação aos Períodos letivos que o alnuo pode ser
	 * renovado, este Método registra a explicação sobre esta restrição no
	 * atributo matriculaPeriodoVO.mensagemRestricaoPeriodosLetivosRenovacao.
	 * VERSAO 5.0
	 */
	public List<PeriodoLetivoVO> obterListaPeriodosLetivosValidosParaRenovacaoMatriculaInicializandoPeriodoLetivoPadrao(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoAcademicoVO configuracaoAcademicoVO, MatriculaComHistoricoAlunoVO matriculaComHistoricoAlunoVO, UsuarioVO usuario) throws Exception {
	     return obterListaPeriodosLetivosValidosParaRenovacaoMatriculaInicializandoPeriodoLetivoPadrao(matriculaVO, matriculaPeriodoVO, configuracaoAcademicoVO, matriculaComHistoricoAlunoVO, false, usuario);
	}
	
	public List<PeriodoLetivoVO> obterListaPeriodosLetivosValidosParaRenovacaoMatriculaInicializandoPeriodoLetivoPadrao(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoAcademicoVO configuracaoAcademicoVO, MatriculaComHistoricoAlunoVO matriculaComHistoricoAlunoVO,Boolean realizandoNovaMatriculaAlunoPartindoTransferenciaInterna, UsuarioVO usuario) throws Exception {
		Boolean matriculaCalouro = verificarMatriculaDeCalouro(matriculaVO.getMatricula(), matriculaPeriodoVO.getCodigo(), false, usuario);
		matriculaPeriodoVO.setCalouro(matriculaCalouro);
		// Preparando os dados do últimoPeriodo Letivo do aluno que será
		// utilizado para determinar o préximo Período letivo que aluno poderá
		// renovar
		MatriculaPeriodoVO ultimoPeriodoMatriculaPeriodo = consultaRapidaBasicaMatriculaPeriodoMaiorPeriodoLetivoPorMatricula(matriculaVO.getMatricula(), false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
		if (ultimoPeriodoMatriculaPeriodo.getCodigo().equals(0)) {
			// neste caso nao existe ainda uma MatriculaPeriodo para este aluno,
			// logo
			// o periodoLetivo a ser adotado para o aluno, ï¿½ o primeiro
			// periodo
			// do curso.
			ultimoPeriodoMatriculaPeriodo.getPeriodoLetivo().setPeriodoLetivo(1);
		}
		PeriodoLetivoVO periodoLetivoRefleteEvolucaoAcademicaAluno = matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getPeriodoLetivoEvolucaoAcademicaAluno();

		PeriodoLetivoVO periodoLetivoSugeridoParaMatricula = null;
		// Definindo o periodoLetivo que o SEI irá sugerir para o aluno
		boolean alunoAptoAvancarProximoPeriodo = true;
		String mensagemRestricaoPeriodosLetivosRenovacao = "";

		if (configuracaoAcademicoVO.getRenovacaoMatriculaSequencial()) {
			// se estão definido para ser sequencial, então basta-se sugerir o
			// préximo periodoLetivo
			// com base no ultimo periodo cursado pelo aluno (que tambem será o
			// maior - mais avancado na grade)
			if (matriculaCalouro) {
				periodoLetivoSugeridoParaMatricula = matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPrimeiroPeriodoLetivoGrade();
			} else {
				Integer nrPeriodoAtual = ultimoPeriodoMatriculaPeriodo.getPeriodoLetivo().getPeriodoLetivo();
				Integer nrProximoPeriodo = matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().obterNumeroProximoPeriodo(nrPeriodoAtual);
				periodoLetivoSugeridoParaMatricula = matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().consultarObjPeriodoLetivoVOPorNumeroPeriodoLetivo(nrProximoPeriodo);
			}
		} else {
			if (configuracaoAcademicoVO.getControlarAvancoPeriodoPorCreditoOuCH()) {
				// Existe na configuracaoAcademico
				// que determina qual o percentual de aproveitamento que o aluno
				// deve ter tido do seu ultimo
				// semestre para avancar para o proximo semestre. O atributo
				// periodoLetivoRefleteEvolucaoAcademicaAluno
				// já foi setado considerando estes parametros de configuracao.
				// Caso o periodoLetivoRefleteEvolucaoAcademicaAluno seja
				// inferir ao último Período
				// que o aluno estudou, então o SEI irá sugerir que o aluno seja
				// mantido no último Período
				// que ele estudou.
				if (matriculaCalouro) {
					periodoLetivoSugeridoParaMatricula = periodoLetivoRefleteEvolucaoAcademicaAluno;
					mensagemRestricaoPeriodosLetivosRenovacao = "Período Letivo definido automaticamente com base na evolução acadêmicaa do aluno (configuração acadêmica).";
				} else {
					if (periodoLetivoRefleteEvolucaoAcademicaAluno.getPeriodoLetivo().compareTo(ultimoPeriodoMatriculaPeriodo.getPeridoLetivo().getPeriodoLetivo()) < 0) {
						// como periodo letivo academico ï¿½ menor que o último
						// Período que o aluno estudou, ento o SEI irá sugerir
						// que o aluno permaneï¿½a no mesmo Período que ele
						// estou
						// da última vez (o Período mais avançado que ele
						// estudou)
						// assim, evita-se que o aluno continue progredindo em
						// um Período letivo que não reflete sua vida
						// acadêmicaa.
						periodoLetivoSugeridoParaMatricula = matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().consultarObjPeriodoLetivoVOPorNumeroPeriodoLetivo(ultimoPeriodoMatriculaPeriodo.getPeridoLetivo().getPeriodoLetivo());
						mensagemRestricaoPeriodosLetivosRenovacao = "Período Letivo definido com base automaticamente com base na evolução acadêmica do aluno (Percentual de aprovação nas Disciplinas dos Períodos Anteriores).";
					} else {
						periodoLetivoSugeridoParaMatricula = periodoLetivoRefleteEvolucaoAcademicaAluno;
						mensagemRestricaoPeriodosLetivosRenovacao = "Período Letivo definido com base automaticamente com base na evolução acadêmica do aluno (Percentual de aprovação nas Disciplinas dos Períodos Anteriores).";
					}
				}
			} else {
				if ((!configuracaoAcademicoVO.getPermiteEvoluirPeriodoLetivoCasoReprovado()) && configuracaoAcademicoVO.getIsPossuiControleDisciplinaReprovacao()) {
					alunoAptoAvancarProximoPeriodo = getFacadeFactory().getHistoricoFacade().executarValidarMatriculaPeriodoExcedeuLimiteMaximoDisciplinaReprovado(matriculaVO.getMatricula(), configuracaoAcademicoVO.getConsiderarDisciplinasReprovadasPeriodosLetivosAnteriores(), configuracaoAcademicoVO.getNumeroDisciplinaConsiderarReprovadoPeriodoLetivo(), usuario);
					if (matriculaCalouro) {
						periodoLetivoSugeridoParaMatricula = matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPrimeiroPeriodoLetivoGrade();
					} else {
						if (!alunoAptoAvancarProximoPeriodo) {
							periodoLetivoSugeridoParaMatricula = matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().consultarObjPeriodoLetivoVOPorNumeroPeriodoLetivo(matriculaVO.getUltimoMatriculaPeriodoVO().getPeridoLetivo().getPeriodoLetivo());
							mensagemRestricaoPeriodosLetivosRenovacao = "Aluno estão reprovado em mais disciplinas que o permitido (" + configuracaoAcademicoVO.getNumeroDisciplinaConsiderarReprovadoPeriodoLetivo() + "). O mesmo será mantido (Renovado) no mesmo Período letivo em que foi reprovado!";
						} else {
							Integer nrPeriodoAtual = ultimoPeriodoMatriculaPeriodo.getPeriodoLetivo().getPeriodoLetivo();
							Integer nrProximoPeriodo = matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().obterNumeroProximoPeriodo(nrPeriodoAtual);
							periodoLetivoSugeridoParaMatricula = matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().consultarObjPeriodoLetivoVOPorNumeroPeriodoLetivo(nrProximoPeriodo);
						}
					}
				} else {
					// Este ï¿½ o padrao do SEI, caso nenhum configuracao seja
					// definida. ou seja o SEI
					// irá sugerir a evolução com base no
					// periodoLetivoEvolucaoAcademica, mas, todos os demais
					// seráo listados para que o usuário escolha o que julga
					// melhor.
					periodoLetivoSugeridoParaMatricula = periodoLetivoRefleteEvolucaoAcademicaAluno;
				}
			}
		}

		if (matriculaPeriodoVO.getIsNovaMatriculaPeriodo()  && !realizandoNovaMatriculaAlunoPartindoTransferenciaInterna) {
			// Caso seja uma nova MatriculaPeriodo iremos setar o
			// periodoLetivoSugerido para
			// a matriculaPeriodo, caso seja uma alteração, temos que preservar
			// o dados selecionado
			// anteriormenete pelo usuário. Mas esta informação de Período
			// sugerido será utilizado
			// para definir a lista de possível periodos letivos que o usuário
			// poderá selecionar
			// para o aluno.
			matriculaPeriodoVO.setPeridoLetivo(periodoLetivoSugeridoParaMatricula);
		}
		matriculaPeriodoVO.setMensagemRestricaoPeriodosLetivosRenovacao(mensagemRestricaoPeriodosLetivosRenovacao);

		List<PeriodoLetivoVO> listaPeriodosLetivosParaComboBox = new ArrayList<PeriodoLetivoVO>();
		if (!matriculaPeriodoVO.getIsNovaMatriculaPeriodo() || ( realizandoNovaMatriculaAlunoPartindoTransferenciaInterna)) {
			adicionarPeriodoLetivoListaPeriodoLetivoValido(listaPeriodosLetivosParaComboBox, matriculaPeriodoVO.getPeriodoLetivo());
		}
		if (configuracaoAcademicoVO.getRenovacaoMatriculaSequencial()) {
			if (matriculaVO.getLiberarMatriculaTodosPeriodos()) {
				for (PeriodoLetivoVO periodo : matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPeriodoLetivosVOs()) {
					adicionarPeriodoLetivoListaPeriodoLetivoValido(listaPeriodosLetivosParaComboBox, periodo);
				}
			} else if(!realizandoNovaMatriculaAlunoPartindoTransferenciaInterna) {
				adicionarPeriodoLetivoListaPeriodoLetivoValido(listaPeriodosLetivosParaComboBox, periodoLetivoSugeridoParaMatricula);
			}
		} else {
			if (configuracaoAcademicoVO.getControlarAvancoPeriodoPorCreditoOuCH()) {
				for (PeriodoLetivoVO periodo : matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPeriodoLetivosVOs()) {
					if ((matriculaVO.getLiberarMatriculaTodosPeriodos()) || (periodo.getPeriodoLetivo().compareTo(periodoLetivoSugeridoParaMatricula.getPeriodoLetivo()) <= 0)) {
						adicionarPeriodoLetivoListaPeriodoLetivoValido(listaPeriodosLetivosParaComboBox, periodo);
					}
				}
			} else {
				if ((!configuracaoAcademicoVO.getPermiteEvoluirPeriodoLetivoCasoReprovado()) && (configuracaoAcademicoVO.getNumeroDisciplinaConsiderarReprovadoPeriodoLetivo() > 0) && (!alunoAptoAvancarProximoPeriodo)) {
					for (PeriodoLetivoVO periodo : matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPeriodoLetivosVOs()) {
						if ((matriculaVO.getLiberarMatriculaTodosPeriodos()) || (periodo.getPeriodoLetivo().compareTo(periodoLetivoSugeridoParaMatricula.getPeriodoLetivo()) <= 0)) {
							adicionarPeriodoLetivoListaPeriodoLetivoValido(listaPeriodosLetivosParaComboBox, periodo);
						}
					}
				} else {
					// Este ï¿½ o padrao do SEI, caso nenhum configuracao seja
					// definida. ou seja o SEI
					// irá sugerir a evolução com base no
					// periodoLetivoEvolucaoAcademica, mas, todos os demais
					// seráo listados para que o usuário escolha o que julga
					// melhor.
					for (PeriodoLetivoVO periodo : matriculaComHistoricoAlunoVO.getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPeriodoLetivosVOs()) {
						adicionarPeriodoLetivoListaPeriodoLetivoValido(listaPeriodosLetivosParaComboBox, periodo);
					}
				}
			}
		}
		matriculaPeriodoVO.setListaPeriodosLetivosValidosParaMatriculaPeriodo(listaPeriodosLetivosParaComboBox);

		return listaPeriodosLetivosParaComboBox;
	}

	/**
	 * Método Responsável por calcular a quantidade de horas/creditos um aluno
	 * cursou até um determinado Período letivo. Esta informação será utilizada
	 * pelo SEI no controle da quantidade de disciplinas que o aluno pode
	 * incluir em uma renovação. Pois, caso o aluno esteja devendo
	 * horas/creditos de periodos anteriores (se comparado ao que foi definido
	 * na matriz) entao o aluno, poderá incluir mais disciplinas em sua
	 * renovacao dentro do que foi configurado.
	 * 
	 * @deprecated na versao 5.0
	 */
	public void calcularTotalCHCreditoAlunoCursouAteDeterminadoPeriodo(PeriodoLetivoVO periodoFinalCalcular, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception {
		Integer totalCargaHoraria = 0;
		Integer totalCreditos = 0;
		for (PeriodoLetivoVO periodo : matriculaPeriodoVO.getGradeCurricular().getPeriodoLetivosVOs()) {
			if (periodo.getPeriodoLetivo().compareTo(periodoFinalCalcular.getPeriodoLetivo()) <= 0) {
				periodo.atualizarTotalCargaHoraria();
				periodo.atualizarTotalCredito();
				totalCargaHoraria += periodo.getTotalCargaHoraria();
				totalCreditos += periodo.getTotalCreditos();
			} else {
				break;
			}
		}
		matriculaPeriodoVO.setTotalCargaHorariaAlunoAtePeriodoAnterior(totalCargaHoraria - 10);
		matriculaPeriodoVO.setTotalCreditoAlunoAtePeriodoAnterior(totalCreditos - 1);
	}

	/*
	 * Método Responsável por calcular a quantidade de horas e creditos que
	 * estãoo planejados na matriz curricular do aluno, até um determinado
	 * periodo letivo. Este dado ï¿½ utilizado no controle de inclusao de
	 * disciplinas
	 * 
	 * @deprecated 5.0
	 */
	public void calcularTotalCHCreditoMatrizAteDeterminadoPeriodo(PeriodoLetivoVO periodoFinalCalcular, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception {
		Integer totalCargaHoraria = 0;
		Integer totalCreditos = 0;
		for (PeriodoLetivoVO periodo : matriculaPeriodoVO.getGradeCurricular().getPeriodoLetivosVOs()) {
			if (periodo.getPeriodoLetivo().compareTo(periodoFinalCalcular.getPeriodoLetivo()) <= 0) {
				periodo.atualizarTotalCargaHoraria();
				periodo.atualizarTotalCredito();
				totalCargaHoraria += periodo.getTotalCargaHoraria();
				totalCreditos += periodo.getTotalCreditos();
			} else {
				break;
			}
		}
		matriculaPeriodoVO.setTotalCargaHorariaPadraoAtePeriodoAnterior(totalCargaHoraria);
		matriculaPeriodoVO.setTotalCreditoPadraoAtePeriodoAnterior(totalCreditos);
	}

	/**
	 * Método Responsável por validar se um aluno pode estudar disciplinas por
	 * meio de um determinado mapa de equivalencia. Para que isto seja possível,
	 * ï¿½ necessário que nenhuma das disciplinas da matriz curricular
	 * vinculadas ao mapa, já tenham um histórico (historicoVO) de aprovação e
	 * também o aluno não pode estar cursando nenhum destas disciplinas,
	 * atualmente, em outros Períodos. Esta rotina depende do objeto
	 * MatriculaComHistoricoAlunoVO devidamente montado.
	 * 
	 * @param matriculaVO
	 * @param matriculaPeriodoVO
	 * @param mapa
	 * @throws Exception
	 */
	public Boolean validarAlunoPodeCursarDisciplinaPorMapaEquivalencia(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MapaEquivalenciaDisciplinaVO mapa, Boolean retornarExcecao) throws Exception {
		for (MapaEquivalenciaDisciplinaMatrizCurricularVO disciplinaDaMatrizMapa : mapa.getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {
			HistoricoVO hist = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().verificarAlunoAprovadoDisciplina(disciplinaDaMatrizMapa.getDisciplinaVO().getCodigo());
			if (hist != null) {
				if(retornarExcecao) {
					throw new Exception("Mapa de Equivalência não pode ser utilizado pois o aluno já foi aprovado na disciplina " + hist.getDisciplina().getCodigo() + " - " + hist.getDisciplina().getNome() + " de sua Matriz Curricular. E este Mapa tenta inferir uma nova situação acadêmica para esta disciplina.");
				}
				return false;
			}
			hist = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().verificarAlunoCursandoDisciplina(disciplinaDaMatrizMapa.getDisciplinaVO().getCodigo());			
			if (hist != null && (!matriculaVO.getCurso().getIntegral() || (matriculaVO.getCurso().getIntegral() && hist.getCursando()))) {
				if(retornarExcecao) {
					throw new Exception("Mapa de Equivalência não pode ser utilizado pois o aluno está atualmente cursando a disciplina " + hist.getDisciplina().getCodigo() + " - " + hist.getDisciplina().getNome() + " de sua Matriz Curricular. E este Mapa tenta inferir uma nova situação acadêmica para esta disciplina.");
				}
				return false;
			}
			for (MatriculaPeriodoTurmaDisciplinaVO matPeriodo : matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()) {
				if (matPeriodo.getDisciplina().getCodigo().equals(disciplinaDaMatrizMapa.getDisciplinaVO().getCodigo())) {
					if (matriculaVO.getCurso().getIntegral() && Uteis.isAtributoPreenchido(matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().verificarAlunoReprovadoDisciplina(disciplinaDaMatrizMapa.getDisciplinaVO().getCodigo()))) {
						return true;
					}
					if(retornarExcecao) {
						throw new Exception("Mapa de Equivalência não pode ser utilizado pois o aluno está atualmente cursando a disciplina " + matPeriodo.getDisciplina().getCodigo() + " - " + matPeriodo.getDisciplina().getNome() + " de sua Matriz Curricular neste Período. E este Mapa tenta inferir uma nova situação acadêmica para esta disciplina.");
					}
					return false;
				}
			}
			if (validarExistenciaDisciplinaMapaEquivalenciaMatriculaPeriodoTurmaDisciplinaVOs(disciplinaDaMatrizMapa.getDisciplinaVO(), matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs())) {
				if(retornarExcecao) {
					throw new Exception("Mapa de Equivalência não pode ser utilizado pois o aluno está atualmente cursando a disciplina " + disciplinaDaMatrizMapa.getDisciplinaVO().getCodigo() + " - " + disciplinaDaMatrizMapa.getDisciplinaVO().getNome() + " de sua Matriz Curricular neste Período, por meio de equivalência. E este Mapa tenta inferir uma nova situação acadêmica para esta disciplina.");
				}
				return false;
			}
		}
		return true;
	}

	/**
	 * Utilizar adicionarEValidarMatriculaPeriodoTurmaDisciplinaVO
	 * 
	 * @param matriculaPeriodo
	 * @param matriculaVO
	 * @param turma
	 * @param disciplina
	 * @param equivale
	 * @param permitirRealizarMatriculaDisciplinaPreRequisito
	 * @param listaMatriculaPeriodoTurmaDisciplinaRemovidaTemporariamenteVOs
	 * @param configuracaoAcademicoVO
	 * @param usuario
	 * @throws Exception
	 * @deprecated em 04/04/14 - versao 4.5
	 */
	public void adicionarMatriculaPeriodoTurmaDisciplinaVO(MatriculaPeriodoVO matriculaPeriodo, MatriculaVO matriculaVO, TurmaVO turma, DisciplinaVO disciplina, DisciplinaVO equivale, Boolean permitirRealizarMatriculaDisciplinaPreRequisito, List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinaRemovidaTemporariamenteVOs, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuario) throws Exception {
		throw new UnsupportedOperationException("Not supported yet.");
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoMatriculaPeriodoFormada(final MatriculaVO obj, final String situacao, UsuarioVO usuarioVO) throws Exception {
		try {
			final StringBuilder sql = new StringBuilder(" UPDATE MatriculaPeriodo set situacaomatriculaperiodo = ?, origemfechamentomatriculaperiodo = '"+OrigemFechamentoMatriculaPeriodoEnum.FORMATURA.toString()+"',  datafechamentomatriculaperiodo = current_date ");
			sql.append(" WHERE codigo = (select mp.codigo from matriculaperiodo mp where mp.matricula = ? and mp.situacaoMatriculaPeriodo != 'PC'  order by (mp.ano || '/' || mp.semestre) desc, case when mp.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, mp.codigo desc limit 1 ) ").append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql.toString());
					sqlAlterar.setString(1, situacao);
					sqlAlterar.setString(2, obj.getMatricula());
					return sqlAlterar;
				}
			});
		} finally {
		}
	}

	public List<MapaAlunoAptoFormarVO> consultarMapaAlunoAptoFormar(String matricula, Integer curso, Integer turma , String situacaoCurricular) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("select matriculaperiodo.codigo, matricula.matricula,matricula.situacao, pessoa.nome as aluno, turma.identificadorturma, curso.nome as curso, matricula.tipomatricula, ");
		sb.append(" (select min(data) from horarioturmadia inner join horarioturma on horarioturma.codigo = horarioturmadia.horarioturma where horarioturma.turma = turma.codigo) as dataInicioAula, ");
		sb.append(" (select max(data) from horarioturmadia inner join horarioturma on horarioturma.codigo = horarioturmadia.horarioturma where horarioturma.turma = turma.codigo) as dataFinalAula, ");
		sb.append(" (select count(codigo) from turmadisciplina where turmadisciplina.turma = turma.codigo) as qtdDisc, ");
		sb.append(" (select count(codigo) from historico where  historico.matriculaperiodo = matriculaperiodo.codigo and historico.matrizcurricular = gradecurricularatual and (historico.historicoequivalente = false or historico.historicoequivalente is null) and historico.situacao in ('AA', 'IS', 'CC', 'CH', 'AP', 'AE', 'CE', 'CO', 'AD', 'AB')) as qtdDiscCursada , matricula.gradecurricularatual ");
		sb.append(" from matriculaperiodo inner join matricula on matricula.matricula = matriculaperiodo.matricula ");
		sb.append(" inner join pessoa on pessoa.codigo = matricula.aluno inner join turma on turma.codigo = matriculaperiodo.turma ");
		sb.append(" inner join curso on curso.codigo = matricula.curso where curso.periodicidade = 'IN' ");
		if (turma > 0) {
			sb.append(" and matriculaperiodo.turma = ").append(turma);
		}
		if (curso > 0) {
			sb.append(" and matricula.curso = ").append(curso);
		}
		if (!matricula.equals("")) {
			sb.append(" and matriculaperiodo.matricula =  '").append(matricula).append("'");
		}
		sb.append(" order by pessoa.nome, matricula.matricula");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<MapaAlunoAptoFormarVO> listaMatriculaPeriodoVOs = new ArrayList<MapaAlunoAptoFormarVO>(0);
		while (tabelaResultado.next()) {
			MapaAlunoAptoFormarVO obj = new MapaAlunoAptoFormarVO();
			obj.setSituacao(tabelaResultado.getString("tipomatricula"));
			obj.getMatriculaPeriodo().getMatriculaVO().getCurso().setNome(tabelaResultado.getString("curso"));
			obj.getMatriculaPeriodo().getMatriculaVO().getAluno().setNome(tabelaResultado.getString("aluno"));
			obj.getMatriculaPeriodo().getMatriculaVO().setMatricula(tabelaResultado.getString("matricula"));
			obj.getMatriculaPeriodo().getTurma().setIdentificadorTurma(tabelaResultado.getString("identificadorturma"));
			obj.setDataAulaIni(tabelaResultado.getDate("datainicioaula"));
			obj.setDataAulaFim(tabelaResultado.getDate("datafinalaula"));
			obj.setQtdeDisc(tabelaResultado.getInt("qtddisc"));
			obj.setQtdeDiscCursada(tabelaResultado.getInt("qtddisccursada"));
			obj.setSituacao(tabelaResultado.getString("situacao"));
			obj.getMatriculaPeriodo().getMatriculaVO().getGradeCurricularAtual().setCodigo(tabelaResultado.getInt("gradecurricularatual"));
			if (situacaoCurricular.equals("IN")) {
				if (getFacadeFactory().getMatriculaFacade().isMatriculaIntegralizada(obj.getMatriculaPeriodo().getMatriculaVO(), obj.getMatriculaPeriodo().getMatriculaVO().getGradeCurricularAtual().getCodigo() , null, null)) {
				listaMatriculaPeriodoVOs.add(obj);
				}
			}else if(situacaoCurricular.equals("NI")) {
				if (!getFacadeFactory().getMatriculaFacade().isMatriculaIntegralizada(obj.getMatriculaPeriodo().getMatriculaVO(), obj.getMatriculaPeriodo().getMatriculaVO().getGradeCurricularAtual().getCodigo(), null, null)) {
					listaMatriculaPeriodoVOs.add(obj);
				}
			}
			else {
				listaMatriculaPeriodoVOs.add(obj);
			}
		}
		return listaMatriculaPeriodoVOs;
	}

	public MatriculaPeriodoVO consultarMatriculaPeriodoRenovadaVisaoAlunoPorSituacaoUnidadeEnsinoCursoTurnoSituacaoPeriodoLetivoAtivoUnidadeEnsinoCurso(Integer turno, Integer curso, Integer unidadeEnsino, String situacaoPeriodoLetivoAtivoUnidadeEnsinoCurso, String situacao, boolean visaoAluno, boolean controlarAcesso, int nivelMontarDados, String matricula, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append(" select codigo, matricula, situacao, situacaoMatriculaPeriodo from matriculaperiodo where matricula = '").append(matricula).append("' ");
		/**
		 * Comentado clausula and devido ao ser efetuado a renovacao na visao
		 * administrativa seja possivel o aluno altera-la atraves de sua visao
		 * ja que na visao administrativa nao e marcado o termo de aceite.
		 */
		// sql.append(" and aceitoutermocontratorenovacaoonline ");
		sql.append(" and situacaomatriculaperiodo <> 'PC' ");
		sql.append(" and processomatricula in( ");
		sql.append(" SELECT Distinct ProcessoMatricula.codigo ");
		sql.append(" FROM ProcessoMatricula ");
		sql.append(" inner JOIN ProcessoMatriculaUnidadeEnsino ON ProcessoMatriculaUnidadeEnsino.ProcessoMatricula = ProcessoMatricula.codigo and ProcessoMatriculaUnidadeEnsino.unidadeEnsino =  ").append(unidadeEnsino);
		sql.append(" INNER JOIN ProcessoMatriculaCalendario pmc ON pmc.processomatricula = processomatricula.codigo and  pmc.curso = ").append(curso).append(" and turno = ").append(turno);
		sql.append(" INNER JOIN UnidadeEnsinoCurso uec ON uec.unidadeEnsino = ProcessoMatriculaUnidadeEnsino.unidadeEnsino and uec.turno = pmc.turno and uec.curso = pmc.curso ");
		sql.append(" INNER jOIN periodoLetivoAtivoUnidadeEnsinoCurso plauec ON plauec.codigo = pmc.periodoLetivoAtivoUnidadeEnsinoCurso ");
		sql.append(" WHERE uec.turno = ").append(turno).append(" AND uec.curso = ").append(curso).append(" AND uec.unidadeEnsino = ").append(unidadeEnsino).append(" ");
		sql.append(" AND plauec.situacao = '").append(situacaoPeriodoLetivoAtivoUnidadeEnsinoCurso).append("' ");
		if (visaoAluno) {
			sql.append(" AND ProcessoMatricula.apresentarProcessoVisaoAluno = true AND ((dataInicioMatriculaOnline <= current_date AND dataFimMatriculaOnline >= current_date) or (pmc.dataInicioInclusaoDisciplina  <= current_date and pmc.dataFinalInclusaoDisciplina  >= current_date)) ");
			sql.append(" AND CASE WHEN ProcessoMatricula.bloquearAlunosPossuemConvenioRenovacaoOnline = true then  ");
			sql.append(" CASE WHEN (select planofinanceiroaluno.codigo from planofinanceiroaluno ");
			sql.append(" inner join itemplanofinanceiroaluno on itemplanofinanceiroaluno.planofinanceiroaluno = planofinanceiroaluno.codigo ");
			sql.append(" where itemplanofinanceiroaluno.tipoitemplanofinanceiro = 'CO' ");
			sql.append(" and matriculaperiodo in(select matriculaperiodo.codigo from matriculaperiodo ");
			sql.append(" inner join periodoletivo on periodoletivo.codigo = matriculaperiodo.periodoletivomatricula ");
			sql.append(" where matricula = '").append(matricula).append("' ");
			sql.append(" order by (MatriculaPeriodo.ano||'/'||MatriculaPeriodo.semestre) desc, periodoletivo.periodoletivo desc, MatriculaPeriodo.codigo desc limit 1 ");
			sql.append(" ) limit 1) > 0 THEN false else true END else true END ");
		}
		if (situacao.equals("PR_AT")) { // Neste caso, temos que montar os
			// processos de matrícula ativos para
			// matrícula e para pré-matrícula
			sql.append(" AND ((ProcessoMatricula.situacao = 'PR') OR (ProcessoMatricula.situacao = 'AT'))");
		} else {
			sql.append(" AND ProcessoMatricula.situacao = '").append(situacao).append("' ");
		}
		sql.append(") ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		MatriculaPeriodoVO obj = null;
		if (tabelaResultado.next()) {
			obj = new MatriculaPeriodoVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getMatriculaVO().setMatricula(tabelaResultado.getString("matricula"));
			obj.setMatricula(tabelaResultado.getString("matricula"));
			obj.setSituacao(tabelaResultado.getString("situacao"));
			obj.setSituacaoMatriculaPeriodo(tabelaResultado.getString("situacaoMatriculaPeriodo"));
		}
		return obj;
	}

	/**
	 * Monta a lista de Grade Disciplina Composta com base na matricula periodo
	 * turma disciplina onde, se a matriculaperiodoturmadisciplina já estiver
	 * gravada então irá montar apenas as GradeDisciplinaCompostaVO na qual
	 * exista uma matriculaperiodoturmadisciplina que referencia a grade de
	 * disciplina composta se a matriculaperiodoturmadisciplina não estiver
	 * gravada então irá montar apenas as GradeDisciplinaCompostaVO com base na
	 * origem da mesma (GradeDisciplinaVO ou GrupoOptativas)
	 */
	@Override
	public List<GradeDisciplinaCompostaVO> realizarObtencaoMatriculaPeriodoTurmaDisciplinaFazParteComposicao(MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO, MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		List<GradeDisciplinaCompostaVO> gradeDisciplinaCompostaVOs = new ArrayList<GradeDisciplinaCompostaVO>(0);
		if (matriculaPeriodoTurmaDisciplinaVO.getDisciplinaComposta()) {
			if (matriculaPeriodoTurmaDisciplinaVO.getDisciplinaReferenteAUmGrupoOptativa() && matriculaPeriodoTurmaDisciplinaVO.getGradeCurricularGrupoOptativaDisciplinaVO().getGradeDisciplinaCompostaVOs().isEmpty()) {
				GradeCurricularGrupoOptativaDisciplinaVO gradeCurricularGrupoOptativaDisciplinaVO = getFacadeFactory().getGradeCurricularGrupoOptativaDisciplinaFacade().consultarPorChavePrimaria(matriculaPeriodoTurmaDisciplinaVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo(), null);
				matriculaPeriodoTurmaDisciplinaVO.setGradeCurricularGrupoOptativaDisciplinaVO(gradeCurricularGrupoOptativaDisciplinaVO);
			} else if (matriculaPeriodoTurmaDisciplinaVO.getGradeDisciplinaVO().getCodigo() > 0 && matriculaPeriodoTurmaDisciplinaVO.getGradeDisciplinaVO().getGradeDisciplinaCompostaVOs().isEmpty()) {
				GradeDisciplinaVO gradeDisciplinaVO = getFacadeFactory().getGradeDisciplinaFacade().consultarPorChavePrimaria(matriculaPeriodoTurmaDisciplinaVO.getGradeDisciplinaVO().getCodigo(), null);
				matriculaPeriodoTurmaDisciplinaVO.setGradeDisciplinaVO(gradeDisciplinaVO);
			}
			List<GradeDisciplinaCompostaVO> compostas = new ArrayList<GradeDisciplinaCompostaVO>(0);
			List<TurmaDisciplinaCompostaVO> turmaDisciplinaCompostaVOs = getFacadeFactory().getTurmaDisciplinaCompostaFacade().consultarPorTurma(matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, false, null);
			// boolean estudarQuantidadeMaximaComposta =
			// TipoControleComposicaoEnum.ESTUDAR_QUANTIDADE_MAXIMA_COMPOSTA.equals(matriculaPeriodoTurmaDisciplinaVO.getGradeDisciplinaVO().getTipoControleComposicao());
			// if (Uteis.isAtributoPreenchido(turmaDisciplinaCompostaVOs) &&
			// estudarQuantidadeMaximaComposta) {
			// for (TurmaDisciplinaCompostaVO tdc : turmaDisciplinaCompostaVOs)
			// {
			// compostas.add(tdc.getGradeDisciplinaCompostaVO());
			// }
			// } else {
			compostas = matriculaPeriodoTurmaDisciplinaVO.getDisciplinaReferenteAUmGrupoOptativa() ? matriculaPeriodoTurmaDisciplinaVO.getGradeCurricularGrupoOptativaDisciplinaVO().getGradeDisciplinaCompostaVOs() : matriculaPeriodoTurmaDisciplinaVO.getGradeDisciplinaVO().getGradeDisciplinaCompostaVOs();
			// }
			// for (GradeDisciplinaCompostaVO disciplinaCompostaVO : compostas)
			// {
			// if (matriculaPeriodoTurmaDisciplinaVO.getCodigo() > 0) {
			// for (MatriculaPeriodoTurmaDisciplinaVO mptdVO :
			// matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()) {
			// if
			// (mptdVO.getGradeDisciplinaCompostaVO().getCodigo().equals(disciplinaCompostaVO.getCodigo()))
			// {
			// gradeDisciplinaCompostaVOs.add(disciplinaCompostaVO);
			//
			// }
			// }
			// } else {
			// gradeDisciplinaCompostaVOs.add(disciplinaCompostaVO);
			// }
			// }
			Boolean existeComposicao = false;
			for (GradeDisciplinaCompostaVO disciplinaCompostaVO : compostas) {
				existeComposicao = false;
				for (MatriculaPeriodoTurmaDisciplinaVO mptdVO : matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()) {
					if (mptdVO.getGradeDisciplinaCompostaVO().getCodigo().equals(disciplinaCompostaVO.getCodigo())) {
						disciplinaCompostaVO.setMatriculaPeriodoTurmaDisciplinaVO(mptdVO);
						gradeDisciplinaCompostaVOs.add(disciplinaCompostaVO);
						existeComposicao = true;
						break;
					}
				}
				if (!existeComposicao) {
					gradeDisciplinaCompostaVOs.add(disciplinaCompostaVO);
				}
			}
		}
		return gradeDisciplinaCompostaVOs;
	}

	public MatriculaPeriodoVO consultarDadosCompletosMatriculaPeriodoPorMatriculaAnoSemestre(String matricula, String ano, String semestre, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("SELECT codigo FROM matriculaPeriodo ");
		sb.append(" WHERE matricula = '").append(matricula).append("' ");
		if (!ano.equals("")) {
			sb.append("AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sb.append("AND matriculaperiodo.semestre = '").append(semestre).append("' ");
		}
		sb.append(" and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sb.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc limit 1 ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
		if (!tabelaResultado.next()) {
			throw new Exception("Aluno não matriculado nesse ano e semestre.");
		}
		obj.setCodigo(tabelaResultado.getInt("codigo"));
		carregarDados(obj, NivelMontarDados.TODOS, configuracaoFinanceiroVO, usuarioVO);
		return obj;
	}

	@Override
	public List<MatriculaPeriodoVO> executarValidacaoParaExcluirMatriculasPeriodoPreMatriculadas(List<MatriculaPeriodoVO> listaPreMatriculados, ConfiguracaoFinanceiroVO configuracaoFinanceiro, ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO,  UsuarioVO usuario) throws Exception {
		List<MatriculaPeriodoVO> listaMatriculaPeriodoQueNaoPodemSeremExcluidas = new ArrayList<MatriculaPeriodoVO>(0);
		Iterator i = listaPreMatriculados.iterator();
		boolean entrou = false;
		while (i.hasNext()) {
			MatriculaPeriodoVO m = (MatriculaPeriodoVO) i.next();
			if (m.getSelecionarMatriculaPeriodoRenovar()) {
				entrou = true;
				try {
					boolean existeContaReceberRecebidaOuNegociada = getFacadeFactory().getContaReceberFacade().consultarExistenciaContaReceberRecebidaOuNegociadaPorMatriculaPeriodo(m.getCodigo());
					if (existeContaReceberRecebidaOuNegociada) {
						listaMatriculaPeriodoQueNaoPodemSeremExcluidas.add(m);
					}
				} catch (Exception e) {
					throw e;
				}
			}
		}
		if (!entrou) {
			throw new Exception("Deve ser selecionado ao menos um aluno para realizar a operação!");
		}
		if (listaMatriculaPeriodoQueNaoPodemSeremExcluidas.isEmpty()) {
			executarExclusaoMatriculasPeriodoPreMatriculadas(listaPreMatriculados, configuracaoFinanceiro, configuracaoGeralSistemaVO, usuario);
		}
		return listaMatriculaPeriodoQueNaoPodemSeremExcluidas;
	}

	@Override
	public List<MatriculaPeriodoVO> executarExclusaoMatriculasPeriodoPreMatriculadas(List<MatriculaPeriodoVO> listaPreMatriculados, ConfiguracaoFinanceiroVO configuracaoFinanceiro, ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO,  UsuarioVO usuario) throws Exception {
		Iterator i = listaPreMatriculados.iterator();
		while (i.hasNext()) {
			MatriculaPeriodoVO m = (MatriculaPeriodoVO) i.next();
			if (m.getSelecionarMatriculaPeriodoRenovar()) {
				executarExclusaoPreMatricula(m, configuracaoFinanceiro, configuracaoGeralSistemaVO, new ArrayList<MatriculaPeriodoVO>(0), usuario);
				if (!m.getErro()) {
					i.remove();
				}
			}
		}
		return listaPreMatriculados;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void executarExclusaoPreMatricula(MatriculaPeriodoVO matriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, ConfiguracaoGeralSistemaVO configuracaoGeralSistemaVO,  List<MatriculaPeriodoVO> listaPreMatriculados, UsuarioVO usuario) throws Exception {
		try {
			boolean existeContaReceberRecebidaOuNegociada = getFacadeFactory().getContaReceberFacade().consultarExistenciaContaReceberRecebidaOuNegociadaPorMatriculaPeriodo(matriculaPeriodo.getCodigo());
			boolean existeTransferenciaMatrizCurricular = getFacadeFactory().getTransferenciaMatrizCurricularFacade().executarVerificarMatriculaPeriodoPossuiTransferenciaMatrizCurricularExclusaoPreMatricula(matriculaPeriodo.getCodigo(), false, usuario);
			boolean existeMatriculaPeriodoRenovadaAposMatriculaPeriodoEspecifica = executarVerificacaoExisteMatriculaPeriodoRenovadaAposMatriculaPeriodoEspecifica(matriculaPeriodo.getCodigo(), false, usuario);
			if (existeContaReceberRecebidaOuNegociada) {
				throw new Exception(UteisJSF.internacionalizar("msg_ConfirmacaoPreMatricula_preMatriculaComParcelaPaga"));
			} else if (existeTransferenciaMatrizCurricular && !existeMatriculaPeriodoRenovadaAposMatriculaPeriodoEspecifica) {
				throw new Exception(UteisJSF.internacionalizar("msg_ConfirmacaoPreMatricula_preMatriculaComTranferenciaMatrizCurricular"));
			} else if (existeMatriculaPeriodoRenovadaAposMatriculaPeriodoEspecifica) {
				throw new Exception(UteisJSF.internacionalizar("msg_ConfirmacaoPreMatricula_preMatriculaComNovaMatriculaPeriodoRenovada"));
			} else {
				getFacadeFactory().getMatriculaFacade().excluirPreMatriculaERegistrosRelacionados(matriculaPeriodo, "Exclusão pré-Matrícula", configuracaoFinanceiroVO, configuracaoGeralSistemaVO, usuario);
				listaPreMatriculados.remove(matriculaPeriodo);
			}
		} catch (Exception e) {
			matriculaPeriodo.setErro(true);
			matriculaPeriodo.setMensagemErro(e.getMessage());
		} finally {
			matriculaPeriodo.setApresentarSituacao(true);
		}
	}

	@Override
	public void verificarOrdemEQtdeEstudandoMatriculaPeriodo(Integer codigoMatriculaPeriodo, Map<String, Integer> auxiliar) throws Exception {
		StringBuilder sqlStr = new StringBuilder();

		sqlStr.append(" select max(case when calendarioatividadematricula.codigo is not null then turmadisciplina.ordemestudoonline else 0 end) ordemestudoatual, count(calendarioatividadematricula.matriculaperiodoturmadisciplina) as qtdeestudando,");
		sqlStr.append(" min(turmadisciplina.ordemestudoonline) primeiraordemestudo, (");
		sqlStr.append(" select td.ordemestudoonline from matriculaperiodoturmadisciplina mptd");
		sqlStr.append(" inner join turmadisciplina td on td.turma = mptd.turma");
		sqlStr.append(" and td.disciplina = mptd.disciplina");
		sqlStr.append(" left join calendarioatividadematricula cam on cam.matriculaperiodoturmadisciplina = mptd.codigo");
		sqlStr.append(" and cam.tipocalendarioatividade = 'ACESSO_CONTEUDO_ESTUDO'");
		sqlStr.append(" where mptd.matriculaperiodo = ").append(codigoMatriculaPeriodo).append(" and cam.codigo is null");
		sqlStr.append(" order by td.ordemestudoonline limit 1");
		sqlStr.append(" ) as proximaordem");
		sqlStr.append(" from matriculaperiodoturmadisciplina");
		sqlStr.append(" inner join turmadisciplina on turmadisciplina.turma = matriculaperiodoturmadisciplina.turma");
		sqlStr.append(" and turmadisciplina.disciplina = matriculaperiodoturmadisciplina.disciplina");
		sqlStr.append(" left join calendarioatividadematricula on calendarioatividadematricula.matriculaperiodoturmadisciplina = matriculaperiodoturmadisciplina.codigo");
		sqlStr.append(" and calendarioatividadematricula.tipocalendarioatividade = 'ACESSO_CONTEUDO_ESTUDO' ").append(" and calendarioatividadematricula.datafim >= ").append("'" + Uteis.getDataJDBC(new Date())+ "'");
		sqlStr.append(" where matriculaperiodoturmadisciplina.matriculaperiodo = ").append(codigoMatriculaPeriodo);

		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());

		if (rs.next()) {
			auxiliar.put("ordemestudo", rs.getInt("ordemestudoatual"));
			auxiliar.put("qtdeestudando", rs.getInt("qtdeestudando"));
			auxiliar.put("primeiraordemestudo", rs.getInt("primeiraordemestudo"));
			auxiliar.put("proximaordem", rs.getInt("proximaordem"));
		}
	}

	@Override
	public Date realizarConsultaDataParcelaMatricula(Integer codigoMatriculaPeriodo) throws Exception {
		StringBuilder sqlStr = new StringBuilder();

		sqlStr.append(" select max(data) from (");
		// possuem matricula recebida
		sqlStr.append(" select negociacaorecebimento.data as data");
		sqlStr.append(" from matriculaperiodo");
		sqlStr.append(" inner join contareceber on matriculaperiodo.codigo = contareceber.matriculaperiodo");
		sqlStr.append(" and contareceber.tipoorigem in ('MAT') and contareceber.situacao = 'RE'");
		sqlStr.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.contareceber = contareceber.codigo");
		sqlStr.append(" inner join negociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo");
		sqlStr.append(" where matriculaperiodo.codigo = ").append(codigoMatriculaPeriodo);
		sqlStr.append(" union");
		// possuem matricula renegociada
		sqlStr.append(" select");
		sqlStr.append(" case when negociacaocontareceber.liberarrenovacaoapospagamentotodasparcelas then");
		sqlStr.append(" (select max(negociacaorecebimento.data) from contareceber");
		sqlStr.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.contareceber = contareceber.codigo");
		sqlStr.append(" inner join negociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo )");
		sqlStr.append(" else case when negociacaocontareceber.liberarrenovacaoapospagamentoprimeiraparcela then");
		sqlStr.append(" (select min(negociacaorecebimento.data) from contareceber");
		sqlStr.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.contareceber = contareceber.codigo");
		sqlStr.append(" inner join negociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo");
		sqlStr.append(" where  contareceber.tipoOrigem = 'NCR' and contareceber.codorigem::INT = negociacaocontareceber.codigo )");
		sqlStr.append(" else negociacaocontareceber.data end end as data");
		sqlStr.append(" from matriculaperiodo");
		sqlStr.append(" inner join contareceber on matriculaperiodo.codigo = contareceber.matriculaperiodo");
		sqlStr.append(" and contareceber.tipoorigem in ('MAT') and contareceber.situacao = 'NE'");
		sqlStr.append(" inner join contarecebernegociado on contarecebernegociado.contareceber = contareceber.codigo");
		sqlStr.append(" inner join negociacaocontareceber on contarecebernegociado.negociacaocontareceber = negociacaocontareceber.codigo");
		sqlStr.append(" where matriculaperiodo.codigo = ").append(codigoMatriculaPeriodo + " and");
		sqlStr.append(" case when negociacaocontareceber.liberarrenovacaoapospagamentotodasparcelas then");
		sqlStr.append(" (select codigo from contareceber where  contareceber.tipoOrigem = 'NCR' and contareceber.codorigem::INT = negociacaocontareceber.codigo and situacao = 'AR' ) is null");
		sqlStr.append(" else case when negociacaocontareceber.liberarrenovacaoapospagamentoprimeiraparcela then");
		sqlStr.append(" (select codigo from contareceber where  contareceber.tipoOrigem = 'NCR' and contareceber.codorigem::INT = negociacaocontareceber.codigo and situacao = 'RE' limit 1 ) is not null");
		sqlStr.append(" else true end end");
		sqlStr.append(" union");
		// Não possuem parcela de matricula entao deve verificar a existencia
		// de uma mensalidade recebida
		sqlStr.append(" select min(negociacaorecebimento.data) as data");
		sqlStr.append(" from matriculaperiodo");
		sqlStr.append(" inner join contareceber cr2 on matriculaperiodo.codigo = cr2.matriculaperiodo");
		sqlStr.append(" and cr2.tipoorigem in ('MEN') and cr2.situacao in ('RE', 'NE')");
		sqlStr.append(" inner join contarecebernegociacaorecebimento on contarecebernegociacaorecebimento.contareceber = cr2.codigo");
		sqlStr.append(" inner join negociacaorecebimento on contarecebernegociacaorecebimento.negociacaorecebimento = negociacaorecebimento.codigo");
		sqlStr.append(" left join contareceber on matriculaperiodo.codigo = contareceber.matriculaperiodo");
		sqlStr.append(" and contareceber.tipoorigem in ('MAT', 'MA')");
		sqlStr.append(" where matriculaperiodo.codigo = ").append(codigoMatriculaPeriodo);
		sqlStr.append(" and contareceber.codigo is null");
		sqlStr.append(" union");
		sqlStr.append(" select matriculaperiodo.data as data from matriculaperiodo");
		sqlStr.append(" left join contareceber on matriculaperiodo.codigo = contareceber.matriculaperiodo and contareceber.tipoorigem in ('MAT', 'MA')");
		sqlStr.append(" where matriculaperiodo.codigo = ").append(codigoMatriculaPeriodo).append(" and matriculaperiodo.situacaomatriculaperiodo = 'AT' and contareceber.codigo is null");
		sqlStr.append(" ) as t");

		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());

		if (rs.next()) {
			return rs.getTimestamp("max");
		}

		return null;
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirObservacaoCriterioAvaliacaoAluno(final MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception {
		final StringBuilder sql = new StringBuilder();
		sql.append("UPDATE MatriculaPeriodo SET observacaoCriterioAvaliacao=? WHERE ((codigo = ?)) " + adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
		try {
			getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

				public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
					PreparedStatement sqlAlterar = arg0.prepareStatement(sql.toString());

					sqlAlterar.setString(1, matriculaPeriodoVO.getObservacaoCriterioAvaliacao());
					sqlAlterar.setInt(2, matriculaPeriodoVO.getCodigo());
					return sqlAlterar;
				}
			});
		} catch (Exception e) {
			throw e;
		}
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public String consultarAnoIngressoMatriculaPeriodoPorMatricula(String matricula, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append(" select ano from (");
		sb.append(" select codigo, ano, semestre from matriculaperiodo where matricula = '").append(matricula).append("' order by codigo asc, (ano || semestre) asc limit 1 ");
		sb.append(") as t");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getString("ano");
		}
		return "";
	}

	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public String consultarSemestreIngressoMatriculaPeriodoPorMatricula(String matricula, UsuarioVO usuarioVO) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append(" select semestre from (");
		sb.append(" select codigo, ano, semestre from matriculaperiodo where matricula = '").append(matricula).append("' order by codigo asc, (ano || semestre) asc limit 1 ");
		sb.append(") as t");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getString("semestre");
		}
		return "";
	}

	@Override
	public void validarExistenciaMatriculaPeriodoAptaRealizarTrancamentoCancelamentoTransferencia(String matricula) throws Exception {
		String sqlStr = "SELECT MatriculaPeriodo.situacaoMatriculaPeriodo  FROM  MatriculaPeriodo WHERE MatriculaPeriodo.matricula = '" + matricula + "' order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc, MatriculaPeriodo.data desc limit 1 ";
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (!rs.next() || (!rs.getString("situacaoMatriculaPeriodo").equals("AT") && !rs.getString("situacaoMatriculaPeriodo").equals("PR"))) {
			throw new Exception(UteisJSF.internacionalizar("msg_MatriculaPeriodo_semMatriculaAtivaOuPreMatriculada"));
		}
	}

	/**
	 * Este método verifica se a condição do plano financeiro do curso do aluno
	 * não controla matrícula e se não existe parcela recebida ou renegociada
	 * Caso não exista parcela recebida e nem renegociada irá retornar true
	 * informando que o mesmo está pendente financeiro, caso contrario false
	 */
	@Override
	public boolean realizarVerificacaoMatriculaPeriodoEstaPendenteFinanceiroAoEstornarMensalidade(Integer matriculaPeriodo) throws Exception {
		StringBuilder sql = new StringBuilder("select condicaopagamentoplanofinanceirocurso.naocontrolarmatricula, count(contareceber.codigo) as contarecebida from matriculaperiodo ");
		sql.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sql.append(" left join contareceber on contareceber.matriculaperiodo = matriculaperiodo.codigo and contareceber.tipoorigem = 'MEN' ");
		sql.append(" and contareceber.situacao in ('RE', 'NE') ");
		sql.append(" where  matriculaperiodo.codigo = ").append(matriculaPeriodo);
		sql.append(" group by condicaopagamentoplanofinanceirocurso.naocontrolarmatricula ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		if (rs.next()) {
			return rs.getBoolean("naocontrolarmatricula") && rs.getInt("contarecebida") == 0;
		}
		return false;
	}

	/**
	 * Este método retorna true caso a condição do plano financeiro do curso
	 * controle matrícula
	 */
	@Override
	public boolean realizarVerificacaoMatriculaPeriodoControlaMatricula(Integer matriculaPeriodo) throws Exception {
		StringBuilder sql = new StringBuilder("select condicaopagamentoplanofinanceirocurso.naocontrolarmatricula from matriculaperiodo ");
		sql.append(" inner join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sql.append(" where  matriculaperiodo.codigo = ").append(matriculaPeriodo);
		sql.append(" group by condicaopagamentoplanofinanceirocurso.naocontrolarmatricula ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		if (rs.next()) {
			return !rs.getBoolean("naocontrolarmatricula");
		}
		return true;
	}

	/**
	 * Este método é responsável em verificar se a parcela que está sendo
	 * estornado seja pelo recebimento ou pela renegociação deve alterar a
	 * situação da matricula período para Pré-Matrícula e também verifica a
	 * situação financeira da matriculaperiodo, seguindo as seguintes regras: 1
	 * - Caso no plano financeiro do curso não controla matrícula a parcela que
	 * está sendo estornada seja a unica parcela recebida então e alterado a
	 * situação financeira para 'Pendente Financeiro' e a situação matricula
	 * periodo 'Pré-matricula' 2 - Caso no plano financeiro do curso controla a
	 * matrícula a parcela que está sendo estornada seja de matrícula então e
	 * alterado a situação financeira para 'Pendente Financeiro' e a situação
	 * matricula periodo 'Pré-matricula' 3 - Caso a parcela estornada seja de
	 * Renegociação então o sistema irá considerar apenas se na renegociação em
	 * questão exista uma conta de matrícula respeitando a regra de liberação da
	 * matricula definida na renegociação, sendo elas: 3.1 - Se na renegociação
	 * esteja definido que a liberação da matrícula irá ocorrer no momento do
	 * pagamento da 1ª parcela então será verificado se não existe nenhuma outra
	 * conta a receber recebida desta mesma renegociação, caso contrario será
	 * alterado a situação financeira para 'Pendente Financeiro' e a situação
	 * matricula periodo 'Pré-matricula' 3.2 - Se na renegociação esteja
	 * definido que a liberação da matrícula irá ocorrer após o de todas as
	 * parcelas então será alterado a situação financeira para 'Pendente
	 * Financeiro' e a situação matricula periodo 'Pré-matricula' 3.3 - Caso não
	 * esteja marcada nenhuma das opções acima não será realizado nada na
	 * matricula periodo
	 * 
	 * @param contaReceberNegociacaoRecebimentoVO
	 * @param configuracaoFinanceiro
	 * @param usuario
	 * @throws Exception
	 */
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarEstornoSituacaoMatriculaPeriodoAoEstornarContaReceber(ContaReceberVO contaReceber, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception {
		boolean alterarSituacaoMatriculaPeriodo = false;
		if (contaReceber.getTipoOrigem().equals(TipoOrigemContaReceber.MATRICULA.getValor())) {
			alterarSituacaoMatriculaPeriodo = true;
		} else if (contaReceber.getTipoOrigem().equals(TipoOrigemContaReceber.MENSALIDADE.getValor()) && realizarVerificacaoMatriculaPeriodoEstaPendenteFinanceiroAoEstornarMensalidade(contaReceber.getMatriculaPeriodo())) {
			alterarSituacaoMatriculaPeriodo = true;
		} else if (contaReceber.getTipoOrigem().equals(TipoOrigemContaReceber.NEGOCIACAO.getValor()) && getFacadeFactory().getNegociacaoContaReceberFacade().realizarValidacaoEstornoAtivacaoMatriculaPeriodoParcelaRenegociada(contaReceber.getCodigo(), contaReceber.getMatriculaPeriodo(), getFacadeFactory().getMatriculaPeriodoFacade().realizarVerificacaoMatriculaPeriodoControlaMatricula(contaReceber.getMatriculaPeriodo()))) {
			alterarSituacaoMatriculaPeriodo = true;
		}
		if (alterarSituacaoMatriculaPeriodo) {
			// A consulta de processoMatricula foi adicionada pois se o processo
			// de matricula não for de pré-matrícula então não poderá alterar a
			// situação da matricula periodo.
			ProcessoMatriculaVO processoMatricula = getFacadeFactory().getProcessoMatriculaFacade().consultaRapidaPorMatriculaPeriodo(contaReceber.getMatriculaPeriodo(), usuario);
			if (Uteis.isAtributoPreenchido(processoMatricula) && processoMatricula.getSituacao().equals("PR")) {
				// A consulta de MatriculaPeriodoVO foi adicionada pois se a
				// matricula periodo estiver diferente de ativa não pode
				// retornar para pré-matrícula.
				MatriculaPeriodoVO mp = new MatriculaPeriodoVO();
				mp.setCodigo(contaReceber.getMatriculaPeriodo());
				getFacadeFactory().getMatriculaPeriodoFacade().carregarDados(mp, NivelMontarDados.BASICO, configuracaoFinanceiro, usuario);
				if (mp.getSituacaoAtiva()) {
					alterarSituacaoMatriculaPeriodoPorCodigo(contaReceber.getMatriculaPeriodo(), SituacaoMatriculaPeriodoEnum.PRE_MATRICULA.getValor(), null, null, false, null);
				}
			}
			alterarSituacaoFinanceiraMatriculaPeriodo(contaReceber.getMatriculaPeriodo(), "PF");
		}
	}

	/**
	 * Responsável por executar a verificação da existência de uma nova
	 * matricula período.
	 * 
	 * @author Wellington Rodrigues - 02/04/2015
	 * @param matriculaPeriodo
	 * @param controlarAcesso
	 * @param usuarioVO
	 * @return
	 * @throws Exception
	 */
	@Override
	public boolean executarVerificacaoExisteMatriculaPeriodoRenovadaAposMatriculaPeriodoEspecifica(Integer matriculaPeriodo, boolean controlarAcesso, UsuarioVO usuarioVO) throws Exception {
		MatriculaPeriodo.consultar(getIdEntidade(), controlarAcesso, usuarioVO);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("select matriculaperiodo.codigo from matriculaperiodo ");
		sqlStr.append("where matriculaperiodo.matricula = (select distinct mp.matricula from matriculaperiodo mp where mp.codigo = ").append(matriculaPeriodo).append(") ");
		sqlStr.append("and matriculaperiodo.codigo != ").append(matriculaPeriodo);
		sqlStr.append(" and 0 = (select distinct count(mp.codigo) from matriculaperiodo mp where mp.matricula = matriculaperiodo.matricula ");
		sqlStr.append(" and (mp.ano || '/'|| mp.semestre) >= (matriculaperiodo.ano || '/'|| matriculaperiodo.semestre) limit 1) ");
		return getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString()).next();
	}

	public MatriculaPeriodoVO consultarCodigoUnidadeEnsinoCursoDataPorMatriculaPeriodoLetivoSemestreAno(String matricula, Integer periodoLetivo, String semestre, String ano, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" SELECT MatriculaPeriodo.codigo, MatriculaPeriodo.unidadeEnsinoCurso, MatriculaPeriodo.data, turma.codigo AS \"turma.codigo\", turma.identificadorTurma AS \"turma.identificadorTurma\" FROM MatriculaPeriodo ");
		sqlStr.append(" LEFT JOIN turma ON matriculaperiodo.turma = turma.codigo ");
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '").append(matricula).append("'");
		if (Uteis.isAtributoPreenchido(periodoLetivo)) {
			sqlStr.append(" AND MatriculaPeriodo.periodoLetivoMatricula = ").append(periodoLetivo);
		}
		if (Uteis.isAtributoPreenchido(ano)) {
			sqlStr.append(" AND MatriculaPeriodo.ano = '").append(ano).append("' ");
		}
		if (Uteis.isAtributoPreenchido(semestre)) {
			sqlStr.append(" AND MatriculaPeriodo.semestre = '").append(semestre).append("'");
		}
		sqlStr.append(" and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getUnidadeEnsinoCursoVO().setCodigo(tabelaResultado.getInt("unidadeEnsinoCurso"));
			obj.setUnidadeEnsinoCurso(tabelaResultado.getInt("unidadeEnsinoCurso"));
			obj.setData(tabelaResultado.getDate("data"));

			obj.getTurma().setCodigo(tabelaResultado.getInt("turma.codigo"));
			obj.getTurma().setIdentificadorTurma(tabelaResultado.getString("turma.identificadorTurma"));
			return obj;
		}
		return null;
	}

	public MatriculaPeriodoVO consultarFinanceiroManulaPorChavePrimaria(Integer matriculaPeriodo, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("SELECT codigo, financeiroManual FROM MatriculaPeriodo WHERE codigo = ").append(matriculaPeriodo);
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		MatriculaPeriodoVO obj = null;
		if (tabelaResultado.next()) {
			obj = new MatriculaPeriodoVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setFinanceiroManual(tabelaResultado.getBoolean("financeiroManual"));
		}
		return obj;
	}

	@Override
	public Double executarValidacaoSeraGeradoParcelaExtraRepassarMatricula(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ProcessoMatriculaCalendarioVO processoMatriculaCalendarioVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		if (!matriculaPeriodoVO.getFinanceiroManual()) {
			inicializarDadosParaProcessarGeracaoContasReceberReferentesParcelasMatriculaPeriodo(matriculaVO, matriculaPeriodoVO, processoMatriculaCalendarioVO, usuarioVO, configuracaoFinanceiroVO);
			MatriculaPeriodoVencimentoVO parcelaMatricula = gerarVencimentoMatricula(matriculaPeriodoVO, processoMatriculaCalendarioVO.getDataVencimentoMatricula());
			matriculaPeriodoVO.setMatriculaPeriodoVencimentoVOs(getFacadeFactory().getMatriculaPeriodoVencimentoFacade().consultarPorMatriculaPeriodo(matriculaPeriodoVO.getCodigo(), false, Uteis.NIVELMONTARDADOS_DADOSCONSULTARTODOS, configuracaoFinanceiroVO, usuarioVO));
			List<MatriculaPeriodoVencimentoVO> listaVctosGerados = gerarVencimentosMensalidades(matriculaPeriodoVO, usuarioVO);
			return calcularValorDiferencaValorCobrarComRelacaoValorJaPago(matriculaVO, parcelaMatricula, listaVctosGerados, matriculaPeriodoVO, configuracaoFinanceiroVO, usuarioVO);
		}
		return 0.0;
	}

	@Override
	public void atualizarSituacaoMatriculaPeriodo(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuarioVO) throws Exception {
		if ((matriculaPeriodoVO.getTurma() == null) || (matriculaPeriodoVO.getTurma().getCodigo().intValue() == 0)) {
			return;
		}
		if ((matriculaPeriodoVO.getProcessoMatricula() == null) || (matriculaPeriodoVO.getProcessoMatricula().equals(0))) {
			return;
		}
		getFacadeFactory().getMatriculaPeriodoFacade().montarDadosProcessoMatriculaCalendarioVO(matriculaVO, matriculaPeriodoVO, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);
		getFacadeFactory().getMatriculaPeriodoFacade().definirSituacaoMatriculaPeriodoComBaseProcesso(matriculaVO, matriculaPeriodoVO, configuracaoFinanceiroVO, usuarioVO);
	}

	@Override
	public List<MatriculaPeriodoVO> consultaRapidaPorNomePessoaAnoSemestre(String nomePessoa, Integer unidadeEnsino, String ano, String semestre, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE sem_acentos(Pessoa.nome) ilike sem_acentos(?) ");
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		if (!ano.equals("")) {
			sqlStr.append("AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sqlStr.append("AND matriculaperiodo.semestre = '").append(semestre).append("' ");
		}
		sqlStr.append(" ORDER BY Pessoa.nome, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { Uteis.removerAcentuacao(nomePessoa.toLowerCase().trim()) + "%" });
		return montarDadosConsultaBasica(tabelaResultado);
	}

	@Override
	public List<MatriculaPeriodoVO> consultaRapidaPorUnidadeEnsinoCursoAnoSemestre(Integer unidadeEnsinoCurso, String semestre, String ano, String situacao, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (uec.codigo = ").append(unidadeEnsinoCurso).append(") ");
		if ((situacao != null) && (!situacao.equals("")) && (!situacao.equals("TO"))) {
			sqlStr.append(" AND (Matricula.situacao = '").append(situacao).append("') ");
		}
		if (!ano.equals("")) {
			sqlStr.append("AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sqlStr.append("AND matriculaperiodo.semestre = '").append(semestre).append("' ");
		}
		sqlStr.append(" ORDER BY curso.nome, Pessoa.nome, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	@Override
	public List<MatriculaPeriodoVO> consultaRapidaPorIdentificadorTurmaSituacaoMatriculaPeriodoAnoSemestre(String identificadorTurma, Integer unidadeEnsino, String situacao, String ano, String semestre, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (Turma.identificadorTurma ilike('").append(identificadorTurma.toLowerCase()).append("%')) ");
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		if ((situacao != null) && (!situacao.equals("")) && (!situacao.equals("TO"))) {
			sqlStr.append(" AND (Matricula.situacao = '").append(situacao).append("') ");
		}
		if (!ano.equals("")) {
			sqlStr.append("AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sqlStr.append("AND matriculaperiodo.semestre = '").append(semestre).append("' ");
		}
		sqlStr.append(" ORDER BY Turma.identificadorTurma, Pessoa.nome, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}

	@Override
	public List<MatriculaPeriodoVO> consultaRapidaPorMatriculaAnoSemestre(String matricula, Integer unidadeEnsino, String situacao, String ano, String semestre, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (MatriculaPeriodo.matricula like('").append(matricula).append("%')) ");
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		if ((situacao != null) && (!situacao.equals("")) && (!situacao.equals("TO"))) {
			sqlStr.append(" AND (Matricula.situacao = '").append(situacao).append("') ");
		}
		if (!ano.equals("")) {
			sqlStr.append("AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (!semestre.equals("")) {
			sqlStr.append("AND matriculaperiodo.semestre = '").append(semestre).append("' ");
		}
		sqlStr.append(" ORDER BY matricula, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}
	
	
	

	/**
	 * Este método tem a finalidade de realizar a definição automática de turma
	 * prática e teórica desde que na conf. academica esteja definido para
	 * realizar a Distribuicao Turma Pratica/Teorica na Renovacao, então caso
	 * encontre turma prática/teórica porém em todas as possibilidades
	 * encontradas é localizada choque de horário então a disciplina é removida
	 * automaticamente da matrícula periodo.
	 * 
	 * @author Rodrigo Wind - 22/01/2016
	 * @param matriculaPeriodoVO
	 * @param configuracaoAcademicoVO
	 * @param usuarioVO
	 * @throws Exception
	 */
	@Override
	public void realizarSugestaoTurmaPraticaTeorica(MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoAcademicoVO configuracaoAcademicoVO, List<HorarioAlunoTurnoVO> horarioAlunoTurnoVOs, Boolean considerarVagaReposicao, UsuarioVO usuarioVO) throws Exception {		
//		if (Uteis.isAtributoPreenchido(configuracaoAcademicoVO) && configuracaoAcademicoVO.getHabilitarDistribuicaoTurmaPraticaTeoricaRenovacao()) {
//			for (Iterator<MatriculaPeriodoTurmaDisciplinaVO> iterator = matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().iterator(); iterator.hasNext();) {
//				MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO = iterator.next();
//				try {
//					getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().realizarSugestaoTurmaPraticaTeorica(matriculaPeriodoVO, matriculaPeriodoTurmaDisciplinaVO, matriculaPeriodoTurmaDisciplinaVO.getDisciplina(), configuracaoAcademicoVO, horarioAlunoTurnoVOs, considerarVagaReposicao, usuarioVO);
//				} catch (ConsistirException e) {
//					if (e.getReferenteChoqueHorario()) {
//						matriculaPeriodoVO.getMensagemAvisoUsuario().setReferenteChoqueHorario(true);
//						matriculaPeriodoVO.getMensagemAvisoUsuario().getListaMensagemErro().addAll(e.getListaMensagemErro());
//						Uteis.liberarListaMemoria(e.getListaMensagemErro());
//						e = null;
//						if (configuracaoAcademicoVO.getRemoverDisciplinaTurmaPraticaTeoricaComChoqueHorario()) {
//							if (matriculaPeriodoTurmaDisciplinaVO.getDisciplinaFazParteComposicao()) {
//								removerMatriculaPeriodoTurmaDisciplinaCompostaComBaseNaComposicao(matriculaPeriodoVO, matriculaPeriodoTurmaDisciplinaVO, usuarioVO);
//								realizarSugestaoTurmaPraticaTeorica(matriculaPeriodoVO, configuracaoAcademicoVO, horarioAlunoTurnoVOs, considerarVagaReposicao, usuarioVO);
//								return;
//							} else {
//								getFacadeFactory().getMatriculaPeriodoFacade().removerMatriculaPeriodoTurmaDisciplinaObjEspecifico(matriculaPeriodoVO, matriculaPeriodoVO.getMatriculaVO(), matriculaPeriodoTurmaDisciplinaVO, usuarioVO);
//								realizarSugestaoTurmaPraticaTeorica(matriculaPeriodoVO, configuracaoAcademicoVO, horarioAlunoTurnoVOs, considerarVagaReposicao, usuarioVO);
//								return;
//							}
//						}
//					} else {
//						throw e;
//					}
//				} catch (Exception e) {
//					throw e;
//				}
//			}
//		}
	}

	public Integer consultaCodigoUltimaMatriculaPeriodoPorMatricula(String valorConsulta, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaCompleta();
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '").append(valorConsulta).append("' and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO vetResultado = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			return (tabelaResultado.getInt("codigo"));
		} else {
			return 0;
		}
	}

	public void alterarSituacaoMatriculaPeriodoEstornoCancelamento(final Integer matriculaPeriodo, final UsuarioVO usuarioVO) throws Exception {
		final String sqlStr = "update matriculaperiodo set situacaomatriculaperiodo = 'AT', datafechamentomatriculaperiodo = null, origemfechamentomatriculaperiodo = null where situacaomatriculaperiodo = 'CA' and codigo = ?";

		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sqlStr);
				sqlAlterar.setInt(1, matriculaPeriodo);
				return sqlAlterar;
			}
		});
	}

	public void alterarSituacaoMatriculaPeriodoEstornoTrancamento(final Integer matriculaPeriodo, final UsuarioVO usuarioVO) throws Exception {
		final String sqlStr = "update matriculaperiodo set situacaomatriculaperiodo = 'AT', datafechamentomatriculaperiodo = null, origemfechamentomatriculaperiodo = null where situacaomatriculaperiodo in ('TR','AC','JU') and codigo = ?";

		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sqlStr);
				sqlAlterar.setInt(1, matriculaPeriodo);
				return sqlAlterar;
			}
		});
	}

	@Override
	public Boolean consultarMatriculaIntegracaoFinanceiraPodeRenovarVisaoAluno(String matriculaAluno, Date dataCompetenciaMatricula) throws Exception {
		String mesMatricula = Integer.toString(Uteis.getMesData(dataCompetenciaMatricula));
		if (mesMatricula.length() == 1) {
			mesMatricula = "0" + mesMatricula;
		}
		String anoMatricula = Integer.toString(Uteis.getAnoData(dataCompetenciaMatricula));
		String parcelaMatriculaPadraoIntegracao = "MAT_" + mesMatricula + "/" + anoMatricula;

		StringBuilder sqlStr = new StringBuilder("");
		sqlStr.append("select distinct matriculaaluno from contareceber where matriculaAluno = ");
		sqlStr.append("'").append(matriculaAluno).append("'");
		sqlStr.append(" and contareceber.situacao = 'AR' and ");
		sqlStr.append("(contareceber.parcela = '").append(parcelaMatriculaPadraoIntegracao).append("'");
		sqlStr.append(" or contareceber.dataCompetencia < '").append(Uteis.getDataJDBC(dataCompetenciaMatricula)).append("'");
		sqlStr.append(" or possuiPendenciasFinanceirasExternas = true ) ");
		sqlStr.append(" and (possuiFiesIntegracaoFinanceiras = false) ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if (tabelaResultado.next()) {
			// se existe alguma conta a receber na situacao acima, entao o aluno
			// nao pode renovar
			// na visao do mesmo.
			return false;
		}
		return true;
	}

	/**
	 * Este método tem a finalidade de remover as disciplina incluidas na
	 * matrícula que não possuem vaga e nem foram liberadas para serem incluidas
	 * sem vaga, neste caso se na configuração acadêmica do curso estiver
	 * marcado o campo RemoverAutomaticamenteDisciplinaSemVagaRenovacaoOnline
	 * esta rotina será executada.
	 */
	@Override
	public void realizarRemocaoAutomaticaDisciplinaSemVaga(MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuarioVO) throws Exception {
		if (configuracaoAcademicoVO.getRemoverAutomaticamenteDisciplinaSemVagaRenovacaoOnline()) {
			for (Iterator<MatriculaPeriodoTurmaDisciplinaVO> iterator = matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().iterator(); iterator.hasNext();) {
				MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO = iterator.next();
				if (matriculaPeriodoTurmaDisciplinaVO.isNovoObj() && matriculaPeriodoTurmaDisciplinaVO.getApresentarLiberacaoVaga() && !matriculaPeriodoTurmaDisciplinaVO.getDisciplinaFazParteComposicao()) {
					matriculaPeriodoVO.getMensagemAvisoUsuario().adicionarListaMensagemErro("A disciplina " + matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getNome().toUpperCase() + " não foi adicionada pois não há mais vagas disponíveis.");
					getFacadeFactory().getMatriculaPeriodoFacade().removerMatriculaPeriodoTurmaDisciplinaComposta(matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs(), matriculaPeriodoTurmaDisciplinaVO, usuarioVO);
					getFacadeFactory().getMatriculaPeriodoFacade().removerMatriculaPeriodoTurmaDisciplinaObjEspecifico(matriculaPeriodoVO, matriculaPeriodoVO.getMatriculaVO(), matriculaPeriodoTurmaDisciplinaVO, usuarioVO);
					realizarRemocaoAutomaticaDisciplinaSemVaga(matriculaPeriodoVO, configuracaoAcademicoVO, usuarioVO);
					return;
				}
			}
		}
	}

	public void validarDisciplinaSemVaga(MatriculaPeriodoVO matriculaPeriodoVO, ConfiguracaoAcademicoVO configuracaoAcademicoVO, UsuarioVO usuarioVO) throws Exception {		
		for (Iterator<MatriculaPeriodoTurmaDisciplinaVO> iterator = matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().iterator(); iterator.hasNext();) {
			MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO = iterator.next();
			if (matriculaPeriodoTurmaDisciplinaVO.isNovoObj() && matriculaPeriodoTurmaDisciplinaVO.getApresentarLiberacaoVaga() && !matriculaPeriodoTurmaDisciplinaVO.getDisciplinaFazParteComposicao()) {
				matriculaPeriodoVO.getMensagemAvisoUsuario().adicionarListaMensagemErro("A disciplina " + matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getNome().toUpperCase() + " não foi adicionada pois não há mais vagas disponíveis.");
				throw new Exception ("Existe(m) disciplina(s) adicionada(s) sem vagas disponíveis na turma! Realize a ilberação para inclusão de disciplina sem vaga ou aumente o número de vagas no controle de vaga(s)!");
			}
		}
	}

	public void removerMatriculaPeriodoTurmaDisciplinaCompostaComBaseNaComposicao(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoTurmaDisciplinaVO obj, UsuarioVO usuario) throws Exception {
		if (obj.getDisciplinaFazParteComposicao()) {
			Integer disciplinaMae = 0;
			if (Uteis.isAtributoPreenchido(obj.getGradeDisciplinaCompostaVO().getGradeCurricularGrupoOptativaDisciplina())) {
				// montando dados da GradeCurricularGrupoOptativaDisciplinaVO,
				// inclusive com as composicoes da mesma.
				GradeCurricularGrupoOptativaDisciplinaVO gradeCurricularGrupoOptativaDisciplinaVO = getFacadeFactory().getGradeCurricularGrupoOptativaDisciplinaFacade().consultarPorChavePrimaria(obj.getGradeDisciplinaCompostaVO().getGradeCurricularGrupoOptativaDisciplina().getCodigo(), usuario);
				disciplinaMae = gradeCurricularGrupoOptativaDisciplinaVO.getDisciplina().getCodigo();
			} else {
				// montando dados da gradeDisciplina, inclusive com as
				// composicoes da mesma.
				GradeDisciplinaVO gradeDisciplinaVO = getFacadeFactory().getGradeDisciplinaFacade().consultarPorChavePrimaria(obj.getGradeDisciplinaCompostaVO().getGradeDisciplina().getCodigo(), usuario);
				disciplinaMae = gradeDisciplinaVO.getDisciplina().getCodigo();
			}

			for (MatriculaPeriodoTurmaDisciplinaVO mptdVO : matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()) {
				if (mptdVO.getDisciplina().getCodigo().equals(disciplinaMae)) {
					getFacadeFactory().getMatriculaPeriodoFacade().removerMatriculaPeriodoTurmaDisciplinaComposta(matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs(), mptdVO, usuario);
					getFacadeFactory().getMatriculaPeriodoFacade().removerMatriculaPeriodoTurmaDisciplinaObjEspecifico(matriculaPeriodoVO, matriculaPeriodoVO.getMatriculaVO(), mptdVO, usuario);
					return;
				}
			}
		}
	}

	@Override
	public List<String> consultarAnoSemestreCursadoAluno(String matricula, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		String sqlStr = "select ano, semestre from matriculaperiodo where matricula = ? order by (ano||'/'||semestre) desc ";
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { matricula });
		List<String> anoSemestre = new ArrayList<String>(0);
		while (rs.next()) {
			anoSemestre.add(rs.getString("ano") + (rs.getString("semestre") != null ? "/" + rs.getString("semestre") : ""));
		}
		return anoSemestre;
	}

	public Boolean consultarExistenciaMatriculaPeriodoPorMatriculaAnoSemestre(String matricula, String ano, String semestre, String periodicidadeCurso, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append("SELECT COUNT(matriculaPeriodo.codigo) AS quantidade_registro ");
		sqlStr.append("FROM matriculaperiodo ");
		sqlStr.append("WHERE matriculaperiodo.matricula = '").append(matricula).append("' ");

		if (periodicidadeCurso.equals("SE") || periodicidadeCurso.equals("AN")) {
			sqlStr.append("AND matriculaperiodo.ano = '").append(ano).append("' ");
		}
		if (periodicidadeCurso.equals("SE")) {
			sqlStr.append("AND matriculaperiodo.semestre = '").append(semestre).append("' ");
		}

		if (periodicidadeCurso.equals("AN") || periodicidadeCurso.equals("SE")) {
			sqlStr.append("AND (matriculaPeriodo.situacaomatriculaperiodo = 'AT' OR matriculaPeriodo.situacaomatriculaperiodo = 'PR' OR matriculaPeriodo.situacaomatriculaperiodo = 'FI') ");
		} else {
			sqlStr.append("AND (matriculaPeriodo.situacaomatriculaperiodo = 'AT' OR matriculaPeriodo.situacaomatriculaperiodo = 'PR') ");
		}
		sqlStr.append(";");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		tabelaResultado.next();
		if (tabelaResultado.getInt("quantidade_registro") > 0) {
			return Boolean.TRUE;
		}
		return Boolean.FALSE;
	}

	public boolean executarVerificacaoQtdeMaximaAlunosTurmaTeoricaChoqueHorarioRegistroAulaTransferir(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoTurmaDisciplinaVO mptd, TurmaVO subturmaTeoricaDestino, boolean visaoAluno, Boolean validarChoqueHorarioOutraMatricula, UsuarioVO usuarioVO, ConsistirException ce) throws Exception {
		if (Uteis.isAtributoPreenchido(mptd.getTurmaTeorica().getCodigo()) && Uteis.isAtributoPreenchido(subturmaTeoricaDestino) && !mptd.getTurmaTeorica().getCodigo().equals(subturmaTeoricaDestino.getCodigo())) {
			subturmaTeoricaDestino = getFacadeFactory().getTurmaFacade().consultarPorChavePrimaria(subturmaTeoricaDestino.getCodigo(), Uteis.NIVELMONTARDADOS_COMBOBOX, usuarioVO);
			subturmaTeoricaDestino.setSubturma(true);
			subturmaTeoricaDestino.setTipoSubTurma(TipoSubTurmaEnum.TEORICA);
			TurmaVO turmaVOAnt = mptd.getTurmaTeorica().clone();
			try {
				if (getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(matriculaPeriodoVO.getMatricula(), mptd.getTurmaTeorica().getCodigo(), mptd.getDisciplina().getCodigo(), null, matriculaPeriodoVO.getSemestre(), matriculaPeriodoVO.getAno())) {
					throw new Exception("Não é possível realizar a alteração para a subturma " + subturmaTeoricaDestino.getIdentificadorTurma() + ", pois já existem aulas registradas na subturma origem.");
				}
				mptd.getTurmaTeorica().setCodigo(0);
				getFacadeFactory().getMatriculaPeriodoFacade().executarVerificarSeHaIncompatibilidadeHorarioDeDisciplinas(matriculaPeriodoVO, subturmaTeoricaDestino, mptd.getDisciplina(), null, validarChoqueHorarioOutraMatricula, usuarioVO);
				executarValidacaoVagaTurmaVisaoAluno(subturmaTeoricaDestino, TipoSubTurmaEnum.TEORICA, matriculaPeriodoVO, mptd, usuarioVO);
				TurmaVO clone = subturmaTeoricaDestino.clone();
				mptd.setTurmaTeorica(clone);
				matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().stream().filter(mptdvo -> mptdvo.getDisciplina().getCodigo().equals(mptd.getDisciplina().getCodigo())).findAny().ifPresent(mptdvo -> {mptdvo.setTurmaTeorica(clone); mptdvo.setAlterandoSubturmaPraticaTeorica(true);});
				realizarDefinicaoNumeroVagaDisciplinaCompostaComLimitacaoDisciplina(matriculaPeriodoVO, mptd);
				mptd.setAlterandoSubturmaPraticaTeorica(true);
			} catch (Exception e) {
				matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().stream().filter(mptdvo -> mptdvo.getDisciplina().getCodigo().equals(mptd.getDisciplina().getCodigo())).findAny().ifPresent(mptdvo -> mptdvo.setTurmaTeorica(turmaVOAnt));
				mptd.setTurmaTeorica(turmaVOAnt);
				ce.adicionarListaMensagemErro(e.getMessage());
				return false;
			}
		}
		return true;
	}

	@Override
	public boolean executarVerificacaoQtdeMaximaAlunosTurmaPraticaChoqueHorarioRegistroAulaTransferir(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoTurmaDisciplinaVO mptd, TurmaVO subturmaPraticaDestino, boolean visaoAluno, Boolean validarChoqueHorarioOutraMatricula, UsuarioVO usuarioVO, ConsistirException ce) throws Exception {
		if (Uteis.isAtributoPreenchido(mptd.getTurmaPratica().getCodigo()) && Uteis.isAtributoPreenchido(subturmaPraticaDestino) && !mptd.getTurmaPratica().getCodigo().equals(subturmaPraticaDestino.getCodigo())) {
			subturmaPraticaDestino = getFacadeFactory().getTurmaFacade().consultarPorChavePrimaria(subturmaPraticaDestino.getCodigo(), Uteis.NIVELMONTARDADOS_COMBOBOX, usuarioVO);
			subturmaPraticaDestino.setSubturma(true);
			subturmaPraticaDestino.setTipoSubTurma(TipoSubTurmaEnum.PRATICA);
			TurmaVO turmaVOAnt = mptd.getTurmaPratica().clone();
			try {
				if (getFacadeFactory().getRegistroAulaFacade().consultarExistenciaRegistroAula(matriculaPeriodoVO.getMatricula(), mptd.getTurmaPratica().getCodigo(), mptd.getDisciplina().getCodigo(), null, matriculaPeriodoVO.getSemestre(), matriculaPeriodoVO.getAno())) {
					throw new Exception("Não é possível realizar a alteração para a subturma " + subturmaPraticaDestino.getIdentificadorTurma() + ", pois já existem aulas registradas na subturma origem.");
				}
				mptd.getTurmaPratica().setCodigo(0);
				getFacadeFactory().getMatriculaPeriodoFacade().executarVerificarSeHaIncompatibilidadeHorarioDeDisciplinas(matriculaPeriodoVO, subturmaPraticaDestino, mptd.getDisciplina(), null, validarChoqueHorarioOutraMatricula, usuarioVO);
				executarValidacaoVagaTurmaVisaoAluno(subturmaPraticaDestino, TipoSubTurmaEnum.PRATICA, matriculaPeriodoVO, mptd, usuarioVO);
				TurmaVO clone = subturmaPraticaDestino.clone();
				mptd.setTurmaPratica(clone);
				matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().stream().filter(mptdvo -> mptdvo.getDisciplina().getCodigo().equals(mptd.getDisciplina().getCodigo())).findAny().ifPresent(mptdvo -> {mptdvo.setTurmaPratica(clone); mptdvo.setAlterandoSubturmaPraticaTeorica(true);});
				realizarDefinicaoNumeroVagaDisciplinaCompostaComLimitacaoDisciplina(matriculaPeriodoVO, mptd);
				mptd.setAlterandoSubturmaPraticaTeorica(true);
			} catch (Exception e) {
				matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().stream().filter(mptdvo -> mptdvo.getDisciplina().getCodigo().equals(mptd.getDisciplina().getCodigo())).findAny().ifPresent(mptdvo -> mptdvo.setTurmaPratica(turmaVOAnt));
				mptd.setTurmaPratica(turmaVOAnt);
				ce.adicionarListaMensagemErro(e.getMessage());
				return false;
			}
		}
		return true;
	}

	private void executarValidacaoVagaTurmaVisaoAluno(TurmaVO turmaDestino, TipoSubTurmaEnum tipoSubTurma, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoTurmaDisciplinaVO mptd, UsuarioVO usuarioVO) throws Exception {
		turmaDestino = getFacadeFactory().getTurmaFacade().consultarPorChavePrimaria(turmaDestino.getCodigo(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);
		VagaTurmaDisciplinaVO vagaTurmaDisciplinaVO = getFacadeFactory().getVagaTurmaDisciplinaFacade().consultarPorCodigoTurmaCodigoDisciplina(turmaDestino.getCodigo(), mptd.getDisciplina().getCodigo(),  matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(),  false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);
		if (Uteis.isAtributoPreenchido(vagaTurmaDisciplinaVO)) {
			turmaDestino.setNrMaximoMatricula(vagaTurmaDisciplinaVO.getNrMaximoMatricula());
		}
		int qtdeAlunosTurma = getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarNrAlunosMatriculadosTurmaDisciplina(turmaDestino.getCodigo(), mptd.getDisciplina().getCodigo(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), true, tipoSubTurma, "", false, turmaDestino.getTurmaAgrupada());

		if (qtdeAlunosTurma + 1 > turmaDestino.getNrMaximoMatricula()) {
			if (usuarioVO.getIsApresentarVisaoAluno() || usuarioVO.getIsApresentarVisaoPais()) {
				throw new Exception("Não é possível realizar a alteração para a subturma " + turmaDestino.getIdentificadorTurma() + ", pois o número máximo de matrícula para a mesma está excedido.");
			}
		}
		if (tipoSubTurma.equals(TipoSubTurmaEnum.PRATICA)) {
			mptd.setNrAlunosMatriculadosTurmaPratica(qtdeAlunosTurma);
			mptd.setNrVagasDisponiveisTurmaPratica(turmaDestino.getNrMaximoMatricula() - qtdeAlunosTurma);
			if (mptd.getNrVagasDisponiveisTurmaPratica() < 0) {
				mptd.setNrVagasDisponiveisTurmaPratica(0);
			}
			matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().stream().filter(mptdvo -> mptdvo.getDisciplina().getCodigo().equals(mptd.getDisciplina().getCodigo())).findAny().ifPresent(mptdvo -> mptdvo.setNrVagasDisponiveisTurmaPratica(mptd.getNrVagasDisponiveisTurmaPratica()));
		} else {
			mptd.setNrAlunosMatriculadosTurmaTeorica(qtdeAlunosTurma);
			mptd.setNrVagasDisponiveisTurmaTeorica(turmaDestino.getNrMaximoMatricula() - qtdeAlunosTurma);
			if (mptd.getNrVagasDisponiveisTurmaTeorica() < 0) {
				mptd.setNrVagasDisponiveisTurmaTeorica(0);
			}
			matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().stream().filter(mptdvo -> mptdvo.getDisciplina().getCodigo().equals(mptd.getDisciplina().getCodigo())).findAny().ifPresent(mptdvo -> mptdvo.setNrVagasDisponiveisTurmaTeorica(mptd.getNrVagasDisponiveisTurmaTeorica()));
		}
	}

	@Override
	public Boolean consultarMatriculaPeriodoAlterouCondicaoPlanoFinanceiroCurso(Integer matriculaPeriodo, Integer condicaoPlano) throws Exception {
		StringBuilder sql = new StringBuilder("select codigo from matriculaperiodo ");
		sql.append(" WHERE codigo = ").append(matriculaPeriodo);
		sql.append(" and condicaopagamentoplanofinanceirocurso != ").append(condicaoPlano);
		return getConexao().getJdbcTemplate().queryForRowSet(sql.toString()).next();
	}

	public void realizarVerificacaoExistenciaAulaProgramada(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO) throws Exception {
		if (matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada()) {
			if(!matriculaPeriodoTurmaDisciplinaVO.getDisciplinaComposta() && !getFacadeFactory().getTurmaFacade().consultarExistenciaAulaProgramadaTurmaConsiderandoTurmaAgrupada(matriculaPeriodoTurmaDisciplinaVO.getTurma().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo(), matriculaPeriodoTurmaDisciplinaVO.getAno(), matriculaPeriodoTurmaDisciplinaVO.getSemestre(), "AB")){
				matriculaPeriodoVO.getMensagemAvisoUsuario().getListaMensagemErro().add("Disciplina "+matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getNome()+" foi removida pois não foi localizado uma programação de aula.");
				throw new Exception("Disciplina "+matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getNome()+" foi removida pois não foi localizado uma programação de aula.");
			}

		}
	}
	
	@Override
	public MatriculaPeriodoVO consultarUltimoAnoSemestrePorMatricula(String matricula, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("select codigo, ano, semestre from matriculaPeriodo where matricula = '").append(matricula).append("' ").append(" order by ano || '/' || semestre desc, codigo desc limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setAno(tabelaResultado.getString("ano"));
			obj.setSemestre(tabelaResultado.getString("semestre"));
		}
		return obj;
	}
	
	@Override
	public String consultarSituacaoAcademicaUltimoPeriodoPorMatricula(String matricula, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("select situacaoMatriculaPeriodo from matriculaPeriodo where matricula = '").append(matricula).append("' ").append(" order by ano || '/' || semestre desc, codigo desc limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getString("situacaoMatriculaPeriodo");
		}
		return "";
	}
	

	@Override
	public void executarVerificacaoNumeroMaximoDisciplinaComposicaoEstudarNaoInformado(MatriculaPeriodoVO matriculaPeriodoVO) throws Exception {
		for (MatriculaPeriodoTurmaDisciplinaVO mptd : matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()) {
			if (mptd.getDisciplinaComposta() && (Uteis.isAtributoPreenchido(mptd.getGradeDisciplinaVO().getCodigo()) && mptd.getGradeDisciplinaVO().getTipoControleComposicao().equals(TipoControleComposicaoEnum.ESTUDAR_QUANTIDADE_MAXIMA_COMPOSTA))) {
				Integer numeroMaximoDisciplinaComposicaoEstudar = 0;
				List<MatriculaPeriodoTurmaDisciplinaVO> matriculaPeriodoTurmaDisciplinaVOs = getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().realizarObtencaoMatriculaPeriodoTurmaDisciplinaFazParteComposicao(mptd, matriculaPeriodoVO);
				for (MatriculaPeriodoTurmaDisciplinaVO mptdVO : matriculaPeriodoTurmaDisciplinaVOs) {
					numeroMaximoDisciplinaComposicaoEstudar += Uteis.isAtributoPreenchido(mptdVO.getTurma()) ? 1 : 0;
				}
				if (numeroMaximoDisciplinaComposicaoEstudar < (mptd.getGradeDisciplinaVO().getNumeroMinimoDisciplinaComposicaoEstudar())
						|| numeroMaximoDisciplinaComposicaoEstudar > mptd.getGradeDisciplinaVO().getNumeroMaximoDisciplinaComposicaoEstudar()) {
					throw new Exception(UteisJSF.internacionalizar("msg_GradeDisciplina_numeroMaximoDisciplinaComposicaoEstudar").replace("{0}", 
							mptd.getDisciplina().getNome()).replace("{1}", numeroMaximoDisciplinaComposicaoEstudar.toString())
							.replace("{2}",mptd.getGradeDisciplinaVO().getNumeroMinimoDisciplinaComposicaoEstudar().toString())
							.replace("{3}",mptd.getGradeDisciplinaVO().getNumeroMaximoDisciplinaComposicaoEstudar().toString()));
				}
			}
		}
	}
	
	@Override
	public void realizarDefinicaoNumeroVagaDisciplinaCompostaComLimitacaoDisciplina(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoTurmaDisciplinaVO matricaPeriodoTurmaDisciplina){
		if(matricaPeriodoTurmaDisciplina.getDisciplinaFazParteComposicao()){
			Integer nrVagasDisponiveis = null;
			Integer nrAlunosMatriculados = null;
			for(MatriculaPeriodoTurmaDisciplinaVO mptd: matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()){
				if(mptd.getDisciplinaFazParteComposicao() 
						&&  ((Uteis.isAtributoPreenchido(mptd.getGradeDisciplinaCompostaVO().getGradeDisciplina().getCodigo()) 
								&& Uteis.isAtributoPreenchido(matricaPeriodoTurmaDisciplina.getGradeDisciplinaCompostaVO().getGradeDisciplina().getCodigo()) && 
								mptd.getGradeDisciplinaCompostaVO().getGradeDisciplina().getCodigo().equals(matricaPeriodoTurmaDisciplina.getGradeDisciplinaCompostaVO().getGradeDisciplina().getCodigo()))
						||  (Uteis.isAtributoPreenchido(mptd.getGradeDisciplinaCompostaVO().getGradeCurricularGrupoOptativaDisciplina().getCodigo()) &&
								Uteis.isAtributoPreenchido(matricaPeriodoTurmaDisciplina.getGradeDisciplinaCompostaVO().getGradeCurricularGrupoOptativaDisciplina().getCodigo()) &&
								mptd.getGradeDisciplinaCompostaVO().getGradeCurricularGrupoOptativaDisciplina().getCodigo().equals(matricaPeriodoTurmaDisciplina.getGradeDisciplinaCompostaVO().getGradeCurricularGrupoOptativaDisciplina().getCodigo())))
						&& Uteis.isAtributoPreenchido(mptd.getTurma().getCodigo())){
					if(Uteis.isAtributoPreenchido(mptd.getTurmaPratica().getCodigo())){
						if(nrVagasDisponiveis == null || nrVagasDisponiveis > mptd.getNrVagasDisponiveisTurmaPratica()){
							nrVagasDisponiveis = mptd.getNrVagasDisponiveisTurmaPratica();
							nrAlunosMatriculados = mptd.getNrAlunosMatriculadosTurmaPratica();
						}
					}
					if(Uteis.isAtributoPreenchido(mptd.getTurmaTeorica().getCodigo())){
						if(nrVagasDisponiveis == null || nrVagasDisponiveis > mptd.getNrVagasDisponiveisTurmaTeorica()){
							nrVagasDisponiveis = mptd.getNrVagasDisponiveisTurmaTeorica();
							nrAlunosMatriculados = mptd.getNrAlunosMatriculadosTurmaTeorica();
						}
					}
					if(nrVagasDisponiveis == null || (nrVagasDisponiveis >  mptd.getNrVagasDisponiveis() 
							&& !Uteis.isAtributoPreenchido(mptd.getTurmaPratica().getCodigo())
							&& !Uteis.isAtributoPreenchido(mptd.getTurmaTeorica().getCodigo()))){
						nrVagasDisponiveis = mptd.getNrVagasDisponiveis();
						nrAlunosMatriculados = mptd.getNrAlunosMatriculados();
					}
				}
			}
			for(MatriculaPeriodoTurmaDisciplinaVO mp: matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()){
				if(mp.getDisciplinaComposta()
						&& ((Uteis.isAtributoPreenchido(mp.getGradeDisciplinaVO().getCodigo()) 
						&& Uteis.isAtributoPreenchido(matricaPeriodoTurmaDisciplina.getGradeDisciplinaCompostaVO().getGradeDisciplina().getCodigo()) 
						&& mp.getGradeDisciplinaVO().getCodigo().equals(matricaPeriodoTurmaDisciplina.getGradeDisciplinaCompostaVO().getGradeDisciplina().getCodigo()))
						|| (Uteis.isAtributoPreenchido(mp.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo()) 
							&& Uteis.isAtributoPreenchido(matricaPeriodoTurmaDisciplina.getGradeDisciplinaCompostaVO().getGradeCurricularGrupoOptativaDisciplina().getCodigo()) 
							&& mp.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo().equals(matricaPeriodoTurmaDisciplina.getGradeDisciplinaCompostaVO().getGradeCurricularGrupoOptativaDisciplina().getCodigo()))
						)){							
					mp.setNrVagasDisponiveis(nrVagasDisponiveis);
					mp.setNrAlunosMatriculados(nrAlunosMatriculados);
				}
			}
		}
	}
	
	@Override
	public List<MatriculaPeriodoVO> consultaRapidaPorCpfAluno(String cpf, Integer unidadeEnsino, boolean controlarAcesso, UsuarioVO usuario,DataModelo dataModelo) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE replace(replace((pessoa.cpf),'.',''),'-','') = replace(replace(?, '.', ''), '-', '') ");
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		sqlStr.append(" ORDER BY matricula, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo DESC ");
		if (Uteis.isAtributoPreenchido(dataModelo.getLimitePorPagina())) {
			sqlStr.append(" LIMIT ").append(dataModelo.getLimitePorPagina()).append(" OFFSET ").append(dataModelo.getOffset());
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), cpf);
		if (tabelaResultado.next()) {
			dataModelo.setTotalRegistrosEncontrados((tabelaResultado.getInt("totalRegistroConsulta")));
		}
		tabelaResultado.beforeFirst();
		return montarDadosConsultaBasica(tabelaResultado);
	}
	
    /*Consulta retorna uma lista de Matrícula Período que deverá ser considerada no histórico. 
     *Na primeira consulta traz as MPs que tem mais de um registro para o mesmo período letivo  e desconsidera as 
	 *situações cancelada e abandono de curso. Na segunda traz as que contém apenas um período letivo considerando todas as situações.
	 */ 
	@Override
	public List<Integer> consultarMatriculaPeriodoMesmoPeriodoLetivoDesconsiderandoCanceladaAbandonoCurso(String matricula) throws Exception {
		List<Integer> matriculaPeriodoVOs = new ArrayList<Integer>(0);
		StringBuilder sql = new StringBuilder("");
		sql.append("SELECT matriculaperiodo.codigo as matriculaperiodo ");
		sql.append(" FROM matriculaperiodo ");
		sql.append("WHERE matriculaperiodo.matricula = '").append(matricula).append("' ");
		sql.append("AND matriculaperiodo.situacaomatriculaperiodo NOT IN ('CA','AC') ");
		sql.append("AND EXISTS ( SELECT 1 FROM matriculaperiodo mp ");
		sql.append("   WHERE mp.matricula = matriculaperiodo.matricula ");
		sql.append("   AND mp.periodoletivomatricula =  matriculaperiodo.periodoletivomatricula ");
		sql.append("GROUP BY mp.periodoletivomatricula HAVING COUNT(mp.codigo) > 1) ");
		sql.append("UNION ALL ");
		sql.append("SELECT matriculaperiodo.codigo as matriculaperiodo ");
		sql.append(" FROM matriculaperiodo ");
		sql.append("WHERE matriculaperiodo.matricula = '").append(matricula).append("' ");
		sql.append("AND EXISTS ( SELECT 1 FROM matriculaperiodo mp ");
		sql.append("WHERE mp.matricula = matriculaperiodo.matricula ");
		sql.append("AND mp.periodoletivomatricula =  matriculaperiodo.periodoletivomatricula ");
		sql.append("GROUP BY mp.periodoletivomatricula HAVING COUNT(mp.codigo) = 1) ; ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		while (rs.next()) {
			matriculaPeriodoVOs.add(rs.getInt("matriculaperiodo"));
		}
		return matriculaPeriodoVOs;
	}
	

	@Override
	public Integer consultarCodigoMatriculaPeriodoUltimoPeriodoPorMatricula(String matricula) throws Exception {
		StringBuilder sb = new StringBuilder();
		sb.append("SELECT matriculaperiodo.codigo AS matriculaperiodo FROM matriculaperiodo WHERE matriculaperiodo.matricula = '").append(matricula).append("' ");
		sb.append(" ORDER BY matriculaperiodo.ano || '/' || matriculaperiodo.semestre DESC, matriculaperiodo.codigo DESC LIMIT 1;");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		if (tabelaResultado.next()) {
			return tabelaResultado.getInt("matriculaperiodo");
		}
		return 0;
	}

	public static Boolean realizarVerificacaoUltimaMatriculaPeriodo(String matricula, Integer codidoMatriculaPeriodo) throws Exception {
		return getFacadeFactory().getMatriculaPeriodoFacade().consultarCodigoMatriculaPeriodoUltimoPeriodoPorMatricula(matricula).equals(codidoMatriculaPeriodo);
	}

	@Override
	public void executarAtivacaoUltimaMatriculaPeriodo(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception {
		try {
			if (realizarVerificacaoMatriculaAtiva(matriculaPeriodoVO)) {
				this.alterarSituacaoMatriculaPeriodoPorCodigo(matriculaPeriodoVO.getCodigo(), SituacaoMatriculaPeriodoEnum.ATIVA.getValor(), null, null, false, null);
			} else if (realizarVerificacaoMatriculaFormada(matriculaPeriodoVO)) {
				FormacaoAcademicaVO formacaoAcademicaVO = getFacadeFactory().getFormacaoAcademicaFacade().consultarPorNomeCursoPessoa(matriculaPeriodoVO.getMatriculaVO().getCurso().getNome(), matriculaPeriodoVO.getMatriculaVO().getAluno().getCodigo(), false, usuarioVO);
				if (Uteis.isAtributoPreenchido(formacaoAcademicaVO)) {
					getFacadeFactory().getFormacaoAcademicaFacade().excluir(formacaoAcademicaVO, usuarioVO);
				}
				this.alterarSituacaoMatriculaPeriodoPorCodigo(matriculaPeriodoVO.getCodigo(), SituacaoMatriculaPeriodoEnum.ATIVA.getValor(), null, null, false, null);
				getFacadeFactory().getMatriculaFacade().alterarAtivarMatriculaAlunoFormado(matriculaPeriodoVO.getMatriculaVO(), usuarioVO);
			}
		} catch (Exception e) {
			throw e;
		}
	}

	private boolean realizarVerificacaoMatriculaAtiva(MatriculaPeriodoVO matriculaPeriodoVO) {
		return (matriculaPeriodoVO.getSituacaoMatriculaPeriodo().equals(SituacaoMatriculaPeriodoEnum.FINALIZADA.getValor()) && (matriculaPeriodoVO.getMatriculaVO().getSituacao().equals(SituacaoVinculoMatricula.ATIVA.getValor()) || matriculaPeriodoVO.getMatriculaVO().getSituacao().equals(SituacaoVinculoMatricula.FINALIZADA.getValor())));
	}

	private boolean realizarVerificacaoMatriculaFormada(MatriculaPeriodoVO matriculaPeriodoVO) {
		return (matriculaPeriodoVO.getSituacaoMatriculaPeriodo().equals(SituacaoMatriculaPeriodoEnum.FORMADO.getValor()) && matriculaPeriodoVO.getMatriculaVO().getSituacao().equals(SituacaoVinculoMatricula.FORMADO.getValor()));
	}
	
	
	@Override
	public Date consultarDataMatriculaPeriodoPorMatriculaAnoSemestre(String matricula, String ano, String semestre) throws Exception{		
		StringBuffer sqlStr = new StringBuffer("select matriculaperiodo.data from matriculaperiodo ");
		sqlStr.append(" WHERE matriculaperiodo.matricula = '").append(matricula).append("' ");
		if (Uteis.isAtributoPreenchido(ano)) {
			sqlStr.append(" AND matriculaPeriodo.ano = '").append(ano).append("' ");
		}
		if (Uteis.isAtributoPreenchido(semestre)) {
			sqlStr.append(" AND matriculaPeriodo.semestre = '").append(semestre).append("' ");
		}
		sqlStr.append("and matriculaperiodo.situacaoMatriculaPeriodo != 'PC' ");		
		sqlStr.append("order by (matriculaperiodo.ano || '/' || matriculaperiodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc limit 1 ");		
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		if(tabelaResultado.next()){
			return tabelaResultado.getDate("data");
		}
		return null;
	}
	
	
	@Override
	public void realizarValidacaoMatriculaPeriodoIncluiuQuantidadeExigidaDisciplinasGrupoOptativas(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO) throws Exception{
		if(matriculaVO.getCurso().getConfiguracaoAcademico().getBloquearRenovAlunoRegSemIncluirQtdeExigidaDiscGrupoOptativa() 
				&& matriculaPeriodoVO.getAlunoRegularMatrizCurricular()
				&& matriculaVO.getCurso().getConfiguracaoAcademico().getPermitirAlunoRegularIncluirDisciplinaGrupoOptativa()
				&& matriculaPeriodoVO.getPeriodoLetivo().getControleOptativaGrupo() 
				&& matriculaPeriodoVO.getPeriodoLetivo().getGradeCurricularGrupoOptativa().getCodigo() > 0
				&& (( matriculaPeriodoVO.getPeriodoLetivo().getNumeroCreditoOptativa() > 0 &&  matriculaPeriodoVO.getPeriodoLetivo().getTipoControleGrupoOptativaPorCredito())
					||	( matriculaPeriodoVO.getPeriodoLetivo().getNumeroCargaHorariaOptativa() > 0 &&  matriculaPeriodoVO.getPeriodoLetivo().getTipoControleGrupoOptativaPorCargaHoraria()))
				){
			
			Integer totalCargaHorariaCumprirGrupo = 0;
			Integer totalCreditoCumprirGrupo = 0;
			
			Integer cargaHoraria = 0;
			Integer credito = 0;
			/**
			 * Este for contabiliza o total de CH e Credito que deve ser cumprido pelo grupo de optativa até o periodo letivo atual do aluno,
			 * exemplo se estiver no 6º periodo e tenha que cumprir 10 creditos e no 5º periodo tenha que cumprir 10 creditos,
			 * então até o periodo atual o aluno terá que cumprir 20 creditos, sendo assim, é contabilizado também o total de credito de CH já cumprido 
			 * pelo aluno deste grupo até o momento, pois o aluno poderá ter cumprido até o 5º periodo 14 credito ficando assim uma pendência apenas 
			 * de 6 credito, ou seja, o sistema não deve cobrar que o aluno cumpra o 10 creditos do periodo atual porque o aluno já cumpriu 4 creditos anteriormente
			 */
			for(PeriodoLetivoComHistoricoAlunoVO periodoLetivoComHistoricoAlunoVO:matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getPeriodoLetivoComHistoricoAlunoVOs()){
				if(periodoLetivoComHistoricoAlunoVO.getPeriodoLetivoVO().getPeriodoLetivo() <= matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo()){
					if(periodoLetivoComHistoricoAlunoVO.getPeriodoLetivoVO().getControleOptativaGrupo() &&
						periodoLetivoComHistoricoAlunoVO.getPeriodoLetivoVO().getGradeCurricularGrupoOptativa().getCodigo().equals(matriculaPeriodoVO.getPeriodoLetivo().getGradeCurricularGrupoOptativa().getCodigo())){
						totalCargaHorariaCumprirGrupo += periodoLetivoComHistoricoAlunoVO.getPeriodoLetivoVO().getNumeroCargaHorariaOptativa();
						totalCreditoCumprirGrupo += periodoLetivoComHistoricoAlunoVO.getPeriodoLetivoVO().getNumeroCreditoOptativa();									
					}
					for(GradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO gradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO : periodoLetivoComHistoricoAlunoVO.getGradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO()){
						if(gradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getGradeCurricularGrupoOptativa().getCodigo().equals(matriculaPeriodoVO.getPeriodoLetivo().getGradeCurricularGrupoOptativa().getCodigo())
								&& Uteis.isAtributoPreenchido(gradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO.getHistoricoAtualAluno()) 
								&& (((gradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO.getHistoricoAtualAluno().getAprovado() 
									|| gradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO.getHistoricoAtualAluno().getCursando())
									&& !gradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO.getHistoricoAtualAluno().getMatriculaPeriodo().getCodigo().equals(matriculaPeriodoVO.getCodigo()))
									|| ("AA CC CH IS AB".contains(gradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO.getHistoricoAtualAluno().getSituacao())))){
							cargaHoraria += gradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria();
							credito += gradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getNrCreditos();
						}
					}
				}
			}
						
			Integer cargaHorariaPeriodoAtual = 0;
			Integer creditoPeriodoAtual = 0;
			for(MatriculaPeriodoTurmaDisciplinaVO obj:matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs()){
				if(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getGradeCurricularGrupoOptativa().getCodigo().equals(matriculaPeriodoVO.getPeriodoLetivo().getGradeCurricularGrupoOptativa().getCodigo())){
					cargaHoraria += obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria();
					credito += obj.getGradeCurricularGrupoOptativaDisciplinaVO().getNrCreditos();
					cargaHorariaPeriodoAtual += obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCargaHoraria();
					creditoPeriodoAtual += obj.getGradeCurricularGrupoOptativaDisciplinaVO().getNrCreditos();
				}
			}
			if(totalCreditoCumprirGrupo > credito &&  matriculaPeriodoVO.getPeriodoLetivo().getTipoControleGrupoOptativaPorCredito()){
				throw new Exception(UteisJSF.internacionalizar("msg_Matricula_creditoOptativaNaoInforma").replace("{0}", (totalCreditoCumprirGrupo-credito)+"").replace("{1}", creditoPeriodoAtual.toString()));
			}else if(totalCargaHorariaCumprirGrupo > cargaHoraria &&  matriculaPeriodoVO.getPeriodoLetivo().getTipoControleGrupoOptativaPorCargaHoraria()){ 
				throw new Exception(UteisJSF.internacionalizar("msg_Matricula_cargaHorariaOptativaNaoInforma").replace("{0}", (totalCargaHorariaCumprirGrupo-cargaHoraria)+"").replace("{1}", cargaHorariaPeriodoAtual.toString()));
			}
		}
	}
	
	/**
	 * Método que é utilizado somente quando o usuário está editando uma matriculaperiodo, após uma transferencia de matriz curricular,
	 * com o objetivo de remover disciplinas que estao sendo cursadas por correspodencia, por serem de outra matriz. Assim, quando
	 * uma nova disciplina é adicionada pelo usuário, temos que verificar, caso haja disciplinas pendentes para remover (neste lista
	 * de cursando por correspodente) se a MatriculaPeriodoTurmaDisciplinaVO adicionada não é a mesma disciplina que está pendente.
	 * Se tratar da mesma disciplina significa que este nova MatriculaPeriodoTurmaDisciplinaVO irá substituir a que estava cursando
	 * por correspondencia. Assim a mesma poderá ser removida da lista de pendencias.
	 * @author Otimize - 5 de out de 2016 
	 * @param novaMatriculaPeriodoTurmaDisciplina
	 * @param matriculaPeriodoVO
	 * @param matriculaVO
	 * @param usuario
	 * @throws Exception
	 */
	public void verificarDisciplinaAdicionadaEqualizaAlgumaDisciplinaCursandoPorCorrespodenciaPendente(
			MatriculaPeriodoTurmaDisciplinaVO novaMatriculaPeriodoTurmaDisciplina, 
			MatriculaPeriodoVO matriculaPeriodoVO, 
			MatriculaVO matriculaVO, 
			UsuarioVO usuario) throws Exception{
		if (matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO() == null) {
			// se TransferenciaMatrizCurricularMatriculaVO é por que nao trata-se de uma edicacao vinda da transferencia. 
			return;
		}
		if (matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().getListaDisciplinasPorCorrespondencia().isEmpty()) {
			// se a lista de pendencias esta vazia, tambem, nao temos o que fazer
			return;
		}
		int k = matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().getListaDisciplinasPorCorrespondencia().size() - 1;
		while (k >= 0) {
			MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO = matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().getListaDisciplinasPorCorrespondencia().get(k);
			if (matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo().equals(novaMatriculaPeriodoTurmaDisciplina.getDisciplina().getCodigo())) {
				// Se entrarmos aqui e por que localizamos a disciplina adicionada na lista de pendencias. logo, podemos remove-la da pendencia.
				// Assim, iremos remover da lista de pendencia, mas tambem iremos garantir que os dados do historico desta matriculaPeriodo removida,
				// possam ser tranferidos para a nova MatriculaPeriodoTurmaDisciplina
				
				// Obtendo historico anterior (cursando por correspondecia) para que possamos manter em ele em memoria, para posteriormente
				// aproveitar todas as notas que já tenham sido lançadas para o aluno. Isto é importante, pois um novo histórico será gerado
				// para o aluno nesta disciplina. E o historico que existia será removido, pois o mesmo nao poderá ser mantido mais vinculado
				// à matriz antiga - haja vista, que a correspodencia será removida.
				HistoricoVO historicoAnteriorDisciplina = getFacadeFactory().getHistoricoFacade().consultarPorMatriculaPeriodoTurmaDisciplina(matriculaPeriodoTurmaDisciplinaVO.getCodigo(), false, false, usuario);
				novaMatriculaPeriodoTurmaDisciplina.setHistoricoAnteriorDisciplinaMigrarNotas(historicoAnteriorDisciplina);
				
				matriculaPeriodoVO.getTransferenciaMatrizCurricularMatriculaVO().getListaDisciplinasPorCorrespondencia().remove(k);
				break;
			}
			k = k - 1;
		}		
	}
	
	@Override
	public void realizarVerificacaoRestricoesParaExclusaoMatriculaPeriodo(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception{
		matriculaPeriodoVO.getMensagemAvisoUsuario().getListaMensagemErro().clear();
		Matricula.excluir("Matricula", true, usuarioVO);
		if(matriculaPeriodoVO.getSituacaoMatriculaPeriodo().equals(SituacaoMatriculaPeriodoEnum.TRANFERENCIA_INTERNA.getValor()) ||
				matriculaPeriodoVO.getSituacaoMatriculaPeriodo().equals(SituacaoMatriculaPeriodoEnum.TRANFERENCIA_SAIDA.getValor())){
			throw new ConsistirException("Não é possível realizar a exclusão de uma matrícula periodo com a situação "+matriculaPeriodoVO.getSituacaoMatriculaPeriodo_Apresentar()+", realize o cancelamento desta transferência.");
		}
		if(getFacadeFactory().getContaReceberFacade().consultarExistenciaContaReceberRecebidaOuNegociadaPorMatriculaPeriodo(matriculaPeriodoVO.getCodigo())){
			throw new ConsistirException("Não é possível realizar a exclusão desta matrícula neste período pois existem contas recebidas ou renegociadas.");
		}
		StringBuilder sql = new StringBuilder("select count(codigo) as qtde from matriculaperiodo where matricula = ?  ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), matriculaPeriodoVO.getMatricula());
		if (rs.next() && rs.getInt("qtde") > 1) {
			sql = new StringBuilder("select count(codigo) as qtde from historico where matriculaperiodo = ?  ");
			rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), matriculaPeriodoVO.getCodigo());
			if (rs.next() && rs.getInt("qtde") > 0) {
				matriculaPeriodoVO.getMensagemAvisoUsuario().getListaMensagemErro().add("Existe(m) " + rs.getInt("qtde")
						+ " histórico(s) vinculados a este período e os mesmos serão excluídos.");
			}
			sql = new StringBuilder(
					"select count(frequenciaaula.matriculaperiodoturmadisciplina) as qtde from frequenciaaula inner join matriculaperiodoturmadisciplina on matriculaperiodoturmadisciplina.codigo = frequenciaaula.matriculaperiodoturmadisciplina where matriculaperiodoturmadisciplina.matriculaperiodo  = ?  ");
			rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), matriculaPeriodoVO.getCodigo());
			if (rs.next() && rs.getInt("qtde") > 0) {
				matriculaPeriodoVO.getMensagemAvisoUsuario().getListaMensagemErro().add("Existe(m) " + rs.getInt("qtde")
						+ " frequencia(s) vinculados a este período e os mesmos serão excluídos.");
			}

			sql = new StringBuilder(
					"select count(estagio.codigo) as qtde from estagio where matricula  = ? and ano = ? and semestre = ? ");
			rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), matriculaPeriodoVO.getMatricula(),
					matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre());
			if (rs.next() && rs.getInt("qtde") > 0) {
				matriculaPeriodoVO.getMensagemAvisoUsuario().getListaMensagemErro().add("Existe(m) " + rs.getInt("qtde")
						+ " estágio(s) vinculados a este período e os mesmos NÃO serão excluídos.");
			}
		} else {
			matriculaPeriodoVO.getMensagemAvisoUsuario().getListaMensagemErro().add(
					"Esta matrícula possui apenas este período, então todos os dados vinculados a esta matrícula serão excluídos.");
		}
	}
	

    private MatriculaPeriodoVencimentoVO realizarCriacaoMatriculaPeriodoVencimento(MatriculaPeriodoVO matriculaPeriodoVO, Date dataVencimento, String parcela, Double valor,String  descricaoPagamento, boolean usaValorPrimeiraParcela) throws Exception{
    	MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO = new MatriculaPeriodoVencimentoVO();				
		matriculaPeriodoVencimentoVO.setData(dataVencimento);
		matriculaPeriodoVencimentoVO.setDataCompetencia(dataVencimento);
		matriculaPeriodoVencimentoVO.setDataVencimento(dataVencimento);
		matriculaPeriodoVencimentoVO.setValor(valor);
		matriculaPeriodoVencimentoVO.setParcela(parcela);		
		matriculaPeriodoVencimentoVO.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_NAO_GERADA);
		matriculaPeriodoVencimentoVO.setMatriculaPeriodo(matriculaPeriodoVO.getCodigo());
		matriculaPeriodoVencimentoVO.setMatriculaPeriodoVO(matriculaPeriodoVO);
		matriculaPeriodoVencimentoVO.setDescricaoPagamento(descricaoPagamento);
		matriculaPeriodoVencimentoVO.setDiasVariacaoDataVencimento(0);
		matriculaPeriodoVencimentoVO.setValorDescontoCalculadoPrimeiraFaixaDescontos(valor);
		matriculaPeriodoVencimentoVO.setValorDescontoCalculadoSegundaFaixaDescontos(valor);
		matriculaPeriodoVencimentoVO.setValorDescontoCalculadoTerceiraFaixaDescontos(valor);
		matriculaPeriodoVencimentoVO.setValorDescontoCalculadoQuartaFaixaDescontos(valor);
		matriculaPeriodoVencimentoVO.setTipoOrigemMatriculaPeriodoVencimento(TipoOrigemContaReceber.MENSALIDADE);
		matriculaPeriodoVencimentoVO.setUsaValorPrimeiraParcela(usaValorPrimeiraParcela);
		matriculaPeriodoVencimentoVO.setTipoBoleto(TipoBoletoBancario.MENSALIDADE.getValor());
		return matriculaPeriodoVencimentoVO;
    }
    
	public void adicionarMatriculaPeriodoVencimento(MatriculaPeriodoVO matriculaPeriodoVO,
			MatriculaPeriodoVencimentoVO novosVctoPodemSerAdicionarParaGeracao) throws Exception {
		if(!novosVctoPodemSerAdicionarParaGeracao.getParcela().contains("EX")){
			for (MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO : matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()) {
				if (matriculaPeriodoVencimentoVO.getParcela().contains("/") 
					&& matriculaPeriodoVencimentoVO.getParcela().substring(0, matriculaPeriodoVencimentoVO.getParcela().indexOf("/")).
					equals(novosVctoPodemSerAdicionarParaGeracao.getParcela().substring(0,novosVctoPodemSerAdicionarParaGeracao.getParcela().indexOf("/")))
					&& matriculaPeriodoVencimentoVO.getTipoOrigemMatriculaPeriodoVencimento().equals(novosVctoPodemSerAdicionarParaGeracao.getTipoOrigemMatriculaPeriodoVencimento())) {
					matriculaPeriodoVencimentoVO.setValorDesconto(novosVctoPodemSerAdicionarParaGeracao.getValorDesconto());
					matriculaPeriodoVencimentoVO.setValor(novosVctoPodemSerAdicionarParaGeracao.getValor());
					matriculaPeriodoVencimentoVO.setDescricaoPagamento(novosVctoPodemSerAdicionarParaGeracao.getDescricaoPagamento());
					return;
				}
			}
		}
		matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs().add(novosVctoPodemSerAdicionarParaGeracao);
	}
	
	
	@Override
	public List<MatriculaPeriodoVO> consultarDadosFichaAlunoPorMatricula(MatriculaVO matriculaVO, UsuarioVO usuarioVO) {
		StringBuilder sb = new StringBuilder();
		sb.append("select matriculaperiodo.codigo, matriculaperiodo.data, matriculaperiodo.matricula, matriculaperiodo.situacaomatriculaperiodo, matriculaperiodo.situacao, matriculaperiodo.ano, matriculaperiodo.semestre, ");
		sb.append(" turma.codigo AS \"turma.codigo\", turma.identificadorTurma, ");
		sb.append(" turno.codigo AS \"turno.codigo\", turno.nome AS \"turno.nome\", ");
		sb.append(" gradeCurricular.codigo AS \"gradeCurricular.codigo\", gradeCurricular.nome AS \"gradeCurricular.nome\", ");
		sb.append(" periodoLetivo.codigo AS \"periodoLetivo.codigo\", periodoLetivo.descricao AS \"periodoLetivo.descricao\", ");
		sb.append(" planofinanceirocurso.codigo AS \"planofinanceirocurso.codigo\", planofinanceirocurso.descricao AS \"planofinanceirocurso.descricao\", ");
		sb.append(" condicaopagamentoplanofinanceirocurso.codigo AS \"condicaopagamentoplanofinanceirocurso.codigo\", condicaopagamentoplanofinanceirocurso.descricao AS \"condicaopagamentoplanofinanceirocurso.descricao\", matriculaperiodo.categoriaCondicaoPagamento AS \"matriculaperiodo.categoriaCondicaoPagamento\" ");
		sb.append(" from matriculaperiodo ");
		sb.append(" inner join turma on turma.codigo = matriculaperiodo.turma ");
		sb.append(" inner join gradecurricular on gradecurricular.codigo = matriculaperiodo.gradecurricular ");
		sb.append(" inner join periodoletivo on periodoletivo.codigo = matriculaperiodo.periodoletivomatricula ");
		sb.append(" inner join unidadeensinocurso on unidadeensinocurso.codigo = matriculaperiodo.unidadeensinocurso ");
		sb.append(" inner join turno on turno.codigo = unidadeensinocurso.turno ");
		sb.append(" left join planofinanceirocurso on planofinanceirocurso.codigo = matriculaperiodo.planofinanceirocurso ");
		sb.append(" left join condicaopagamentoplanofinanceirocurso on condicaopagamentoplanofinanceirocurso.codigo = matriculaperiodo.condicaopagamentoplanofinanceirocurso ");
		sb.append(" where matriculaperiodo.matricula = '").append(matriculaVO.getMatricula()).append("' ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sb.toString());
		List<MatriculaPeriodoVO> listaMatriculaPeriodoVOs = new ArrayList<MatriculaPeriodoVO>(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setData(tabelaResultado.getDate("data"));
			obj.setSituacaoMatriculaPeriodo(tabelaResultado.getString("situacaoMatriculaPeriodo"));
			obj.setSituacao(tabelaResultado.getString("situacao"));
			obj.setAno(tabelaResultado.getString("ano"));
			obj.setSemestre(tabelaResultado.getString("semestre"));
			obj.setMatricula(tabelaResultado.getString("matricula"));
			obj.getMatriculaVO().setMatricula(matriculaVO.getMatricula());
			obj.setMatriculaVO(matriculaVO);
			
			obj.getTurma().setCodigo(tabelaResultado.getInt("turma.codigo"));
			obj.getTurma().setIdentificadorTurma(tabelaResultado.getString("identificadorTurma"));
			
			obj.getGradeCurricular().setCodigo(tabelaResultado.getInt("gradeCurricular.codigo"));
			obj.getGradeCurricular().setNome(tabelaResultado.getString("gradeCurricular.nome"));
			
			obj.getPeriodoLetivo().setCodigo(tabelaResultado.getInt("periodoLetivo.codigo"));
			obj.getPeriodoLetivo().setDescricao(tabelaResultado.getString("periodoLetivo.descricao"));
			
			obj.getUnidadeEnsinoCursoVO().getTurno().setCodigo(tabelaResultado.getInt("turno.codigo"));
			obj.getUnidadeEnsinoCursoVO().getTurno().setNome(tabelaResultado.getString("turno.nome"));
			
			obj.getPlanoFinanceiroCurso().setCodigo(tabelaResultado.getInt("planofinanceirocurso.codigo"));
			obj.getPlanoFinanceiroCurso().setDescricao(tabelaResultado.getString("planofinanceirocurso.descricao"));
			
			obj.getCondicaoPagamentoPlanoFinanceiroCurso().setCodigo(tabelaResultado.getInt("condicaopagamentoplanofinanceirocurso.codigo"));
			obj.getCondicaoPagamentoPlanoFinanceiroCurso().setDescricao(tabelaResultado.getString("condicaopagamentoplanofinanceirocurso.descricao"));
			
			obj.setCategoriaCondicaoPagamento(tabelaResultado.getString("matriculaperiodo.categoriaCondicaoPagamento"));
			
			listaMatriculaPeriodoVOs.add(obj);
		}
		return listaMatriculaPeriodoVOs;
		
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gerarContaPagarRestituirAlunoValorJaPagoParcelaEspecifica(Date dataVcto, Double valorRestituir, MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodo, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO,  UsuarioVO usuario) throws Exception {
		matriculaPeriodo.setContaPagarRestituicaoVO(getFacadeFactory().getContaPagarFacade().consultaRapidaContaPagarRestituicaoValorPorMatriculaPeriodo(matricula.getMatricula(), matriculaPeriodo.getCodigo(), Uteis.NIVELMONTARDADOS_COMBOBOX, usuario));
		String descricaoPagamento = "Restituição de valor pago pelo aluno nas mensalidades";
		if (!Uteis.isAtributoPreenchido(matriculaPeriodo.getContaPagarRestituicaoVO())) {
			// Se não foi encontrada nenhum conta a pagar, então podemos gerar a
			// conta a pagar
			// de restituição sem nenhum tipo de restrição.
			matriculaPeriodo.setContaPagarRestituicaoVO(getFacadeFactory().getContaPagarFacade().criarContaPagarRestituirValorJaPagoPorAlunoConvenio(dataVcto, valorRestituir, "1/1", matricula, matriculaPeriodo, OrigemContaPagar.RESTITUICAO_VALOR_MATRICULA_PERIODO, descricaoPagamento, null, configuracaoFinanceiroVO.getCategoriaDespesaPadraoRestituicaoAluno(), usuario));
			
			//getFacadeFactory().getContaPagarFacade().incluir(contaPagar, usuario);
		} else {
			// Se encontramos uma conta a pagar, precisamos verificar as
			// seguintes situaï¿½ï¿½es:
			if (!matriculaPeriodo.getContaPagarRestituicaoVO().getQuitada()) {
				getFacadeFactory().getContaPagarFacade().excluir(matriculaPeriodo.getContaPagarRestituicaoVO(), false, usuario);
				// a) Se a conta a pagar não estão quitada (baixada) então a
				// mesma será removida e uma nova conta a pagar
				// será criada em substituiï¿½ï¿½o ï¿½ existente. Isto irá
				// garantir que os dados da mesma estejam devidamente
				// atualizadas.
				matriculaPeriodo.setContaPagarRestituicaoVO(getFacadeFactory().getContaPagarFacade().criarContaPagarRestituirValorJaPagoPorAlunoConvenio(dataVcto, valorRestituir, "1/1", matricula, matriculaPeriodo, OrigemContaPagar.RESTITUICAO_VALOR_MATRICULA_PERIODO, descricaoPagamento, null, configuracaoFinanceiroVO.getCategoriaDespesaPadraoRestituicaoAluno(), usuario));
				//getFacadeFactory().getContaPagarFacade().incluir(contaPagar, usuario);
			} else {
				if (matriculaPeriodo.getContaPagarRestituicaoVO().getValor().equals(valorRestituir)) {
					// b) Se a conta a pagar existir e já estirver pagar, o
					// sistema irá verificar se o valor da mesma ï¿½ idï¿½ntico
					// ao que estão sendo definido para geração da restituição.
					// Caso o valor seja igual, signigica que o valor
					// que tem que ser devolvido ao aluno, já foi entregue ao
					// mesmo. Assim, o Método não farï¿½ mais nada	
					matriculaPeriodo.getContaPagarRestituicaoVO().setValorAlterar(0.0);					
					return;
				} else {
					// Caso o valor seja diferente, então o sistema
					// irá throws, pois o aluno foi restituï¿½do de um valor
					// diferernte do que o sistema estão deduzindo para
					// restituir. Isto terï¿½ que ser investigado e/ou tratado
					// de outras formas.
					throw new Exception("O aluno possui um valor a ser restituido pendente de R$ " + Uteis.getDoubleFormatado(valorRestituir) + ". Contudo verificamos que a CONTA A PAGAR para restituição ao aluno já está PAGA/NEGOCIADA. Neste caso é necessário realizar o estorno do PAGAMENTO/NEGOCIAÇÃO da conta a pagar da matrícula "+matricula.getMatricula()+" com vencimento em "+matriculaPeriodo.getContaPagarRestituicaoVO().getDataVencimento_Apresentar()+" para realizar esta operação.");
				}
			}
		}
	}
	
	private void realizarDefinicaoContaPagarRestituicaoAluno(MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuarioVO) throws Exception{
		if(matriculaPeriodoVO.getContaPagarRestituicaoVO().getValor() > 0 && matriculaPeriodoVO.getContaPagarRestituicaoVO().isNovoObj()){
			getFacadeFactory().getContaPagarFacade().incluir(matriculaPeriodoVO.getContaPagarRestituicaoVO(), false, true, usuarioVO);
			return;
		}		
		if (Uteis.isAtributoPreenchido(matriculaPeriodoVO.getContaPagarRestituicaoVO())) {
			if(matriculaPeriodoVO.getContaPagarRestituicaoVO().getQuitada()){
				if(matriculaPeriodoVO.getContaPagarRestituicaoVO().getValorAlterar() > 0){
					throw new Exception("O aluno possui um valor de R$ " + Uteis.getDoubleFormatado(matriculaPeriodoVO.getContaPagarRestituicaoVO().getValor()) + " que foi restituido ao aluno através da conta a pagar com vencimento no dia "+matriculaPeriodoVO.getContaPagarRestituicaoVO().getDataVencimento_Apresentar()+", para realizar esta operação é necessário estornar o pagamento/negociação da mesma.");
				}
			}else{
				getFacadeFactory().getContaPagarFacade().excluir(matriculaPeriodoVO.getContaPagarRestituicaoVO(), false, usuarioVO);
				matriculaPeriodoVO.setContaPagarRestituicaoVO(null);
			}
		}
	}
	
	public MatriculaPeriodoContaReceberLogVO realizarPreenchimentoAlteracaoContaReceberPorMatriculaPeriodoVencimento(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO contaNova, MatriculaPeriodoVencimentoVO contaVelha, Map<String, UsuarioVO> mapaParcelaDesconsiderarRateio) throws Exception{
		MatriculaPeriodoContaReceberLogVO matriculaPeriodoContaReceberLogVO = new MatriculaPeriodoContaReceberLogVO();
		if(Uteis.isAtributoPreenchido(contaVelha.getContaReceber())){
			matriculaPeriodoContaReceberLogVO.setParcelaAntiga(contaVelha.getContaReceber().getParcela());
			matriculaPeriodoContaReceberLogVO.setAcrescimoAntiga(contaVelha.getContaReceber().getAcrescimo());
			matriculaPeriodoContaReceberLogVO.setDataVencimentoAntiga(contaVelha.getDataVencimento());
			matriculaPeriodoContaReceberLogVO.setDescontoProgressivoAntigaVO(contaVelha.getContaReceber().getDescontoProgressivo());
			matriculaPeriodoContaReceberLogVO.setValorAntiga(contaVelha.getContaReceber().getValor());
			matriculaPeriodoContaReceberLogVO.setValorDescontoAlunoAntiga(contaVelha.getContaReceber().getValorDescontoAlunoJaCalculado());
			matriculaPeriodoContaReceberLogVO.setValorBaseAntiga(contaVelha.getContaReceber().getValorBaseContaReceber());
			matriculaPeriodoContaReceberLogVO.setValorCusteadoAntiga(contaVelha.getContaReceber().getValorCusteadoContaReceber());
			matriculaPeriodoContaReceberLogVO.setValorDescontoConvenioAntiga(contaVelha.getContaReceber().getValorDescontoConvenio());
			matriculaPeriodoContaReceberLogVO.setValorDescontoInstituicaoAntiga(contaVelha.getContaReceber().getValorDescontoInstituicao());
			matriculaPeriodoContaReceberLogVO.setValorDescontoProgressivoAntiga(contaVelha.getContaReceber().getValorDescontoProgressivo());
			matriculaPeriodoContaReceberLogVO.setValorDescontoRateioAntiga(contaVelha.getContaReceber().getValorDescontoRateio());
			matriculaPeriodoContaReceberLogVO.setValorDescontoRecebimentoAntiga(contaVelha.getContaReceber().getValorCalculadoDescontoLancadoRecebimento());
			matriculaPeriodoContaReceberLogVO.setJuroAntiga(contaVelha.getContaReceber().getJuro());
			matriculaPeriodoContaReceberLogVO.setMultaAntiga(contaVelha.getContaReceber().getMulta());
			matriculaPeriodoContaReceberLogVO.setSituacaoAntiga(SituacaoContaReceber.getEnum(contaVelha.getContaReceber().getSituacao()));
			matriculaPeriodoContaReceberLogVO.setValorReceberAntiga(contaVelha.getContaReceber().getValorRecebido());
			matriculaPeriodoContaReceberLogVO.setValorRecebidoAntiga(contaVelha.getContaReceber().getValorFinalCalculado());
			matriculaPeriodoContaReceberLogVO.setContaEditadaManualmente(contaVelha.getContaReceber().getContaEditadaManualmente());
			Ordenacao.ordenarLista(contaVelha.getContaReceber().getPlanoDescontoContaReceberVOs(), "ordenacao");
			for(PlanoDescontoContaReceberVO planoDescontoContaReceberVO: contaVelha.getContaReceber().getPlanoDescontoContaReceberVOs()){
				MatriculaPeriodoContaReceberPlanoDescontoConvenioVO matriculaPeriodoContaReceberPlanoDescontoConvenioVO = new MatriculaPeriodoContaReceberPlanoDescontoConvenioVO();
				matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setConvenio(planoDescontoContaReceberVO.getConvenio());
				matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setPlanoDescontoVO(planoDescontoContaReceberVO.getPlanoDescontoVO());
				matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setTipoItemPlanoFinanceiro(planoDescontoContaReceberVO.getTipoItemPlanoFinanceiro());
				matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setValorUtilizadoRecebimento(planoDescontoContaReceberVO.getValorUtilizadoRecebimento());
				matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setUtilizado(planoDescontoContaReceberVO.getUtilizado());
				if(contaVelha.getParcelaReferenteMatricula() && planoDescontoContaReceberVO.getIsConvenio() && planoDescontoContaReceberVO.getConvenio().getAbaterDescontoNoValorMatricula()){
					matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberConvenioCusteadoAntigaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
				}else if(!contaVelha.getParcelaReferenteMatricula()  && planoDescontoContaReceberVO.getIsConvenio() && planoDescontoContaReceberVO.getConvenio().getAbaterDescontoNoValorParcela()){
					matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberConvenioCusteadoAntigaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
				}else{
					matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberPlanoDescontoConvenioAntigaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
				}
			}
		}else{
			matriculaPeriodoContaReceberLogVO.setValorAntiga(contaVelha.getValor());
			matriculaPeriodoContaReceberLogVO.setParcelaAntiga(contaVelha.getParcela());
			matriculaPeriodoContaReceberLogVO.setDataVencimentoAntiga(contaVelha.getDataVencimento());
			matriculaPeriodoContaReceberLogVO.setValorDescontoRateioAntiga(contaVelha.getValorDesconto());
			matriculaPeriodoContaReceberLogVO.setValorBaseAntiga(contaVelha.getValor());
			matriculaPeriodoContaReceberLogVO.setValorReceberAntiga(contaVelha.getValorDescontoCalculadoPrimeiraFaixaDescontos());			
			matriculaPeriodoContaReceberLogVO.setValorRecebidoAntiga(contaVelha.getValorDescontoCalculadoPrimeiraFaixaDescontos());
		}
		if(contaNova != null){
			matriculaPeriodoContaReceberLogVO.setParcelaNova(contaNova.getParcela());
			matriculaPeriodoContaReceberLogVO.setValorNova(contaNova.getValor());
			matriculaPeriodoContaReceberLogVO.setValorBaseNova(contaNova.getValor());
			matriculaPeriodoContaReceberLogVO.setValorReceberNova(contaNova.getValorDescontoCalculadoPrimeiraFaixaDescontos());
			matriculaPeriodoContaReceberLogVO.setValorDescontoRateioNova(contaNova.getValorDesconto());
			matriculaPeriodoContaReceberLogVO.setValorRecebidoNova(contaNova.getValorDescontoCalculadoPrimeiraFaixaDescontos());
			matriculaPeriodoContaReceberLogVO.setDataVencimentoNova(contaVelha.getContaReceber().getDataVencimento());
			PlanoFinanceiroAlunoDescricaoDescontosVO desc = null;
			if(contaNova.getParcelaReferenteMatricula()){
				if(!matriculaPeriodoVO.getListaDescontosMatricula().isEmpty()){
					desc = matriculaPeriodoVO.getListaDescontosMatricula().get(0);
				}
			}else if(!contaNova.getParcela().contains("EX") && !contaNova.isUsaValorPrimeiraParcela()){
				Integer contabilizarParcelaEntrada = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isUsaValorPrimeiraParcela() ? 1 : 0;
				for(MatriculaPeriodoMensalidadeCalculadaVO matriculaPeriodoMensalidadeCalculadaVO : matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs()){
					if(matriculaPeriodoMensalidadeCalculadaVO.getParcelaInicial() <= Integer.valueOf(contaNova.getParcela().substring(0, contaNova.getParcela().indexOf("/"))) 
					&& (contabilizarParcelaEntrada + matriculaPeriodoMensalidadeCalculadaVO.getParcelaFinal()) >= Integer.valueOf(contaNova.getParcela().substring(0, contaNova.getParcela().indexOf("/")))){
						if(!matriculaPeriodoMensalidadeCalculadaVO.getListaDescontosMensalidade().isEmpty()){
							desc = matriculaPeriodoMensalidadeCalculadaVO.getListaDescontosMensalidade().get(0);
						}
					}
				}
			}else if(desc ==  null && contaNova.isUsaValorPrimeiraParcela() 
					&& Uteis.isAtributoPreenchido(matriculaPeriodoVO.getMatriculaPeriodoMensalidadeEntradaCalculadaVOs())
					&& Uteis.isAtributoPreenchido(matriculaPeriodoVO.getMatriculaPeriodoMensalidadeEntradaCalculadaVOs().get(0).getListaDescontosMensalidade())){
				desc = matriculaPeriodoVO.getMatriculaPeriodoMensalidadeEntradaCalculadaVOs().get(0).getListaDescontosMensalidade().get(0);
			}
			if(desc != null){
				matriculaPeriodoContaReceberLogVO.setDescontoProgressivoNovaVO(desc.getDescontoProgressivoVO());
				matriculaPeriodoContaReceberLogVO.setValorNova(desc.getValorBase()-desc.getValorCusteadoContaReceber());
				matriculaPeriodoContaReceberLogVO.setValorDescontoAlunoNova(desc.getValorDescontoAluno());
				matriculaPeriodoContaReceberLogVO.setValorBaseNova(desc.getValorBase());
				matriculaPeriodoContaReceberLogVO.setValorCusteadoNova(desc.getValorCusteadoContaReceber());
				matriculaPeriodoContaReceberLogVO.setValorDescontoConvenioNova(desc.getValorDescontoConvenio());
				matriculaPeriodoContaReceberLogVO.setValorDescontoInstituicaoNova(desc.getValorDescontoInstituicao());
				matriculaPeriodoContaReceberLogVO.setValorDescontoProgressivoNova(desc.getValorDescontoProgressivo());
				matriculaPeriodoContaReceberLogVO.setValorDescontoRateioNova(desc.getValorDescontoRateio());
				matriculaPeriodoContaReceberLogVO.setValorReceberNova(desc.getValorBaseComDescontosJaCalculadosAplicados());
				matriculaPeriodoContaReceberLogVO.setValorRecebidoNova(desc.getValorBaseComDescontosJaCalculadosAplicados());
				Double valorTotalDescontoNaoRestituir = 0.0; 
				for(Integer convenio : desc.getListaDescontosConvenio().keySet()){
					for(ItemPlanoFinanceiroAlunoVO itemPlanoFinanceiroAlunoVO: matriculaPeriodoVO.getMatriculaVO().getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()){
						if(itemPlanoFinanceiroAlunoVO.getTipoPlanoFinanceiroConvenio() && itemPlanoFinanceiroAlunoVO.getConvenio().getCodigo().equals(convenio)){						
							MatriculaPeriodoContaReceberPlanoDescontoConvenioVO matriculaPeriodoContaReceberPlanoDescontoConvenioVO = new MatriculaPeriodoContaReceberPlanoDescontoConvenioVO();
							matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setConvenio(itemPlanoFinanceiroAlunoVO.getConvenio());						
							matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setTipoItemPlanoFinanceiro(itemPlanoFinanceiroAlunoVO.getTipoItemPlanoFinanceiro());
							matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setValorUtilizadoRecebimento(desc.getListaDescontosConvenio().get(convenio));
							if(contaNova.getParcelaReferenteMatricula() && itemPlanoFinanceiroAlunoVO.getConvenio().getAbaterDescontoNoValorMatricula()){
								matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberConvenioCusteadoNovaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
							}else if(!contaNova.getParcelaReferenteMatricula() && itemPlanoFinanceiroAlunoVO.getConvenio().getAbaterDescontoNoValorParcela()){
								matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberConvenioCusteadoNovaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
							}else{
								matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberPlanoDescontoConvenioNovaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
							}
							matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setValorConvenioNaoRestituirAluno(calcularValorConvenioNaoRestituirAluno(matriculaPeriodoVO, itemPlanoFinanceiroAlunoVO.getConvenio(), desc.getListaDescontosConvenio().get(convenio), contaVelha));
							if(matriculaPeriodoContaReceberPlanoDescontoConvenioVO.getValorConvenioNaoRestituirAluno() > 0){
								matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberPlanoConvenioNaoRestituitAlunoVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
								valorTotalDescontoNaoRestituir += matriculaPeriodoContaReceberPlanoDescontoConvenioVO.getValorConvenioNaoRestituirAluno();
							}
							break;
						}
					}
					
				}
				matriculaPeriodoContaReceberLogVO.setValorConvenioNaoRestituirAluno(valorTotalDescontoNaoRestituir);
				for(Integer planoDesconto : desc.getListaDescontosPlanoDesconto().keySet()){
					for(ItemPlanoFinanceiroAlunoVO itemPlanoFinanceiroAlunoVO: matriculaPeriodoVO.getMatriculaVO().getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()){
						if(itemPlanoFinanceiroAlunoVO.getTipoPlanoFinanceiroDescontoInstitucional() && itemPlanoFinanceiroAlunoVO.getPlanoDesconto().getCodigo().equals(planoDesconto)){											
							MatriculaPeriodoContaReceberPlanoDescontoConvenioVO matriculaPeriodoContaReceberPlanoDescontoConvenioVO = new MatriculaPeriodoContaReceberPlanoDescontoConvenioVO();
							matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setPlanoDescontoVO(itemPlanoFinanceiroAlunoVO.getPlanoDesconto());
							matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setTipoItemPlanoFinanceiro(itemPlanoFinanceiroAlunoVO.getTipoItemPlanoFinanceiro());
							matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setValorUtilizadoRecebimento(desc.getListaDescontosPlanoDesconto().get(planoDesconto));
							matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberPlanoDescontoConvenioNovaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
							break;
						}
					}
					
				}
			}	
		}else{
			matriculaPeriodoContaReceberLogVO.setParcelaNova(contaVelha.getParcela());
			matriculaPeriodoContaReceberLogVO.setValorNova(0.0);
			matriculaPeriodoContaReceberLogVO.setValorBaseNova(0.0);
			matriculaPeriodoContaReceberLogVO.setValorReceberNova(0.0);
			matriculaPeriodoContaReceberLogVO.setValorDescontoRateioNova(0.0);
			matriculaPeriodoContaReceberLogVO.setValorRecebidoNova(0.0);
			matriculaPeriodoContaReceberLogVO.setDataVencimentoNova(contaVelha.getDataVencimento());
		}
		matriculaPeriodoContaReceberLogVO.setValorCalculadoComDescontoAplicado(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioBaseadoValorBaseComDescontosAplicados());
		if(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioBaseadoValorBaseComDescontosAplicados()){
			matriculaPeriodoContaReceberLogVO.setDiferencaParcela(Uteis.arrendondarForcando2CadasDecimais(matriculaPeriodoContaReceberLogVO.getValorReceberNova()-matriculaPeriodoContaReceberLogVO.getValorReceberAntiga()));
		}else{
			matriculaPeriodoContaReceberLogVO.setDiferencaParcela(Uteis.arrendondarForcando2CadasDecimais(matriculaPeriodoContaReceberLogVO.getValorNova()-matriculaPeriodoContaReceberLogVO.getValorAntiga()));
		}
		if(Uteis.isAtributoPreenchido(mapaParcelaDesconsiderarRateio) && mapaParcelaDesconsiderarRateio.containsKey(matriculaPeriodoContaReceberLogVO.getParcelaAntiga())) {
			matriculaPeriodoContaReceberLogVO.setLiberadoDiferencaValorRateio(true);
			matriculaPeriodoContaReceberLogVO.setResponsavelLiberadoDiferencaValorRateio(mapaParcelaDesconsiderarRateio.get(matriculaPeriodoContaReceberLogVO.getParcelaAntiga()));
		}
//		if(matriculaPeriodoContaReceberLogVO.getValorConvenioNaoRestituirAluno() > 0 
//				&& matriculaPeriodoContaReceberLogVO.getDiferencaParcela() < 0
//				&& matriculaPeriodoContaReceberLogVO.getDiferencaParcela()*-1 < matriculaPeriodoContaReceberLogVO.getValorConvenioNaoRestituirAluno()
//				&& matriculaPeriodoContaReceberLogVO.isLiberadoDiferencaValorRateio()) {
//			matriculaPeriodoContaReceberLogVO.setValorConvenioNaoRestituirAluno(matriculaPeriodoContaReceberLogVO.getDiferencaParcela()*-1);
//		}
		return matriculaPeriodoContaReceberLogVO;
	} 
	
	public Double calcularValorConvenioNaoRestituirAluno(MatriculaPeriodoVO matriculaPeriodoVO){
		Double valorConveniNaoRestituir = 0.0;
		matriculaPeriodoVO.setValorConvenioNaoRestituirAluno(0.0);
		matriculaPeriodoVO.getListaConvenioNaoRestituiAluno().clear();
		for(ItemPlanoFinanceiroAlunoVO itemPlanoFinanceiroAlunoVO: matriculaPeriodoVO.getMatriculaVO().getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()){
			if(itemPlanoFinanceiroAlunoVO.getTipoPlanoFinanceiroConvenio() 
					&& !itemPlanoFinanceiroAlunoVO.getConvenio().getGerarRestituicaoAlunoValorJaPagoRelativoAoConvenio() 
					&& !matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().isEmpty() 
					&& !matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().get(0).getListaDescontosMensalidade().isEmpty()){
				Double valorConvenio = 0.0;
				for(Integer codigo : matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().get(0).getListaDescontosMensalidade().get(0).getListaDescontosConvenio().keySet()){
					if(codigo.equals(itemPlanoFinanceiroAlunoVO.getConvenio().getCodigo())){
						valorConvenio = matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().get(0).getListaDescontosMensalidade().get(0).getListaDescontosConvenio().get(codigo);
					}
				}
				if(valorConvenio > 0){
					for(MatriculaPeriodoVencimentoVO vctoGerar: matriculaPeriodoVO.getMatriculaPeriodoVencimentoVOs()){
						valorConveniNaoRestituir += calcularValorConvenioNaoRestituirAluno(matriculaPeriodoVO, itemPlanoFinanceiroAlunoVO.getConvenio(), valorConvenio, vctoGerar);
					}
					
				}
			}
		}
		return valorConveniNaoRestituir;
	}
	
	public Double calcularValorConvenioNaoRestituirAluno(MatriculaPeriodoVO matriculaPeriodoVO, ConvenioVO convenioVO, Double valorConvenio, MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO){
		Double valorConveniNaoRestituir = 0.0;
		if((matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA_EPAGA) || matriculaPeriodoVencimentoVO.getSituacao().equals(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_RENEGOCIADA)) 
				&& !matriculaPeriodoVencimentoVO.getParcela().contains("EX") && valorConvenio > 0
				&& !matriculaPeriodoVencimentoVO.isUsaValorPrimeiraParcela()
				&& !convenioVO.getGerarRestituicaoAlunoValorJaPagoRelativoAoConvenio() 
				&& !matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().isEmpty() 
				&&  (matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioBaseadoValorBaseComDescontosAplicados()
						|| (convenioVO.getAbaterDescontoNoValorParcela() && !matriculaPeriodoVencimentoVO.getTipoOrigemMatriculaPeriodoVencimento().isMatricula())
						|| (convenioVO.getAbaterDescontoNoValorMatricula() && matriculaPeriodoVencimentoVO.getTipoOrigemMatriculaPeriodoVencimento().isMatricula()))
				&& !matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs().get(0).getListaDescontosMensalidade().isEmpty()){						
				boolean desconsiderarDescontoConvenio = true;
				for (PlanoDescontoContaReceberVO planoContaReceber : matriculaPeriodoVencimentoVO.getContaReceber().getPlanoDescontoContaReceberVOs()) {
					if(planoContaReceber.getConvenio().getCodigo().equals(convenioVO.getCodigo())){
						desconsiderarDescontoConvenio =  false;
					}
				}
				if(desconsiderarDescontoConvenio){
					valorConveniNaoRestituir += valorConvenio;
					boolean convenioAdd = false;
					for(ConvenioVO convenioVO2: matriculaPeriodoVO.getListaConvenioNaoRestituiAluno()){
						if(convenioVO2.getCodigo().equals(convenioVO.getCodigo())){
							convenioAdd = true;
							break;
						}
					}
					if(!convenioAdd){
					     matriculaPeriodoVO.getListaConvenioNaoRestituiAluno().add(convenioVO);
					}
				}						
		}
		return valorConveniNaoRestituir;
	}
	

	public void realizarPrevisaoContaReceberImpactadasPorAlteracaoFinanceira(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, Double valorRateioExtra, ConfiguracaoFinanceiroVO configuracaoFinanceiro, UsuarioVO usuario) throws Exception{
		List<MatriculaPeriodoVencimentoVO> listaVctosGerados = gerarVencimentosMensalidades(matriculaPeriodoVO, usuario);
		registrarParcelasGeradasAindaNaoPagas_ContabilizandoValorDiferencaCobrarComRelacaoValorPago(listaVctosGerados, matriculaVO, matriculaPeriodoVO, valorRateioExtra, configuracaoFinanceiro, true, usuario);
	}
	
	public MatriculaPeriodoContaReceberLogVO realizarPreenchimentoContaReceberSeraIncluidaPorMatriculaPeriodoVencimento(MatriculaPeriodoVO matriculaPeriodoVO, MatriculaPeriodoVencimentoVO contaNova, OperacaoMatriculaPeriodoContaLogEnum operacaoMatriculaPeriodoContaLog) throws Exception{
		MatriculaPeriodoContaReceberLogVO matriculaPeriodoContaReceberLogVO = new MatriculaPeriodoContaReceberLogVO();
		matriculaPeriodoContaReceberLogVO.setOperacaoMatriculaPeriodoContaLog(operacaoMatriculaPeriodoContaLog);
		matriculaPeriodoContaReceberLogVO.setParcelaNova(contaNova.getParcela());
		matriculaPeriodoContaReceberLogVO.setValorNova(contaNova.getValor());
		matriculaPeriodoContaReceberLogVO.setValorBaseNova(contaNova.getValor());
		matriculaPeriodoContaReceberLogVO.setValorReceberNova(contaNova.getValorDescontoCalculadoPrimeiraFaixaDescontos()+contaNova.getAcrescimoExtra());
		matriculaPeriodoContaReceberLogVO.setValorDescontoRateioNova(contaNova.getValorDesconto());
		matriculaPeriodoContaReceberLogVO.setValorRecebidoNova(contaNova.getValorDescontoCalculadoPrimeiraFaixaDescontos()+contaNova.getAcrescimoExtra());
		matriculaPeriodoContaReceberLogVO.setAcrescimoNova(contaNova.getAcrescimoExtra());
		matriculaPeriodoContaReceberLogVO.setDataVencimentoNova(contaNova.getDataVencimento());
		PlanoFinanceiroAlunoDescricaoDescontosVO desc = null;
		if(contaNova.getParcelaReferenteMatricula()){
			if(!matriculaPeriodoVO.getListaDescontosMatricula().isEmpty()){
				desc = matriculaPeriodoVO.getListaDescontosMatricula().get(0);
			}
		}else if(!contaNova.getParcela().contains("EX") && !contaNova.getParcela().contains("PG") && !contaNova.isUsaValorPrimeiraParcela()){
			Integer contabilizarParcelaEntrada = matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().isUsaValorPrimeiraParcela() ? 1 : 0;
			for(MatriculaPeriodoMensalidadeCalculadaVO matriculaPeriodoMensalidadeCalculadaVO : matriculaPeriodoVO.getMatriculaPeriodoMensalidadeCalculadaVOs()){
				if(matriculaPeriodoMensalidadeCalculadaVO.getParcelaInicial() <= Integer.valueOf(contaNova.getParcela().substring(0, contaNova.getParcela().indexOf("/"))) 
				&& (contabilizarParcelaEntrada + matriculaPeriodoMensalidadeCalculadaVO.getParcelaFinal()) >= Integer.valueOf(contaNova.getParcela().substring(0, contaNova.getParcela().indexOf("/")))){
					if(!matriculaPeriodoMensalidadeCalculadaVO.getListaDescontosMensalidade().isEmpty()){
						desc = matriculaPeriodoMensalidadeCalculadaVO.getListaDescontosMensalidade().get(0);
					}
				}
			}
		}else if(desc == null && contaNova.isUsaValorPrimeiraParcela() 
			&& Uteis.isAtributoPreenchido(matriculaPeriodoVO.getMatriculaPeriodoMensalidadeEntradaCalculadaVOs())
			&& Uteis.isAtributoPreenchido(matriculaPeriodoVO.getMatriculaPeriodoMensalidadeEntradaCalculadaVOs().get(0).getListaDescontosMensalidade())){
			desc = matriculaPeriodoVO.getMatriculaPeriodoMensalidadeEntradaCalculadaVOs().get(0).getListaDescontosMensalidade().get(0);
		}
		if(desc != null){			
			matriculaPeriodoContaReceberLogVO.setDescontoProgressivoNovaVO(desc.getDescontoProgressivoVO());
			matriculaPeriodoContaReceberLogVO.setValorNova(desc.getValorBase()-desc.getValorCusteadoContaReceber());
			matriculaPeriodoContaReceberLogVO.setValorDescontoAlunoNova(desc.getValorDescontoAluno());
			matriculaPeriodoContaReceberLogVO.setValorBaseNova(desc.getValorBase());
			matriculaPeriodoContaReceberLogVO.setValorCusteadoNova(desc.getValorCusteadoContaReceber());
			matriculaPeriodoContaReceberLogVO.setValorDescontoConvenioNova(desc.getValorDescontoConvenio());
			matriculaPeriodoContaReceberLogVO.setValorDescontoInstituicaoNova(desc.getValorDescontoInstituicao());
			matriculaPeriodoContaReceberLogVO.setValorDescontoProgressivoNova(desc.getValorDescontoProgressivo());
			matriculaPeriodoContaReceberLogVO.setValorDescontoRateioNova(contaNova.getValorDesconto());
			matriculaPeriodoContaReceberLogVO.setValorReceberNova( Uteis.arrendondarForcando2CadasDecimais(desc.getValorBaseComDescontosJaCalculadosAplicados()-contaNova.getValorDesconto()+contaNova.getAcrescimoExtra()));
			matriculaPeriodoContaReceberLogVO.setValorRecebidoNova(Uteis.arrendondarForcando2CadasDecimais(desc.getValorBaseComDescontosJaCalculadosAplicados()-contaNova.getValorDesconto()+contaNova.getAcrescimoExtra()));
			Double valorTotalDescontoNaoRestituir = 0.0; 
			for(Integer convenio : desc.getListaDescontosConvenio().keySet()){
				for(ItemPlanoFinanceiroAlunoVO itemPlanoFinanceiroAlunoVO: matriculaPeriodoVO.getMatriculaVO().getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()){
					if(itemPlanoFinanceiroAlunoVO.getTipoPlanoFinanceiroConvenio() && itemPlanoFinanceiroAlunoVO.getConvenio().getCodigo().equals(convenio)){						
						MatriculaPeriodoContaReceberPlanoDescontoConvenioVO matriculaPeriodoContaReceberPlanoDescontoConvenioVO = new MatriculaPeriodoContaReceberPlanoDescontoConvenioVO();
						matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setConvenio(itemPlanoFinanceiroAlunoVO.getConvenio());						
						matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setTipoItemPlanoFinanceiro(itemPlanoFinanceiroAlunoVO.getTipoItemPlanoFinanceiro());
						matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setValorUtilizadoRecebimento(desc.getListaDescontosConvenio().get(convenio));
						if(contaNova.getParcelaReferenteMatricula() && itemPlanoFinanceiroAlunoVO.getConvenio().getAbaterDescontoNoValorMatricula()){
							matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberConvenioCusteadoNovaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
						}else if(!contaNova.getParcelaReferenteMatricula() && itemPlanoFinanceiroAlunoVO.getConvenio().getAbaterDescontoNoValorParcela()){
							matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberConvenioCusteadoNovaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
						}else{
							matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberPlanoDescontoConvenioNovaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
						}						
						if(matriculaPeriodoContaReceberPlanoDescontoConvenioVO.getValorConvenioNaoRestituirAluno() > 0){
							matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberPlanoConvenioNaoRestituitAlunoVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
							valorTotalDescontoNaoRestituir += matriculaPeriodoContaReceberPlanoDescontoConvenioVO.getValorConvenioNaoRestituirAluno();
						}
						break;
					}
				}
				
			}
			matriculaPeriodoContaReceberLogVO.setValorConvenioNaoRestituirAluno(valorTotalDescontoNaoRestituir);
			for(Integer planoDesconto : desc.getListaDescontosPlanoDesconto().keySet()){
				for(ItemPlanoFinanceiroAlunoVO itemPlanoFinanceiroAlunoVO: matriculaPeriodoVO.getMatriculaVO().getPlanoFinanceiroAluno().getItemPlanoFinanceiroAlunoVOs()){
					if(itemPlanoFinanceiroAlunoVO.getTipoPlanoFinanceiroDescontoInstitucional() && itemPlanoFinanceiroAlunoVO.getPlanoDesconto().getCodigo().equals(planoDesconto) && desc.getListaDescontosPlanoDesconto().get(planoDesconto) > 0.0){											
						MatriculaPeriodoContaReceberPlanoDescontoConvenioVO matriculaPeriodoContaReceberPlanoDescontoConvenioVO = new MatriculaPeriodoContaReceberPlanoDescontoConvenioVO();
						matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setPlanoDescontoVO(itemPlanoFinanceiroAlunoVO.getPlanoDesconto());
						matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setTipoItemPlanoFinanceiro(itemPlanoFinanceiroAlunoVO.getTipoItemPlanoFinanceiro());
						matriculaPeriodoContaReceberPlanoDescontoConvenioVO.setValorUtilizadoRecebimento(desc.getListaDescontosPlanoDesconto().get(planoDesconto));
						matriculaPeriodoContaReceberLogVO.getMatriculaPeriodoContaReceberPlanoDescontoConvenioNovaVOs().add(matriculaPeriodoContaReceberPlanoDescontoConvenioVO);
						break;
					}
				}
				
			}
		}
		if(contaNova.getParcela().contains("PG")){
			matriculaPeriodoContaReceberLogVO.setParcelaNova("1/1");
		}
		matriculaPeriodoContaReceberLogVO.setValorCalculadoComDescontoAplicado(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getConsiderarValorRateioBaseadoValorBaseComDescontosAplicados());
		return matriculaPeriodoContaReceberLogVO;
	}
	
	
	@Override
	public List<MatriculaPeriodoVO> consultarMatriculaPeriodoPrecisaReprovarPeriodoLetivoPorRegistroAula(List<RegistroAulaVO> registroAulaVOs, String ano, String semestre, UsuarioVO usuarioVO) throws Exception{
		List<HistoricoVO> historicoVOs = new ArrayList<HistoricoVO>(0);
		for(RegistroAulaVO registroAulaVO: registroAulaVOs){
			for(FrequenciaAulaVO frequenciaAulaVO: registroAulaVO.getFrequenciaAulaVOs()){
				historicoVOs.add(frequenciaAulaVO.getHistoricoVO());
			}
			break;
		}
		return consultarMatriculaPeriodoPrecisaReprovarPeriodoLetivo(historicoVOs, ano, semestre, usuarioVO);
	}
	
	@Override
	public List<MatriculaPeriodoVO> consultarMatriculaPeriodoPrecisaReprovarPeriodoLetivo(List<HistoricoVO> historicoVOs, String ano, String semestre, UsuarioVO usuarioVO) throws Exception{
		StringBuilder sql  = new StringBuilder("");
		sql.append(" select distinct matriculaperiodo.codigo as matriculaperiodo, matriculaperiodo.matricula, pessoa.nome as aluno	");		
		sql.append(" from matricula 	");
		sql.append(" inner join matriculaperiodo on matriculaperiodo.matricula = matricula.matricula	");
		sql.append(" inner join pessoa on pessoa.codigo = matricula.aluno	");
		sql.append(" inner join curso on curso.codigo = matricula.curso	");
		sql.append(" inner join periodoletivo on periodoletivo.codigo = matriculaperiodo.periodoletivomatricula 	");
		sql.append(" inner join periodoletivo pl on pl.gradecurricular = matricula.gradecurricularatual and pl.periodoletivo = periodoletivo.periodoletivo 	");
		sql.append(" inner join configuracaoacademico on ((pl.configuracaoacademico is not null and pl.configuracaoacademico = configuracaoacademico.codigo) or (pl.configuracaoacademico is null and curso.configuracaoacademico = configuracaoacademico.codigo ))	");
		sql.append(" inner join historico on historico.matriculaperiodo = matriculaperiodo.codigo	");
		sql.append(" and historico.anohistorico = matriculaperiodo.ano and historico.semestrehistorico = matriculaperiodo.semestre	");
		sql.append(" where configuracaoacademico.reprovadoMatricularDisciplinaPeriodoLetivo 	");
		sql.append(" and configuracaoacademico.numeroDisciplinaConsiderarReprovadoPeriodoLetivo > 0 	");
		sql.append(" and ((curso.periodicidade = 'AN' and matriculaperiodo.ano = '").append(ano).append("') 	");
		sql.append(" or (curso.periodicidade = 'SE' and matriculaperiodo.ano = '").append(ano).append("' and matriculaperiodo.semestre = '").append(semestre).append("') 	");
		sql.append(" or (curso.periodicidade = 'IN'))	");
		sql.append(" and matriculaperiodo.situacaomatriculaperiodo = 'FI'	");
		sql.append(" and (historico.historicodisciplinafazpartecomposicao is null or historico.historicodisciplinafazpartecomposicao = false)	");
		sql.append(" and (historico.historicoequivalente is null or historico.historicoequivalente= false) 	");
		sql.append(" and (historico.historicodisciplinaforagrade is null or historico.historicodisciplinaforagrade = false)	");
		sql.append(" and (historico.gradecurriculargrupooptativadisciplina is not null or historico.gradedisciplina is not null)	");
		sql.append(" and historico.matrizcurricular = matricula.gradecurricularatual 	");
		sql.append(" and historico.situacao not in ('AA', 'CC', 'CH', 'IS', 'AB') ");
		sql.append("	and ((historico.periodoletivomatrizcurricular is not null and pl.codigo = historico.periodoletivomatrizcurricular) "); 	
		sql.append("	 or exists ( ");
		sql.append("	select gradecurriculargrupooptativadisciplina.codigo from gradecurriculargrupooptativadisciplina ");
		sql.append("	inner join periodoletivo plgo on plgo.gradecurriculargrupooptativa = gradecurriculargrupooptativadisciplina.gradecurriculargrupooptativa ");
		sql.append("	where gradecurriculargrupooptativadisciplina.codigo = historico.gradecurriculargrupooptativadisciplina ");
		sql.append("	and plgo.codigo = pl.codigo ");
		sql.append("	union all ");
		sql.append("	select gradedisciplina.codigo from gradedisciplina ");
		sql.append("	inner join periodoletivo plgo on plgo.codigo = gradedisciplina.periodoletivo ");
		sql.append("	where gradedisciplina.codigo = historico.gradedisciplina ");
		sql.append("	and plgo.codigo = pl.codigo ");
		sql.append("	) ) ");
		sql.append(" and matriculaperiodo.codigo in (0 ");
		for(HistoricoVO historicoVO: historicoVOs){
			sql.append(", ").append(historicoVO.getMatriculaPeriodo().getCodigo());	
		}
		sql.append(" ) ");
		sql.append(" group by matriculaperiodo.codigo ,matriculaperiodo.matricula, matricula.gradecurricularatual, matriculaperiodo.ano, matriculaperiodo.semestre, configuracaoacademico.numeroDisciplinaConsiderarReprovadoPeriodoLetivo, pl.codigo, pessoa.nome	");
		sql.append(" having sum(case when historico.situacao in ('RE', 'RF') then 1 else 0 end ) >= configuracaoacademico.numeroDisciplinaConsiderarReprovadoPeriodoLetivo	");
		sql.append(" and sum(case when historico.situacao not in ('RE', 'RF', 'RP') then 1 else 0 end ) > 1 ");
		sql.append(" order by  aluno ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		List<MatriculaPeriodoVO> matriculaPeriodoVOs = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO matriculaPeriodoVO = null;
		while(rs.next()){
			matriculaPeriodoVO = new MatriculaPeriodoVO();
			matriculaPeriodoVO.setCodigo(rs.getInt("matriculaperiodo"));
			matriculaPeriodoVO.getMatriculaVO().setMatricula(rs.getString("matricula"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setNome(rs.getString("aluno"));
			matriculaPeriodoVOs.add(matriculaPeriodoVO);
		}
		return matriculaPeriodoVOs;		
	}

	public List<MatriculaPeriodoVO> consultarMatriculaPeriodo_MatriculaConfirmada() throws Exception {
		StringBuilder sql  = new StringBuilder("");
		sql.append(" select pessoa.codigo as codigoaluno, pessoa.nome as nomealuno, pessoa.email as emailaluno, matricula.matricula, 	");		
		sql.append(" matriculaperiodo.situacaomatriculaperiodo as situacaomatricula, turma.identificadorturma as turma, ");
		sql.append(" unidadeensino.codigo as codigounidadeensino, unidadeensino.nome as nomeunidadeensino, matricula.data as datainscricao, matricula.data as datamatricula, ");
		sql.append(" matriculaperiodo.situacaomatriculaperiodo as matriculaconfirmada ");
		sql.append(" from matriculaperiodo	");
		sql.append(" inner join matricula on matricula.matricula = matriculaperiodo.matricula ");
		sql.append(" inner join pessoa on pessoa.codigo = matricula.aluno ");
		sql.append(" inner join unidadeensino on unidadeensino.codigo = matricula.unidadeensino	");
		sql.append(" inner join turma on turma.codigo = matriculaperiodo.turma ");
		sql.append(" where matriculaperiodo.situacaomatriculaperiodo in ('AT' , 'PR') ");
		sql.append(" and matriculaperiodo.data >= (current_date - 7) ");
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
		List<MatriculaPeriodoVO> matriculaPeriodoVOs = new ArrayList<MatriculaPeriodoVO>(0);
		MatriculaPeriodoVO matriculaPeriodoVO = null;
		while(rs.next()){
			matriculaPeriodoVO = new MatriculaPeriodoVO();
			matriculaPeriodoVO.getMatriculaVO().getAluno().setCodigo(rs.getInt("codigoaluno"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setNome(rs.getString("nomealuno"));
			matriculaPeriodoVO.getMatriculaVO().getAluno().setEmail(rs.getString("emailaluno"));
			matriculaPeriodoVO.setMatricula(rs.getString("matricula"));
			matriculaPeriodoVO.setSituacaoMatriculaPeriodo(rs.getString("situacaomatricula"));
			matriculaPeriodoVO.getTurma().setIdentificadorTurma(rs.getString("turma"));
			matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().setCodigo(rs.getInt("codigounidadeensino"));
			matriculaPeriodoVO.getMatriculaVO().getUnidadeEnsino().setNome(rs.getString("nomeunidadeensino"));
			matriculaPeriodoVO.setData(rs.getDate("datamatricula"));
			//matriculaPeriodoVO.setSituacaoMatriculaPeriodo(rs.getString("matriculaconfirmada"));
			matriculaPeriodoVOs.add(matriculaPeriodoVO);
		}
		return matriculaPeriodoVOs;		
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gravarContratoMatricula(Integer matriculaPeriodo, Integer contrato) throws Exception{
		if(Uteis.isAtributoPreenchido(matriculaPeriodo) && Uteis.isAtributoPreenchido(contrato)){
			getConexao().getJdbcTemplate().update("update matriculaperiodo set contratoMatricula = ? where codigo = ?", contrato, matriculaPeriodo);
		}		
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gravarContratoFiador(Integer matriculaPeriodo, Integer contrato) throws Exception{
		if(Uteis.isAtributoPreenchido(matriculaPeriodo) && Uteis.isAtributoPreenchido(contrato)){
			getConexao().getJdbcTemplate().update("update matriculaperiodo set contratoFiador = ? where codigo = ?", contrato, matriculaPeriodo);
		}		
	}

	@Override
	public void removerHistoricoListaCursandoAdicionandoListaPendenteObjEspecifico(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodoVO, MapaEquivalenciaDisciplinaVO mapaEquivalenciaDisciplinaVO, UsuarioVO usuario) throws Exception {
		for (MapaEquivalenciaDisciplinaMatrizCurricularVO disciplinaMatriz : mapaEquivalenciaDisciplinaVO.getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {
			List<PeriodoLetivoComHistoricoAlunoVO> periodoLetivoComHistoricoAlunoVOs = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getPeriodoLetivoComHistoricoAlunoVOs();
			for (PeriodoLetivoComHistoricoAlunoVO periodoLetivoComHistoricoAlunoVO : periodoLetivoComHistoricoAlunoVOs) {
				for (GradeDisciplinaComHistoricoAlunoVO gradeDisciplinaComHistoricoAlunoVO : periodoLetivoComHistoricoAlunoVO.getGradeDisciplinaComHistoricoAlunoVOs()) {
					if (gradeDisciplinaComHistoricoAlunoVO.getGradeDisciplinaVO().getDisciplina().getCodigo().equals(disciplinaMatriz.getDisciplinaVO().getCodigo())) {

						for (Iterator<HistoricoVO> iterator = periodoLetivoComHistoricoAlunoVO.getHistoricosDisciplinasAlunoCursandoPeriodoLetivo().iterator(); iterator.hasNext();) {
							HistoricoVO historicoVO = iterator.next();
							if (historicoVO.getGradeDisciplinaVO().getCodigo().equals(gradeDisciplinaComHistoricoAlunoVO.getGradeDisciplinaVO().getCodigo())) {
								historicoVO.setSituacao(SituacaoHistorico.REPROVADO.getValor());
								periodoLetivoComHistoricoAlunoVO.getDisciplinasPendentesAlunoPeriodoLetivo().add(gradeDisciplinaComHistoricoAlunoVO.getGradeDisciplinaVO());
								iterator.remove();
								break;
							}
						}
						for (Iterator<HistoricoVO> iterator = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getHistoricosDisciplinasAlunoCursandoGradeCurricular().iterator(); iterator.hasNext();) {
							HistoricoVO historicoVO = iterator.next();
							if (historicoVO.getGradeDisciplinaVO().getCodigo().equals(gradeDisciplinaComHistoricoAlunoVO.getGradeDisciplinaVO().getCodigo())) {
								historicoVO.setSituacao(SituacaoHistorico.REPROVADO.getValor());
								iterator.remove();
								break;
							}
						}
						break;
					}
				}
			}
		}
		atualizarNrDisciplinasIncluidasExcluidas(matriculaPeriodoVO, matricula, usuario);
	}

	@Override
	public void removerHistoricoGrupoOptativaListaCursandoAdicionandoListaPendenteObjEspecifico(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodoVO, MapaEquivalenciaDisciplinaVO mapaEquivalenciaDisciplinaVO, UsuarioVO usuario) throws Exception {
		for (MapaEquivalenciaDisciplinaMatrizCurricularVO disciplinaMatriz : mapaEquivalenciaDisciplinaVO.getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {
			List<PeriodoLetivoComHistoricoAlunoVO> periodoLetivoComHistoricoAlunoVOs = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getPeriodoLetivoComHistoricoAlunoVOs();
			for (PeriodoLetivoComHistoricoAlunoVO periodoLetivoComHistoricoAlunoVO : periodoLetivoComHistoricoAlunoVOs) {
				for (GradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO obj : periodoLetivoComHistoricoAlunoVO.getGradeCurricularGrupoOptativaDisciplinaComHistoricoAlunoVO()) {
					if (obj.getGradeCurricularGrupoOptativaDisciplinaVO().getDisciplina().getCodigo().equals(disciplinaMatriz.getDisciplinaVO().getCodigo())) {
						for (Iterator<HistoricoVO> iterator = periodoLetivoComHistoricoAlunoVO.getHistoricosDisciplinasAlunoCursandoPeriodoLetivo().iterator(); iterator.hasNext();) {
							HistoricoVO historicoVO = iterator.next();
							historicoVO.setSituacao(SituacaoHistorico.REPROVADO.getValor());
							if (historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo().equals(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo())) {
								iterator.remove();
								break;
							}
						}
						for (Iterator<HistoricoVO> iterator = matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getHistoricosDisciplinasAlunoCursandoGradeCurricular().iterator(); iterator.hasNext();) {
							HistoricoVO historicoVO = iterator.next();
							if (historicoVO.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo().equals(obj.getGradeCurricularGrupoOptativaDisciplinaVO().getCodigo())) {
								historicoVO.setSituacao(SituacaoHistorico.REPROVADO.getValor());
								iterator.remove();
								break;
							}
						}
						break;
					}
				}
			}
		}
		atualizarNrDisciplinasIncluidasExcluidas(matriculaPeriodoVO, matricula, usuario);
	}
	

	// Caso existam contas a receber editadas manualmente, vinculadas a esta matriculaperiodo. E caso, o usuario,
	// tenha optado por remover estas contas, entao vamos alterar a situacao das mesmas para NAO EDITADAS MANUALMENTE.
	// Assim, estas contas serao naturalmente regeradas pelas rotinas abaixo de gestão de contas a receber.
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void verificarEAlterarContaReceberEditasManualmenteConformeDefinicaoUsuario(MatriculaPeriodoVO matriculaPeriodo, UsuarioVO usuario) throws Exception {
		if ((matriculaPeriodo.getExistemContaReceberComEdicaoManualAtiva()) &&
			(matriculaPeriodo.getRegerarContaReceberComEdicaoManualAtiva())) {
			getFacadeFactory().getContaReceberFacade().alterarContasReceberMatriculaPeriodoRemovendoEditadaManualmente(matriculaPeriodo.getMatricula(), matriculaPeriodo.getCodigo());
			for (MatriculaPeriodoVencimentoVO matriculaPeriodoVencimentoVO : matriculaPeriodo.getMatriculaPeriodoVencimentoVOs()) {
				if ((matriculaPeriodoVencimentoVO.getContaReceber().getContaEditadaManualmente()) &&
				    (matriculaPeriodoVencimentoVO.getContaReceber().getSituacaoAReceber())) {
					matriculaPeriodoVencimentoVO.getContaReceber().setContaEditadaManualmente(Boolean.FALSE);
					matriculaPeriodoVencimentoVO.setSituacao(SituacaoVencimentoMatriculaPeriodo.CONTARECEBER_GERADA);
				}
			}			
		}

	}
	@Override
	public void removerMapaEquivalenciaDisciplinaCursadaAposDesistenciaEquivalencia(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, List<MatriculaPeriodoTurmaDisciplinaVO> listaMatriculaPeriodoTurmaDisciplinaVOs, DisciplinaVO disciplinaCursadaVO, UsuarioVO usuarioVO) throws Exception {
		int index = 0;
		for (MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO : listaMatriculaPeriodoTurmaDisciplinaVOs) {
			if (matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getCodigo().equals(disciplinaCursadaVO.getCodigo())) {
				listaMatriculaPeriodoTurmaDisciplinaVOs.remove(index);
				return;
			}
			index++;
		}
		atualizarNrDisciplinasIncluidasExcluidas(matriculaPeriodoVO, matriculaVO, usuarioVO);
	}

	
	@Override
	public void realizarVerificacaoAceiteTermoRenovacaoOnline(MatriculaPeriodoVO obj, MatriculaVO matriculaVO, UsuarioVO usuarioVO) throws Exception{
		if (!obj.getAceitouTermoContratoRenovacaoOnline()) {
			InteracaoWorkflowVO interacaoVO = getFacadeFactory().getInteracaoWorkflowFacade().consultarPorRenovacaoMatriculaPeloPortalAluno(matriculaVO.getMatricula(), obj.getSemestre() + "/" + obj.getAno(), Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuarioVO);
			if (Uteis.isAtributoPreenchido(interacaoVO)) {
				obj.setDataAceitouTermoContratoRenovacaoOnline(interacaoVO.getDataInicio());
				obj.setAceitouTermoContratoRenovacaoOnline(true);
			}
		}
	}
	
	@Override
	public MatriculaPeriodoVO consultaUltimaMatriculaPeriodoPorMatriculaDadosNegociacao(String valorConsulta, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" SELECT matriculaPeriodo.codigo, matriculaperiodo.situacaoMatriculaPeriodo, MatriculaPeriodo.ano, MatriculaPeriodo.semestre, ");
		sqlStr.append(" PeriodoLetivo.codigo AS \"PeriodoLetivo.codigo\", PeriodoLetivo.descricao as \"PeriodoLetivo.descricao\", PeriodoLetivo.periodoLetivo as \"PeriodoLetivo.periodoLetivo\" ");
		sqlStr.append(" FROM matriculaperiodo ");
		sqlStr.append(" LEFT JOIN PeriodoLetivo ON (MatriculaPeriodo.periodoletivomatricula = PeriodoLetivo.codigo) ");
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '").append(valorConsulta).append("' and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setSituacaoMatriculaPeriodo(tabelaResultado.getString("situacaoMatriculaPeriodo"));
			obj.setAno(tabelaResultado.getString("ano"));
			obj.setSemestre(tabelaResultado.getString("semestre"));
			obj.getPeriodoLetivo().setCodigo(tabelaResultado.getInt("PeriodoLetivo.codigo"));
			obj.getPeriodoLetivo().setDescricao(tabelaResultado.getString("PeriodoLetivo.descricao"));
			obj.getPeriodoLetivo().setPeriodoLetivo(tabelaResultado.getInt("PeriodoLetivo.periodoLetivo"));
		}
		return obj;
	}

	
	/**
	 * Método Responsável por verificar se um aluno já reprovou em uma
	 * determinada disciplina. Caso o mesmo tenha sido prevado então a
	 * matriculaPeriodoTurmaDisciplina será marcada como de dependencia. Este
	 * controle poderá ser util pois a insituicao podera cobrar um valor
	 * diferenciado para disciplina caso a mesma seja de inclusao.
	 */
	@Override
	public void verificarDisciplinaAlunoAdaptacao(MatriculaPeriodoTurmaDisciplinaVO disciplinaIncluida, MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodoVO) {		
		disciplinaIncluida.setDisciplinaAdaptacao(Boolean.FALSE);
		if (disciplinaIncluida.getDisciplinaEquivale()) {
			for (MapaEquivalenciaDisciplinaMatrizCurricularVO mapaEquivalenciaDisciplinaMatriz : disciplinaIncluida.getMapaEquivalenciaDisciplinaVOIncluir().getMapaEquivalenciaDisciplinaMatrizCurricularVOs()) {				
				for(PeriodoLetivoVO periodoLetivoVO2 : matricula.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getGradeCurricularVO().getPeriodoLetivosVOs()) {
					if(periodoLetivoVO2.getPeriodoLetivo() > matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo()) {
						for(GradeDisciplinaVO gradeDisciplinaVO : periodoLetivoVO2.getGradeDisciplinaVOs()) {
							if(gradeDisciplinaVO.getDisciplina().getCodigo().equals(mapaEquivalenciaDisciplinaMatriz.getDisciplinaVO().getCodigo()) && 
								periodoLetivoVO2.getPeriodoLetivo() > matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo()) {
							disciplinaIncluida.setDisciplinaAdaptacao(Boolean.TRUE);
							return;
							}
						}
						if(periodoLetivoVO2.getControleOptativaGrupo()) {
							if(periodoLetivoVO2.getGradeCurricularGrupoOptativa().getGradeCurricularGrupoOptativaDisciplinaVOs().stream().anyMatch(d -> d.getDisciplina().getCodigo().equals(mapaEquivalenciaDisciplinaMatriz.getDisciplinaVO().getCodigo()))) {
								disciplinaIncluida.setDisciplinaAdaptacao(Boolean.TRUE);
								return;
							}
						}
					}
				}
				
			}
		} else {
			// Verificando se o aluno já foi reprovado nesta disciplina, alguma vez.	
			if(Uteis.isAtributoPreenchido(disciplinaIncluida.getGradeDisciplinaVO()) && matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo() < disciplinaIncluida.getGradeDisciplinaVO().getPeriodoLetivoVO().getPeriodoLetivo()) {
				disciplinaIncluida.setDisciplinaAdaptacao(Boolean.TRUE);
				return;
			}
			if(Uteis.isAtributoPreenchido(disciplinaIncluida.getGradeCurricularGrupoOptativaDisciplinaVO()) && Uteis.isAtributoPreenchido(disciplinaIncluida.getGradeCurricularGrupoOptativaDisciplinaVO().getPeriodoLetivoDisciplinaReferenciada())  && matriculaPeriodoVO.getPeriodoLetivo().getPeriodoLetivo() < disciplinaIncluida.getGradeCurricularGrupoOptativaDisciplinaVO().getPeriodoLetivoDisciplinaReferenciada().getPeriodoLetivo()) {
				disciplinaIncluida.setDisciplinaAdaptacao(Boolean.TRUE);
				return;
			}
		}		
	}
	
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarDefinicaoContratoPadraoSerUsadoMatriculaPeriodo(TipoContratoMatriculaEnum tipoContratoMatriculaEnum, MatriculaPeriodoVO matriculaPeriodoVO, boolean forcarTrocarContrato, boolean gravarContrato, UsuarioVO usuarioVO) throws Exception {
		if(verificarMatriculaDeCalouro(matriculaPeriodoVO.getMatricula(), matriculaPeriodoVO.getCodigo(), false, usuarioVO)) {
			if(matriculaPeriodoVO != null 				
					&& ((!Uteis.isAtributoPreenchido(matriculaPeriodoVO.getContratoMatricula()) && tipoContratoMatriculaEnum.equals(TipoContratoMatriculaEnum.NORMAL))
					|| (!Uteis.isAtributoPreenchido(matriculaPeriodoVO.getContratoExtensao()) && tipoContratoMatriculaEnum.equals(TipoContratoMatriculaEnum.EXTENSAO))
					|| (!Uteis.isAtributoPreenchido(matriculaPeriodoVO.getContratoFiador()) && tipoContratoMatriculaEnum.equals(TipoContratoMatriculaEnum.FIADOR))
					|| forcarTrocarContrato)) {
	
				if(tipoContratoMatriculaEnum.equals(TipoContratoMatriculaEnum.EXTENSAO)) {
                    List<TurmaContratoVO> turmaContratoVOs= getFacadeFactory().getTurmaContratoFacade().consultarTurmaTipoContratoMatricula(matriculaPeriodoVO.getTurma().getCodigo(), tipoContratoMatriculaEnum, true, usuarioVO);
                    if(Uteis.isAtributoPreenchido(turmaContratoVOs)) {
						matriculaPeriodoVO.setContratoExtensao(turmaContratoVOs.get(0).getTextoPadraoVO());					
					}else {
						matriculaPeriodoVO.setContratoExtensao(matriculaPeriodoVO.getPlanoFinanceiroCurso().getTextoPadraoContratoExtensao());
					}	
					if(gravarContrato && Uteis.isAtributoPreenchido(matriculaPeriodoVO.getContratoExtensao().getCodigo())) {
						gravarContratoExtensao(matriculaPeriodoVO.getCodigo(), matriculaPeriodoVO.getContratoExtensao().getCodigo());
					}
				}else if(tipoContratoMatriculaEnum.equals(TipoContratoMatriculaEnum.NORMAL)) {
					   TextoPadraoVO contratoMatriculaCalouro = getFacadeFactory().getTextoPadraoFacade().consultarTextoPadraoContratoMatriculaPorCurso(matriculaPeriodoVO.getTurma().getCurso().getCodigo(), false ,Uteis.NIVELMONTARDADOS_DADOSMINIMOS, usuarioVO);
						matriculaPeriodoVO.setContratoMatricula(contratoMatriculaCalouro);
						
					//pegar do curso apartir de agora .
//					if(Uteis.isAtributoPreenchido(turmaContratoVOs)) {				
//						matriculaPeriodoVO.setContratoMatricula(turmaContratoVOs.get(0).getTextoPadraoVO());					
//					}else if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getTextoPadraoContratoMatricula())) {
//						matriculaPeriodoVO.setContratoMatricula(matriculaPeriodoVO.getCondicaoPagamentoPlanoFinanceiroCurso().getTextoPadraoContratoMatricula());
//					}else {
//						matriculaPeriodoVO.setContratoMatricula(matriculaPeriodoVO.getPlanoFinanceiroCurso().getTextoPadraoContratoMatricula());	
//					}
					
					if(gravarContrato && Uteis.isAtributoPreenchido(matriculaPeriodoVO.getContratoMatricula().getCodigo())) {
						gravarContratoMatricula(matriculaPeriodoVO.getCodigo(), matriculaPeriodoVO.getContratoMatricula().getCodigo());
					}
				}else if(tipoContratoMatriculaEnum.equals(TipoContratoMatriculaEnum.FIADOR)) {				
					matriculaPeriodoVO.setContratoFiador(matriculaPeriodoVO.getPlanoFinanceiroCurso().getTextoPadraoContratoFiador());
					if(gravarContrato && Uteis.isAtributoPreenchido(matriculaPeriodoVO.getContratoFiador().getCodigo())) {
						gravarContratoFiador(matriculaPeriodoVO.getCodigo(), matriculaPeriodoVO.getContratoFiador().getCodigo());
					}
				}
				
			}
		}else {
			matriculaPeriodoVO.setContratoMatricula(null);
			matriculaPeriodoVO.setContratoExtensao(null);
			matriculaPeriodoVO.setContratoFiador(null);
		}
		
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void gravarContratoExtensao(Integer matriculaPeriodo, Integer contrato) throws Exception{
		if(Uteis.isAtributoPreenchido(matriculaPeriodo) && Uteis.isAtributoPreenchido(contrato)){
			getConexao().getJdbcTemplate().update("update matriculaperiodo set contratoExtensao = ? where codigo = ?", contrato, matriculaPeriodo);
		}		
	}
	
	public void alterarSituacaoMatriculaPeriodoEstornoCancelamentoSolicitarReconsideracaoSolicitacao(final Integer matriculaPeriodo, final UsuarioVO usuarioVO) throws Exception {
		final String sqlStr = "update matriculaperiodo set situacaomatriculaperiodo = 'PR', datafechamentomatriculaperiodo = null, origemfechamentomatriculaperiodo = null where situacaomatriculaperiodo = 'CA' and codigo = ?";
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sqlStr);
				sqlAlterar.setInt(1, matriculaPeriodo);
				return sqlAlterar;
			}
		});
	}	

	private boolean isPermitirMatriculaForaPrazo(UsuarioVO usuarioVO) {
		try {
			ControleAcesso.verificarPermissaoUsuarioFuncionalidadeComPerfilUsuarioVOEspecifico(PerfilAcessoPermissaoAcademicoEnum.MATRICULA_FORA_PRAZO.getValor(), usuarioVO);
			return true;
		} catch (Exception e) {
			return false;
		}
	}
	
	private boolean validarExistenciaDisciplinaMatriculaPeriodoTurmaDisciplinaVOs(DisciplinaVO disciplinaVO, List<MatriculaPeriodoTurmaDisciplinaVO> matriculaPeriodoTumaDisciplinaVOs) {
		return matriculaPeriodoTumaDisciplinaVOs.stream().map(MatriculaPeriodoTurmaDisciplinaVO::getDisciplina).anyMatch(disciplinaVO::equals);
	}

	public boolean validarExistenciaDisciplinaMapaEquivalenciaMatriculaPeriodoTurmaDisciplinaVOs(DisciplinaVO disciplinaVO, List<MatriculaPeriodoTurmaDisciplinaVO> matriculaPeriodoTumaDisciplinaVOs) {
		return matriculaPeriodoTumaDisciplinaVOs.stream()
			.map(MatriculaPeriodoTurmaDisciplinaVO::getMapaEquivalenciaDisciplinaVOIncluir)
			.map(MapaEquivalenciaDisciplinaVO::getMapaEquivalenciaCodigoDisciplinaMatrizCurricularVOs)
			.flatMap(Collection::stream)
			.anyMatch(disciplinaVO.getCodigo()::equals);
	}
	
	private boolean validarExistenciaDisciplinaMapaEquivalenciaDisciplina(DisciplinaVO disciplinaVO, MapaEquivalenciaDisciplinaVO mapaEquivalenciaDisciplinaVO) {
		return mapaEquivalenciaDisciplinaVO.getMapaEquivalenciaCodigoDisciplinaMatrizCurricularVOs().stream().anyMatch(disciplinaVO.getCodigo()::equals);
	}
	
	private boolean validarPreRequisitosDisciplinas(MatriculaVO matriculaVO, DisciplinaVO disciplinaPreRequisito, List<MatriculaPeriodoTurmaDisciplinaVO> matriculaPeriodoTumaDisciplinaVOs, MapaEquivalenciaDisciplinaVO mapaEquivalenciaDisciplinaVO) throws Exception {
		return !validarExistenciaDisciplinaMatriculaPeriodoTurmaDisciplinaVOs(disciplinaPreRequisito, matriculaPeriodoTumaDisciplinaVOs)
				&& !validarExistenciaDisciplinaMapaEquivalenciaMatriculaPeriodoTurmaDisciplinaVOs(disciplinaPreRequisito, matriculaPeriodoTumaDisciplinaVOs)
				&& !validarExistenciaDisciplinaMapaEquivalenciaDisciplina(disciplinaPreRequisito, mapaEquivalenciaDisciplinaVO)
				&& !getFacadeFactory().getConcessaoCreditoDisciplinaFacade().consultaExistenciaCreditoConcedidoDisciplinaPreRequisito(matriculaVO.getMatricula(), disciplinaPreRequisito.getCodigo(), matriculaVO.getGradeCurricularAtual().getCodigo());
	}
	
	public void verificarDisciplinaCursandoMapaEquivalencia(DisciplinaVO disciplinaVO, List<MatriculaPeriodoTurmaDisciplinaVO> matriculaPeriodoTumaDisciplinaVOs) throws Exception {
		if (validarExistenciaDisciplinaMapaEquivalenciaMatriculaPeriodoTurmaDisciplinaVOs(disciplinaVO, matriculaPeriodoTumaDisciplinaVOs)) {
			throw new ConsistirException("A disciplina " + disciplinaVO.getNome() + " já está sendo cursada por meio do Mapa de Equivalência");
		}
	}
	
	private Exception mensagemErroTratadaDisciplinaPreRequisito(MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTurmaDisciplinaVO) {
		if (matriculaPeriodoTurmaDisciplinaVO.getDisciplinaEquivale() && Uteis.isAtributoPreenchido(matriculaPeriodoTurmaDisciplinaVO.getMapaEquivalenciaDisciplinaVOIncluir())) {
			return new Exception("Não é possível realizar a inclusão, a(s) disciplina(s) " 
					+ matriculaPeriodoTurmaDisciplinaVO.getMapaEquivalenciaDisciplinaVOIncluir()
					.getMapaEquivalenciaDisciplinaMatrizCurricularVOs()
					.stream()
					.map(MapaEquivalenciaDisciplinaMatrizCurricularVO::getDisciplinaApresentar)
					.collect(Collectors.joining("; ")) + " possui(em) pré-requisito. Inclusão com mapa de equivalência.");
		}
		return new Exception("Não é possível realizar a inclusão, a disciplina " + matriculaPeriodoTurmaDisciplinaVO.getDisciplina().getNome() + " possui pré-requisito.");
	}
	
	@Override
	public MatriculaPeriodoVO consultaRapidaBasicaUltimaMatriculaPeriodoAtivaPorMatriculaDadosJobDCC(String valorConsulta, UsuarioVO usuario) throws Exception {
		StringBuilder sqlStr = new StringBuilder();
		sqlStr.append(" SELECT matriculaPeriodo.codigo, matriculaPeriodo.turma, matricula.matricula, curso.codigo as codigoCurso, curso.nivelEducacional, ");
		sqlStr.append(" matriculaPeriodo.ano, matriculaPeriodo.semestre, matriculaPeriodo.situacaoMatriculaPeriodo ");
		sqlStr.append(" FROM matriculaPeriodo ");
		sqlStr.append(" INNER JOIN matricula ON matricula.matricula = matriculaPeriodo.matricula ");
		sqlStr.append(" INNER JOIN curso on curso.codigo = matricula.curso ");
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = '").append(valorConsulta).append("' AND MatriculaPeriodo.situacaomatriculaperiodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano||'/'||MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, MatriculaPeriodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.getTurma().setCodigo(tabelaResultado.getInt("turma"));
			obj.getMatriculaVO().getCurso().setCodigo(tabelaResultado.getInt("codigoCurso"));
			obj.getMatriculaVO().getCurso().setNivelEducacional(tabelaResultado.getString("nivelEducacional"));
		}
		return obj;
	}
	
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void removerConstraintValidacaoMatriculaPeriodo() throws Exception {
		StringBuilder sql = new StringBuilder();
		sql.append(" ALTER TABLE IF EXISTS matriculaperiodo DROP CONSTRAINT IF EXISTS check_matriculaperiodo_ano_semestre_matricula;");
		sql.append(" ALTER TABLE IF EXISTS matriculaperiodo DROP CONSTRAINT IF EXISTS fn_validarexistenciaprocessomatriculacalendario; ");
		sql.append(" ALTER TABLE IF EXISTS matriculaperiodo DROP CONSTRAINT IF EXISTS ck_validarunidadeensinomatriculaunidadeensinoprocessomatricula; ");
		getConexao().getJdbcTemplate().update(sql.toString());
	}
	
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void incluirConstraintValidacaoMatriculaPeriodo() throws Exception {
		StringBuilder sql = new StringBuilder();
		if(!this.verificarConstraintExistente("check_matriculaperiodo_ano_semestre_matricula")) {
			sql.append("ALTER TABLE matriculaperiodo ADD CONSTRAINT check_matriculaperiodo_ano_semestre_matricula CHECK (fn_validarexistenciamatriculaperiodo(matricula::text, ano::text, semestre::text, codigo::bigint)) NOT VALID;");	
			getConexao().getJdbcTemplate().update(sql.toString());
			sql.delete(0, sql.length());
		}
		if(!this.verificarConstraintExistente("fn_validarexistenciaprocessomatriculacalendario")) {
			sql.append("ALTER TABLE matriculaperiodo ADD CONSTRAINT fn_validarexistenciaprocessomatriculacalendario CHECK (fn_validarexistenciaprocessomatriculacalendario(processomatricula, unidadeensinocurso) = true) NOT VALID;");
			getConexao().getJdbcTemplate().update(sql.toString());
			sql.delete(0, sql.length());
		}
		if(!this.verificarConstraintExistente("ck_validarunidadeensinomatriculaunidadeensinoprocessomatricula")) {
			sql.append("ALTER TABLE matriculaperiodo  ADD CONSTRAINT ck_validarunidadeensinomatriculaunidadeensinoprocessomatricula CHECK (fn_validaruematriculaigualueprocessomatricula(processomatricula, unidadeensinocurso) = true) NOT VALID;");	
			getConexao().getJdbcTemplate().update(sql.toString());
		}
	}
	

	public Boolean verificarConstraintExistente (String nomeConstraint) throws Exception {
		try {
			StringBuilder sql = new StringBuilder();
			sql.append(" SELECT COUNT(*) AS qtd  FROM pg_constraint WHERE conname = '").append(nomeConstraint).append("';") ;  		
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString());
			return Uteis.isAtributoPreenchido(tabelaResultado, "qtd", TipoCampoEnum.INTEIRO);
		} catch (Exception e) {
			throw e;
		}
	}
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarUnidadeEnsinoCursoPorTurma(TurmaVO turmaVO,UsuarioVO usuarioVO) throws Exception {
		 final StringBuilder sqlStr = new StringBuilder();
		 sqlStr.append(" UPDATE matriculaperiodo SET unidadeensinocurso = t.unidadeensinocurso  FROM ( ");
		 sqlStr.append(" SELECT");
		 sqlStr.append("   matriculaperiodo.codigo AS matriculaperiodo,unidadeensinocurso.codigo AS unidadeensinocurso ");
		 sqlStr.append(" FROM matriculaperiodo ");
		 sqlStr.append(" INNER JOIN turma 				    ON matriculaperiodo.turma   = turma.codigo ");
		 sqlStr.append(" INNER JOIN unidadeensinocurso  	ON unidadeensinocurso.curso = turma.curso ");
		 sqlStr.append(" AND unidadeensinocurso.turno 			= turma.turno ");
		 sqlStr.append(" AND unidadeensinocurso.unidadeensino  	= turma.unidadeensino ");
		 sqlStr.append("WHERE turma.codigo = ? ");
		 sqlStr.append(") AS t WHERE matriculaperiodo.codigo =  t.matriculaperiodo AND t.unidadeensinocurso <> matriculaperiodo.unidadeensinocurso ;");
		 sqlStr.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));

		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sqlStr.toString());
				int i = 0;
				Uteis.setValuePreparedStatement(turmaVO.getCodigo(), ++i, sqlAlterar);
				return sqlAlterar;
			}
		});
	}
	
	
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarProcessoMatriculaAlteracaoUnidadeEnsinoTurma(TurmaVO turmaVO,boolean controlarAcesso,UsuarioVO usuarioVO) throws Exception {
		 final StringBuilder sqlStr = new StringBuilder();
		 sqlStr.append("UPDATE matriculaperiodo  SET processomatricula = t.processomatricula FROM ( ");
		 sqlStr.append(" SELECT ");
		 sqlStr.append("   matriculaperiodo.codigo as matriculaperiodo,temp_processomatricula.processomatricula ");
		 sqlStr.append(" FROM matriculaperiodo");
		 sqlStr.append(" INNER JOIN turma             ON matriculaperiodo.turma = turma.codigo");
		 sqlStr.append(" INNER JOIN unidadeensino     ON turma.unidadeensino = unidadeensino.codigo");
		 sqlStr.append(" INNER JOIN LATERAL (");
		 sqlStr.append(" SELECT");
		 sqlStr.append("    processomatricula.codigo as processomatricula");
		 sqlStr.append(" FROM processomatricula");
		 sqlStr.append("   INNER JOIN processomatriculaunidadeensino 		ON processomatricula.codigo = processomatriculaunidadeensino.processomatricula");
		 sqlStr.append("   INNER JOIN processomatriculacalendario 		ON processomatricula.codigo = processomatriculacalendario.processomatricula");
		 sqlStr.append("   INNER JOIN unidadeensinocurso  				ON processomatriculaunidadeensino.unidadeensino = unidadeensinocurso.unidadeensino and processomatriculacalendario.curso = unidadeensinocurso.curso and processomatriculacalendario.turno = unidadeensinocurso.turno ");
		 sqlStr.append("  WHERE unidadeensinocurso.curso = turma.curso AND unidadeensinocurso.turno = turma.turno AND unidadeensinocurso.unidadeensino = turma.unidadeensino");
		 sqlStr.append("  AND processomatriculaunidadeensino.unidadeensino = turma.unidadeensino ORDER BY processomatricula.codigo DESC LIMIT 1");
		 sqlStr.append(" ) AS temp_processomatricula ON 1=1 ");
		 sqlStr.append(" WHERE turma.codigo = ? ");
		 sqlStr.append(") AS t WHERE matriculaperiodo.codigo = t.matriculaperiodo;");
		 sqlStr.append(adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));

		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {
			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sqlStr.toString());
				int i = 0;
				Uteis.setValuePreparedStatement(turmaVO.getCodigo(), ++i, sqlAlterar);
				return sqlAlterar;
			}
		});
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void alterarSituacaoManualMatriculaPeriodoPorMatriculaPeriodo(final Integer codigoMatriculaPeriodo, SituacaoMatriculaPeriodoEnum situacaoMatriculaPeriodo, UsuarioVO usuarioVO) throws Exception {
		final String sql = "UPDATE MatriculaPeriodo set  situacaoMatriculaPeriodo=?  WHERE ((codigo = ?))";
		getConexao().getJdbcTemplate().update(new PreparedStatementCreator() {

			public PreparedStatement createPreparedStatement(Connection arg0) throws SQLException {
				PreparedStatement sqlAlterar = arg0.prepareStatement(sql);
				sqlAlterar.setString(1, situacaoMatriculaPeriodo.getValor());
				sqlAlterar.setInt(2, codigoMatriculaPeriodo);
				return sqlAlterar;
			}
		});
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public JSONObject inicializarDadosRowDataLogRegistroOperacaoMatriculaPeriodo(MatriculaPeriodoVO matriculaPeriodoVO, String situacaoMatriculaPeriodo) {
		JSONObject jsonObjectRowData = new JSONObject();
		jsonObjectRowData.put("Codigo", matriculaPeriodoVO.getCodigo());
		jsonObjectRowData.put("Ano", matriculaPeriodoVO.getAno());
		jsonObjectRowData.put("Semestre", matriculaPeriodoVO.getSemestre());
		jsonObjectRowData.put("Codigo Turma", matriculaPeriodoVO.getTurma().getCodigo());
		jsonObjectRowData.put("Idenficador Turma", matriculaPeriodoVO.getTurma().getIdentificadorTurma());
		jsonObjectRowData.put("SituacaoMatriculaPeriodo", situacaoMatriculaPeriodo);
		return jsonObjectRowData;
	}
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public JSONObject inicializarDadosChangedFieldsLogRegistroOperacaoMatriculaPeriodo(MatriculaPeriodoVO matriculaPeriodoVO, SituacaoMatriculaPeriodoEnum situacaoMatriculaPeriodoAlterar) {
		JSONObject jsonObjectChangedFields = new JSONObject();
		jsonObjectChangedFields.put("SituacaoMatriculaPeriodo", situacaoMatriculaPeriodoAlterar.getValor());
		return jsonObjectChangedFields;
	}
 
	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarAlteracaoSituacaoMatriculaPeriodoManual(MatriculaPeriodoVO matriculaPeriodoVO, Boolean alterarSituacaoManualMatriculaPeriodo, SituacaoMatriculaPeriodoEnum situacaoMatriculaPeriodoAlterar, UsuarioVO usuarioVO) throws Exception {
		if (!alterarSituacaoManualMatriculaPeriodo) {
			return;
		}
		String situacaoMatriculaPeriodo = matriculaPeriodoVO.getSituacaoMatriculaPeriodo();
		
		if (!situacaoMatriculaPeriodo.equals(situacaoMatriculaPeriodoAlterar.getValor())) {
			JSONObject jsonObjectRowData = inicializarDadosRowDataLogRegistroOperacaoMatriculaPeriodo(matriculaPeriodoVO, situacaoMatriculaPeriodo);
			JSONObject jsonObjectChangedFields = inicializarDadosChangedFieldsLogRegistroOperacaoMatriculaPeriodo(matriculaPeriodoVO, situacaoMatriculaPeriodoAlterar);
			String observacao = "Alteração Manual de Matrícula Período";
			LogRegistroOperacoesVO logRegistroOperacoesVO = getFacadeFactory().getLogRegistroOperacoesFacade().inicializarDadosLogRegistroOperacoes(TabelaLogRegistroOperacoesEnum.MATRICULA_PERIODO, OperacaoLogRegistroOperacoesEnum.ALTERACAO_SITUACAO_MANUAL_MATRICULA_PERIODO, jsonObjectRowData, jsonObjectChangedFields, observacao, usuarioVO);
			getFacadeFactory().getLogRegistroOperacoesFacade().incluir(logRegistroOperacoesVO, usuarioVO);
			
			alterarSituacaoManualMatriculaPeriodoPorMatriculaPeriodo(matriculaPeriodoVO.getCodigo(), situacaoMatriculaPeriodoAlterar, usuarioVO);
			matriculaPeriodoVO.setSituacaoMatriculaPeriodo(situacaoMatriculaPeriodoAlterar.getValor());
			if(situacaoMatriculaPeriodoAlterar.equals(SituacaoMatriculaPeriodoEnum.ATIVA) || situacaoMatriculaPeriodoAlterar.equals(SituacaoMatriculaPeriodoEnum.PRE_MATRICULA)) {
				getConexao().getJdbcTemplate().update("update historico set situacao = 'CS' where matriculaperiodo = "+matriculaPeriodoVO.getCodigo()+" and anohistorico = '"+matriculaPeriodoVO.getAno()+"' and semestrehistorico = '"+matriculaPeriodoVO.getSemestre()+"' and situacao in ('TR', 'AC', 'CA', 'TF', 'JU') "+adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			}else if(situacaoMatriculaPeriodoAlterar.equals(SituacaoMatriculaPeriodoEnum.CANCELADA)) {
				getConexao().getJdbcTemplate().update("update historico set situacao = 'CA' where matriculaperiodo = "+matriculaPeriodoVO.getCodigo()+" and anohistorico = '"+matriculaPeriodoVO.getAno()+"' and semestrehistorico = '"+matriculaPeriodoVO.getSemestre()+"' and situacao in ('CS', 'TR', 'AC', 'TF', 'JU') "+adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			}else if(situacaoMatriculaPeriodoAlterar.equals(SituacaoMatriculaPeriodoEnum.TRANCADA)) {
				getConexao().getJdbcTemplate().update("update historico set situacao = 'TR' where matriculaperiodo = "+matriculaPeriodoVO.getCodigo()+" and anohistorico = '"+matriculaPeriodoVO.getAno()+"' and semestrehistorico = '"+matriculaPeriodoVO.getSemestre()+"' and situacao in ('CS', 'AC', 'CA', 'TF', 'JU') "+adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			}else if(situacaoMatriculaPeriodoAlterar.equals(SituacaoMatriculaPeriodoEnum.ABANDONO_CURSO)) {
				getConexao().getJdbcTemplate().update("update historico set situacao = 'AC' where matriculaperiodo = "+matriculaPeriodoVO.getCodigo()+" and anohistorico = '"+matriculaPeriodoVO.getAno()+"' and semestrehistorico = '"+matriculaPeriodoVO.getSemestre()+"' and situacao in ('CS', 'TR', 'CA', 'TF', 'JU') "+adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			}else if(situacaoMatriculaPeriodoAlterar.equals(SituacaoMatriculaPeriodoEnum.JUBILADO)) {
				getConexao().getJdbcTemplate().update("update historico set situacao = 'JU' where matriculaperiodo = "+matriculaPeriodoVO.getCodigo()+" and anohistorico = '"+matriculaPeriodoVO.getAno()+"' and semestrehistorico = '"+matriculaPeriodoVO.getSemestre()+"' and situacao in ('CS', 'TR', 'AC', 'CA', 'TF') "+adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			}else if(situacaoMatriculaPeriodoAlterar.equals(SituacaoMatriculaPeriodoEnum.TRANFERENCIA_INTERNA) || situacaoMatriculaPeriodoAlterar.equals(SituacaoMatriculaPeriodoEnum.TRANFERENCIA_SAIDA)) {
				getConexao().getJdbcTemplate().update("update historico set situacao = 'TF' where matriculaperiodo = "+matriculaPeriodoVO.getCodigo()+" and anohistorico = '"+matriculaPeriodoVO.getAno()+"' and semestrehistorico = '"+matriculaPeriodoVO.getSemestre()+"' and situacao in ('CS', 'TR', 'CA', 'AC', 'JU') "+adicionarUsuarioLogadoComoComentarioParaLogTrigger(usuarioVO));
			}
		}
	}
	
	public List<MatriculaPeriodoVO> consultaRapidaPorMatricula(String matricula, Integer unidadeEnsino, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (MatriculaPeriodo.matricula = '").append(matricula).append("') ");
		if (unidadeEnsino.intValue() != 0 && unidadeEnsino != null) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		sqlStr.append(" ORDER BY matricula, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		return montarDadosConsultaBasica(tabelaResultado);
	}
	
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarLiberacaoModuloTCCAluno(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception{
		if(!matricula.getMatriculaOnlineExterna()) {
			SqlRowSet rs = getFacadeFactory().getSalaAulaBlackboardFacade().realizarConsultaDeVerificacaoSeMatriculaAptaSalaAulaBlackboardTccAmbientacao(matricula.getMatricula(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), usuario);
			if(rs.next()) {
				getFacadeFactory().getSalaAulaBlackboardFacade().realizarVerificacaoSalaAulaBlackboardPorModuloTccAmbientacao(matricula, matriculaPeriodoVO, usuario);
				getFacadeFactory().getGestaoEnvioMensagemAutomaticaFacade().executarEnvioMensagemTccLiberado(matricula, matriculaPeriodoVO, usuario);
			}		
//				/**
//				 * Deve ser verificado se não existe a disciplina de TCC incluida para o aluno caso não esteja deve ser incluida automaticamente, 
//				 * utilizando a primeira turma aberta que encontrar vinculada a este disciplina, e deve ser apresentado o menu de TCC para o mesmo,
//				 *  bem como um Dashboard na tela inicial do aluno com o Link para a sala da black. 
//				 *  A sala gerar de ambientação de TCC deve estar vinculado a Matrícula do Aluno. 
//				 *  
//				 *  Caso na renovação a disciplinas de TCC  estiver 
//				 *  sendo incluida e o aluno não tenha completado os 62,5% então disciplina deve ser retirada da matricula do aluno.
//				 */
//				if(!getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().consultarMatriculaPeriodoTurmaDisciplinaPorDisciplinaTcc(matricula.getGradeCurricularAtual().getCodigo(), usuario)) {
//					GradeDisciplinaVO gradeDisciplinaVO = getFacadeFactory().getGradeDisciplinaFacade().consultarGradeDisciplinaVOTCC(matricula.getGradeCurricularAtual().getCodigo(), Uteis.NIVELMONTARDADOS_TODOS, usuario);
//					List<TurmaVO> listaResultado = getFacadeFactory().getTurmaFacade().consultaRapidaPorNrPeriodoLetivoUnidadeEnsinoCursoTurno(
//							matriculaPeriodoVO.getPeridoLetivo().getPeriodoLetivo(), 
//							matricula.getUnidadeEnsino().getCodigo(), matricula.getCurso().getCodigo(), 
//							matricula.getTurno().getCodigo(), matriculaPeriodoVO.getGradeCurricular().getCodigo(), 
//							false,true,false,false, 
//							matriculaPeriodoVO.getAno(),matriculaPeriodoVO.getSemestre(), 
//							false, usuario,getConfiguracaoFinanceiroPrevilegiandoUnidadeEnsino(matricula.getUnidadeEnsino().getCodigo(), usuario), false); 
//					Uteis.checkState(!Uteis.isAtributoPreenchido(listaResultado), "Não foi encontrado turma disponivel para disciplina de TCC");
//					TurmaVO turma  = listaResultado.get(0);
//					MatriculaPeriodoTurmaDisciplinaVO novoObj = gerarMatriculaPeriodoTurmaDisciplinaVOValidado(gradeDisciplinaVO, 
//							false, //indica se a disciplina será cursada por meio de um mapa de equivalencia 
//							null, // indica a qual mapa de equivalencia de disciplina estão sendo criado o objeto
//							null, // indica a qual disciplina do mapa de equivalencia o aluno irá cursar nesta MatriculaPeriodoTurmaDisciplina
//							false, null, 
//							false, // indica que o aluno foi liberado para estudar a disciplina, mesmo com choque de horário com outras disciplinas de sua turma
//							false, // se a principal, trata-se de uma composicao, o metodo que adiciona a MatriculaPEriodoTurmaDisciplina irá tratar esta situacao
//							null, gradeDisciplinaVO.getModalidadeDisciplina(), matriculaPeriodoVO, matricula, turma, null, null, usuario);
//					validarMatriculaPeriodoTurmaDisciplinaVOParaAluno(matriculaPeriodoVO, matricula, false, false, novoObj, usuario);
//					getFacadeFactory().getMatriculaPeriodoTurmaDisciplinaFacade().incluir(matricula, matriculaPeriodoVO, novoObj, getConfiguracaoFinanceiroPrevilegiandoUnidadeEnsino(matricula.getUnidadeEnsino().getCodigo(), usuario), matricula.getGradeCurricularAtual(), usuario);
//					
//				}
		}
	}
	
	
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
	public void realizarLiberacaoModuloEstagioAluno(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario) throws Exception{
		if(!matricula.getMatriculaOnlineExterna()) {
			SqlRowSet rs = getFacadeFactory().getSalaAulaBlackboardFacade().realizarConsultaDeVerificacaoSeMatriculaAptaSalaAulaBlackboardEstagio(matricula.getMatricula(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), usuario);
			if(rs.next()) {
				ConfiguracaoEstagioObrigatorioVO configEstagio = getFacadeFactory().getConfiguracaoEstagioObrigatorioFacade().consultarPorConfiguracaoEstagioPadrao(false, Uteis.NIVELMONTARDADOS_DADOSBASICOS, usuario);
				Uteis.checkState(!Uteis.isAtributoPreenchido(configEstagio), "O cadastro da Configuração de Estágio Obrigatório deve ser informado.");
				getFacadeFactory().getSalaAulaBlackboardFacade().realizarVerificacaoSalaAulaBlackboardPorModuloEstagio(matricula, matriculaPeriodoVO, configEstagio, usuario);
				getFacadeFactory().getGestaoEnvioMensagemAutomaticaFacade().executarEnvioMensagemEstagioObrigatorioLiberado(matricula, matriculaPeriodoVO, usuario);
			}
		}
	}
	
	@Override
	public void realizarExecucaoRegrasContaIntegracaoPorMatricula(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario, boolean geraContaGsuite) {
		if(geraContaGsuite == false) {
			Thread executarRegrasContaGsuitePorMatricula = new Thread(new ExecutarRegrasContaIntegracaoPorMatricula((MatriculaVO) Uteis.clonar(matriculaVO), matriculaPeriodoVO == null ? null : (MatriculaPeriodoVO) Uteis.clonar(matriculaPeriodoVO), usuario, geraContaGsuite));
			executarRegrasContaGsuitePorMatricula.start();
		}
	}
	
    class ExecutarRegrasContaIntegracaoPorMatricula implements Runnable {
		
		private MatriculaVO matricula;
		private MatriculaPeriodoVO matriculaPeriodoVO;
		private UsuarioVO usuario;
		private boolean gerarContaGsuite = false;
		
		public ExecutarRegrasContaIntegracaoPorMatricula(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodoVO, UsuarioVO usuario, boolean geraContaGsuite) {
			super();
			this.matricula = matricula;
			this.matriculaPeriodoVO = matriculaPeriodoVO;
			this.usuario = usuario;
			this.gerarContaGsuite = geraContaGsuite;
		}
		
		@Override
		public void run() {			
			try {
				Thread.sleep(60000);//Tempo para a matricula termine a sua persistencia para que as validacoes necessario de email seja feita
				if(gerarContaGsuite) {
					getFacadeFactory().getConfiguracaoSeiBlackboardFacade().realizarSalaAulaOperacaoPorMatricula(matricula, matriculaPeriodoVO, usuario);
				}else {
					getFacadeFactory().getConfiguracaoSeiGsuiteFacade().realizarExclusaoDaContaGsuitePorMatricula(matricula, usuario);	
				}				
			} catch (Exception e) {				
				e.printStackTrace();
			}
		}
	}
 
    @Override
    public List<MatriculaPeriodoVO> consultaRapidaPorMatriculaUtilizandoLike(String matricula, Integer unidadeEnsino, boolean controlarAcesso, DataModelo dataModelo, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr = getSQLPadraoConsultaBasica();
		sqlStr.append(" WHERE (MatriculaPeriodo.matricula ilike ?) ");
		if (Uteis.isAtributoPreenchido(unidadeEnsino)) {
			sqlStr.append(" AND (UnidadeEnsino.codigo = ").append(unidadeEnsino.intValue()).append(") ");
		}
		sqlStr.append(" ORDER BY Pessoa.nome, MatriculaPeriodo.data desc, MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.matricula ");
		if (Uteis.isAtributoPreenchido(dataModelo.getLimitePorPagina())) {
			sqlStr.append(" LIMIT ").append(dataModelo.getLimitePorPagina()).append(" OFFSET ").append(dataModelo.getOffset());
		}
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), matricula + PERCENT);
		if (tabelaResultado.next()) {
			dataModelo.setTotalRegistrosEncontrados((tabelaResultado.getInt("totalRegistroConsulta")));
		}
		tabelaResultado.beforeFirst();
		return montarDadosConsultaBasica(tabelaResultado);
	}

   
	public void realizarVerificacaoInclusaoDisciplinaPorEquivalencia(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, GradeDisciplinaVO gdPendente, boolean liberadoInclusaoTurmaOutroUnidadeEnsino, boolean liberadoInclusaoTurmaOutroCurso, boolean liberadoInclusaoTurmaOutroMatrizCurricular, boolean permitirRealizarMatriculaDisciplinaPreRequisito, List<HorarioAlunoTurnoVO> horarioAlunoTurnoVOs, Boolean apresentarRenovacaoOnline,UsuarioVO usuario) throws Exception {
        getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoInclusaoDisciplinaPorEquivalencia"+ matriculaVO.getMatricula());
        List<MapaEquivalenciaDisciplinaVO> mapaEquivalenciaDisciplinaVOs = getFacadeFactory().getMapaEquivalenciaDisciplinaFacade().consultarPorMapaEquivalenciaMatrizCurricularDisciplinaMatriz(matriculaPeriodoVO.getGradeCurricular().getCodigo(), gdPendente.getDisciplina().getCodigo(), NivelMontarDados.TODOS, false);
		q:for (MapaEquivalenciaDisciplinaVO mapa : mapaEquivalenciaDisciplinaVOs) {			
			if (mapa.getMapaEquivalenciaDisciplinaCursadaVOs().size() == 1 && 
					mapa.getMapaEquivalenciaCodigoDisciplinaMatrizCurricularVOs().size() ==1 
					&& getFacadeFactory().getMatriculaPeriodoFacade().validarAlunoPodeCursarDisciplinaPorMapaEquivalencia(matriculaVO, matriculaPeriodoVO, mapa, false)) {				
				boolean adicinouDisciplina = false;
				for (MapaEquivalenciaDisciplinaCursadaVO mapaEquivalenciaDisciplinaCursadaVO : mapa.getMapaEquivalenciaDisciplinaCursadaVOs()) {
					mapaEquivalenciaDisciplinaCursadaVO = getFacadeFactory().getMapaEquivalenciaDisciplinaCursadaFacade().consultarPorChavePrimaria(mapaEquivalenciaDisciplinaCursadaVO.getCodigo());
					HistoricoVO hist = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().verificarAlunoAprovadoDisciplina(mapaEquivalenciaDisciplinaCursadaVO.getDisciplinaVO().getCodigo());
					if (hist != null) {
						continue q ;
					}
					hist = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().verificarAlunoCursandoDisciplina(mapaEquivalenciaDisciplinaCursadaVO.getDisciplinaVO().getCodigo());			
					if (hist != null && (!matriculaVO.getCurso().getIntegral() || (matriculaVO.getCurso().getIntegral() && hist.getCursando()))) {
						continue q ;
					}
					Integer  disciplina = mapaEquivalenciaDisciplinaCursadaVO.getDisciplinaVO().getCodigo();
					Boolean disciplinaOfertadaEquivalenciaJaAdicionada = matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().stream().anyMatch(p-> p.getDisciplina().getCodigo().equals(disciplina));
					if(disciplinaOfertadaEquivalenciaJaAdicionada) {
						continue q ;
					}
					Integer unidadeEnsinoFiltro = liberadoInclusaoTurmaOutroUnidadeEnsino ? 0 : matriculaVO.getUnidadeEnsino().getCodigo();
					Integer cursoFiltro = liberadoInclusaoTurmaOutroCurso ? 0 : matriculaVO.getCurso().getCodigo();
					Integer matrizCurricularFiltro = liberadoInclusaoTurmaOutroMatrizCurricular ? 0 : matriculaVO.getGradeCurricularAtual().getCodigo();
                    getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoInclusaoDisciplinaPorEquivalencia1"+ matriculaVO.getMatricula());
					if ((matriculaPeriodoVO.getTipoContabilizacaoDisciplinaDependencia().equals(TipoContabilizacaoDisciplinaDependenciaEnum.CREDITO) && matriculaPeriodoVO.getPeriodoLetivo().getNumeroMaximoCreditoAlunoPodeCursar() > 0 && (mapaEquivalenciaDisciplinaCursadaVO.getNumeroCreditos() > matriculaPeriodoVO.getSaldoCreditoDisponivelInclusaoDisplinas() || matriculaPeriodoVO.getSaldoCreditoDisponivelInclusaoDisplinas().equals(0))) 
							|| (matriculaPeriodoVO.getTipoContabilizacaoDisciplinaDependencia().equals(TipoContabilizacaoDisciplinaDependenciaEnum.CARGA_HORARIA) && matriculaPeriodoVO.getPeriodoLetivo().getNumeroMaximoCargaHorariaAlunoPodeCursar() > 0 && (mapaEquivalenciaDisciplinaCursadaVO.getCargaHoraria() > matriculaPeriodoVO.getSaldoCHDisponivelInclusaoDisplinas() || matriculaPeriodoVO.getSaldoCHDisponivelInclusaoDisplinas().equals(0)))) {
                        getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoInclusaoDisciplinaPorEquivalencia2"+ matriculaVO.getMatricula());
						gdPendente.setGradeDisciplinaOfertada(getFacadeFactory().getTurmaFacade().consultaSeExisteTurmaPorDisciplinaPorUnidadeEnsinoPorCursoPorMatrizCurricularPorSituacao(mapaEquivalenciaDisciplinaCursadaVO.getDisciplinaVO().getCodigo(), mapaEquivalenciaDisciplinaCursadaVO.getCargaHoraria(), unidadeEnsinoFiltro, "AB", false, cursoFiltro, matrizCurricularFiltro, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), true, false, false, false, false, usuario, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(),apresentarRenovacaoOnline, matriculaVO));
						adicinouDisciplina = true;
					} else {
                        getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoInclusaoDisciplinaPorEquivalencia3"+ matriculaVO.getMatricula());
						List<TurmaVO> listaTurmaOfertada = getFacadeFactory().getTurmaFacade().consultaTurmaPorDisciplinaPorUnidadeEnsinoPorCursoPorMatrizCurricularPorSituacao(mapaEquivalenciaDisciplinaCursadaVO.getDisciplinaVO().getCodigo(), mapaEquivalenciaDisciplinaCursadaVO.getCargaHoraria(), unidadeEnsinoFiltro, "AB", false, cursoFiltro, matrizCurricularFiltro, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), true, false, false, false, false, usuario, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada() , apresentarRenovacaoOnline, matriculaVO);
						if (!listaTurmaOfertada.isEmpty()) {
							gdPendente.setGradeDisciplinaOfertada(true);
							Optional<TurmaVO> optionalTurma = listaTurmaOfertada.stream().filter(p -> p.getUnidadeEnsino().getCodigo().equals(matriculaVO.getUnidadeEnsino().getCodigo()) && p.getCurso().getCodigo().equals(matriculaVO.getCurso().getCodigo())).findFirst();
							if (!optionalTurma.isPresent()) {
								optionalTurma = listaTurmaOfertada.stream().filter(p -> p.getUnidadeEnsino().getCodigo().equals(matriculaVO.getUnidadeEnsino().getCodigo())).findFirst();
								if (!optionalTurma.isPresent()) {
									optionalTurma = listaTurmaOfertada.stream().filter(p -> p.getCurso().getCodigo().equals(matriculaVO.getCurso().getCodigo())).findFirst();
								}
							}
							TurmaVO turmaSelecionada = optionalTurma.isPresent() ? optionalTurma.get() : listaTurmaOfertada.get(0);
							MatriculaPeriodoTurmaDisciplinaVO novoObj = new MatriculaPeriodoTurmaDisciplinaVO();
							novoObj.setDisciplinaPorEquivalencia(true);
							novoObj.setMapaEquivalenciaDisciplinaCursada(mapaEquivalenciaDisciplinaCursadaVO);
							novoObj.setMapaEquivalenciaDisciplinaVOIncluir(mapa);
							novoObj.setDisciplina(mapaEquivalenciaDisciplinaCursadaVO.getDisciplinaVO());
							novoObj.setGradeDisciplinaVO(gdPendente);
							novoObj.setGradeCurricularGrupoOptativaDisciplinaVO(new GradeCurricularGrupoOptativaDisciplinaVO());
							novoObj.setTurmaPratica(null);
							novoObj.setTurmaTeorica(null);
							novoObj.setSugestaoTurmaPraticaTeoricaRealizada(false);
							novoObj.setDescricaoChoqueHorarioDisciplina("");
							getFacadeFactory().getTurmaFacade().carregarDados(turmaSelecionada, NivelMontarDados.BASICO, usuario);
							novoObj.setTurma(turmaSelecionada);
							novoObj.setModalidadeDisciplina(ModalidadeDisciplinaEnum.ON_LINE);
							getFacadeFactory().getMatriculaPeriodoFacade().adicionarEValidarMatriculaPeriodoTurmaDisciplinaVO(matriculaPeriodoVO, matriculaVO, permitirRealizarMatriculaDisciplinaPreRequisito, novoObj, horarioAlunoTurnoVOs, false, usuario);
							adicinouDisciplina = true;
						}
                        getAplicacaoControle().realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, "realizarVerificacaoInclusaoDisciplinaPorEquivalencia4"+ matriculaVO.getMatricula());
					}
				}
				if(adicinouDisciplina) {
					return;	
				}
			}
		}
	}
	
	@Override
	public void validarExistenciaMatriculaPeriodoAptaRealizarTransferenciaPorMatriculaSituacoesAtivaPreMatriculaAbandonoCursoTrancado(String matricula) throws Exception {
		String sqlStr = "SELECT MatriculaPeriodo.situacaoMatriculaPeriodo  FROM  MatriculaPeriodo WHERE MatriculaPeriodo.matricula = '" + matricula + "' order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ( 'AT','PR','TR','AC','FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc, MatriculaPeriodo.data desc limit 1 ";
		SqlRowSet rs = getConexao().getJdbcTemplate().queryForRowSet(sqlStr);
		if (!rs.next() || (!rs.getString("situacaoMatriculaPeriodo").equals(SituacaoMatriculaPeriodoEnum.ATIVA.getValor()) && !rs.getString("situacaoMatriculaPeriodo").equals(SituacaoMatriculaPeriodoEnum.PRE_MATRICULA.getValor()) && !rs.getString("situacaoMatriculaPeriodo").equals(SituacaoMatriculaPeriodoEnum.TRANCADA.getValor()) && !rs.getString("situacaoMatriculaPeriodo").equals(SituacaoMatriculaPeriodoEnum.ABANDONO_CURSO.getValor()))) {
			throw new Exception(UteisJSF.internacionalizar("msg_MatriculaPeriodo_semMatriculaAtivaOuPreMatriculadaOuTrancamentoOuAbandonoCurso"));
		}		
	}
	
	
	
	@Override
	public MatriculaPeriodoVO consultaAnoSemestreUltimaMatriculaPeriodoPorMatriculaConsultaBasica(String valorConsulta, boolean controlarAcesso,  UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuffer sqlStr =  new StringBuffer();
		sqlStr.append(" select MatriculaPeriodo.codigo , MatriculaPeriodo.ano, MatriculaPeriodo.semestre from MatriculaPeriodo  ");
		sqlStr.append(" INNER JOIN PeriodoLetivo ON  PeriodoLetivo.codigo = MatriculaPeriodo.periodoLetivoMatricula  ");
		sqlStr.append(" WHERE MatriculaPeriodo.matricula = ? and MatriculaPeriodo.situacaoMatriculaPeriodo != 'PC' ");
		sqlStr.append(" order by (MatriculaPeriodo.ano || '/' || MatriculaPeriodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, PeriodoLetivo.PeriodoLetivo desc, matriculaperiodo.codigo desc ");
		sqlStr.append(" limit 1");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), valorConsulta);
		MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
		if (tabelaResultado.next()) {
			obj.setCodigo(tabelaResultado.getInt("codigo"));
			obj.setAno(tabelaResultado.getString("ano"));
			obj.setSemestre(tabelaResultado.getString("semestre"));
		}
		return obj;
	}
	
	@Override
	public MatriculaPeriodoVO  realizarConsultaMatriculaAptaVoltarSituacaoPrematriculaAposIndeferirDocumentosObrigatorios(String matriculaAluno ,Boolean controlarAcesso,   UsuarioVO usuarioVO)  throws Exception {
			ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuarioVO);
			StringBuffer sqlStr =  new StringBuffer();			
			sqlStr.append(" select mp.codigo from matriculaperiodo mp  ");
			sqlStr.append(" inner join matricula m on m.matricula = mp.matricula  ");
			sqlStr.append(" inner join curso on curso.codigo = m.curso ");
			sqlStr.append(" inner join processomatricula  on processomatricula.codigo =  mp.processomatricula ");
			// inicio  join lateral feito para verificar se o aluno e calouro  
			sqlStr.append(" inner join lateral (");
			sqlStr.append(" select count (mpr.codigo) as total  from matriculaperiodo mpr where mpr.matricula = mp.matricula    ");
			sqlStr.append(" and ((mpr.situacaoMatriculaPeriodo = 'PR') or (mpr.situacaoMatriculaPeriodo = 'AT') or (mpr.situacaoMatriculaPeriodo = 'FI')   or (mpr.situacaoMatriculaPeriodo = 'TR')) ");
			sqlStr.append("  ) as t on t.total = 1 ");
			// fim join
			sqlStr.append(" where processomatricula.situacao ='PR' ");
			sqlStr.append(" and mp.situacaomatriculaperiodo ='AT'  ");
			sqlStr.append(" and curso.ativarprematriculaaposentregadocumentosobrigatorios ");
			sqlStr.append(" and mp.matricula= ?  ");
			sqlStr.append(" order by (mp.ano || '/' || mp.semestre) desc, case when mp.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, mp.codigo desc  ");
			sqlStr.append(" limit 1");
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), matriculaAluno  );
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			if (tabelaResultado.next()) {
				obj.setCodigo(tabelaResultado.getInt("codigo"));
			}
			return obj;
			
	}

	@Override
	@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.SUPPORTS)
	public void realizarAtivacaoMatriculaValidandoRegrasEntregaDocumentoAssinaturaContratoMatricula(String matriculaAluno, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, Boolean retornarException, UsuarioVO usuarioVO) throws Exception {
		try {
			if (realizarValidacaoRegraAtivacaoMatriculaPorEntregaDocumentoEContratoMatricula(matriculaAluno, usuarioVO)) {
				MatriculaPeriodoVO matriculaPeriodoVO = getFacadeFactory().getMatriculaPeriodoFacade().consultarPorMatriculaDadosMensagemAtivacaoMatricula(matriculaAluno, false, Uteis.NIVELMONTARDADOS_TODOS, configuracaoFinanceiroVO, usuarioVO);
				if (Uteis.isAtributoPreenchido(matriculaPeriodoVO) && matriculaPeriodoVO.getSituacaoPreMatricula()) {
					matriculaPeriodoVO.setSituacao("AT");
					matriculaPeriodoVO.setUsuarioResponsavelConfirmacaoOuCancelamentoPreMatricula(usuarioVO.getCodigo());
					getFacadeFactory().getMatriculaFacade().alterarSituacaoMatriculaVOParaAtivada(matriculaPeriodoVO.getMatriculaVO(), matriculaPeriodoVO, usuarioVO, configuracaoFinanceiroVO);

					// consultando lista de personalizacao template pois existe vinculo com curso .
					List<PersonalizacaoMensagemAutomaticaVO> mensagemTemplates = getFacadeFactory().getPersonalizacaoMensagemAutomaticaFacade().consultarPorParamentrosTemplate("", TemplateMensagemAutomaticaEnum.MENSAGEM_NOTIFICACAO_ATIVACAO_PREMATRICULA_DOCUMENTO_ENTREGUE, null, "", false, usuarioVO);
					// verificado se a lista ta preenchido e pelo menos 1 template nao ta desabilitado envio de mensagens
					if (Uteis.isAtributoPreenchido(mensagemTemplates) && mensagemTemplates.stream().anyMatch(template -> !template.getDesabilitarEnvioMensagemAutomatica())) {
						PersonalizacaoMensagemAutomaticaVO templateUsar = null;
						// filtro por um optional padrao que caso não tenha personalizacao com curso de acordo com a matricula sera enviado o padrao
						Optional<PersonalizacaoMensagemAutomaticaVO> optMensagemTemplatePadrao = mensagemTemplates.stream().filter(template -> (!Uteis.isAtributoPreenchido(template.getCursoVO()))).findFirst();

                        Optional<PersonalizacaoMensagemAutomaticaVO> optMensagemTemplateCurso = mensagemTemplates.stream().filter(template -> (Uteis.isAtributoPreenchido(template.getCursoVO()) && template.getCursoVO().getCodigo().equals(matriculaPeriodoVO.getMatriculaVO().getCurso().getCodigo()))).findFirst();
                        // caso exista para o curso sera validado o template que possui curso
                        if (optMensagemTemplateCurso != null && optMensagemTemplateCurso.isPresent()) {
                            templateUsar = optMensagemTemplateCurso.get();
                        } else if (optMensagemTemplatePadrao != null && optMensagemTemplatePadrao.isPresent()) {
                            templateUsar = optMensagemTemplatePadrao.get();
                        }
                        if (templateUsar != null && !templateUsar.getDesabilitarEnvioMensagemAutomatica() && getFacadeFactory().getMatriculaFacade().verificarSeMatriculaEstaAptaReceberNotificacaoAtivacaoPreMatricula(matriculaPeriodoVO.getMatriculaVO().getMatricula(), usuarioVO)) {
                            getFacadeFactory().getGestaoEnvioMensagemAutomaticaFacade().enviarMensagemAtivacaoPreMatricula(matriculaPeriodoVO.getMatriculaVO(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), templateUsar, usuarioVO);
                            getFacadeFactory().getMatriculaFacade().atualizarDataEnvioNotificacaoMensagemAtivacaoPreMatricula(Arrays.asList(matriculaPeriodoVO.getMatriculaVO()), usuarioVO);
                        }
                    }
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            if (retornarException) {
                throw e;
            }
        }
    }

		@Override
		public Boolean  realizarVerificacaoMatriculaPrecisaVoltarSituacaoPrematriculaAposIndeferirDocumentosObrigatorios(String matriculaAluno , Boolean liberadoVoltarPrematricula, Boolean controlarAcesso,   UsuarioVO usuarioVO)  throws Exception {
		Boolean necessarioVoltarPrematricula = Boolean.FALSE;
		MatriculaPeriodoVO  matriculaPeriodoVO  = getFacadeFactory().getMatriculaPeriodoFacade().realizarConsultaMatriculaAptaVoltarSituacaoPrematriculaAposIndeferirDocumentosObrigatorios(matriculaAluno, controlarAcesso, usuarioVO);
    	if(Uteis.isAtributoPreenchido(matriculaPeriodoVO) &&  Uteis.isAtributoPreenchido(matriculaPeriodoVO.getCodigo())) {
    		necessarioVoltarPrematricula = Boolean.TRUE;
			if(liberadoVoltarPrematricula) {
    			matriculaPeriodoVO.setSituacaoMatriculaPeriodo("PR");
				matriculaPeriodoVO.setUsuarioResponsavelConfirmacaoOuCancelamentoPreMatricula(usuarioVO.getCodigo());
				alterarSituacaoMatriculaPeriodo(matriculaPeriodoVO,usuarioVO);
			}
			AplicacaoControle.realizarEscritaTextoDebug(AssuntoDebugEnum.GERAL, " entrou no metodo realizarVerificacaoMatriculaPrecisaVoltarSituacaoPrematriculaAposIndeferirDocumentosObrigatorios  linha 15940 facade matriculaPeriodo mudou situacao matricula periodo para pre - matricuila  " );
    	}
        return	necessarioVoltarPrematricula ;
	}
			
		    
		 @Override
		   public Boolean realizarValidacaoRegraAtivacaoMatriculaPorEntregaDocumentoEContratoMatricula(String matricula , UsuarioVO usuarioVO) throws Exception {
		   	   				 
				 return validarMatriculaPodeSerAtivadaPrematriculaAposEntregaDocumentosObrigatorios(matricula,usuarioVO) || validarMatriculaPodeSerAtivadaAposAssinaturaContratoMatricula(matricula,usuarioVO) ; 		    	
			}	
	

		@Override
		public void inicializarDadosDefinirDisciplinasDependenciaFuturasMatriculaPeriodo(MatriculaVO matriculaVO,
				MatriculaPeriodoVO matriculaPeriodoVO,
				List<GradeDisciplinaVO> listaDisciplinasPeriodoLetivoAlunoPendente, PeriodoLetivoVO periodoAnterior,
				Integer periodoLetivoVisualizarHistoricoAlunoIncluirDisciplina,
				boolean liberadoInclusaoTurmaOutroUnidadeEnsino, Boolean liberadoInclusaoTurmaOutroCurso,
				Boolean liberadoInclusaoTurmaOutroMatrizCurricular,
				Boolean permitirRealizarMatriculaDisciplinaPreRequisito, Boolean carregarDisciplinasFuturo, List<HorarioAlunoTurnoVO> horarioAlunoTurnoVOs,
				UsuarioVO usuarioLogadoClone) throws Exception {
			
             if((carregarDisciplinasFuturo)) {
				if(Uteis.isAtributoPreenchido(matriculaVO.getCurso().getConfiguracaoAcademico().getNumeroPeriodoLetivoPosteriorPermiteInclusaoDisciplina()) ) {
					Integer numeroPeriodoLetivo = matriculaPeriodoVO.getPeridoLetivo().getPeriodoLetivo() + matriculaVO.getCurso().getConfiguracaoAcademico().getNumeroPeriodoLetivoPosteriorPermiteInclusaoDisciplina();					
					if(Uteis.isAtributoPreenchido(numeroPeriodoLetivo) && numeroPeriodoLetivo >= matriculaPeriodoVO.getGradeCurricular().getUltimoPeriodoLetivoGrade().getPeriodoLetivo()) {
						periodoAnterior = matriculaPeriodoVO.getGradeCurricular().getUltimoPeriodoLetivoGrade();
					}else {							
						periodoAnterior = matriculaPeriodoVO.getGradeCurricular().getPeriodoLetivoPorNumero(numeroPeriodoLetivo);
					}					
				}else if(Uteis.isAtributoPreenchido(matriculaPeriodoVO.getGradeCurricular().getUltimoPeriodoLetivoGrade())){
					periodoAnterior  =   matriculaPeriodoVO.getGradeCurricular().getUltimoPeriodoLetivoGrade();				
				}				
			}
			
			if (periodoLetivoVisualizarHistoricoAlunoIncluirDisciplina.intValue() == 0 || (carregarDisciplinasFuturo)) {
				if(Uteis.isAtributoPreenchido(matriculaVO.getTransferenciaEntrada().getCodigo())) {
					listaDisciplinasPeriodoLetivoAlunoPendente = (matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getListaGradeDisciplinaVOsPendentesGradeCurricularValidandoDisciplinaAprovadoNaGradeAntigaReferenteAtransferenciaInternaMatricula(periodoAnterior.getPeriodoLetivo()));					
				}else {
					listaDisciplinasPeriodoLetivoAlunoPendente = (matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getListaGradeDisciplinaVOsPendentesGradeCurricular(periodoAnterior.getPeriodoLetivo()));
				}
			} else {
				PeriodoLetivoComHistoricoAlunoVO periodoComHistorico = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().getPeriodoLetivoComHistoricoAlunoVOPorCodigo(periodoLetivoVisualizarHistoricoAlunoIncluirDisciplina);
				if (periodoComHistorico != null) {
					listaDisciplinasPeriodoLetivoAlunoPendente =(periodoComHistorico.getDisciplinasPendentesAlunoPeriodoLetivo());
				} else {
					listaDisciplinasPeriodoLetivoAlunoPendente = (new ArrayList<>(0));
				}
			}
			
			
			getFacadeFactory().getMatriculaPeriodoFacade().realizarVerificacaoDeDistribuicaoDisciplinaDependenciaAutomatica(
					matriculaVO,
					matriculaPeriodoVO,
					listaDisciplinasPeriodoLetivoAlunoPendente,
					liberadoInclusaoTurmaOutroUnidadeEnsino, 
					liberadoInclusaoTurmaOutroCurso, 
					liberadoInclusaoTurmaOutroMatrizCurricular,
					permitirRealizarMatriculaDisciplinaPreRequisito,
					horarioAlunoTurnoVOs,
					usuarioLogadoClone);
		
			
			
			
		}
	

		@Override
		public void realizarVerificacaoOfertaDisciplinaGrupoOptativa(MatriculaVO matriculaVO, MatriculaPeriodoVO matriculaPeriodoVO, GradeCurricularGrupoOptativaDisciplinaVO gradeCurricularGrupoOptativaDisciplinaVO, boolean liberadoInclusaoTurmaOutroUnidadeEnsino, boolean liberadoInclusaoTurmaOutroCurso, boolean liberadoInclusaoTurmaOutroMatrizCurricular, boolean permitirRealizarMatriculaDisciplinaPreRequisito, List<HorarioAlunoTurnoVO> horarioAlunoTurnoVOs, Boolean apresentarRenovacaoOnline,UsuarioVO usuario) throws Exception {
			Integer unidadeEnsinoFiltro = liberadoInclusaoTurmaOutroUnidadeEnsino ? 0 : matriculaVO.getUnidadeEnsino().getCodigo();
			Integer cursoFiltro = liberadoInclusaoTurmaOutroCurso ? 0 : matriculaVO.getCurso().getCodigo();
			Integer matrizCurricularFiltro = liberadoInclusaoTurmaOutroMatrizCurricular ? 0 : matriculaVO.getGradeCurricularAtual().getCodigo();
			gradeCurricularGrupoOptativaDisciplinaVO.setDisciplinaOfertada(getFacadeFactory().getTurmaFacade().consultaSeExisteTurmaPorDisciplinaPorUnidadeEnsinoPorCursoPorMatrizCurricularPorSituacao(gradeCurricularGrupoOptativaDisciplinaVO.getDisciplina().getCodigo(), gradeCurricularGrupoOptativaDisciplinaVO.getCargaHoraria(), unidadeEnsinoFiltro, "AB", false, cursoFiltro, matrizCurricularFiltro, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), true, false, false, false, false, usuario, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(), usuario.getIsApresentarVisaoAlunoOuPais(), matriculaVO));
			if(!gradeCurricularGrupoOptativaDisciplinaVO.getDisciplinaOfertada()) {				
			List<MapaEquivalenciaDisciplinaVO> mapaEquivalenciaDisciplinaVOs = getFacadeFactory().getMapaEquivalenciaDisciplinaFacade().consultarPorMapaEquivalenciaMatrizCurricularDisciplinaMatriz(matriculaPeriodoVO.getGradeCurricular().getCodigo(), gradeCurricularGrupoOptativaDisciplinaVO.getDisciplina().getCodigo(), NivelMontarDados.TODOS, false);
			q:for (MapaEquivalenciaDisciplinaVO mapa : mapaEquivalenciaDisciplinaVOs) {			
				if (mapa.getMapaEquivalenciaDisciplinaCursadaVOs().size() == 1 && 
						mapa.getMapaEquivalenciaCodigoDisciplinaMatrizCurricularVOs().size() ==1 
						&& getFacadeFactory().getMatriculaPeriodoFacade().validarAlunoPodeCursarDisciplinaPorMapaEquivalencia(matriculaVO, matriculaPeriodoVO, mapa, false)) {				
					boolean adicinouDisciplina = false;
					for (MapaEquivalenciaDisciplinaCursadaVO mapaEquivalenciaDisciplinaCursadaVO : mapa.getMapaEquivalenciaDisciplinaCursadaVOs()) {
						mapaEquivalenciaDisciplinaCursadaVO = getFacadeFactory().getMapaEquivalenciaDisciplinaCursadaFacade().consultarPorChavePrimaria(mapaEquivalenciaDisciplinaCursadaVO.getCodigo());
						
						HistoricoVO hist = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().verificarAlunoAprovadoDisciplina(mapaEquivalenciaDisciplinaCursadaVO.getDisciplinaVO().getCodigo());
						if (hist != null) {
							continue q ;
						}
						hist = matriculaVO.getMatriculaComHistoricoAlunoVO().getGradeCurricularComHistoricoAlunoVO().verificarAlunoCursandoDisciplina(mapaEquivalenciaDisciplinaCursadaVO.getDisciplinaVO().getCodigo());			
						if (hist != null && (!matriculaVO.getCurso().getIntegral() || (matriculaVO.getCurso().getIntegral() && hist.getCursando()))) {
							continue q ;
						}
						Integer  disciplina = mapaEquivalenciaDisciplinaCursadaVO.getDisciplinaVO().getCodigo();
						Boolean disciplinaOfertadaEquivalenciaJaAdicionada = matriculaPeriodoVO.getMatriculaPeriodoTumaDisciplinaVOs().stream().anyMatch(p-> p.getDisciplina().getCodigo().equals(disciplina));
						if(disciplinaOfertadaEquivalenciaJaAdicionada) {
							continue q ;
						}
						
						
						gradeCurricularGrupoOptativaDisciplinaVO.setDisciplinaOfertada(getFacadeFactory().getTurmaFacade().consultaSeExisteTurmaPorDisciplinaPorUnidadeEnsinoPorCursoPorMatrizCurricularPorSituacao(mapaEquivalenciaDisciplinaCursadaVO.getDisciplinaVO().getCodigo(), mapaEquivalenciaDisciplinaCursadaVO.getCargaHoraria(), unidadeEnsinoFiltro, "AB", false, cursoFiltro, matrizCurricularFiltro, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(), matriculaPeriodoVO.getAno(), matriculaPeriodoVO.getSemestre(), true, false, false, false, false, usuario, matriculaVO.getCurso().getConfiguracaoAcademico().getMatricularApenasDisciplinaAulaProgramada(),apresentarRenovacaoOnline, matriculaVO));						

					}					
				}
			}
				
			}
			gradeCurricularGrupoOptativaDisciplinaVO.setOfertaJaValida(true);
		}
	
		@Override
		public void realizarVerificacaoPermissaoExclusaoDisciplina(MatriculaVO matricula, MatriculaPeriodoVO matriculaPeriodo, MatriculaPeriodoTurmaDisciplinaVO matriculaPeriodoTumaDisciplina, UsuarioVO usuario) throws Exception {
		matriculaPeriodoTumaDisciplina.setApresentarRemoverVisaoAluno(true);
		if(Uteis.isAtributoPreenchido(usuario) && usuario.getIsApresentarVisaoAlunoOuPais() && !matriculaPeriodoTumaDisciplina.getDisciplinaReferenteAUmGrupoOptativa()
				&& !matriculaPeriodoTumaDisciplina.getDisciplinaAdaptacao()) {			
			matriculaPeriodoTumaDisciplina.setApresentarRemoverVisaoAluno(!matriculaPeriodoTumaDisciplina.getDisciplinaDependencia() && !matriculaPeriodoTumaDisciplina.getGradeDisciplinaVO().getPeriodoLetivoVO().getCodigo().equals(matriculaPeriodo.getPeriodoLetivo().getCodigo()));
			if(!matriculaPeriodo.getAlunoRegularMatrizCurricular() && !matricula.getCurso().getConfiguracaoAcademico().getPermitirAlunoIrregularRemoverDisciplinaPeriodoLetivoAtual()
					&& !matriculaPeriodoTumaDisciplina.getDisciplinaDependencia() && !matriculaPeriodoTumaDisciplina.getDisciplinaAdaptacao()) {
				matriculaPeriodoTumaDisciplina.setApresentarRemoverVisaoAluno(false);
			}
			if(matriculaPeriodo.getAlunoRegularMatrizCurricular() && matricula.getCurso().getConfiguracaoAcademico().getBloquearExclusaoDisciplinaPeriodoLetivoAtualAlunoRegular()
					&& !matriculaPeriodoTumaDisciplina.getDisciplinaDependencia() && !matriculaPeriodoTumaDisciplina.getDisciplinaAdaptacao()) {
				matriculaPeriodoTumaDisciplina.setApresentarRemoverVisaoAluno(false);
			}
			if(matriculaPeriodoTumaDisciplina.getDisciplinaDependencia() && matricula.getCurso().getConfiguracaoAcademico().isHabilitarDistribuicaoDisciplinaDependenciaAutomatica()) {
				matriculaPeriodoTumaDisciplina.setApresentarRemoverVisaoAluno(false);
			}
		}
		}
		
		// disciplinasAlunoJaEstaEstudando so vai vira preenchida  caso exitir matricula e turma com disciplina .
		@Override
		public void realizarAdicionarObjetoDisciplinasMatricula(MatriculaRSVO matriculaRSVO,List<MatriculaPeriodoTurmaDisciplinaVO> disciplinasAlunoJaEstaEstudando,MatriculaPeriodoVO matriculaPeriodoVOInicializadaDadosPadrao) throws Exception  {
			matriculaPeriodoVOInicializadaDadosPadrao.getMatriculaPeriodoTumaDisciplinaVOs().stream().forEach(mptdInicializada -> {			
				Boolean estudar = true;
				if (verificarSeJaEstaEstudandoDisciplinaProcessoSeletivo(disciplinasAlunoJaEstaEstudando, mptdInicializada)) {
					estudar = false ;
				}			
				matriculaRSVO.getDisciplinasMatricula().add(new DisciplinaRSVO(mptdInicializada.getDisciplina().getCodigo(), mptdInicializada.getDisciplina().getNome(), estudar));
			 });
		}
		
		public boolean verificarSeJaEstaEstudandoDisciplinaProcessoSeletivo(List<MatriculaPeriodoTurmaDisciplinaVO> disciplinasAlunoJaEstaEstudando,MatriculaPeriodoTurmaDisciplinaVO mptdInicializada) {
			return  Uteis.isAtributoPreenchido(disciplinasAlunoJaEstaEstudando) &&  !disciplinasAlunoJaEstaEstudando.stream().anyMatch(mptdEstudando -> mptdEstudando.getDisciplina().getCodigo().equals(mptdInicializada.getDisciplina().getCodigo()));
		}
		
	
		@Override
		public boolean executarVerificacaoExisteMatriculaPeriodoRenovadaPorAnoSemestreEvasao(Integer matriculaPeriodo, String ano, String semestre, boolean controlarAcesso, UsuarioVO usuarioVO) throws Exception {
			MatriculaPeriodo.consultar(getIdEntidade(), controlarAcesso, usuarioVO);
			StringBuilder sqlStr = new StringBuilder();
			sqlStr.append("select matriculaperiodo.codigo from matriculaperiodo ");
			sqlStr.append("where matriculaperiodo.matricula = (select distinct mp.matricula from matriculaperiodo mp where mp.codigo = ").append(matriculaPeriodo).append(") ");
			sqlStr.append("and matriculaperiodo.ano = '").append(ano).append("' ");
			if (Uteis.isAtributoPreenchido(semestre)) {
				sqlStr.append("and matriculaperiodo.semestre = '").append(semestre).append("' ");
			}
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
			if (!tabelaResultado.next()) {
				return false;
			}
			return Uteis.isAtributoPreenchido(tabelaResultado.getInt("codigo"));
		}
		
		
		@Override
		public MatriculaPeriodoVO consultarPorMatriculaDadosMensagemAtivacaoMatricula(String valorConsulta, boolean controlarAcesso, int nivelMontarDados, ConfiguracaoFinanceiroVO configuracaoFinanceiroVO, UsuarioVO usuario) throws Exception {
			ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
			StringBuilder sqlStr = new StringBuilder();
			sqlStr.append(" SELECT matriculaperiodo.codigo as codigoMatriculaPeriodo,");
			sqlStr.append(" matriculaperiodo.matricula as numeroMatricula , ");
			sqlStr.append(" matriculaperiodo.ano  as anoMatriculaPeriodo ,");
			sqlStr.append(" matriculaperiodo.semestre as semestreMatriculaPeriodo ,");
			sqlStr.append(" matriculaperiodo.situacaoMatriculaPeriodo ,");
			sqlStr.append(" matriculaperiodo.situacao  as situacaoMp ,");
			sqlStr.append(" matricula.situacao  as situacaoMatricula ,");
			sqlStr.append(" matricula.inscricao  as inscricaoMatricula ,");
			sqlStr.append(" curso.codigo as codigoCurso , ");
			sqlStr.append(" curso.nome as nomeCurso , ");
			sqlStr.append(" pessoa.codigo as codigoAluno ,");
			sqlStr.append(" pessoa.nome as nomeAluno , ");
			sqlStr.append(" pessoa.email as emailAluno , ");
			sqlStr.append(" pessoa.email2 as email2Aluno ");		
			sqlStr.append(" FROM matriculaperiodo  ");
			sqlStr.append(" inner join matricula on matricula.matricula = matriculaperiodo.matricula  ");
			sqlStr.append(" inner join pessoa on pessoa.codigo = matricula.aluno  ");
			sqlStr.append(" inner join curso on curso.codigo = matricula.curso  ");
			sqlStr.append("  WHERE matriculaperiodo.matricula = ?  ");
			sqlStr.append(" and matriculaperiodo.situacaoMatriculaPeriodo != 'PC' ");
			sqlStr.append(" order by (matriculaperiodo.ano || '/' || matriculaperiodo.semestre) desc, case when matriculaperiodo.situacaoMatriculaPeriodo in ('AT', 'PR', 'FI', 'FO') then 1 else 2 end, matriculaperiodo.codigo desc ");
			sqlStr.append(" limit 1");
			SqlRowSet dadosSQL = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString(), new Object[] { valorConsulta });
			if (dadosSQL.next()) {
				MatriculaPeriodoVO obj = new MatriculaPeriodoVO(); 
				obj.setCodigo((dadosSQL.getInt("codigoMatriculaPeriodo")));
				obj.setMatricula(dadosSQL.getString("numeroMatricula"));						
				obj.setAno(dadosSQL.getString("anoMatriculaPeriodo"));
				obj.setSemestre(dadosSQL.getString("semestreMatriculaPeriodo"));
				obj.setSituacaoMatriculaPeriodo(dadosSQL.getString("situacaoMatriculaPeriodo"));
				obj.setSituacao(dadosSQL.getString("situacaoMp"));
				obj.getMatriculaVO().setSituacao(dadosSQL.getString("situacaoMatricula"));
				obj.getMatriculaVO().setMatricula(dadosSQL.getString("numeroMatricula"));
				obj.getMatriculaVO().getCurso().setCodigo(dadosSQL.getInt("codigoCurso"));
				obj.getMatriculaVO().getCurso().setNome(dadosSQL.getString("nomeCurso"));
				obj.getMatriculaVO().getAluno().setCodigo(dadosSQL.getInt("codigoAluno"));
				obj.getMatriculaVO().getAluno().setNome(dadosSQL.getString("nomeAluno"));
				obj.getMatriculaVO().getAluno().setEmail(dadosSQL.getString("emailAluno"));
				obj.getMatriculaVO().getAluno().setEmail2(dadosSQL.getString("email2Aluno"));				
				return obj;
			}
			return null;
		}
		
		@Override
		@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
		public void alterarSituacaoMatriculaPeriodo(Integer codigo, String situacao, UsuarioVO usuario) throws Exception {
			Date updated = new Date();
			try {
				String sqlStr = "UPDATE matriculaperiodo set situacaomatriculaperiodo=?, updated=? WHERE ((codigo = ?))";
				getConexao().getJdbcTemplate().update(sqlStr, new Object[] { situacao, Uteis.getDataJDBCTimestamp(updated), codigo });
			} finally {
				updated = null;
			}
		}
		
		@Override
		@Transactional(readOnly = false, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
		public MatriculaPeriodoVO consultarListaMatriculasCanceladas(String[] matriculas) throws Exception {
			String matricula = String.join(",", java.util.Collections.nCopies(matriculas.length, "?"));
			String sqlStr = "SELECT * FROM matriculaperiodo WHERE matricula IN ( "+ matricula +" ) ORDER BY data DESC";
			SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr, (Object[]) matriculas);
			while(tabelaResultado.next()) {
				MatriculaPeriodoVO matPeriodo = new MatriculaPeriodoVO();
				matPeriodo.setCodigo(tabelaResultado.getInt("codigo"));
				matPeriodo.setMatricula(tabelaResultado.getString("matricula"));
				matPeriodo.setData(tabelaResultado.getDate("data"));
				return matPeriodo;
			}
			return null;
		}
	
	@Override
	public List<MatriculaPeriodoVO> consultaRapidaPorMatricula(String matricula, boolean controlarAcesso, UsuarioVO usuario) throws Exception {
		ControleAcesso.consultar(getIdEntidade(), controlarAcesso, usuario);
		StringBuilder sqlStr = new StringBuilder("SELECT MatriculaPeriodo.codigo, MatriculaPeriodo.data, MatriculaPeriodo.periodoLetivoMatricula, ");
		sqlStr.append(" PeriodoLetivo.descricao \"PeriodoLetivo.descricao\", PeriodoLetivo.periodoLetivo \"PeriodoLetivo.periodoLetivo\", MatriculaPeriodo.ano, MatriculaPeriodo.semestre ");
		sqlStr.append(" FROM MatriculaPeriodo ");
		sqlStr.append(" INNER JOIN PeriodoLetivo ON MatriculaPeriodo.periodoLetivoMatricula = PeriodoLetivo.codigo ");
		sqlStr.append(" WHERE (MatriculaPeriodo.matricula = '").append(matricula).append("') ");
		sqlStr.append(" ORDER BY MatriculaPeriodo.ano desc, MatriculaPeriodo.semestre desc, MatriculaPeriodo.codigo desc ");
		SqlRowSet tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sqlStr.toString());
		List<MatriculaPeriodoVO> matriculaPeriodoVOs = new ArrayList<>(0);
		while (tabelaResultado.next()) {
			MatriculaPeriodoVO obj = new MatriculaPeriodoVO();
			obj.setCodigo((tabelaResultado.getInt("codigo")));
			obj.setData(tabelaResultado.getDate("data"));
			obj.getPeridoLetivo().setCodigo(tabelaResultado.getInt("periodoLetivoMatricula"));
			obj.getPeridoLetivo().setDescricao(tabelaResultado.getString("PeriodoLetivo.descricao"));
			obj.setAno(tabelaResultado.getString("ano"));
			obj.setSemestre(tabelaResultado.getString("semestre"));
			obj.getPeridoLetivo().setPeriodoLetivo(tabelaResultado.getInt("PeriodoLetivo.periodoletivo"));
			matriculaPeriodoVOs.add(obj);
		}
		return matriculaPeriodoVOs;
	}

	@Override
	public Date consultarDataInicioCursoMatricula(String matricula) {
		StringBuilder sql = new StringBuilder();
		SqlRowSet tabelaResultado = null;
		try {
			sql.append("SELECT matriculaperiodo.\"data\" dataprimeiramatriculaperiodo ");
			sql.append("FROM matriculaperiodo ");
			sql.append("WHERE matriculaperiodo.matricula = ? ");
			sql.append("ORDER BY matriculaperiodo.ano || matriculaperiodo.semestre, matriculaperiodo.codigo LIMIT 1");
			tabelaResultado = getConexao().getJdbcTemplate().queryForRowSet(sql.toString(), matricula);
			return tabelaResultado.next() ? tabelaResultado.getDate("dataprimeiramatriculaperiodo") : null;
		} finally {
			sql = null;
			tabelaResultado = null;
		}
	}
}